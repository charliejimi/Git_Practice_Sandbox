<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Writing å‡ºé¡Œå¹«æ‰‹ (AI é©…å‹•ç‰ˆ)</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«” */
        html {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        /* ç°¡å–®çš„ loading spinner å‹•ç•« */
        .spinner {
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        /* è®“ textarea æ›´åƒ IDE */
        textarea::placeholder {
            color: #9ca3af;
            font-style: italic;
        }
        /* èª¿æ•´é‚è¼¯å€å¡Šçš„æ¨£å¼ï¼Œä½¿å…¶æ›´çµæ§‹åŒ– */
        #generation-logic {
            white-space: pre-wrap; /* ä¿æŒæ›è¡Œå’Œç©ºæ ¼ */
            line-height: 1.6; /* å¢åŠ è¡Œé«˜ä»¥ä¾¿é–±è®€ */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

    <div class="max-w-3xl mx-auto">
        
        <!-- é é¦– -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md::text-4xl font-bold text-blue-700">IELTS Writing å‡ºé¡Œå¹«æ‰‹</h1>
            <p class="text-lg text-gray-600 mt-2">è²¼ä¸Šæ‚¨çš„å¯«ä½œåˆ†æï¼ŒAI å°‡è‡ªå‹•ç”Ÿæˆå€‹äººåŒ–ç·´ç¿’é¡Œã€‚</p>
        </header>

        <!-- ä¸»å…§å®¹å€åŸŸ -->
        <main class="space-y-6">

            <!-- 1. è¼¸å…¥å¡ç‰‡ (FR-001, FR-008, MODIFICATION: History Import) -->
            <section class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">1. è²¼ä¸Šæ‚¨çš„åˆ†ææ–‡å­—èˆ‡æ­·å²è¨˜éŒ„</h2>
                
                <div class="space-y-4">
                    <div>
                        <label for="analysis-text" class="block text-sm font-medium text-gray-700 mb-1">1.1. æœ¬æ¬¡å¯«ä½œåˆ†æå…§å®¹ (å¿…å¡«)</label>
                        <textarea id="analysis-text" rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 font-mono text-sm" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šæ‚¨å¾ GitHub æˆ–å…¶ä»–åœ°æ–¹è¤‡è£½çš„å¯«ä½œåˆ†æå›é¥‹...&#10;ä¾‹å¦‚:&#10;TA: 7.0 - è«–é»æ“´å±•æ·±å…¥ä¸”çµæ§‹å®Œæ•´ã€‚&#10;LR: 5.5 - è©å½™é‡è¤‡æ€§é«˜ï¼Œç¼ºä¹è®ŠåŒ–ã€‚"></textarea>
                    </div>
                    
                    <!-- MODIFICATION: å°‡ textarea æ”¹ç‚ºæª”æ¡ˆä¸Šå‚³ -->
                    <div>
                        <label for="history-file-input" class="block text-sm font-medium text-gray-700 mb-1">1.2. å°å…¥éå»çš„è¨“ç·´è¨˜éŒ„ (å¯é¸, .md æ ¼å¼)</label>
                        <input type="file" id="history-file-input" multiple accept=".md, .markdown, text/markdown" class="block w-full text-sm text-gray-500
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-md file:border-0
                            file:text-sm file:font-semibold
                            file:bg-blue-50 file:text-blue-700
                            hover:file:bg-blue-100
                            cursor-pointer
                        ">
                        <!-- ç”¨æ–¼é¡¯ç¤ºå·²é¸æª”æ¡ˆçš„åˆ—è¡¨ -->
                        <div id="file-list-container" class="mt-2 text-sm text-gray-600 space-y-1">
                            <ul id="history-file-list" class="list-disc list-inside">
                                <li id="file-list-placeholder" class="text-gray-400">å°šæœªé¸æ“‡ä»»ä½• .md æª”æ¡ˆã€‚</li>
                            </ul>
                        </div>
                    </div>
                    <!-- END OF MODIFICATION -->

                    <!-- Task 1 / Task 2 é¸æ“‡ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">1.3. é¸æ“‡ä»»å‹™é¡å‹</label>
                        <div class="flex gap-4 p-2 bg-gray-50 rounded-md border">
                            <label class="flex items-center">
                                <input type="radio" id="task-2" name="task-type" value="Task 2" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" checked>
                                <span class="ml-2 text-sm text-gray-900">Task 2 (Essay)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" id="task-1" name="task-type" value="Task 1" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-900">Task 1 (Report/Letter)</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- FR-008ï¼šéš±ç§æˆæ¬Š -->
                    <div class="flex items-center">
                        <input id="privacy-check" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="privacy-check" class="ml-2 block text-sm text-gray-900">æˆ‘åŒæ„å‚³é€åˆ†ææ–‡å­—ä»¥é€²è¡Œ AI è™•ç† (FR-008)</label>
                    </div>

                    <button id="generate-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300 disabled:bg-gray-400">
                        é–‹å§‹åˆ†æä¸¦ç”Ÿæˆé¡Œç›®
                    </button>
                </div>
            </section>

            <!-- éŒ¯èª¤æç¤ºå€åŸŸ (Edge Cases) -->
            <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert">
                <strong class="font-bold">éŒ¯èª¤ï¼š</strong>
                <span class="block sm:inline" id="error-text"></span>
            </div>

            <!-- è®€å–ä¸­æç¤º (SC-001) -->
            <div id="loading-spinner" class="hidden flex flex-col items-center justify-center p-8 text-center">
                <div class="spinner w-12 h-12 border-4 border-blue-500 rounded-full"></div>
                <p class="mt-4 text-gray-600 font-semibold">AI æ­£åœ¨åˆ†ææ‚¨çš„å›é¥‹ä¸¦æ’°å¯«æ–°é¡Œç›®...</p>
                <p class="text-sm text-gray-500">(ä¸²æ¥ Gemini API... å¯èƒ½éœ€è¦å¹¾ç§’é˜)</p>
            </div>

            <!-- 2. çµæœé¡¯ç¤ºå¡ç‰‡ (FR-002, FR-003, FR-005, FR-006) -->
            <section id="results-card" class="hidden bg-white p-6 rounded-lg shadow-md space-y-6">
                
                <!-- åˆ†æçµæœ -->
                <div>
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">2. AI å¯«ä½œåˆ†ææ‘˜è¦ (FR-002)</h2>
                    <p class="text-sm text-gray-500 mb-4">ç³»çµ±å·²è§£ææ‚¨çš„æ–‡å­—ï¼Œæ‘˜è¦å¦‚ä¸‹ï¼š</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <span class="text-sm font-medium text-blue-800">TA (ä»»å‹™å›æ‡‰)</span>
                            <div id="score-ta" class="text-3xl font-bold text-blue-600">...</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <span class="text-sm font-medium text-green-800">CC (é€£è²«èˆ‡éŠœæ¥)</span>
                            <div id="score-cc" class="text-3xl font-bold text-green-600">...</div>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <span class="text-sm font-medium text-yellow-800">LR (è©å½™è³‡æº)</span>
                            <div id="score-lr" class="text-3xl font-bold text-yellow-600">...</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <span class="text-sm font-medium text-purple-800">GRA (æ–‡æ³•ç¯„åœ)</span>
                            <div id="score-gra" class="text-3xl font-bold text-purple-600">...</div>
                        </div>
                    </div>
                    <div class="mt-4 bg-gray-50 p-4 rounded-md">
                        <h4 class="font-semibold">AI è©•è«–æ‘˜è¦ (FR-003)ï¼š</h4>
                        <p id="analysis-summary" class="text-gray-700 mt-1">AI æ­£åœ¨åˆ†æ...</p>
                    </div>
                </div>

                <!-- å€‹äººåŒ–æ–°é¡Œç›® -->
                <div>
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">3. AI å€‹äººåŒ–æ–°é¡Œç›® (FR-005)</h2>
                    <div class="bg-gray-100 p-6 rounded-lg border border-gray-200">
                        <p id="task-type-label" class="text-sm font-medium text-gray-500 mb-2">IELTS Writing Task 2</p>
                        <p id="new-question" class="text-lg font-medium leading-relaxed">AI æ­£åœ¨ç”Ÿæˆé¡Œç›®...</p>
                    </div>

                    <!-- Task 1 åœ–è¡¨æè¿°å€å¡Š -->
                    <div id="chart-description-container" class="hidden mt-4">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-md font-semibold text-gray-800">åœ–è¡¨ç”Ÿåœ–æç¤ºè© (Markdown æ ¼å¼)</h4>
                            <button id="copy-chart-btn" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded-md transition-colors">
                                è¤‡è£½
                            </button>
                        </div>
                        <div class="bg-gray-800 text-white font-mono text-sm p-4 rounded-lg overflow-x-auto">
                            <pre id="chart-description-content" class="whitespace-pre-wrap">...åœ–è¡¨æè¿°å°‡é¡¯ç¤ºæ–¼æ­¤...</pre>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">æ‚¨å¯ä»¥å°‡æ­¤æè¿°è²¼åˆ°æ”¯æ´çš„ AI (å¦‚ Gemini 2.5) ä¸­ä»¥ç”Ÿæˆåœ–è¡¨ã€‚</p>
                    </div>
                    <!-- END OF Task 1 MODIFICATION -->

                </div>

                <!-- ç”Ÿæˆé‚è¼¯ (å«å°å‡ºæŒ‰éˆ•) -->
                <div class="relative">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-semibold">4. ç”Ÿæˆé‚è¼¯èˆ‡å€‹äººåŒ–ç­–ç•¥ (FR-006)</h3>
                        <!-- MODIFICATION: å°å‡ºæŒ‰éˆ• -->
                        <button id="export-logic-btn" class="text-sm bg-indigo-200 hover:bg-indigo-300 text-indigo-800 px-3 py-1 rounded-md transition-colors disabled:bg-gray-300 disabled:text-gray-600" disabled>
                            å°å‡ºç‚º Markdown
                        </button>
                        <!-- END OF MODIFICATION -->
                    </div>
                    <div id="generation-logic" class="bg-blue-50 border-l-4 border-blue-500 text-blue-900 p-4 rounded-md text-sm">
                        AI æ­£åœ¨åˆ†æç”Ÿæˆç­–ç•¥...
                    </div>
                </div>
            </section>

            <!-- 5. æ­·å²ç´€éŒ„ (FR-007 / User Story 4) -->
            <section class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">5. æ­·å²ç”Ÿæˆç´€éŒ„ (FR-007)</h2>
                <div id="history-container" class="space-y-3">
                    <ul id="history-list" class="divide-y divide-gray-200">
                        <!-- JS æœƒå‹•æ…‹åŠ å…¥æ­·å²ç´€éŒ„ -->
                        <li id="history-placeholder" class="text-gray-500 py-2">ç›®å‰æ²’æœ‰ç´€éŒ„ã€‚</li>
                    </ul>
                </div>
            </section>

        </main>
    </div>

    <script>
        // ç²å– DOM å…ƒç´ 
        const generateBtn = document.getElementById('generate-btn');
        const analysisTextInput = document.getElementById('analysis-text'); 
        
        // MODIFICATION: ç§»é™¤ pastHistoryInputï¼Œæ”¹ç‚ºæª”æ¡ˆä¸Šå‚³
        // const pastHistoryInput = document.getElementById('past-history-text'); // ç§»é™¤
        const historyFileInput = document.getElementById('history-file-input');
        const historyFileList = document.getElementById('history-file-list');
        const fileListPlaceholder = document.getElementById('file-list-placeholder');
        // END OF MODIFICATION
        
        const privacyCheck = document.getElementById('privacy-check');
        const task1Radio = document.getElementById('task-1');
        const task2Radio = document.getElementById('task-2');
        
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        
        const loadingSpinner = document.getElementById('loading-spinner');
        const resultsCard = document.getElementById('results-card');
        
        const scoreTa = document.getElementById('score-ta');
        const scoreCc = document.getElementById('score-cc');
        const scoreLr = document.getElementById('score-lr');
        const scoreGra = document.getElementById('score-gra');
        const analysisSummary = document.getElementById('analysis-summary');
        
        const taskTypeLabel = document.getElementById('task-type-label');
        const newQuestion = document.getElementById('new-question');
        const generationLogic = document.getElementById('generation-logic');
        
        // åœ–è¡¨æè¿°ç›¸é—œå…ƒç´ 
        const chartDescriptionContainer = document.getElementById('chart-description-container');
        const chartDescriptionContent = document.getElementById('chart-description-content');
        const copyChartBtn = document.getElementById('copy-chart-btn');
        
        const historyList = document.getElementById('history-list');

        // MODIFICATION: å°å‡ºæŒ‰éˆ•åŠå„²å­˜åŸå§‹é‚è¼¯æ–‡å­—
        const exportLogicBtn = document.getElementById('export-logic-btn');
        let rawLogicText = ''; // å„²å­˜æœ€è¿‘ä¸€æ¬¡ç”Ÿæˆçš„åŸå§‹é‚è¼¯æ–‡å­—
        // END OF MODIFICATION

        // MODIFICATION: å„²å­˜åˆä½µçš„æª”æ¡ˆå…§å®¹
        let combinedHistoryText = "";
        // END OF MODIFICATION

        // Gemini API è¨­å®š
        const apiKey = "AIzaSyCDd6xErsGUo9SLp6V7espooLedL1OM3Lo"; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // ç›£è½æŒ‰éˆ•é»æ“Š
        generateBtn.addEventListener('click', handleGeneration);
        copyChartBtn.addEventListener('click', copyChartDescription);
        exportLogicBtn.addEventListener('click', exportLogicAsMarkdown);
        
        // MODIFICATION: æ–°å¢æª”æ¡ˆé¸æ“‡çš„ç›£è½å™¨
        historyFileInput.addEventListener('change', handleFileSelect);
        // END OF MODIFICATION

        /**
         * MODIFICATION: è™•ç†æª”æ¡ˆé¸æ“‡èˆ‡è®€å–
         */
        async function handleFileSelect(event) {
            const files = event.target.files;
            
            // æ¸…ç©ºå…ˆå‰çš„åˆ—è¡¨å’Œå…§å®¹
            historyFileList.innerHTML = ''; 
            combinedHistoryText = "";

            if (files.length === 0) {
                historyFileList.innerHTML = '<li id="file-list-placeholder" class="text-gray-400">å°šæœªé¸æ“‡ä»»ä½• .md æª”æ¡ˆã€‚</li>';
                return;
            }

            const fileReadPromises = [];

            // 1. æ›´æ–° UI åˆ—è¡¨ä¸¦å»ºç«‹è®€å–æ‰¿è«¾ (Promise)
            for (const file of files) {
                // æ›´æ–° UI åˆ—è¡¨
                const listItem = document.createElement('li');
                listItem.className = 'text-gray-800';
                listItem.textContent = file.name;
                historyFileList.appendChild(listItem);

                // å»ºç«‹è®€å–æª”æ¡ˆçš„ Promise
                const readPromise = new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(new Error('ç„¡æ³•è®€å–æª”æ¡ˆ: ' + file.name));
                    reader.readAsText(file);
                });
                fileReadPromises.push(readPromise);
            }

            // 2. ç­‰å¾…æ‰€æœ‰æª”æ¡ˆè®€å–å®Œæˆ
            try {
                const fileContents = await Promise.all(fileReadPromises);
                
                // å°‡æ‰€æœ‰æª”æ¡ˆå…§å®¹åˆä½µï¼Œä¸¦ç”¨åˆ†éš”ç·šæ¨™è¨˜ï¼Œæ–¹ä¾¿ AI è¾¨è­˜
                combinedHistoryText = fileContents.join('\n\n--- (æ–°æª”æ¡ˆåˆ†éš”ç·š) ---\n\n');
                
                console.log('å·²è®€å–ä¸¦åˆä½µæª”æ¡ˆå…§å®¹ã€‚');

            } catch (err) {
                showError(err.message);
                // ç™¼ç”ŸéŒ¯èª¤æ™‚æ¸…ç©ºè®Šæ•¸
                combinedHistoryText = "";
            }
        }
        // END OF MODIFICATION

        /**
         * ä¸»è™•ç†å‡½æ•¸
         */
        async function handleGeneration() {
            // 1. é‡ç½® UI
            resetUI();

            // 2. ç²å–è¼¸å…¥
            const analysisText = analysisTextInput.value.trim();
            // MODIFICATION: ç›´æ¥ä½¿ç”¨å·²è®€å–çš„æª”æ¡ˆå…§å®¹
            const pastHistoryText = combinedHistoryText;
            // END OF MODIFICATION
            const selectedTask = task1Radio.checked ? "Task 1" : "Task 2";

            // 3. é©—è­‰ (Edge Cases & FR-008)
            if (!privacyCheck.checked) {
                showError('æ‚¨å¿…é ˆåŒæ„å‚³é€åˆ†ææ–‡å­— (FR-008)ã€‚');
                return;
            }
            if (!analysisText) {
                showError('åˆ†ææ–‡å­—å…§å®¹ä¸å¾—ç‚ºç©ºã€‚');
                return;
            }

            // 4. é¡¯ç¤º Loading (SC-001)
            loadingSpinner.classList.remove('hidden');
            resultsCard.classList.remove('hidden'); 

            try {
                // 5. [çœŸå¯¦ AI å‘¼å« 1] - åˆ†ææ–‡å­—
                const analysisResult = await callGeminiForAnalysis(analysisText);
                
                // 6. æ›´æ–° UI (åˆ†æéƒ¨åˆ†)
                updateUIWithAnalysis(analysisResult);

                // 7. [çœŸå¯¦ AI å‘¼å« 2] - ç”Ÿæˆé¡Œç›®
                // MODIFICATION: å‚³éåˆä½µå¾Œçš„æ­·å²ç´€éŒ„æ–‡å­—
                const generationResult = await callGeminiForGeneration(analysisResult, selectedTask, analysisText, pastHistoryText); 

                // 8. æ›´æ–° UI (ç”Ÿæˆé¡Œç›®éƒ¨åˆ†)
                updateUIWithGeneration(generationResult, selectedTask);

                // 9. æ›´æ–°æ­·å²ç´€éŒ„ (FR-007)
                updateHistory(analysisText, generationResult.question);

            } catch (err) {
                showError(`è™•ç†æ™‚ç™¼ç”ŸéŒ¯èª¤: ${err.message}`);
                resultsCard.classList.add('hidden');
            } finally {
                // éš±è— Loading
                loadingSpinner.classList.add('hidden');
            }
        }

        /**
         * å‘¼å« Gemini API é€²è¡Œåˆ†æ (FR-002, FR-003)
         * ä½¿ç”¨ JSON æ¨¡å¼
         */
        async function callGeminiForAnalysis(text) {
            const systemPrompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„ IELTS é›…æ€å¯«ä½œè©•åˆ†å“¡ã€‚è«‹è§£æä»¥ä¸‹ä½¿ç”¨è€…æä¾›çš„å¯«ä½œåˆ†æå›é¥‹æ–‡å­—ã€‚
            ä½ çš„ä»»å‹™æ˜¯ï¼š
            1. æå–å››å€‹è©•åˆ†é … (TA, CC, LR, GRA) çš„åˆ†æ•¸ã€‚å¦‚æœåˆ†æ•¸æ˜¯å€é–“ï¼ˆä¾‹å¦‚ 6.0-6.5ï¼‰ï¼Œå–è¼ƒä½çš„åˆ†æ•¸ã€‚å¦‚æœæ‰¾ä¸åˆ°ï¼Œå¡« "N/A"ã€‚
            2. æ ¹æ“šå›é¥‹æ–‡å­—ï¼Œæ’°å¯«ä¸€æ®µ 30-50 å­—çš„ç°¡çŸ­æ‘˜è¦ï¼Œé»å‡ºä¸»è¦çš„å¼·é …èˆ‡å¼±é …ã€‚
            
            ä½ å¿…é ˆåš´æ ¼ä»¥ JSON æ ¼å¼å›æ‡‰ï¼Œä¸å¾—åŒ…å«ä»»ä½• JSON ä»¥å¤–çš„æ–‡å­—ã€‚`;
            
            const userQuery = `è«‹è§£æé€™æ®µå›é¥‹ï¼š\n"""\n${text}\n"""`;

            const payload = {
                systemInstruction: { parts: [{ text: systemPrompt }] },
                contents: [{ parts: [{ text: userQuery }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "ta": { "type": "STRING", "description": "TA åˆ†æ•¸, e.g., '6.0' or 'N/A'" },
                            "cc": { "type": "STRING", "description": "CC åˆ†æ•¸, e.g., '6.5' or 'N/A'" },
                            "lr": { "type": "STRING", "description": "LR åˆ†æ•¸, e.g., '5.5' or 'N/A'" },
                            "gra": { "type": "STRING", "description": "GRA åˆ†æ•¸, e.g., '7.0' or 'N/A'" },
                            "summary": { "type": "STRING", "description": "30-50 å­—çš„æ‘˜è¦" }
                        },
                        required: ["ta", "cc", "lr", "gra", "summary"]
                    }
                }
            };

            const response = await fetchWithBackoff(apiUrl, payload);
            const jsonText = response.candidates[0].content.parts[0].text;
            return JSON.parse(jsonText);
        }

        /**
         * å‘¼å« Gemini API ç”Ÿæˆæ–°é¡Œç›® (FR-004, FR-005, FR-006)
         * ä½¿ç”¨ JSON æ¨¡å¼
         * --- MODIFIED as per user request (v6: Added History Analysis) ---
         */
        async function callGeminiForGeneration(analysis, taskType, rawAnalysisText, pastHistoryText) { 
            
            // å°‡åˆ†æ•¸è½‰æ›ç‚ºæ˜“æ–¼æ¯”è¼ƒçš„æ•¸å­—
            const scores = {
                'TA': parseFloat(analysis.ta) || 0,
                'CC': parseFloat(analysis.cc) || 0,
                'LR': parseFloat(analysis.lr) || 0,
                'GRA': parseFloat(analysis.gra) || 0,
            };

            // æå–åŸå§‹å•é¡Œæè¿°ï¼Œç”¨æ–¼å¼±é …ç²¾æº–å¼•ç”¨
            const getProblemDescription = (aspect) => {
                // Regex: æ‰¾åˆ° "ASPECT: [score] - [description]"
                const regex = new RegExp(`${aspect}: [\\d\\.\\-]+ - (.*)`, 'i');
                const match = rawAnalysisText.match(regex);
                if (match) {
                    return match[1].trim();
                } else {
                    const regexNoScore = new RegExp(`${aspect}: (.*)`, 'i');
                    const matchNoScore = rawAnalysisText.match(regexNoScore);
                    return matchNoScore ? matchNoScore[1].trim() : 'æœªæä¾›å…·é«”æè¿°ã€‚';
                }
            };

            // --- NEW TEMPLATE (v6: Incorporating History) ---
             const strategyTemplate = (taskType) => `
Â  Â  Â  Â  Â  Â  Â  Â  å‡ºé¡Œç­–ç•¥ (FR-006) - é‡å° Task ${taskType}:
				
				ä½ æ˜¯ä¸€åä¸–ç•Œç´šçš„é›…æ€å¯«ä½œå‡ºé¡Œå°ˆå®¶ï¼Œä½ çš„ç›®æ¨™æ˜¯æ ¹æ“šç”¨æˆ¶çš„**è‹±æ–‡å¯«ä½œåˆ†æçµæœ (æœ¬æ¬¡)**å’Œ**éå»çš„è¨“ç·´è¨˜éŒ„ (éå»)**ï¼Œè¨­è¨ˆä¸€å€‹æ¥µåº¦é‡å°æ€§çš„é›…æ€å¯«ä½œ Task ${taskType} é¡Œç›®
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  1.Â  **ç›®æ¨™ï¼š** å¿…é ˆè¨­è¨ˆä¸€å€‹åŒæ™‚æŒ‘æˆ°æ‰€æœ‰å¼±é» (åˆ†æ•¸ â‰¤ 6.5) ä¸¦å…è¨±ç™¼æ®æ‰€æœ‰å¼·é … (åˆ†æ•¸ â‰¥ 7.0) çš„é¡Œç›®ã€‚
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  2.Â  **æœ€å¤§ç—›é»é–å®š (CRITICAL - MUST DO)ï¼š**
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  * H-001: ä½ å¿…é ˆ**åŒæ™‚**åˆ†æ (A) **ã€Œæœ¬æ¬¡ã€**çš„å¼±é … (W) (å³åˆ†æ•¸ â‰¤ 6.5 çš„é …ç›®) å’Œ (B) **ã€Œéå»ã€**çš„è¨“ç·´è¨˜éŒ„ (pastHistoryText)ã€‚
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  * H-002: **(CRITICAL) èªå®šæœ€å¤§ç—›é» (Primary Pain Point)**ï¼šå°‡ (A) å’Œ (B) ä¸­**å…±åŒå‡ºç¾**ã€**åè¦†å‡ºç¾**ã€æˆ–**æœ¬æ¬¡åˆ†æ•¸æœ€ä½**çš„é …ç›®ï¼Œèªå®šç‚º**æœ€å¤§ç—›é»**ã€‚
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  * H-003: **(CRITICAL) ç—›é»æ­¸ç´**ï¼šä½ å¿…é ˆåœ¨ final 'logic' è¼¸å‡ºçš„ã€Œæœ€å¤§ç—›é»åˆ†æã€æ¬„ä½ä¸­ï¼Œ**æ˜ç¢ºåœ°ã€è©³ç´°åœ°æ­¸ç´ä½ å¦‚ä½•å¾ã€Œæœ¬æ¬¡ã€å’Œã€Œéå»ã€çš„åˆ†æä¸­é–å®šé€™å€‹æœ€å¤§ç—›é»**ã€‚(ä¾‹å¦‚ï¼šéå»å·²æ˜¯å¼±é …çš„ CCï¼Œæœ¬æ¬¡åˆ†æ•¸ä¾ç„¶æœ€ä½ï¼Œå› æ­¤é–å®šç‚ºæœ€å¤§ç—›é»ã€‚)
Â  Â  Â  Â  Â  Â  * H-004: ä½ çš„å‡ºé¡Œå¿…é ˆä»¥ H-002 é–å®šçš„**æœ€å¤§ç—›é»**ç‚ºæ ¸å¿ƒé€²è¡ŒæŒ‘æˆ°ã€‚
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  * H-005: è«‹å¿½ç•¥éå»è¨˜éŒ„ä¸­å¯èƒ½å­˜åœ¨çš„ã€Œç„¡éå»è¨˜éŒ„ã€ç­‰æ¨£æ¿æ–‡å­—ï¼Œå°ˆæ³¨æ–¼å¾ŒçºŒçš„å¯¦è³ªåˆ†æå…§å®¹ã€‚
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  3.Â  **SWOT åˆ†æè¦æ±‚ (MUST DO)ï¼š**
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  * H-006: é‡å°å¼·é … (S - Strength, åˆ†æ•¸ â‰¥ 7.0)ï¼šä½ å¿…é ˆæ‰¾å‡ºé€™äº›å¼·é …å¯ä»¥å¸¶ä¾†çš„ **O (æ©Ÿæœƒ/Opportunities)**ã€‚
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  * H-007: é‡å°å¼±é … (W - Weakness, åˆ†æ•¸ â‰¤ 6.5)ï¼šä½ å¿…é ˆæ‰¾å‡ºé€™äº›å¼±é»å¯èƒ½å°è‡´çš„ **T (å¨è„…/Threats)**ã€‚
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  * H-008: **(CRITICAL)** ä½ å¿…é ˆåœ¨ã€Œæ ¸å¿ƒå‡ºé¡Œé‚è¼¯ã€ä¸­ï¼Œ**æ˜ç¢º**èªªæ˜æ­¤é¡Œç›®å¦‚ä½•å°‡è‡³å°‘ä¸€å€‹ **O (ä¾†è‡ª H-006)** å’Œé‡å°**æœ€å¤§ç—›é» (ä¾†è‡ª H-002)** çš„ **T (ä¾†è‡ª H-007)** èå…¥é¡Œç›®è¨­è¨ˆä¸­ã€‚
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  4.Â  **å¼·é … (S) é‹ç”¨èˆ‡æ©Ÿæœƒ (O) å±•é–‹ (MUST DO)ï¼š**
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  -Â  Â ä½ å¿…é ˆå°‡æ‰€æœ‰åˆ†æ•¸ â‰¥ 7.0 çš„é …ç›® (TA, CC, LR, GRA) **å…¨éƒ¨ä»¥æ¢åˆ—å¼åˆ—å‡º**ã€‚
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  -Â  Â å°æ–¼**æ¯ä¸€å€‹**å¼·é …ï¼š
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  A. å¿…é ˆåˆ—å‡ºã€Œåˆ†ææè¿°ã€ã€‚
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  B. **å¿…é ˆ**ç‚ºæ­¤å¼·é …æä¾›ä¸€æ®µã€Œå¸¶ä¾†çš„æ©Ÿæœƒ (O)ã€ã€‚(åŸ·è¡Œ H-006)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  C. æ¥è‘—ï¼Œ**å¿…é ˆ**ä»”ç´°æª¢æŸ¥ã€Œå­¸ç”Ÿçš„åŸå§‹åˆ†æ/å›é¥‹æ–‡å­—ã€ä¸­è©²é …ç›®çš„æè¿° (å³ ${getProblemDescription('ASPECT')})ï¼Œä¸¦å¼•ç”¨å…·é«”è‹±æ–‡ä¾‹å¥/å¥å‹ï¼Œæˆ–æ¨æ–·å¥å‹æ¶æ§‹ã€‚

Â  Â  Â  Â  Â  Â  Â  Â  5.Â  **å¼±é … (W) æŒ‘æˆ°èˆ‡å¨è„… (T) é é˜² (MUST DO)ï¼š**
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  -Â  Â ä½ å¿…é ˆå°‡æ‰€æœ‰åˆ†æ•¸ â‰¤ 6.5 çš„é …ç›® (TA, CC, LR, GRA) **å…¨éƒ¨ä»¥æ¢åˆ—å¼åˆ—å‡º**ã€‚
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  -Â  Â å°æ–¼**æ¯ä¸€å€‹**å¼±é …ï¼š
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  A. éƒ½**å¿…é ˆ**å¾ã€Œå­¸ç”Ÿçš„åŸå§‹åˆ†æ/å›é¥‹æ–‡å­—ã€ä¸­ï¼Œ**ç²¾ç¢ºä¸”å®Œæ•´åœ°å¼•ç”¨**è©²å¼±é …çš„**å…·é«”å•é¡Œæè¿°**ï¼Œä¸¦æ¨™è¨»ç‚ºã€Œå•é¡Œé»ã€ã€‚(æ­¤ç‚º H-001 çš„ (A) éƒ¨åˆ†)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  B. **å¿…é ˆ**ç‚ºæ­¤å¼±é …æä¾›ä¸€æ®µã€Œæ½›åœ¨çš„å¨è„… (T)ã€ã€‚(åŸ·è¡Œ H-007)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  C. å¿…é ˆæä¾›é‡å°æ­¤å•é¡Œçš„å…·é«”ç·´ç¿’ç›®æ¨™ã€Œæœ¬æ¬¡ç›®æ¨™ã€ã€‚
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  **é‡å° Task 1 çš„ç‰¹åˆ¥è¦æ±‚ (MUST DO)ï¼š**
Â  Â  Â  Â  Â  Â  Â  Â  1.Â  åœ¨ã€Œæ ¸å¿ƒå‡ºé¡Œé‚è¼¯ã€ä¸­èªªæ˜ä½ é¸æ“‡äº†åœ–è¡¨é¡å‹ï¼Œä¸¦èªªæ˜è©²é¡å‹å¦‚ä½•æŒ‘æˆ°å¼±é» W/Tã€‚
Â  Â  Â  Â  Â  Â  Â  Â  2.Â  **å¿…é ˆ**é¡å¤–ç”Ÿæˆä¸€å€‹ \`chartDescription\` æ¬„ä½ã€‚æ­¤æ¬„ä½**å¿…é ˆ**åŒ…å«ä¸€å€‹**å®Œæ•´ä¸”è©³ç´°çš„åœ–è¡¨æ–‡å­—æè¿°**ï¼Œæ ¼å¼ç‚º **Markdown**ã€‚
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  è«‹å°‡å®Œæ•´çš„ã€Œæ­·å²åˆ†æã€å‡ºé¡Œé‚è¼¯ã€SWOT åˆ†æã€å½™æ•´æˆä¸€æ®µé€£è²«çš„ä¸­æ–‡æ–‡å­—ï¼Œä½œç‚º JSON è¼¸å‡ºä¸­çš„ \`logic\` å­—æ®µå…§å®¹ã€‚
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  **è¼¸å‡ºæ ¼å¼è¦æ±‚å¦‚ä¸‹ (è«‹åš´æ ¼éµå®ˆé€™å€‹æ¢åˆ—å¼çµæ§‹)ï¼š**
Â  Â  Â  Â  Â  Â  Â  Â  ---
Â  Â  Â  Â  Â  Â  Â  Â  æœ€å¤§ç—›é»åˆ†æï¼š[**åš´æ ¼åŸ·è¡Œ H-003**ï¼š**å¿…é ˆåœ¨æ­¤è©³ç´°æ­¸ç´**ä½ æ˜¯å¦‚ä½•çµåˆã€Œæœ¬æ¬¡å¼±é … Wã€å’Œã€Œéå»è¨˜éŒ„ã€ä¾†é–å®š**æœ€å¤§ç—›é»**çš„ã€‚å¦‚æœæ²’æœ‰éå»è¨˜éŒ„ï¼Œå‰‡åŸºæ–¼æœ¬æ¬¡åˆ†æé–å®šç—›é»ã€‚]
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  æ ¸å¿ƒå‡ºé¡Œé‚è¼¯ï¼š[**åš´æ ¼åŸ·è¡Œ H-008**ï¼šèªªæ˜é¸æ“‡æ­¤ä¸»é¡Œå’Œçµæ§‹çš„åŸå› ï¼Œ**ç‰¹åˆ¥è¦è§£é‡‹å¦‚ä½•å°‡ O (æ©Ÿæœƒ) å’Œé‡å° H-002 é–å®šä¹‹æœ€å¤§ç—›é»çš„ T (å¨è„…) èå…¥é¡Œç›®è¨­è¨ˆä¸­**ã€‚å¦‚æœæ˜¯ Task 1ï¼Œå¿…é ˆæŒ‡æ˜åœ–è¡¨é¡å‹ã€‚]

Â  Â  Â  Â  Â  Â  Â  Â  ğŸ’ª å¼·é … (Strength, S) èˆ‡æ©Ÿæœƒ (Opportunity, O)ï¼š
Â  Â  Â  Â  Â  Â  Â  Â  [æ­¤è™•åˆ—å‡ºæ‰€æœ‰å¼·é … (ä¾†è‡ªæœ¬æ¬¡åˆ†æ)]
Â  Â  Â  Â  Â  Â  Â  Â  ${
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Object.keys(scores).filter(key => scores[key] >= 7.0).map(aspect =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `* **${aspect} (Band ${scores[aspect]})**ï¼š
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  * *åˆ†ææè¿°ï¼š* ${getProblemDescription(aspect) || 'N/A'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  * *å¸¶ä¾†çš„æ©Ÿæœƒ (O)ï¼š* [é‡å°æ­¤å¼·é …ï¼Œå¯ä»¥æ‡‰å°å“ªäº›è¤‡é›œçš„å¯«ä½œæƒ…å¢ƒæˆ–é¡Œå‹ï¼Ÿ]
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  * *åŸæ–‡ä¾‹å¥/å¥å‹ï¼š* [è«‹æª¢æŸ¥ã€Œ${getProblemDescription(aspect)}ã€ä¸­æ˜¯å¦åŒ…å«è‹±æ–‡ç¯„ä¾‹æˆ–å¥å‹ï¼Œè‹¥æœ‰å‰‡**å¼•ç”¨**æ–¼æ­¤ï¼›è‹¥ç„¡ï¼Œå‰‡æ ¹æ“šæè¿°**æ¨æ–·**å¯èƒ½çš„å¥å‹æ¶æ§‹ã€‚]
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ).join('\n') || '* [æ‰€æœ‰åˆ†æ•¸çš†ä½æ–¼ 7.0ã€‚]'
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  ğŸš§ å¼±é … (Weakness, W) èˆ‡å¨è„… (Threat, T)ï¼š
Â  Â  Â  Â  Â  Â  Â  Â  [æ­¤è™•åˆ—å‡ºæ‰€æœ‰å¼±é … (ä¾†è‡ªæœ¬æ¬¡åˆ†æ)]
Â  Â  Â  Â  Â  Â  Â  Â  ${
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Object.keys(scores).filter(key => scores[key] <= 6.5 && scores[key] > 0).map(aspect =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `* **${aspect} (Band ${scores[aspect]})**ï¼š
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  * *å•é¡Œé» (ä¾†è‡ªä¸Šæ¬¡åˆ†æ)ï¼š* ${getProblemDescription(aspect)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  * *æ½›åœ¨çš„å¨è„… (T)ï¼š* [é‡å°æ­¤å¼±é»ï¼Œåœ¨å“ªäº›é¡Œå‹æˆ–è¤‡é›œæƒ…å¢ƒä¸‹æœƒæ›´å®¹æ˜“å¤±åˆ†ï¼Ÿ]
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  * *æœ¬æ¬¡ç›®æ¨™ï¼š* [é‡å°æ­¤å•é¡Œçš„å…·é«”ç·´ç¿’ç›®æ¨™ã€‚]
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ).join('\n') || '* [æ‰€æœ‰åˆ†æ•¸çš†é«˜æ–¼ 6.5ã€‚]'
 }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  **æœ¬æ¬¡é¡Œç›®è¨­è¨ˆç¸½çµï¼š** [ç”¨ä¸€æ®µè©±ç¸½çµæœ¬æ¬¡é¡Œç›®å¦‚ä½•åˆ©ç”¨ Oï¼Œä¸¦åŒæ™‚é¿é–‹/æŒ‘æˆ° T (ç‰¹åˆ¥æ˜¯ H-002 é–å®šçš„æœ€å¤§ç—›é»)ã€‚]
Â  Â  Â  Â  Â  Â  Â  Â  ---
Â  Â  Â  Â  Â  Â  `;
            // --- END OF NEW TEMPLATE (v6) ---

            let strategyDetails = strategyTemplate(taskType);
            
            const systemPrompt = `ä½ æ˜¯ä¸€å€‹é›…æ€å‡ºé¡Œ AIã€‚
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  ä½ çš„ä»»å‹™æ˜¯åš´æ ¼éµå¾ª ${taskType} çš„ã€Œå‡ºé¡Œç­–ç•¥ (FR-006)ã€ï¼Œä¸¦ç”Ÿæˆä¸€é“å€‹äººåŒ–çš„é¡Œç›®ã€‚

Â  Â  Â  Â  Â  Â  ${strategyDetails}
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  ä½ å¿…é ˆåš´æ ¼ä»¥ JSON æ ¼å¼å›æ‡‰ã€‚`;
            
            const userQuery = `
Â  Â  Â  Â  Â  Â  å­¸ç”Ÿçš„åˆ†æ•¸åˆ†æçµæœ (JSON æ ¼å¼, æ­¤ç‚ºã€Œæœ¬æ¬¡ã€åˆ†æ):
Â  Â  Â  Â  Â  Â  ${JSON.stringify(analysis, null, 2)}
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  å­¸ç”Ÿçš„åŸå§‹åˆ†æ/å›é¥‹æ–‡å­— (ç”¨æ–¼æå–ã€Œæœ¬æ¬¡ã€çš„ç²¾ç¢ºå•é¡Œé»å’Œå¼·é …ç¯„ä¾‹):
Â  Â  Â  Â  Â  Â  """
Â  Â  Â  Â  Â  Â  ${rawAnalysisText}
Â  Â  Â  Â  Â  Â  """
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  éå»çš„è¨“ç·´è¨˜éŒ„ (æ­¤ç‚ºã€Œéå»ã€åˆ†æï¼Œç”¨æ–¼å’Œã€Œæœ¬æ¬¡ã€åˆ†æçµåˆï¼Œä»¥åŸ·è¡Œ H-001 å’Œ H-002):
Â  Â  Â  Â  Â  Â  """
Â  Â  Â  Â  Â  Â  ${pastHistoryText || 'ç„¡éå»è¨˜éŒ„ã€‚'}
Â  Â  Â  Â  Â  Â  """
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  è«‹ç‚ºé€™ä½å­¸ç”Ÿç”Ÿæˆä¸€é“æ–°çš„ ${taskType} é¡Œç›®ã€‚å¦‚æœ Task 1ï¼Œè«‹åœ¨é¡Œç›®å‰åŠ ä¸Šåœ–è¡¨é¡å‹æç¤ºï¼Œä¾‹å¦‚ï¼š[Line Graph] The chart below...`;

            const payload = {
                systemInstruction: { parts: [{ text: systemPrompt }] },
                contents: [{ parts: [{ text: userQuery }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "question": { "type": "STRING", "description": `ç”Ÿæˆçš„ ${taskType} é¡Œç›®å…§æ–‡` },
                            "logic": { "type": "STRING", "description": "ç°¡çŸ­èªªæ˜ç‚ºä½•ç”Ÿæˆæ­¤é¡Œç›®ï¼ˆç¬¦åˆ FR-006ï¼‰" },
                            "chartDescription": { "type": "STRING", "description": "Markdown æ ¼å¼çš„è©³ç´°åœ–è¡¨æè¿°ï¼Œåƒ…åœ¨ Task 1 æ™‚æä¾›ã€‚" }
                        },
                        required: ["question", "logic"]
                    }
                }
            };
			
            console.log("=== DEBUG: æœ€çµ‚å‚³é€çµ¦ AI çš„ User Query ===");
            console.log(userQuery);
            console.log("=========================================");

            const response = await fetchWithBackoff(apiUrl, payload);
            const jsonText = response.candidates[0].content.parts[0].text;
            return JSON.parse(jsonText);
        }

        /**
         * å¸¶æœ‰æŒ‡æ•¸é€€è®“é‡è©¦çš„ Fetch
         */
        async function fetchWithBackoff(url, payload, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`API è«‹æ±‚å¤±æ•—: ${response.status} ${JSON.stringify(errorBody)}`);
                }
                
                const result = await response.json();
                
                if (!result.candidates || !result.candidates[0].content || !result.candidates[0].content.parts[0].text) {
                     throw new Error('å¾ API æ”¶åˆ°çš„å›æ‡‰æ ¼å¼ç„¡æ•ˆæˆ–ç‚ºç©ºã€‚');
                }

                return result;

            } catch (err) {
                if (retries > 0) {
                    await new Promise(r => setTimeout(r, delay));
                    return fetchWithBackoff(url, payload, retries - 1, delay * 2);
                } else {
                    console.error('API å‘¼å«é‡è©¦å¤±æ•—:', err);
                    throw err; // æœ€çµ‚æ‹‹å‡ºéŒ¯èª¤
                }
            }
        }

        /**
         * é‡ç½® UI ç‹€æ…‹
         */
        function resetUI() {
            errorMessage.classList.add('hidden');
            loadingSpinner.classList.add('hidden');
            resultsCard.classList.add('hidden');
            
            // é‡ç½®çµæœå¡ç‰‡å…§å®¹
            scoreTa.textContent = "...";
            scoreCc.textContent = "...";
            scoreLr.textContent = "...";
            scoreGra.textContent = "...";
            analysisSummary.textContent = "AI æ­£åœ¨åˆ†æ...";
            newQuestion.textContent = "AI æ­£åœ¨ç”Ÿæˆé¡Œç›®...";
            generationLogic.textContent = "AI æ­£åœ¨åˆ†æç”Ÿæˆç­–ç•¥...";
            
            // é‡ç½®åœ–è¡¨æè¿°
            chartDescriptionContainer.classList.add('hidden');
            chartDescriptionContent.textContent = "...åœ–è¡¨æè¿°å°‡é¡¯ç¤ºæ–¼æ­¤...";
            copyChartBtn.textContent = 'è¤‡è£½';

            // MODIFICATION: é‡ç½®å°å‡ºæŒ‰éˆ•ç‹€æ…‹
            exportLogicBtn.disabled = true;
            exportLogicBtn.textContent = 'å°å‡ºç‚º Markdown';
            rawLogicText = ''; // æ¸…é™¤åŸå§‹é‚è¼¯æ–‡å­—
            // END OF MODIFICATION

            // MODIFICATION: é‡ç½®æª”æ¡ˆä¸Šå‚³æ¬„ä½ (REMOVED - é€™äº›æ˜¯è¼¸å…¥ï¼Œä¸æ‡‰åœ¨æ­¤é‡ç½®)
            //historyFileInput.value = null; // æ¸…ç©ºæª”æ¡ˆé¸æ“‡
            //historyFileList.innerHTML = '<li id="file-list-placeholder" class="text-gray-400">å°šæœªé¸æ“‡ä»»ä½• .md æª”æ¡ˆã€‚</li>';
            //combinedHistoryText = ""; // æ¸…ç©ºå„²å­˜çš„æ–‡å­—
            // END OF MODIFICATION
        }

        /**
         * é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
         */
        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
            loadingSpinner.classList.add('hidden');
        }

        /**
         * å°‡ (AI åˆ†æ) çµæœæ›´æ–°åˆ° UI
         */
        function updateUIWithAnalysis(analysis) {
            scoreTa.textContent = analysis.ta || 'N/A';
            scoreCc.textContent = analysis.cc || 'N/A';
            scoreLr.textContent = analysis.lr || 'N/A';
            scoreGra.textContent = analysis.gra || 'N/A';
            analysisSummary.textContent = analysis.summary || 'AI æœªèƒ½æä¾›æ‘˜è¦ã€‚';
        }

        /**
         * å°‡ (AI ç”Ÿæˆ) çµæœæ›´æ–°åˆ° UI
         */
        function updateUIWithGeneration(generation, taskType) {
            taskTypeLabel.textContent = `IELTS Writing ${taskType}`;
            newQuestion.textContent = generation.question || 'AI æœªèƒ½ç”Ÿæˆé¡Œç›®ã€‚';

            // MODIFICATION: å„²å­˜åŸå§‹é‚è¼¯æ–‡å­—ä¸¦å•Ÿç”¨å°å‡ºæŒ‰éˆ•
            rawLogicText = generation.logic;
            exportLogicBtn.disabled = false;
            // END OF MODIFICATION

            let formattedLogic = generation.logic;
            
            // 1. è™•ç†åˆ†éš”ç·š (HTML)
            formattedLogic = formattedLogic.replace(/---/g, '<hr class="my-3 border-blue-300">');

            // 2. è™•ç†æ¨™é¡Œ (HTML)
            // éå»è¨˜éŒ„åˆ†æï¼š(æ–°å¢)
            formattedLogic = formattedLogic.replace(/^(æœ€å¤§ç—›é»åˆ†æï¼š)/gm, '<strong class="text-indigo-700 font-extrabold">$1</strong>');
            // æ ¸å¿ƒå‡ºé¡Œé‚è¼¯
            formattedLogic = formattedLogic.replace(/^(æ ¸å¿ƒå‡ºé¡Œé‚è¼¯ï¼š)/gm, '<strong class="text-gray-900">$1</strong>');
            // ğŸ’ª å¼·é … (Strength, S) èˆ‡æ©Ÿæœƒ (Opportunity, O)ï¼š
            formattedLogic = formattedLogic.replace(/^(ğŸ’ª å¼·é … \(Strength, S\) èˆ‡æ©Ÿæœƒ \(Opportunity, O\)ï¼š)/gm, '<strong class="text-blue-700">$1</strong>');
            // ğŸš§ å¼±é … (Weakness, W) èˆ‡å¨è„… (Threat, T)ï¼š
            formattedLogic = formattedLogic.replace(/^(ğŸš§ å¼±é … \(Weakness, W\) èˆ‡å¨è„… \(Threat, T\)ï¼š)/gm, '<strong class="text-red-700">$1</strong>');
            // æœ¬æ¬¡é¡Œç›®è¨­è¨ˆç¸½çµï¼š
            formattedLogic = formattedLogic.replace(/^(\*\*æœ¬æ¬¡é¡Œç›®è¨­è¨ˆç¸½çµï¼š\*\*)/gm, '<strong class="text-blue-700">æœ¬æ¬¡é¡Œç›®è¨­è¨ˆç¸½çµï¼š</strong>');
            
            // 3. è™•ç†æ¢åˆ—å¼é …ç›®
            // * **ASPECT (Band X)**ï¼š -> â€¢ **ASPECT (Band X)**ï¼š
            formattedLogic = formattedLogic.replace(/\* \*\*(.*?)\*\*ï¼š/g, 'â€¢ <strong class="text-gray-900">$1</strong>ï¼š');
            
            // * *åˆ†ææè¿°ï¼š* / *å•é¡Œé» (ä¾†è‡ªä¸Šæ¬¡åˆ†æ)ï¼š* / *å¸¶ä¾†çš„æ©Ÿæœƒ (O)ï¼š* / *æ½›åœ¨çš„å¨è„… (T)ï¼š* / *æœ¬æ¬¡ç›®æ¨™ï¼š*
            formattedLogic = formattedLogic.replace(/\* \*(.*?)\*ï¼š/g, '  â†³ <span class="font-semibold italic">$1</span>ï¼š');

            // 4. è™•ç†æ•¸å­—åˆ—è¡¨ (HTML)
            formattedLogic = formattedLogic.replace(/^(1\. .*)$/gm, '<span class="ml-4">$1</span>');
            formattedLogic = formattedLogic.replace(/^(2\. .*)$/gm, '<span class="ml-4">$1</span>');
            formattedLogic = formattedLogic.replace(/^(3\. .*)$/gm, '<span class="ml-4">$1</span>');

            generationLogic.innerHTML = formattedLogic;
            
            // è™•ç† Task 1 åœ–è¡¨æè¿°
            if (taskType === 'Task 1' && generation.chartDescription) {
                chartDescriptionContent.textContent = generation.chartDescription;
                chartDescriptionContainer.classList.remove('hidden');
            } else {
                chartDescriptionContainer.classList.add('hidden');
            }
        }

        /**
         * MODIFICATION: å°å‡ºé‚è¼¯ç‚º Markdown æª”æ¡ˆ
         */
        function exportLogicAsMarkdown() {
            if (!rawLogicText) {
                alert('æ²’æœ‰å¯å°å‡ºçš„ç”Ÿæˆé‚è¼¯ã€‚');
                return;
            }

            // æ¨¡æ“¬ Markdown æª”æ¡ˆå…§å®¹ï¼Œä½¿ç”¨ç°¡å–®çš„æ¨™é¡Œå’ŒåŸå§‹æ–‡æœ¬
            const markdownContent = `
# IELTS å¯«ä½œå€‹äººåŒ–è¨“ç·´è¨˜éŒ„ (å°å‡ºæ—¥æœŸ: ${new Date().toLocaleDateString()})

---

${rawLogicText}
`;

            const blob = new Blob([markdownContent], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `IELTS_Training_Logic_${Date.now()}.md`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            exportLogicBtn.textContent = 'å°å‡ºæˆåŠŸ!';
            setTimeout(() => { exportLogicBtn.textContent = 'å°å‡ºç‚º Markdown'; }, 3000);
        }
        // END OF MODIFICATION

        /**
         * æ›´æ–°æ­·å²ç´€éŒ„ (FR-007)
         */
        function updateHistory(analysisText, questionText) {
            const placeholder = document.getElementById('history-placeholder');
            if (placeholder) {
                placeholder.remove();
            }

            const listItem = document.createElement('li');
            listItem.className = 'py-3 border-b border-gray-100 last:border-b-0';
            
            const shortAnalysis = analysisText.length > 50 ? analysisText.substring(0, 50) + '...' : analysisText;
            const shortQuestion = questionText.length > 60 ? questionText.substring(0, 60) + '...' : questionText;

            listItem.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm font-medium text-gray-800">${shortQuestion}</p>
                        <p class="text-xs text-gray-500">ä¾†æºåˆ†æ: ${shortAnalysis}</p>
                    </div>
                    <span class="text-xs text-gray-400">${new Date().toLocaleTimeString()}</span>
                </div>
            `;
            
            // å°‡æœ€æ–°çš„ç´€éŒ„åŠ åˆ°æœ€å‰é¢
            historyList.prepend(listItem);
        }

        /**
         * è¤‡è£½åœ–è¡¨æè¿°åˆ°å‰ªè²¼ç°¿
         */
        function copyChartDescription() {
            const textToCopy = chartDescriptionContent.textContent;
            
            // å„ªå…ˆä½¿ç”¨ navigator.clipboard (æ›´ç¾ä»£)
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    copyChartBtn.textContent = 'å·²è¤‡è£½!';
                    setTimeout(() => { copyChartBtn.textContent = 'è¤‡è£½'; }, 2000);
                }).catch(err => {
                    console.error('ç„¡æ³•ä½¿ç”¨ Clipboard API: ', err);
                    fallbackCopyText(textToCopy); // é™ç´šè™•ç†
                });
            } else {
                // é™ç´šä½¿ç”¨ document.execCommand (é©ç”¨æ–¼ä¸å®‰å…¨çš„ http æˆ– iFrame)
                fallbackCopyText(textToCopy);
            }
        }

        /**
         * é™ç´šè¤‡è£½æ–¹æ³•
         */
        function fallbackCopyText(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            
            // é¿å…åœ¨ç•«é¢ä¸Šé¡¯ç¤º
            textArea.style.position = 'fixed';
            textArea.style.top = 0;
            textArea.style.left = 0;
            textArea.style.opacity = 0;

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    copyChartBtn.textContent = 'å·²è¤‡è£½!';
                } else {
                    copyChartBtn.textContent = 'è¤‡è£½å¤±æ•—';
                }
            } catch (err) {
                console.error('ç„¡æ³•è¤‡è£½æ–‡å­—: ', err);
                copyChartBtn.textContent = 'è¤‡è£½å¤±æ•—';
            }

            document.body.removeChild(textArea);
            setTimeout(() => { copyChartBtn.textContent = 'è¤‡è£½'; }, 2000);
        }

    </script>

</body>
</html>