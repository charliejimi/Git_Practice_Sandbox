<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯«ä½œæ ¡æº–å„€å¼ SOP - Writing Correction Ritual (Local History)</title>
    
<script src="https://cdn.tailwindcss.com"></script>
    
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
    
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        /* Custom styles for the ritualistic feel */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1a202c 0%, #0d121c 100%); /* Darker gradient background */
        }
        .header-glow {
            text-shadow: 0 0 8px rgba(99, 102, 241, 0.6), 0 0 15px rgba(99, 102, 241, 0.4);
        }
        .ritual-card {
            background-color: #1f2937; /* Darker card background */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.2); /* Deeper shadow */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* Smoother transition */
            border-left: 5px solid;
            position: relative;
            overflow: hidden;
        }
        .ritual-card:hover:not(.completed):not(.locked) {
            transform: translateY(-5px); /* More pronounced lift */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.6), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
            border-left-color: #a78bfa !important; /* Lighter indigo for hover */
        }
        .completed {
            opacity: 0.8; 
            border-left-color: #34d399 !important; /* Green 400 */
            filter: grayscale(10%); 
        }
        .locked {
            opacity: 0.5;
            filter: blur(1px) grayscale(50%);
            cursor: not-allowed;
            pointer-events: none; /* Disable click events */
        }
        .phase-diagnosis {
            border-left-color: #6366f1; /* Indigo 500 */
        }
        .phase-verification {
            border-left-color: #f59e0b; /* Amber 500 */
        }
        .step-toggle {
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            position: relative;
            z-index: 10;
        }
        .step-toggle:active {
            transform: scale(0.95);
        }

        /* Gradient for buttons */
        .btn-gradient {
            background: linear-gradient(90deg, #6366f1, #8b5cf6); /* Indigo to Violet */
            border: none;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        .btn-gradient:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: 0.5s;
            z-index: -1;
        }
        .btn-gradient:hover:before {
            left: 100%;
        }
        .btn-gradient:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        /* New Complete Button Gradient */
        .btn-complete {
             background: linear-gradient(90deg, #10b981, #059669); /* Emerald Gradient */
        }
        .btn-complete:hover {
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.7);
        }
        .btn-complete:disabled {
            background: #4b5563;
        }


        /* Custom scrollbar for textareas */
        textarea {
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: #6366f1 #1f2937; /* thumb and track */
        }
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-track {
            background: #1f2937;
            border-radius: 10px;
        }
        textarea::-webkit-scrollbar-thumb {
            background-color: #6366f1;
            border-radius: 10px;
            border: 2px solid #1f2937;
        }
        
        /* Table styles */
        #history-list th, #history-list td {
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
            /* Default small width */
            max-width: 80px; 
            padding-left: 0.75rem; /* px-3 */
            padding-right: 0.75rem; /* px-3 */
        }
        @media (min-width: 768px) {
            /* Adjusted widths for desktop view with 5 columns */
            #history-list th:nth-child(2), #history-list td:nth-child(2) { /* Original (A) */
                max-width: 180px; 
            }
            #history-list th:nth-child(3), #history-list td:nth-child(3) { /* Corrected (B) */
                max-width: 180px;
            }
            #history-list th:nth-child(4), #history-list td:nth-child(4) { /* Principle (Step 7) */
                 max-width: 220px; 
            }
            #history-list th:nth-child(5), #history-list td:nth-child(5) { /* Action */
                 max-width: 80px; 
                 width: 80px;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 md:p-10">

    <div class="max-w-4xl mx-auto">
        
<header class="text-center mb-10">
            <h1 class="text-4xl md:text-6xl font-extrabold text-white mb-3 tracking-tight header-glow font-orbitron">
                å¯«ä½œæ ¡æº–å„€å¼
            </h1>
            <p class="text-indigo-300 text-lg md:text-xl font-light">Writing Error Analysis and Correction SOP (æœ¬åœ°å„²å­˜)</p>
            <div id="progress-bar" class="w-full bg-gray-700 rounded-full h-3 mt-6 relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-r from-purple-500 to-indigo-500 opacity-20"></div>
                <div id="progress-fill" class="bg-gradient-to-r from-green-400 to-emerald-500 h-full rounded-full transition-all duration-700 ease-out shadow-lg shadow-green-500/30" style="width: 0%"></div>
            </div>
            <p id="progress-text" class="text-sm mt-2 text-gray-400">0 / 8 æ­¥é©Ÿå·²å®Œæˆ</p>
        </header>

        
<div class="bg-gray-800 p-6 rounded-2xl mb-8 shadow-2xl border border-gray-700">
            <label for="writing-text" class="block text-xl font-semibold mb-3 text-indigo-200">
                A. æ¬²æ ¡æº–çš„åŸå§‹å¥å­æˆ–æ®µè½ï¼š
            </label>
            <textarea id="writing-text" rows="2" class="w-full p-4 rounded-xl bg-gray-700 border border-gray-600 text-white placeholder-gray-500 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-200 shadow-inner" placeholder="è«‹è¼¸å…¥æ‚¨æƒ³è¦æ ¡æº–çš„å¥å­ã€‚"></textarea>
            
            
<button id="diagnosis-btn" onclick="window.handleDiagnosis()" class="w-full mt-4 flex items-center justify-center space-x-2 px-6 py-3 btn-gradient text-white font-bold rounded-xl transition duration-300 shadow-xl hover:shadow-indigo-500/70 active:scale-98" disabled>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                <span>è§£é–ï¼šæ™ºèƒ½è¨ºæ–·èˆ‡ä¿®æ­£å»ºè­° (AI Diagnosis & Suggestion)</span>
            </button>
            
            <div id="diagnosis-unlock-message" class="mt-4 text-center text-amber-400 font-semibold bg-gray-900/50 p-3 rounded-lg border border-amber-600/50">
                ğŸ”’ è«‹å…ˆå®Œæˆã€Œç¬¬ä¸€éšæ®µï¼šå•é¡Œè¨ºæ–· (æ­¥é©Ÿ 1-4)ã€æ‰èƒ½è§£é–æ™ºèƒ½è¨ºæ–·å’Œå¾ŒçºŒé©—è­‰æ­¥é©Ÿã€‚
            </div>

            
<div id="diagnosis-loading" class="hidden mt-4 text-center">
                <div class="flex items-center justify-center text-indigo-400">
                    <svg class="animate-spin -ml-1 mr-3 h-6 w-6 text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    æ­£åœ¨é€²è¡Œæ™ºèƒ½è¨ºæ–·... è«‹ç¨å€™ç‰‡åˆ»ã€‚
                </div>
            </div>
            <div id="diagnosis-result" class="mt-4">
                
</div>

            <!-- NEW: Final Corrected Sentence Input -->
            <div class="mt-8 pt-6 border-t border-gray-700">
                <label for="final-corrected-text" class="block text-xl font-semibold mb-3 text-green-300">
                    B. æœ€çµ‚æ ¡æº–å¾Œçš„å¥å­ï¼š
                </label>
                <textarea id="final-corrected-text" rows="2" class="w-full p-4 rounded-xl bg-gray-700 border border-gray-600 text-white placeholder-gray-500 focus:ring-green-500 focus:border-green-500 transition-all duration-200 shadow-inner" placeholder="è«‹å°‡æ‚¨æ ¹æ“šæ­¥é©Ÿ 1-8 å¾¹åº•æ ¡æº–å¾Œçš„æœ€çµ‚å¥å­è¼¸å…¥æ–¼æ­¤ã€‚"></textarea>
            </div>


            <!-- NEW: Complete Ritual Button -->
            <button id="complete-ritual-btn" onclick="window.checkRitualCompletion()" class="w-full mt-6 flex items-center justify-center space-x-2 px-6 py-4 btn-complete text-white font-bold text-lg rounded-xl transition duration-300 shadow-xl hover:shadow-green-500/70 active:scale-98" disabled>
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span id="complete-ritual-text">å®Œæˆæ‰€æœ‰ 8 å€‹æ­¥é©Ÿå¾Œï¼Œé»æ“Šæ­¤è™•è¨˜éŒ„æ­·å²</span>
            </button>
            
            <p id="completion-message" class="text-sm text-gray-500 mt-4 text-center">
                 æç¤ºï¼šæ™ºèƒ½è¨ºæ–·å°‡ç‚ºæ‚¨æä¾›ä¸€å€‹**ç›´è¦ºä¿®æ­£**çš„èµ·é»ã€‚æ‚¨ä»éœ€åŸ·è¡Œæ­¥é©Ÿ 5-8 é€²è¡Œåš´è¬¹çš„**é©—è­‰**ã€‚
            </p>
        </div>

        
<div id="step-list" class="space-y-6">
            
</div>

        <!-- UPDATED: History Section -->
        <section class="mt-12 pt-8 border-t border-gray-700">
            <h2 class="text-3xl font-bold text-indigo-300 mb-6 header-glow">æ­·å²æ ¡æº–ç´€éŒ„ (æœ¬åœ°å„²å­˜)</h2>
            <div id="history-list">
                <!-- History Table will be rendered here by JavaScript -->
                <p class="text-center text-gray-500 p-4 border border-gray-700 rounded-xl bg-gray-800/50">
                    è¼‰å…¥ä¸­...
                </p>
            </div>
            
            <!-- === MODIFICATION START: Added wrapper and export button === -->
            <div class="flex justify-center items-center space-x-4 mt-4">
                <button onclick="window.exportHistoryAsMarkdown()" class="text-sm text-green-400 hover:text-green-300 transition-colors duration-150 p-2 rounded-md hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block -mt-1 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    åŒ¯å‡ºç‚º Markdown
                </button>
                <button onclick="window.clearHistory()" class="text-sm text-red-400 hover:text-red-300 transition-colors duration-150 p-2 rounded-md hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block -mt-1 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                   æ¸…é™¤æ‰€æœ‰æœ¬åœ°ç´€éŒ„
                </button>
            </div>
        </section>

        
<footer class="mt-12 pt-8 border-t border-gray-700 text-center">
            <p class="text-gray-400 text-base font-light">
                æµç¨‹ç¸½çµï¼š[å¯«ä½œ] â†’ [æ­¥é©Ÿ 1-4 è¨ºæ–·] â†’ [å»ºç«‹ä¿®æ”¹ (ç›´è¦º)] â†’ [æ­¥é©Ÿ 5-8 é©—è­‰ (åç›´è¦º)] â†’ [ç¢ºèªæœ€çµ‚ä¿®æ­£ï¼Œè¨˜éŒ„å®Œæˆ]
            </p>
        </footer>
    </div>

    <script type="module">
        // --- Gemini API Setup ---
        const apiKey = "AIzaSyAzBdrm2Ma3LWkdo87hC_TZlLPc7cuqNEo"; 
        const modelName = "gemini-2.5-flash";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

        // Function for exponential backoff retry logic
        async function fetchWithRetry(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if (i < retries - 1 && response.status >= 400) {
                            await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000 + Math.random() * 500)); 
                            continue;
                        }
                    }
                    return response;
                } catch (error) {
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000 + Math.random() * 500)); 
                        continue;
                    }
                    throw error;
                }
            }
            throw new Error('Fetch failed after multiple retries.');
        }

        // --- Core SOP Data ---
        const stepsData = [
            // Phase I: Diagnosis (Steps 1-4) - Indigo Theme
            { id: 1, phase: 'Diagnosis', title: 'æœ—è®€æª¢æŸ¥ (Read-Aloud Check)', icon: 'ğŸ”Š', focus: 'æµæš¢åº¦/çµæ§‹', detail: 'å¤§è²æœ—è®€å¥å­ã€‚å“ªè£¡æœ‰å¡é “ã€çŒ¶è±«æˆ–éœ€è¦æ›æ°£ï¼Ÿ', error: 'èªå¥éé•·ï¼Œçµæ§‹æ··äº‚ã€‚', className: 'phase-diagnosis', notePlaceholder: 'åœ¨æ­¤è¨˜éŒ„æ‚¨ç™¼ç¾çš„çµæ§‹å•é¡Œ' },
            { id: 2, phase: 'Diagnosis', title: 'è©å½¢æª¢æŸ¥ (Word Form Check)', icon: 'ğŸ“', focus: 'èªæ³•/è©æ€§', detail: 'æè¿°ã€Œæ¦‚å¿µã€æˆ–ã€Œäº‹ç‰©ã€æ™‚ï¼Œæ˜¯å¦èª¤ç”¨äº† V-ingï¼Ÿè©æ€§æ˜¯å¦ä¸€è‡´ï¼Ÿï¼ˆå¦‚ï¼š`constructing` â†’ `construction`ï¼‰', error: 'åè©åŒ–å•é¡Œï¼šV-ing $\\rightarrow$ Nounã€‚', className: 'phase-diagnosis', notePlaceholder: 'åœ¨æ­¤è¨˜éŒ„è©æ€§è½‰æ›çš„ä¾æ“š' },
            { id: 3, phase: 'Diagnosis', title: 'ç²¾ç¢ºåº¦æª¢æŸ¥ (Precision Check)', icon: 'ğŸ¯', focus: 'è©å½™/æ­é…', detail: 'æ¯å€‹é—œéµè©æ˜¯å¦ã€Œæœ€æº–ç¢ºã€ï¼Ÿè©èªæ­é…ï¼ˆCollocationï¼‰æ˜¯å¦è‡ªç„¶ï¼Ÿï¼ˆå¦‚ï¼š`old construction` â†’ `old building`ï¼‰', error: 'è©èªé¸æ“‡ä¸ç²¾ç¢ºã€‚', className: 'phase-diagnosis', notePlaceholder: 'åœ¨æ­¤è¨˜éŒ„æ›´æ›¿ç‚ºæ›´ç²¾æº–çš„è©å½™' },
            { id: 4, phase: 'Diagnosis', title: 'é€£è²«æ€§æª¢æŸ¥ (Cohesion Check)', icon: 'ğŸ”—', focus: 'é€£æ¥/é‡è¤‡', detail: 'æ˜¯å¦ã€Œä¸å¿…è¦åœ°é‡è¤‡ã€äº†å‰ä¸€å¥çš„ä¸»èªï¼Ÿéæ¸¡æ˜¯å¦å½†æ‰­ï¼Ÿ', error: 'ä¸å¿…è¦çš„é‡è¤‡ä¸»èªã€‚', className: 'phase-diagnosis', notePlaceholder: 'åœ¨æ­¤è¨˜éŒ„é€£è²«æ€§çš„æ”¹å–„æ–¹æ³•' },
            
            // Phase II: Verification (Steps 5-8) - Amber Theme
            { id: 5, phase: 'Verification', title: 'Google èªæ–™åº«é©—è­‰', icon: 'ğŸ”', focus: 'è‡ªç„¶åº¦/è¦æ¨¡', detail: 'ä½¿ç”¨é›™å¼•è™Ÿ (`"..."`) æœç´¢ä¿®æ”¹å¾Œçš„è©çµ„ã€‚æª¢æŸ¥çµæœä¾†æºã€‚', error: 'ä¿®æ”¹å¾Œç„¡æ”¶éŒ„æˆ–ä¾†æºä¸å¯é ã€‚', verificationStandard: 'A. è¦æ¨¡ï¼šä¿®æ­£å¾Œçš„è©çµ„æœ‰é¡¯è‘—æ›´å¤šçš„æœç´¢çµæœã€‚B. ä¾†æºï¼šçµæœä¾†è‡ªå¯é æ–°è/å­¸è¡“ç¶²ç«™ã€‚', className: 'phase-verification', notePlaceholder: 'åœ¨æ­¤è¨˜éŒ„èªæ–™åº«é©—è­‰çµæœ' },
            { id: 6, phase: 'Verification', title: 'AI å·¥å…·è¤‡æŸ¥', icon: 'ğŸ¤–', focus: 'èªæ³•/æµæš¢åº¦', detail: 'å°‡ã€Œæ•´å€‹ä¿®æ”¹å¾Œçš„å¥å­ã€è²¼å…¥å°ˆæ¥­å¯«ä½œå·¥å…·ï¼ˆå¦‚ Grammarlyï¼‰ã€‚', error: 'AI ä»æ¨™è¨˜éŒ¯èª¤ã€‚', verificationStandard: 'AI ä¸å†æ¨™è¨˜ä¿®æ”¹éƒ¨åˆ†ä¸­çš„èªæ³•æˆ–æµæš¢æ€§éŒ¯èª¤ã€‚', className: 'phase-verification', notePlaceholder: 'åœ¨æ­¤è¨˜éŒ„ AI è¤‡æŸ¥çµæœï¼ˆé€šé/æœªé€šéï¼‰' },
            { id: 7, phase: 'Verification', title: 'åŸç†æ¨å° (Principle Deduction)', icon: 'ğŸ§ ', focus: 'è¦å‰‡/åˆ†æ', detail: 'å¼·è¿«è‡ªå·±ç‚ºä¿®æ­£å¯«ä¸‹ä¸€æ¢ç°¡çŸ­çš„ã€Œèªæ³•/è©å½™è¦å‰‡ã€ä½œç‚ºã€Œå‚™è¨»ã€ã€‚', error: 'ç„¡æ³•æ¸…æ™°é—¡è¿°è¦å‰‡ã€‚', verificationStandard: 'å¯ä»¥æ¸…æ™°é—¡è¿°è¦å‰‡ï¼ˆä¾‹å¦‚ï¼šã€Œéµå¾ªåè©åŒ–åŸå‰‡ã€ï¼‰ã€‚', className: 'phase-verification', notePlaceholder: 'ï¼ˆåœ¨æ­¤è™•è¨˜éŒ„ä¿®æ­£çš„è¦å‰‡ï¼Œé€™æ˜¯åˆ†æçš„è­‰æ˜ï¼‰' },
            { id: 8, phase: 'Verification', title: 'ç¯„æ–‡æ¯”è¼ƒ', icon: 'ğŸ†', focus: 'é¢¨æ ¼/è¡¨é”', detail: 'å›æ†¶æˆ–æœç´¢é«˜åˆ†ç¯„æ–‡ï¼Œå°‹æ‰¾ç›¸ä¼¼è¡¨é”æˆ–çµæ§‹ã€‚', error: 'è¡¨é”èˆ‡é«˜åˆ†ç¯„æ–‡ä¸ç¬¦ã€‚', verificationStandard: 'æ‚¨çš„ä¿®æ”¹èˆ‡é«˜åˆ† IELTS ç¯„æ–‡ä¸­ä½¿ç”¨çš„æªè¾­ä¿æŒä¸€è‡´ã€‚', className: 'phase-verification', notePlaceholder: 'åœ¨æ­¤è¨˜éŒ„ç¯„æ–‡åƒè€ƒä¾†æºæˆ–å°æ¯”çµæœ' }
        ];

        let state = {
            steps: stepsData.map(s => ({ ...s, completed: false, userNote: '' })),
            originalWritingText: '', 
            history: [],
        };

        const stepList = document.getElementById('step-list');
        const progressBar = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const diagnosisBtn = document.getElementById('diagnosis-btn');
        const diagnosisUnlockMsg = document.getElementById('diagnosis-unlock-message');
        const completeRitualBtn = document.getElementById('complete-ritual-btn');
        const completeRitualText = document.getElementById('complete-ritual-text');
        const finalCorrectedTextarea = document.getElementById('final-corrected-text');
        const originalWritingTextarea = document.getElementById('writing-text');
        const completionMessage = document.getElementById('completion-message');

        const verificationStepIds = [5, 6, 7, 8];
        const historyList = document.getElementById('history-list');

        // --- History Functions ---

        function loadHistory() {
            try {
                const storedHistory = localStorage.getItem('ritualHistory');
                if (storedHistory) {
                    state.history = JSON.parse(storedHistory);
                }
            } catch (e) {
                console.error("ç„¡æ³•å¾ localStorage è¼‰å…¥æ­·å²ç´€éŒ„:", e);
                state.history = []; // Fallback
            }
        }
        
        function saveHistory() {
            const completedTime = new Date().toLocaleString('zh-TW', {
                year: 'numeric', month: '2-digit', day: '2-digit', 
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
            
            const finalCorrected = finalCorrectedTextarea.value.trim();
            const original = originalWritingTextarea.value.trim();
            
            // æ‰¾åˆ°æ­¥é©Ÿ 7 (åŸç†æ¨å°) çš„ä½¿ç”¨è€…å‚™è¨»
            const principleNote = state.steps.find(s => s.id === 7)?.userNote || 'ç„¡ç´€éŒ„'; 
            
            // NEW: Assign a unique ID (timestamp in ms)
            const uniqueId = Date.now();

            const newEntry = {
                id: uniqueId, // <--- æ–°å¢å”¯ä¸€ ID
                timestamp: completedTime,
                // Use captured state (from the moment diagnosis was run) or current value as fallback
                original: state.originalWritingText || original, 
                corrected: finalCorrected,
                principle: principleNote
            };
            
            // Check if captured original text is available, or if the current original text is not empty
            if (newEntry.original === '' || newEntry.corrected === '') {
                // Prevent saving if either original or corrected are empty
                console.warn("æœªå®Œæˆæ ¡æº–ï¼ŒåŸå§‹å¥å­æˆ–æœ€çµ‚ä¿®æ­£å¥å­ç‚ºç©ºã€‚ä¸å„²å­˜æ­·å²ç´€éŒ„ã€‚");
                completionMessage.textContent = 'âŒ ç„¡æ³•è¨˜éŒ„ï¼šåŸå§‹å¥å­æˆ–æœ€çµ‚ä¿®æ­£çµæœä¸èƒ½ç‚ºç©ºã€‚';
                completionMessage.classList.remove('text-gray-500', 'text-green-400');
                completionMessage.classList.add('text-red-400');
                return false;
            }
            
            state.history.unshift(newEntry); // Add to the beginning
            
            try {
                localStorage.setItem('ritualHistory', JSON.stringify(state.history));
                completionMessage.textContent = `ğŸ‰ å„€å¼åœ“æ»¿å®Œæˆï¼ç´€éŒ„å·²å„²å­˜ï¼Œæ­£åœ¨é‡ç½®... (A: ${newEntry.original.substring(0, 20)}... | B: ${newEntry.corrected.substring(0, 20)}...)`;
                completionMessage.classList.remove('text-gray-500', 'text-red-400');
                completionMessage.classList.add('text-green-400', 'font-bold');
                return true;
            } catch (e) {
                console.error("ç„¡æ³•å°‡æ­·å²ç´€éŒ„å„²å­˜åˆ° localStorage:", e);
                completionMessage.textContent = 'âŒ å„²å­˜å¤±æ•—ï¼šæœ¬åœ°å„²å­˜ç©ºé–“ç™¼ç”ŸéŒ¯èª¤ã€‚';
                completionMessage.classList.remove('text-gray-500', 'text-green-400');
                completionMessage.classList.add('text-red-400');
                return false;
            }
        }

        // NEW: Function to delete a history entry
        function deleteHistoryEntry(id) {
            // Convert id to number as it's a timestamp
            const entryId = Number(id);
            
            if (!confirm('æ‚¨ç¢ºå®šè¦æ°¸ä¹…ç§»é™¤é€™ç­†æ­·å²ç´€éŒ„å—ï¼Ÿ')) {
                return;
            }

            const initialLength = state.history.length;
            
            // Filter out the entry with the matching ID
            state.history = state.history.filter(entry => entry.id !== entryId);

            if (state.history.length < initialLength) {
                // Only update localStorage and re-render if something was actually removed
                try {
                    localStorage.setItem('ritualHistory', JSON.stringify(state.history));
                    renderHistory();
                    completionMessage.textContent = `ğŸ—‘ï¸ ç´€éŒ„ ID ${id} å·²æˆåŠŸç§»é™¤ã€‚`;
                    completionMessage.classList.remove('text-gray-500', 'text-green-400', 'font-bold', 'text-amber-400');
                    completionMessage.classList.add('text-red-400');
                    setTimeout(() => {
                        completionMessage.textContent = 'æç¤ºï¼šæ™ºèƒ½è¨ºæ–·å°‡ç‚ºæ‚¨æä¾›ä¸€å€‹ç›´è¦ºä¿®æ­£çš„èµ·é»ã€‚æ‚¨ä»éœ€åŸ·è¡Œæ­¥é©Ÿ 5-8 é€²è¡Œåš´è¬¹çš„é©—è­‰ã€‚';
                        completionMessage.classList.remove('text-red-400');
                        completionMessage.classList.add('text-gray-500');
                    }, 3000);
                } catch (e) {
                    console.error("ç„¡æ³•æ›´æ–° localStorage:", e);
                }
            } else {
                 console.warn(`Attempted to delete ID ${id}, but no matching entry was found.`);
            }
        }


        function renderHistory() {
            
            if (state.history.length === 0) {
                historyList.innerHTML = '<p class="text-center text-gray-500 p-4 border border-gray-700 rounded-xl bg-gray-800/50">ç›®å‰æ²’æœ‰å·²å®Œæˆçš„æ ¡æº–ç´€éŒ„ã€‚</p>';
                return;
            }

            const tableHtml = `
                <div class="overflow-x-auto rounded-xl shadow-lg border border-gray-700">
                    <table id="history-table" class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-700">
                            <tr>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-1/12">æ™‚é–“</th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-3/12">åŸå§‹å¥å­ (A)</th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-3/12">æ ¡æº–å¾Œå¥å­ (B)</th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-4/12">åŸç†æ¨å° (Step 7)</th>
                                <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider w-1/12">æ“ä½œ</th> 
                            </tr>
                        </thead>
                        <tbody class="bg-gray-800 divide-y divide-gray-700">
                            ${state.history.map(entry => `
                                <tr class="hover:bg-gray-700 transition-colors duration-150">
                                    <td class="px-3 py-3 text-sm text-gray-400">${entry.timestamp.split(', ')[1]}<br><span class="text-xs text-gray-500">${entry.timestamp.split(', ')[0]}</span></td>
                                    <td class="px-3 py-3 text-sm text-indigo-300">${entry.original}</td>
                                    <td class="px-3 py-3 text-sm text-green-300 font-medium">${entry.corrected}</td>
                                    <td class="px-3 py-3 text-sm text-yellow-300">${entry.principle || 'N/A'}</td>
                                    <td class="px-3 py-3 text-center">
                                         <button onclick="window.deleteHistoryEntry(${entry.id})" class="text-red-400 hover:text-red-300 bg-red-900/30 hover:bg-red-900/50 p-1 rounded-md text-sm transition-colors duration-150 active:scale-95">
                                            âŒ</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            historyList.innerHTML = tableHtml;
        }
        
        function clearHistory() {
             // Replaced alert() with standard JS confirm() for simple deletion confirmation
             if (confirm('æ‚¨ç¢ºå®šè¦æ°¸ä¹…æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ ¡æº–ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼')) {
                 console.warn("Clearing all local ritual history. This cannot be undone.");
                 localStorage.removeItem('ritualHistory');
                 state.history = [];
                 
                 // Provide immediate feedback in the UI
                 historyList.innerHTML = '<p class="text-center text-red-400 p-4 border border-red-700 rounded-xl bg-red-900/50 font-bold">æ‰€æœ‰æ­·å²ç´€éŒ„å·²æ¸…é™¤ï¼</p>';
                 
                 setTimeout(() => {
                     renderHistory(); // Re-render the empty state after a brief delay
                     completionMessage.textContent = 'æç¤ºï¼šæ™ºèƒ½è¨ºæ–·å°‡ç‚ºæ‚¨æä¾›ä¸€å€‹ç›´è¦ºä¿®æ­£çš„èµ·é»ã€‚æ‚¨ä»éœ€åŸ·è¡Œæ­¥é©Ÿ 5-8 é€²è¡Œåš´è¬¹çš„é©—è­‰ã€‚';
                     completionMessage.classList.remove('text-red-400', 'text-green-400', 'font-bold');
                     completionMessage.classList.add('text-gray-500');
                 }, 3000);
             }
        }
        
        // === MODIFICATION START: Added export function ===
        /**
         * Exports the current history state to a Markdown file.
         */
        function exportHistoryAsMarkdown() {
            const history = state.history;
            
			// *** æ–°å¢æ­¤è¡Œæª¢æŸ¥ ***
           console.log("History is not empty. Proceeding to generate Markdown.");
	
            if (!history || history.length === 0) {
                completionMessage.textContent = 'â„¹ï¸ æ²’æœ‰å¯åŒ¯å‡ºçš„æ­·å²ç´€éŒ„ã€‚';
                completionMessage.classList.remove('text-gray-500', 'text-green-400', 'text-red-400');
                completionMessage.classList.add('text-amber-400', 'font-bold');
                setTimeout(() => {
                    completionMessage.textContent = 'æç¤ºï¼šæ™ºèƒ½è¨ºæ–·å°‡ç‚ºæ‚¨æä¾›ä¸€å€‹ç›´è¦ºä¿®æ­£çš„èµ·é»ã€‚æ‚¨ä»éœ€åŸ·è¡Œæ­¥é©Ÿ 5-8 é€²è¡Œåš´è¬¹çš„é©—è­‰ã€‚';
                    completionMessage.classList.remove('text-amber-400', 'font-bold');
                    completionMessage.classList.add('text-gray-500');
                }, 3000);
                return;
            }

            // Helper to clean text for Markdown table cells
            const clean = (str) => {
                if (!str) return 'N/A';
                // Escape pipes and replace newlines with <br> for visibility in Markdown tables
                return str.replace(/\|/g, '\\|').replace(/\n/g, '<br>');
            };

            let markdownContent = "# å¯«ä½œæ ¡æº–ç´€éŒ„\n\n";
            markdownContent += "| éŒ¯èª¤æˆ–ä¸ç•¶ | å»ºè­°çš„ä¿®æ”¹æˆ–è£œå…… | è¨»é‡‹ |\n";
            markdownContent += "|:---|:---|:---|\n";

            // Add each history entry as a table row (history is already unshifted, so it's in reverse chronological order)
            for (const entry of history) {
                markdownContent += `| ${clean(entry.original)} | ${clean(entry.corrected)} | ${clean(entry.principle)} |\n`;
            }

            try {
                // Create a blob and trigger download
                const blob = new Blob([markdownContent], { type: 'text/markdown;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                // Generate a timestamped filename
                const date = new Date();
                const filename = `writing-history-${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}.md`;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // Show success message
                completionMessage.textContent = `âœ… æˆåŠŸåŒ¯å‡º ${history.length} ç­†ç´€éŒ„ç‚º ${filename}ï¼`;
                completionMessage.classList.remove('text-gray-500', 'text-red-400', 'text-amber-400');
                completionMessage.classList.add('text-green-400', 'font-bold');
                setTimeout(() => {
                    completionMessage.textContent = 'æç¤ºï¼šæ™ºèƒ½è¨ºæ–·å°‡ç‚ºæ‚¨æä¾›ä¸€å€‹ç›´è¦ºä¿®æ­£çš„èµ·é»ã€‚æ‚¨ä»éœ€åŸ·è¡Œæ­¥é©Ÿ 5-8 é€²è¡Œåš´è¬¹çš„é©—è­‰ã€‚';
                    completionMessage.classList.remove('text-green-400', 'font-bold');
                    completionMessage.classList.add('text-gray-500');
                }, 4000);

            } catch (e) {
                console.error("ç„¡æ³•åŒ¯å‡º Markdown:", e);
                completionMessage.textContent = 'âŒ åŒ¯å‡ºå¤±æ•—ï¼šç„¡æ³•å»ºç«‹ä¸‹è¼‰æª”æ¡ˆã€‚';
                completionMessage.classList.remove('text-gray-500', 'text-green-400');
                completionMessage.classList.add('text-red-400', 'font-bold');
            }
        }
        // === MODIFICATION END ===
        
        // --- NEW: Check Completion and Save ---
        function checkRitualCompletion() {
            if (state.steps.every(s => s.completed)) {
                // All 8 steps complete, trigger save and reset
                if (saveHistory()) {
                    setTimeout(resetRitual, 2000); // Auto-reset after successful saving
                }
            } else {
                completionMessage.textContent = 'âš ï¸ è«‹å…ˆå®Œæˆæ‰€æœ‰ 8 å€‹æ ¡æº–æ­¥é©Ÿæ‰èƒ½è¨˜éŒ„æ­·å²ç´€éŒ„ã€‚';
                completionMessage.classList.remove('text-gray-500', 'text-green-400');
                completionMessage.classList.add('text-amber-400', 'font-bold');
            }
        }
        
        // --- Ritual Core Functions ---

        function resetRitual() {
            // Reset step completion and notes
            state.steps = stepsData.map(s => ({ ...s, completed: false, userNote: '', locked: s.id >= 5 }));
            state.originalWritingText = ''; // Reset original text
            
            // Reset text areas and diagnosis result
            originalWritingTextarea.value = '';
            finalCorrectedTextarea.value = '';
            document.getElementById('diagnosis-result').innerHTML = '';

            // Reset completion message
            completionMessage.textContent = 'æç¤ºï¼šæ™ºèƒ½è¨ºæ–·å°‡ç‚ºæ‚¨æä¾›ä¸€å€‹ç›´è¦ºä¿®æ­£çš„èµ·é»ã€‚æ‚¨ä»éœ€åŸ·è¡Œæ­¥é©Ÿ 5-8 é€²è¡Œåš´è¬¹çš„é©—è­‰ã€‚';
            completionMessage.classList.remove('text-red-400', 'text-green-400', 'font-bold', 'text-amber-400');
            completionMessage.classList.add('text-gray-500');


            // Re-render
            updateLockStatus(); 
            renderSteps();
            updateProgress(); // This will update the button state too
            renderHistory(); 
            originalWritingTextarea.focus();
        }

        // Function to call Gemini for writing diagnosis
        async function handleDiagnosis() {
            const writingText = originalWritingTextarea.value.trim();
            const resultDiv = document.getElementById('diagnosis-result');
            const loadingDiv = document.getElementById('diagnosis-loading');
            
            // Check if Diagnosis Phase is complete
            if (!isDiagnosisPhaseComplete()) {
                 resultDiv.innerHTML = '<p class="text-red-400 p-3 rounded-md bg-red-900/20 border border-red-700">ğŸš¨ å¿…é ˆå…ˆå®Œæˆæ­¥é©Ÿ 1-4 çš„æ‰‹å‹•è¨ºæ–·ï¼</p>';
                 return;
            }

            if (!writingText) {
                resultDiv.innerHTML = '<p class="text-red-400 p-3 rounded-md bg-red-900/20 border border-red-700">ğŸš¨ è«‹å…ˆåœ¨ä¸Šæ–¹è¼¸å…¥æ‚¨çš„åŸå§‹å¥å­æˆ–æ®µè½ã€‚</p>';
                return;
            }
            
            // Capture the initial text when diagnosis is run. This will be recorded as 'A'.
            if (state.originalWritingText === '') {
                 state.originalWritingText = writingText;
            }


            // Show loading state
            loadingDiv.classList.remove('hidden');
            resultDiv.innerHTML = '';

            const systemPrompt = `
                ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„è‹±æ–‡å¯«ä½œå°å¸«ã€‚
                ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šç”¨æˆ¶æä¾›çš„å¥å­ï¼ŒåŸ·è¡Œã€Œå¯«ä½œè¨ºæ–· SOPã€ä¸­çš„å‰å››å€‹è¨ºæ–·æ­¥é©Ÿï¼Œä¸¦ä»¥ JSON æ ¼å¼è¼¸å‡ºçµæœã€‚
                è¨ºæ–·æ‡‰æ¶µè“‹ï¼šæµæš¢åº¦/çµæ§‹ (Fluency/Structure)ã€èªæ³•/è©å½¢ (Grammar/Word Form)ã€è©å½™/æ­é… (Lexis/Collocation)ã€å’Œé€£è²«æ€§ (Cohesion)ã€‚
                
                è«‹åš´æ ¼éµå¾ªä»¥ä¸‹æ­¥é©Ÿä¸¦ä»¥ JSON æ ¼å¼è¿”å›çµæœï¼š
                1. æª¢æŸ¥ä¸¦æä¾›ä¸€å€‹**ä¿®æ­£å¾Œçš„å¥å­** (correctedSentence)ã€‚
                2. åˆ¤æ–·ä¸»è¦çš„**éŒ¯èª¤é¡å‹** (errorType)ï¼Œå¿…é ˆæ˜¯ä»¥ä¸‹å››ç¨®ä¹‹ä¸€ï¼šFluency (æµæš¢åº¦/çµæ§‹), Grammar (èªæ³•/è©å½¢), Lexis (è©å½™/æ­é…), Cohesion (é€£è²«æ€§)ã€‚
                3. æä¾›**ä¿®æ­£çš„ä¾æ“š** (rationale)ï¼Œèªªæ˜ç‚ºä½•éœ€è¦é€²è¡Œæ­¤ä¿®æ­£ã€‚
            `;
            
            const userQuery = `è«‹åˆ†æä¸¦ä¿®æ­£ä»¥ä¸‹å¥å­ï¼š"${writingText}"`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "correctedSentence": { "type": "STRING", description: "ä¿®æ­£å¾Œçš„å®Œæ•´å¥å­" },
                            "errorType": { "type": "STRING", description: "ä¸»è¦çš„éŒ¯èª¤é¡å‹ (Fluency, Grammar, Lexis, Cohesion)" },
                            "rationale": { "type": "STRING", description: "ä¿®æ­£çš„ä¾æ“šå’ŒåŸå› " }
                        },
                        "propertyOrdering": ["correctedSentence", "errorType", "rationale"]
                    }
                }
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("API Response Error:", response.status, errorBody);
                    throw new Error(`API request failed with status ${response.status}: ${errorBody}`);
                }
                
                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!jsonText) {
                    console.error("Invalid API response structure:", result);
                    throw new Error("API returned no content or an unexpected structure.");
                }

                const data = JSON.parse(jsonText);
                
                // Update the final correction box with the suggested correction for convenience
                finalCorrectedTextarea.value = data.correctedSentence;

                resultDiv.innerHTML = `
                    <div class="space-y-3 p-4 rounded-xl bg-indigo-900/40 border border-indigo-700 shadow-md">
                        <p class="font-bold text-indigo-300 text-lg flex items-center">
                            <svg class="w-6 h-6 mr-2 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            æ™ºèƒ½è¨ºæ–·çµæœèˆ‡ä¿®æ­£å»ºè­°:
                        </p>
                        <div class="bg-gray-700 p-3 rounded-md border border-gray-600 shadow-inner">
                            <p class="text-sm text-gray-400 mb-1">AI å»ºè­°ä¿®æ­£:</p>
                            <p class="text-white font-medium text-lg">${data.correctedSentence}</p>
                        </div>
                        <p class="text-sm">
                            <span class="font-semibold text-amber-300">ä¸»è¦éŒ¯èª¤é¡å‹:</span> 
                            <span class="bg-amber-800 text-amber-100 px-2 py-0.5 rounded-full text-xs font-semibold">${data.errorType}</span>
                        </p>
                        <p class="text-sm">
                            <span class="font-semibold text-indigo-300">ä¿®æ­£ä¾æ“š:</span> ${data.rationale}
                        </p>
                        <p class="text-xs text-gray-400 mt-2 text-center">
                            * AI å»ºè­°å·²è‡ªå‹•å¡«å…¥ä¸‹æ–¹çš„**ã€Œæœ€çµ‚æ ¡æº–å¾Œçš„å¥å­ã€**ç·¨è¼¯æ¡†ã€‚æ‚¨ç¾åœ¨å¯ä»¥æ ¹æ“šæ­¥é©Ÿ 5-8 é€²è¡Œé©—è­‰ä¸¦è‡ªç”±ä¿®æ”¹ã€‚
                        </p>
                    </div>
                `;

            } catch (error) {
                console.error("Gemini API Error:", error);
                resultDiv.innerHTML = `<p class="text-red-400 mt-4 p-3 rounded-md bg-red-900/20 border border-red-700">ğŸš¨ LLM è¨ºæ–·å¤±æ•—ï¼šç„¡æ³•ç²å–ä¿®æ­£å»ºè­°ã€‚è«‹æª¢æŸ¥æ‚¨çš„ API Keyã€å¸³æˆ¶é¤˜é¡æˆ–ç¨å¾Œé‡è©¦ã€‚(${error.message})</p>`;
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }

        // Helper function to check if all diagnosis steps (1-4) are complete
        function isDiagnosisPhaseComplete() {
            return state.steps.slice(0, 4).every(s => s.completed);
        }
        
        // Helper function to check if all 8 steps are complete
        function isRitualComplete() {
            return state.steps.every(s => s.completed);
        }


        // Function to update the lock/unlock state
        function updateLockStatus() {
            const isDiagnosisPhaseDone = isDiagnosisPhaseComplete();
            const isAllComplete = isRitualComplete();
            
            // 1. Toggle Diagnosis Button (AI)
            diagnosisBtn.disabled = !isDiagnosisPhaseDone;
            diagnosisUnlockMsg.classList.toggle('hidden', isDiagnosisPhaseDone);
            
            if (isDiagnosisPhaseDone) {
                 diagnosisBtn.querySelector('span').textContent = 'âœ¨ æ™ºèƒ½è¨ºæ–·èˆ‡ä¿®æ­£å»ºè­° (AI Diagnosis & Suggestion)';
            } else {
                 diagnosisBtn.querySelector('span').textContent = 'è§£é–ï¼šæ™ºèƒ½è¨ºæ–·èˆ‡ä¿®æ­£å»ºè­° (AI Diagnosis & Suggestion)';
            }
            
            // 2. Toggle Complete Ritual Button
            completeRitualBtn.disabled = !isAllComplete;
            if (isAllComplete) {
                completeRitualText.textContent = 'âœ… å®Œæˆå„€å¼ä¸¦è¨˜éŒ„æ­·å² (é»æ“Šæ­¤è™•)';
                completeRitualBtn.classList.add('shadow-green-500/70');
            } else {
                 completeRitualText.textContent = 'å®Œæˆæ‰€æœ‰ 8 å€‹æ­¥é©Ÿå¾Œï¼Œé»æ“Šæ­¤è™•è¨˜éŒ„æ­·å²';
                 completeRitualBtn.classList.remove('shadow-green-500/70');
            }
            
            // 3. Toggle Verification Steps (5-8) lock status
            state.steps.forEach(step => {
                if (verificationStepIds.includes(step.id)) {
                    step.locked = !isDiagnosisPhaseDone;
                }
            });
        }

        // Function to update the progress bar and text
        function updateProgress() {
            const completedCount = state.steps.filter(s => s.completed).length;
            const totalCount = state.steps.length;
            const percentage = (completedCount / totalCount) * 100;

            progressBar.style.width = `${percentage}%`;

            if (completedCount === totalCount) {
                progressText.innerHTML = '<span class="text-green-400 font-bold text-lg">ğŸ‰ æ‰€æœ‰æ­¥é©Ÿå·²å®Œæˆï¼è«‹åœ¨ä¸‹æ–¹é»æ“Šã€Œå®Œæˆå„€å¼ä¸¦è¨˜éŒ„ã€æŒ‰éˆ•ã€‚</span>';
            } else {
                 progressText.textContent = `${completedCount} / ${totalCount} æ­¥é©Ÿå·²å®Œæˆ ${isDiagnosisPhaseComplete() ? '(å·²å®Œæˆè¨ºæ–·)' : ''}`;
            }
            
            updateLockStatus(); // Ensure button states reflect progress
        }

        // Function to toggle the completion status of a step
        function toggleStepCompletion(id) {
            const stepIndex = state.steps.findIndex(s => s.id === id);
            if (stepIndex !== -1) {
                // Prevent toggling locked steps
                if (state.steps[stepIndex].locked) return;

                state.steps[stepIndex].completed = !state.steps[stepIndex].completed;
                
                // Crucial: Update lock status before rendering
                updateLockStatus(); 
                
                renderSteps();
                updateProgress();
            }
        }
        
        // Function to handle note input changes
        function handleNoteChange(id, value) {
            const stepIndex = state.steps.findIndex(s => s.id === id);
            if (stepIndex !== -1) {
                state.steps[stepIndex].userNote = value;
            }
        }

        // Main rendering function
        function renderSteps() {
            // First ensure the lock status is up to date for rendering classes
            updateLockStatus(); 

            stepList.innerHTML = state.steps.map(step => {
                const isCompleted = step.completed;
                const isLocked = step.locked; 
                const phaseTitle = step.phase === 'Diagnosis' ? 'ç¬¬ä¸€éšæ®µï¼šå•é¡Œè¨ºæ–·' : 'ç¬¬äºŒéšæ®µï¼šéŒ¯èª¤é©—è­‰';
                const phaseBgColor = step.phase === 'Diagnosis' ? 'bg-indigo-500' : 'bg-amber-500';

                const cardClasses = `ritual-card ${step.className} ${isCompleted ? 'completed' : ''} ${isLocked ? 'locked' : ''} p-5 rounded-2xl transition-all duration-300 relative`;
                const toggleClass = `step-toggle flex-shrink-0 w-12 h-12 rounded-full ${isCompleted ? 'bg-green-500 hover:bg-green-600' : (isLocked ? 'bg-gray-800' : 'bg-gray-700 hover:bg-indigo-600')} flex items-center justify-center`;
                
                return `
                    <div id="step-${step.id}" class="${cardClasses}">
                         <!--${isCompleted ? `<div class="absolute top-0 right-0 m-4 text-green-400 text-3xl opacity-90"><svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg></div>` : ''}
                         -->
                        ${isLocked ? `<div class="absolute inset-0 flex items-center justify-center bg-gray-900/70 z-20">
                            <svg class="w-12 h-12 text-amber-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2h2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2h2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path></svg>
                        </div>` : ''}

                        <div class="flex items-start justify-between">
                            <div class="flex items-center space-x-3 w-full">
                                
                                <!-- Step Icon -->
                                <div class="flex-shrink-0 w-10 h-10 rounded-full ${phaseBgColor} text-white font-bold flex items-center justify-center text-xl">
                                    ${step.icon}
                                </div>
                                
                                <div class="flex-grow">
                                    <!-- Phase Tag -->
                                    <span class="inline-block px-2 py-0.5 text-xs font-bold uppercase rounded-full tracking-wider 
                                        ${step.phase === 'Diagnosis' ? 'text-indigo-300 bg-indigo-900/50 border border-indigo-700' : 'text-amber-300 bg-amber-900/50 border border-amber-700'}">
                                        ${phaseTitle}
                                    </span>
                                    <h2 class="text-xl font-bold ${isCompleted ? 'text-gray-400 line-through' : 'text-white'} mt-1">
                                        ${step.id}. ${step.title}
                                    </h2>
                                </div>
                                
                                
                                <div class="${toggleClass}" onclick="window.toggleStepCompletion(${step.id})">
                                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${isCompleted ? 'M5 13l4 4L19 7' : 'M12 4v16m8-8H4'}"></path></svg>
                                </div>
                            </div>
                        </div>

                        
                        <div class="mt-4 pl-14 text-gray-300">
                            <p class="mb-2 text-sm"><strong>å°ˆæ³¨é ˜åŸŸ:</strong> <span class="text-indigo-200">${step.focus}</span></p>
                            <p class="mb-2 text-sm"><strong>åŸ·è¡Œç´°ç¯€:</strong> <span class="math-tex">${step.detail}</span></p>
                            ${step.verificationStandard ? `<p class="mb-2 text-sm"><strong>é©—è­‰æ¨™æº–:</strong> <span class="text-amber-200">${step.verificationStandard}</span></p>` : `<p class="mb-2 text-sm"><strong>éŒ¯èª¤é¡å‹ï¼ˆç¯„ä¾‹ï¼‰:</strong> <span class="text-red-300">${step.error}</span></p>`}
                            
                            
                            <label for="note-${step.id}" class="block text-sm font-medium mt-3 ${isCompleted ? 'text-gray-500' : 'text-gray-300'}">
                                å„€å¼ç´€éŒ„ï¼ˆå‚™è¨»ï¼‰ï¼š
                            </label>
                            <textarea id="note-${step.id}" rows="2" class="w-full p-2 mt-1 rounded-lg ${isCompleted ? 'bg-gray-700 text-gray-400 border-gray-600' : 'bg-gray-700 border border-gray-600 text-white'} focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-200 shadow-inner" placeholder="${step.notePlaceholder}" oninput="window.handleNoteChange(${step.id}, this.value)" ${isCompleted || isLocked ? 'readonly' : ''}>${step.userNote}</textarea>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Re-render MathJax after inserting new HTML
            if (window.MathJax) {
                window.MathJax.typeset();
            }
        }

        // --- Expose functions to the global scope for HTML attributes ---
        window.handleDiagnosis = handleDiagnosis;
        window.toggleStepCompletion = toggleStepCompletion;
        window.handleNoteChange = handleNoteChange;
        window.clearHistory = clearHistory; 
        window.checkRitualCompletion = checkRitualCompletion; // Expose new completion function
        window.deleteHistoryEntry = deleteHistoryEntry; // <--- Expose new delete function
        window.exportHistoryAsMarkdown = exportHistoryAsMarkdown; // <-- MODIFICATION: Added export function
        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            loadHistory(); // Load history first
            // Initialize the ritual state
            resetRitual(); 
        });
    </script>
</body>
</html>