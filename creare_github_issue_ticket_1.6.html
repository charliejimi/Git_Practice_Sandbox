<!DOCTYPE html>
<html lang="zh-Hant" class="dark"> <!-- 預設啟用暗黑模式 --><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Task 1 - AI vs Self Assessment</title>
    
    <!-- 載入 Tailwind CSS CDN --><script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind 設定：必須緊接在 CDN 載入之後執行 --><script>
        tailwind.config = {
            darkMode: 'class', // 啟用 class-based 暗黑模式
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'], // 支援中文
                    },
                    colors: {
                        darkBg: '#1a1a2e', // 深色背景
                        cardBg: '#2a2a4a', // 卡片背景
                        primaryBtnStart: '#6a11cb', // 漸層按鈕起始色
                        primaryBtnEnd: '#2575fc',   // 漸層按鈕結束色
                        accentGreen: '#34d399',     // 完成提示綠色
                        accentYellow: '#fbbf24',    // 警告提示黃色
                        borderDark: '#4a4a6e',      // 深色邊框
                        successGreen: '#10b981',    // 成功提示綠色
                        errorRed: '#ef4444',        // 錯誤提示紅色
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght{300;400;500;700}&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', 'sans-serif';
            -webkit-font-smoothing: antialiased;
            -moz-osx-osx-smoothing: grayscale;
        }
        /* 自訂 placeholder 樣式，使其在暗黑模式下更明顯 */
        textarea::placeholder, input::placeholder {
            color: #888; 
            opacity: 0.7;
        }
        .gradient-button {
            background-image: linear-gradient(to right, var(--tw-gradient-stops));
            background-size: 200% auto;
            transition: background-position 0.3s ease;
        }
        .gradient-button:hover {
            background-position: right center; 
        }

        /* 隱藏原生日期選擇器箭頭 */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1); /* 反轉顏色以適應暗色模式 */
            cursor: pointer;
        }
        
        /* 隱藏 Number 輸入框的上下箭頭 (Spin Buttons)，確保只能打字 */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield; /* Firefox 兼容 */
        }
    </style>
</head>
<body class="bg-darkBg text-gray-100 flex flex-col items-center py-12 px-6 min-h-screen">

    <!-- 頂部標題與說明 --><div class="text-center mb-10">
        <h1 class="text-5xl md:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-blue-500 mb-4 tracking-tight">
            IELTS Task 1 評估與反思
        </h1>
        <p class="text-lg text-gray-300">AI vs 自我評估比較分析 (進階格式化與內容隱藏)</p>
    </div>

    <!-- 主表單容器 --><div class="max-w-4xl w-full space-y-8">
        
        <!-- GitHub Repo 設定卡片 --><div class="bg-cardBg p-6 md:p-8 rounded-xl shadow-lg border border-borderDark">
            <h2 class="text-2xl font-semibold text-blue-400 mb-4">⚙️ GitHub 儲存庫與 API 設定</h2>
            <p class="text-gray-300 mb-5 text-sm md:text-base">
                要自動建立 Issue，您需要提供具有 `repo` 權限的 Personal Access Token (PAT)。
            </p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- User Name --><div class="col-span-1">
                    <label for="github_user" class="block text-sm font-medium text-gray-400 mb-2">GitHub 使用者名稱</label>
                    <input type="text" id="github_user" name="github_user" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200" placeholder="例如：your-username" value="charliejimi">
                </div>
                <!-- Repo Name --><div class="col-span-1">
                    <label for="github_repo" class="block text-sm font-medium text-gray-400 mb-2">GitHub 儲存庫名稱</label>
                    <input type="text" id="github_repo" name="github_repo" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200" placeholder="例如：ielts-writing-tracker" value="Git_Practice_Sandbox">
                </div>
                <!-- PAT Token --><div class="col-span-1">
                    <label for="github_token" class="block text-sm font-medium text-gray-400 mb-2">Personal Access Token (PAT)</label>
                    <input type="password" id="github_token" name="github_token" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" value="">
                </div>
            </div>
            <p id="repo-error" class="text-red-400 text-sm mt-4 hidden">🚨 請務必填寫所有 GitHub 欄位，包括 PAT。</p>
        </div>

        <!-- Issue 表單 --><form id="issue-form" class="space-y-8">

            <!-- 1. 題目名稱/編號 --><div class="bg-cardBg p-6 md:p-8 rounded-xl shadow-lg border border-borderDark">
                <label for="task_name" class="block text-xl font-bold text-gray-200 mb-3">1️⃣ 題目名稱/編號</label>
                <p class="text-sm text-gray-400 mb-4">請填寫這次練習的題目名稱代號</p>
                <input type="text" id="task_name" name="task_name" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200" placeholder="例如：WT1_Two_Pies">
            </div>

            <!-- 2. 文章檔案 -->
            <div class="bg-cardBg p-6 md:p-8 rounded-xl shadow-lg border border-borderDark">
                <label for="task_file" class="block text-xl font-bold text-gray-200 mb-3">📄 文章檔案 (Docx)</label>
                <p class="text-sm text-gray-400 mb-4">
                    請填寫您的檔案名稱 (例如：My_Task_1.docx)。
                    <br>
                    <strong class="text-accentYellow">重要提示：</strong> 
                    Issue 建立後，您需要 <strong class="underline">手動將您的 .doc/.docx 檔案</strong> 拖曳到 Issue 留言區才能完成上傳。
                </p>
                <input type="text" id="task_file" name="task_file" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200" placeholder="My_Task_1.docx">
            </div>

            <!-- 2.5 文章內容 (支援貼圖並傳輸至 GitHub) -->
            <div class="bg-cardBg p-6 md:p-8 rounded-xl shadow-lg border border-borderDark">
                <label for="article_content" class="block text-xl font-bold text-gray-200 mb-3">📝 文章內容與圖表截圖</label>
                <p class="text-sm text-gray-400 mb-2">
                    請將您的 Task 1 寫作內容和圖表截圖貼於此處。您可以直接 **貼上 (Ctrl+V)** 截圖或 **拖曳** 圖片檔案。
                </p>
                <p id="image-upload-status" class="text-sm text-accentGreen mb-4 hidden">
                    正在等待上傳的圖片：0 張。
                </p>
                <textarea id="article_content" name="article_content" rows="12" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder:text-gray-500" placeholder="貼上您的 Task 1 寫作內容和圖表截圖... (例如：The provided line graph illustrates...)"></textarea>
            </div>
            
            <!-- 2.6 逐句解析內容 --><div class="bg-cardBg p-6 md:p-8 rounded-xl shadow-lg border border-borderDark">
                <label for="sentence_analysis" class="block text-xl font-bold text-gray-200 mb-3">📚 逐句解析內容</label>
                <p class="text-sm text-gray-400 mb-2">
                    請貼上您對 Task 1 寫作內容進行逐句解析的內容、截圖或表格，例如每個句子的文法或詞彙修正。
                </p>
                <textarea id="sentence_analysis" name="sentence_analysis" rows="8" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder:text-gray-500" placeholder="貼上逐句解析內容... (例如：[句子 1] - 修正建議 / [句子 2] - 備註)"></textarea>
            </div>


            <!-- 3. 寫作日期 --><div class="bg-cardBg p-6 md:p-8 rounded-xl shadow-lg border border-borderDark">
                <label for="writing_date" class="block text-xl font-bold text-gray-200 mb-3">📅 寫作日期</label>
                <input type="date" id="writing_date" name="writing_date" class="w-full md:w-1/2 px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 text-gray-200">
            </div>

            <!-- 4. 題型 --><div class="bg-cardBg p-6 md:p-8 rounded-xl shadow-lg border border-borderDark">
                <label for="question_type" class="block text-xl font-bold text-gray-200 mb-3">📊 題型</label>
                <p class="text-sm text-gray-400 mb-4">請選擇這次寫作的圖表題型。</p>
                <select id="question_type" name="question_type" class="w-full md:w-1/2 px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 text-gray-200">
                    <option value="" disabled selected class="bg-darkBg text-gray-500">請選擇...</option>
                    <option value="Line Graph" class="bg-darkBg">Line Graph</option>
                    <option value="Bar Chart" class="bg-darkBg">Bar Chart</option>
                    <option value="Pie Chart" class="bg-darkBg">Pie Chart</option>
                    <option value="Table" class="bg-darkBg">Table</option>
                    <option value="Map" class="bg-darkBg">Map</option>
                    <option value="Process Diagram" class="bg-darkBg">Process Diagram</option>
                    <option value="Mixed" class="bg-darkBg">Mixed</option>
                </select>
            </div>

            <!-- 5. 自我評估分數 (四個數字欄位 + 備註區) --><div class="bg-cardBg p-6 md:p-8 rounded-xl shadow-lg border border-borderDark">
                <label class="block text-xl font-bold text-gray-200 mb-3">2️⃣ 自我評估分數 (0-9)</label>
                <p class="text-sm text-gray-400 mb-4">請填寫你對 IELTS 四大核心維度的自評分數 (0~9)。</p>
                
                <!-- 四個數字輸入欄位 -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <!-- TA -->
                    <div>
                        <label for="self_assessment_ta" class="block text-sm font-medium text-gray-400 mb-2">Task Achievement (TA)</label>
                        <input type="number" id="self_assessment_ta" name="self_assessment_ta" min="0" max="9" step="0.5" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 text-gray-200" placeholder="例如：6.5">
                    </div>
                    <!-- CC -->
                    <div>
                        <label for="self_assessment_cc" class="block text-sm font-medium text-gray-400 mb-2">Coherence & Cohesion (CC)</label>
                        <input type="number" id="self_assessment_cc" name="self_assessment_cc" min="0" max="9" step="0.5" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 text-gray-200" placeholder="例如：7.0">
                    </div>
                    <!-- LR -->
                    <div>
                        <label for="self_assessment_lr" class="block text-sm font-medium text-gray-400 mb-2">Lexical Resource (LR)</label>
                        <input type="number" id="self_assessment_lr" name="self_assessment_lr" min="0" max="9" step="0.5" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 text-gray-200" placeholder="例如：6.0">
                    </div>
                    <!-- GRA -->
                    <div>
                        <label for="self_assessment_gra" class="block text-sm font-medium text-gray-400 mb-2">Grammatical Range & Accuracy (GRA)</label>
                        <input type="number" id="self_assessment_gra" name="self_assessment_gra" min="0" max="9" step="0.5" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 text-gray-200" placeholder="例如：7.5">
                    </div>
                </div>

                <!-- 新增：LR 自評解析 -->
                <label for="self_assessment_lr_analysis" class="block text-sm font-medium text-gray-400 mb-2 mt-6">詞彙資源 (LR) 自評解析 (支援貼圖/拖曳)</label>
                <p class="text-xs text-gray-500 mb-2">請貼上您對 LR 分數的自評細節或圖表，將會自動格式化。</p>
                <textarea id="self_assessment_lr_analysis" name="self_assessment_lr_analysis" rows="4" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder:text-gray-500" placeholder="例如：自評單字庫的使用、同義詞替換的數量與準確性等。"></textarea>

                <!-- 新增：GRA 自評解析 -->
                <label for="self_assessment_gra_analysis" class="block text-sm font-medium text-gray-400 mb-2 mt-6">文法範圍與準確性 (GRA) 自評解析 (支援貼圖/拖曳)</label>
                <p class="text-xs text-gray-500 mb-2">請貼上您對 GRA 分數的自評細節或圖表，將會自動格式化。</p>
                <textarea id="self_assessment_gra_analysis" name="self_assessment_gra_analysis" rows="4" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder:text-gray-500" placeholder="例如：自評複雜句型的使用、時態或主謂一致的錯誤數量等。"></textarea>
                
                
                <!-- 新增：Google Translate Source (TA/CC 語義檢查 - 中文源文) -->
                <label for="google_translate_source" class="block text-sm font-medium text-gray-400 mb-2 mt-6 text-yellow-300">💡 Google 語義檢查 (1/3): 中文源文（TA/CC 意圖）</label>
                <p class="text-xs text-gray-500 mb-2">請輸入您的原始意圖 (中文)，用於比對 AI 評分和您的實際表達。</p>
                <textarea id="google_translate_source" name="google_translate_source" rows="4" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder:text-gray-500" placeholder="例如：這張圖表顯示了 A 國在 2000 年到 2020 年之間能源消耗的顯著增長。"></textarea>

                <!-- 新增：Google Translate Output (TA/CC 語義檢查 - 翻譯結果) -->
                <label for="google_translate_output" class="block text-sm font-medium text-gray-400 mb-2 mt-6 text-yellow-300">💡 Google 語義檢查 (2/3): 翻譯結果（反向驗證）</label>
                <p class="text-xs text-gray-500 mb-2">請將 Google 翻譯結果貼於此處（如：您將中文源文翻譯成英文的結果，或將您的英文寫作反譯回中文的結果）。</p>
                <textarea id="google_translate_output" name="google_translate_output" rows="4" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder:text-gray-500" placeholder="例如：This chart shows a significant increase in energy consumption in country A between 2000 and 2020."></textarea>

                <!-- 新增：自評辨識出的問題 -->
                <label for="self_identified_issues" class="block text-sm font-medium text-gray-400 mb-2 mt-6 text-red-400">🚨 自評辨識出的問題 (3/3) - 修正盲點 (支援貼圖/拖曳)</label>
                <p class="text-xs text-gray-500 mb-2">請輸入您比對原文、中文源文和翻譯結果後，自己發現的 TA/CC 用字準確性問題或 AI 未能辨識出的盲點。**（將自動格式化為列表/段落）**</p>
                <textarea id="self_identified_issues" name="self_identified_issues" rows="4" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder:text-gray-500" placeholder="例如：將 '顯著增長' 寫成了 '快速發展'，導致 TA 準確性不足；或連接詞使用與中文語義不符。"></textarea>

                <!-- ================================== -->
                <!--        ⬇️ AI 圖表生成 (新) ⬇️      -->
                <!-- ================================== -->
                <label class="block text-sm font-medium text-gray-400 mb-2 mt-6 text-purple-300">🤖 AI 圖表生成 (實驗性)</label>
                <p class="text-xs text-gray-500 mb-2">點擊按鈕，讓 AI 根據您在「文章內容與圖表截圖」欄位中的*文字描述*來嘗試生成一張對應的圖表。 (使用 gemini-2.5-flash-image-preview)</p>
                <button type="button" id="generate-chart-button" class="w-full px-4 py-2 text-sm font-medium rounded-lg bg-blue-600 hover:bg-blue-700 transition duration-200 text-white">
                    生成圖表
                </button>
                <div id="chart-generator-status" class="text-xs text-accentYellow mt-2"></div>
                <div id="chart-display-area" class="mt-4">
                    <!-- AI generated chart will appear here -->
                </div>
                <!-- 隱藏欄位，用於儲存上傳後的圖片 URL，以便提交 -->
                <textarea id="generated_chart_content" name="generated_chart_content" class="hidden"></textarea>
                <!-- ================================== -->
                <!--        ⬆️ AI 圖表生成 (新) ⬆️      -->
                <!-- ================================== -->

                <!-- ================================== -->
                <!--           ⬇️ 新增欄位 ⬇️         -->
                <!-- ================================== -->
                <label for="custom_field_1" class="block text-sm font-medium text-gray-400 mb-2 mt-6 text-green-300">💡 新增自訂欄位 (支援貼圖/拖曳)</label>
                <p class="text-xs text-gray-500 mb-2">請在此處輸入您需要補充的任何資訊或截圖。</p>
                <textarea id="custom_field_1" name="custom_field_1" rows="4" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder:text-gray-500" placeholder="輸入自訂內容..."></textarea>
                <!-- ================================== -->
                <!--           ⬆️ 新增欄位 ⬆️         -->
                <!-- ================================== -->

                <!-- 備註/其他觀察區塊 -->
                <label for="self_assessment_notes" class="block text-sm font-medium text-gray-400 mb-2 mt-6">其他觀察/備註 (通用) (支援貼圖/拖曳)</label>
                <textarea id="self_assessment_notes" name="self_assessment_notes" rows="4" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder:text-gray-500" placeholder="補充其他觀察、自評原因或截圖..."></textarea>
            </div>

            <!-- 6. AI 評分 (支援貼圖並格式化) --><div class="bg-cardBg p-6 md:p-8 rounded-xl shadow-lg border border-borderDark">
                <label for="ai_assessment" class="block text-xl font-bold text-gray-200 mb-3">3️⃣ AI 評分 (支援貼圖/拖曳 & AI 格式化)</label>
                <p class="text-sm text-gray-400 mb-4">填入 AI 對四大核心維度的評分與建議評語，或貼上 AI 評分截圖。內容將**自動轉換為表格**。</p>
                <textarea id="ai_assessment" name="ai_assessment" rows="6" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder:text-gray-500" placeholder="Task Response (TR): 
Coherence & Cohesion (CC): 
Lexical Resource (LR): 
Grammatical Range & Accuracy (GRA): 
AI 評語:"></textarea>
            </div>

            <!-- 7. 差異判斷 --><div class="bg-cardBg p-6 md:p-8 rounded-xl shadow-lg border border-borderDark">
                <label class="block text-xl font-bold text-gray-200 mb-3">4️⃣ 差異判斷 (Difference Analysis)</label>
                <p class="text-sm text-gray-400 mb-4">勾選本篇文章與 AI 評分的差異類型，並補充原因與判斷</p>
                <div id="difference_analysis" class="space-y-3 mt-2">
                    <div class="flex items-center">
                        <input id="diff_1" name="difference_analysis" type="checkbox" value="自評高 / AI 低 → 自我盲點" class="h-5 w-5 text-blue-500 bg-darkBg border-borderDark rounded focus:ring-blue-500 accent-blue-600">
                        <label for="diff_1" class="ml-3 block text-base text-gray-200">自評高 / AI 低 → 自我盲點</label>
                    </div>
                    <div class="flex items-center">
                        <input id="diff_2" name="difference_analysis" type="checkbox" value="自評低 / AI 高 → 認知保守" class="h-5 w-5 text-blue-500 bg-darkBg border-borderDark rounded focus:ring-2 focus:ring-blue-500 accent-blue-600">
                        <label for="diff_2" class="ml-3 block text-base text-gray-200">自評低 / AI 高 → 認知保守</label>
                    </div>
                    <div class="flex items-center">
                        <input id="diff_3" name="difference_analysis" type="checkbox" value="自評 ≈ AI → 共識問題" class="h-5 w-5 text-blue-500 bg-darkBg border-borderDark rounded focus:ring-2 focus:ring-blue-500 accent-blue-600">
                        <label for="diff_3" class="ml-3 block text-base text-gray-200">自評 ≈ AI → 共識問題</label>
                    </div>
                    <div class="flex items-center">
                        <input id="diff_4" name="difference_analysis" type="checkbox" value="分數接近但理由不同 → 認知偏差" class="h-5 w-5 text-blue-500 bg-darkBg border-borderDark rounded focus:ring-2 focus:ring-blue-500 accent-blue-600">
                        <label for="diff_4" class="ml-3 block text-base text-gray-200">分數接近但理由不同 → 認知偏差</label>
                    </div>
                </div>
            </div>

            <!-- 8. 反思與行動 (支援貼圖並格式化) --><div class="bg-cardBg p-6 md:p-8 rounded-xl shadow-lg border border-borderDark">
                <label for="reflection_action" class="block text-xl font-bold text-gray-200 mb-3">5️⃣ 反思與行動 (支援貼圖/拖曳 & AI 格式化)</label>
                <p class="text-sm text-gray-400 mb-4">針對每個差異類型列出具體修正行動，並可附 Project 或任務連結，或貼上修正的截圖。內容將**自動轉換為表格或列表**。</p>
                <textarea id="reflection_action" name="reflection_action" rows="8" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder:text-gray-500" placeholder="🔹 自我盲點修正 (需重寫或改善段落): 
🔹 認知保守收錄 (存入最佳範例庫或模板): 
🔹 共識問題訓練 (指定練習任務或練習題): 
🔹 理由偏差驗證 (你與 AI 給出不同原因但結果相似時，需比對 AI 評語或高分範文，找出真正原因):"></textarea>
            </div>

            <!-- 9. 其他備註 (支援貼圖並格式化) --><div class="bg-cardBg p-6 md:p-8 rounded-xl shadow-lg border border-borderDark">
                <label for="additional_notes" class="block text-xl font-bold text-gray-200 mb-3">6️⃣ 其他備註 (支援貼圖/拖曳 & AI 格式化)</label>
                <p class="text-sm text-gray-400 mb-4">填寫額外備註，例如寫作心得、詞彙卡片、特別觀察或相關圖片。內容將**自動轉換為表格或整潔的段落**。</p>
                <textarea id="additional_notes" name="additional_notes" rows="4" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder:text-gray-500" placeholder="請填寫備註或心得"></textarea>
            </div>

            <!-- 提交按鈕 --><div class="pt-8 text-center">
                <div id="status-message" class="mb-4 p-3 rounded-lg text-sm hidden"></div>
                <button type="submit" id="submit-button" class="gradient-button w-full md:w-2/3 lg:w-1/Two_Pies px-8 py-4 text-xl font-bold rounded-xl shadow-lg
                                         text-white bg-gradient-to-r from-primaryBtnStart to-primaryBtnEnd
                                         hover:from-blue-500 hover:to-purple-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-darkBg
                                         transition duration-300 ease-in-out">
                    ✨ 自動建立 GitHub Issue
                </button>
            </div>
        </form>
    </div>

    <script>
        // 全域變數
        const apiKey = ""; // 留空，系統會自動填入
        const modelName = "gemini-2.5-flash-preview-09-2025"; 
        const imageModelName = "gemini-2.5-flash-image-preview"; // 🌟 新增 (用於 AI 圖表生成)
        
        // -----------------------------------------------------
        // 圖片處理專用變數：新的結構，用於儲存待上傳的圖片並追蹤其來源
        // { 'textareaId': [{file, placeholder}, ...] }
        // -----------------------------------------------------
        const pendingImages = {}; 
        const imageStatusElement = document.getElementById('image-upload-status');
        
        /**
         * 處理貼上和拖曳事件的核心邏輯，用於將圖片儲存為待上傳列表並插入佔位符。
         * @param {string} textareaId - 目標文字區域的 ID
         */
        function setupImageUpload(textareaId) {
            const textarea = document.getElementById(textareaId);
            
            if (!textarea) return; // 確保元素存在
            
            // 初始化陣列
            pendingImages[textareaId] = [];

            // ------------------ 貼上處理 (Paste) ------------------
            textarea.addEventListener('paste', function(event) {
                const items = (event.clipboardData || event.originalEvent.clipboardData).items;
                let imageFound = false;

                for (let item of items) {
                    if (item.type.indexOf('image') !== -1) {
                        event.preventDefault(); 
                        const file = item.getAsFile();
                        if (file) {
                            const timestamp = Date.now();
                            const mimeType = file.type || 'image/png';
                            const extension = mimeType.split('/')[1] || 'png';
                            const placeholderName = `${textareaId}_pasted_${timestamp}.${extension}`;
                            
                            // 儲存檔案和佔位符，並標記來源 ID
                            pendingImages[textareaId].push({ file: file, placeholder: placeholderName });
                            
                            // 在文字區塊中插入 Markdown 佔位符
                            const placeholderText = `\n![Uploading: ${placeholderName}]\n`;
                            const start = this.selectionStart;
                            const end = this.selectionEnd;
                            this.value = this.value.substring(0, start) + placeholderText + this.value.substring(end);
                            this.setSelectionRange(start + placeholderText.length, start + placeholderText.length);
                            
                            imageFound = true;
                        }
                    }
                }

                if (imageFound) {
                    updateImageStatus();
                }
            });

            // ------------------ 拖曳處理 (Drag & Drop) ------------------
            textarea.addEventListener('dragover', function(event) {
                event.preventDefault(); 
                this.classList.add('border-blue-500', 'ring-2', 'ring-blue-500'); // 視覺回饋
            });
            
            textarea.addEventListener('dragleave', function(event) {
                this.classList.remove('border-blue-500', 'ring-2', 'ring-blue-500');
            });

            textarea.addEventListener('drop', function(event) {
                event.preventDefault();
                this.classList.remove('border-blue-500', 'ring-2', 'ring-blue-500');
                
                let imageFound = false;
                const files = event.dataTransfer.files;

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (file.type.startsWith('image/')) {
                        const timestamp = Date.now() + i;
                        const extension = file.type.split('/')[1] || 'png';
                        const placeholderName = `${textareaId}_dragged_${timestamp}.${extension}`;
                        
                        pendingImages[textareaId].push({ file: file, placeholder: placeholderName });

                        const placeholderText = `\n![Uploading: ${placeholderName}]\n`;
                        this.value += placeholderText;
                        imageFound = true;
                    }
                }

                if (imageFound) {
                    updateImageStatus();
                }
            });
        }
        
        /**
         * 統計所有欄位中待上傳的圖片總數，並更新狀態提示
         */
        function updateImageStatus() {
            let totalImages = 0;
            for (const id in pendingImages) {
                totalImages += pendingImages[id].length;
            }
            
            if (totalImages > 0) {
                imageStatusElement.textContent = `正在等待上傳的圖片：${totalImages} 張。`;
                imageStatusElement.classList.remove('hidden');
            } else {
                imageStatusElement.classList.add('hidden');
            }
        }
        
        /**
         * 將 Base64 數據上傳到 GitHub Repo
         * @returns {string} The raw content URL for the uploaded file.
         */
        async function uploadImageToGithub(user, repo, token, path, base64Content, message) {
            const apiUrl = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;
            const maxRetries = 5; // Allow retries for 409 conflicts
            let sha = null;

            // 1. 初次嘗試 GET 現有檔案的 SHA
            try {
                const getResponse = await fetch(apiUrl, {
                    headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.com/v3+json' }
                });

                if (getResponse.ok) {
                    const existingFile = await getResponse.json();
                    sha = existingFile.sha;
                }
            } catch (e) {
                console.warn(`[GitHub Upload] Initial attempt to GET SHA failed for ${path}:`, e);
            }

            // 2. PUT 請求與 409 衝突重試循環
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                console.log(`[GitHub Upload] PUT attempt ${attempt + 1} for ${path}. Current SHA: ${sha || 'new file'}`);
                
                // 準備 PUT 請求體
                const putBody = {
                    message: sha ? `Update existing image for Task 1 Issue: ${path}` : message,
                    content: base64Content, 
                    committer: {
                        name: user,
                        email: `${user}@users.noreply.github.com`
                    }
                };

                if (sha) {
                    putBody.sha = sha; // 包含 SHA 以更新現有檔案
                }

                const response = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.com/v3+json'
                    },
                    body: JSON.stringify(putBody)
                });

                const result = await response.json();
                
                if (response.ok) {
                    // 成功
                    console.log(`[GitHub Upload] Successfully uploaded ${path} on attempt ${attempt + 1}.`);
                    return result.content.download_url;
                } 
                
                if (response.status === 409) {
                    // 409 Conflict (SHA mismatch) - 需要重試
                    console.warn(`[GitHub Upload] Conflict (409) detected for ${path}. Retrying to get latest SHA...`);
                    
                    let reGetError = null;

                    // 重新 GET 檔案以取得最新的 SHA
                    try {
                        const getResponse = await fetch(apiUrl, {
                            headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.com/v3+json' }
                        });

                        if (getResponse.ok) { // 200 OK
                            const existingFile = await getResponse.json();
                            sha = existingFile.sha; // 更新 SHA
                            console.log(`[GitHub Upload] Successfully fetched new SHA: ${sha}. Retrying PUT...`);
                        } else if (getResponse.status === 404) {
                            // FIX: 如果重新 GET 得到 404 (Not Found)，表示檔案不存在，應清除 SHA，作為新檔案重試 PUT
                            sha = null; 
                            console.warn(`[GitHub Upload] File ${path} not found (404) during SHA re-GET. Retrying PUT as a new file (clearing SHA).`);
                        } else {
                            // Non-recoverable error during GET (403, 500, etc.)
                            const errResult = await getResponse.json();
                            reGetError = new Error(`GitHub 重新獲取 SHA 失敗 (${path}, Status: ${getResponse.status}): ${errResult.message || 'Unknown error during re-GET'}`);
                        }
                    } catch (e) {
                        // Catches network error
                        reGetError = new Error(`Fatal network error during re-GET for SHA: ${e.message}`);
                    }
                    
                    // 如果在重新 GET 期間發生錯誤，且不是可忽略的 404，或者達到重試上限但 SHA 仍為舊值，拋出致命錯誤
                    if (reGetError) {
                        console.error(`[GitHub Upload] ${reGetError.message}`);
                        throw new Error(`GitHub 圖片上傳失敗 (${path}, Status: 409): 無法獲取最新的 SHA 進行重試。
Stack: ${reGetError.message}`); 
                    }

                    // 延遲重試以避免立即衝突
                    await new Promise(resolve => setTimeout(resolve, 500 * (attempt + 1)));
                    continue; // 進入下一次循環 (重試 PUT)
                } 
                
                // 非 409 錯誤，拋出
                throw new Error(`GitHub 圖片上傳失敗 (${path}, Status: ${response.status}): ${result.message || 'Unknown error'}`);
            }
            
            // 達到最大重試次數
            throw new Error(`GitHub 圖片上傳失敗 (${path}): 已達最大重試次數 (${maxRetries})。`);
        }

        /**
         * 執行所有圖片上傳並返回佔位符到最終 Markdown 連結的映射。
         */
        async function uploadAllImages(user, repo, token, submitButton) {
            const uploadedMap = {}; // Maps: placeholder -> final URL
            const allImagesToUpload = [];

            // 將所有欄位的圖片扁平化為一個列表
            for (const fieldId in pendingImages) {
                pendingImages[fieldId].forEach(img => {
                    allImagesToUpload.push({ ...img, fieldId });
                });
            }
            
            if (allImagesToUpload.length === 0) {
                console.log("[GitHub Upload] No images to upload.");
                return uploadedMap;
            }

            console.log(`[GitHub Upload] Starting upload of ${allImagesToUpload.length} images...`);

            const uploadPromises = allImagesToUpload.map(async (img, index) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = async () => {
                        try {
                            const base64Content = reader.result.split(',')[1];
                            const path = `issue_images/${img.placeholder}`; 
                            const message = `Upload image for Task 1 Issue - Field: ${img.fieldId}`;
                            
                            // 更新按鈕文字，讓用戶知道進度
                            submitButton.textContent = `🖼️ 正在上傳圖片 (${index + 1}/${allImagesToUpload.length})...`;

                            const rawUrl = await uploadImageToGithub(user, repo, token, path, base64Content, message);
                            uploadedMap[img.placeholder] = rawUrl;
                            resolve();
                        } catch (error) {
                            console.error(`[GitHub Upload] Image Upload Error for ${img.placeholder}:`, error);
                            // 即使上傳失敗，也將佔位符映射到錯誤訊息，以便在內容中顯示
                            uploadedMap[img.placeholder] = `[圖片上傳失敗: ${error.message}]`; 
                            resolve(); 
                        }
                    };
                    reader.readAsDataURL(img.file);
                });
            });

            // 使用 Promise.allSettled 等待所有上傳完成，即使有失敗
            await Promise.allSettled(uploadPromises);
            
            // 清空所有待上傳圖片
            for (const id in pendingImages) {
                pendingImages[id].length = 0;
            }
            updateImageStatus();

            console.log("[GitHub Upload] All image uploads completed.");
            return uploadedMap;
        }
        
        // -----------------------------------------------------
        // Gemini 格式化功能 (DEBUG 強化版)
        // -----------------------------------------------------

        /**
         * 使用 Gemini API 將純文字轉換為格式化的 Markdown 表格或整潔段落。
         * @param {string} text - 待格式化的原始文字 (已替換圖片佔位符)
         * @param {string} context - 給 AI 的上下文提示
         * @param {boolean} preferTable - 是否傾向於轉換為 Key:Value 表格
         */
        async function formatTextWithGemini(text, context, preferTable = true) {
            const trimmedText = text.trim();
            if (!trimmedText) {
                return '無';
            }
            
            console.log(`\n--- [Gemini Format] Starting API Call ---`);
            console.log(`[Gemini Format] Context: '${context}'`);
            console.log(`[Gemini Format] Input text (first 100 chars):\n${trimmedText.substring(0, 100)}...`);


            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
            
            const tableInstruction = preferTable 
                ? `請優先嘗試使用兩欄 Markdown 表格 (例如：項目 | 內容) 來呈現 Key:Value 結構或分行項目。如果內容是自由格式的評語或含有圖片連結，則將其轉換為整潔的 Markdown 列表或段落，並確保換行被保留為段落。`
                : `請將內容轉換為整潔的 Markdown 格式，例如列表、標題或段落，保留所有換行以確保可讀性。不要使用表格。`;

            const userQuery = `請將以下關於 IELTS Task 1 評估的純文字內容轉換為 GitHub Issue 兼容的 Markdown 格式。
                ${tableInstruction}
                
                上下文/預期用途: ${context}
                
                原始輸入:
                ---
                ${trimmedText}
                ---
                `;

            const responseSchema = {
                type: "OBJECT",
                properties: {
                    "markdown_output": { 
                        "type": "STRING",
                        "description": "The input text converted into a GitHub compatible Markdown table or clean text string, or the original text if a table is not suitable. Only include the table or text itself, no Markdown code fences."
                    }
                },
                required: ["markdown_output"]
            };

            const systemPrompt = "你是一位專業的 Markdown 格式化助手。你的任務是將非結構化文本轉換為整潔的 Markdown 表格或純文字格式，以方便 GitHub 顯示。你必須以指定的 JSON 格式返回結果，**不要包含任何多餘的解釋或 Markdown 區塊標記**，例如 ```json 或 ```。";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema,
                }
            };

            const maxRetries = 3;
            let delay = 1000;
            
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        const candidate = result.candidates?.[0];

                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            let jsonText = candidate.content.parts[0].text;
                            
                            // --- 關鍵修正：清理 Markdown 程式碼區塊標記 ---
                            jsonText = jsonText.replace(/^```json\n?/, '').replace(/\n?```$/, '').trim(); 
                            
                            console.log("[Gemini Format] Raw JSON Text received:", jsonText.substring(0, 500) + '...'); 

                            try {
                                const parsedJson = JSON.parse(jsonText);
                                
                                if (parsedJson && typeof parsedJson.markdown_output === 'string') {
                                    const finalOutput = parsedJson.markdown_output.trim();
                                    console.log("[Gemini Format] Success. Formatted output (first 100 chars):\n", finalOutput.substring(0, 100) + '...');
                                    return finalOutput;
                                } else {
                                    console.warn("[Gemini Format] Output JSON structure missing 'markdown_output'. Falling back to original text.");
                                    return trimmedText; 
                                }
                            } catch (jsonError) {
                                console.error("[Gemini Format] 輸出 JSON 解析失敗:", jsonError, "原始文字:", jsonText.substring(0, 500) + '...');
                                console.log("[Gemini Format] Falling back to original text due to JSON error.");
                                return trimmedText; 
                            }
                        } else {
                            console.warn("[Gemini Format] Candidate or content part missing in response.");
                        }
                    } else if ((response.status === 429 || response.status === 503) && i < maxRetries - 1) {
                        console.warn(`[Gemini Format] API Rate Limit hit (${response.status}). Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                        continue; 
                    }
                    
                    console.error(`[Gemini Format] API call failed with status: ${response.status}. Falling back to original text.`);
                    return trimmedText; 

                } catch (error) {
                    console.error("[Gemini Format] Fetch or general API error:", error);
                    if (i < maxRetries - 1) {
                         console.warn(`[Gemini Format] General error. Retrying in ${delay / 1000}s...`);
                         await new Promise(resolve => setTimeout(resolve, delay));
                         delay *= 2;
                         continue;
                    }
                    console.log("[Gemini Format] Final fallback to original text.");
                    return trimmedText;
                }
            }
            return trimmedText;
        }

        /**
         * 🌟 (新) 使用 Gemini 生成圖表並上傳到 GitHub
         */
        async function generateAndUploadChart() {
            const button = document.getElementById('generate-chart-button');
            const status = document.getElementById('chart-generator-status');
            const displayArea = document.getElementById('chart-display-area');
            const hiddenTextarea = document.getElementById('generated_chart_content');

            // 1. 獲取 GitHub 資訊和描述
            const user = document.getElementById('github_user').value.trim();
            const repo = document.getElementById('github_repo').value.trim();
            const token = document.getElementById('github_token').value.trim();
            const articleContent = document.getElementById('article_content').value.trim();

            if (!user || !repo || !token) {
                status.textContent = '🚨 錯誤：請先填寫 GitHub 儲存庫設定。';
                return;
            }
            if (!articleContent) {
                status.textContent = '🚨 錯誤：請先在「文章內容與圖表截圖」欄位中填寫文字描述。';
                return;
            }

            // 2. 設置加載狀態
            button.disabled = true;
            button.textContent = '🧠 正在生成圖表...';
            status.textContent = '請稍候，AI 正在根據您的文字描述繪製圖表...';
            displayArea.innerHTML = ''; // 清空舊圖表

            try {
                // 3. 呼叫 Gemini Image API
                const userPrompt = `Based on the following IELTS Task 1 description, generate a simple, clear visual chart (like a line graph, bar chart, or pie chart) that represents the data described. Focus on the key trends and figures. Description: ${articleContent}`;
                
                const payload = {
                    contents: [{
                        parts: [{ text: userPrompt }]
                    }],
                    generationConfig: {
                        responseModalities: ['IMAGE']
                    },
                };

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${imageModelName}:generateContent?key=${apiKey}`;
                
                let response;
                let result;
                const maxRetries = 3;
                let delay = 1000;

                for (let i = 0; i < maxRetries; i++) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        result = await response.json();
                        break; // 成功，跳出循環
                    }
                    
                    if ((response.status === 429 || response.status === 503) && i < maxRetries - 1) {
                        console.warn(`[Chart Gen] API Rate Limit hit (${response.status}). Retrying in ${delay / 1000}s...`);
                        status.textContent = `API 忙碌中 (${response.status})，${delay / 1000} 秒後重試...`;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        // 最終失敗
                        const errorResult = await response.json();
                        console.error("[Chart Gen] API Error Response:", errorResult);
                        throw new Error(`API 請求失敗，狀態碼: ${response.status}. ${errorResult?.error?.message || ''}`);
                    }
                }

                const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (!base64Data) {
                    console.warn("[Chart Gen] API Response missing base64 data:", result);
                    throw new Error('API 未能返回有效的圖片數據。');
                }

                // 4. 顯示圖片
                status.textContent = '✅ 生成成功！正在顯示圖片...';
                const imageUrl = `data:image/png;base64,${base64Data}`;
                displayArea.innerHTML = `<img src="${imageUrl}" alt="AI 生成的圖表" class="w-full rounded-lg border border-borderDark">`;

                // 5. 上傳圖片到 GitHub
                status.textContent = '🖼️ 正在上傳圖片到 GitHub...';
                const path = `issue_images/ai_generated_chart_${Date.now()}.png`;
                const message = "Upload AI-generated chart for Task 1 Issue";
                
                const rawUrl = await uploadImageToGithub(user, repo, token, path, base64Data, message);
                
                // 6. 儲存 Markdown 到隱藏欄位
                const markdown = `![AI 生成的圖表 (基於描述)](${rawUrl})`;
                hiddenTextarea.value = markdown;
                
                status.textContent = '✅ 圖表生成並上傳成功！將包含在 Issue 中。';

            } catch (error) {
                console.error('[Chart Gen] Error:', error);
                status.textContent = `❌ 生成失敗：${error.message}`;
            } finally {
                // 7. 恢復按鈕
                button.disabled = false;
                button.textContent = '重新生成圖表';
            }
        }


        // -----------------------------------------------------
        // 表單提交邏輯
        // -----------------------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            // 在 DOMContentLoaded 時為所有需要的 Textarea 啟用圖片上傳功能
            setupImageUpload('article_content');
            setupImageUpload('sentence_analysis'); 
            setupImageUpload('self_assessment_notes'); 
            setupImageUpload('ai_assessment');
            setupImageUpload('reflection_action');
            setupImageUpload('additional_notes');

            // LR/GRA 解析欄位
            setupImageUpload('self_assessment_lr_analysis');
            setupImageUpload('self_assessment_gra_analysis');
            
            // 新增的自評問題辨識欄位 (支援貼圖)
            setupImageUpload('self_identified_issues'); // <-- 新增
            
            // 🌟 (新 JS 插入點) 為新欄位啟用貼圖
            setupImageUpload('custom_field_1'); 

            // 🌟 (新 JS 插入點) 綁定 AI 圖表生成按鈕
            document.getElementById('generate-chart-button').addEventListener('click', generateAndUploadChart);
            
            // 預設寫作日期為今天
            document.getElementById('writing_date').value = new Date().toISOString().split('T')[0];
        });


        document.getElementById('issue-form').addEventListener('submit', async function(event) {
            event.preventDefault(); 
            
            console.log("Starting Issue Submission Process...");

            // 獲取 GitHub 資訊
            const user = document.getElementById('github_user').value.trim();
            const repo = document.getElementById('github_repo').value.trim();
            const token = document.getElementById('github_token').value.trim();
            const repoError = document.getElementById('repo-error');
            const statusMessage = document.getElementById('status-message');
            const submitButton = document.getElementById('submit-button');

            statusMessage.classList.add('hidden');
            statusMessage.textContent = '';
            
            // 檢查 GitHub 資訊
            if (!user || !repo || !token) {
                repoError.classList.remove('hidden');
                statusMessage.textContent = '🚨 錯誤：請填寫 GitHub 使用者名稱、儲存庫名稱和 PAT。';
                statusMessage.classList.remove('hidden', 'bg-successGreen', 'bg-errorRed');
                statusMessage.classList.add('bg-accentYellow', 'text-black');
                return;
            }
            repoError.classList.add('hidden'); 
            
            // 禁用按鈕並顯示載入狀態
            submitButton.disabled = true;
            
            // 1. 獲取表單數據
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            const taskName = data.task_name || '未命名練習';
            const writingDate = data.writing_date || new Date().toISOString().split('T')[0];
            const title = `Task 1 寫作評估 - ${taskName} (${writingDate})`;
            const labels = ['ielts-writing', 'task-1', data.question_type || 'unclassified'];

            
            // 2. 處理圖片上傳
            let uploadedImageMap = {};
            // 檢查是否有圖片需要上傳
            let totalImagesToUpload = 0;
            for (const id in pendingImages) {
                totalImagesToUpload += pendingImages[id].length;
            }

            if (totalImagesToUpload > 0) {
                try {
                    uploadedImageMap = await uploadAllImages(user, repo, token, submitButton);
                    
                    submitButton.textContent = '🤖 正在使用 AI 格式化內容... (1/10)'; // 🌟 (9 -> 10)
                } catch (e) {
                    statusMessage.textContent = `❌ 圖片上傳過程中發生嚴重錯誤: ${e.message}`;
                    statusMessage.classList.remove('hidden', 'bg-successGreen', 'bg-accentYellow', 'text-black');
                    statusMessage.classList.add('bg-errorRed', 'text-white');
                    submitButton.disabled = false;
                    submitButton.textContent = '✨ 自動建立 GitHub Issue';
                    return;
                }
            } else {
                 submitButton.textContent = '🤖 正在使用 AI 格式化內容... (1/10)'; // 🌟 (9 -> 10)
            }


            // 3. 替換所有欄位中的圖片佔位符
            function replacePlaceholders(content, uploadedMap) {
                let newContent = content;
                for (const placeholder in uploadedMap) {
                    const finalUrl = uploadedMap[placeholder];
                    // 替換所有的 ![Uploading: <placeholder>]
                    newContent = newContent.replace(new RegExp(`!\\[Uploading: ${placeholder}\\]`, 'g'), `![${placeholder}](${finalUrl})`);
                }
                return newContent;
            }

            const processedFields = {};
            // 🌟 <-- 更新要處理的欄位清單: 增加 'generated_chart_content'
            for (const key of ['article_content', 'sentence_analysis', 'self_assessment_notes', 'ai_assessment', 'reflection_action', 'additional_notes', 'self_assessment_lr_analysis', 'self_assessment_gra_analysis', 'self_identified_issues', 'custom_field_1', 'generated_chart_content']) { 
                // 將圖片連結替換到文字中
                processedFields[key] = replacePlaceholders(data[key] || '', uploadedImageMap);
            }
            
            // 獲取新的 Google Translate 欄位內容 (不需要替換佔位符，因為它們不支援貼圖)
            const googleTranslateSource = data.google_translate_source || '';
            const googleTranslateOutput = data.google_translate_output || '';

            // 4. 準備分數 (通用備註將單獨處理)
            const selfAssessmentInput = `
Task Achievement (TA): ${data.self_assessment_ta || 'N/A'}
Coherence & Cohesion (CC): ${data.self_assessment_cc || 'N/A'}
Lexical Resource (LR): ${data.self_assessment_lr || 'N/A'}
Grammatical Range & Accuracy (GRA): ${data.self_assessment_gra || 'N/A'}
`.trim();


            // 5. 使用 Gemini 轉換評估文本 (現在有 10 個步驟)
            
            // A. 轉換自我評估 (僅分數)
            submitButton.textContent = '🤖 正在使用 AI 格式化內容... (1/10)'; // (1/9 -> 1/10)
            const selfAssessmentFormatted = await formatTextWithGemini(
                selfAssessmentInput, 
                "IELTS Task 1 自我評估，包含 TA, CC, LR, GRA 分數。請轉為兩欄 Markdown 表格。",
                true // Prefer Table
            );

            // B. 轉換 LR Analysis 
            submitButton.textContent = '🤖 正在使用 AI 格式化內容... (2/10)'; // (2/9 -> 2/10)
            const lrAnalysisFormatted = await formatTextWithGemini(
                processedFields.self_assessment_lr_analysis, 
                "IELTS Task 1 詞彙資源 (LR) 的自我評估細節和分析，可能含有圖片連結。請將內容轉換為整潔的 Markdown 列表或段落，以便閱讀。",
                true // Prefer Table
            );

            // C. 轉換 GRA Analysis 
            submitButton.textContent = '🤖 正在使用 AI 格式化內容... (3/10)'; // (3/9 -> 3/10)
            const graAnalysisFormatted = await formatTextWithGemini(
                processedFields.self_assessment_gra_analysis, 
                "IELTS Task 1 文法範圍與準確性 (GRA) 的自我評估細節和分析，可能含有圖片連結。請將內容轉換為整潔的 Markdown 列表或段落，以便閱讀。",
                true // Prefer Table
            );
            
            // D. 轉換 Self Identified Issues (新增)
            submitButton.textContent = '🤖 正在使用 AI 格式化內容... (4/10)'; // (4/9 -> 4/10)
            const selfIdentifiedIssuesFormatted = await formatTextWithGemini(
                processedFields.self_identified_issues, 
                "Task 1 寫作的自評辨識出的 TA/CC 準確性問題與盲點。請將內容轉換為整潔的 Markdown 列表或段落，保留所有換行和項目符號。",
                false // Do NOT prefer table for free-form analysis of issues
            );

            // E. 轉換 新增自訂欄位
            submitButton.textContent = '🤖 正在使用 AI 格式化內容... (5/10)'; // (5/9 -> 5/10)
            const customField1Formatted = await formatTextWithGemini(
                processedFields.custom_field_1, 
                "Task 1 寫作的自訂補充欄位。請將內容轉換為整潔的 Markdown 列表或段落，保留所有換行和項目符號。",
                false // 不優先使用表格
            );

            // 🌟 (新 JS 插入點)
            // F. 轉換 AI 生成的圖表 (它已經是 Markdown，但我們還是要 "格式化" 以防萬一，並保持步驟)
            submitButton.textContent = '🤖 正在使用 AI 格式化內容... (6/10)'; // (新步驟 6/10)
            const generatedChartFormatted = await formatTextWithGemini(
                processedFields.generated_chart_content, 
                "AI 生成的圖表連結。保持原樣，作為 Markdown 圖片。",
                false // 不使用表格
            );

            // G. 轉換 AI 評分 
            submitButton.textContent = '🤖 正在使用 AI 格式化內容... (7/10)'; // (6/9 -> 7/10)
            const aiAssessmentFormatted = await formatTextWithGemini(
                processedFields.ai_assessment, 
                "IELTS Task 1 AI 評分，包含 TR, CC, LR, GRA 分數與 AI 評語建議，可能含有圖片連結。請優先轉為兩欄 Markdown 表格。",
                true // Prefer Table
            );
            
            // H. 轉換 逐句解析內容
            submitButton.textContent = '🤖 正在使用 AI 格式化內容... (8/10)'; // (7/9 -> 8/10)
            const sentenceAnalysisFormatted = await formatTextWithGemini(
                processedFields.sentence_analysis, 
                "Task 1 寫作的逐句解析內容，包含句子、文法修正、詞彙建議或截圖。請嘗試轉換為兩欄 Markdown 表格 (例如：原始句子 | 修正建議)，若內容不適合表格，則轉換為整潔的列表或段落。",
                true // Prefer Table
            );
            
            // I. 轉換 反思與行動
            submitButton.textContent = '🤖 正在使用 AI 格式化內容... (9/10)'; // (8/9 -> 9/10)
            const reflectionActionFormatted = await formatTextWithGemini(
                processedFields.reflection_action, 
                "寫作後的反思與具體修正行動，包含項目符號、任務連結或修正截圖。請嘗試轉換為兩欄 Markdown 表格 (項目 | 內容)，若內容不適合表格，則轉換為整潔的列表或段落。",
                true // Prefer Table
            );

            // J. 轉換 其他備註
            submitButton.textContent = '🤖 正在使用 AI 格式化內容... (10/10)'; // (9/9 -> 10/10)
            
            // ⬇️ 修正點：移除這裡多餘的 $ 符號
            const additionalNotesFormatted = await formatTextWithGemini(
                processedFields.additional_notes, 
                "額外備註或寫作心得，可能包含圖片連結。請嘗試轉換為兩欄 Markdown 表格 (項目 | 內容)，若內容不適合表格，則轉換為整潔的段落。",
                true // Prefer Table
            );

            // K. 處理 checkbox 
            const checkedDifferences = Array.from(document.querySelectorAll('input[name="difference_analysis"]:checked'))
                                            .map(cb => `- [x] ${cb.value}`)
                                            .join('\n');
            

            // 6. 建立 body 內容 (將新的解析欄位加入)
            const body = `
### ⚠️ 文章內容 (遵循不直接顯示內容的原則)

文章內容和任何相關圖片已上傳至 GitHub 儲存庫，但不會直接顯示在 Issue 本體中，以保持整潔。
請參考您手動上傳的 **\`${data.task_file || '未填寫檔案名稱'}\`** 檔案，或點擊下方可收合區塊查看原始寫作截圖與文字。

---
<details>
<summary>點擊此處展開原始文章內容截圖與文字</summary>
<br>

${processedFields.article_content.trim() || '（原始文章內容欄位為空）'}

</details>
---

### 📚 逐句解析內容
${sentenceAnalysisFormatted}

---

### 1️⃣ 題目名稱/編號
${data.task_name || '未填寫'}

### 文章檔案
**檔案名稱：** ${data.task_file || '未填寫'}
*(⚠️ **重要提醒：** 檔案 ${data.task_file || '未填寫'} 未能自動上傳。請在 Issue 建立後，手動拖曳檔案到此處來完成上傳。)*

### 📅 寫作日期
${data.writing_date || '未填寫'}

### 📊 題型
${data.question_type || '未選擇'}

### 2️⃣ 自我評估分數 (Self Assessment)

#### 📝 評分項目
${selfAssessmentFormatted}

#### 📝 詞彙資源 (LR) 自評解析
${lrAnalysisFormatted}

#### 📝 文法範圍與準確性 (GRA) 自評解析
${graAnalysisFormatted}

---

### 💡 Google 語義檢查 (TA/CC 準確性評估)

#### 🇨🇳 中文源文（您的原始意圖）
> ${googleTranslateSource.trim().replace(/\n/g, '\n> ') || '（未提供）'}

#### 🇬🇧 翻譯結果（反向驗證）
> ${googleTranslateOutput.trim().replace(/\n/g, '\n> ') || '（未提供）'}

#### 🚨 自評辨識出的問題 (修正盲點)
${selfIdentifiedIssuesFormatted}

---

<!-- 🌟 (新 JS 插入點) -->
### 🤖 AI 生成圖表 (基於文字描述)
${generatedChartFormatted.trim() || '（未生成圖表）'}

---

<!-- 🌟 (新 JS 插入點) -->
### 💡 新增自訂欄位
${customField1Formatted.trim() || '（未填寫自訂欄位）'}

---

### 📝 其他觀察/備註 (通用)
${processedFields.self_assessment_notes.trim() || '（未填寫通用備註）'}

---

### 3️⃣ AI 評分 (AI Scoring)
${aiAssessmentFormatted}

### 4️⃣ 差異判斷 (Difference Analysis)
${checkedDifferences || '未選擇'}

### 5️⃣ 反思與行動 (Reflection & Action)
${reflectionActionFormatted}

### 6️⃣ 其他備註 (Optional Notes)
${additionalNotesFormatted}
`;
            
            // 7. 發送 API 請求自動建立 Issue
            submitButton.textContent = '🚀 正在建立 GitHub Issue...';
            const apiUrl = `https://api.github.com/repos/${user}/${repo}/issues`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.com/v3+json' 
                    },
                    body: JSON.stringify({
                        title: title,
                        body: body,
                        labels: labels
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    statusMessage.textContent = `✅ Issue 建立成功！Issue #${result.number} 已建立。`;
                    statusMessage.classList.remove('hidden', 'bg-errorRed', 'bg-accentYellow', 'text-black');
                    statusMessage.classList.add('bg-successGreen', 'text-white');
                    
                    // 成功後，開啟新 Issue 頁面
                    setTimeout(() => {
                         window.open(result.html_url, '_blank');
                    }, 1000); 

                } else {
                    let errorMessage = '建立 Issue 失敗。';
                    if (result.message) {
                        errorMessage += ` GitHub 錯誤訊息：${result.message}`;
                    }
                    if (response.status === 401 || response.status === 403) {
                        errorMessage += " (請檢查 PAT 是否有效或權限是否足夠 - 需要 'repo' 權限)";
                    } else if (response.status === 404) {
                        errorMessage += " (請檢查使用者名稱或儲存庫名稱是否正確)";
                    }
                    statusMessage.textContent = `❌ ${errorMessage}`;
                    statusMessage.classList.remove('hidden', 'bg-successGreen', 'bg-accentYellow', 'text-black');
                    statusMessage.classList.add('bg-errorRed', 'text-white');
                }

            } catch (error) {
                statusMessage.textContent = `❌ 網路或未知錯誤：${error.message}`;
                statusMessage.classList.remove('hidden', 'bg-successGreen', 'bg-accentYellow', 'text-black');
                statusMessage.classList.add('bg-errorRed', 'text-white');
            } finally {
                // 恢復按鈕狀態
                submitButton.disabled = false;
                submitButton.textContent = '✨ 自動建立 GitHub Issue';
            }
        });
    </script>

</body>
</html>