<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Pull Request å¿«é€Ÿç”¢ç”Ÿå™¨ (v1.1)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* ä½¿ç”¨ Inter å­—é«” */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1A202C, #2D3748); /* æ·±è—ç°è‰²æ¼¸è®ŠèƒŒæ™¯ */
            min-height: 100vh;
            padding: 2rem 1rem;
            transition: background-color 0.3s;
        }

        /* æ·±è‰²æ¨¡å¼å°ˆç”¨æ¨£å¼ */
        .dark .bg-card {
            background-color: #2D3748; /* å¡ç‰‡èƒŒæ™¯ */
            border: 1px solid #4A5568;
        }
        .dark .text-primary { color: #CBD5E0; }
        .dark input, .dark textarea {
            background-color: #4A5568;
            border-color: #6B7280;
            color: #E2E8F0;
        }
        .dark input:focus, .dark textarea:focus {
            border-color: #63B3ED;
            box-shadow: 0 0 0 1px #63B3ED;
        }
        .dark .input-label { color: #A0AEC0; }
        
        /* ä¸»è¦æŒ‰éˆ•æ¼¸è®Š */
        .btn-primary {
            background: linear-gradient(90deg, #667EEA, #6B46C1); /* è—ç´«æ¼¸è®Š */
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .btn-primary:hover {
            background: linear-gradient(90deg, #5A67D8, #553C9A);
            transform: translateY(-1px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
        }
        .btn-primary:disabled {
            background: #4A5568;
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Gemini AI æŒ‰éˆ• */
        .btn-ai {
            background-color: #38A169; /* ç¶ è‰² */
            transition: background-color 0.2s;
        }
        .btn-ai:hover {
            background-color: #2F855A;
        }

        /* Log è¼¸å‡ºå€å¡Š */
        #logContainer {
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            background-color: #1A202C;
            border: 1px solid #4A5568;
            font-family: monospace;
            padding: 1rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* æ‹–æ”¾å€åŸŸæ¨£å¼ */
        .drop-zone {
            border: 2px dashed #6B7280;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background-color 0.2s;
        }
        .drop-zone.drag-over {
            border-color: #63B3ED;
            background-color: #3A4452;
        }

        @media (min-width: 768px) {
            body {
                padding: 4rem 1rem;
            }
        }
    </style>
</head>
<body class="text-primary">
    <div id="app" class="max-w-3xl mx-auto space-y-8">
        <h1 class="text-3xl font-bold text-center mb-6 text-white">
            <svg class="inline-block w-8 h-8 mr-2 -mt-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
            GitHub PR è‡ªå‹•åŒ–å·¥å…· (v1.1)
        </h1>
        
        <!-- èªè­‰èˆ‡å€‰åº« -->
        <div class="bg-card p-6 rounded-xl shadow-lg space-y-4">
            <h2 class="text-xl font-semibold border-b border-gray-600 pb-2">èªè­‰èˆ‡ç›®æ¨™å€‰åº«</h2>
            <p class="text-sm text-yellow-400 p-2 rounded-lg bg-yellow-900/50">
                âš ï¸ **å®‰å…¨è­¦å‘Šï¼š** è«‹å‹¿åˆ†äº«æ‚¨çš„å€‹äººå­˜å–æ¬Šæ– (PAT)ã€‚æœ¬å·¥å…·åªåœ¨ç€è¦½å™¨æœ¬åœ°ä½¿ç”¨æ‚¨çš„æ¬Šæ–é€²è¡Œ API å‘¼å«ã€‚
            </p>
            <div class="space-y-4 md:flex md:space-y-0 md:space-x-4">
                <div class="flex-1">
                    <label for="token" class="input-label block mb-1">GitHub PAT æ¬Šæ– (å¿…éœ€)</label>
                    <input type="password" id="token" placeholder="ghp_..." class="w-full p-2 rounded-lg border focus:outline-none">
                </div>
                <div class="flex-1">
                    <label for="repoFullName" class="input-label block mb-1">å€‰åº«åç¨± (Owner/Repo)</label>
                    <input type="text" id="repoFullName" value="google/gemini-api-recipes" placeholder="e.g. owner/repository-name" class="w-full p-2 rounded-lg border focus:outline-none">
                </div>
            </div>
        </div>

        <!-- åˆ†æ”¯è³‡è¨Š -->
        <div class="bg-card p-6 rounded-xl shadow-lg space-y-4">
            <h2 class="text-xl font-semibold border-b border-gray-600 pb-2">åˆ†æ”¯è¨­å®š</h2>
            <div class="space-y-4 md:flex md:space-y-0 md:space-x-4">
                <div class="flex-1">
                    <label for="baseBranch" class="input-label block mb-1">ç›®æ¨™åˆ†æ”¯ (Base Branch)</label>
                    <input type="text" id="baseBranch" value="main" placeholder="e.g. main" class="w-full p-2 rounded-lg border focus:outline-none">
                </div>
                <div class="flex-1">
                    <label for="newBranch" class="input-label block mb-1">ä¾†æºåˆ†æ”¯ (Source Branch)</label>
                    <input type="text" id="newBranch" placeholder="e.g. feat/add-new-feature" class="w-full p-2 rounded-lg border focus:outline-none">
                </div>
            </div>
            <div class="flex items-center pt-2">
                <input type="checkbox" id="deleteBranch" checked class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-2">
                <label for="deleteBranch" class="input-label">æˆåŠŸåˆä½µå¾Œåˆªé™¤ä¾†æºåˆ†æ”¯ (å¯é¸)</label>
            </div>
        </div>
        
        <!-- æª”æ¡ˆè®Šæ›´ (å‹•æ…‹å€å¡Š) -->
        <div class="bg-card p-6 rounded-xl shadow-lg space-y-4">
            <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                <h2 class="text-xl font-semibold">æª”æ¡ˆè®Šæ›´ (Commit)</h2>
                <button onclick="addFileBlock()" class="text-sm font-medium px-3 py-1 bg-indigo-500 hover:bg-indigo-600 rounded-lg transition">+ æ–°å¢å¦ä¸€å€‹æª”æ¡ˆ</button>
            </div>
            <div id="filesContainer" class="space-y-6">
                <!-- é è¨­æª”æ¡ˆå€å¡Šå°‡ç”± JS è¼‰å…¥ -->
            </div>
        </div>

        <!-- Pull Request è³‡è¨Š -->
        <div class="bg-card p-6 rounded-xl shadow-lg space-y-4">
            <h2 class="text-xl font-semibold border-b border-gray-600 pb-2">Pull Request è³‡è¨Š</h2>
            
            <div class="flex justify-between items-end">
                <div class="flex-1 pr-4">
                    <label for="prTitle" class="input-label block mb-1">PR æ¨™é¡Œ</label>
                    <input type="text" id="prTitle" placeholder="e.g. Fix: ä¿®æ­£ç™»å…¥é‚è¼¯" class="w-full p-2 rounded-lg border focus:outline-none">
                </div>
                <button id="btnGenerateTitle" onclick="generatePRTitle()" class="btn-ai text-white text-sm font-medium px-4 py-2 rounded-lg whitespace-nowrap">
                    âœ¨ å¹«æˆ‘ç”¢ç”Ÿ PR æ¨™é¡Œ
                </button>
            </div>

            <div class="flex justify-between items-end">
                <div class="flex-1 pr-4">
                    <label for="prBody" class="input-label block mb-1">PR æè¿° (æ”¯æ´ Markdown)</label>
                    <textarea id="prBody" rows="5" placeholder="è©³ç´°æè¿°è®Šæ›´å…§å®¹..." class="w-full p-2 rounded-lg border focus:outline-none"></textarea>
                </div>
                <button id="btnGenerateDesc" onclick="generatePRDescription()" class="btn-ai text-white text-sm font-medium px-4 py-2 rounded-lg whitespace-nowrap">
                    âœ¨ å¹«æˆ‘ç”¢ç”Ÿ PR æè¿°
                </button>
            </div>
            
            <div>
                <label for="issueNumber" class="input-label block mb-1">é€£å‹• Issue è™Ÿç¢¼ (å¯é¸)</label>
                <input type="text" id="issueNumber" placeholder="e.g. 123 (å°‡è‡ªå‹•åŠ å…¥ Closes #123)" class="w-full p-2 rounded-lg border focus:outline-none">
            </div>

            <div class="pt-4">
                <button id="mainActionButton" onclick="createPullRequest()" class="btn-primary text-white w-full py-3 rounded-lg text-lg font-semibold flex items-center justify-center">
                    <svg class="w-6 h-6 mr-2" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 21v-4a2 2 0 1 1 4 0v4"/><path d="M17 21v-8a2 2 0 1 1 4 0v8"/><path d="M7 3h2v2H7zM15 3h2v2h-2zM4 14V6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8M10 17v-4a2 2 0 1 1 4 0v4"/></svg>
                    å»ºç«‹ã€è‡ªå‹•åˆä½µä¸¦æ¸…ç† Pull Request (7 æ­¥é©Ÿ)
                </button>
            </div>
        </div>

        <!-- æ—¥èªŒèˆ‡çµæœè¼¸å‡º -->
        <div class="bg-card p-6 rounded-xl shadow-lg space-y-4">
            <h2 class="text-xl font-semibold border-b border-gray-600 pb-2">æ—¥èªŒèˆ‡åŸ·è¡Œçµæœ</h2>
            <div id="logContainer" class="rounded-lg">
                <!-- Log messages here -->
            </div>
            <div id="resultBox" class="p-4 rounded-lg hidden">
                <!-- Final result/link here -->
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://api.github.com';
        const GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025';
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=`; // API Key is read from environment
        
        let fileBlockCounter = 0;
        let isProcessing = false;

        /**
         * å¯«å…¥æ—¥èªŒè¨Šæ¯åˆ°æ—¥èªŒå®¹å™¨
         * @param {string} message - è¦è¨˜éŒ„çš„è¨Šæ¯
         * @param {string} level - è¨Šæ¯ç´šåˆ¥ ('info', 'success', 'error', 'warn')
         */
        function logMessage(message, level = 'info') {
            const logContainer = document.getElementById('logContainer');
            const colorMap = {
                info: 'text-gray-400',
                success: 'text-green-400',
                error: 'text-red-400',
                warn: 'text-yellow-400',
            };
            const prefixMap = {
                info: '[INFO]',
                success: '[SUCCESS]',
                error: '[ERROR]',
                warn: '[WARN]',
            };

            const logEntry = document.createElement('div');
            logEntry.className = colorMap[level];
            logEntry.innerHTML = `<span class="font-bold mr-2">${prefixMap[level]}</span> ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight; // ä¿æŒæ»¾å‹•åˆ°åº•éƒ¨
        }

        /**
         * é¡¯ç¤ºæœ€çµ‚çµæœè¨Šæ¯
         * @param {string} message - æœ€çµ‚çµæœ HTML/Text
         * @param {boolean} isSuccess - æ˜¯å¦æˆåŠŸ
         */
        function showResult(message, isSuccess) {
            const resultBox = document.getElementById('resultBox');
            resultBox.className = `p-4 rounded-lg mt-4 ${isSuccess ? 'bg-green-900/50 border border-green-700' : 'bg-red-900/50 border border-red-700'}`;
            resultBox.innerHTML = message;
            resultBox.style.display = 'block';
        }
        
        /**
         * æª¢æŸ¥è¼¸å…¥çš„å¿…è¦æ¬„ä½æ˜¯å¦å¡«å¯«
         * @returns {boolean}
         */
        function validateInputs() {
            const token = document.getElementById('token').value.trim();
            const repoFullName = document.getElementById('repoFullName').value.trim();
            const newBranch = document.getElementById('newBranch').value.trim();
            const prTitle = document.getElementById('prTitle').value.trim();
            const baseBranch = document.getElementById('baseBranch').value.trim();

            if (!token || !repoFullName || !newBranch || !prTitle || !baseBranch) {
                showResult('<strong>éŒ¯èª¤ï¼š</strong> PAT æ¬Šæ–ã€å€‰åº«åç¨±ã€ä¾†æºåˆ†æ”¯ã€ç›®æ¨™åˆ†æ”¯å’Œ PR æ¨™é¡Œéƒ½æ˜¯å¿…éœ€çš„ã€‚è«‹æª¢æŸ¥æ‰€æœ‰æ¬„ä½ã€‚', false);
                return false;
            }

            const fileBlocks = document.querySelectorAll('.file-block');
            if (fileBlocks.length === 0) {
                 showResult('<strong>éŒ¯èª¤ï¼š</strong> è‡³å°‘éœ€è¦ä¸€å€‹æª”æ¡ˆè®Šæ›´ã€‚', false);
                return false;
            }
            
            for (const block of fileBlocks) {
                const path = block.querySelector('.file-path').value.trim();
                const content = block.querySelector('.file-content').value;
                const commitMessage = block.querySelector('.commit-message').value.trim();
                if (!path || !content || !commitMessage) {
                    showResult(`<strong>éŒ¯èª¤ï¼š</strong> æª”æ¡ˆ #${block.dataset.index} çš„è·¯å¾‘ã€å…§å®¹å’Œæäº¤è¨Šæ¯éƒ½æ˜¯å¿…éœ€çš„ã€‚`, false);
                    return false;
                }
            }

            return true;
        }

        /**
         * å¸¶æœ‰æŒ‡æ•¸é€€é¿å’Œé‡è©¦æ©Ÿåˆ¶çš„ GitHub API å‘¼å«å™¨ (æœ€å¤š 5 æ¬¡)
         * @param {string} url - API URL
         * @param {string} method - HTTP æ–¹æ³• (GET, POST, PUT, DELETE)
         * @param {string} token - GitHub PAT
         * @param {object} payload - JSON payload
         * @param {number} maxRetries - æœ€å¤§é‡è©¦æ¬¡æ•¸
         * @returns {Promise<Response>}
         */
        async function callApiWithRetry(url, method, token, payload = null, maxRetries = 5) {
            const headers = {
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json',
            };

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: headers,
                        body: payload ? JSON.stringify(payload) : null,
                    });

                    // æˆåŠŸæˆ– 404/409 (é 5xx éŒ¯èª¤) ç›´æ¥è¿”å›
                    if (response.ok || response.status === 404 || response.status === 409) {
                        return response;
                    }
                    
                    // è™•ç† 403 Rate Limit æˆ– 5xx ä¼ºæœå™¨éŒ¯èª¤ï¼Œå˜—è©¦é‡è©¦
                    if (response.status === 403 || response.status >= 500) {
                         // æŒ‡æ•¸é€€é¿å»¶é²
                        const delay = Math.pow(2, i) * 1000;
                        logMessage(`API å‘¼å«å¤±æ•— (${response.status} ${response.statusText})ï¼Œå°‡åœ¨ ${delay / 1000} ç§’å¾Œé‡è©¦...`, 'warn');
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; // é€²å…¥ä¸‹ä¸€å€‹é‡è©¦å¾ªç’°
                    }

                    // å…¶ä»–éé‡è©¦éŒ¯èª¤ (å¦‚ 400 Bad Request, 401 Bad Credentials)
                    return response;
                    
                } catch (error) {
                    // ç¶²è·¯éŒ¯èª¤
                    const delay = Math.pow(2, i) * 1000;
                    logMessage(`ç¶²è·¯éŒ¯èª¤: ${error.message}ï¼Œå°‡åœ¨ ${delay / 1000} ç§’å¾Œé‡è©¦...`, 'error');
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }

            throw new Error(`API å‘¼å« ${url} å¤±æ•—ï¼Œå·²é”åˆ°æœ€å¤§é‡è©¦æ¬¡æ•¸ ${maxRetries}ã€‚`);
        }
        
        /**
         * å‘¼å« Gemini API é€²è¡Œ PR æ¨™é¡Œæˆ–æè¿°ç”Ÿæˆ
         * @param {string} systemPrompt - ç³»çµ±æç¤ºè©
         * @param {string} userQuery - ä½¿ç”¨è€…è¼¸å…¥çš„å…§å®¹ (ä¾†è‡ª Commit Messages)
         * @returns {Promise<string>} - è¿”å›ç”Ÿæˆçš„æ–‡æœ¬
         */
        async function callGeminiApi(systemPrompt, userQuery) {
            const btnTitle = document.getElementById('btnGenerateTitle');
            const btnDesc = document.getElementById('btnGenerateDesc');
            
            // ç”±æ–¼ API Key æ˜¯åœ¨ Canvas ç’°å¢ƒä¸­æä¾›çš„ï¼Œé€™è£¡ç•™ç©º
            const apiKey = ""; 
            const apiUrl = `${GEMINI_API_URL}${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };
            
            let resultText = '';
            const maxRetries = 3;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    // ç¦ç”¨æŒ‰éˆ•
                    btnTitle.disabled = true;
                    btnDesc.disabled = true;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.candidates && result.candidates.length > 0) {
                        resultText = result.candidates[0].content?.parts?.[0]?.text || '';
                        if (resultText) return resultText;
                    }

                    // è™•ç†éŒ¯èª¤æˆ–ç„¡æ•ˆéŸ¿æ‡‰ï¼Œé€²è¡Œé‡è©¦
                    const delay = Math.pow(2, i) * 1000;
                    logMessage(`Gemini API å‘¼å«å¤±æ•—ï¼Œå°‡åœ¨ ${delay / 1000} ç§’å¾Œé‡è©¦...`, 'warn');
                    await new Promise(resolve => setTimeout(resolve, delay));
                    
                } catch (error) {
                    const delay = Math.pow(2, i) * 1000;
                    logMessage(`Gemini API ç¶²è·¯éŒ¯èª¤: ${error.message}ï¼Œå°‡åœ¨ ${delay / 1000} ç§’å¾Œé‡è©¦...`, 'error');
                    await new Promise(resolve => setTimeout(resolve, delay));
                } finally {
                    // åœ¨æœ€å¾Œä¸€æ¬¡å˜—è©¦å¾Œæˆ–æˆåŠŸå¾Œé‡æ–°å•Ÿç”¨æŒ‰éˆ•
                    if (i === maxRetries - 1 || resultText) {
                        btnTitle.disabled = false;
                        btnDesc.disabled = false;
                    }
                }
            }
            
            throw new Error('ç„¡æ³•å¾ Gemini å–å¾—æœ‰æ•ˆçš„æ¨™é¡Œ/æè¿°ã€‚è«‹æ‰‹å‹•è¼¸å…¥ã€‚');
        }

        /**
         * ç”¢ç”Ÿ PR æ¨™é¡Œ
         */
        async function generatePRTitle() {
            const commitMessages = Array.from(document.querySelectorAll('.commit-message'))
                .map(el => el.value.trim())
                .filter(msg => msg.length > 0);
            
            if (commitMessages.length === 0) {
                logMessage('è«‹å…ˆè¼¸å…¥è‡³å°‘ä¸€å€‹æª”æ¡ˆçš„ã€Œæäº¤è¨Šæ¯ (Commit Message)ã€', 'warn');
                return;
            }

            const prompt = `åŸºæ–¼ä»¥ä¸‹æäº¤è¨Šæ¯ï¼Œç”Ÿæˆä¸€å€‹ç°¡æ½”ã€å–®è¡Œã€ä¸è¶…é 72 å€‹å­—å…ƒçš„ GitHub Pull Request æ¨™é¡Œã€‚åªè¼¸å‡ºæ¨™é¡Œæœ¬èº«ï¼Œä¸è¦åŒ…å«ä»»ä½•å‰ç¶´æˆ–è§£é‡‹ã€‚\n\næäº¤è¨Šæ¯:\n${commitMessages.join('\n')}`;
            const systemPrompt = "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ GitHub é–‹ç™¼è€…ã€‚è«‹æ ¹æ“šæäº¤è¨Šæ¯ï¼Œä»¥æœ€ç°¡æ½”ä¸”ç¬¦åˆè¦ç¯„çš„é¢¨æ ¼ç”Ÿæˆä¸€å€‹ PR æ¨™é¡Œã€‚";
            
            try {
                logMessage('æ­£åœ¨å‘¼å« Gemini AI ç”¢ç”Ÿ PR æ¨™é¡Œ...');
                const title = await callGeminiApi(systemPrompt, prompt);
                document.getElementById('prTitle').value = title.trim();
                logMessage('PR æ¨™é¡Œå·²æˆåŠŸç”Ÿæˆä¸¦å¡«å…¥ã€‚', 'success');
            } catch (error) {
                logMessage(`ç”¢ç”Ÿ PR æ¨™é¡Œå¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        /**
         * ç”¢ç”Ÿ PR æè¿°
         */
        async function generatePRDescription() {
            const commitMessages = Array.from(document.querySelectorAll('.commit-message'))
                .map(el => el.value.trim())
                .filter(msg => msg.length > 0);
            
            if (commitMessages.length === 0) {
                logMessage('è«‹å…ˆè¼¸å…¥è‡³å°‘ä¸€å€‹æª”æ¡ˆçš„ã€Œæäº¤è¨Šæ¯ (Commit Message)ã€', 'warn');
                return;
            }

            const prompt = `åŸºæ–¼ä»¥ä¸‹æäº¤è¨Šæ¯ï¼Œç”Ÿæˆä¸€å€‹çµæ§‹åŒ–çš„ GitHub Pull Request æè¿°ã€‚ä½¿ç”¨ Markdown æ ¼å¼ï¼ŒåŒ…å«ä»¥ä¸‹å…©å€‹é ‚ç´šæ¨™é¡Œï¼š\n1. **è®Šæ›´æ‘˜è¦** (Summary of Changes): ç°¡è¦èªªæ˜é€™æ¬¡ PR çš„ç›®çš„å’Œä¸»è¦è®Šæ›´ã€‚\n2. **è©³ç´°è®Šæ›´** (Detailed Changes): ä»¥ Markdown æ¸…å–®åˆ—å‡ºæ‰€æœ‰æäº¤è¨Šæ¯çš„è¦é»ã€‚\n\næäº¤è¨Šæ¯:\n${commitMessages.join('\n')}`;
            const systemPrompt = "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ GitHub é–‹ç™¼è€…ã€‚è«‹æ ¹æ“šæäº¤è¨Šæ¯ï¼Œç”Ÿæˆçµæ§‹åŒ–ä¸”æ˜“æ–¼é–±è®€çš„ Markdown æ ¼å¼ PR æè¿°ã€‚";
            
            try {
                logMessage('æ­£åœ¨å‘¼å« Gemini AI ç”¢ç”Ÿ PR æè¿°...');
                const description = await callGeminiApi(systemPrompt, prompt);
                document.getElementById('prBody').value = description.trim();
                logMessage('PR æè¿°å·²æˆåŠŸç”Ÿæˆä¸¦å¡«å…¥ã€‚', 'success');
            } catch (error) {
                logMessage(`ç”¢ç”Ÿ PR æè¿°å¤±æ•—: ${error.message}`, 'error');
            }
        }

        /**
         * è™•ç†æ‹–æ”¾æª”æ¡ˆä¸Šå‚³
         * @param {DragEvent} e - æ‹–æ”¾äº‹ä»¶ç‰©ä»¶
         * @param {HTMLElement} block - æª”æ¡ˆå€å¡Šçš„å®¹å™¨å…ƒç´ 
         */
        function handleFileDrop(e, block) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');

            const file = e.dataTransfer.files[0];
            if (!file) return;

            const filePathInput = block.querySelector('.file-path');
            const fileContentTextarea = block.querySelector('.file-content');

            // 1. è‡ªå‹•å¡«å…¥æª”æ¡ˆåç¨±ä½œç‚ºè·¯å¾‘
            filePathInput.value = file.name;

            // 2. è®€å–æª”æ¡ˆå…§å®¹
            const reader = new FileReader();
            reader.onload = function(e) {
                fileContentTextarea.value = e.target.result;
                logMessage(`æª”æ¡ˆ ${file.name} (å¤§å°: ${file.size} bytes) å…§å®¹å·²è®€å–ä¸¦å¡«å…¥ã€‚`);
            };
            reader.onerror = function(error) {
                logMessage(`è®€å–æª”æ¡ˆ ${file.name} å¤±æ•—: ${error}`, 'error');
            };
            reader.readAsText(file);
        }
        
        /**
         * å‹•æ…‹æ–°å¢æª”æ¡ˆè®Šæ›´å€å¡Š
         * @param {string} defaultPath - é è¨­æª”æ¡ˆè·¯å¾‘
         * @param {string} defaultContent - é è¨­æª”æ¡ˆå…§å®¹
         * @param {string} defaultCommit - é è¨­æäº¤è¨Šæ¯
         */
        function addFileBlock(defaultPath = '', defaultContent = '', defaultCommit = '') {
            fileBlockCounter++;
            const index = fileBlockCounter;
            const container = document.getElementById('filesContainer');

            const block = document.createElement('div');
            block.className = 'file-block bg-gray-700/50 p-4 rounded-lg space-y-3';
            block.dataset.index = index;
            
            block.innerHTML = `
                <div class="flex justify-between items-center border-b border-gray-500 pb-2">
                    <h3 class="text-lg font-medium">æª”æ¡ˆ #${index} è®Šæ›´</h3>
                    <button onclick="removeFileBlock(this)" class="text-red-400 hover:text-red-500 text-sm font-medium">åˆªé™¤</button>
                </div>

                <div class="drop-zone rounded-lg" 
                    ondragover="event.preventDefault(); this.classList.add('drag-over');"
                    ondragleave="this.classList.remove('drag-over');"
                    ondrop="handleFileDrop(event, this.closest('.file-block'));">
                    å°‡æª”æ¡ˆæ‹–æ”¾åˆ°æ­¤è™•ï¼Œè‡ªå‹•å¡«å…¥è·¯å¾‘èˆ‡å…§å®¹
                </div>

                <div>
                    <label class="input-label block mb-1 text-sm">æª”æ¡ˆè·¯å¾‘ (e.g. src/file.js)</label>
                    <input type="text" value="${defaultPath}" class="file-path w-full p-2 rounded-lg border focus:outline-none" placeholder="æª”æ¡ˆåœ¨å€‰åº«ä¸­çš„å®Œæ•´è·¯å¾‘">
                </div>
                
                <div>
                    <label class="input-label block mb-1 text-sm">æäº¤è¨Šæ¯ (Commit Message)</label>
                    <input type="text" value="${defaultCommit}" class="commit-message w-full p-2 rounded-lg border focus:outline-none" placeholder="e.g. feat: å¢åŠ æ–°çš„è¨­å®šæª”">
                </div>

                <div>
                    <label class="input-label block mb-1 text-sm">æª”æ¡ˆå…§å®¹ (UTF-8)</label>
                    <textarea rows="6" class="file-content w-full p-2 rounded-lg border focus:outline-none">${defaultContent}</textarea>
                </div>
            `;
            container.appendChild(block);

            // åªæœ‰åœ¨ç¬¬ä¸€æ¬¡è¼‰å…¥æ™‚ï¼Œå¦‚æœæ²’æœ‰è¨­å®šé è¨­å€¼ï¼Œçµ¦äºˆä¸€äº›å»ºè­°
            if (fileBlockCounter === 1 && !defaultPath) {
                block.querySelector('.file-path').value = 'docs/README.md';
                block.querySelector('.commit-message').value = 'docs: æ›´æ–°èªªæ˜æ–‡ä»¶';
                block.querySelector('.file-content').value = '## GitHub PR è‡ªå‹•ç”¢ç”Ÿå™¨\n\né€™ä»½æ–‡ä»¶ç”±è‡ªå‹•åŒ–å·¥å…·ç”Ÿæˆã€‚';
            }
        }

        /**
         * åˆªé™¤æª”æ¡ˆå€å¡Š
         * @param {HTMLElement} button - è§¸ç™¼åˆªé™¤çš„æŒ‰éˆ•å…ƒç´ 
         */
        function removeFileBlock(button) {
            const block = button.closest('.file-block');
            block.remove();
        }

        /**
         * ä¸»åŸ·è¡Œå‡½æ•¸ï¼šå»ºç«‹ PR ä¸¦è‡ªå‹•åˆä½µ
         */
        async function createPullRequest() {
            if (isProcessing) return;
            if (!validateInputs()) return;

            isProcessing = true;
            document.getElementById('mainActionButton').disabled = true;
            document.getElementById('logContainer').innerHTML = '';
            document.getElementById('resultBox').style.display = 'none';
            
            const token = document.getElementById('token').value.trim();
            const repoFullName = document.getElementById('repoFullName').value.trim();
            const baseBranch = document.getElementById('baseBranch').value.trim();
            const newBranch = document.getElementById('newBranch').value.trim();
            const prTitle = document.getElementById('prTitle').value.trim();
            let prBody = document.getElementById('prBody').value;
            const issueNumber = document.getElementById('issueNumber').value.trim();
            const deleteBranchAfterMerge = document.getElementById('deleteBranch').checked;
            
            const [owner, repo] = repoFullName.split('/');
            
            // æ”¶é›†æª”æ¡ˆè®Šæ›´è³‡è¨Š
            const fileChanges = Array.from(document.querySelectorAll('.file-block')).map(block => ({
                path: block.querySelector('.file-path').value.trim(),
                content: block.querySelector('.file-content').value,
                commitMessage: block.querySelector('.commit-message').value.trim(),
            }));
            
            let baseBranchSHA = null;
            let prNumber = null;
            
            try {
                // =========================================================================
                // Step 1/7: å–å¾—åŸºç¤ SHA
                // =========================================================================
                logMessage(`[1/7] æ­£åœ¨å–å¾—åŸºç¤åˆ†æ”¯ (${baseBranch}) çš„æœ€æ–° SHA...`);
                const refUrl = `${API_BASE}/repos/${owner}/${repo}/git/ref/heads/${baseBranch}`;
                let response = await callApiWithRetry(refUrl, 'GET', token);

                if (!response.ok) {
                    throw new Error(`ç„¡æ³•å–å¾—åŸºç¤åˆ†æ”¯ SHAã€‚ç‹€æ…‹: ${response.status} ${response.statusText}`);
                }
                const baseRefData = await response.json();
                baseBranchSHA = baseRefData.object.sha;
                logMessage(`åŸºç¤ SHA å–å¾—æˆåŠŸ: ${baseBranchSHA}`);

                // =========================================================================
                // Step 2/7: å»ºç«‹æ–°åˆ†æ”¯
                // =========================================================================
                logMessage(`[2/7] æ­£åœ¨å˜—è©¦å»ºç«‹æ–°åˆ†æ”¯ (${newBranch})...`);
                const newRefUrl = `${API_BASE}/repos/${owner}/${repo}/git/refs`;
                const newRefPayload = {
                    ref: `refs/heads/${newBranch}`,
                    sha: baseBranchSHA
                };
                response = await callApiWithRetry(newRefUrl, 'POST', token, newRefPayload);

                if (response.status === 422) { // 422 Unprocessable Entity - å¯èƒ½æ˜¯åˆ†æ”¯å·²å­˜åœ¨
                    logMessage(`åˆ†æ”¯ refs/heads/${newBranch} å·²å­˜åœ¨ã€‚è·³éå»ºç«‹æ­¥é©Ÿï¼Œç¹¼çºŒä½¿ç”¨ç¾æœ‰åˆ†æ”¯ã€‚`, 'warn');
                } else if (!response.ok) {
                    throw new Error(`å»ºç«‹åˆ†æ”¯å¤±æ•—ã€‚ç‹€æ…‹: ${response.status} ${response.statusText}`);
                } else {
                    logMessage(`æ–°åˆ†æ”¯ refs/heads/${newBranch} å»ºç«‹æˆåŠŸã€‚`, 'success');
                }
                
                // =========================================================================
                // Step 3/7: æäº¤æª”æ¡ˆè®Šæ›´
                // =========================================================================
                logMessage(`[3/7] æ­£åœ¨æäº¤ ${fileChanges.length} å€‹æª”æ¡ˆè®Šæ›´...`);
                
                for (const change of fileChanges) {
                    logMessage(`   > è™•ç†æª”æ¡ˆ: ${change.path}`);
                    const contentUrl = `${API_BASE}/repos/${owner}/${repo}/contents/${change.path}`;
                    
                    // 1. å˜—è©¦å–å¾—ç¾æœ‰æª”æ¡ˆ SHA (ç”¨æ–¼æ›´æ–°)
                    let existingSHA = null;
                    const getFileResponse = await callApiWithRetry(`${contentUrl}?ref=${newBranch}`, 'GET', token);
                    
                    if (getFileResponse.ok) {
                        const fileData = await getFileResponse.json();
                        existingSHA = fileData.sha;
                        logMessage(`   > æª”æ¡ˆå·²å­˜åœ¨ (SHA: ${existingSHA})ï¼Œå°‡åŸ·è¡Œ **æ›´æ–°** æ“ä½œã€‚`);
                    } else if (getFileResponse.status === 404) {
                        logMessage(`   > æª”æ¡ˆä¸å­˜åœ¨ï¼Œå°‡åŸ·è¡Œ **æ–°å¢** æ“ä½œã€‚`);
                    } else {
                        throw new Error(`å˜—è©¦å–å¾—æª”æ¡ˆ ${change.path} è³‡è¨Šå¤±æ•—ã€‚ç‹€æ…‹: ${getFileResponse.status}`);
                    }
                    
                    // 2. æäº¤ PUT è«‹æ±‚
                    const putPayload = {
                        message: change.commitMessage,
                        content: btoa(unescape(encodeURIComponent(change.content))), // ç¢ºä¿ UTF-8 æ­£ç¢ºç·¨ç¢¼
                        branch: newBranch,
                        sha: existingSHA // åƒ…åœ¨æ›´æ–°æ™‚æä¾› SHA
                    };

                    const putResponse = await callApiWithRetry(contentUrl, 'PUT', token, putPayload);
                    if (!putResponse.ok) {
                        const errorData = await putResponse.json();
                        throw new Error(`æäº¤æª”æ¡ˆ ${change.path} å¤±æ•—: ${errorData.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                    }
                    logMessage(`   > æª”æ¡ˆ ${change.path} æäº¤æˆåŠŸã€‚`, 'success');
                }

                // =========================================================================
                // Step 4/7: å»ºç«‹ PR
                // =========================================================================
                logMessage(`[4/7] æ­£åœ¨å»ºç«‹ Pull Request...`);
                
                // è™•ç† Issue è™Ÿç¢¼é€£å‹•
                if (issueNumber) {
                    const issueLink = `Closes #${issueNumber}\n\n`;
                    prBody = issueLink + prBody;
                    logMessage(`   > å·²è‡ªå‹•åŠ å…¥é€£å‹• Issue é—œéµå­—: ${issueLink.trim()}`);
                }
                
                const prUrl = `${API_BASE}/repos/${owner}/${repo}/pulls`;
                const prPayload = {
                    title: prTitle,
                    body: prBody,
                    head: newBranch,
                    base: baseBranch
                };
                
                response = await callApiWithRetry(prUrl, 'POST', token, prPayload);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`å»ºç«‹ PR å¤±æ•—: ${errorData.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                }
                const prData = await response.json();
                prNumber = prData.number;
                logMessage(`PR å»ºç«‹æˆåŠŸï¼ç·¨è™Ÿ #${prNumber}ï¼Œé€£çµ: ${prData.html_url}`, 'success');

                // =========================================================================
                // Step 5/7: ç­‰å¾… PR ç‹€æ…‹è®Šç‚ºå¯åˆä½µ (Mergeable)
                // =========================================================================
                logMessage(`[5/7] æ­£åœ¨è¼ªè©¢ PR ç‹€æ…‹ï¼Œç­‰å¾…å¯åˆä½µ... (æœ€å¤š 10 æ¬¡)`);
                let prStatusUrl = `${API_BASE}/repos/${owner}/${repo}/pulls/${prNumber}`;
                
                const MAX_POLLS = 10;
                let mergeable = false;

                for (let i = 0; i < MAX_POLLS; i++) {
                    // ä½¿ç”¨æ™‚é–“æˆ³åŸ·è¡Œ Cache-Busting
                    const cacheBustingUrl = `${prStatusUrl}?_=${new Date().getTime()}`;
                    response = await callApiWithRetry(cacheBustingUrl, 'GET', token);
                    
                    if (!response.ok) {
                        throw new Error(`è¼ªè©¢ PR ç‹€æ…‹å¤±æ•—ã€‚ç‹€æ…‹: ${response.status}`);
                    }
                    
                    const statusData = await response.json();
                    
                    if (statusData.mergeable === true) {
                        mergeable = true;
                        logMessage(`PR å·²æº–å‚™å¥½åˆä½µ (Mergeable: true)ã€‚`, 'success');
                        break;
                    } else if (statusData.mergeable === false) {
                        logMessage(`PR é¡¯ç¤ºä¸å¯åˆä½µ (Mergeable: false)ï¼Œå¯èƒ½éœ€è¦æ‰‹å‹•ä¿®å¾©è¡çªæˆ–ç­‰å¾… CIã€‚ä¸­æ­¢è‡ªå‹•åˆä½µã€‚`, 'warn');
                        break;
                    } else { // mergeable === null, ç‹€æ…‹ä»åœ¨è¨ˆç®—ä¸­
                        logMessage(`PR ç‹€æ…‹ä»åœ¨è¨ˆç®—ä¸­... (ç¬¬ ${i + 1}/${MAX_POLLS} æ¬¡å˜—è©¦)`);
                        if (i < MAX_POLLS - 1) {
                            await new Promise(resolve => setTimeout(resolve, 2000)); // é–“éš” 2 ç§’
                        }
                    }
                }

                if (!mergeable) {
                    logMessage('é”åˆ°æœ€å¤§è¼ªè©¢æ¬¡æ•¸ï¼ŒPR ä»æœªé¡¯ç¤ºç‚ºå¯åˆä½µã€‚ä¸­æ­¢è‡ªå‹•åˆä½µï¼Œè«‹æ‰‹å‹•æª¢æŸ¥ PRã€‚', 'warn');
                    return; // çµæŸåŸ·è¡Œ
                }
                
                // =========================================================================
                // Step 6/7: è‡ªå‹•åˆä½µ PR
                // =========================================================================
                logMessage(`[6/7] æ­£åœ¨åŸ·è¡Œè‡ªå‹• **Squash åˆä½µ**...`);
                const mergeUrl = `${API_BASE}/repos/${owner}/${repo}/pulls/${prNumber}/merge`;
                const mergePayload = {
                    commit_title: prTitle, // ä½¿ç”¨ PR æ¨™é¡Œä½œç‚º Squash Commit æ¨™é¡Œ
                    commit_message: prBody,
                    merge_method: 'squash'
                };

                response = await callApiWithRetry(mergeUrl, 'PUT', token, mergePayload);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`è‡ªå‹•åˆä½µ PR å¤±æ•—: ${errorData.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                }
                
                const mergeData = await response.json();
                logMessage(`PR åˆä½µæˆåŠŸï¼Commit SHA: ${mergeData.sha}`, 'success');

                // =========================================================================
                // Step 7/7: åˆªé™¤ä¾†æºåˆ†æ”¯ (å¯é¸)
                // =========================================================================
                if (deleteBranchAfterMerge) {
                    logMessage(`[7/7] æ­£åœ¨å˜—è©¦åˆªé™¤ä¾†æºåˆ†æ”¯ (${newBranch})...`);
                    const deleteRefUrl = `${API_BASE}/repos/${owner}/${repo}/git/refs/heads/${newBranch}`;
                    response = await callApiWithRetry(deleteRefUrl, 'DELETE', token);

                    if (response.ok) {
                        logMessage(`ä¾†æºåˆ†æ”¯ ${newBranch} åˆªé™¤æˆåŠŸã€‚`, 'success');
                    } else if (response.status === 422) {
                        logMessage(`åˆªé™¤åˆ†æ”¯å¤±æ•— (422 Unprocessable Entity)ï¼Œå¯èƒ½æ˜¯åˆ†æ”¯å·²è¢«é–å®šæˆ–ä¿è­·ã€‚`, 'warn');
                    } else if (response.status === 404) {
                        logMessage(`ä¾†æºåˆ†æ”¯ ${newBranch} å·²ç¶“ä¸å­˜åœ¨ã€‚`, 'warn');
                    } else {
                        logMessage(`åˆªé™¤ä¾†æºåˆ†æ”¯å¤±æ•—ã€‚ç‹€æ…‹: ${response.status} ${response.statusText}`, 'error');
                    }
                } else {
                    logMessage('[7/7] ç•¥éåˆªé™¤ä¾†æºåˆ†æ”¯æ­¥é©Ÿ (ä¾è¨­å®š)ã€‚');
                }
                
                // æœ€çµ‚æˆåŠŸè¨Šæ¯
                const finalMessage = `
                    <div class="flex items-center space-x-2">
                        <svg class="w-6 h-6 text-green-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 11 12 14 22 4"/><path d="M21 12v5c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2V5c0-1.1.9-2 2-2h11"/></svg>
                        <span class="text-lg font-bold">ğŸ‰ PR è‡ªå‹•åŒ–æµç¨‹å·²æˆåŠŸå®Œæˆï¼</span>
                    </div>
                    <p class="mt-2">æ‰€æœ‰è®Šæ›´å·²åˆä½µåˆ° <code>${baseBranch}</code>ã€‚</p>
                    <a href="${prData.html_url}" target="_blank" class="text-indigo-400 hover:text-indigo-300 font-medium underline">é»æ­¤æŸ¥çœ‹ Pull Request #${prNumber}</a>
                `;
                showResult(finalMessage, true);

            } catch (error) {
                logMessage(`æœ€çµ‚éŒ¯èª¤: ${error.message}`, 'error');
                showResult(`<strong>ğŸš¨ æµç¨‹å¤±æ•—ï¼š</strong> ${error.message}<br>è«‹æª¢æŸ¥æ¬Šæ–ã€å€‰åº«åç¨±ã€åˆ†æ”¯åç¨±æˆ– PR #${prNumber} çš„ç‹€æ…‹ã€‚`, false);
            } finally {
                isProcessing = false;
                document.getElementById('mainActionButton').disabled = false;
            }
        }
        
        // è¼‰å…¥æ™‚è‡ªå‹•æ–°å¢ä¸€å€‹æª”æ¡ˆå€å¡Š
        window.onload = function() {
            addFileBlock();
        };

    </script>
</body>
</html>