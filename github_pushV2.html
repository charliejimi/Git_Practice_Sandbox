<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub æª”æ¡ˆç®¡ç†çµ‚ç«¯ v2.4 (è‡ªå¡« API Key)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- åŠ å…¥ FontAwesome ç”¨æ–¼åœ–ç¤º -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- åŠ å…¥ Markdown è§£æå™¨ (marked) ç”¨æ–¼æ¸²æŸ“ AI å›æ‡‰ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0F172A, #1E293B);
            min-height: 100vh;
            color: #E2E8F0;
        }

        /* æ»¾å‹•æ¢ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-gradient {
            background: linear-gradient(135deg, #3B82F6, #8B5CF6);
            transition: all 0.3s ease;
        }
        .btn-gradient:hover:not(:disabled) {
            background: linear-gradient(135deg, #2563EB, #7C3AED);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #EF4444, #B91C1C);
            transition: all 0.3s ease;
        }
        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .input-field {
            background: #0F172A;
            border: 1px solid #334155;
            transition: all 0.3s;
        }
        .input-field:focus {
            border-color: #8B5CF6;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
            outline: none;
        }

        /* æª”æ¡ˆåˆ—è¡¨é …ç›®å‹•ç•« */
        .file-item {
            transition: background-color 0.2s;
        }
        .file-item:hover {
            background-color: #334155;
        }

        .spinner {
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Markdown æ¨£å¼ä¿®æ­£ */
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { margin-top: 1em; margin-bottom: 0.5em; font-weight: bold; color: #fff; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body li { margin-bottom: 0.3em; }
        .markdown-body code { background-color: #334155; padding: 0.2em 0.4em; border-radius: 3px; font-family: monospace; }
        .markdown-body pre { background-color: #1e293b; padding: 1em; border-radius: 0.5em; overflow-x: auto; margin-bottom: 1em; }
        .markdown-body p { margin-bottom: 0.8em; }
        .markdown-body strong { color: #A5B4FC; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- å·¦å´é¢æ¿ï¼šè¨­å®šèˆ‡æª”æ¡ˆç€è¦½å™¨ -->
        <div class="lg:col-span-1 space-y-6">
            
            <!-- 1. è¨­å®šå€å¡Š -->
            <div class="glass-panel rounded-2xl p-6 shadow-xl">
                <h2 class="text-xl font-bold mb-4 flex items-center text-blue-400">
                    <i class="fa-brands fa-github mr-2"></i> å€‰åº«è¨­å®š
                </h2>
                
                <div class="space-y-4">
                    <!-- Token -->
                    <div>
                        <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider">GitHub PAT Token</label>
                        <div class="relative">
                            <input type="password" id="token" placeholder="ghp_xxxxxxxxxxxx"
                                class="input-field w-full p-2.5 rounded-lg text-sm mt-1 pr-10">
                            <button onclick="toggleTokenVisibility('token', 'eyeIcon')" class="absolute right-3 top-3.5 text-gray-500 hover:text-white">
                                <i class="fa-regular fa-eye" id="eyeIcon"></i>
                            </button>
                        </div>
                        <div class="flex items-center mt-2">
                            <input type="checkbox" id="saveToken" class="rounded bg-gray-700 border-gray-600 text-blue-500 focus:ring-blue-500">
                            <label for="saveToken" class="ml-2 text-xs text-gray-400">è¨˜ä½ Token (å„²å­˜æ–¼ç€è¦½å™¨)</label>
                        </div>
                    </div>

                    <!-- Gemini API Key -->
                    <div class="border-t border-slate-700 pt-4">
                        <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider flex items-center">
                            <i class="fa-solid fa-robot mr-1"></i> Gemini API Key (é¸å¡«)
                        </label>
                        <div class="relative">
                            <input type="password" id="geminiApiKey" placeholder="AIzaSy..."
                                class="input-field w-full p-2.5 rounded-lg text-sm mt-1 pr-10">
                            <button onclick="toggleTokenVisibility('geminiApiKey', 'aiEyeIcon')" class="absolute right-3 top-3.5 text-gray-500 hover:text-white">
                                <i class="fa-regular fa-eye" id="aiEyeIcon"></i>
                            </button>
                        </div>
                         <div class="flex items-center mt-2">
                            <input type="checkbox" id="saveGeminiKey" class="rounded bg-gray-700 border-gray-600 text-blue-500 focus:ring-blue-500">
                            <label for="saveGeminiKey" class="ml-2 text-xs text-gray-400">è¨˜ä½ API Key</label>
                        </div>
                    </div>

                    <!-- Repo & Branch -->
                    <div class="border-t border-slate-700 pt-4">
                        <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Owner / Repo</label>
                        <input type="text" id="repo" value="charliejimi/Git_Practice_Sandbox" placeholder="user/repo"
                            class="input-field w-full p-2.5 rounded-lg text-sm mt-1">
                    </div>
                    <div>
                        <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Branch</label>
                        <input type="text" id="branch" value="master" placeholder="main or master"
                            class="input-field w-full p-2.5 rounded-lg text-sm mt-1">
                    </div>
                    
                    <button onclick="fetchRepoContents()" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-medium py-2 rounded-lg text-sm transition flex justify-center items-center">
                        <i class="fa-solid fa-rotate mr-2"></i> é€£ç·šä¸¦è®€å–æª”æ¡ˆåˆ—è¡¨
                    </button>
                </div>
            </div>

            <!-- 2. æª”æ¡ˆç€è¦½å™¨ -->
            <div class="glass-panel rounded-2xl p-6 shadow-xl flex flex-col h-[500px]">
                <h2 class="text-xl font-bold mb-2 flex items-center text-emerald-400">
                    <i class="fa-regular fa-folder-open mr-2"></i> æª”æ¡ˆç€è¦½å™¨
                </h2>
                <div class="text-xs text-gray-400 mb-2 truncate" id="currentPathDisplay">root/</div>
                
                <!-- æª”æ¡ˆåˆ—è¡¨å€åŸŸ -->
                <div id="fileList" class="flex-grow overflow-y-auto border border-slate-700 rounded-lg bg-slate-900/50 p-2 space-y-1">
                    <div class="text-center text-gray-500 mt-10 text-sm">
                        <p>è«‹è¼¸å…¥è¨­å®šä¸¦é»æ“Šä¸Šæ–¹<br>ã€Œé€£ç·šä¸¦è®€å–ã€æŒ‰éˆ•</p>
                    </div>
                </div>

                <!-- åº•éƒ¨æ“ä½œæç¤º -->
                <div class="mt-3 text-[10px] text-gray-500 text-center">
                    é»æ“Šè³‡æ–™å¤¾é€²å…¥ï¼Œé»æ“Šæª”æ¡ˆé¸å–è·¯å¾‘
                </div>
            </div>
        </div>

        <!-- å³å´é¢æ¿ï¼šä¸Šå‚³èˆ‡æ“ä½œå€ -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- 3. ä¸Šå‚³/ç·¨è¼¯å€ -->
            <div class="glass-panel rounded-2xl p-6 md:p-10 shadow-xl relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
                    <i class="fa-brands fa-git-alt text-9xl"></i>
                </div>

                <h1 class="text-3xl font-extrabold text-white mb-6 tracking-tight flex items-center gap-3">
                    æª”æ¡ˆä¸Šå‚³èˆ‡æ™ºèƒ½æ“ä½œ
                    <span class="text-xs font-normal bg-blue-600 text-white px-2 py-1 rounded-full align-middle">AI Powered</span>
                </h1>

                <!-- ç›®æ¨™è·¯å¾‘ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-400 mb-1">ç›®æ¨™è·¯å¾‘ (å«æª”å)</label>
                    <div class="flex">
                        <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-slate-600 bg-slate-700 text-gray-400 text-sm">
                            /
                        </span>
                        <input type="text" id="targetPath" placeholder="folder/filename.ext"
                            class="input-field flex-1 p-3 rounded-r-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <p class="text-xs text-gray-500 mt-1 ml-1">å¾å·¦å´é»æ“Šæª”æ¡ˆå¯è‡ªå‹•å¡«å…¥</p>
                </div>

                <!-- æª”æ¡ˆé¸æ“‡å€åŸŸ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-400 mb-2">é¸æ“‡æª”æ¡ˆ (æ”¯æ´æ–‡å­—ã€ç¨‹å¼ç¢¼èˆ‡åœ–ç‰‡)</label>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- æ‹–æ”¾å€ -->
                        <div class="md:col-span-2 relative border-2 border-dashed border-slate-600 rounded-xl p-6 hover:border-blue-500 transition-colors group cursor-pointer bg-slate-800/50"
                             onclick="document.getElementById('fileInput').click()">
                            <input type="file" id="fileInput" class="hidden" 
                                   accept=".txt,.html,.css,.js,.json,.md,.png,.jpg,.jpeg,.gif,.svg,.webp,.py,.java,.cpp,.ts"
                                   onchange="handleFileSelect(this)">
                            
                            <div class="text-center space-y-2 pointer-events-none">
                                <i class="fa-solid fa-cloud-arrow-up text-3xl text-gray-400 group-hover:text-blue-400 transition"></i>
                                <p id="fileNameDisplay" class="text-sm text-gray-300 font-medium">é»æ“Šæˆ–æ‹–æ›³æª”æ¡ˆè‡³æ­¤</p>
                                <p class="text-xs text-gray-500">æ”¯æ´ç¨‹å¼ç¢¼ã€æ–‡å­—æª”èˆ‡åœ–ç‰‡</p>
                            </div>
                        </div>

                        <!-- é è¦½å€ -->
                        <div class="md:col-span-1 border border-slate-700 rounded-xl bg-slate-900 flex items-center justify-center overflow-hidden relative min-h-[120px]">
                            <img id="imagePreview" class="hidden w-full h-full object-cover" alt="Preview">
                            <div id="textPreviewIcon" class="hidden text-gray-600 flex flex-col items-center gap-2">
                                <i class="fa-regular fa-file-code text-4xl"></i>
                                <span class="text-xs">ç¨‹å¼ç¢¼æª”æ¡ˆ</span>
                            </div>
                            <span id="noPreviewText" class="text-xs text-gray-600">ç„¡é è¦½</span>
                            
                            <!-- æ¸…é™¤æŒ‰éˆ• -->
                            <button onclick="clearFileSelection()" id="clearFileBtn" class="hidden absolute top-1 right-1 bg-red-500/80 hover:bg-red-600 text-white rounded-full p-1 w-6 h-6 flex items-center justify-center text-xs backdrop-blur-sm">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Gemini AI åŠŸèƒ½å€ -->
                <div class="mb-6 p-4 rounded-xl border border-indigo-500/30 bg-indigo-900/10">
                    <label class="block text-sm font-bold text-indigo-300 mb-3 flex items-center">
                        <i class="fa-solid fa-robot mr-2"></i> Gemini AI æ™ºèƒ½åŠ©æ‰‹
                    </label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <button onclick="runGeminiTask('summary')" id="btnSummary" disabled
                            class="bg-indigo-600/20 border border-indigo-500/30 text-indigo-300 hover:bg-indigo-600/30 py-2 px-3 rounded-lg text-sm font-medium transition flex items-center justify-center disabled:opacity-30 disabled:cursor-not-allowed">
                            <i class="fa-solid fa-file-lines mr-2"></i> æª”æ¡ˆæ‘˜è¦
                        </button>
                        <button onclick="runGeminiTask('commit')" id="btnCommitMsg" disabled
                            class="bg-amber-600/20 border border-amber-500/30 text-amber-300 hover:bg-amber-600/30 py-2 px-3 rounded-lg text-sm font-medium transition flex items-center justify-center disabled:opacity-30 disabled:cursor-not-allowed">
                            <i class="fa-solid fa-message mr-2"></i> å¯« Commit è¨Šæ¯
                        </button>
                        <button onclick="runGeminiTask('review')" id="btnCodeReview" disabled
                            class="bg-emerald-600/20 border border-emerald-500/30 text-emerald-300 hover:bg-emerald-600/30 py-2 px-3 rounded-lg text-sm font-medium transition flex items-center justify-center disabled:opacity-30 disabled:cursor-not-allowed relative overflow-hidden group">
                            <span class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></span>
                            <i class="fa-solid fa-bug-slash mr-2"></i> âœ¨ æ™ºèƒ½ä»£ç¢¼å¯©æŸ¥
                        </button>
                    </div>
                    
                    <!-- Gemini è¼¸å‡ºå€å¡Š -->
                    <div id="geminiOutputContainer" class="hidden mt-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-indigo-300 font-bold" id="aiOutputTitle">AI å›æ‡‰:</span>
                            <button onclick="document.getElementById('geminiOutputContainer').classList.add('hidden')" class="text-xs text-gray-500 hover:text-white">
                                <i class="fa-solid fa-times"></i> é—œé–‰
                            </button>
                        </div>
                        <div id="geminiOutput" class="p-4 bg-slate-800/80 border border-indigo-500/20 rounded-lg text-sm text-gray-200 markdown-body max-h-64 overflow-y-auto"></div>
                    </div>
                </div>

                <!-- Commit Message -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-400 mb-1">Commit Message</label>
                    <input type="text" id="commitMessage" value="Update via AI GitHub Manager"
                        class="input-field w-full p-3 rounded-lg">
                </div>

                <!-- Action Buttons -->
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="performAction('upload')" id="btnUpload"
                        class="btn-gradient text-white font-bold py-3.5 rounded-xl shadow-lg flex items-center justify-center">
                        <span id="spinnerUpload" class="spinner hidden mr-2"></span>
                        <i class="fa-solid fa-cloud-upload-alt mr-2"></i> ä¸Šå‚³ / æ›´æ–°
                    </button>
                    <button onclick="performAction('delete')" id="btnDelete"
                        class="btn-danger text-white font-bold py-3.5 rounded-xl shadow-lg flex items-center justify-center">
                        <span id="spinnerDelete" class="spinner hidden mr-2"></span>
                        <i class="fa-solid fa-trash-alt mr-2"></i> åˆªé™¤æª”æ¡ˆ
                    </button>
                </div>
            </div>

            <!-- ç‹€æ…‹èˆ‡çµæœ -->
            <div id="statusArea" class="hidden p-4 rounded-xl border transition-all duration-300">
                <div class="flex items-start">
                    <i id="statusIcon" class="fa-solid fa-circle-info mt-1 mr-3"></i>
                    <div class="flex-1 overflow-hidden">
                        <h4 id="statusTitle" class="font-bold text-sm mb-1">ç‹€æ…‹æ›´æ–°</h4>
                        <p id="statusMsg" class="text-xs opacity-90 break-all"></p>
                        
                        <!-- æˆåŠŸå¾Œçš„é€£çµ -->
                        <div id="successLinks" class="hidden mt-3 pt-3 border-t border-white/20">
                            <label class="text-[10px] uppercase font-bold opacity-70">Raw URL</label>
                            <div class="flex mt-1">
                                <input type="text" id="resultUrl" readonly class="bg-black/20 border-none rounded-l text-xs w-full px-2 py-1 select-all text-white">
                                <button onclick="copyUrl()" class="bg-white/20 hover:bg-white/30 px-3 rounded-r text-xs font-bold transition">
                                    COPY
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- å…¨åŸŸå¸¸æ•¸èˆ‡è®Šæ•¸ ---
        const DEFAULT_UPLOAD_MESSAGE = "Update via AI GitHub Manager"; // é è¨­ Commit è¨Šæ¯
        
        let currentBrowserPath = ''; 
        let selectedFile = null; 
        let selectedFileBase64 = null; 

        // --- 1. Token/Key ç®¡ç†èˆ‡åˆå§‹åŒ– ---
        
        window.onload = function() {
            // è®€å– GitHub Token
            const savedToken = localStorage.getItem('github_pat_token');
            if (savedToken) {
                document.getElementById('token').value = savedToken;
                document.getElementById('saveToken').checked = true;
            }
            
            // è®€å– Gemini API Key
            const savedGeminiKey = localStorage.getItem('gemini_api_key');
            if (savedGeminiKey) {
                document.getElementById('geminiApiKey').value = savedGeminiKey;
                document.getElementById('saveGeminiKey').checked = true;
            }

            document.getElementById('commitMessage').value = DEFAULT_UPLOAD_MESSAGE;
        };
        
        function toggleTokenVisibility(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        function saveKeysIfChecked() {
            // å„²å­˜ GitHub Token
            const token = document.getElementById('token').value.trim();
            const shouldSaveToken = document.getElementById('saveToken').checked;
            if (shouldSaveToken && token) {
                localStorage.setItem('github_pat_token', token);
            } else {
                localStorage.removeItem('github_pat_token');
            }

            // å„²å­˜ Gemini API Key
            const geminiKey = document.getElementById('geminiApiKey').value.trim();
            const shouldSaveGeminiKey = document.getElementById('saveGeminiKey').checked;
            if (shouldSaveGeminiKey && geminiKey) {
                localStorage.setItem('gemini_api_key', geminiKey);
            } else {
                localStorage.removeItem('gemini_api_key');
            }
        }


        // --- 2. æª”æ¡ˆç€è¦½å™¨é‚è¼¯ (ä¿æŒä¸è®Š) ---

        async function fetchRepoContents(path = '') {
            const inputs = getInputs(false); 
            if (!inputs.token || !inputs.repo) {
                showStatus('error', 'è«‹è¼¸å…¥ GitHub Token å’Œ Repository åç¨±ä»¥è®€å–åˆ—è¡¨');
                return;
            }

            saveKeysIfChecked(); // å„²å­˜é€™æ¬¡è¼¸å…¥çš„ key/token

            const listContainer = document.getElementById('fileList');
            const pathDisplay = document.getElementById('currentPathDisplay');
            
            listContainer.innerHTML = '<div class="flex justify-center py-4"><span class="spinner"></span></div>';
            
            try {
                const url = `https://api.github.com/repos/${inputs.repo}/contents/${path}?ref=${inputs.branch}`;
                const response = await fetch(url, {
                    headers: { 
                        'Authorization': `token ${inputs.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) throw new Error(`ç„¡æ³•è®€å–: ${response.status}`);
                
                const data = await response.json();
                
                const items = Array.isArray(data) ? data.sort((a, b) => {
                    if (a.type === b.type) return a.name.localeCompare(b.name);
                    return a.type === 'dir' ? -1 : 1;
                }) : [data]; 

                currentBrowserPath = path;
                pathDisplay.textContent = path ? path : 'root/';
                renderFileList(items, path);

            } catch (error) {
                listContainer.innerHTML = `<div class="text-red-400 text-center text-sm p-2">è®€å–å¤±æ•—<br>${error.message}</div>`;
            }
        }

        function renderFileList(items, currentPath) {
            const listContainer = document.getElementById('fileList');
            listContainer.innerHTML = '';

            if (currentPath) {
                const parentPath = currentPath.split('/').slice(0, -1).join('/');
                const backItem = document.createElement('div');
                backItem.className = 'file-item p-2 rounded cursor-pointer flex items-center text-gray-400 hover:text-white';
                backItem.innerHTML = '<i class="fa-solid fa-level-up-alt w-6 text-center"></i> <span class="ml-2 text-sm">.. (ä¸Šä¸€å±¤)</span>';
                backItem.onclick = () => fetchRepoContents(parentPath);
                listContainer.appendChild(backItem);
            }

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'file-item p-2 rounded cursor-pointer flex items-center group';
                
                const iconClass = item.type === 'dir' 
                    ? 'fa-folder text-yellow-400' 
                    : getFileIcon(item.name);

                div.innerHTML = `
                    <i class="fa-solid ${iconClass} w-6 text-center group-hover:scale-110 transition"></i>
                    <span class="ml-2 text-sm truncate flex-1">${item.name}</span>
                    ${item.type === 'file' ? `<span class="text-[10px] text-gray-500">${formatSize(item.size)}</span>` : ''}
                `;

                if (item.type === 'dir') {
                    div.onclick = () => fetchRepoContents(item.path);
                } else {
                    div.onclick = () => {
                        document.getElementById('targetPath').value = item.path;
                        div.classList.add('bg-blue-600');
                        setTimeout(() => div.classList.remove('bg-blue-600'), 300);
                    };
                }
                listContainer.appendChild(div);
            });
        }

        function getFileIcon(filename) {
            if (filename.endsWith('.html')) return 'fa-html5 text-orange-500';
            if (filename.endsWith('.js')) return 'fa-js text-yellow-300';
            if (filename.endsWith('.css')) return 'fa-css3-alt text-blue-500';
            if (filename.match(/\.(jpg|jpeg|png|gif|svg)$/i)) return 'fa-image text-purple-400';
            if (filename.endsWith('.md')) return 'fa-markdown text-white';
            return 'fa-file-lines text-gray-400';
        }

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            return (bytes / 1024).toFixed(1) + ' KB';
        }


        // --- 3. æª”æ¡ˆè™•ç†èˆ‡é è¦½ (ä¿æŒä¸è®Š) ---

        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;

            selectedFile = file;
            const fileNameDisplay = document.getElementById('fileNameDisplay');
            const previewImg = document.getElementById('imagePreview');
            const previewText = document.getElementById('textPreviewIcon');
            const noPreview = document.getElementById('noPreviewText');
            const clearBtn = document.getElementById('clearFileBtn');
            const targetPath = document.getElementById('targetPath');

            fileNameDisplay.textContent = file.name;
            fileNameDisplay.classList.add('text-blue-300');
            clearBtn.classList.remove('hidden');
            noPreview.classList.add('hidden');

            const currentVal = targetPath.value;
            if (!currentVal || currentVal.endsWith('/')) {
                targetPath.value = (currentVal.endsWith('/') ? currentVal : '') + file.name;
            }

            const reader = new FileReader();
            
            if (file.type.startsWith('image/')) {
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    previewImg.classList.remove('hidden');
                    previewText.classList.add('hidden');
                    selectedFileBase64 = e.target.result.split(',')[1];
                    enableGemini(false); 
                };
                reader.readAsDataURL(file);
            } else {
                previewImg.classList.add('hidden');
                previewText.classList.remove('hidden');
                
                reader.onload = (e) => {
                    selectedFileBase64 = btoa(unescape(encodeURIComponent(e.target.result)));
                    enableGemini(true);
                };
                reader.readAsText(file);
            }
        }

        function clearFileSelection() {
            document.getElementById('fileInput').value = '';
            selectedFile = null;
            selectedFileBase64 = null;
            document.getElementById('fileNameDisplay').textContent = 'é»æ“Šæˆ–æ‹–æ›³æª”æ¡ˆè‡³æ­¤';
            document.getElementById('fileNameDisplay').classList.remove('text-blue-300');
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('textPreviewIcon').classList.add('hidden');
            document.getElementById('noPreviewText').classList.remove('hidden');
            document.getElementById('clearFileBtn').classList.add('hidden');
            document.getElementById('geminiOutputContainer').classList.add('hidden'); 
            enableGemini(false);
        }

        // --- 4. ä¸Šå‚³èˆ‡åˆªé™¤é‚è¼¯ ---

        async function performAction(action) {
            const inputs = getInputs(true);
            if (!inputs) return;
            
            saveKeysIfChecked(); // ç¢ºä¿æœ€æ–°çš„ token/key å·²å„²å­˜

            const btn = action === 'upload' ? document.getElementById('btnUpload') : document.getElementById('btnDelete');
            const spinner = action === 'upload' ? document.getElementById('spinnerUpload') : document.getElementById('spinnerDelete');
            
            if (action === 'upload' && !selectedFileBase64) {
                showStatus('error', 'è«‹å…ˆé¸æ“‡è¦ä¸Šå‚³çš„æª”æ¡ˆ');
                return;
            }

            // UI Loading State
            btn.disabled = true;
            spinner.classList.remove('hidden');
            showStatus('info', 'æ­£åœ¨è™•ç†è«‹æ±‚...');

            try {
                // 1. Check File Existence (GET SHA)
                const apiUrl = `https://api.github.com/repos/${inputs.repo}/contents/${inputs.path}?ref=${inputs.branch}`;
                const checkRes = await fetch(apiUrl, {
                    headers: { 'Authorization': `token ${inputs.token}` }
                });

                let sha = null;
                let remoteContentBase64 = null;

                if (checkRes.ok) {
                    const data = await checkRes.json();
                    sha = data.sha;
                    remoteContentBase64 = data.content; // Remote content is base64 encoded
                }

                if (action === 'upload') {
                    // è§£ç¢¼æœ¬åœ°å…§å®¹ (UTF-8)
                    const localContent = decodeURIComponent(escape(atob(selectedFileBase64)));

                    if (sha) {
                        // --- æª”æ¡ˆå­˜åœ¨ï¼Œè™•ç†æ›´æ–° ---
                        
                        // è§£ç¢¼é ç«¯å…§å®¹ (ç§»é™¤å¯èƒ½çš„æ›è¡Œç¬¦è™Ÿ)
                        const remoteContent = decodeURIComponent(escape(atob(remoteContentBase64.replace(/\n/g, ''))));
                        
                        if (remoteContent === localContent) {
                            showStatus('info', 'æª”æ¡ˆå…§å®¹æœªè®Šæ›´ï¼Œç„¡éœ€ä¸Šå‚³æ›´æ–°ã€‚');
                            btn.disabled = false;
                            spinner.classList.add('hidden');
                            return; // çµ‚æ­¢æ“ä½œ
                        }

                        // å…§å®¹ä¸åŒï¼Œæª¢æŸ¥æ˜¯å¦éœ€è¦ AI ç”Ÿæˆ Commit Message (è‡ªå‹•ä¸Šå‚³æµç¨‹)
                        if (inputs.message === DEFAULT_UPLOAD_MESSAGE && inputs.geminiApiKey) {
                            showStatus('info', 'å…§å®¹æœ‰è®Šå‹•ï¼Œæ­£åœ¨ä½¿ç”¨ AI åˆ†æå·®ç•°ä¸¦ç”Ÿæˆ Commit è¨Šæ¯...');
                            
                            try {
                                const newCommitMessage = await generateDiffCommitMessage(inputs.geminiApiKey, remoteContent, localContent, inputs.path);
                                inputs.message = newCommitMessage; // æ›´æ–° inputs ä¸­çš„ message
                                document.getElementById('commitMessage').value = newCommitMessage; // æ›´æ–° UI
                                showStatus('info', `AI å·²ç‚ºæ‚¨ç”Ÿæˆ Commit è¨Šæ¯: ${newCommitMessage}`);
                            } catch (geminiError) {
                                console.error("Gemini Diff Commit Message failed:", geminiError);
                                showStatus('warning', `AI ç”Ÿæˆ Commit è¨Šæ¯å¤±æ•— (${geminiError.message})ï¼Œä½¿ç”¨é è¨­è¨Šæ¯é€²è¡Œæ›´æ–°ã€‚`);
                            }
                        }
                    } else if (inputs.message === DEFAULT_UPLOAD_MESSAGE && inputs.geminiApiKey) {
                        // æ–°å¢æª”æ¡ˆï¼Œä¹Ÿå˜—è©¦ç”Ÿæˆ Commit Message
                        showStatus('info', 'æ–°æª”æ¡ˆä¸Šå‚³ä¸­ï¼Œæ­£åœ¨ä½¿ç”¨ AI æ‘˜è¦å…§å®¹ä¸¦ç”Ÿæˆ Commit è¨Šæ¯...');
                        try {
                            const newCommitMessage = await generateNewFileCommitMessage(inputs.geminiApiKey, localContent, inputs.path);
                            inputs.message = newCommitMessage; // æ›´æ–° inputs ä¸­çš„ message
                            document.getElementById('commitMessage').value = newCommitMessage; // æ›´æ–° UI
                            showStatus('info', `AI å·²ç‚ºæ‚¨ç”Ÿæˆ Commit è¨Šæ¯: ${newCommitMessage}`);
                        } catch (geminiError) {
                            console.error("Gemini New File Commit Message failed:", geminiError);
                            showStatus('warning', `AI ç”Ÿæˆ Commit è¨Šæ¯å¤±æ•— (${geminiError.message})ï¼Œä½¿ç”¨é è¨­è¨Šæ¯é€²è¡Œä¸Šå‚³ã€‚`);
                        }
                    }

                    // æº–å‚™ PUT Payload
                    let finalBase64 = selectedFileBase64;
                    // Token sanitization for HTML files
                    if (selectedFile && selectedFile.name.endsWith('.html')) {
                        let content = decodeURIComponent(escape(atob(selectedFileBase64)));
                        const tokenRegex = /(<input[^>]*value=")(ghp_[^"]*)("[^>]*>)/gi;
                        if (tokenRegex.test(content)) {
                            // é€™è£¡åªæ¸…ç©º valueï¼Œé¿å…å°‡ token ä¸Šå‚³åˆ° GitHub
                            content = content.replace(tokenRegex, '$1""$3'); 
                            finalBase64 = btoa(unescape(encodeURIComponent(content)));
                            console.log('HTML Token cleaned.');
                        }
                    }

                    var method = 'PUT';
                    var payload = {
                        message: inputs.message, 
                        branch: inputs.branch,
                        content: finalBase64
                    };
                    if (sha) payload.sha = sha;

                } else { 
                    // Action === 'delete'
                    if (!sha) throw new Error('æª”æ¡ˆä¸å­˜åœ¨ï¼Œç„¡æ³•åˆªé™¤');
                    var method = 'DELETE';
                    var payload = {
                        message: inputs.message,
                        branch: inputs.branch,
                        sha: sha
                    };
                }


                // 3. Execute
                const res = await fetch(apiUrl, {
                    method: method,
                    headers: {
                        'Authorization': `token ${inputs.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const resultData = await res.json();

                if (res.ok) {
                    const actionName = action === 'upload' ? (sha ? 'æ›´æ–°' : 'ä¸Šå‚³') : 'åˆªé™¤';
                    showStatus('success', `æª”æ¡ˆ${actionName}æˆåŠŸï¼ Commit SHA: ${resultData.commit.sha.substring(0,7)}`);
                    
                    if (action === 'upload') {
                        const rawUrl = `https://github.com/${inputs.repo}/raw/${inputs.branch}/${inputs.path}`;
                        document.getElementById('resultUrl').value = rawUrl;
                        document.getElementById('successLinks').classList.remove('hidden');
                    } else {
                        document.getElementById('successLinks').classList.add('hidden');
                        clearFileSelection();
                    }
                    
                    if (currentBrowserPath !== '') fetchRepoContents(currentBrowserPath);

                } else {
                    throw new Error(resultData.message || res.statusText);
                }

            } catch (error) {
                showStatus('error', `æ“ä½œå¤±æ•—: ${error.message}`);
            } finally {
                btn.disabled = false;
                spinner.classList.add('hidden');
            }
        }

        /**
         * è¼•é‡ç‰ˆï¼šç”¨æ–¼è‡ªå‹•ä¸Šå‚³æ™‚ï¼Œç”Ÿæˆç°¡æ½”æ¨™é¡Œ (å·²ä¿®æ”¹ç‚ºä½¿ç”¨ API Key)
         */
        async function generateDiffCommitMessage(apiKey, oldContent, newContent, filePath) {
            const systemInstruction = "You are a Git commit message generator. Output ONLY the raw commit message text. No markdown or quotation marks.";
            const MAX_CONTEXT_LENGTH = 4000;
            const diffContext = `File: ${filePath}\n\n--- OLD CONTENT ---\n${oldContent.substring(0, MAX_CONTEXT_LENGTH)}\n\n--- NEW CONTENT ---\n${newContent.substring(0, MAX_CONTEXT_LENGTH)}`;
            const userQuery = `è«‹æ ¹æ“šå…§å®¹å·®ç•°ï¼Œç”Ÿæˆä¸€å€‹ç¹é«”ä¸­æ–‡ Git Commit Message (ä¸è¶…é 30 å€‹å­—ç¬¦)ã€‚`;
            const result = await callGeminiApi(systemInstruction, userQuery, diffContext, apiKey);
            return result.replace(/^['"`]+|['"`]+$/g, '').trim();
        }
        
        async function generateNewFileCommitMessage(apiKey, newContent, filePath) {
            const systemInstruction = "You are a Git commit message generator. Output ONLY the raw commit message text. No markdown or quotation marks.";
            const MAX_CONTEXT_LENGTH = 4000;
            const context = `File: ${filePath}\n\n--- FILE CONTENT ---\n${newContent.substring(0, MAX_CONTEXT_LENGTH)}`;
            const userQuery = `é€™æ˜¯ä¸€å€‹æ–°æª”æ¡ˆã€‚è«‹æ ¹æ“šå…§å®¹ï¼Œç”Ÿæˆä¸€å€‹ç¹é«”ä¸­æ–‡ Git Commit Message (ä¸è¶…é 30 å€‹å­—ç¬¦)ï¼Œé–‹é ­ä½¿ç”¨ 'feat:' æˆ– 'add:'ã€‚`;
            const result = await callGeminiApi(systemInstruction, userQuery, context, apiKey);
            return result.replace(/^['"`]+|['"`]+$/g, '').trim();
        }


        // --- 5. Gemini æ·±åº¦æ•´åˆåŠŸèƒ½ (æ ¸å¿ƒä¿®æ”¹å€) ---

        function enableGemini(enabled) {
            const hasKey = !!document.getElementById('geminiApiKey').value.trim();
            const finalState = enabled && hasKey;

            document.getElementById('btnSummary').disabled = !finalState;
            document.getElementById('btnCommitMsg').disabled = !finalState;
            document.getElementById('btnCodeReview').disabled = !finalState;
            document.getElementById('geminiOutputContainer').classList.add('hidden');
            
            if (enabled && !hasKey) {
                showStatus('warning', 'åµæ¸¬åˆ°æª”æ¡ˆå¯åˆ†æï¼Œä½†è«‹åœ¨å·¦å´è¼¸å…¥ Gemini API Key ä»¥å•Ÿç”¨ AI åŠŸèƒ½ã€‚');
            }
        }

        async function runGeminiTask(task) {
            const file = selectedFile;
            const apiKey = document.getElementById('geminiApiKey').value.trim();
            if (!file || !apiKey) return;

            const outputContainer = document.getElementById('geminiOutputContainer');
            const outputDiv = document.getElementById('geminiOutput');
            const title = document.getElementById('aiOutputTitle');
            
            outputContainer.classList.remove('hidden');
            
            // è®€å–æœ¬åœ°æª”æ¡ˆ
            const localText = await new Promise(resolve => {
                const r = new FileReader();
                r.onload = e => resolve(e.target.result);
                r.readAsText(file);
            });

            // æº–å‚™ Prompt
            let prompt = "";
            let systemInstruction = "";
            let contextText = localText;

            try {
                if (task === 'summary') {
                    outputDiv.innerHTML = '<div class="flex items-center gap-2"><span class="spinner" style="width:16px;height:16px;"></span> <span class="text-gray-400">Gemini æ­£åœ¨åˆ†ææª”æ¡ˆçµæ§‹...</span></div>';
                    title.textContent = "ğŸ“„ æª”æ¡ˆæ‘˜è¦";
                    systemInstruction = "You are a helpful summary assistant. Respond in Traditional Chinese.";
                    prompt = "è«‹ç”¨ç¹é«”ä¸­æ–‡ï¼Œåˆ—é»ç¸½çµé€™ä»½ç¨‹å¼ç¢¼æˆ–æ–‡ä»¶çš„ä¸»è¦åŠŸèƒ½èˆ‡æ¶æ§‹ï¼Œè«‹ä½¿ç”¨ Markdown æ ¼å¼ã€‚";
                    
                } else if (task === 'commit') {
                    // --- ä¿®æ”¹ï¼šDiff Commit Message ç”Ÿæˆé‚è¼¯ ---
                    outputDiv.innerHTML = '<div class="flex items-center gap-2"><span class="spinner" style="width:16px;height:16px;"></span> <span class="text-gray-400">æ­£åœ¨æ¯”å°é ç«¯æª”æ¡ˆä¸¦ç”Ÿæˆæ‘˜è¦...</span></div>';
                    title.textContent = "ğŸ’¬ å·®ç•°æ‘˜è¦èˆ‡ Commit å»ºè­°";
                    
                    const inputs = getInputs(false); 
                    let oldContent = "";
                    let isNewFile = true;

                    if (inputs && inputs.token && inputs.repo && inputs.path) {
                        try {
                            const apiUrl = `https://api.github.com/repos/${inputs.repo}/contents/${inputs.path}?ref=${inputs.branch}`;
                            const res = await fetch(apiUrl, { headers: { 'Authorization': `token ${inputs.token}` } });
                            if (res.ok) {
                                const data = await res.json();
                                oldContent = decodeURIComponent(escape(atob(data.content.replace(/\n/g, ''))));
                                isNewFile = false;
                            }
                        } catch (e) {
                            console.log("Remote file fetch failed (likely new file):", e);
                        }
                    }

                    // 2. æ§‹å»º Diff Prompt
                    systemInstruction = "You are a professional Git assistant. Analyze code differences. Respond in Traditional Chinese.";
                    
                    const diffHeader = isNewFile ? "é€™æ˜¯ä¸€å€‹æ–°æª”æ¡ˆï¼Œè«‹æ ¹æ“šæ–°å…§å®¹ç¸½çµå…¶ä½œç”¨ã€‚" : "é€™æ˜¯ç¾æœ‰æª”æ¡ˆçš„ä¿®æ”¹ï¼Œè«‹åˆ†æ 'OLD_CONTENT' èˆ‡ 'NEW_CONTENT' çš„å·®ç•°ã€‚";
                    prompt = `${diffHeader}
                    
                    è«‹åŸ·è¡Œä»¥ä¸‹å…©å€‹ä»»å‹™ï¼š
                    1. **ç”Ÿæˆ Commit Message**: çµ¦å‡ºä¸€å€‹ç°¡æ½”çš„æ¨™é¡Œ (50å­—å…§)ï¼Œèƒ½æ¦‚æ‹¬é€™æ¬¡ä¿®æ”¹çš„æ ¸å¿ƒæ„åœ–ã€‚
                    2. **æ¢åˆ—å¼æ‘˜è¦**: è©³ç´°åˆ—å‡ºå…·é«”è®Šæ›´é» (Bulleted List)ï¼Œæ–¹ä¾¿ä½¿ç”¨è€…è¤‡è£½è²¼ä¸Šä½œç‚ºè©³ç´°æè¿°ã€‚

                    è¼¸å‡ºæ ¼å¼è«‹åš´æ ¼éµå®ˆï¼š
                    ---COMMIT_MSG_START---
                    (é€™è£¡å¡«å¯« Commit Message)
                    ---COMMIT_MSG_END---

                    (é€™è£¡å¡«å¯«æ¢åˆ—å¼æ‘˜è¦èˆ‡èªªæ˜ Markdown)
                    `;
                    
                    // çµ„åˆ Context
                    const MAX_LEN = 15000;
                    contextText = `File Path: ${inputs ? inputs.path : file.name}\n\n--- OLD_CONTENT ---\n${oldContent.substring(0, MAX_LEN)}\n\n--- NEW_CONTENT ---\n${localText.substring(0, MAX_LEN)}`;
                
                } else if (task === 'review') {
                    outputDiv.innerHTML = '<div class="flex items-center gap-2"><span class="spinner" style="width:16px;height:16px;"></span> <span class="text-gray-400">æ­£åœ¨é€²è¡Œä»£ç¢¼å¯©æŸ¥...</span></div>';
                    title.textContent = "âœ¨ æ™ºèƒ½ä»£ç¢¼å¯©æŸ¥";
                    systemInstruction = "You are a senior software engineer conducting a code review. Be constructive, strict but polite. Respond in Traditional Chinese using Markdown.";
                    prompt = `è«‹å°ä»¥ä¸‹ä»£ç¢¼é€²è¡Œ Code Reviewã€‚è«‹åŒ…å«ï¼š
1. **æ•´é«”è©•åˆ†** (0-10 åˆ†)
2. **æ½›åœ¨ Bug èˆ‡å®‰å…¨æ€§é¢¨éšª** (å¦‚æœæœ‰çš„è©±)
3. **å„ªåŒ–å»ºè­°** (æ•ˆèƒ½ã€å¯è®€æ€§)
4. **é‡æ§‹ç¯„ä¾‹** (é‡å°é—œéµéƒ¨åˆ†æä¾›æ›´å¥½çš„å¯«æ³•)
Code to review:`; 
                }

                // å‘¼å« API
                const result = await callGeminiApi(systemInstruction, prompt, contextText, apiKey);
                
                // è™•ç†è¼¸å‡º
                if (task === 'commit') {
                    // è§£æ Commit Message èˆ‡ æ‘˜è¦
                    const msgMatch = result.match(/---COMMIT_MSG_START---([\s\S]*?)---COMMIT_MSG_END---/);
                    let commitMsg = "Update file";
                    let explanation = result;

                    if (msgMatch) {
                        commitMsg = msgMatch[1].trim();
                        // ç§»é™¤æ¨™è¨˜ï¼Œåªç•™ä¸‹æ‘˜è¦éƒ¨åˆ†
                        explanation = result.replace(/---COMMIT_MSG_START---[\s\S]*?---COMMIT_MSG_END---/, '').trim();
                    }

                    document.getElementById('commitMessage').value = commitMsg;
                    outputDiv.innerHTML = `
                        <div class="mb-3 p-2 bg-green-900/30 border border-green-500/30 rounded text-xs text-green-300">
                            <i class="fa-solid fa-check-circle mr-1"></i> å·²è‡ªå‹•å¡«å…¥æ¨™é¡Œ: <b>${commitMsg}</b>
                        </div>
                        <div class="markdown-body text-sm">${marked.parse(explanation)}</div>
                        <div class="mt-2 text-center text-xs text-gray-500">â†‘ æ‚¨å¯ä»¥é¸å–ä¸¦è¤‡è£½ä¸Šæ–¹çš„æ‘˜è¦ä½œç‚ºè©³ç´°æè¿°</div>
                    `;
                } else {
                    outputDiv.innerHTML = marked.parse(result);
                }

            } catch (error) {
                outputDiv.innerHTML = `<span class="text-red-400">AI è«‹æ±‚å¤±æ•—: ${error.message}</span>`;
            }
        }

        async function callGeminiApi(systemPrompt, userQuery, contextText = "", apiKey) {
            if (!apiKey) {
                throw new Error("Gemini API Key is missing.");
            }
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            // å¢åŠ  Context é•·åº¦é™åˆ¶
            const finalPrompt = contextText ? `${userQuery}\n\nContent:\n${contextText.substring(0, 30000)}` : userQuery; 
            
            const payload = {
                contents: [{ parts: [{ text: finalPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            // Implement retry logic
            const maxRetries = 3;
            let attempt = 0;
            
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        if (response.status === 429) { // Too Many Requests
                            throw new Error("Rate limit exceeded");
                        }
                        // å˜—è©¦è§£æéŒ¯èª¤è¨Šæ¯
                        const errorData = await response.json();
                        const errorMessage = errorData.error?.message || `API Error: ${response.status}`;
                        throw new Error(errorMessage);
                    }

                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response generated.";
                } catch (e) {
                    attempt++;
                    console.warn(`Attempt ${attempt} failed: ${e.message}`);
                    if (attempt >= maxRetries) throw e;
                    await new Promise(r => setTimeout(r, 1000 * attempt)); // Exponential backoffish
                }
            }
        }

        // --- Helpers ---

        function getInputs(validateAll = true) {
            const token = document.getElementById('token').value.trim();
            const geminiApiKey = document.getElementById('geminiApiKey').value.trim();
            const repo = document.getElementById('repo').value.trim();
            const branch = document.getElementById('branch').value.trim();
            const path = document.getElementById('targetPath').value.trim();
            const message = document.getElementById('commitMessage').value.trim();

            if (validateAll && (!token || !repo || !branch || !path || !message)) {
                showStatus('error', 'è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½ (Token, Repo, Branch, Path, Message)');
                return null;
            }
            // Return object even if validation skipped, but check basic connectivity fields
            return { token, geminiApiKey, repo, branch, path, message };
        }

        function showStatus(type, msg) {
            const el = document.getElementById('statusArea');
            const title = document.getElementById('statusTitle');
            const body = document.getElementById('statusMsg');
            const icon = document.getElementById('statusIcon');

            el.classList.remove('hidden', 'bg-red-900/50', 'bg-green-900/50', 'bg-blue-900/50', 'border-red-500', 'border-green-500', 'border-blue-500');
            icon.className = 'mt-1 mr-3 fa-solid';

            if (type === 'error') {
                el.classList.add('bg-red-900/50', 'border-red-500', 'text-red-200');
                icon.classList.add('fa-circle-xmark');
                title.textContent = 'ç™¼ç”ŸéŒ¯èª¤';
            } else if (type === 'success') {
                el.classList.add('bg-green-900/50', 'border-green-500', 'text-green-200');
                icon.classList.add('fa-circle-check');
                title.textContent = 'æ“ä½œæˆåŠŸ';
                document.getElementById('successLinks').classList.remove('hidden');
            } else if (type === 'info' || type === 'warning') {
                el.classList.add('bg-blue-900/50', 'border-blue-500', 'text-blue-200');
                icon.classList.add('fa-spinner', 'fa-spin');
                title.textContent = 'è™•ç†ä¸­';
                document.getElementById('successLinks').classList.add('hidden');
                if (type === 'warning') {
                    icon.classList.replace('fa-spinner', 'fa-triangle-exclamation');
                    icon.classList.remove('fa-spin');
                    title.textContent = 'è­¦å‘Š';
                } else if (type === 'info') {
                    title.textContent = 'è™•ç†ä¸­';
                }
            }
            body.textContent = msg;
            el.classList.remove('hidden');
        }

        function copyUrl() {
            const input = document.getElementById('resultUrl');
            input.select();
            document.execCommand('copy');
            const btn = input.nextElementSibling;
            const originalText = btn.textContent;
            btn.textContent = 'OK!';
            setTimeout(() => btn.textContent = originalText, 1500);
        }
    </script>
</body>
</html>