<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±èªæ­é…è©åˆ†æå™¨ (AI é©…å‹•)</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«” */
        body {
            font-family: "Inter", sans-serif;
        }
        /* è‡ªè¨‚åˆ†æçµæœçš„å‹•ç•« */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .result-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        /* ç¢ºä¿åˆ—è¡¨çš„é¡¯ç¤ºæ•ˆæœ */
        .list-disc li {
            margin-bottom: 0.25rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg w-full max-w-3xl">
        
        <header class="text-center mb-6">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">è‹±èªæ­é…è©åˆ†æå™¨</h1>
            <p class="text-gray-600 mt-2">æ¯”è¼ƒå…©å€‹è©çµ„ï¼Œåˆ†æå…¶ç”¨æ³•è¦æ¨¡èˆ‡ä¾†æºå¯é æ€§ã€‚</p>
            <p class="text-sm text-blue-600 mt-2 font-medium">(ç”± AI é©…å‹•çš„çœŸå¯¦åˆ†æå·¥å…·)</p>
        </header>

        <!-- è¼¸å…¥å€åŸŸ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
                <label for="phrase1" class="block text-sm font-medium text-gray-700 mb-1">è©çµ„ 1 (ä¾‹å¦‚: make a decision)</label>
                <input type="text" id="phrase1" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label for="phrase2" class="block text-sm font-medium text-gray-700 mb-1">è©çµ„ 2 (ä¾‹å¦‚: take a decision)</label>
                <input type="text" id="phrase2" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
        </div>

        <!-- æŒ‰éˆ• -->
        <div class="text-center mb-6">
            <button id="analyzeButton" class="w-full md:w-auto bg-blue-600 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 disabled:bg-gray-400">
                <span id="button-text">é–‹å§‹åˆ†æ</span>
                <span id="button-loading" class="hidden">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 inline-block text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    åˆ†æä¸­...
                </span>
            </button>
        </div>

        <!-- çµæœé¡¯ç¤ºå€åŸŸ -->
        <div id="results-container" class="space-y-6">
            <!-- éŒ¯èª¤è¨Šæ¯æç¤º (ç”¨æ–¼çœŸæ­£éŒ¯èª¤) -->
            <div id="error-message" class="hidden text-center text-red-600 bg-red-100 p-4 rounded-lg"></div>
            <!-- ç‹€æ…‹/IELTS æç¤º (ç”¨æ–¼é€šçŸ¥) -->
            <div id="status-message" class="hidden text-center p-4 rounded-lg font-medium"></div>
            
            <!-- ç¯„ä¾‹æç¤º -->
            <div id="sample-prompt" class="text-center text-gray-500 p-4 bg-gray-50 rounded-lg">
                <h4 class="font-semibold">è©¦è©¦çœ‹è¼¸å…¥é€™äº›ç¯„ä¾‹ï¼š</h4>
                <ul class="text-sm mt-2">
                    <li>(make a decision) vs (take a decision)</li>
                    <li>(strong coffee) vs (powerful coffee)</li>
                    <li>(commit a crime) vs (do a crime)</li>
                </ul>
            </div>

            <!-- åˆ†æçµæœå°‡å‹•æ…‹æ’å…¥æ­¤è™• -->
        </div>

    </div>

    <script>
        // å…¨å±€å¿«å–ï¼Œç”¨æ–¼å„²å­˜åŸå§‹ Markdown åˆ†ææ–‡æœ¬ä»¥ä¾›åŒ¯å‡º
        window.toneAnalysisCache = {}; 
        
        // --- DOM å…ƒç´  ---
        const phrase1Input = document.getElementById('phrase1');
        const phrase2Input = document.getElementById('phrase2');
        const analyzeButton = document.getElementById('analyzeButton');
        const buttonText = document.getElementById('button-text');
        const buttonLoading = document.getElementById('button-loading');
        const resultsContainer = document.getElementById('results-container');
        const errorMessage = document.getElementById('error-message');
        const statusMessage = document.getElementById('status-message'); // æ–°å¢ç‹€æ…‹æç¤º
        const samplePrompt = document.getElementById('sample-prompt');

        // --- äº‹ä»¶ç›£è½ ---
        analyzeButton.addEventListener('click', handleAnalysis);

        // --- è¼”åŠ©å‡½æ•¸: Markdown è½‰åŸºæœ¬ HTML ---
        function markdownToBasicHtml(markdownText) {
            if (!markdownText) return '';

            let html = markdownText;

            // 1. è½‰æ›ç²—é«” (**text** æˆ– __text__) ç‚º strong æ¨™ç±¤
            html = html.replace(/(\*\*|__)(.*?)\1/g, '<strong>$2</strong>');
            
            // 2. è½‰æ›æ¨™é¡Œ (# Header)
            // H4 æ¨£å¼
            html = html.replace(/^##\s*(.*)$/gm, '<h4 class="font-bold text-lg text-teal-700 mt-3 mb-1">$1</h4>');
            // H3 æ¨£å¼ (æœ€ä¸»è¦æ¨™é¡Œ)
            html = html.replace(/^#\s*(.*)$/gm, '<h3 class="font-bold text-xl text-teal-800 mt-4 mb-2">$1</h3>');
            
            // 3. è™•ç†è¡¨æ ¼ (Table Conversion - NEW)
            const tableRegex = /(\|.*?\|\r?\n)((?:\|[-: ]+\|)+\r?\n)((?:\|.*?\|\r?\n?)+)/gs;
            
            html = html.replace(tableRegex, (match, headerLine, separatorLine, dataLines) => {
                let tableHtml = '<div class="overflow-x-auto my-4"><table class="min-w-full table-auto border-collapse shadow-md rounded-lg overflow-hidden">';
                
                // 3a. Process Header
                const headerCells = headerLine.trim().split('|').filter(c => c.trim() !== '');
                if (headerCells.length > 0) {
                    tableHtml += '<thead><tr class="bg-gray-200">';
                    headerCells.forEach(cell => {
                        let content = cell.trim();
                        tableHtml += `<th class="px-4 py-2 text-sm font-semibold text-gray-700 text-left border-b-2 border-gray-300">${content}</th>`;
                    });
                    tableHtml += '</tr></thead>';
                }
                
                // 3b. Process Data Rows
                tableHtml += '<tbody>';
                const dataRowsArray = dataLines.trim().split('\n').filter(r => r.trim() !== '');
                dataRowsArray.forEach(rowLine => {
                    const dataCells = rowLine.trim().split('|').filter(c => c.trim() !== '');
                    if (dataCells.length > 0) {
                        tableHtml += '<tr class="border-b border-gray-100 hover:bg-gray-50">';
                        dataCells.forEach(cell => {
                            let content = cell.trim();
                            tableHtml += `<td class="px-4 py-2 text-sm text-gray-800">${content}</td>`;
                        });
                        tableHtml += '</tr>';
                    }
                });
                tableHtml += '</tbody></table></div>';
                
                return tableHtml;
            });

            // 4. è™•ç†åˆ—è¡¨ (* Item æˆ– - Item) å’Œæ™®é€šæ®µè½
            const lines = html.split('\n');
            let inList = false;
            let newLines = [];

            for (const line of lines) {
                const trimmedLine = line.trim();
                
                // å¿½ç•¥ç©ºè¡Œ
                if (trimmedLine === '' && !inList) continue; 
                
                // æª¢æŸ¥æ˜¯å¦æ˜¯å·²è™•ç†çš„ HTML å€å¡Š (æ¨™é¡Œæˆ–è¡¨æ ¼)
                if (trimmedLine.startsWith('<h') || trimmedLine.startsWith('<div class="overflow-x-auto')) {
                    if (inList) {
                        newLines.push('</ul>');
                        inList = false;
                    }
                    newLines.push(line);
                    continue;
                }
                
                // æª¢æŸ¥æ˜¯å¦æ˜¯åˆ—è¡¨é …ç›®
                if (trimmedLine.startsWith('* ') || trimmedLine.startsWith('- ')) {
                    if (!inList) {
                        // é–‹å§‹ä¸€å€‹æ–°çš„åˆ—è¡¨
                        newLines.push('<ul class="list-disc list-inside ml-4 space-y-1">');
                        inList = true;
                    }
                    // ç§»é™¤åˆ—è¡¨ç¬¦è™Ÿä¸¦åŒ…è£æˆ li
                    const listItemText = trimmedLine.substring(2).trim();
                    newLines.push(`<li class="text-sm text-gray-700">${listItemText}</li>`);
                } else {
                    if (inList) {
                        // çµæŸåˆ—è¡¨
                        newLines.push('</ul>');
                        inList = false;
                    }
                    if (trimmedLine) {
                        // è™•ç†éåˆ—è¡¨é …ç›®ï¼ˆå³æ®µè½ï¼‰
                        if (!trimmedLine.startsWith('<')) { 
                            newLines.push(`<p class="text-sm text-gray-700">${trimmedLine}</p>`);
                        } else {
                            // å¦‚æœæ˜¯å…¶ä»– HTML æ¨™ç±¤ï¼ˆä¾‹å¦‚ï¼šè¡¨æ ¼ï¼‰ï¼Œå‰‡ç›´æ¥åŠ å…¥
                            newLines.push(line);
                        }
                    }
                }
            }
            if (inList) {
                newLines.push('</ul>');
            }

            // é‡æ–°çµ„åˆ
            return newLines.join('\n');
        }


        // --- æ ¸å¿ƒåŠŸèƒ½ ---
        async function handleAnalysis() {
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            setLoading(true);
            showError(''); // æ¸…ç©ºèˆŠçš„éŒ¯èª¤è¨Šæ¯
            showStatus(''); // æ¸…ç©ºèˆŠçš„ç‹€æ…‹è¨Šæ¯
            resultsContainer.innerHTML = ''; // æ¸…ç©ºèˆŠçš„åˆ†æçµæœ
            samplePrompt.classList.add('hidden'); // éš±è—ç¯„ä¾‹æç¤º

            const phrase1 = phrase1Input.value.trim();
            const phrase2 = phrase2Input.value.trim();

            if (!phrase1 || !phrase2) {
                showError('è«‹åŒæ™‚è¼¸å…¥å…©å€‹è©çµ„ä»¥ä¾¿æ¯”è¼ƒã€‚');
                setLoading(false);
                return;
            }

            try {
                // 1. åŸ·è¡Œä¸»è¦æ­é…è©åˆ†æ
                const analysisData = await callGeminiAPI(phrase1, phrase2);
                const { recommendation } = analysisData;

                let recommendedPhrase;

                // 2. åˆ¤æ–·å“ªå€‹è©çµ„æ˜¯ AI æ¨è–¦çš„
				
				// --- åŠ å…¥é€™ä¸‰è¡Œé€²è¡ŒåµéŒ¯ ---
				console.log('åµéŒ¯ 1: Phrase 1 åŸå§‹å€¼:', phrase1);
				console.log('åµéŒ¯ 2: Phrase 2 åŸå§‹å€¼:', phrase2);
				console.log('åµéŒ¯ 3: Recommendation åŸå§‹å…§å®¹:', recommendation);
				// ----------------------------
                const isPhrase1Better = recommendation.includes(phrase1) && !recommendation.includes(phrase2);
                const isPhrase2Better = recommendation.includes(phrase2) && !recommendation.includes(phrase1);
				
				// --- æª¢æŸ¥åˆ¤æ–·çµæœ ---
				console.log('åµéŒ¯ 4: isPhrase1Better çµæœ:', isPhrase1Better);
				console.log('åµéŒ¯ 5: isPhrase2Better çµæœ:', isPhrase2Better);
				// ----------------------
				
                if (isPhrase1Better) {
                    recommendedPhrase = phrase1;
                } else if (isPhrase2Better) {
                    recommendedPhrase = phrase2;
                } else {
                    // 3. (æ–°é‚è¼¯) å¦‚æœæ²’æœ‰å–®ä¸€æ˜ç¢ºæ¨è–¦ï¼Œå‰‡é€é IELTS æ¬Šé‡æ±ºå®š
                    showStatus('ç¸½çµå»ºè­°ä¸å¤ æ˜ç¢ºã€‚æ­£åœ¨é€é IELTS å¯«ä½œæ¨™æº–æ±ºå®šæ¨è–¦è©çµ„...', 'loading');
                    
                    // å‘¼å«æ–°çš„ AI æ±ºå®šå‡½æ•¸
                    const ieltsChoice = await determineIeltsPhrase(phrase1, phrase2);
                    recommendedPhrase = ieltsChoice;
                    
                    // é¡¯ç¤ºæœ€çµ‚ IELTS åˆ¤æ–·çµæœ
                    showStatus(`AI æ¨è–¦è©çµ„åˆ¤å®šç‚º IELTS å¯«ä½œä¸­æ›´åˆé©çš„ï¼šã€Œ${recommendedPhrase}ã€ã€‚`, 'info');
                }

                // 4. ç”¢ç”Ÿä¸¦é¡¯ç¤ºåˆ†æçµæœ
                const analysisHTML = createAnalysisHTML(analysisData, recommendedPhrase);
                resultsContainer.innerHTML = analysisHTML;

            } catch (error) {
                console.error('API å‘¼å«å¤±æ•—:', error);
                showError(`åˆ†ææ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}ã€‚è«‹ç¨å¾Œå†è©¦ã€‚`);
            } finally {
                setLoading(false);
                // å¦‚æœæ˜¯ IELTS åˆ¤æ–·æ¨¡å¼ï¼Œç¶­æŒç‹€æ…‹è¨Šæ¯é¡¯ç¤ºï¼Œå¦å‰‡æ¸…é™¤
                if (statusMessage.classList.contains('bg-blue-100')) {
                    // ä¿æŒ info ç‹€æ…‹è¨Šæ¯
                } else {
                    showStatus('');
                }
            }
        }

        function setLoading(isLoading) {
            if (isLoading) {
                analyzeButton.disabled = true;
                buttonText.classList.add('hidden');
                buttonLoading.classList.remove('hidden');
            } else {
                analyzeButton.disabled = false;
                buttonText.classList.remove('hidden');
                buttonLoading.classList.add('hidden');
            }
        }

        // --- å‘¼å« Gemini API (IELTS Phrase Determination - NEW) ---
        async function determineIeltsPhrase(phrase1, phrase2) {
            const apiKey = "AIzaSyCDd6xErsGUo9SLp6V7espooLedL1OM3Lo";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const systemPrompt = "You are an expert English language examiner, specializing in IELTS writing. You must choose ONE of the two provided phrases that is more formal, appropriate, and common for high-scoring IELTS academic writing. You must ONLY respond with the chosen phrase text, nothing else, no explanation, no quotes, no extra characters.";

            const userQuery = `Which phrase is better for IELTS Academic Writing: "${phrase1}" or "${phrase2}"?`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };
			
			// ğŸ’¡ åµéŒ¯æ­¥é©Ÿ 1: æ‰“å° PAYLOAD å…§å®¹
            console.log('--- API è«‹æ±‚ Payload åµéŒ¯ ---');
            console.log('Payload ç‰©ä»¶:', payload);
            console.log('JSON æ ¼å¼ Payload:', JSON.stringify(payload));
            console.log('----------------------------');

            const response = await fetchWithBackoff(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
			
			// ğŸ’¡ åµéŒ¯æ­¥é©Ÿ 2: æ‰“å° RESPONSE ç‹€æ…‹å’Œå…§å®¹
            console.log('--- API éŸ¿æ‡‰ Response åµéŒ¯ ---');
            console.log('Response ç‹€æ…‹ç¢¼:', response.status);
            console.log('Response ç‹€æ…‹è¨Šæ¯:', response.statusText);

            if (!response.ok) {
                throw new Error(`IELTS determination failed with status ${response.status}`);
            }

            const result = await response.json();
			
			// ğŸ’¡ åµéŒ¯æ­¥é©Ÿ 3: æ‰“å°æˆåŠŸçš„ RESPONSE å…§å®¹
        	console.log('API æˆåŠŸéŸ¿æ‡‰è³‡æ–™ (JSON):', result);
            console.log('----------------------------');
			
			
			
            const chosenPhrase = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
			
			const candidate = result.candidates?.[0];
			console.log('3. ç¬¬ä¸€å€‹ Candidate ç‰©ä»¶:', candidate);
			
			// åˆ¤æ–· content å±¬æ€§æ˜¯å¦å­˜åœ¨
			if (!candidate?.content) {
				console.error('ERROR: candidate[0] ä¸­ç¼ºå°‘ content å±¬æ€§ã€‚');
			}
			const contentParts = candidate?.content?.parts;
			console.log('4. Content Parts é™£åˆ—:', contentParts);
			
			// åˆ¤æ–· parts æ˜¯å¦å­˜åœ¨ä¸”ä¸ç‚ºç©º
			if (!Array.isArray(contentParts) || contentParts.length === 0) {
				console.error('ERROR: content.parts ä¸å­˜åœ¨æˆ–ç‚ºç©ºé™£åˆ—ã€‚');
			}

			const firstPart = contentParts?.[0];
			console.log('5. ç¬¬ä¸€å€‹ Part ç‰©ä»¶:', firstPart);
			
			const finalString = firstPart?.text;
			console.log('6. æœ€çµ‚æå–çš„ Text å…§å®¹:', finalString);
			
			// åˆ¤æ–· text å±¬æ€§æ˜¯å¦çœŸçš„å­˜åœ¨
			if (!finalString) {
				console.error('ERROR: parts[0] ä¸­ç¼ºå°‘ text å±¬æ€§ï¼Œæˆ– text ç‚ºç©ºã€‚');
			}

            if (!chosenPhrase) {
                // Fallback to the first phrase if AI fails to respond clearly
                return phrase1;
            }
            
            // ç¢ºä¿è¿”å›çš„è©çµ„èˆ‡åŸè¼¸å…¥çš„è©çµ„ä¹‹ä¸€åŒ¹é…
            if (chosenPhrase.includes(phrase1)) return phrase1;
            if (chosenPhrase.includes(phrase2)) return phrase2;
            
            // æœ€çµ‚çš„ä¿è­·æ€§å›é€€
            return phrase1;
        }

        // --- å‘¼å« Gemini API (Collocation Analysis - ä¿æŒä¸è®Š) ---
        async function callGeminiAPI(phrase1, phrase2) {
            const apiKey = "AIzaSyCDd6xErsGUo9SLp6V7espooLedL1OM3Lo"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const systemPrompt = "You are an expert English linguist and corpus analyst. Analyze the user's phrases accurately. Respond in Traditional Chinese.";
            
            const userQuery = `è«‹æ¯”è¼ƒä»¥ä¸‹å…©å€‹è‹±èªæ­é…è©ï¼š "${phrase1}" å’Œ "${phrase2}"ã€‚
è«‹é‡å°æ¯ä¸€å€‹è©çµ„ï¼Œæä¾›ï¼š
1. è¦æ¨¡åˆ†æï¼šåˆ†æå…¶å¸¸è¦‹ç”¨æ³•å’Œä½¿ç”¨é »ç‡ï¼ˆä¾‹å¦‚ï¼š'éå¸¸å¸¸è¦‹ï¼Œæ¨™æº–ç”¨æ³•'ã€'å¸¸ç”¨'ã€'ç½•è¦‹'æˆ–'éŒ¯èª¤ç”¨æ³•'ï¼‰ã€‚
2. ä¾†æºåˆ†æï¼šåˆ—å‡º 3-4 å€‹æœ€å¯èƒ½æ‰¾åˆ°æ­¤ç”¨æ³•çš„ä¾†æºé¡å‹ï¼ˆä¾‹å¦‚ï¼š"æ–°èåª’é«”"ã€"å­¸è¡“è«–æ–‡"ã€"å€‹äººéƒ¨è½æ ¼"ã€"å£èªå°è©±"ï¼‰ã€‚
æœ€å¾Œï¼Œè«‹æä¾›ä¸€å€‹ç¸½çµå»ºè­°ï¼Œèªªæ˜å“ªå€‹è©çµ„åœ¨IELTS ***Writing Task 1*** ä»¥åŠ***Writing Task 2***å¯«ä½œä¸Šä½¿ç”¨æ›´å¥½ï¼Œä»¥åŠç‚ºä»€éº¼ã€‚
æ³¨æ„: å‹™å¿…é‡å°***Writing Task 1*** ä»¥åŠ***Writing Task 2***éƒ½è¦åˆ†æ
é‡å°æ‚¨æ¨è–¦çš„è©çµ„ï¼Œè«‹é€²è¡Œä¸€å€‹ç°¡çŸ­çš„ SWOT åˆ†æï¼ˆå„ªå‹¢ã€åŠ£å‹¢ã€æ©Ÿæœƒã€å¨è„…ï¼‰ï¼Œå¾èªè¨€ä½¿ç”¨å’Œå­¸ç¿’çš„è§’åº¦å‡ºç™¼ã€‚`; 

            // JSON Schema å®šç¾© (ä¿æŒä¸è®Š)
            const schema = {
                type: "OBJECT",
                properties: {
                    phrase1_analysis: {
                        type: "OBJECT",
                        properties: {
                            phrase: { type: "STRING" },
                            scale_analysis: { type: "STRING" },
                            sources: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        name: { type: "STRING" },
                                        type: { type: "STRING" }
                                    }
                                }
                            }
                        }
                    },
                    phrase2_analysis: { /* ... structure omitted for brevity ... */
                        type: "OBJECT",
                        properties: {
                            phrase: { type: "STRING" },
                            scale_analysis: { type: "STRING" },
                            sources: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        name: { type: "STRING" },
                                        type: { type: "STRING" }
                                    }
                                }
                            }
                        }
                    },
                    recommendation: { type: "STRING" },
                    swot_analysis: { 
                        type: "OBJECT",
                        description: "åŸºæ–¼æ¨è–¦è©çµ„çš„èªè¨€ä½¿ç”¨å’Œå­¸ç¿’è§’åº¦çš„ SWOT åˆ†æã€‚",
                        properties: {
                            strengths: { type: "STRING" },
                            weaknesses: { type: "STRING" },
                            opportunities: { type: "STRING" },
                            threats: { type: "STRING" }
                        }
                    }
                }
            };

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema
                }
            };

            const response = await fetchWithBackoff(apiUrl, options={
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                console.error("API éŒ¯èª¤å…§æ–‡:", errorBody); 
                throw new Error(`API request failed with status ${response.status}: ${errorBody}`);
            }

            const result = await response.json();
            
            const candidate = result.candidates?.[0];
            if (!candidate || !candidate.content?.parts?.[0]?.text) {
                throw new Error('å¾ API æ”¶åˆ°çš„å›æ‡‰æ ¼å¼ç„¡æ•ˆã€‚');
            }

            return JSON.parse(candidate.content.parts[0].text);
        }
        
        // --- å‘¼å« Gemini API (Example Sentence Generation - ä¿æŒä¸è®Š) ---
        async function generateExamples(phrase) {
            const uniqueId = phrase.replace(/\s/g, '-');
            const buttonTextEl = document.getElementById(`gen-text-${uniqueId}`);
            const buttonLoadingEl = document.getElementById(`gen-loading-${uniqueId}`);
            const examplesContainer = document.getElementById(`examples-container-${uniqueId}`);
            const examplesList = document.getElementById(`examples-list-${uniqueId}`);

            buttonTextEl.classList.add('hidden');
            buttonLoadingEl.classList.remove('hidden');
            
            examplesList.innerHTML = '<p class="text-gray-500 italic">æ­£åœ¨ç”Ÿæˆä¾‹å¥...</p>';

            try {
                const apiKey = "AIzaSyCDd6xErsGUo9SLp6V7espooLedL1OM3Lo"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const systemPrompt = "You are a language teacher. Generate exactly 3 diverse, contextually correct English sentences using the provided phrase. Do not add any introductory or explanatory text. Respond with only the JSON array.";
                const userQuery = `Generate 3 example sentences using the phrase: "${phrase}".`;

                const schema = {
                    type: "ARRAY",
                    items: { type: "STRING" }
                };

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: schema
                    }
                };

                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Generation failed with status ${response.status}`);
                }

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!jsonText) {
                    throw new Error('No valid response received.');
                }
                
                const sentences = JSON.parse(jsonText);
                
                let html = sentences.map(s => `<p class="text-base text-gray-800 border-l-4 border-purple-400 pl-3 bg-white p-2 rounded">${s.replace(phrase, `<strong>${phrase}</strong>`)}</p>`).join('');

                examplesList.innerHTML = html;

            } catch (error) {
                console.error('ä¾‹å¥ç”Ÿæˆå¤±æ•—:', error);
                examplesList.innerHTML = `<p class="text-red-600">ç„¡æ³•ç”Ÿæˆä¾‹å¥ï¼Œè«‹æª¢æŸ¥è¼¸å…¥æˆ–ç¨å¾Œå†è©¦ã€‚</p>`;
            } finally {
                buttonTextEl.classList.remove('hidden');
                buttonLoadingEl.classList.add('hidden');
            }
        }

        // --- å‘¼å« Gemini API (Tone and Context Analysis - ä¿æŒä¸è®Š) ---
        async function checkToneAndContext(phrase) {
            const uniqueId = phrase.replace(/\s/g, '-');
            const buttonTextEl = document.getElementById(`tone-text-${uniqueId}`);
            const buttonLoadingEl = document.getElementById(`tone-loading-${uniqueId}`);
            const toneContainer = document.getElementById(`tone-container-${uniqueId}`);
            const toneContent = document.getElementById(`tone-content-${uniqueId}`);
            const exportButton = document.getElementById(`export-tone-btn-${uniqueId}`);

            buttonTextEl.classList.add('hidden');
            buttonLoadingEl.classList.remove('hidden');
            exportButton.disabled = true; // è¼‰å…¥æ™‚ç¦ç”¨åŒ¯å‡ºæŒ‰éˆ•
            toneContent.innerHTML = '<p class="text-gray-500 italic">æ­£åœ¨åˆ†æèªæ°£èˆ‡èªå¢ƒ...</p>';

            try {
                const apiKey = "AIzaSyCDd6xErsGUo9SLp6V7espooLedL1OM3Lo"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const systemPrompt = "You are an expert language usage guide. Provide a detailed, easy-to-understand analysis of the formality, tone, and specific contexts where the user's provided phrase is most appropriate. Use Markdown formatting for clarity (e.g., bold headings, lists, tables). Respond in Traditional Chinese.";
                
                const userQuery = `è«‹åˆ†ææ­é…è© "${phrase}" çš„èªæ°£ (Tone)ã€æ­£å¼ç¨‹åº¦ (Formality) å’Œé©ç”¨èªå¢ƒ (Specific Contexts)ã€‚`; 

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Tone analysis failed with status ${response.status}`);
                }

                const result = await response.json();
                const analysisText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!analysisText) {
                    throw new Error('No valid tone analysis received.');
                }
                
                // 1. å„²å­˜åŸå§‹ Markdown æ–‡æœ¬åˆ°å…¨å±€å¿«å–ä»¥ä¾›åŒ¯å‡º
                window.toneAnalysisCache[uniqueId] = analysisText;

                // 2. å°‡ Markdown è½‰æ›ç‚ºåŸºæœ¬ HTML çµæ§‹ (ç¢ºä¿è¡¨æ ¼å’Œæ¨™é¡Œè¢«æ­£ç¢ºè½‰æ›)
                const contentHtml = markdownToBasicHtml(analysisText);
                
                const formattedHtml = `<div class="p-3 bg-white rounded-lg shadow-sm space-y-2">
                    ${contentHtml}
                </div>`;

                toneContent.innerHTML = formattedHtml;
                exportButton.disabled = false; // å•Ÿç”¨åŒ¯å‡ºæŒ‰éˆ•

            } catch (error) {
                console.error('èªæ°£åˆ†æå¤±æ•—:', error);
                toneContent.innerHTML = `<p class="text-red-600">ç„¡æ³•ç”Ÿæˆèªæ°£èˆ‡èªå¢ƒåˆ†æï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>`;
            } finally {
                buttonTextEl.classList.remove('hidden');
                buttonLoadingEl.classList.add('hidden');
            }
        }
        
        // --- åŒ¯å‡º Markdown æ ¼å¼çš„åˆ†æçµæœ (ä¿æŒä¸è®Š) ---
        function exportAnalysisMarkdown(phrase) {
            const uniqueId = phrase.replace(/\s/g, '-');
            const markdownContent = window.toneAnalysisCache[uniqueId];

            if (!markdownContent) {
                showError('æ²’æœ‰å¯ä¾›åŒ¯å‡ºçš„èªæ°£èˆ‡èªå¢ƒåˆ†æå…§å®¹ã€‚è«‹å…ˆé€²è¡Œåˆ†æã€‚');
                return;
            }

            const blob = new Blob([markdownContent], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            a.href = url;
            a.download = `Collocation_Analysis_${uniqueId}.md`;
            
            document.body.appendChild(a);
            a.click();
            
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }


        // --- å¸¶æœ‰æŒ‡æ•¸é€€é¿çš„ Fetch ---
        async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (response.status === 429 && retries > 0) { // 429: Too Many Requests
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(url, options, retries - 1, delay * 2);
                }
                return response;
            } catch (error) {
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(url, options, retries - 1, delay * 2);
                }
                throw error;
            }
        }


        // --- é¡¯ç¤ºéŒ¯èª¤ (ç´…è‰²è­¦å‘Š) ---
        function showError(message) {
            if (message) {
                errorMessage.textContent = message;
                errorMessage.classList.remove('hidden');
            } else {
                errorMessage.classList.add('hidden');
            }
        }
        
        // --- é¡¯ç¤ºç‹€æ…‹ (è—è‰²é€šçŸ¥) ---
        function showStatus(message, type = 'info') {
            statusMessage.classList.add('hidden'); // å…ˆéš±è—
            statusMessage.textContent = '';

            if (message) {
                statusMessage.textContent = message;
                statusMessage.classList.remove('hidden');
                statusMessage.classList.remove('text-blue-600', 'bg-blue-100', 'text-yellow-600', 'bg-yellow-100');

                if (type === 'info') {
                    statusMessage.classList.add('text-blue-600', 'bg-blue-100');
                } else if (type === 'loading') {
                    statusMessage.classList.add('text-yellow-600', 'bg-yellow-100');
                }
            }
        }


        // --- ç”¢ç”Ÿ HTML çµæœ (å·²æ›´æ–°ç‚ºæ¥æ”¶æ˜ç¢ºçš„ recommendedPhrase) ---
        function createAnalysisHTML(data, recommendedPhrase) {
            const { phrase1_analysis, phrase2_analysis, recommendation } = data;

            let uniqueId = recommendedPhrase ? recommendedPhrase.replace(/\s/g, '-') : 'none';

            // ç”¨ä¾†é«˜äº®é¡¯ç¤ºè¦æ¨¡åˆ†æçµæœ
            const isPhrase1Better = recommendedPhrase === phrase1_analysis.phrase;
            const isPhrase2Better = recommendedPhrase === phrase2_analysis.phrase;
            
            return `
                <!-- ç¸½çµå»ºè­° & ç”Ÿæˆä¾‹å¥æŒ‰éˆ• -->
                <div class="bg-blue-50 p-4 rounded-xl shadow-inner result-fade-in border-l-4 border-blue-500">
                    <h3 class="text-xl font-semibold text-blue-800 mb-2">AI ç¸½çµå»ºè­°</h3>
                    <p class="text-gray-800 font-medium mb-4">${recommendation}</p>
                    
                    ${recommendedPhrase ? `
                    <div class="flex flex-wrap gap-3 mt-4">
                        <!-- E. ä¾‹å¥ç”ŸæˆæŒ‰éˆ• -->
                        <button id="gen-btn-${uniqueId}" onclick="generateExamples('${recommendedPhrase}')" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-full shadow-md hover:bg-purple-700 transition duration-300 flex items-center text-sm">
                            <span id="gen-text-${uniqueId}">âœ¨ ç”Ÿæˆä¾‹å¥ (for: ${recommendedPhrase})</span>
                            <span id="gen-loading-${uniqueId}" class="hidden ml-2"><svg class="animate-spin h-4 w-4 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></span>
                        </button>
                        
                        <!-- F. èªæ°£èˆ‡èªå¢ƒåˆ†ææŒ‰éˆ• -->
                        <button id="tone-btn-${uniqueId}" onclick="checkToneAndContext('${recommendedPhrase}')" class="bg-teal-600 text-white font-bold py-2 px-4 rounded-full shadow-md hover:bg-teal-700 transition duration-300 flex items-center text-sm">
                            <span id="tone-text-${uniqueId}">ğŸ—£ï¸ èªæ°£èˆ‡èªå¢ƒåˆ†æ (for: ${recommendedPhrase})</span>
                            <span id="tone-loading-${uniqueId}" class="hidden ml-2"><svg class="animate-spin h-4 w-4 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></span>
                        </button>

                        <!-- G. åŒ¯å‡º Markdown æŒ‰éˆ• -->
                        <button id="export-tone-btn-${uniqueId}" onclick="exportAnalysisMarkdown('${recommendedPhrase}')" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-full shadow-md hover:bg-gray-600 transition duration-300 flex items-center text-sm disabled:bg-gray-300" disabled>
                            <span>ğŸ“¥ åŒ¯å‡º Markdown</span>
                        </button>
                    </div>
                    ` : ''}
                </div>


                <!-- D. SWOT åˆ†æ (é‡å°å»ºè­°è©çµ„) -->
                ${data.swot_analysis ? `
                <div class="bg-indigo-50 p-4 rounded-lg shadow-inner result-fade-in" style="animation-delay: 0.15s;">
                    <h3 class="text-xl font-semibold text-indigo-800 mb-4">D. SWOT åˆ†æ (é‡å°å»ºè­°è©çµ„: ${recommendedPhrase})</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Strengths (å„ªå‹¢) -->
                        <div class="p-3 bg-white rounded-lg shadow border-l-4 border-green-500">
                            <h4 class="font-bold text-green-700 mb-1">å„ªå‹¢ (Strengths)</h4>
                            <p class="text-sm text-gray-700">${data.swot_analysis.strengths}</p>
                        </div>
                        <!-- Weaknesses (åŠ£å‹¢) -->
                        <div class="p-3 bg-white rounded-lg shadow border-l-4 border-yellow-500">
                            <h4 class="font-bold text-yellow-700 mb-1">åŠ£å‹¢ (Weaknesses)</h4>
                            <p class="text-sm text-gray-700">${data.swot_analysis.weaknesses}</p>
                        </div>
                        <!-- Opportunities (æ©Ÿæœƒ) -->
                        <div class="p-3 bg-white rounded-lg shadow border-l-4 border-blue-500">
                            <h4 class="font-bold text-blue-700 mb-1">æ©Ÿæœƒ (Opportunities)</h4>
                            <p class="text-sm text-gray-700">${data.swot_analysis.opportunities}</p>
                        </div>
                        <!-- Threats (å¨è„…) -->
                        <div class="p-3 bg-white rounded-lg shadow border-l-4 border-red-500">
                            <h4 class="font-bold text-red-700 mb-1">å¨è„… (Threats)</h4>
                            <p class="text-sm text-gray-700">${data.swot_analysis.threats}</p>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                <!-- E. ä¾‹å¥ç”Ÿæˆ (æ–°æ¨¡çµ„) -->
                <div id="examples-container-${uniqueId}" class="bg-purple-50 p-4 rounded-lg shadow-inner result-fade-in" style="animation-delay: 0.25s;">
                    <h3 class="text-xl font-semibold text-purple-800 mb-3 flex items-center">
                        <span class="mr-2">ğŸ“š E. ä¾‹å¥èˆ‡èªå¢ƒ (Contextual Examples)</span>
                    </h3>
                    <div id="examples-list-${uniqueId}" class="space-y-3">
                        <p class="text-gray-600 italic">è«‹é»æ“Šä¸Šæ–¹çš„ã€Œâœ¨ ç”Ÿæˆä¾‹å¥ã€æŒ‰éˆ•ä¾†æŸ¥çœ‹çµæœã€‚</p>
                    </div>
                </div>

                <!-- F. èªæ°£èˆ‡èªå¢ƒåˆ†æ (Tone and Context Analysis) -->
                <div id="tone-container-${uniqueId}" class="bg-teal-50 p-4 rounded-lg shadow-inner result-fade-in" style="animation-delay: 0.35s;">
                    <h3 class="text-xl font-semibold text-teal-800 mb-3 flex items-center">
                        <span class="mr-2">ğŸ—£ï¸ F. èªæ°£èˆ‡èªå¢ƒåˆ†æ (Tone & Context)</span>
                    </h3>
                    <div id="tone-content-${uniqueId}" class="space-y-2 text-sm text-gray-700">
                        <p class="text-gray-600 italic">è«‹é»æ“Šä¸Šæ–¹çš„ã€ŒğŸ—£ï¸ èªæ°£èˆ‡èªå¢ƒåˆ†æã€æŒ‰éˆ•ä¾†æŸ¥çœ‹çµæœã€‚</p>
                    </div>
                </div>


                <!-- A. è¦æ¨¡åˆ†æ (åŸæœ‰çš„éƒ¨åˆ†) -->
                <div class="bg-gray-50 p-4 rounded-lg shadow-inner result-fade-in" style="animation-delay: 0.45s;">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">A. è¦æ¨¡åˆ†æ (AI è³ªåŒ–åˆ†æ)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-1">"${phrase1_analysis.phrase}"</h4>
                            <p class="p-2 rounded ${isPhrase1Better ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-700'}">${phrase1_analysis.scale_analysis}</p>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-1">"${phrase2_analysis.phrase}"</h4>
                            <p class="p-2 rounded ${isPhrase2Better ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-700'}">${phrase2_analysis.scale_analysis}</p>
                        </div>
                    </div>
                </div>

                <!-- B. ä¾†æºåˆ†æ (åŸæœ‰çš„éƒ¨åˆ†) -->
                <div class="bg-gray-50 p-4 rounded-lg shadow-inner result-fade-in" style="animation-delay: 0.55s;">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">B. ä¾†æºåˆ†æ (AI åˆ¤æ–·)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- è©çµ„ 1 ä¾†æº -->
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">"${phrase1_analysis.phrase}" çš„å¯èƒ½ä¾†æº:</h4>
                            <ul class="list-disc list-inside space-y-1">
                                ${phrase1_analysis.sources.map(s => `
                                    <li class="text-sm text-gray-800">
                                        ${s.name} <span class="text-xs ${isPhrase1Better ? 'text-green-700 bg-green-100' : 'text-gray-700 bg-gray-100'} font-medium px-2 py-0.5 rounded-full">${s.type}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        <!-- è©çµ„ 2 ä¾†æº -->
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">"${phrase2_analysis.phrase}" çš„å¯èƒ½ä¾†æº:</h4>
                            <ul class="list-disc list-inside space-y-1">
                                ${phrase2_analysis.sources.map(s => `
                                    <li class="text-sm text-gray-800">
                                        ${s.name} <span class="text-xs ${isPhrase2Better ? 'text-green-700 bg-green-100' : 'text-gray-700 bg-gray-100'} font-medium px-2 py-0.5 rounded-full">${s.type}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>