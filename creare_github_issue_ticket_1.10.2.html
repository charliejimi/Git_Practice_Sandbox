<!DOCTYPE html>
<html lang="zh-Hant" class="dark"> <!-- é è¨­å•Ÿç”¨æš—é»‘æ¨¡å¼ --><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Task 1 - AI vs Self Assessment</title>
    
    <!-- è¼‰å…¥ Tailwind CSS CDN --><script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind è¨­å®šï¼šå¿…é ˆç·Šæ¥åœ¨ CDN è¼‰å…¥ä¹‹å¾ŒåŸ·è¡Œ --><script>
        tailwind.config = {
            darkMode: 'class', // å•Ÿç”¨ class-based æš—é»‘æ¨¡å¼
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'], // æ”¯æ´ä¸­æ–‡
                    },
                    colors: {
                        darkBg: '#1a1a2e', // æ·±è‰²èƒŒæ™¯
                        cardBg: '#2a2a4a', // å¡ç‰‡ background
                        primaryBtnStart: '#6a11cb', // æ¼¸å±¤æŒ‰éˆ•èµ·å§‹è‰²
                        primaryBtnEnd: '#2575fc',   // æ¼¸å±¤æŒ‰éˆ•çµæŸè‰²
                        accentGreen: '#34d399',     // å®Œæˆæç¤ºç¶ è‰²
                        accentYellow: '#fbbf24',    // è­¦å‘Šæç¤ºé»ƒè‰²
                        borderDark: '#4a4a6e',      // æ·±è‰²é‚Šæ¡†
                        successGreen: '#10b981',    // æˆåŠŸæç¤ºç¶ è‰²
                        errorRed: '#ef4444',        // éŒ¯èª¤æç¤ºç´…è‰²
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght{300;400;500;700}&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', 'sans-serif';
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* è‡ªè¨‚ placeholder æ¨£å¼ï¼Œä½¿å…¶åœ¨æš—é»‘æ¨¡å¼ä¸‹æ›´æ˜é¡¯ */
        textarea::placeholder, input::placeholder {
            color: #888; 
            opacity: 0.7;
        }
        .gradient-button {
            background-image: linear-gradient(to right, var(--tw-gradient-stops));
            background-size: 200% auto;
            transition: background-position 0.3s ease;
        }
        .gradient-button:hover {
            background-position: right center; 
        }

        /* éš±è—åŸç”Ÿæ—¥æœŸé¸æ“‡å™¨ç®­é ­ */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1); /* åè½‰é¡è‰²ä»¥é©æ‡‰æš—è‰²æ¨¡å¼ */
            cursor: pointer;
        }
        
        /* éš±è— Number è¼¸å…¥æ¡†çš„ä¸Šä¸‹ç®­é ­ (Spin Buttons)ï¼Œç¢ºä¿åªèƒ½æ‰“å­— */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield; /* Firefox å…¼å®¹ */
        }
    </style>
    <!-- ğŸŒŸ æ–°å¢ï¼šè¼‰å…¥ JSZip å‡½å¼åº« (ç”¨æ–¼ ZIP å£“ç¸®/è§£å£“ç¸®) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body class="bg-darkBg text-gray-100 flex flex-col items-center py-12 px-6 min-h-screen">

    <!-- é ‚éƒ¨æ¨™é¡Œèˆ‡èªªæ˜ --><div class="text-center mb-10">
        <h1 class="text-5xl md:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-blue-500 mb-4 tracking-tight">
            IELTS Task 1 è©•ä¼°èˆ‡åæ€
        </h1>
        <p class="text-lg text-gray-300">AI vs è‡ªæˆ‘è©•ä¼°æ¯”è¼ƒåˆ†æ (é€²éšæ ¼å¼åŒ–èˆ‡å…§å®¹éš±è—)</p>
    </div>

    <!-- ä¸»è¡¨å–®å®¹å™¨ --><div class="max-w-4xl w-full space-y-8">
        
        <!-- ğŸŒŸ æ–°å¢ï¼šåŒ¯å‡º/åŒ¯å…¥åŠŸèƒ½å¡ç‰‡ -->
        <div class="bg-cardBg p-6 md:p-8 rounded-xl shadow-lg border border-borderDark">
            <h2 class="text-2xl font-semibold text-green-400 mb-4">ğŸ”„ åŒ¯å‡º / åŒ¯å…¥è³‡æ–™</h2>
            <p class="text-gray-300 mb-5 text-sm md:text-base">
                æ‚¨å¯ä»¥å°‡ç›®å‰è¡¨å–®çš„æ‰€æœ‰å…§å®¹åŒ¯å‡ºç‚º Markdown æª”æ¡ˆï¼Œä»¥ä¾¿ç¨å¾ŒåŒ¯å…¥ä¸¦é‚„åŸã€‚
            </p>
            <div class="flex flex-col md:flex-row gap-4">
                <!-- åŒ¯å‡ºæŒ‰éˆ• -->
                <button type="button" id="export-markdown-button" class="gradient-button w-full px-6 py-3 text-lg font-bold rounded-xl shadow-lg
                                         text-white bg-gradient-to-r from-green-500 to-blue-500
                                         hover:from-blue-500 hover:to-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-darkBg
                                         transition duration-300 ease-in-out">
                    ğŸ“¥ åŒ¯å‡ºç‚º ZIP å£“ç¸®æª”
                </button>
                
                <!-- åŒ¯å…¥æŒ‰éˆ• (ä½¿ç”¨ label å½è£) -->
                <label for="import-markdown-input" class="gradient-button w-full px-6 py-3 text-lg font-bold rounded-xl shadow-lg
                                         text-white bg-gradient-to-r from-blue-500 to-purple-500
                                         hover:from-purple-500 hover:to-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-darkBg
                                         transition duration-300 ease-in-out text-center cursor-pointer">
                    ğŸ“¤ åŒ¯å…¥ ZIP å£“ç¸®æª”
                </label>
                <!-- éš±è—çš„å¯¦éš›æª”æ¡ˆä¸Šå‚³æ¬„ä½ -->
                <input type="file" id="import-markdown-input" class="hidden" accept=".zip"> <!-- ğŸŒŸ ä¿®æ”¹ accept å±¬æ€§ -->
            </div>
            <!-- ç‹€æ…‹è¨Šæ¯æç¤º -->
            <p id="import-status" class="text-green-400 text-sm mt-4 hidden"></p>
        </div>


        <!-- GitHub Repo è¨­å®šå¡ç‰‡ --><div class="bg-cardBg p-6 md:p-8 rounded-xl shadow-lg border border-borderDark">
            <h2 class="text-2xl font-semibold text-blue-400 mb-4">âš™ï¸ GitHub å„²å­˜åº«èˆ‡ API è¨­å®š</h2>
            <p class="text-gray-300 mb-5 text-sm md:text-base">
                è¦è‡ªå‹•å»ºç«‹ Issueï¼Œæ‚¨éœ€è¦æä¾›å…·æœ‰ `repo` æ¬Šé™çš„ Personal Access Token (PAT)ã€‚
            </p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- User Name --><div class="col-span-1">
                    <label for="github_user" class="block text-sm font-medium text-gray-400 mb-2">GitHub ä½¿ç”¨è€…åç¨±</label>
                    <input type="text" id="github_user" name="github_user" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200" placeholder="ä¾‹å¦‚ï¼šyour-username" value="charliejimi">
                </div>
                <!-- Repo Name --><div class="col-span-1">
                    <label for="github_repo" class="block text-sm font-medium text-gray-400 mb-2">GitHub å„²å­˜åº«åç¨±</label>
                    <input type="text" id="github_repo" name="github_repo" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200" placeholder="ä¾‹å¦‚ï¼šielts-writing-tracker" value="Git_Practice_Sandbox">
                </div>
                <!-- PAT Token --><div class="col-span-1">
                    <label for="github_token" class="block text-sm font-medium text-gray-400 mb-2">Personal Access Token (PAT)</label>
                    <input type="password" id="github_token" name="github_token" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" value="""">
                </div>
            </div>
            <p id="repo-error" class="text-red-400 text-sm mt-4 hidden">ğŸš¨ è«‹å‹™å¿…å¡«å¯«æ‰€æœ‰ GitHub æ¬„ä½ï¼ŒåŒ…æ‹¬ PATã€‚</p>
        </div>

        <!-- Issue è¡¨å–® --><form id="issue-form" class="space-y-8">

            <!-- 1. é¡Œç›®åç¨±/ç·¨è™Ÿ --><div class="bg-cardBg p-6 md:p-8 rounded-xl shadow-lg border border-borderDark">
                <label for="task_name" class="block text-xl font-bold text-gray-200 mb-3">1ï¸âƒ£ é¡Œç›®åç¨±/ç·¨è™Ÿ</label>
                <p class="text-sm text-gray-400 mb-4">è«‹å¡«å¯«é€™æ¬¡ç·´ç¿’çš„é¡Œç›®åç¨±ä»£è™Ÿ</p>
                <input type="text" id="task_name" name="task_name" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200" placeholder="ä¾‹å¦‚ï¼šWT1_Two_Pies">
            </div>

            <!-- 2. æ–‡ç« æª”æ¡ˆ -->
            <div class="bg-cardBg p-6 md:p-8 rounded-xl shadow-lg border border-borderDark">
                <label for="task_file" class="block text-xl font-bold text-gray-200 mb-3">ğŸ“„ æ–‡ç« æª”æ¡ˆ (Docx)</label>
                <p class="text-sm text-gray-400 mb-4">
                    è«‹å¡«å¯«æ‚¨çš„æª”æ¡ˆåç¨± (ä¾‹å¦‚ï¼š06_Process_Cyclic_Silkworms.docx)ã€‚
                    <br>
                    <strong class="text-accentYellow">é‡è¦æç¤ºï¼š</strong> 
                    Issue å»ºç«‹å¾Œï¼Œæ‚¨éœ€è¦ <strong class="underline">æ‰‹å‹•å°‡æ‚¨çš„ .doc/.docx æª”æ¡ˆ</strong> æ‹–æ›³åˆ° Issue ç•™è¨€å€æ‰èƒ½å®Œæˆä¸Šå‚³ã€‚
                </p>
                <input type="text" id="task_file" name="task_file" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200" placeholder="[æ¬¡æ•¸]_[é¡Œå‹]_[é¡Œç›®ä¸»é¡Œ].docx">
            </div>

            <!-- 2.5 æ–‡ç« å…§å®¹ (æ”¯æ´è²¼åœ–ä¸¦å‚³è¼¸è‡³ GitHub) -->
            <div class="bg-cardBg p-6 md:p-8 rounded-xl shadow-lg border border-borderDark">
                <label for="article_content" class="block text-xl font-bold text-gray-200 mb-3">ğŸ“ æ–‡ç« å…§å®¹èˆ‡åœ–è¡¨æˆªåœ–</label>
                <p class="text-sm text-gray-400 mb-2">
                    è«‹å°‡æ‚¨çš„ Task 1 å¯«ä½œå…§å®¹å’Œåœ–è¡¨æˆªåœ–è²¼æ–¼æ­¤è™•ã€‚æ‚¨å¯ä»¥ç›´æ¥ **è²¼ä¸Š (Ctrl+V)** æˆªåœ–æˆ– **æ‹–æ›³** åœ–ç‰‡æª”æ¡ˆã€‚
                </p>
                <p id="image-upload-status" class="text-sm text-accentGreen mb-4 hidden">
                    æ­£åœ¨ç­‰å¾…ä¸Šå‚³çš„åœ–ç‰‡ï¼š0 å¼µã€‚
                </p>
                <textarea id="article_content" name="article_content" rows="12" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder:text-gray-500" placeholder="è²¼ä¸Šæ‚¨çš„ Task 1 å¯«ä½œå…§å®¹å’Œåœ–è¡¨æˆªåœ–... (ä¾‹å¦‚ï¼šThe provided line graph illustrates...)"></textarea>
            </div>
            
            <!-- 2.6 é€å¥è§£æå…§å®¹ --><div class="bg-cardBg p-6 md:p-8 rounded-xl shadow-lg border border-borderDark">
                <label for="sentence_analysis" class="block text-xl font-bold text-gray-200 mb-3">ğŸ“š é€å¥è§£æå…§å®¹</label>
                <p class="text-sm text-gray-400 mb-2">
                    è«‹è²¼ä¸Šæ‚¨å° Task 1 å¯«ä½œå…§å®¹é€²è¡Œé€å¥è§£æçš„å…§å®¹ã€æˆªåœ–æˆ–è¡¨æ ¼ï¼Œä¾‹å¦‚æ¯å€‹å¥å­çš„æ–‡æ³•æˆ–è©å½™ä¿®æ­£ã€‚
                </p>
                <textarea id="sentence_analysis" name="sentence_analysis" rows="8" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder:text-gray-500" placeholder="è²¼ä¸Šé€å¥è§£æå…§å®¹... (ä¾‹å¦‚ï¼š[å¥å­ 1] - ä¿®æ­£å»ºè­° / [å¥å­ 2] - å‚™è¨»)"></textarea>
            </div>


            <!-- 3. å¯«ä½œæ—¥æœŸ --><div class="bg-cardBg p-6 md:p-8 rounded-xl shadow-lg border border-borderDark">
                <label for="writing_date" class="block text-xl font-bold text-gray-200 mb-3">ğŸ“… å¯«ä½œæ—¥æœŸ</label>
                <input type="date" id="writing_date" name="writing_date" class="w-full md:w-1/2 px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 text-gray-200">
            </div>

            <!-- 4. é¡Œå‹ --><div class="bg-cardBg p-6 md:p-8 rounded-xl shadow-lg border border-borderDark">
                <label for="question_type" class="block text-xl font-bold text-gray-200 mb-3">ğŸ“Š é¡Œå‹</label>
                <p class="text-sm text-gray-400 mb-4">è«‹é¸æ“‡é€™æ¬¡å¯«ä½œçš„åœ–è¡¨é¡Œå‹ã€‚</p>
                <select id="question_type" name="question_type" class="w-full md:w-1/2 px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 text-gray-200">
                    <option value="" disabled selected class="bg-darkBg text-gray-500">è«‹é¸æ“‡...</option>
                    <option value="Line Graph" class="bg-darkBg">Line Graph</option>
                    <option value="Bar Chart" class="bg-darkBg">Bar Chart</option>
                    <option value="Pie Chart" class="bg-darkBg">Pie Chart</option>
                    <option value="Table" class="bg-darkBg">Table</option>
                    <option value="Map" class="bg-darkBg">Map</option>
                    <option value="Process Diagram" class="bg-darkBg">Process Diagram</option>
                    <option value="Mixed" class="bg-darkBg">Mixed</option>
                </select>
            </div>

            <!-- 5. è‡ªæˆ‘è©•ä¼°åˆ†æ•¸ (å››å€‹æ•¸å­—æ¬„ä½ + å‚™è¨»å€) --><div class="bg-cardBg p-6 md:p-8 rounded-xl shadow-lg border border-borderDark">
                <label class="block text-xl font-bold text-gray-200 mb-3">2ï¸âƒ£ è‡ªæˆ‘è©•ä¼°åˆ†æ•¸ (0-9)</label>
                <p class="text-sm text-gray-400 mb-4">è«‹å¡«å¯«ä½ å° IELTS å››å¤§æ ¸å¿ƒç¶­åº¦çš„è‡ªè©•åˆ†æ•¸ (0~9)ã€‚</p>
                
                <!-- å››å€‹æ•¸å­—è¼¸å…¥æ¬„ä½ -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <!-- TA -->
                    <div>
                        <label for="self_assessment_ta" class="block text-sm font-medium text-gray-400 mb-2">Task Achievement (TA)</label>
                        <input type="number" id="self_assessment_ta" name="self_assessment_ta" min="0" max="9" step="0.5" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 text-gray-200" placeholder="ä¾‹å¦‚ï¼š6.5">
                    </div>
                    <!-- CC -->
                    <div>
                        <label for="self_assessment_cc" class="block text-sm font-medium text-gray-400 mb-2">Coherence & Cohesion (CC)</label>
                        <input type="number" id="self_assessment_cc" name="self_assessment_cc" min="0" max="9" step="0.5" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 text-gray-200" placeholder="ä¾‹å¦‚ï¼š7.0">
                    </div>
                    <!-- LR -->
                    <div>
                        <label for="self_assessment_lr" class="block text-sm font-medium text-gray-400 mb-2">Lexical Resource (LR)</label>
                        <input type="number" id="self_assessment_lr" name="self_assessment_lr" min="0" max="9" step="0.5" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 text-gray-200" placeholder="ä¾‹å¦‚ï¼š6.0">
                    </div>
                    <!-- GRA -->
                    <div>
                        <label for="self_assessment_gra" class="block text-sm font-medium text-gray-400 mb-2">Grammatical Range & Accuracy (GRA)</label>
                        <input type="number" id="self_assessment_gra" name="self_assessment_gra" min="0" max="9" step="0.5" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 text-gray-200" placeholder="ä¾‹å¦‚ï¼š7.5">
                    </div>
                </div>

                <!-- ğŸŒŸ æ–°å¢ï¼šè‡ªè©•ç¸½è¦½æˆªåœ– -->
                <label for="self_assessment_screenshot" class="block text-sm font-medium text-gray-400 mb-2 mt-6">ğŸ“¸ è‡ªè©•ç¸½è¦½æˆªåœ– (æ”¯æ´è²¼åœ–/æ‹–æ›³)</label>
                <p class="text-xs text-gray-500 mb-2">è«‹åœ¨æ­¤è²¼ä¸Šæ‚¨å®Œæ•´çš„è‡ªè©•æˆªåœ– (ä¾‹å¦‚ï¼šåŒ…å«å››é …åˆ†æ•¸çš„ç¸½è¦½åœ–)ã€‚</p>
                <textarea id="self_assessment_screenshot" name="self_assessment_screenshot" rows="4" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder:text-gray-500" placeholder="è²¼ä¸Šæ‚¨çš„è‡ªè©•ç¸½è¦½æˆªåœ–..."></textarea>

                <!-- æ–°å¢ï¼šLR è‡ªè©•è§£æ -->
                <label for="self_assessment_lr_analysis" class="block text-sm font-medium text-gray-400 mb-2 mt-6">è©å½™è³‡æº (LR) è‡ªè©•è§£æ (æ”¯æ´è²¼åœ–/æ‹–æ›³)</label>
                <p class="text-xs text-gray-500 mb-2">è«‹è²¼ä¸Šæ‚¨å° LR åˆ†æ•¸çš„è‡ªè©•ç´°ç¯€æˆ–åœ–è¡¨ï¼Œå°‡æœƒè‡ªå‹•æ ¼å¼åŒ–ã€‚</p>
                <textarea id="self_assessment_lr_analysis" name="self_assessment_lr_analysis" rows="4" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder:text-gray-500" placeholder="ä¾‹å¦‚ï¼šè‡ªè©•å–®å­—åº«çš„ä½¿ç”¨ã€åŒç¾©è©æ›¿æ›çš„æ•¸é‡èˆ‡æº–ç¢ºæ€§ç­‰ã€‚"></textarea>

                <!-- æ–°å¢ï¼šGRA è‡ªè©•è§£æ -->
                <label for="self_assessment_gra_analysis" class="block text-sm font-medium text-gray-400 mb-2 mt-6">æ–‡æ³•ç¯„åœèˆ‡æº–ç¢ºæ€§ (GRA) è‡ªè©•è§£æ (æ”¯æ´è²¼åœ–/æ‹–æ›³)</label>
                <p class="text-xs text-gray-500 mb-2">è«‹è²¼ä¸Šæ‚¨å° GRA åˆ†æ•¸çš„è‡ªè©•ç´°ç¯€æˆ–åœ–è¡¨ï¼Œå°‡æœƒè‡ªå‹•æ ¼å¼åŒ–ã€‚</p>
                <textarea id="self_assessment_gra_analysis" name="self_assessment_gra_analysis" rows="4" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder:text-gray-500" placeholder="ä¾‹å¦‚ï¼šè‡ªè©•è¤‡é›œå¥å‹çš„ä½¿ç”¨ã€æ™‚æ…‹æˆ–ä¸»è¬‚ä¸€è‡´çš„éŒ¯èª¤æ•¸é‡ç­‰ã€‚"></textarea>
                
                
                <!-- æ–°å¢ï¼šGoogle Translate Source (TA/CC èªç¾©æª¢æŸ¥ - ä¸­æ–‡æºæ–‡) -->
                <label for="google_translate_source" class="block text-sm font-medium text-gray-400 mb-2 mt-6 text-yellow-300">ğŸ’¡ Google èªç¾©æª¢æŸ¥ (1/3): ä¸­æ–‡æºæ–‡ï¼ˆTA/CC æ„åœ–ï¼‰</label>
                <p class="text-xs text-gray-500 mb-2">è«‹è¼¸å…¥æ‚¨çš„åŸå§‹æ„åœ– (ä¸­æ–‡)ï¼Œç”¨æ–¼æ¯”å° AI è©•åˆ†å’Œæ‚¨çš„å¯¦éš›è¡¨é”ã€‚</p>
                <textarea id="google_translate_source" name="google_translate_source" rows="4" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder:text-gray-500" placeholder="ä¾‹å¦‚ï¼šé€™å¼µåœ–è¡¨é¡¯ç¤ºäº† A åœ‹åœ¨ 2000 å¹´åˆ° 2020 å¹´ä¹‹é–“èƒ½æºæ¶ˆè€—çš„é¡¯è‘—å¢é•·ã€‚"></textarea>

                <!-- æ–°å¢ï¼šGoogle Translate Output (TA/CC èªç¾©æª¢æŸ¥ - ç¿»è­¯çµæœ) -->
                <label for="google_translate_output" class="block text-sm font-medium text-gray-400 mb-2 mt-6 text-yellow-300">ğŸ’¡ Google èªç¾©æª¢æŸ¥ (2/3): ç¿»è­¯çµæœï¼ˆåå‘é©—è­‰ï¼‰</label>
                <p class="text-xs text-gray-500 mb-2">è«‹å°‡ Google ç¿»è­¯çµæœè²¼æ–¼æ­¤è™•ï¼ˆå¦‚ï¼šæ‚¨å°‡ä¸­æ–‡æºæ–‡ç¿»è­¯æˆè‹±æ–‡çš„çµæœï¼Œæˆ–å°‡æ‚¨çš„è‹±æ–‡å¯«ä½œåè­¯å›ä¸­æ–‡çš„çµæœï¼‰ã€‚</p>
                <textarea id="google_translate_output" name="google_translate_output" rows="4" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder:text-gray-500" placeholder="ä¾‹å¦‚ï¼šThis chart shows a significant increase in energy consumption in country A between 2000 and 2020."></textarea>

                <!-- æ–°å¢ï¼šè‡ªè©•è¾¨è­˜å‡ºçš„å•é¡Œ -->
                <label for="self_identified_issues" class="block text-sm font-medium text-gray-400 mb-2 mt-6 text-red-400">ğŸš¨ è‡ªè©•è¾¨è­˜å‡ºçš„å•é¡Œ (3/3) - ä¿®æ­£ç›²é» (æ”¯æ´è²¼åœ–/æ‹–æ›³)</label>
                <p class="text-xs text-gray-500 mb-2">è«‹è¼¸å…¥æ‚¨æ¯”å°åŸæ–‡ã€ä¸­æ–‡æºæ–‡å’Œç¿»è­¯çµæœå¾Œï¼Œè‡ªå·±ç™¼ç¾çš„ TA/CC ç”¨å­—æº–ç¢ºæ€§å•é¡Œæˆ– AI æœªèƒ½è¾¨è­˜å‡ºçš„ç›²é»ã€‚**ï¼ˆå°‡è‡ªå‹•æ ¼å¼åŒ–ç‚ºåˆ—è¡¨/æ®µè½ï¼‰**</p>
                <textarea id="self_identified_issues" name="self_identified_issues" rows="4" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder:text-gray-500" placeholder="ä¾‹å¦‚ï¼šå°‡ 'é¡¯è‘—å¢é•·' å¯«æˆäº† 'å¿«é€Ÿç™¼å±•'ï¼Œå°è‡´ TA æº–ç¢ºæ€§ä¸è¶³ï¼›æˆ–é€£æ¥è©ä½¿ç”¨èˆ‡ä¸­æ–‡èªç¾©ä¸ç¬¦ã€‚"></textarea>

                <!-- ================================== -->
                <!--    â¬‡ï¸ AI å…§å®¹ç†è§£ (å·²ä¿®æ”¹) â¬‡ï¸      -->
                <!-- ================================== -->
                <label class="block text-sm font-medium text-gray-400 mb-2 mt-6 text-purple-300">ğŸ¤– AI å…§å®¹ç†è§£ (å¯¦é©—æ€§)</label>
                <p class="text-xs text-gray-500 mb-2">é»æ“ŠæŒ‰éˆ•ï¼Œè®“ AI æ ¹æ“šæ‚¨åœ¨ã€Œæ–‡ç« å…§å®¹èˆ‡åœ–è¡¨æˆªåœ–ã€æ¬„ä½ä¸­çš„*æ–‡å­—æè¿°*ä¾†ç”Ÿæˆå…§å®¹ç†è§£ (Breakdown)ã€‚</p>
                <button type="button" id="generate-chart-button" class="w-full px-4 py-2 text-sm font-medium rounded-lg bg-blue-600 hover:bg-blue-700 transition duration-200 text-white">
                    ç”Ÿæˆ AI ç†è§£
                </button>
                <div id="chart-generator-status" class="text-xs text-accentYellow mt-2"></div>
                
                <!-- AI Breakdown text will be injected here -->
                <div id="chart-display-area" class="mt-4">
                </div>
                
                <!-- NEW: Container for manual paste, hidden by default -->
                <div id="manual-chart-paste-container" class="hidden mt-4">
                    <label for="manual_chart_paste" class="block text-sm font-medium text-gray-400 mb-2 mt-6 text-green-300">ğŸ–¼ï¸ æ‰‹å‹•è²¼ä¸Šåœ–è¡¨</label>
                    <p class="text-xs text-gray-500 mb-2">AI ç†è§£å·²ç”Ÿæˆã€‚è«‹åœ¨æ­¤è™•è²¼ä¸Šæ‚¨æ‰‹å‹•è£½ä½œæˆ–ä¿®æ­£çš„åœ–è¡¨ï¼ˆæ”¯æ´è²¼åœ–/æ‹–æ›³ï¼‰ã€‚</p>
                    <textarea id="manual_chart_paste" name="manual_chart_paste" rows="4" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder:text-gray-500" placeholder="è«‹è²¼ä¸Šæ‚¨çš„åœ–è¡¨..."></textarea>
                </div>
                
                <!-- NEW: Hidden field to store AI breakdown text for submission -->
                <!-- ğŸŒŸ ç§»é™¤ï¼šåˆªé™¤é€™å€‹éš±è—æ¬„ä½ï¼Œä½¿å…¶ä¸æœƒè¢«æäº¤ -->
                <!-- <textarea id="ai_breakdown_text" name="ai_breakdown_text" class="hidden"></textarea> -->
                
                <!-- ================================== -->
                <!--    â¬†ï¸ AI å…§å®¹ç†è§£ (å·²ä¿®æ”¹) â¬†ï¸      -->
                <!-- ================================== -->

                <!-- ================================== -->
                <!-- â¬‡ï¸ æ¬„ä½å·²ä¿®æ”¹ (TA/CC æº–ç¢ºæ€§) â¬‡ï¸  -->
                <!-- ================================== -->
                <label for="custom_field_1" class="block text-sm font-medium text-gray-400 mb-2 mt-6 text-green-300">ğŸ’¡ TA/CC ç”¨å­—æº–ç¢ºæ€§ (åœ–è¡¨åå‘é©—è­‰) (æ”¯æ´è²¼åœ–/æ‹–æ›³)</label>
                <p class="text-xs text-gray-500 mb-2">è«‹è§€å¯Ÿ AI ä¾æ“šæ‚¨çš„æ–‡å­—æ‰€ç”Ÿæˆçš„ã€ŒAI ç†è§£ã€ä»¥åŠæ‚¨ã€Œæ‰‹å‹•è²¼ä¸Šçš„åœ–è¡¨ã€ï¼Œåå‘é©—è­‰æ‚¨åœ¨ TA (ä»»å‹™å®Œæˆåº¦) å’Œ CC (é€£è²«æ€§) ä¸Šçš„ç”¨å­—æ˜¯å¦ç²¾ç¢ºã€‚</p>
                <textarea id="custom_field_1" name="custom_field_1" rows="4" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder:text-gray-500" placeholder="ä¾‹å¦‚ï¼šæˆ‘æè¿° 'rapidly increased'ï¼Œä½†æ‰‹å‹•è²¼ä¸Šçš„åœ–è¡¨é¡¯ç¤ºçš„åƒ…æ˜¯ 'gradual rise'ï¼Œé€™è¡¨ç¤ºæˆ‘ TA ç”¨å­—ä¸æº–ç¢º..."></textarea>
                <!-- ================================== -->
                <!-- â¬†ï¸ æ¬„ä½å·²ä¿®æ”¹ (TA/CC æº–ç¢ºæ€§) â¬†ï¸  -->
                <!-- ================================== -->

                <!-- å‚™è¨»/å…¶ä»–è§€å¯Ÿå€å¡Š -->
                <label for="self_assessment_notes" class="block text-sm font-medium text-gray-400 mb-2 mt-6">å…¶ä»–è§€å¯Ÿ/å‚™è¨» (é€šç”¨) (æ”¯æ´è²¼åœ–/æ‹–æ›³)</label>
                <textarea id="self_assessment_notes" name="self_assessment_notes" rows="4" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder:text-gray-500" placeholder="è£œå……å…¶ä»–è§€å¯Ÿã€è‡ªè©•åŸå› æˆ–æˆªåœ–..."></textarea>
            </div>

            <!-- 6. AI è©•åˆ† (æ”¯æ´è²¼åœ–ä¸¦æ ¼å¼åŒ–) --><div class="bg-cardBg p-6 md:p-8 rounded-xl shadow-lg border border-borderDark">
                <label for="ai_assessment" class="block text-xl font-bold text-gray-200 mb-3">3ï¸âƒ£ AI è©•åˆ† (æ”¯æ´è²¼åœ–/æ‹–æ›³ & AI æ ¼å¼åŒ–)</label>
                <p class="text-sm text-gray-400 mb-4">å¡«å…¥ AI å°å››å¤§æ ¸å¿ƒç¶­åº¦çš„è©•åˆ†èˆ‡å»ºè­°è©•èªï¼Œæˆ–è²¼ä¸Š AI è©•åˆ†æˆªåœ–ã€‚å…§å®¹å°‡**è‡ªå‹•è½‰æ›ç‚ºè¡¨æ ¼**ã€‚</p>
                <textarea id="ai_assessment" name="ai_assessment" rows="6" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder:text-gray-500" placeholder="Task Response (TR): 
Coherence & Cohesion (CC): 
Lexical Resource (LR): 
Grammatical Range & Accuracy (GRA): 
AI è©•èª:"></textarea>
            </div>

            <!-- 7. å·®ç•°åˆ¤æ–· --><div class="bg-cardBg p-6 md:p-8 rounded-xl shadow-lg border border-borderDark">
                <label class="block text-xl font-bold text-gray-200 mb-3">4ï¸âƒ£ å·®ç•°åˆ¤æ–· (Difference Analysis)</label>
                <p class="text-sm text-gray-400 mb-4">å‹¾é¸æœ¬ç¯‡æ–‡ç« èˆ‡ AI è©•åˆ†çš„å·®ç•°é¡å‹ï¼Œä¸¦è£œå……åŸå› èˆ‡åˆ¤æ–·</p>
                <div id="difference_analysis" class="space-y-3 mt-2">
                    <div class="flex items-center">
                        <input id="diff_1" name="difference_analysis" type="checkbox" value="è‡ªè©•é«˜ / AI ä½ â†’ è‡ªæˆ‘ç›²é»" class="h-5 w-5 text-blue-500 bg-darkBg border-borderDark rounded focus:ring-blue-500 accent-blue-600">
                        <label for="diff_1" class="ml-3 block text-base text-gray-200">è‡ªè©•é«˜ / AI ä½ â†’ è‡ªæˆ‘ç›²é»</label>
                    </div>
                    <div class="flex items-center">
                        <input id="diff_2" name="difference_analysis" type="checkbox" value="è‡ªè©•ä½ / AI é«˜ â†’ èªçŸ¥ä¿å®ˆ" class="h-5 w-5 text-blue-500 bg-darkBg border-borderDark rounded focus:ring-2 focus:ring-blue-500 accent-blue-600">
                        <label for="diff_2" class="ml-3 block text-base text-gray-200">è‡ªè©•ä½ / AI é«˜ â†’ èªçŸ¥ä¿å®ˆ</label>
                    </div>
                    <div class="flex items-center">
                        <input id="diff_3" name="difference_analysis" type="checkbox" value="è‡ªè©• â‰ˆ AI â†’ å…±è­˜å•é¡Œ" class="h-5 w-5 text-blue-500 bg-darkBg border-borderDark rounded focus:ring-2 focus:ring-blue-500 accent-blue-600">
                        <label for="diff_3" class="ml-3 block text-base text-gray-200">è‡ªè©• â‰ˆ AI â†’ å…±è­˜å•é¡Œ</label>
                    </div>
                    <div class="flex items-center">
                        <input id="diff_4" name="difference_analysis" type="checkbox" value="åˆ†æ•¸æ¥è¿‘ä½†ç†ç”±ä¸åŒ â†’ èªçŸ¥åå·®" class="h-5 w-5 text-blue-500 bg-darkBg border-borderDark rounded focus:ring-2 focus:ring-blue-500 accent-blue-600">
                        <label for="diff_4" class="ml-3 block text-base text-gray-200">åˆ†æ•¸æ¥è¿‘ä½†ç†ç”±ä¸åŒ â†’ èªçŸ¥åå·®</label>
                    </div>
                </div>
            </div>

            <!-- 8. åæ€èˆ‡è¡Œå‹• (æ”¯æ´è²¼åœ–ä¸¦æ ¼å¼åŒ–) --><div class="bg-cardBg p-6 md:p-8 rounded-xl shadow-lg border border-borderDark">
                <label for="reflection_action" class="block text-xl font-bold text-gray-200 mb-3">5ï¸âƒ£ åæ€èˆ‡è¡Œå‹• (æ”¯æ´è²¼åœ–/æ‹–æ›³ & AI æ ¼å¼åŒ–)</label>
                <p class="text-sm text-gray-400 mb-4">é‡å°æ¯å€‹å·®ç•°é¡å‹åˆ—å‡ºå…·é«”ä¿®æ­£è¡Œå‹•ï¼Œä¸¦å¯é™„ Project æˆ–ä»»å‹™é€£çµï¼Œæˆ–è²¼ä¸Šä¿®æ­£çš„æˆªåœ–ã€‚å…§å®¹å°‡**è‡ªå‹•è½‰æ›ç‚ºè¡¨æ ¼æˆ–åˆ—è¡¨**ã€‚</p>
                <textarea id="reflection_action" name="reflection_action" rows="8" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder:text-gray-500" placeholder="ğŸ”¹ è‡ªæˆ‘ç›²é»ä¿®æ­£ (éœ€é‡å¯«æˆ–æ”¹å–„æ®µè½): 
ğŸ”¹ èªçŸ¥ä¿å®ˆæ”¶éŒ„ (å­˜å…¥æœ€ä½³ç¯„ä¾‹åº«æˆ–æ¨¡æ¿): 
ğŸ”¹ å…±è­˜å•é¡Œè¨“ç·´ (æŒ‡å®šç·´ç¿’ä»»å‹™æˆ–ç·´ç¿’é¡Œ): 
ğŸ”¹ ç†ç”±åå·®é©—è­‰ (ä½ èˆ‡ AI çµ¦å‡ºä¸åŒåŸå› ä½†çµæœç›¸ä¼¼æ™‚ï¼Œéœ€æ¯”å° AI è©•èªæˆ–é«˜åˆ†ç¯„æ–‡ï¼Œæ‰¾å‡ºçœŸæ­£åŸå› ):"></textarea>
            </div>

            <!-- ================================== -->
            <!--   â¬‡ï¸ æ–°å¢ï¼šæ ¹æœ¬åŸå›  (Issue Title) â¬‡ï¸  -->
            <!-- ================================== -->
            <div class="bg-cardBg p-6 md:p-8 rounded-xl shadow-lg border border-borderDark">
                <label for="root_cause_title" class="block text-xl font-bold text-gray-200 mb-3">ğŸ¯ æ ¹æœ¬åŸå› æ¨æ•² (GitHub Issue æ¨™é¡Œ)</label>
                <p class="text-sm text-gray-400 mb-4">
                    è«‹æ ¹æ“šä¸Šé¢è§£æ,åˆ†æå‡ºç„¡æ³•é”æ¨™çš„æ ¹æœ¬åŸå› ã€‚
                    <br>
                    <strong class="text-accentYellow">é€™å°‡æœƒç›´æ¥ä½œç‚º GitHub Issue çš„æ¨™é¡Œã€‚</strong>
                </p>
                <textarea id="root_cause_title" name="root_cause_title" rows="2" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder:text-gray-500" placeholder="ä¾‹å¦‚ï¼šTA æ¼å¤±é—œéµæ•¸æ“šé» (Data Missing) ä¸”æ™‚æ…‹ä½¿ç”¨æ··äº‚"></textarea>
            </div>
            <!-- ================================== -->
            <!--   â¬†ï¸ æ–°å¢ï¼šæ ¹æœ¬åŸå›  (Issue Title) â¬†ï¸  -->
            <!-- ================================== -->


            <!-- 9. å…¶ä»–å‚™è¨» (æ”¯æ´è²¼åœ–ä¸¦æ ¼å¼åŒ–) --><div class="bg-cardBg p-6 md:p-8 rounded-xl shadow-lg border border-borderDark">
                <label for="additional_notes" class="block text-xl font-bold text-gray-200 mb-3">6ï¸âƒ£  å¯¦éš›æ ¹æœ¬åŸå›  (æ”¯æ´è²¼åœ–/æ‹–æ›³ & AI æ ¼å¼åŒ–)</label>
                <p class="text-sm text-gray-400 mb-4">åè¦†ä¿®æ”¹æ–‡ç« , é€éåœ¨ChatGPTé©—è­‰åˆ†æ•¸æ˜¯å¦é”æ¨™,ç¢ºèªä¿®æ”¹æ–¹æ³•æœ‰æ•ˆ,æ ¹å› æ­£ç¢ºã€‚</p>
                <textarea id="additional_notes" name="additional_notes" rows="4" class="w-full px-4 py-3 bg-darkBg border border-borderDark rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 placeholder:text-gray-500" placeholder="è«‹å¡«å¯«å¯¦éš›æ ¹æœ¬åŸå› "></textarea>
            </div>

            <!-- æäº¤æŒ‰éˆ• --><div class="pt-8 text-center">
                <div id="status-message" class="mb-4 p-3 rounded-lg text-sm hidden"></div>
                <button type="submit" id="submit-button" class="gradient-button w-full md:w-2/3 lg:w-1/Two_Pies px-8 py-4 text-xl font-bold rounded-xl shadow-lg
                                         text-white bg-gradient-to-r from-primaryBtnStart to-primaryBtnEnd
                                         hover:from-blue-500 hover:to-purple-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-darkBg
                                         transition duration-300 ease-in-out">
                    âœ¨ è‡ªå‹•å»ºç«‹ GitHub Issue
                </button>
            </div>
        </form>
    </div>

    <script>
        // -----------------------------------------------------
        // ğŸŒŸ æ–°å¢ï¼šåŒ¯å‡º/åŒ¯å…¥ åŠŸèƒ½æ‰€éœ€ ID åˆ—è¡¨
        // -----------------------------------------------------
        // æ­¤åˆ—è¡¨åŒ…å«æ‰€æœ‰éœ€è¦è¢«å„²å­˜å’Œé‚„åŸçš„æ¬„ä½ ID
        const fieldsToSync = [
            'github_user', 'github_repo', 'github_token', 'task_name', 'task_file', 
            'article_content', 'sentence_analysis', 'writing_date', 'question_type',
            'self_assessment_ta', 'self_assessment_cc', 'self_assessment_lr', 'self_assessment_gra',
            'self_assessment_screenshot', 'self_assessment_lr_analysis', 'self_assessment_gra_analysis', // ğŸŒŸ æ–°å¢ self_assessment_screenshot
            'google_translate_source', 'google_translate_output', 'self_identified_issues',
            'manual_chart_paste', 'custom_field_1', 'self_assessment_notes', 'ai_assessment',
            'diff_1', 'diff_2', 'diff_3', 'diff_4', // Checkboxes
            'reflection_action', 'root_cause_title', 'additional_notes'
        ];

        // -----------------------------------------------------
        // ğŸŒŸ ä¿®æ”¹ï¼šåŒ¯å‡ºç‚º ZIP å£“ç¸®æª” (åŒ…å«åœ–ç‰‡)
        // -----------------------------------------------------
        async function exportZip() { // ğŸŒŸ Renamed and made async
            console.log('é–‹å§‹åŒ¯å‡º ZIP...');
            const statusEl = document.getElementById('import-status');
            
            // æª¢æŸ¥ JSZip æ˜¯å¦å·²è¼‰å…¥
            if (typeof JSZip === 'undefined') {
                console.error('JSZip library not loaded.');
                statusEl.textContent = 'âŒ åŒ¯å‡ºå¤±æ•—ï¼šJSZip å‡½å¼åº«è¼‰å…¥å¤±æ•—ã€‚';
                statusEl.classList.remove('hidden', 'text-green-400');
                statusEl.classList.add('text-red-400');
                return;
            }

            statusEl.textContent = 'ğŸ”„ æ­£åœ¨æ‰“åŒ…è³‡æ–™...';
            statusEl.classList.remove('hidden', 'text-red-400', 'text-green-400');
            statusEl.classList.add('text-yellow-400');

            try {
                const zip = new JSZip();
                
                // 1. ç”¢ç”Ÿä¸¦å„²å­˜ data.md (æ–‡å­—å…§å®¹)
                let markdownContent = `# IELTS Task 1 åŒ¯å‡ºè³‡æ–™\n\n`;
                fieldsToSync.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        let value;
                        if (element.type === 'checkbox') {
                            value = element.checked; // å„²å­˜ true/false
                        } else {
                            value = element.value; // å„²å­˜æ–‡å­—ã€æ•¸å­—ã€æ—¥æœŸã€ä¸‹æ‹‰é¸å–®ç­‰
                        }
                        markdownContent += `<!--FIELD:${id}-->\n`;
                        markdownContent += `${value}\n\n`;
                    }
                });
                zip.file("data.md", markdownContent);

                // 2. å„²å­˜æ‰€æœ‰ "pendingImages" (å¾…ä¸Šå‚³åœ–ç‰‡)
                const imgFolder = zip.folder("images");
                let imageCount = 0;
                for (const fieldId in pendingImages) {
                    for (const img of pendingImages[fieldId]) {
                        // img.file is the File object
                        // img.placeholder is the unique name (e.g., article_content_pasted_123.png)
                        imgFolder.file(img.placeholder, img.file); // JSZip handles File objects
                        imageCount++;
                    }
                }
                console.log(`Adding ${imageCount} images to zip.`);

                // 3. ç”¢ç”Ÿ ZIP æª”æ¡ˆ
                statusEl.textContent = `ğŸ”„ æ­£åœ¨å£“ç¸® ${imageCount} å¼µåœ–ç‰‡...`;
                const zipBlob = await zip.generateAsync({
                    type: "blob",
                    compression: "DEFLATE",
                    compressionOptions: {
                        level: 6 // 1-9 (6 is a good balance)
                    }
                });

                // 4. ç”¢ç”Ÿæª”æ¡ˆåç¨±ä¸¦è§¸ç™¼ä¸‹è¼‰
                const taskName = document.getElementById('task_name').value.trim() || 'untitled';
                const date = new Date().toISOString().split('T')[0];
                const filename = `ielts-export-${taskName}-${date}.zip`;
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(zipBlob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log('ZIP åŒ¯å‡ºå®Œæˆã€‚');
                statusEl.textContent = 'âœ… è³‡æ–™å·²æˆåŠŸåŒ¯å‡ºç‚º ZIPï¼';
                statusEl.classList.remove('hidden', 'text-red-400', 'text-yellow-400');
                statusEl.classList.add('text-green-400');

            } catch (error) {
                console.error('ZIP åŒ¯å‡ºå¤±æ•—:', error);
                statusEl.textContent = `âŒ åŒ¯å‡ºå¤±æ•—ï¼š${error.message}`;
                statusEl.classList.remove('hidden', 'text-green-400');
                statusEl.classList.add('text-red-400');
            }
        }

        // -----------------------------------------------------
        // ğŸŒŸ æ–°å¢ï¼šè¼”åŠ©å‡½å¼ - æ¸…ç©º pendingImages
        // -----------------------------------------------------
        function clearPendingImages() {
            // æ¸…ç©ºä¸»ç‰©ä»¶
            for (const key in pendingImages) {
                delete pendingImages[key];
            }
            
            // é‡æ–°åˆå§‹åŒ–æ‰€æœ‰ textarea çš„éµ
            fieldsToSync.forEach(id => {
                const element = document.getElementById(id);
                if (element && element.tagName === 'TEXTAREA') {
                    pendingImages[id] = [];
                }
            });
            updateImageStatus(); // æ›´æ–°è¨ˆæ•¸å™¨ç‚º 0
        }

        // -----------------------------------------------------
        // ğŸŒŸ ä¿®æ”¹ï¼šå¾ ZIP å£“ç¸®æª”åŒ¯å…¥ (åŒ…å«åœ–ç‰‡)
        // -----------------------------------------------------
        async function importZip(event) { // ğŸŒŸ Renamed and made async
            const file = event.target.files[0];
            if (!file) return;
            
            const statusEl = document.getElementById('import-status');
            
            // æª¢æŸ¥ JSZip æ˜¯å¦å·²è¼‰å…¥
            if (typeof JSZip === 'undefined') {
                console.error('JSZip library not loaded.');
                statusEl.textContent = 'âŒ åŒ¯å…¥å¤±æ•—ï¼šJSZip å‡½å¼åº«è¼‰å…¥å¤±æ•—ã€‚';
                statusEl.classList.remove('hidden', 'text-green-400');
                statusEl.classList.add('text-red-400');
                return;
            }

            statusEl.textContent = 'ğŸ”„ æ­£åœ¨è®€å– ZIP æª”æ¡ˆ...';
            statusEl.classList.remove('hidden', 'text-red-400', 'text-green-400');
            statusEl.classList.add('text-yellow-400');

            try {
                const zip = await JSZip.loadAsync(file);

                // 1. åŒ¯å…¥æ–‡å­—è³‡æ–™ (data.md)
                const dataFile = zip.file("data.md");
                if (!dataFile) {
                    throw new Error('ZIP æª”æ¡ˆä¸­æ‰¾ä¸åˆ° data.mdã€‚');
                }
                
                const content = await dataFile.async("string");
                const chunks = content.split('<!--FIELD:');
                if (chunks.length <= 1) {
                    throw new Error('data.md æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºã€‚');
                }

                let fieldsImported = 0;
                for (let i = 1; i < chunks.length; i++) {
                    const chunk = chunks[i];
                    const delimiterPos = chunk.indexOf('-->');
                    if (delimiterPos === -1) continue;
                    
                    const id = chunk.substring(0, delimiterPos).trim();
                    const value = chunk.substring(delimiterPos + 3).trim(); 
                    const element = document.getElementById(id);
                    
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = (value === 'true');
                        } else {
                            element.value = value;
                        }
                        fieldsImported++;
                    }
                }
                console.log(`Imported ${fieldsImported} text fields.`);

                // 2. åŒ¯å…¥åœ–ç‰‡è³‡æ–™ (images/*)
                statusEl.textContent = `ğŸ”„ æ­£åœ¨åŒ¯å…¥ ${fieldsImported} å€‹æ¬„ä½... æ¥è‘—è™•ç†åœ–ç‰‡...`;
                
                // æ¸…ç©ºä¸¦æº–å‚™ pendingImages
                clearPendingImages(); 

                const imageFiles = Object.values(zip.files).filter(file => file.name.startsWith('images/') && !file.dir);
                console.log(`Found ${imageFiles.length} images in zip.`);

                for (const zipEntry of imageFiles) {
                    const placeholderName = zipEntry.name.substring("images/".length);
                    
                    // å¾ placeholderName (e.g., 'article_content_pasted_123.png') æå– ID
                    // ä¿®æ­£ï¼šç¢ºä¿èƒ½æ­£ç¢ºè™•ç† 'article_content' é€™ç¨®åŒ…å«åº•ç·šçš„ ID
                    const idParts = placeholderName.split('_');
                    if (idParts.length < 3) continue; // æ ¼å¼ä¸ç¬¦ (e.g., textareaid_pasted_timestamp.png)
                    
                    // é‡çµ„ ID
                    const textareaId = idParts.slice(0, idParts.length - 2).join('_');
                    
                    if (document.getElementById(textareaId) && pendingImages[textareaId]) {
                        const fileBlob = await zipEntry.async("blob");
                        const file = new File([fileBlob], placeholderName, { type: fileBlob.type || 'image/png' });
                        
                        // åŠ å…¥
                        pendingImages[textareaId].push({ file: file, placeholder: placeholderName });
                    } else {
                        console.warn(`Could not find matching textarea ID "${textareaId}" for image ${placeholderName}`);
                    }
                }

                updateImageStatus(); // æ›´æ–°åœ–ç‰‡è¨ˆæ•¸å™¨
                
                statusEl.textContent = `âœ… æˆåŠŸåŒ¯å…¥ ${fieldsImported} å€‹æ¬„ä½èˆ‡ ${imageFiles.length} å¼µåœ–ç‰‡ï¼`;
                statusEl.classList.remove('hidden', 'text-red-400', 'text-yellow-400');
                statusEl.classList.add('text-green-400');

            } catch (error) {
                console.error('ZIP åŒ¯å…¥å¤±æ•—:', error);
                statusEl.textContent = `âŒ åŒ¯å…¥å¤±æ•—ï¼š${error.message}`;
                statusEl.classList.remove('hidden', 'text-green-400');
                statusEl.classList.add('text-red-400');
            } finally {
                // æ¸…ç©º file input çš„å€¼
                event.target.value = null;
            }
        }


        // å…¨åŸŸè®Šæ•¸
        const apiKey = "AIzaSyCDd6xErsGUo9SLp6V7espooLedL1OM3Lo"; // ç•™ç©ºï¼Œç³»çµ±æœƒè‡ªå‹•å¡«å…¥
        const modelName = "gemini-2.5-flash-preview-09-2025"; 
        const imageModelName = "gemini-2.5-flash-image-preview"; // ğŸŒŸ (ç”¨æ–¼ AI åœ–è¡¨ç”Ÿæˆ)
        
        // -----------------------------------------------------
        // åœ–ç‰‡è™•ç†å°ˆç”¨è®Šæ•¸ï¼šæ–°çš„çµæ§‹ï¼Œç”¨æ–¼å„²å­˜å¾…ä¸Šå‚³çš„åœ–ç‰‡ä¸¦è¿½è¹¤å…¶ä¾†æº
        // { 'textareaId': [{file, placeholder}, ...] }
        // -----------------------------------------------------
        const pendingImages = {}; 
        const imageStatusElement = document.getElementById('image-upload-status');
        
        /**
         * è™•ç†è²¼ä¸Šå’Œæ‹–æ›³äº‹ä»¶çš„æ ¸å¿ƒé‚è¼¯ï¼Œç”¨æ–¼å°‡åœ–ç‰‡å„²å­˜ç‚ºå¾…ä¸Šå‚³åˆ—è¡¨ä¸¦æ’å…¥ä½”ä½ç¬¦ã€‚
         * @param {string} textareaId - ç›®æ¨™æ–‡å­—å€åŸŸçš„ ID
         */
        function setupImageUpload(textareaId) {
            const textarea = document.getElementById(textareaId);
            
            if (!textarea) return; // ç¢ºä¿å…ƒç´ å­˜åœ¨
            
            // åˆå§‹åŒ–é™£åˆ—
            pendingImages[textareaId] = [];

            // ------------------ è²¼ä¸Šè™•ç† (Paste) ------------------
            textarea.addEventListener('paste', function(event) {
                const items = (event.clipboardData || event.originalEvent.clipboardData).items;
                let imageFound = false;

                for (let item of items) {
                    if (item.type.indexOf('image') !== -1) {
                        event.preventDefault(); 
                        const file = item.getAsFile();
                        if (file) {
                            const timestamp = Date.now();
                            const mimeType = file.type || 'image/png';
                            const extension = mimeType.split('/')[1] || 'png';
                            const placeholderName = `${textareaId}_pasted_${timestamp}.${extension}`;
                            
                            // å„²å­˜æª”æ¡ˆå’Œä½”ä½ç¬¦ï¼Œä¸¦æ¨™è¨˜ä¾†æº ID
                            pendingImages[textareaId].push({ file: file, placeholder: placeholderName });
                            
                            // åœ¨æ–‡å­—å€å¡Šä¸­æ’å…¥ Markdown ä½”ä½ç¬¦
                            const placeholderText = `\n![Uploading: ${placeholderName}]\n`;
                            const start = this.selectionStart;
                            const end = this.selectionEnd;
                            this.value = this.value.substring(0, start) + placeholderText + this.value.substring(end);
                            this.setSelectionRange(start + placeholderText.length, start + placeholderText.length);
                            
                            imageFound = true;
                        }
                    }
                }

                if (imageFound) {
                    updateImageStatus();
                }
            });

            // ------------------ æ‹–æ›³è™•ç† (Drag & Drop) ------------------
            textarea.addEventListener('dragover', function(event) {
                event.preventDefault(); 
                this.classList.add('border-blue-500', 'ring-2', 'ring-blue-500'); // è¦–è¦ºå›é¥‹
            });
            
            textarea.addEventListener('dragleave', function(event) {
                this.classList.remove('border-blue-500', 'ring-2', 'ring-blue-500');
            });

            textarea.addEventListener('drop', function(event) {
                event.preventDefault();
                this.classList.remove('border-blue-500', 'ring-2', 'ring-blue-500');
                
                let imageFound = false;
                const files = event.dataTransfer.files;

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (file.type.startsWith('image/')) {
                        const timestamp = Date.now() + i;
                        const extension = file.type.split('/')[1] || 'png';
                        const placeholderName = `${textareaId}_dragged_${timestamp}.${extension}`;
                        
                        pendingImages[textareaId].push({ file: file, placeholder: placeholderName });

                        const placeholderText = `\n![Uploading: ${placeholderName}]\n`;
                        this.value += placeholderText;
                        imageFound = true;
                    }
                }

                if (imageFound) {
                    updateImageStatus();
                }
            });
        }
        
        /**
         * çµ±è¨ˆæ‰€æœ‰æ¬„ä½ä¸­å¾…ä¸Šå‚³çš„åœ–ç‰‡ç¸½æ•¸ï¼Œä¸¦æ›´æ–°ç‹€æ…‹æç¤º
         */
        function updateImageStatus() {
            let totalImages = 0;
            for (const id in pendingImages) {
                totalImages += pendingImages[id].length;
            }
            
            if (totalImages > 0) {
                imageStatusElement.textContent = `æ­£åœ¨ç­‰å¾…ä¸Šå‚³çš„åœ–ç‰‡ï¼š${totalImages} å¼µã€‚`;
                imageStatusElement.classList.remove('hidden');
            } else {
                imageStatusElement.classList.add('hidden');
            }
        }
        
        /**
         * å°‡ Base64 æ•¸æ“šä¸Šå‚³åˆ° GitHub Repo
         * @returns {string} The raw content URL for the uploaded file.
         */
        async function uploadImageToGithub(user, repo, token, path, base64Content, message) {
            const apiUrl = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;
            const maxRetries = 5; // Allow retries for 409 conflicts
            let sha = null;

            // 1. åˆæ¬¡å˜—è©¦ GET ç¾æœ‰æª”æ¡ˆçš„ SHA
            try {
                const getResponse = await fetch(apiUrl, {
                    headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.com/v3+json' }
                });

                if (getResponse.ok) {
                    const existingFile = await getResponse.json();
                    sha = existingFile.sha;
                }
            } catch (e) {
                console.warn(`[GitHub Upload] Initial attempt to GET SHA failed for ${path}:`, e);
            }

            // 2. PUT è«‹æ±‚èˆ‡ 409 è¡çªé‡è©¦å¾ªç’°
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                console.log(`[GitHub Upload] PUT attempt ${attempt + 1} for ${path}. Current SHA: ${sha || 'new file'}`);
                
                // æº–å‚™ PUT è«‹æ±‚é«”
                const putBody = {
                    message: sha ? `Update existing image for Task 1 Issue: ${path}` : message,
                    content: base64Content, 
                    committer: {
                        name: user,
                        email: `${user}@users.noreply.github.com`
                    }
                };

                if (sha) {
                    putBody.sha = sha; // åŒ…å« SHA ä»¥æ›´æ–°ç¾æœ‰æª”æ¡ˆ
                }

                const response = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.com/v3+json'
                    },
                    body: JSON.stringify(putBody)
                });

                const result = await response.json();
                
                if (response.ok) {
                    // æˆåŠŸ
                    console.log(`[GitHub Upload] Successfully uploaded ${path} on attempt ${attempt + 1}.`);
                    return result.content.download_url;
                } 
                
                if (response.status === 409) {
                    // 409 Conflict (SHA mismatch) - éœ€è¦é‡è©¦
                    console.warn(`[GitHub Upload] Conflict (409) detected for ${path}. Retrying to get latest SHA...`);
                    
                    let reGetError = null;

                    // é‡æ–° GET æª”æ¡ˆä»¥å–å¾—æœ€æ–°çš„ SHA
                    try {
                        const getResponse = await fetch(apiUrl, {
                            headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.com/v3+json' }
                        });

                        if (getResponse.ok) { // 200 OK
                            const existingFile = await getResponse.json();
                            sha = existingFile.sha; // æ›´æ–° SHA
                            console.log(`[GitHub Upload] Successfully fetched new SHA: ${sha}. Retrying PUT...`);
                        } else if (getResponse.status === 404) {
                            // FIX: å¦‚æœé‡æ–° GET å¾—åˆ° 404 (Not Found)ï¼Œè¡¨ç¤ºæª”æ¡ˆä¸å­˜åœ¨ï¼Œæ‡‰æ¸…é™¤ SHAï¼Œä½œç‚ºæ–°æª”æ¡ˆé‡è©¦ PUT
                            sha = null; 
                            console.warn(`[GitHub Upload] File ${path} not found (404) during SHA re-GET. Retrying PUT as a new file (clearing SHA).`);
                        } else {
                            // Non-recoverable error during GET (403, 500, etc.)
                            const errResult = await getResponse.json();
                            reGetError = new Error(`GitHub é‡æ–°ç²å– SHA å¤±æ•— (${path}, Status: ${getResponse.status}): ${errResult.message || 'Unknown error during re-GET'}`);
                        }
                    } catch (e) {
                        // Catches network error
                        reGetError = new Error(`Fatal network error during re-GET for SHA: ${e.message}`);
                    }
                    
                    // å¦‚æœåœ¨é‡æ–° GET æœŸé–“ç™¼ç”ŸéŒ¯èª¤ï¼Œä¸”ä¸æ˜¯å¯å¿½ç•¥çš„ 404ï¼Œæˆ–è€…é”åˆ°é‡è©¦ä¸Šé™ä½† SHA ä»ç‚ºèˆŠå€¼ï¼Œæ‹‹å‡ºè‡´å‘½éŒ¯èª¤
                    if (reGetError) {
                        console.error(`[GitHub Upload] ${reGetError.message}`);
                        throw new Error(`GitHub åœ–ç‰‡ä¸Šå‚³å¤±æ•— (${path}, Status: 409): ç„¡æ³•ç²å–æœ€æ–°çš„ SHA é€²è¡Œé‡è©¦ã€‚
Stack: ${reGetError.message}`); 
                    }

                    // å»¶é²é‡è©¦ä»¥é¿å…ç«‹å³è¡çª
                    await new Promise(resolve => setTimeout(resolve, 500 * (attempt + 1)));
                    continue; // é€²å…¥ä¸‹ä¸€æ¬¡å¾ªç’° (é‡è©¦ PUT)
                } 
                
                // é 409 éŒ¯èª¤ï¼Œæ‹‹å‡º
                throw new Error(`GitHub åœ–ç‰‡ä¸Šå‚³å¤±æ•— (${path}, Status: ${response.status}): ${result.message || 'Unknown error'}`);
            }
            
            // é”åˆ°æœ€å¤§é‡è©¦æ¬¡æ•¸
            throw new Error(`GitHub åœ–ç‰‡ä¸Šå‚³å¤±æ•— (${path}): å·²é”æœ€å¤§é‡è©¦æ¬¡æ•¸ (${maxRetries})ã€‚`);
        }

        /**
         * åŸ·è¡Œæ‰€æœ‰åœ–ç‰‡ä¸Šå‚³ä¸¦è¿”å›ä½”ä½ç¬¦åˆ°æœ€çµ‚ Markdown é€£çµçš„æ˜ å°„ã€‚
         */
        async function uploadAllImages(user, repo, token, submitButton) {
            const uploadedMap = {}; // Maps: placeholder -> final URL
            const allImagesToUpload = [];

            // å°‡æ‰€æœ‰æ¬„ä½çš„åœ–ç‰‡æ‰å¹³åŒ–ç‚ºä¸€å€‹åˆ—è¡¨
            for (const fieldId in pendingImages) {
                pendingImages[fieldId].forEach(img => {
                    allImagesToUpload.push({ ...img, fieldId });
                });
            }
            
            if (allImagesToUpload.length === 0) {
                console.log("[GitHub Upload] No images to upload.");
                return uploadedMap;
            }

            console.log(`[GitHub Upload] Starting upload of ${allImagesToUpload.length} images...`);

            const uploadPromises = allImagesToUpload.map(async (img, index) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = async () => {
                        try {
                            const base64Content = reader.result.split(',')[1];
                            const path = `issue_images/${img.placeholder}`; 
                            const message = `Upload image for Task 1 Issue - Field: ${img.fieldId}`;
                            
                            // æ›´æ–°æŒ‰éˆ•æ–‡å­—ï¼Œè®“ç”¨æˆ¶çŸ¥é“é€²åº¦
                            submitButton.textContent = `ğŸ–¼ï¸ æ­£åœ¨ä¸Šå‚³åœ–ç‰‡ (${index + 1}/${allImagesToUpload.length})...`;

                            const rawUrl = await uploadImageToGithub(user, repo, token, path, base64Content, message);
                            uploadedMap[img.placeholder] = rawUrl;
                            resolve();
                        } catch (error) {
                            console.error(`[GitHub Upload] Image Upload Error for ${img.placeholder}:`, error);
                            // å³ä½¿ä¸Šå‚³å¤±æ•—ï¼Œä¹Ÿå°‡ä½”ä½ç¬¦æ˜ å°„åˆ°éŒ¯èª¤è¨Šæ¯ï¼Œä»¥ä¾¿åœ¨å…§å®¹ä¸­é¡¯ç¤º
                            uploadedMap[img.placeholder] = `[åœ–ç‰‡ä¸Šå‚³å¤±æ•—: ${error.message}]`; 
                            resolve(); 
                        }
                    };
                    reader.readAsDataURL(img.file);
                });
            });

            // ä½¿ç”¨ Promise.allSettled ç­‰å¾…æ‰€æœ‰ä¸Šå‚³å®Œæˆï¼Œå³ä½¿æœ‰å¤±æ•—
            await Promise.allSettled(uploadPromises);
            
            // æ¸…ç©ºæ‰€æœ‰å¾…ä¸Šå‚³åœ–ç‰‡
            for (const id in pendingImages) {
                pendingImages[id].length = 0;
            }
            updateImageStatus();

            console.log("[GitHub Upload] All image uploads completed.");
            return uploadedMap;
        }
        
        // -----------------------------------------------------
        // Gemini æ ¼å¼åŒ–åŠŸèƒ½ (DEBUG å¼·åŒ–ç‰ˆ)
        // -----------------------------------------------------

        /**
         * ä½¿ç”¨ Gemini API å°‡ç´”æ–‡å­—è½‰æ›ç‚ºæ ¼å¼åŒ–çš„ Markdown è¡¨æ ¼æˆ–æ•´æ½”æ®µè½ã€‚
         * @param {string} text - å¾…æ ¼å¼åŒ–çš„åŸå§‹æ–‡å­— (å·²æ›¿æ›åœ–ç‰‡ä½”ä½ç¬¦)
         * @param {string} context - çµ¦ AI çš„ä¸Šä¸‹æ–‡æç¤º
         * @param {boolean} preferTable - æ˜¯å¦å‚¾å‘æ–¼è½‰æ›ç‚º Key:Value è¡¨æ ¼
         */
        async function formatTextWithGemini(text, context, preferTable = true) {
            const trimmedText = text.trim();
            if (!trimmedText) {
                return 'ç„¡';
            }
            
            console.log(`\n--- [Gemini Format] Starting API Call ---`);
            console.log(`[Gemini Format] Context: '${context}'`);
            console.log(`[Gemini Format] Input text (first 100 chars):\n${trimmedText.substring(0, 100)}...`);


            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
            
            const tableInstruction = preferTable 
                ? `è«‹å„ªå…ˆå˜—è©¦ä½¿ç”¨å…©æ¬„ Markdown è¡¨æ ¼ (ä¾‹å¦‚ï¼šé …ç›® | å…§å®¹) ä¾†å‘ˆç¾ Key:Value çµæ§‹æˆ–åˆ†è¡Œé …ç›®ã€‚å¦‚æœå…§å®¹æ˜¯è‡ªç”±æ ¼å¼çš„è©•èªæˆ–å«æœ‰åœ–ç‰‡é€£çµï¼Œå‰‡å°‡å…¶è½‰æ›ç‚ºæ•´æ½”çš„ Markdown åˆ—è¡¨æˆ–æ®µè½ï¼Œä¸¦ç¢ºä¿æ›è¡Œè¢«ä¿ç•™ç‚ºæ®µè½ã€‚`
                : `è«‹å°‡å…§å®¹è½‰æ›ç‚ºæ•´æ½”çš„ Markdown æ ¼å¼ï¼Œä¾‹å¦‚åˆ—è¡¨ã€æ¨™é¡Œæˆ–æ®µè½ï¼Œä¿ç•™æ‰€æœ‰æ›è¡Œä»¥ç¢ºä¿å¯è®€æ€§ã€‚ä¸è¦ä½¿ç”¨è¡¨æ ¼ã€‚`;

            const userQuery = `è«‹å°‡ä»¥ä¸‹é—œæ–¼ IELTS Task 1 è©•ä¼°çš„ç´”æ–‡å­—å…§å®¹è½‰æ›ç‚º GitHub Issue å…¼å®¹çš„ Markdown æ ¼å¼ã€‚
                ${tableInstruction}
                
                ä¸Šä¸‹æ–‡/é æœŸç”¨é€”: ${context}
                
                åŸå§‹è¼¸å…¥:
                ---
                ${trimmedText}
                ---
                `;

            const responseSchema = {
                type: "OBJECT",
                properties: {
                    "markdown_output": { 
                        "type": "STRING",
                        "description": "The input text converted into a GitHub compatible Markdown table or clean text string, or the original text if a table is not suitable. Only include the table or text itself, no Markdown code fences."
                    }
                },
                required: ["markdown_output"]
            };

            const systemPrompt = "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ Markdown æ ¼å¼åŒ–åŠ©æ‰‹ã€‚ä½ çš„ä»»å‹™æ˜¯å°‡éçµæ§‹åŒ–æ–‡æœ¬è½‰æ›ç‚ºæ•´æ½”çš„ Markdown è¡¨æ ¼æˆ–ç´”æ–‡å­—æ ¼å¼ï¼Œä»¥æ–¹ä¾¿ GitHub é¡¯ç¤ºã€‚ä½ å¿…é ˆä»¥æŒ‡å®šçš„ JSON æ ¼å¼è¿”å›çµæœï¼Œ**ä¸è¦åŒ…å«ä»»ä½•å¤šé¤˜çš„è§£é‡‹æˆ– Markdown å€å¡Šæ¨™è¨˜**ï¼Œä¾‹å¦‚ ```json æˆ– ```ã€‚";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema,
                }
            };

            const maxRetries = 3;
            let delay = 1000;
            
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        const candidate = result.candidates?.[0];

                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            let jsonText = candidate.content.parts[0].text;
                            
                            // --- é—œéµä¿®æ­£ï¼šæ¸…ç† Markdown ç¨‹å¼ç¢¼å€å¡Šæ¨™è¨˜ ---
                            jsonText = jsonText.replace(/^```json\n?/, '').replace(/\n?```$/, '').trim(); 
                            
                            console.log("[Gemini Format] Raw JSON Text received:", jsonText.substring(0, 500) + '...'); 

                            try {
                                const parsedJson = JSON.parse(jsonText);
                                
                                if (parsedJson && typeof parsedJson.markdown_output === 'string') {
                                    const finalOutput = parsedJson.markdown_output.trim();
                                    console.log("[Gemini Format] Success. Formatted output (first 100 chars):\n", finalOutput.substring(0, 100) + '...');
                                    return finalOutput;
                                } else {
                                    console.warn("[Gemini Format] Output JSON structure missing 'markdown_output'. Falling back to original text.");
                                    return trimmedText; 
                                }
                            } catch (jsonError) {
                                console.error("[Gemini Format] è¼¸å‡º JSON è§£æå¤±æ•—:", jsonError, "åŸå§‹æ–‡å­—:", jsonText.substring(0, 500) + '...');
                                console.log("[Gemini Format] Falling back to original text due to JSON error.");
                                return trimmedText; 
                            }
                        } else {
                            console.warn("[Gemini Format] Candidate or content part missing in response.");
                        }
                    } else if ((response.status === 429 || response.status === 503) && i < maxRetries - 1) {
                        console.warn(`[Gemini Format] API Rate Limit hit (${response.status}). Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                        continue; 
                    }
                    
                    console.error(`[Gemini Format] API call failed with status: ${response.status}. Falling back to original text.`);
                    return trimmedText; 

                } catch (error) {
                    console.error("[Gemini Format] Fetch or general API error:", error);
                    if (i < maxRetries - 1) {
                         console.warn(`[Gemini Format] General error. Retrying in ${delay / 1000}s...`);
                         await new Promise(resolve => setTimeout(resolve, delay));
                         delay *= 2;
                         continue;
                    }
                    console.log("[Gemini Format] Final fallback to original text.");
                    return trimmedText;
                }
            }
            return trimmedText;
        }

        // =================================================================
        // ğŸŒŸ (å‡½æ•¸å·²æ›´æ–°) 
        // åƒ…ç”Ÿæˆ AI Breakdown æ–‡å­—ï¼Œä¸¦é¡¯ç¤ºæ‰‹å‹•è²¼åœ–æ¬„ä½
        // =================================================================
        async function generateAIBreakdown() { // å‡½æ•¸å·²é‡å‘½å
            const button = document.getElementById('generate-chart-button');
            const status = document.getElementById('chart-generator-status');
            const displayArea = document.getElementById('chart-display-area');
            // ğŸŒŸ ç§»é™¤ï¼šä¸å†éœ€è¦ hiddenBreakdownTextarea
            // const hiddenBreakdownTextarea = document.getElementById('ai_breakdown_text'); 
            const manualPasteContainer = document.getElementById('manual-chart-paste-container'); // æ–°çš„è²¼åœ–å®¹å™¨

            // 1. ç²å–æè¿°
            const articleContent = document.getElementById('article_content').value.trim();

            if (!articleContent) {
                status.textContent = 'ğŸš¨ éŒ¯èª¤ï¼šè«‹å…ˆåœ¨ã€Œæ–‡ç« å…§å®¹èˆ‡åœ–è¡¨æˆªåœ–ã€æ¬„ä½ä¸­å¡«å¯«æ–‡å­—æè¿°ã€‚';
                return;
            }

            // 2. è¨­ç½®åŠ è¼‰ç‹€æ…‹
            button.disabled = true;
            button.textContent = 'ğŸ§  æ­£åœ¨ç†è§£æ–‡å­—...';
            status.textContent = 'è«‹ç¨å€™ï¼ŒAI æ­£åœ¨åˆ†ææ‚¨çš„æ–‡å­—æè¿°...';
            displayArea.innerHTML = ''; // æ¸…ç©ºèˆŠå…§å®¹
            manualPasteContainer.classList.add('hidden'); // éš±è—è²¼åœ–å€
            // ğŸŒŸ ç§»é™¤ï¼šä¸å†éœ€è¦ hiddenBreakdownTextarea
            // hiddenBreakdownTextarea.value = ''; 
 
            let breakdownText = ""; 
            const maxRetries = 3;
            let delay = 1000;

            try {
                // ==========================================================
                // æ­¥é©Ÿ 1: å‘¼å« *æ–‡å­—æ¨¡å‹* (modelName) ç²å–å®Œæ•´çš„ Breakdown
                // ==========================================================
                
                const textPrompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„IELTS Task 1 åœ–è¡¨åˆ†æå¸«ã€‚è«‹è©³ç´°é–±è®€ä»¥ä¸‹çš„ Task 1 å¯«ä½œæ–‡å­—ï¼Œä¸¦"break down"ä½ å°å…§å®¹çš„ç†è§£ã€‚ä½ çš„ breakdown æ‡‰è©²åŒ…å«ï¼š
1.  åœ–è¡¨çš„ä¸»è¦é¡å‹ (ä¾‹å¦‚ï¼šline graph, bar chart)ã€‚
2.  åœ–è¡¨æè¿°çš„é—œéµä¸»é«”å’Œå–®ä½ (ä¾‹å¦‚ï¼šenergy consumption in tonnes, population in millions)ã€‚
3.  æè¿°çš„é—œéµæ™‚é–“ç¯„åœ (ä¾‹å¦‚ï¼šfrom 1990 to 2010)ã€‚
4.  æè¿°çš„é—œéµæ•¸æ“šé»å’Œè¶¨å‹¢ (ä¾‹å¦‚ï¼šA started at 50 and rose to 100, while B declined)ã€‚

è«‹ä»¥æ¸…æ™°ã€æœ‰æ¢ç†çš„æ ¼å¼è¼¸å‡ºé€™å€‹ breakdownã€‚

åŸå§‹æ–‡å­—ï¼š
---
${articleContent}
---
`;
                
                const textApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
                const textPayload = {
                    contents: [{ parts: [{ text: textPrompt }] }]
                };

                let textResponse;
                let textResult;

                for (let i = 0; i < maxRetries; i++) {
                    textResponse = await fetch(textApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(textPayload)
                    });

                    if (textResponse.ok) {
                        textResult = await textResponse.json();
                        break; 
                    }
                    
                    if ((textResponse.status === 429 || textResponse.status === 503) && i < maxRetries - 1) {
                        console.warn(`[Chart Gen - Text] API Rate Limit hit (${textResponse.status}). Retrying in ${delay / 1000}s...`);
                        status.textContent = `API å¿™ç¢Œä¸­ (${textResponse.status})ï¼Œ${delay / 1000} ç§’å¾Œé‡è©¦...`;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        const errorResult = await textResponse.json();
                        console.error("[Chart Gen - Text] API Error Response:", errorResult);
                        throw new Error(`[æ–‡å­—ç†è§£] API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${textResponse.status}. ${errorResult?.error?.message || ''}`);
                    }
                }

                // æå–æ–‡å­— breakdown
                breakdownText = textResult?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!breakdownText) {
                    throw new Error('AI æœªèƒ½è¿”å›æ–‡å­—ç†è§£ (Breakdown)ã€‚');
                }

                // 3. é¡¯ç¤º Breakdown
                console.log("[Chart Gen] Found full text part:", breakdownText);
                const breakdownElement = document.createElement('div');
                breakdownElement.className = 'p-4 bg-darkBg border border-borderDark rounded-lg mt-4';
                breakdownElement.innerHTML = `<strong class="text-lg text-purple-300">AI çš„ç†è§£ (Breakdown):</strong><br><pre class="whitespace-pre-wrap text-gray-300 font-sans mt-2">${breakdownText}</pre>`;
                displayArea.appendChild(breakdownElement);

                // 4. å„²å­˜ Breakdown åˆ°éš±è—æ¬„ä½
                // ğŸŒŸ ç§»é™¤ï¼šä¸å†å„²å­˜ Breakdown æ–‡å­—åˆ°éš±è—æ¬„ä½
                // hiddenBreakdownTextarea.value = breakdownText;
                
                // 5. é¡¯ç¤ºæ‰‹å‹•è²¼åœ–å®¹å™¨
                manualPasteContainer.classList.remove('hidden');
                
                status.textContent = 'âœ… AI ç†è§£å·²ç”Ÿæˆï¼è«‹åœ¨ä¸‹æ–¹æ¬„ä½è²¼ä¸Šæ‚¨çš„åœ–è¡¨ã€‚';

                // 6. ç§»é™¤æ‰€æœ‰åœ–ç‰‡ç”Ÿæˆç›¸é—œçš„ç¨‹å¼ç¢¼

            } catch (error) {
                console.error('[Chart Gen] Error:', error);
                status.textContent = `âŒ ç”Ÿæˆå¤±æ•—ï¼š${error.message}`;
            } finally {
                // 7. æ¢å¾©æŒ‰éˆ•
                button.disabled = false;
                button.textContent = 'é‡æ–°ç”Ÿæˆ AI ç†è§£';
            }
        }


        // -----------------------------------------------------
        // è¡¨å–®æäº¤é‚è¼¯
        // -----------------------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            // ğŸŒŸ ä¿®æ”¹ï¼šç¶å®š ZIP åŒ¯å‡º/åŒ¯å…¥æŒ‰éˆ•
            document.getElementById('export-markdown-button').addEventListener('click', exportZip);
            document.getElementById('import-markdown-input').addEventListener('change', importZip);


            // åœ¨ DOMContentLoaded æ™‚ç‚ºæ‰€æœ‰éœ€è¦çš„ Textarea å•Ÿç”¨åœ–ç‰‡ä¸Šå‚³åŠŸèƒ½
            setupImageUpload('article_content');
            setupImageUpload('sentence_analysis'); 
            setupImageUpload('self_assessment_notes'); 
            setupImageUpload('ai_assessment');
            setupImageUpload('reflection_action');
            setupImageUpload('additional_notes');

            // ğŸŒŸ æ–°å¢ï¼šç‚º self_assessment_screenshot å•Ÿç”¨
            setupImageUpload('self_assessment_screenshot');
            // LR/GRA è§£ææ¬„ä½
            setupImageUpload('self_assessment_lr_analysis');
            setupImageUpload('self_assessment_gra_analysis');
            
            // æ–°å¢çš„è‡ªè©•å•é¡Œè¾¨è­˜æ¬„ä½ (æ”¯æ´è²¼åœ–)
            setupImageUpload('self_identified_issues'); // <-- æ–°å¢
            
            // ğŸŒŸ (æ–° JS æ’å…¥é») ç‚ºæ–°æ¬„ä½å•Ÿç”¨è²¼åœ–
            setupImageUpload('custom_field_1'); 

            // ğŸŒŸ (æ–° JS æ’å…¥é») ç‚º*æ–°çš„æ‰‹å‹•è²¼åœ–æ¬„ä½*å•Ÿç”¨è²¼åœ–
            setupImageUpload('manual_chart_paste'); 

            // ğŸŒŸ (æ–° JS æ’å…¥é») ç¶å®š AI *Breakdown* ç”ŸæˆæŒ‰éˆ•
            document.getElementById('generate-chart-button').addEventListener('click', generateAIBreakdown); // å‡½æ•¸åç¨±å·²æ›´æ–°
            
            // é è¨­å¯«ä½œæ—¥æœŸç‚ºä»Šå¤©
            // ==================================
            //   â¬‡ï¸ èªæ³•éŒ¯èª¤ä¿®æ­£ â¬‡ï¸
            // ==================================
            document.getElementById('writing_date').value = new Date().toISOString().split('T')[0];
            // ==================================
            //   â¬†ï¸ èªæ³•éŒ¯èª¤ä¿®æ­£ â¬†ï¸
            // ==================================
        });


        document.getElementById('issue-form').addEventListener('submit', async function(event) {
            event.preventDefault(); 
            
            console.log("Starting Issue Submission Process...");

            // ç²å– GitHub è³‡è¨Š
            const user = document.getElementById('github_user').value.trim();
            const repo = document.getElementById('github_repo').value.trim();
            const token = document.getElementById('github_token').value.trim();
            const repoError = document.getElementById('repo-error');
            const statusMessage = document.getElementById('status-message');
            const submitButton = document.getElementById('submit-button');

            statusMessage.classList.add('hidden');
            statusMessage.textContent = '';
            
            // æª¢æŸ¥ GitHub è³‡è¨Š
            if (!user || !repo || !token) {
                repoError.classList.remove('hidden');
                statusMessage.textContent = 'ğŸš¨ éŒ¯èª¤ï¼šè«‹å¡«å¯« GitHub ä½¿ç”¨è€…åç¨±ã€å„²å­˜åº«åç¨±å’Œ PATã€‚';
                statusMessage.classList.remove('hidden', 'bg-successGreen', 'bg-errorRed');
                statusMessage.classList.add('bg-accentYellow', 'text-black');
                return;
            }
            repoError.classList.add('hidden'); 
            
            // ç¦ç”¨æŒ‰éˆ•ä¸¦é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            submitButton.disabled = true;
            
            // 1. ç²å–è¡¨å–®æ•¸æ“š
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            // ==================================
            //   â¬‡ï¸ æ–°å¢ï¼šæ¨™é¡Œé‚è¼¯ä¿®æ”¹ â¬‡ï¸
            // ==================================
            const taskName = data.task_name || 'æœªå‘½åç·´ç¿’';
            const writingDate = data.writing_date || new Date().toISOString().split('T')[0];
            const rootCauseTitle = data.root_cause_title ? data.root_cause_title.trim() : '';
            
            // å¦‚æœæ ¹æœ¬åŸå› æ¬„ä½ç‚ºç©ºï¼Œå‰‡ä½¿ç”¨èˆŠçš„æ¨™é¡Œæ ¼å¼ä½œç‚ºå¾Œå‚™
            const title = rootCauseTitle ? rootCauseTitle : `Task 1 å¯«ä½œè©•ä¼° - ${taskName} (æœªå¡«å¯«æ ¹æœ¬åŸå› )`;
            // ==================================
            //   â¬†ï¸ æ–°å¢ï¼šæ¨™é¡Œé‚Gè¼¯ä¿®æ”¹ â¬†ï¸
            // ==================================

            const labels = ['ielts-writing', 'task-1', data.question_type || 'unclassified'];

            
            // 2. è™•ç†åœ–ç‰‡ä¸Šå‚³
            let uploadedImageMap = {};
            // æª¢æŸ¥æ˜¯å¦æœ‰åœ–ç‰‡éœ€è¦ä¸Šå‚³
            let totalImagesToUpload = 0;
            for (const id in pendingImages) {
                totalImagesToUpload += pendingImages[id].length;
            }

            if (totalImagesToUpload > 0) {
                try {
                    uploadedImageMap = await uploadAllImages(user, repo, token, submitButton);
                    
                    submitButton.textContent = 'ğŸ¤– æ­£åœ¨ä½¿ç”¨ AI æ ¼å¼åŒ–å…§å®¹... (1/12)'; // ğŸŒŸ 11 -> 12
                } catch (e) {
                    statusMessage.textContent = `âŒ åœ–ç‰‡ä¸Šå‚³éç¨‹ä¸­ç™¼ç”Ÿåš´é‡éŒ¯èª¤: ${e.message}`;
                    statusMessage.classList.remove('hidden', 'bg-successGreen', 'bg-accentYellow', 'text-black');
                    statusMessage.classList.add('bg-errorRed', 'text-white');
                    submitButton.disabled = false;
                    submitButton.textContent = 'âœ¨ è‡ªå‹•å»ºç«‹ GitHub Issue';
                    return;
                }
            } else {
                 submitButton.textContent = 'ğŸ¤– æ­£åœ¨ä½¿ç”¨ AI æ ¼å¼åŒ–å…§å®¹... (1/12)'; // ğŸŒŸ 11 -> 12
            }


            // 3. æ›¿æ›æ‰€æœ‰æ¬„ä½ä¸­çš„åœ–ç‰‡ä½”ä½ç¬¦
            function replacePlaceholders(content, uploadedMap) {
                let newContent = content;
                for (const placeholder in uploadedMap) {
                    const finalUrl = uploadedMap[placeholder];
                    // æ›¿æ›æ‰€æœ‰çš„ ![Uploading: <placeholder>]
                    newContent = newContent.replace(new RegExp(`!\\[Uploading: ${placeholder}\\]`, 'g'), `![${placeholder}](${finalUrl})`);
                }
                return newContent;
            }

            const processedFields = {};
            // ğŸŒŸ <-- æ›´æ–°è¦è™•ç†çš„æ¬„ä½æ¸…å–®: ç§»é™¤ 'ai_breakdown_text'ï¼Œæ–°å¢ 'self_assessment_screenshot'
            // æ³¨æ„ï¼šroot_cause_title ä¸éœ€è¦æ ¼å¼åŒ–æˆ–åœ–ç‰‡æ›¿æ›ï¼Œæ‰€ä»¥ä¸åœ¨æ­¤åˆ—è¡¨ä¸­
            for (const key of ['article_content', 'sentence_analysis', 'self_assessment_notes', 'ai_assessment', 'reflection_action', 'additional_notes', 'self_assessment_screenshot', 'self_assessment_lr_analysis', 'self_assessment_gra_analysis', 'self_identified_issues', 'custom_field_1', 'manual_chart_paste']) { 
                // å°‡åœ–ç‰‡é€£çµæ›¿æ›åˆ°æ–‡å­—ä¸­
                processedFields[key] = replacePlaceholders(data[key] || '', uploadedImageMap);
            }
            
            // ç²å–æ–°çš„ Google Translate æ¬„ä½å…§å®¹ (ä¸éœ€è¦æ›¿æ›ä½”ä½ç¬¦ï¼Œå› ç‚ºå®ƒå€‘ä¸æ”¯æ´è²¼åœ–)
            const googleTranslateSource = data.google_translate_source || '';
            const googleTranslateOutput = data.google_translate_output || '';

            // 4. æº–å‚™åˆ†æ•¸ (é€šç”¨å‚™è¨»å°‡å–®ç¨è™•ç†)
            const selfAssessmentInput = `
Task Achievement (TA): ${data.self_assessment_ta || 'N/A'}
Coherence & Cohesion (CC): ${data.self_assessment_cc || 'N/A'}
Lexical Resource (LR): ${data.self_assessment_lr || 'N/A'}
Grammatical Range & Accuracy (GRA): ${data.self_assessment_gra || 'N/A'}
`.trim();


            // 5. ä½¿ç”¨ Gemini è½‰æ›è©•ä¼°æ–‡æœ¬ (ç¾åœ¨æœ‰ 12 å€‹æ­¥é©Ÿ)
            
            // A. è½‰æ›è‡ªæˆ‘è©•ä¼° (åƒ…åˆ†æ•¸) (1/12)
            submitButton.textContent = 'ğŸ¤– æ­£åœ¨ä½¿ç”¨ AI æ ¼å¼åŒ–å…§å®¹... (1/12)'; 
            const selfAssessmentFormatted = await formatTextWithGemini(
                selfAssessmentInput, 
                "IELTS Task 1 è‡ªæˆ‘è©•ä¼°ï¼ŒåŒ…å« TA, CC, LR, GRA åˆ†æ•¸ã€‚è«‹è½‰ç‚ºå…©æ¬„ Markdown è¡¨æ ¼ã€‚",
                true // Prefer Table
            );

            // B. ğŸŒŸ æ–°å¢ï¼šè½‰æ›è‡ªè©•ç¸½è¦½æˆªåœ– (2/12)
            submitButton.textContent = 'ğŸ¤– æ­£åœ¨ä½¿ç”¨ AI æ ¼å¼åŒ–å…§å®¹... (2/12)'; 
            const screenshotFormatted = await formatTextWithGemini(
                processedFields.self_assessment_screenshot, 
                "IELTS Task 1 è‡ªæˆ‘è©•ä¼°çš„ç¸½è¦½æˆªåœ–ï¼Œæ‡‰ç‚º Markdown åœ–ç‰‡é€£çµã€‚è«‹ä¿æŒåŸæ¨£ã€‚",
                false // Do NOT prefer table
            );

            // C. è½‰æ› LR Analysis (3/12)
            submitButton.textContent = 'ğŸ¤– æ­£åœ¨ä½¿ç”¨ AI æ ¼å¼åŒ–å…§å®¹... (3/12)'; 
            const lrAnalysisFormatted = await formatTextWithGemini(
                processedFields.self_assessment_lr_analysis, 
                "IELTS Task 1 è©å½™è³‡æº (LR) çš„è‡ªæˆ‘è©•ä¼°ç´°ç¯€å’Œåˆ†æï¼Œå¯èƒ½å«æœ‰åœ–ç‰‡é€£çµã€‚è«‹å°‡å…§å®¹è½‰æ›ç‚ºæ•´æ½”çš„ Markdown åˆ—è¡¨æˆ–æ®µè½ï¼Œä»¥ä¾¿é–±è®€ã€‚",
                true // Prefer Table
            );

            // D. è½‰æ› GRA Analysis (4/12)
            submitButton.textContent = 'ğŸ¤– æ­£åœ¨ä½¿ç”¨ AI æ ¼å¼åŒ–å…§å®¹... (4/12)'; 
            const graAnalysisFormatted = await formatTextWithGemini(
                processedFields.self_assessment_gra_analysis, 
                "IELTS Task 1 æ–‡æ³•ç¯„åœèˆ‡æº–ç¢ºæ€§ (GRA) çš„è‡ªæˆ‘è©•ä¼°ç´°ç¯€å’Œåˆ†æï¼Œå¯èƒ½å«æœ‰åœ–ç‰‡é€£çµã€‚è«‹å°‡å…§å®¹è½‰æ›ç‚ºæ•´æ½”çš„ Markdown åˆ—è¡¨æˆ–æ®µè½ï¼Œä»¥ä¾¿é–±è®€ã€‚",
                true // Prefer Table
            );
            
            // E. è½‰æ› Self Identified Issues (æ–°å¢) (5/12)
            submitButton.textContent = 'ğŸ¤– æ­£åœ¨ä½¿ç”¨ AI æ ¼å¼åŒ–å…§å®¹... (5/12)'; 
            const selfIdentifiedIssuesFormatted = await formatTextWithGemini(
                processedFields.self_identified_issues, 
                "Task 1 å¯«ä½œçš„è‡ªè©•è¾¨è­˜å‡ºçš„ TA/CC æº–ç¢ºæ€§å•é¡Œèˆ‡ç›²é»ã€‚è«‹å°‡å…§å®¹è½‰æ›ç‚ºæ•´æ½”çš„ Markdown åˆ—è¡¨æˆ–æ®µè½ï¼Œä¿ç•™æ‰€æœ‰æ›è¡Œå’Œé …ç›®ç¬¦è™Ÿã€‚",
                false // Do NOT prefer table for free-form analysis of issues
            );

            // F. è½‰æ› TA/CC åœ–è¡¨åå‘é©—è­‰ (6/12)
            submitButton.textContent = 'ğŸ¤– æ­£åœ¨ä½¿ç”¨ AI æ ¼å¼åŒ–å…§å®¹... (6/12)'; 
            const customField1Formatted = await formatTextWithGemini(
                processedFields.custom_field_1, 
                "Task 1 å¯«ä½œçš„ TA/CC ç”¨å­—æº–ç¢ºæ€§ (åœ–è¡¨åå‘é©—è­‰)ã€‚è«‹å°‡å…§å®¹è½‰æ›ç‚ºæ•´æ½”çš„ Markdown åˆ—è¡¨æˆ–æ®µè½ï¼Œä¿ç•™æ‰€æœ‰æ›è¡Œå’Œé …ç›®ç¬¦è™Ÿã€‚",
                false // ä¸å„ªå…ˆä½¿ç”¨è¡¨æ ¼
            );

            // G. è½‰æ›æ‰‹å‹•è²¼ä¸Šçš„åœ–è¡¨ (7/12)
            submitButton.textContent = 'ğŸ¤– æ­£åœ¨ä½¿ç”¨ AI æ ¼å¼åŒ–å…§å®¹... (7/12)';
            const manualChartFormatted = await formatTextWithGemini(
                processedFields.manual_chart_paste, 
                "ä½¿ç”¨è€…æ‰‹å‹•è²¼ä¸Šçš„åœ–è¡¨ (Markdown åœ–ç‰‡é€£çµ)ã€‚ä¿æŒåŸæ¨£ã€‚",
                false // ä¸ä½¿ç”¨è¡¨æ ¼
            );

            // H. è½‰æ› AI è©•åˆ† (8/12)
            submitButton.textContent = 'ğŸ¤– æ­£åœ¨ä½¿ç”¨ AI æ ¼å¼åŒ–å…§å®¹... (8/12)'; 
            const aiAssessmentFormatted = await formatTextWithGemini(
                processedFields.ai_assessment, 
                "IELTS Task 1 AI è©•åˆ†ï¼ŒåŒ…å« TR, CC, LR, GRA åˆ†æ•¸èˆ‡ AI è©•èªå»ºè­°ï¼Œå¯èƒ½å«æœ‰åœ–ç‰‡é€£çµã€‚è«‹å„ªå…ˆè½‰ç‚ºå…©æ¬„ Markdown è¡¨æ ¼ã€‚",
                true // Prefer Table
            );
            
            // I. è½‰æ› é€å¥è§£æå…§å®¹ (9/12)
            submitButton.textContent = 'ğŸ¤– æ­£åœ¨ä½¿ç”¨ AI æ ¼å¼åŒ–å…§å®¹... (9/12)'; 
            const sentenceAnalysisFormatted = await formatTextWithGemini(
                processedFields.sentence_analysis, 
                "Task 1 å¯«ä½œçš„é€å¥è§£æå…§å®¹ï¼ŒåŒ…å«å¥å­ã€æ–‡æ³•ä¿®æ­£ã€è©å½™å»ºè­°æˆ–æˆªåœ–ã€‚è«‹å˜—è©¦è½‰æ›ç‚ºå…©æ¬„ Markdown è¡¨æ ¼ (ä¾‹å¦‚ï¼šåŸå§‹å¥å­ | ä¿®æ­£å»ºè­°)ï¼Œè‹¥å…§å®¹ä¸é©åˆè¡¨æ ¼ï¼Œå‰‡è½‰æ›ç‚ºæ•´æ½”çš„åˆ—è¡¨æˆ–æ®µè½ã€‚",
                true // Prefer Table
            );
            
            // J. è½‰æ› åæ€èˆ‡è¡Œå‹• (10/12)
            submitButton.textContent = 'ğŸ¤– æ­£åœ¨ä½¿ç”¨ AI æ ¼å¼åŒ–å…§å®¹... (10/12)'; 
            const reflectionActionFormatted = await formatTextWithGemini(
                processedFields.reflection_action, 
                "å¯«ä½œå¾Œçš„åæ€èˆ‡å…·é«”ä¿®æ­£è¡Œå‹•ï¼ŒåŒ…å«é …ç›®ç¬¦è™Ÿã€ä»»å‹™é€£çµæˆ–ä¿®æ­£æˆªåœ–ã€‚è«‹å˜—è©¦è½‰æ›ç‚ºå…©æ¬„ Markdown è¡¨æ ¼ (é …ç›® | å…§å®¹)ï¼Œè‹¥å…§å®¹ä¸é©åˆè¡¨æ ¼ï¼Œå‰‡è½‰æ›ç‚ºæ•´æ½”çš„åˆ—è¡¨æˆ–æ®µè½ã€‚",
                true // Prefer Table
            );

            // K. è½‰æ› å…¶ä»–å‚™è¨» (11/12)
            submitButton.textContent = 'ğŸ¤– æ­£åœ¨ä½¿ç”¨ AI æ ¼å¼åŒ–å…§å®¹... (11/12)'; 
            const additionalNotesFormatted = await formatTextWithGemini(
                processedFields.additional_notes, 
                "é¡å¤–å‚™è¨»æˆ–å¯«ä½œå¿ƒå¾—ï¼Œå¯èƒ½åŒ…å«åœ–ç‰‡é€£çµã€‚è«‹å˜—è©¦è½‰æ›ç‚ºå…©æ¬„ Markdown è¡¨æ ¼ (é …ç›® | å…§å®¹)ï¼Œè‹¥å…§å®¹ä¸é©åˆè¡¨æ ¼ï¼Œå‰‡è½‰æ›ç‚ºæ•´æ½”çš„æ®µè½ã€‚",
                true // Prefer Table
            );

            // L. è™•ç† checkbox (12/12)
            submitButton.textContent = 'ğŸ¤– æ­£åœ¨ä½¿ç”¨ AI æ ¼å¼åŒ–å…§å®¹... (12/12)'; 
            const checkedDifferences = Array.from(document.querySelectorAll('input[name="difference_analysis"]:checked'))
                                            .map(cb => `- [x] ${cb.value}`)
                                            .join('\n');
            

            // 6. å»ºç«‹ body å…§å®¹ (å°‡æ–°çš„è§£ææ¬„ä½åŠ å…¥)
            const body = `
### âš ï¸ æ–‡ç« å…§å®¹

è«‹åƒè€ƒæ‚¨æ‰‹å‹•ä¸Šå‚³çš„ **\`${data.task_file || 'æœªå¡«å¯«æª”æ¡ˆåç¨±'}\`** æª”æ¡ˆï¼Œæˆ–é»æ“Šä¸‹æ–¹å¯æ”¶åˆå€å¡ŠæŸ¥çœ‹åŸå§‹å¯«ä½œæˆªåœ–èˆ‡æ–‡å­—ã€‚

---
<details>
<summary>é»æ“Šæ­¤è™•å±•é–‹åŸå§‹æ–‡ç« å…§å®¹æˆªåœ–èˆ‡æ–‡å­—</summary>
<br>

${processedFields.article_content.trim() || 'ï¼ˆåŸå§‹æ–‡ç« å…§å®¹æ¬„ä½ç‚ºç©ºï¼‰'}

</details>
---

### ğŸ“š é€å¥è§£æå…§å®¹
${sentenceAnalysisFormatted}

---

### 1ï¸âƒ£ é¡Œç›®åç¨±/ç·¨è™Ÿ
${data.task_name || 'æœªå¡«å¯«'}

### æ–‡ç« æª”æ¡ˆ
**æª”æ¡ˆåç¨±ï¼š** ${data.task_file || 'æœªå¡«å¯«'}
*(âš ï¸ **é‡è¦æé†’ï¼š** æª”æ¡ˆ ${data.task_file || 'æœªå¡«å¯«'} æœªèƒ½è‡ªå‹•ä¸Šå‚³ã€‚è«‹åœ¨ Issue å»ºç«‹å¾Œï¼Œæ‰‹å‹•æ‹–æ›³æª”æ¡ˆåˆ°æ­¤è™•ä¾†å®Œæˆä¸Šå‚³ã€‚)*

### ğŸ“… å¯«ä½œæ—¥æœŸ
${data.writing_date || 'æœªå¡«å¯«'}

### ğŸ“Š é¡Œå‹
${data.question_type || 'æœªé¸æ“‡'}

### 2ï¸âƒ£ è‡ªæˆ‘è©•ä¼°åˆ†æ•¸ (Self Assessment)

#### ğŸ“ è©•åˆ†é …ç›®
${selfAssessmentFormatted}

#### ğŸ“¸ è‡ªè©•ç¸½è¦½æˆªåœ–
${screenshotFormatted}

#### ğŸ“ è©å½™è³‡æº (LR) è‡ªè©•è§£æ
${lrAnalysisFormatted}

#### ğŸ“ æ–‡æ³•ç¯„åœèˆ‡æº–ç¢ºæ€§ (GRA) è‡ªè©•è§£æ
${graAnalysisFormatted}

---

### ğŸ’¡ Google èªç¾©æª¢æŸ¥ (TA/CC/LR æº–ç¢ºæ€§è©•ä¼°)

#### ğŸ‡¨ğŸ‡³ ä¸­æ–‡æºæ–‡ï¼ˆæ‚¨çš„åŸå§‹æ„åœ–ï¼‰
> ${googleTranslateSource.trim().replace(/\n/g, '\n> ') || 'ï¼ˆæœªæä¾›ï¼‰'}

#### ğŸ‡¬ğŸ‡§ ç¿»è­¯çµæœï¼ˆåå‘é©—è­‰ï¼‰
> ${googleTranslateOutput.trim().replace(/\n/g, '\n> ') || 'ï¼ˆæœªæä¾›ï¼‰'}

#### ğŸš¨ è‡ªè©•è¾¨è­˜å‡ºçš„å•é¡Œ (ä¿®æ­£ç›²é»)
${selfIdentifiedIssuesFormatted}

---
<!-- ğŸŒŸ (æ–° JS æ’å…¥é») -->
### ğŸ¤– AI ä¾æ“š**åŸå§‹æ„åœ–**ç”Ÿæˆåœ–è¡¨ (TA/CC æº–ç¢ºæ€§è©•ä¼°)
${manualChartFormatted.trim() || 'ï¼ˆæœªè²¼ä¸Šåœ–è¡¨ï¼‰'}
---


#### ğŸš¨ è‡ªè©•è¾¨è­˜å‡ºçš„å•é¡Œ (ä¿®æ­£ç›²é»)
${customField1Formatted.trim() || 'ï¼ˆæœªå¡«å¯«ï¼‰'}

---

### ğŸ“ å…¶ä»–è§€å¯Ÿ/å‚™è¨» (é€šç”¨)
${processedFields.self_assessment_notes.trim() || 'ï¼ˆæœªå¡«å¯«é€šç”¨å‚™è¨»ï¼‰'}

---

### 3ï¸âƒ£ AI è©•åˆ† (AI Scoring)
${aiAssessmentFormatted}

### 4ï¸âƒ£ å·®ç•°åˆ¤æ–· (Difference Analysis)
${checkedDifferences || 'æœªé¸æ“‡'}

### 5ï¸âƒ£ åæ€èˆ‡è¡Œå‹• (Reflection & Action)
${reflectionActionFormatted}

<!-- ================================== -->
<!--      â¬‡ï¸ æ–°å¢ï¼šæ ¹æœ¬åŸå›  (Body) â¬‡ï¸     -->
<!-- ================================== -->
### ğŸ¯ æ ¹æœ¬åŸå›  (Issue Title)
> ${title}
<!-- ================================== -->
<!--      â¬†ï¸ æ–°å¢ï¼šæ ¹æœ¬åŸå›  (Body) â¬†ï¸     -->
<!-- ================================== -->

### 6ï¸âƒ£ å¯¦éš›æ ¹æœ¬åŸå› 
${additionalNotesFormatted}
`;
            
            // 7. ç™¼é€ API è«‹æ±‚è‡ªå‹•å»ºç«‹ Issue
            submitButton.textContent = 'ğŸš€ æ­£åœ¨å»ºç«‹ GitHub Issue...';
            const apiUrl = `https://api.github.com/repos/${user}/${repo}/issues`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.com/v3+json' 
                    },
                    body: JSON.stringify({
                        title: title, // ğŸŒŸ å·²æ›´æ–°ç‚ºä½¿ç”¨æ–°çš„ title è®Šæ•¸
                        body: body,
                        labels: labels
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    statusMessage.textContent = `âœ… Issue å»ºç«‹æˆåŠŸï¼Issue #${result.number} å·²å»ºç«‹ã€‚`;
                    statusMessage.classList.remove('hidden', 'bg-errorRed', 'bg-accentYellow', 'text-black');
                    statusMessage.classList.add('bg-successGreen', 'text-white');
                    
                    // æˆåŠŸå¾Œï¼Œé–‹å•Ÿ new Issue é é¢
                    setTimeout(() => {
                         window.open(result.html_url, '_blank');
                    }, 1000); 

                } else {
                    let errorMessage = 'å»ºç«‹ Issue å¤±æ•—ã€‚';
                    if (result.message) {
                        errorMessage += ` GitHub éŒ¯èª¤è¨Šæ¯ï¼š${result.message}`;
                    }
                    if (response.status === 401 || response.status === 403) {
                        errorMessage += " (è«‹æª¢æŸ¥ PAT æ˜¯å¦æœ‰æ•ˆæˆ–æ¬Šé™æ˜¯å¦è¶³å¤  - éœ€è¦ 'repo' æ¬Šé™)";
                    } else if (response.status === 404) {
                        errorMessage += " (è«‹æª¢æŸ¥ä½¿ç”¨è€…åç¨±æˆ–å„²å­˜åº«åç¨±æ˜¯å¦æ­£ç¢º)";
                    }
                    statusMessage.textContent = `âŒ ${errorMessage}`;
                    statusMessage.classList.remove('hidden', 'bg-successGreen', 'bg-accentYellow', 'text-black');
                    statusMessage.classList.add('bg-errorRed', 'text-white');
                }

            } catch (error) {
                statusMessage.textContent = `âŒ ç¶²è·¯æˆ–æœªçŸ¥éŒ¯èª¤ï¼š${error.message}`;
                statusMessage.classList.remove('hidden', 'bg-successGreen', 'bg-accentYellow', 'text-black');
                statusMessage.classList.add('bg-errorRed', 'text-white');
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                submitButton.disabled = false;
                submitButton.textContent = 'âœ¨ è‡ªå‹•å»ºç«‹ GitHub Issue';
            }
        });
    </script>

</body>
</html>