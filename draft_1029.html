<!DOCTYPE html>
<!-- v2.9.3-en: Changed lang to English and translated all UI elements -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Vocabulary & Collocation System (v2.9.3)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base Style */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Highlight Style */
        .highlight {
            background-color: rgba(147, 197, 253, 0.4); /* blue-300/40 */
            color: #dbeafe; /* text-blue-100 */
            font-weight: 600;
            padding: 0 2px;
            border-radius: 3px;
            white-space: nowrap; /*
Ensure highlighted part does not wrap */
        }
        /* Hide Element */
        .hidden {
            display: none;
        }
        /* Simple Spinner Animation */
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #ffffff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .band-tag {
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- Title -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">Smart Vocabulary & Collocation System (v2.9.3)</h1>
            <!-- v2.9.3-en: Translated -->
            <p class="text-lg text-gray-400 mt-2">
                Integrating Grammar Validation (GVL), Correction (GCE), and Cohesion & Coherence (C&C) Analysis
            </p>
        </header>

        <!-- API Key Input -->
        <div class="max-w-xl mx-auto mb-6 p-4 bg-gray-800 rounded-lg shadow-inner border border-gray-700">
            <label for="apiKeyInput" class="block text-sm font-medium text-gray-300 mb-2">
                Gemini API Key
            </label>
            <!-- v2.9.3-en: Translated -->
            <input type="password" id="apiKeyInput" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter your API key here..." value="AIzaSyCKKfTgA-4wY7aOP0fqLHRJ8dBV9AQRkzs">
            <!-- v2.9.3-en: Translated -->
            <p class="text-xs text-gray-500 mt-2">
                Please paste your own Gemini API key to ensure service availability.
            </p>
        </div>
        
        <!-- Feature Tabs -->
        <!-- v2.9.3-en: Translated -->
        <div class="flex justify-center mb-6 border-b border-gray-700">
            <button id="tabPrediction" class="tab-button px-6 py-3 font-semibold text-white bg-gray-800 rounded-t-lg -mb-px border-t border-l border-r border-gray-700">
                1. Word Prediction
            </button>
            <button id="tabValidation" class="tab-button px-6 py-3 font-semibold text-gray-400 hover:bg-gray-800/50 rounded-t-lg">
                2. Collocation Validation
            </button>
            <button id="tabContinuation" class="tab-button px-6 py-3 font-semibold text-gray-400 hover:bg-gray-800/50 rounded-t-lg">
                3. Paragraph Analysis
            </button>
        </div>

        <!-- Main Content Area -->
        <main>
            <!-- 1. Prediction Content -->
            <div id="predictionContent">
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl space-y-6">
                    <form id="predictionForm" class="space-y-4">
                        <!-- v2.9.3-en: Translated -->
                        <label for="predInput" class="block text-sm font-medium text-gray-300 mb-2">Input Context Phrase</label>
                        <input type="text" id="predInput" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., The government should implement effective policies to...">
                        
                        <div id="igpvlPredError" class="text-sm rounded-lg"></div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <!-- v2.9.3-en: Translated -->
                                <label for="predPos" class="block text-sm font-medium text-gray-300 mb-2">Specify Word Class</label>
                                <select id="predPos" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <!-- v2.9.3-en: Translated -->
                                    <option value="any">Any</option>
                                    <option value="N">Noun</option>
                                    <option value="V">Verb</option>
                                    <option value="Adj">Adjective</option>
                                    <option value="Adv">Adverb</option>
                                </select>
                            </div>
                            <div>
                                <!-- v2.9.3-en: Translated -->
                                <label for="predTask" class="block text-sm font-medium text-gray-300 mb-2">Writing Mode</label>
                                <select id="predTask" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <!-- v2.9.3-en: Translated -->
                                    <option value="general">General</option>
                                    <option value="task1">Data & Visual Report</option>
                                    <option value="task2">Academic Essay</option>
									<option value="TechWriting">TechWriting</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="pt-4 border-t border-gray-700">
                            <!-- v2.9.3-en: Translated -->
                            <h3 class="text-sm font-medium text-gray-300 mb-2">Consistency Manager</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <label class="block">
                                    <span class="text-xs text-gray-400">Temperature</span>
                                    <input type="number" id="predTemp" value="0.7" step="0.1" min="0.1" max="1.0" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white text-sm">
                                </label>
                                <label class="block">
                                    <span class="text-xs text-gray-400">Top-P (Nucleus Sampling)</span>
                                    <input type="number" id="predTopP" value="0.95" step="0.05" min="0.0" max="1.0" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white text-sm">
                                </label>
                                <label class="block">
                                    <span class="text-xs text-gray-400">Context Words</span>
                                    <input type="number" id="predContextLen" value="20" min="5" max="50" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white text-sm">
                                </label>
                                <label class="block">
                                    <span class="text-xs text-gray-400">Self-Consistency Iterations</span>
                                    <input type="number" id="predSC" value="3" min="1" max="5" disabled class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-gray-500 text-sm">
                                </label>
                            </div>
                        </div>

                        <button type="submit" id="predButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2 disabled:opacity-50 mt-4">
                            <!-- v2.9.3-en: Translated -->
                            <span id="predButtonText">Get 6 Predictions</span>
                            <div id="predLoading" class="spinner hidden"></div>
                        </button>
                    </form>

                    <!-- Custom Word Validation Area -->
                    <div class="pt-6 border-t border-gray-700 mt-6">
                        <!-- v2.9.3-en: Translated -->
                        <h2 class="text-xl font-semibold text-white mb-3">2. Custom Word Check</h2>
                        <form id="customWordForm" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <!-- v2.9.3-en: Translated -->
                                <input type="text" id="customWordInput" class="bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500" placeholder="Enter word to check (e.g., 'growth')">
                                <button type="submit" id="customButton" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2 disabled:opacity-50">
                                    <!-- v2.9.3-en: Translated -->
                                    <span id="customButtonText">Check Word</span>
                                    <div id="customLoading" class="spinner hidden"></div>
                                </button>
                            </div>
                        </form>
                        <div id="igpvlCustomError" class="text-sm rounded-lg mt-4"></div>
                        <div id="customResults" class="mt-4"></div>
                    </div>
                </div>

                <!-- Prediction Results Area -->
                <div id="predError" class="text-red-400 bg-red-900/50 p-4 rounded-lg mt-6 hidden"></div>
                <div id="predictionResults" class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Prediction result cards will be dynamically inserted here -->
                </div>
            </div>

            <!-- 2. Validation Content -->
            <div id="validationContent" class="hidden">
                <form id="validationForm" class="bg-gray-800 p-6 rounded-lg shadow-xl space-y-6">
                    <div>
                        <!-- v2.9.3-en: Translated -->
                        <label for="valInput1" class="block text-sm font-medium text-gray-300 mb-2">Collocation - Initial Phrase</label>
                        <input type="text" id="valInput1" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., make a">
                    </div>
                    <div>
                        <!-- v2.9.3-en: Translated -->
                        <label for="valInput2" class="block text-sm font-medium text-gray-300 mb-2">Collocation - Target Word/Phrase</label>
                        <input type="text" id="valInput2" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., decision">
                    </div>
                    
                    <div id="igpvlValError" class="text-sm rounded-lg"></div>

                    <button type="submit" id="valButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2 disabled:opacity-50">
                        <!-- v2.9.3-en: Translated -->
                        <span id="valButtonText">Validate Collocation</span>
                        <div id="valLoading" class="spinner hidden"></div>
                    </button>
                </form>

                <!-- Validation Results Area -->
                <div id="valError" class="text-red-400 bg-red-900/50 p-4 rounded-lg mt-6 hidden"></div>
                <div id="validationResults" class="mt-8 bg-gray-800 p-6 rounded-lg shadow-xl hidden">
                    <!-- Validation results will be dynamically inserted here -->
                </div>
            </div>

            <!-- 3. Continuation Content -->
            <div id="continuationContent" class="hidden">
                <!-- Form 1: Paragraph Continuation -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl space-y-6">
                    <!-- v2.9.3-en: Translated -->
                    <h2 class="text-xl font-semibold text-white">1. Paragraph Continuation & Analysis</h2>
                    <form id="continuationForm" class="space-y-4">
                        <div>
                            <!-- v2.9.3-en: Translated -->
                            <label for="contInput" class="block text-sm font-medium text-gray-300 mb-2">Input Paragraph</label>
                            <textarea id="contInput" rows="5" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., The silk industry has a long history in Asia..."></textarea>
                        </div>
                        
                        <!-- IGPVL Error Area -->
                        <div id="igpvlContError" class="text-sm rounded-lg"></div>

                        <button type="submit" id="contButton" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2 disabled:opacity-50">
                            <!-- v2.9.3-en: Translated -->
                            <span id="contButtonText">Predict Next Sentence & Analyze</span>
                            <div id="contLoading" class="spinner hidden"></div>
                        </button>
                    </form>
                    <!-- Continuation Results Area -->
                    <div id="contError" class="text-red-400 bg-red-900/50 p-4 rounded-lg mt-6 hidden"></div>
                    <div id="continuationResult" class="mt-6 hidden">
                        <!-- Continuation results will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Form 2: Sentence Band Prediction -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl space-y-6 mt-8">
                    <!-- v2.9.3-en: Translated -->
                    <h2 class="text-xl font-semibold text-white">2. Single Sentence Band Prediction</h2>
                    <form id="bandPredictionForm" class="space-y-4">
                        <div>
                            <!-- v2.9.3-en: Translated -->
                            <label for="bandInput" class="block text-sm font-medium text-gray-300 mb-2">Input Sentence</label>
                            <input type="text" id="bandInput" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., This process begins with the cultivation of silkworms.">
                        </div>
                        
                        <!-- IGPVL Error Area -->
                        <div id="igpvlBandError" class="text-sm rounded-lg"></div>

                        <button type="submit" id="bandButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2 disabled:opacity-50">
                            <!-- v2.9.3-en: Translated -->
                            <span id="bandButtonText">Predict Sentence Band</span>
                            <div id="bandLoading" class="spinner hidden"></div>
                        </button>
                    </form>
                    <!-- Band Prediction Results Area -->
                    <div id="bandError" class="text-red-400 bg-red-900/50 p-4 rounded-lg mt-6 hidden"></div>
                    <div id="bandPredictionResult" class="mt-6 hidden">
                        <!-- Band prediction results will be dynamically inserted here -->
                    </div>
                </div>

                <!-- === [MODIFICATION START] v2.9.3 SWOT Analysis Form === -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl space-y-6 mt-8">
                    <!-- v2.9.3-en: Translated -->
                    <h2 class="text-xl font-semibold text-white">3. Cohesion &amp; Coherence (C&C) SWOT Analysis</h2>
                    <!-- v2.9.3-en: Translated -->
                    <p class="text-sm text-gray-400">
                        Evaluates the logical coherence between the 'Previous Paragraph' and the 'Opening Sentence of the next'.
                        <br>
                        <strong class="text-teal-300">v2.9.3 Update:</strong> Enter two options, and the system will compare and analyze the best choice.
                    </p>
                    <form id="swotForm" class="space-y-4">
                        <div>
                            <!-- v2.9.3-en: Translated -->
                            <label for="swotInputParagraph" class="block text-sm font-medium text-gray-300 mb-2">Input Full Previous Paragraph</label>
                            <textarea id="swotInputParagraph" rows="5" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., ...This reliance on private vehicles has led to significant traffic congestion."></textarea>
                        </div>
                        <div>
                            <!-- v2.9.3-en: Translated -->
                            <label for="swotInputSentence1" class="block text-sm font-medium text-gray-300 mb-2">Input Next Paragraph Opening (Option 1)</label>
                            <input type="text" id="swotInputSentence1" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., However, the government has failed to invest in public transport.">
                        </div>
                        <!-- v2.9.3 Add -->
                        <div>
                            <!-- v2.9.3-en: Translated -->
                            <label for="swotInputSentence2" class="block text-sm font-medium text-gray-300 mb-2">Input Next Paragraph Opening (Option 2)</label>
                            <input type="text" id="swotInputSentence2" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., To address this issue, improving public transportation is essential.">
                        </div>
                        
                        <!-- IGPVL Error Area -->
                        <div id="igpvlSwotError" class="text-sm rounded-lg"></div>

                        <button type="submit" id="swotButton" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2 disabled:opacity-50">
                            <!-- v2.9.3-en: Translated -->
                            <span id="swotButtonText">Compare & Run SWOT Analysis</span>
                            <div id="swotLoading" class="spinner hidden"></div>
                        </button>
                    </form>
                    <!-- SWOT Results Area -->
                    <div id="swotError" class="text-red-400 bg-red-900/50 p-4 rounded-lg mt-6 hidden"></div>
                    <div id="swotResult" class="mt-6 hidden">
                        <!-- SWOT results will be dynamically inserted here -->
                    </div>
                </div>
                <!-- === [MODIFICATION END] v2.9.3 SWOT Analysis Form === -->

            </div>

        </main>
    </div>

    <!-- JavaScript Logic -->
    <script type="module">
        // --- [MODIFICATION] Gemini API Key ---
        // API Key is now read from the 'apiKeyInput' field in the HTML.
        // const apiKey = "AIzaSyAzBdrm2Ma3LWkdo87hC_TZlLPc7cuqNEo"; // Old hard-coded key
        // API URL is now dynamically constructed inside callGeminiAPI().
        // const apiUrl = `...`;
        // --- [MODIFICATION END] ---

        // --- DOM Element References ---
        const tabs = {
            prediction: document.getElementById('tabPrediction'),
            validation: document.getElementById('tabValidation'),
            continuation: document.getElementById('tabContinuation') // v2.8 Add
        };
        const contents = {
            prediction: document.getElementById('predictionContent'),
            validation: document.getElementById('validationContent'),
            continuation: document.getElementById('continuationContent') // v2.8 Add
        };
        
        // Prediction-related elements
        const predForm = document.getElementById('predictionForm');
        const predInput = document.getElementById('predInput');
        const predPos = document.getElementById('predPos');
        const predTask = document.getElementById('predTask');
        const predTemp = document.getElementById('predTemp');
        const predTopP = document.getElementById('predTopP');
        const predContextLen = document.getElementById('predContextLen'); // T1.4 Get DOM
        const predButton = document.getElementById('predButton');
        const predButtonText = document.getElementById('predButtonText');
        const predLoading = document.getElementById('predLoading');
        const predError = document.getElementById('predError');
        const predictionResults = document.getElementById('predictionResults');
        const igpvlPredError = document.getElementById('igpvlPredError'); // v2.6 IGPVL Add

        // Custom Word-related elements
        const customWordForm = document.getElementById('customWordForm');
        const customWordInput = document.getElementById('customWordInput');
        const customButton = document.getElementById('customButton');
        const customButtonText = document.getElementById('customButtonText');
        const customLoading = document.getElementById('customLoading');
        const customResults = document.getElementById('customResults');
        const igpvlCustomError = document.getElementById('igpvlCustomError'); // v2.6 IGPVL Add

        // Validation-related elements
        const valForm = document.getElementById('validationForm');
        const valInput1 = document.getElementById('valInput1');
        const valInput2 = document.getElementById('valInput2');
        const valButton = document.getElementById('valButton');
        const valButtonText = document.getElementById('valButtonText');
        const valLoading = document.getElementById('valLoading');
        const valError = document.getElementById('valError');
        const validationResults = document.getElementById('validationResults');
        const igpvlValError = document.getElementById('igpvlValError'); // v2.6 IGPVL Add
        
        // v2.8 Add: Continuation-related elements
        const continuationForm = document.getElementById('continuationForm');
        const contInput = document.getElementById('contInput');
        const contButton = document.getElementById('contButton');
        const contButtonText = document.getElementById('contButtonText');
        const contLoading = document.getElementById('contLoading');
        const igpvlContError = document.getElementById('igpvlContError');
        const contError = document.getElementById('contError');
        const continuationResult = document.getElementById('continuationResult');

        // v2.8 Add: Band Prediction-related elements
        const bandPredictionForm = document.getElementById('bandPredictionForm');
        const bandInput = document.getElementById('bandInput');
        const bandButton = document.getElementById('bandButton');
        const bandButtonText = document.getElementById('bandButtonText');
        const bandLoading = document.getElementById('bandLoading');
        const igpvlBandError = document.getElementById('igpvlBandError');
        const bandError = document.getElementById('bandError');
        const bandPredictionResult = document.getElementById('bandPredictionResult');

        // --- [MODIFICATION START] API Key Input ---
        const apiKeyInput = document.getElementById('apiKeyInput');
        // --- [MODIFICATION END] ---

        // v2.9 Add: SWOT Analysis elements
        const swotForm = document.getElementById('swotForm');
        const swotInputParagraph = document.getElementById('swotInputParagraph');
        // v2.9.3: Rename
        const swotInputSentence1 = document.getElementById('swotInputSentence1');
        // v2.9.3: Add
        const swotInputSentence2 = document.getElementById('swotInputSentence2'); 
        const swotButton = document.getElementById('swotButton');
        const swotButtonText = document.getElementById('swotButtonText');
        const swotLoading = document.getElementById('swotLoading');
        const igpvlSwotError = document.getElementById('igpvlSwotError');
        const swotError = document.getElementById('swotError');
        const swotResult = document.getElementById('swotResult');

        // T1.8 / T2.8 Fix: Regeneration history
        const regenerationHistory = {};

        // --- v2.6 IGPVL (Input Grammar Pre-Validation Layer) Schema ---
        // Schema defined according to user's v2.6 specification
        const igpvlSchema = {
            "type": "OBJECT",
            "description": "Real-time feedback from Input Grammar Pre-Validation Layer (IGPVL)",
            "properties": {
                "input_id": { "type": "STRING", "description": "Unique ID corresponding to the request" },
                "status": { "type": "STRING", "enum": ["passed", "warning", "blocked"], "description": "Validation status" },
                "error_count": { "type": "NUMBER", "description": "Total number of grammar errors detected" },
                "severity": { "type": "STRING", "enum": ["none", "minor", "major"], "description": "Overall error severity" },
                "errors": {
                    "type": "ARRAY",
                    "description": "List of detected errors",
                    "items": {
                        "type": "OBJECT",
                        "properties": {
                            "type": { "type": "STRING", "enum": ["subject_verb_agreement","tense_error","article_error","pronoun_error","number_agreement","dangling_modifier","incomplete_comparison","double_negative","inconsistent_tense_shift","spelling","contextual_spelling","capitalization_error","number_format_error","hyphenation_error","end_punctuation","internal_punctuation","quotation_marks"],"description": "Error type, must be selected from a predefined list to match the four major check categories." },
                            "message": { "type": "STRING", "description": "Description of the error" },
                            "suggestion": { "type": "STRING", "description": "Grammatically correct suggestion (can be a full sentence or fragment)" },
                            "severity": { "type": "STRING", "enum": ["minor", "major"], "description": "Severity of this error" },
                            "code": { "type": "STRING", "description": "Standard-compliant error code (e.g., 'IGPVL-CORE-XX')" }
                        },
                        "required": ["type", "message", "suggestion", "code"]
                    }
                },
                "recommendation": { "type": "STRING", "description": "Overall recommendation for the user, providing a grammatically correct sentence" },
                "timestamp": { "type": "STRING", "format": "date-time", "description": "Timestamp in ISO 8601 format" }
            },
            "required": ["input_id", "status", "error_count", "severity", "errors", "recommendation", "timestamp"]
        };

        // --- v3.0 GVL (Grammar Validation Layer) Schema ---
        // This is the *original* GVL schema for Tabs 1 & 2.
        // It will be *preserved* to maintain original functionality.
        const grammarValidationSchemaObject = {
            "type": "OBJECT",
            "description": "Detailed analysis results from Grammar Validation Layer v3.0",
            "properties": {
                "correctness": {
                    "type": "OBJECT",
                    "properties": {
                        "errors": {
                            "type": "ARRAY",
							"description": "I. Correctness (Grammar, Spelling, Punctuation). List of all 'Correctness' related grammar, spelling, punctuation errors. Empty array [] means 'Check passed'.",
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "type": { "type": "STRING", "description": "Error type (e.g., 'Subject-Verb Agreement', 'Tense Error', 'Article Error', 'Pronoun Error', 'Number Agreement', 'Dangling Modifier', 'Incomplete Comparison', 'Double Negative', 'Inconsistent Tense Shift', 'General Spelling', 'Contextual Spelling', 'Capitalization Error', 'Number Format Error', 'Hyphenation Error', 'End Punctuation Error', 'Internal Punctuation Misuse - incl. Comma/Semicolon/Colon')"},
                                    "original": { "type": "STRING", "description": "Original incorrect fragment" },
                                    "correction": { "type": "STRING", "description": "Correction suggestion" },
                                    "explanation": { "type": "STRING", "description": "Brief explanation" }
                                },
                                "required": ["type", "original", "correction"]
                            }
                        }
                    },
                    "required": ["errors"]
                },
                "clarity": {
                    "type": "OBJECT",
					"description": "II. Clarity - Suggestive",
                    "properties": {
                        "feedback": { "type": "ARRAY", "description": "Clarity issues (e.g., 'Run-on Sentence', 'Sentence Fragment', 'Wordiness', 'Fluency')", "items": { "type": "STRING" } },
                        "rewrite_suggestion": { "type": "STRING", "description": "Complete rewrite suggestion for complex sentences (empty string if none)" },
                        "passive_voice_warning": { "type": "BOOLEAN", "description": "Whether passive voice is overused" }
                    },
                    "required": ["feedback", "rewrite_suggestion", "passive_voice_warning"]
                },
                "engagement": {
                    "type": "OBJECT",
                    "properties": {
                        "feedback": { "type": "ARRAY", "description": "Engagement issues (e.g., 'Monotonous Vocabulary', 'Repetitive Sentence Structure')", "items": { "type": "STRING" } },
                        "vocab_suggestions": {
                            "type": "ARRAY",
							"description": "Vocabulary enhancement suggestions (replace dull or overused words)",
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "original": { "type": "STRING" },
                                    "suggestion": { "type": "STRING" }
                                },
                                "required": ["original", "suggestion"]
                            }
                        }
                    },
                    "required": ["feedback", "vocab_suggestions"]
                },
                "delivery": {
                    "type": "OBJECT",
					"description": "IV. Delivery / Tone",
                    "properties": {
                        "detected_tone": { "type": "STRING", "description": "Detected tone" },
                        "formality": { "type": "STRING", "description": "Formality (e.g., 'Formal', 'Informal', 'Colloquial')" },
                        "inclusive_language_warning": { "type": "BOOLEAN", "description": "Whether non-inclusive language is present" }
                    },
                    "required": ["detected_tone", "formality", "inclusive_language_warning"]
                }
            },
            "required": ["correctness", "clarity", "engagement", "delivery"]
        };
        
        // --- v2.8 GVL Schema (NEW) ---
        // This is the new schema from the v2.8 spec (Section VIII).
        // It will be used ONLY for the new Continuation Tab (Tab 3).
        const v2_8_Schema = {
            "type": "OBJECT",
            "description": "Full analysis report based on v2.8 specification.",
            "properties": {
                "input_text": { "type": "STRING", "description": "The user's original input text." },
                "correctness": {
                    "type": "OBJECT",
                    "description": "GVL/GCE Layer. Errors MUST be corrected by GCE.",
                    "properties": {
                        "errors": {
                            "type": "ARRAY",
                            "description": "List of errors detected by GVL. Must be empty if GCE passed.",
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "code": { "type": "STRING", "description": "e.g., GVL-NAC-01" },
                                    "message": { "type": "STRING", "description": "Error description." },
                                    "suggestion": { "type": "STRING", "description": "Correction." }
                                },
                                "required": ["code", "message", "suggestion"]
                            }
                        },
                        "validated": { "type": "BOOLEAN", "description": "Must be true if GCE pass." }
                    },
                    "required": ["errors", "validated"]
                },
                "clarity": {
                    "type": "OBJECT",
                    "description": "Clarity Layer.",
                    "properties": {
                        "rewrite_suggestion": { "type": "STRING", "description": "Suggestion for wordiness, fluency, etc." },
                        "fluency_feedback": { "type": "STRING", "description": "Feedback on flow." }
                    },
                    "required": ["rewrite_suggestion", "fluency_feedback"]
                },
                "engagement": {
                    "type": "OBJECT",
                    "description": "Engagement Layer.",
                    "properties": {
                        "vocab_suggestions": {
                            "type": "ARRAY",
                            "description": "Suggestions for dull words.",
                            "items": { "type": "STRING" }
                        },
                        "feedback": { "type": "STRING", "description": "Feedback on repetitive structure." }
                    },
                    "required": ["vocab_suggestions", "feedback"]
                },
                "delivery": {
                    "type": "OBJECT",
                    "description": "Delivery & Tone Layer.",
                    "properties": {
                        "detected_tone": { "type": "STRING", "enum": ["Formal", "Neutral", "Friendly"] },
                        "formality": { "type": "STRING", "description": "Formality level." },
                        "inclusive_language_warning": { "type": "BOOLEAN" }
                    },
                    "required": ["detected_tone", "formality", "inclusive_language_warning"]
                },
                "continuation": {
                    "type": "OBJECT",
                    "description": "Continuation Module (User Story 3).",
                    "properties": {
                        "predicted_sentence": { "type": "STRING", "description": "Predicted next sentence (must pass GVL/GCE)." },
                        "band_prediction": { "type": "NUMBER", "description": "IELTS Band prediction (e.g., 8.0)." }
                    },
                    "required": ["predicted_sentence", "band_prediction"]
                },
                "validation_result": { "type": "STRING", "enum": ["Passed"], "description": "Must be 'Passed' after GCE." }
            },
            "required": ["input_text", "correctness", "clarity", "engagement", "delivery", "continuation", "validation_result"]
        };

        // v2.8 Add: Schema for *only* Band Prediction
        const bandPredictionSchema = {
            "type": "OBJECT",
            "description": "Band prediction for a single sentence.",
            "properties": {
                "band_prediction": { "type": "NUMBER", "description": "IELTS Band prediction (e.g., 8.0)." },
                "validation_result": { "type": "STRING", "enum": ["Passed"], "description": "Grammar validation result." }
            },
            "required": ["band_prediction", "validation_result"]
        };

        // v2.9 Add: Schema for SWOT Analysis
        const swotSchema = {
            "type": "OBJECT",
            "description": "SWOT analysis of paragraph-to-sentence cohesion based on IELTS Cohesion & Coherence criteria.",
            "properties": {
                "strengths": {
                    "type": "ARRAY",
                    "description": "Strengths (S): Positive cohesion/coherence links.",
                    "items": { "type": "STRING" }
                },
                "weaknesses": {
                    "type": "ARRAY",
                    "description": "Weaknesses (W): Errors or poor links in cohesion/coherence.",
                    "items": { "type": "STRING" }
                },
                "opportunities": {
                    "type": "ARRAY",
                    "description": "Opportunities (O): Specific suggestions for improvement.",
                    "items": { "type": "STRING" }
                },
                "threats": {
                    "type": "ARRAY",
                    "description": "Threats (T): Risks/warnings if weaknesses persist.",
                    "items": { "type": "STRING" }
                },
                "overall_assessment": {
                    "type": "STRING",
                    "description": "A brief summary of the connection's quality."
                },
                "cohesion_band_estimate": {
                    "type": "NUMBER",
                    "description": "Estimated IELTS C&C band score (5.0-9.0) for this specific transition."
                }
            },
            "required": ["strengths", "weaknesses", "opportunities", "threats", "overall_assessment", "cohesion_band_estimate"]
        };
        
        // v2.9.3 Add: Schema for SWOT Comparison
        const swotComparisonSchema = {
            "type": "OBJECT",
            "description": "Compares two opening sentences for C&C against a paragraph.",
            "properties": {
                "best_option_index": { 
                    "type": "NUMBER", 
                    "description": "Index of the better sentence (0 for Option 1, 1 for Option 2)." 
                },
                "comparison_reason": { 
                    "type": "STRING", 
                    "description": "Detailed reason why the best option is better, citing C&C principles (e.g., 'Option 2 provides a clearer lexical link ('this issue') to the paragraph's topic...')."
                },
                "worst_option_feedback": {
                    "type": "STRING",
                    "description": "Brief C&C feedback on the weaker option (e.g., 'Option 1 felt abrupt.')"
                }
            },
            "required": ["best_option_index", "comparison_reason", "worst_option_feedback"]
        };


        // --- Core Helper Functions ---

        /**
         * T1.4 Fix: Truncate context to the last N words
         * @param {string} text - Full input text
         * @param {number} wordCount - Number of last words to keep
         * @returns {string} - Truncated text
         */
        function truncateContext(text, wordCount) {
            if (!text) return "";
            const words = text.trim().split(/\s+/); // Split by whitespace
            const count = parseInt(wordCount, 10) || 20; // Default 20
            
            if (words.length <= count) {
                return text.trim(); // No truncation needed
            }
            
            return words.slice(-count).join(' '); // Take last N words
        }

        /**
         * Get Band commentary based on PPL (Cohesion & Coherence)
         * @param {number} ppl - Perplexity
         * @returns {object} - { band, summary, color }
         */
        function getCohesionBandDetails(ppl) {
            if (ppl <= 20) {
                return { band: 9, summary: 'Fluent, natural cohesion, extremely high coherence.', color: 'bg-indigo-600' };
            } else if (ppl <= 40) {
                return { band: 8, summary: 'Clear structure, smooth cohesion, only occasional minor unnaturalness.', color: 'bg-purple-600' };
            } else if (ppl <= 60) {
                return { band: 7, summary: 'Coherent but slightly mechanical; some connectors or references are imprecise.', color: 'bg-blue-600' };
            } else if (ppl <= 80) {
                return { band: 6, summary: 'Overall logic exists, but discourse cohesion is occasionally unbalanced or repetitive.', color: 'bg-yellow-600' };
            } else {
                return { band: 5, summary: 'Loose structure, lacking natural or overly mechanical links between sentences.', color: 'bg-red-600' };
            }
        }

        /**
         * [S_Naturalness v2.1 Revised]
         * Get Band commentary based on S_Naturalness (Lexical Resource)
         * @param {number} s - S_Naturalness score
         * @returns {object} - { band, summary, color }
         */
        function getLexicalBandDetails(s) {
             if (s >= 0.85) {
                return { band: 9, summary: 'Completely natural, very high collocation strength; near-native expression.', color: 'bg-indigo-600' };
            } else if (s >= 0.75) {
                return { band: 8, summary: 'Fluent and flexible, minor misuse; still high-level collocation.', color: 'bg-purple-600' };
            } else if (s >= 0.60) {
                return { band: 7, summary: 'Understandable and common, but slightly mechanical or repetitive.', color: 'bg-blue-600' };
            } else if (s >= 0.40) {
                return { band: 6, summary: 'Moderate naturalness; meaning is clear but collocation is not idiomatic.', color: 'bg-yellow-600' };
            } else {
                // S < 0.40
                return { band: 5, summary: 'Unnatural or awkward; replacement suggested.', color: 'bg-red-600' };
            }
        }

        /**
         * Highlight a phrase within an example sentence
         * @param {string} text - The full example sentence
         * @param {string} phraseToHighlight - The phrase to highlight
         * @returns {string} - String containing HTML <span class="highlight">
         */
        function highlight(text, phraseToHighlight) {
            if (!text || !phraseToHighlight) return text;
            // Replace all non-word characters with whitespace to ensure correct word boundary matching
            const cleanedPhrase = phraseToHighlight.trim().replace(/[\W_]+/g,"\\s*");
            // Use regex for case-insensitive replacement
            const regex = new RegExp(`(${cleanedPhrase})`, 'gi');
            
            // Use match function to preserve original case
            return text.replace(regex, (match, p1) => {
                // p1 is the original matched group, ensure we only highlight this part
                return `<span class="highlight">${match}</span>`;
            });
        }

        /**
         * v3.0: Render HTML report for Grammar Validation Layer (Tabs 1 & 2)
         * @param {object} validation - grammar_validation object
         * @returns {string} - Formatted HTML
         */
        function renderGrammarValidation(validation) {
            if (!validation) {
                return '<div class="text-xs text-red-400">Grammar validation data missing.</div>';
            }

            let html = '<div class="space-y-2 mt-2 pt-2 border-t border-gray-600 text-xs text-left">'; // Change to text-left
            
            // I. Correctness
            const { correctness, clarity, engagement, delivery } = validation;
            html += '<h5 class="font-semibold text-gray-300">Grammar Validation Report (v3.1)</h5>';
            
            if (correctness && correctness.errors && correctness.errors.length > 0) {
                html += `<div class="text-yellow-400">I. Correctness: ${correctness.errors.length} critical error(s) found</div>`;
                html += '<ul class="list-disc list-inside text-gray-400 pl-2">';
                correctness.errors.slice(0, 10).forEach(err => { // Show max 10
                    html += `<li>[${err.type}] <strong>"${err.original}"</strong> &rarr; <strong>"${err.correction}"</strong></li>`;
                });
                html += '</ul>';
            } else {
                html += '<div class="text-green-400">I. Correctness: Check passed.</div>';
            }

            // II. Clarity
            if (clarity && (clarity.feedback.length > 0 || clarity.rewrite_suggestion || clarity.passive_voice_warning)) {
                html += `<div class="text-blue-300 mt-1">II. Clarity:</div>`;
                html += '<ul class="list-disc list-inside text-gray-400 pl-2">';
                clarity.feedback.slice(0, 10).forEach(fb => html += `<li>${fb}</li>`); // Max 10
                if (clarity.passive_voice_warning) html += '<li>Note: Excessive use of passive voice.</li>';
                if (clarity.rewrite_suggestion) html += `<li>Rewrite Suggestion: <span class="text-blue-200">${clarity.rewrite_suggestion}</span></li>`;
                html += '</ul>';
            } else {
                html += '<div class="text-green-400">II. Clarity: Check passed.</div>';
            }

            // III. Engagement
            if (engagement && (engagement.feedback.length > 0 || engagement.vocab_suggestions.length > 0)) {
                html += `<div class="text-purple-300 mt-1">III. Engagement:</div>`;
                html += '<ul class="list-disc list-inside text-gray-400 pl-2">';
                engagement.feedback.slice(0, 10).forEach(fb => html += `<li>${fb}</li>`);
                engagement.vocab_suggestions.slice(0, 1).forEach(vs => html += `<li>Vocab Suggestion: ${vs.original} &rarr; ${vs.suggestion}</li>`);
                html += '</ul>';
            }

            // IV. Delivery
            if (delivery) {
                html += `<div class="text-gray-300 mt-1">IV. Tone: ${delivery.detected_tone} | Formality: ${delivery.formality}</div>`;
                if(delivery.inclusive_language_warning) html += '<div class="text-yellow-400">Note: Contains non-inclusive language.</div>';
            }

            html += '</div>';
            return html;
        }

        // v2.8 Add: Render HTML report for *new* v2.8 Schema (Tab 3)
        function renderV2_8_Validation(result) {
            let html = '<div class="space-y-3 mt-4 pt-4 border-t border-gray-600 text-sm">';
            
            const { correctness, clarity, engagement, delivery } = result;

            // I. Correctness (GVL / GCE)
            html += '<h5 class="font-semibold text-white">I. Correctness (GVL/GCE)</h5>';
            if (correctness && correctness.errors.length === 0 && correctness.validated) {
                html += '<p class="text-green-400">âœ… Grammar Check Passed (GCE Validated).</p>';
            } else {
                html += `<p class="text-yellow-400">âš ï¸ ${correctness.errors.length} error(s) found by GVL:</p>`;
                html += '<ul class="list-disc list-inside text-gray-400 pl-2 text-xs">';
                correctness.errors.forEach(err => {
                    html += `<li>[${err.code}] ${err.message} &rarr; <strong>${err.suggestion}</strong></li>`;
                });
                html += '</ul>';
            }

            // II. Clarity
            html += '<h5 class="font-semibold text-white mt-3">II. Clarity</h5>';
            html += `<p class="text-gray-300"><strong>Fluency:</strong> ${clarity.fluency_feedback || 'N/A'}</p>`;
            if (clarity.rewrite_suggestion) {
                html += `<p class="text-gray-300"><strong>Rewrite Suggestion:</strong> <span class="text-blue-300">${clarity.rewrite_suggestion}</span></p>`;
            }

            // III. Engagement
            html += '<h5 class="font-semibold text-white mt-3">III. Engagement</h5>';
            html += `<p class="text-gray-300"><strong>Feedback:</strong> ${engagement.feedback || 'N/A'}</p>`;
            if (engagement.vocab_suggestions && engagement.vocab_suggestions.length > 0) {
                html += `<p class="text-gray-300"><strong>Vocabulary:</strong> Suggests replacing: <span class="text-purple-300">${engagement.vocab_suggestions.join(', ')}</span></p>`;
            }

            // IV. Delivery
            html += '<h5 class="font-semibold text-white mt-3">IV. Delivery (Tone)</h5>';
            let deliveryInfo = `<strong>Detected Tone:</strong> ${delivery.detected_tone} | <strong>Formality:</strong> ${delivery.formality}`;
            if (delivery.inclusive_language_warning) {
                deliveryInfo += ` | <span class="text-yellow-400">Inclusive Language Warning!</span>`;
            }
            html += `<p class="text-gray-300">${deliveryInfo}</p>`;
            
            html += '</div>';
            return html;
        }


        // --- API Call Logic ---

        /**
         * Call the Gemini API
         * @param {string} userApiKey - [MODIFIED] The API key from the input field
         * @param {string} systemPrompt - System Instruction
         * @param {string} userQuery - User Query
         * @param {object|null} schema - JSON output schema (if needed)
         * @param {number} temperature - Sampling temperature
         * @param {number} topP - Top-P sampling parameter
         * @param {number} maxRetries - Maximum retry attempts
         * @returns {Promise<object>} - API response or error object
         */
        // --- [MODIFICATION START] Added userApiKey parameter ---
        async function callGeminiAPI(userApiKey, systemPrompt, userQuery, schema = null, temperature = 0.7, topP = 0.95, maxRetries = 3) {
            
            // --- [MODIFICATION] Dynamically build API URL ---
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`;
            // --- [MODIFICATION END] ---

			// ===============================================
			// ðŸš¨ This is your checkpoint: Print Prompt content for AI
			// ===============================================
			console.log("--- Sending System Prompt to AI ---");
			console.log(systemPrompt);
			console.log("----------------------------------");
			
			console.log("--- Sending User Query to AI ---");
			console.log(userQuery);
			console.log("-------------------------------");
			
			// Since your System Prompt is very long, you can print them together
			console.log("--- Full API Request Payload (Debug) ---");
			
			const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };
            
            const generationConfig = {
                temperature: parseFloat(temperature),
                topP: parseFloat(topP),
            };

            if (schema) {
                generationConfig.responseMimeType = "application/json";
                generationConfig.responseSchema = schema;
            }
            payload.generationConfig = generationConfig;
            
            // Print the entire payload object
			console.log(JSON.stringify(payload, null, 2));
			console.log("----------------------------------------------");

            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, { // [MODIFIED] Uses dynamic apiUrl
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // [MODIFIED] Improved error handling for 400 (Bad Request), often API key related
                        if (response.status === 400) {
                             const errorData = await response.json();
                             throw new Error(`API request failed (Status 400 - Bad Request). Check API Key or model access. Details: ${errorData?.error?.message || 'No details'}`);
                        }
                        throw new Error(`API request failed, status code: ${response.status}`);
                    }

                    const result = await response.json();
					
                    const candidate = result.candidates?.[0];

                    if (!candidate || !candidate.content?.parts?.[0]) {
                        // [MODIFIED] Handle safety blocks
                        if (candidate?.finishReason === 'SAFETY') {
                            throw new Error("API call blocked due to safety settings (Finish Reason: SAFETY).");
                        }
                        throw new Error("API returned an invalid response structure or was filtered.");
                    }

                    const part = candidate.content.parts[0];
                    
                    if (schema) {
                        // Handle JSON response
                        const jsonText = part.text;
                        return JSON.parse(jsonText);
                    } else {
                        // Handle plain text response
                        return part.text;
                    }

                } catch (error) {
                    console.error(`API call attempt ${attempt} failed:`, error);
                    if (attempt === maxRetries) {
                        return { isError: true, message: `API request failed: ${error.message}` };
                    }
                    // Exponential backoff
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                }
            }
        }

        // --- v2.6 IGPVL (Input Grammar Pre-Validation Layer) Logic ---

        /**
         * Execute IGPVL check (Simulates API call)
         * @param {string} userApiKey - [MODIFIED] The API key
         * @param {string} text - The full text to check
         * @param {string} inputId - ID of the calling source
         * @param {string} context - Writing context (e.g., 'academic')
         * @returns {Promise<object>} - Object matching igpvlSchema or an error
         */
        // --- [MODIFICATION START] Added userApiKey parameter ---
        async function validateInputGrammar(userApiKey, text, inputId, context) {
            
            // v2.6 IGPVL System Prompt
			const systemPrompt = `You are a specialized and strict "Input Grammar Pre-Validation Layer (IGPVL) v2.6".
Your absolute sole task is to analyze the user's input text and return only one valid JSON object according to the v2.6 specification.
You are absolutely forbidden from outputting any additional text, notes, or explanations outside the JSON.

You must perform all four check categories and strictly flag all errors:
1. Core Grammar (IGPVL-CORE-XX): Subject-verb agreement, Tense, Articles, Pronouns, Number agreement.
2. Advanced Grammar (IGPVL-ADV-XX): Dangling modifiers, Incomplete comparisons, Double negatives, Inconsistent tense shifts, Semantic Collocation Errors, improper Subject/Verb pairings, or improper coordination of non-parallel elements (e.g., 'a linear and five-step process').
3. Spelling & Consistency (IGPVL-SPC-XX): Spelling errors, Contextual spelling (e.g., their/there), Capitalization, Number formats, Hyphenation.
4. Punctuation (IGPVL-PUN-XX): Only when the last character of the input is a punctuation mark, check end punctuation, comma/semicolon/colon misuse.
   Mandatory Exception Rule: If the input is judged to be a fragment or phrase (not a complete statement or question), do NOT flag an 'end_punctuation' error.

Rules:
- Maximum strictness check: Flag even minor errors (e.g., 'He go').
- Error count (error_count) must precisely reflect the length of the 'errors' array.
- Validation mechanism (status & severity):
   * error_count = 0: status = 'passed', severity = 'none', recommendation = 'Grammar correct, ready to generate.'
   * 1 <= error_count <= 3: status = 'warning', severity = 'minor', recommendation = 'Detected \${error_count} minor errors. Please review suggestions. Generation is permitted.'
   * error_count > 3: status = 'blocked', severity = 'major', recommendation = 'Detected \${error_count} major errors. Please correct the input and try again.'
- Error codes: 'code' field must follow specifications (e.g., 'IGPVL-CORE-01', 'IGPVL-SPC-01').
- Timestamp: must provide the current UTC time in ISO 8601 format.
- Absolute prohibition: Your response must not contain any text other than the JSON.

Each error object must contain:
{
  "code": string,              // e.g., "IGPVL-CORE-01"
  "category": string,          // one of ["core", "advanced", "spelling", "punctuation"]
  "message": string,           // clear error description
  "span": {                   // error range in user input (character indexes)
    "start": integer,
    "end": integer
  },
  "confidence": number,        // float between 0 and 1, representing confidence level
  "evidence_type": string      // one of ["rules", "case", "embedding"] indicating source of evidence
}

The JSON object must include top-level fields:
{
  "status": string,            // "passed", "warning", "blocked"
  "severity": string,          // "none", "minor", "major"
  "error_count": integer,      // count of errors detected
  "errors": array of error objects,
  "recommendation": string,
  "timestamp": string          // ISO 8601 UTC timestamp, e.g., "2025-11-04T00:00:00Z"
}


{
  "IGPVL-CORE-01": {
    "category": "core",
    "description": "Subject-verb agreement error",
    "example_incorrect": "She go to school.",
    "example_correct": "She goes to school."
  },
  "IGPVL-CORE-02": {
    "category": "core",
    "description": "Incorrect verb tense",
    "example_incorrect": "He eat breakfast yesterday.",
    "example_correct": "He ate breakfast yesterday."
  },
  "IGPVL-ADV-01": {
    "category": "advanced",
    "description": "Dangling modifier",
    "example_incorrect": "Walking down the street, the car almost hit me.",
    "example_correct": "Walking down the street, I almost got hit by a car."
  },
  "IGPVL-ADV-05": {
    "category": "advanced",
    "description": "Semantic collocation or improper coordination error",
    "example_incorrect": "Make a photo. / A linear and five-step process.",
    "example_correct": "Take a photo. / A linear, five-step process."
  },
  "IGPVL-SPC-02": {
    "category": "spelling",
    "description": "Contextual spelling error",
    "example_incorrect": "Their going to the park.",
    "example_correct": "They're going to the park."
  },
  "IGPVL-PUN-01": {
    "category": "punctuation",
    "description": "Missing end punctuation",
    "example_incorrect": "How are you",
    "example_correct": "How are you?"
  }
}

If the first attempt outputs an invalid JSON, rewrite once to valid JSON without changing the error detections or judgments.`;
            

            const userQuery = `
{
  "input_id": "${inputId}",
  "text": "${text}",
  "context": "${context}",
  "language": "en",
  "validation_mode": "strict"
}
`;
            // Use 0.1 temperature to ensure stability and consistency of IGPVL check
            // --- [MODIFICATION START] Pass userApiKey ---
            const result = await callGeminiAPI(userApiKey, systemPrompt, userQuery, igpvlSchema, 0.1, 1.0);
            // --- [MODIFICATION END] ---
            
            // Ensure timestamp exists (model sometimes forgets)
            if (result && !result.isError && !result.timestamp) {
                result.timestamp = new Date().toISOString();
            }
            return result;
        }

        /**
         * Display IGPVL feedback on the UI
         * @param {HTMLElement} el - The DOM element to display feedback in
         * @param {object} result - The result object from validateInputGrammar
         * @returns {boolean} - Whether the flow was blocked (isBlocked)
         */
        function displayIgpvlFeedback(el, result) {
            el.innerHTML = '';
            
            if (result.isError) {
                el.className = 'text-sm p-3 rounded-lg bg-red-900/50 text-red-400';
                // v2.9.3-en: Translated
                el.innerHTML = `<strong>IGPVL Check Failed:</strong> ${result.message}`;
                return true; // Block flow
            }

            // Note: result.recommendation and result.message are already in English
            // as per the System Prompt.
            if (result.status === 'blocked') {
                el.className = 'text-sm p-3 rounded-lg bg-red-900/50 text-red-400 space-y-2';
                let html = `<p class="font-semibold">${result.recommendation}</p>`;
                html += '<ul class="list-disc list-inside text-xs">';
                result.errors.forEach(err => {
                    html += `<li>[${err.code}] ${err.message} (Suggestion: <strong>${err.suggestion}</strong>)</li>`;
                });
                html += '</ul>';
                el.innerHTML = html;
                return true; // Block flow
            
            } else if (result.status === 'warning') {
                el.className = 'text-sm p-3 rounded-lg bg-yellow-900/50 text-yellow-400 space-y-2';
                let html = `<p class="font-semibold">${result.recommendation}</p>`;
                html += '<ul class="list-disc list-inside text-xs">';
                result.errors.forEach(err => {
                    html += `<li>[${err.code}] ${err.message} (Suggestion: <strong>${err.suggestion}</strong>)</li>`;
                });
                html += '</ul>';
                el.innerHTML = html;
                return false; // Do not block
            
            } else {
                // 'passed'
                el.className = 'text-sm p-3 rounded-lg bg-green-900/50 text-green-400';
                el.innerHTML = `<p class="font-semibold">${result.recommendation}</p>`;
                return false; // Do not block
            }
        }


        // --- Prediction Tab Logic (Unchanged) ---

        // v3.0 Update: Use v3.0 Grammar Validation Layer Schema
        const predictionSchema = {
            type: "ARRAY",
            maxItems: 6,
            items: {
                type: "OBJECT",
                properties: {
                    "word": { "type": "STRING", "description": "Predicted next word" },
                    "p_w_n": { "type": "NUMBER", "description": "Conditional probability P(w_n | context), between 0 and 1" },
                    "ppl": { "type": "NUMBER", "description": "Perplexity of the example sentence" },
                    "band": { "type": "NUMBER", "description": "Corresponding IELTS Cohesion & Coherence Band (5, 6, 7, 8, or 9)" },
                    "band_summary": { "type": "STRING", "description": "IELTS examiner-style summary description (based on PPL coherence assessment)" },
                    "example": { "type": "STRING", "description": "Example sentence, max 25 words" },
                    "consistency_score": { "type": "NUMBER", "description": "Semantic consistency score (0-100)" },
                    "grammar_validation": grammarValidationSchemaObject // v3.0 Replace
                },
                required: ["word", "p_w_n", "ppl", "band", "band_summary", "example", "consistency_score", "grammar_validation"] // v3.0 Replace
            }
        };
        
        async function handlePredictionSubmit(e) {
            e.preventDefault();

            // --- [MODIFICATION START] Get API Key First ---
            const userApiKey = apiKeyInput.value.trim();
            if (!userApiKey) {
                // v2.9.3-en: Translated
                displayError(predError, "API key is empty. Please provide a valid API key in the field above.", predLoading, predButton, predButtonText, "Get 6 Predictions");
                // Clear any old IGPVL errors
                igpvlPredError.innerHTML = '';
                igpvlPredError.className = 'text-sm rounded-lg';
                return;
            }
            // --- [MODIFICATION END] ---

            const phrase = predInput.value.trim();
            
            // v2.6 IGPVL Integration: Clear old messages
            igpvlPredError.innerHTML = '';
            igpvlPredError.className = 'text-sm rounded-lg';
            predError.classList.add('hidden'); // Hide old generation errors
            predictionResults.innerHTML = ''; // Clear old results

            if (!phrase) {
                // v2.9.3-en: Translated
                displayError(predError, "Please enter an English phrase.", predLoading, predButton, predButtonText, "Get 6 Predictions");
                return;
            }

            // Set UI to loading (v2.6: Before IGPVL)
            // v2.9.3-en: Translated
            displayLoading(predError, predLoading, predButton, predButtonText, "1/2 Validating Input...");

            // --- v2.6 IGPVL Execution ---
            // --- [MODIFICATION START] Pass userApiKey ---
            const igpvlResult = await validateInputGrammar(userApiKey, phrase, 'predInput', 'academic');
            // --- [MODIFICATION END] ---
            const isBlocked = displayIgpvlFeedback(igpvlPredError, igpvlResult);

            if (isBlocked) {
                // v2.9.3-en: Translated
                displayDone(predLoading, predButton, predButtonText, "Get 6 Predictions");
                return; // Stop execution
            }
            // --- IGPVL End ---

            // Set UI to loading (v2.6: Update status)
            // v2.9.3-en: Translated
            displayLoading(predError, predLoading, predButton, predButtonText, "2/2 Generating Predictions...");

            // Prepare API request
            const posFilter = predPos.value === 'any' ? 'Any POS' : predPos.value;
            const taskContext = predTask.value === 'general' ? 'General Writing' : `IELTS ${predTask.value}`;
            const temp = predTemp.value;
            const topP = predTopP.value;
            // T1.4 Fix: Read and truncate context
            const contextLen = predContextLen.value;
            const truncatedPhrase = truncateContext(phrase, contextLen);

            // v3.0 (User Custom) Update: Strictly implement Grammar Validation Layer
			// Prompt optimization log: https://gemini.google.com/share/c74d88da14dc
            const systemPrompt = `You are a versatile writing style assistant (IELTS & Technical Writing). Your task is to predict the 6 most common and natural next words based on the user's input phrase, adhering to the highest academic standards (IELTS) or the highest clarity standards (Tech Guide).

[Internal Reference: English Sentence Definition]: **A complete English sentence must contain a subject and a predicate, express a complete thought (independent clause), begin with a capital letter, and end with a period, question mark, or exclamation mark.** This reference will be used for the strict check in Rule 8.

Rules:
0. [**POS Constraint & Interpretation**]: The predicted 'predicted_word' must strictly belong to the user-specified Part of Speech (POS) class (e.g., if POS='Adjective', the word must be an adjective). **CRITICAL VERB CONSTRAINT: If the POS is Verb (V), the predicted word MUST be an inflected form or the base form of the verb (e.g., 'begins', 'requires', 'was', 'is'). It must NOT be a Gerund (V-ing), a Participle (V-ing/V-ed) used adjectivally/adverbially, or an Infinitive ('to' + V).** The model must ensure the grammatical function of the predicted word is correct in the generated 'example' sentence.

1.  [**Input Validation & Correction**]: **If the user's input phrase contains basic spelling or severe grammatical errors** (e.g., 'cycly' or 'the lives are'), **you must provide the corrected phrase in the 'initial_phrase_correction' field of the output JSON** (e.g., 'the life cycle ends,'), and use this corrected phrase as the context for all predictions. If the input is correct, return an empty string.

2.  [ðŸ”¥ **Task Style Constraint (Core Optimization)**]: Must strictly adhere to the user-specified 'POS' and 'Task' context when generating 'example' sentences.
    a.  **If Task = Task 1 (Chart Description):** 'example' must be **Formal**, **Objective**, and **Academic**. The tone must be **Neutral**, focusing on describing data, trends, or comparisons (e.g., *soared, plummeted, whereas, significantly*). **Absolutely prohibit** any subjective or emotional expressions like "I think", "In my opinion".
    b.  **If Task = Task 2 (Argumentative Essay):** 'example' must be **Formal** or **Semi-formal**, with a **Persuasive** or **Analytical** tone. Sentences should focus on logical arguments, cause-and-effect, or presenting formal viewpoints (e.g., *consequently, It is widely argued that, however*). **Must avoid** colloquial expressions or contractions (like "don't").
    c.  **If Task = 'Tech Guide' (Technical Manual):** 'example' must be **Clear**, **Direct**, and **Instructional**. The tone must be **objective and focused on instructions**.
        * **(i) Core Requirement:** Sentences **must** prioritize the **Imperative mood** (e.g., "**Click** the button") or **Active Voice in the second person** (e.g., "**You** must **enter** the password").
        * **(ii) Formatting Conventions:** Must strictly use technical writing formats: **Use Bold for UI elements** (e.g., **Save** button, **File** menu); **Use Monospace/Code font for code, commands, or paths** (e.g., 'npm install', 'C:\\ProgramData').
        * **(iii) Absolute Prohibition:** Must **strictly avoid** using the **Passive Voice** (e.g., "The button is clicked by...") or **vague, suggestive language** (e.g., "You might want to...", "It is possible to...").

3.  [**Absolute Rule**]: 'All' 'example' sentences you generate 'must' undergo the 'thorough and strict' check by the GVL (Grammar Validation Layer) in point 8 below. **This check is mandatory and cannot be skipped or done superficially**.
4.  For each predicted word, provide 'Conditional Probability P(w_n | context)', 'Concise Example (example)', 'Perplexity (ppl)', and 'IELTS Cohesion & Coherence Band Assessment'.
5.  [PPL-Band Mapping]: PPL 0â€“20=Band 9, 21â€“40=Band 8, 41â€“60=Band 7, 61â€“80=Band 6, >80=Band 5.
6.  [Key Point] In the example sentence, the predicted word must "closely and uniquely" follow the "last word" of the user's input phrase. If the last character of the user's input phrase is punctuation, the predicted word must "closely and uniquely" follow the punctuation mark, separated by a single space.
7.  Simulate three rounds of Self-Consistency sampling for each example generation to ensure semantic stability, and provide a "consistency_score" (0-100) for each generation.

8.  [Grammar Validation Layer (Latest Spec)]: âœ¨ Ultimate Validation Standard
**This is the most important step.** Perform an **absolutely strict** grammar validation on the generated 'example' and fill in the 'grammar_validation' object.

    a.  [I. Correctness (Strict Correctness)]: (ðŸ”¥ Strictly Reinforced - **Includes syntax and Task compliance errors**)
    The 'correctness.errors' array 'must' contain all detected errors. **This includes the most minor errors, as well as major syntax errors (like comma splices/fragments)**. If no errors, must return an empty array [].
        * **Core Grammar:** Subject-verb agreement, Basic tense errors, Pronoun case, Article errors (**redundant, missing, or misused**), Noun number.
        * **Complex Grammar/Syntax:** Dangling modifiers, Inconsistent tense shifts, Double negatives, Parallel structure errors, **Run-on sentences, Comma Splices, Sentence Fragments**.
        * **Spelling:** Basic spelling, Contextual spelling, Capitalization/Number format, Hyphenation/Dashes.
        * **Punctuation:** Basic punctuation, Advanced punctuation (semicolons, colon structure, quotation mark conventions). **CRITICAL CHECK: Must strictly detect commas that incorrectly separate a subject from its verb, a verb from its object, or a preposition from its object** (e.g., 'selection, of the raw cocoons').
        * **(ðŸ”¥) Task Compliance (General):** Must strictly check for basic violations of **Rule 2** Task style.
            * **Task 1 Violation (Critical):** Detected any subjective expression (e.g., "I think", "In my opinion", "feels"). Error 'type' should be "Task 1 Violation".
            * **Task 2 Violation (High):** Detected colloquial contractions (e.g., "don't", "it's") or
overly informal vocabulary. Error 'type' should be "Formality Violation".
            * **Tech Guide Violation (High):** Detected **passive voice** (e.g., "The file is saved by..."), **vague/non-instructional language** (e.g., "It is recommended to..."), or **missing UI/Code formatting** (e.g., failing to mark 'Save button' as '**Save** button'). Error 'type' should be "Tech Guide Violation".
			
			**(ðŸ”¥) Task Compliance (Band 8+ Style Hardening):**
            * **Style Error (High - Collocation):** For Task 1 process descriptions, if the phrase \"starts from\" or \"begins at\" is used instead of the more academic and fixed collocation \"begins with\" or \"commences with\", mark as a 'Style/Collocation Error'.
            * **Style Error (High - Parallel/Conciseness):** Detected an incorrect parallel structure in an adjective list, specifically using the conjunction 'and' between two non-coordinate adjectives (e.g., 'a linear and five-step process' should be 'a linear, five-step process'). Mark this as a 'Style/Parallel Error'.
            * **Style Error (Low - Conciseness):** For Task 1 process descriptions referring to general raw materials (e.g., 'silkworm cocoons', 'wheat'), mark the use of the definite article 'the' (e.g., 'the silkworm cocoons') as a 'Style/Conciseness Error' for being unnaturally descriptive where the generic term should be used.
        **(Note: Individual error suggestions are now replaced by the holistic 'rewrite_suggestion' in Rule 8b.)**

    b.  [II. Clarity]: (ðŸ’¡ Suggestive Reinforcement - Focus on style, brevity, and semantics)
    Provide "suggestions". **Does not handle Level I syntax errors**.
        * **Optimization:** Provide brevity suggestions (wordiness), detect overuse of passive voice (a suggestion in Task 1/2, an error in Tech Guide).
        * **Sentence Rewrite (rewrite_suggestion):** **Must** provide a full sentence rewrite that **corrects all errors from I. Correctness** and makes the meaning clearer and more concise.

    c.  [III. Engagement]: (ðŸŒŸ Suggestive Reinforcement)
    Provide "suggestions".
        * **Vocabulary:** Via 'vocab_suggestions', **must** suggest replacements for **overused or bland** basic words.
        * **Structure:** Via 'feedback', alert to issues with sentence variety or content repetition.

    d.  [IV. Delivery]: (ðŸ”¥ Task-Reinforced Standard)
    Detect 'detected_tone', 'formality', and check 'inclusive_language_warning'.
    **'formality' and 'detected_tone' assessment must strictly correspond to the Task type specified in Rule 2:**
        * **Task 1:** 'formality' must be rated "Formal (Academic)", 'detected_tone' must be "Objective" or "Neutral".
        * **Task 2:** 'formality' must be rated "Formal" or "Semi-formal", 'detected_tone' must be "Persuasive" or "Analytical".
        * **Tech Guide:** 'formality' must be rated "Neutral" or "Informal" (meaning "Direct", not "Casual"), 'detected_tone' must be "Instructional" or "Direct".

9.  [Output Format (JSON Schema)]: **Your output 'must' strictly adhere to the following JSON structure object.**

\`\`\`json
{
  "initial_phrase_correction": "STRING", 
  "predictions": [
    {
      "predicted_word": "STRING",
      "P(w_n|context)": "NUMBER",
      "example": "STRING",
      "ppl": "NUMBER",
      "cohesion_band": "NUMBER",
      "consistency_score": "NUMBER",
      "grammar_validation": {
        "correctness": {
          "is_correct": "BOOLEAN", 
          "errors": [
            {
              "type": "STRING", 
              "description": "STRING", 
              
              "priority": "STRING" // Must be one of "Critical", "High", "Low"
            }
          ]
        },
        "clarity": {
          "feedback": "STRING", 
          "rewrite_suggestion": "STRING"
        },
        "engagement": {
          "feedback": "STRING", 
          "vocab_suggestions": "ARRAY<STRING>"
        },
        "delivery": {
   "detected_tone": "STRING",
          "formality": "STRING",
          "inclusive_language_warning": "STRING"
        }
      }
    }
  ]
}
\`\`\`
10. **Output ONLY the requested JSON format object.**`;

            const userQuery = `
Input Phrase (Using only last ${contextLen} words): "${truncatedPhrase}"
POS Filter: ${posFilter}
Writing Task: ${taskContext}
Sampling Params (T=${temp}, TopP=${topP})
`;

            // Call API
            // --- [MODIFICATION START] Pass userApiKey ---
            const results = await callGeminiAPI(userApiKey, systemPrompt, userQuery, predictionSchema, temp, topP);
            // --- [MODIFICATION END] ---
            
			// â­ï¸ Checkpoint: Print the raw API response
			console.log("--- Raw Gemini API Response (results) ---");
			console.log(results);
			console.log("-----------------------------------------");
            // Restore UI
            // v2.9.3-en: Translated
            displayDone(predLoading, predButton, predButtonText, "Get 6 Predictions");

            // Process API response
            if (results.isError) {
                displayError(predError, results.message);
            } else if (Array.isArray(results)) {
                displayPredictionResults(results, truncatedPhrase); // T1.4 Fix: Pass truncated phrase
            } else {
                displayError(predError, "Received unexpected response format.");
            }
        }
        
        ////
        /* * =======================================================================
         * æ­¥é©Ÿä¸€ï¼šæ›¿æ›èˆŠçš„ customSchema
         *
         * v3.0: æ­¤ Schema å¿…é ˆèˆ‡ systemPrompt (è¦å‰‡ 11) ä¸­å®šç¾©çš„ JSON çµæ§‹å®Œå…¨ä¸€è‡´ã€‚
         * æ³¨æ„ï¼šæˆ‘å€‘æ·»åŠ äº† PPL_norm, H_norm, TS, SC, FQ, Bandï¼Œ
         * ç§»é™¤äº† p_w_n, ppl, band_summaryã€‚
         * =======================================================================
         */
        const customSchema = {
Â  Â  Â  Â  Â  Â  type: "OBJECT",
Â  Â  Â  Â  Â  Â  properties: {
Â  Â  Â  Â  Â  Â  Â  Â  "initial_phrase_correction": { "type": "STRING" },
Â  Â  Â  Â  Â  Â  Â  Â  "PPL_norm": { "type": "NUMBER" },
Â  Â  Â  Â  Â  Â  Â  Â  "H_norm": { "type": "NUMBER" },
Â  Â  Â  Â  Â  Â  Â  Â  "TS": { "type": "NUMBER" },
Â  Â  Â  Â  Â  Â  Â  Â  "SC": { "type": "NUMBER" },
Â  Â  Â  Â  Â  Â  Â  Â  "FQ": { "type": "NUMBER" },
Â  Â  Â  Â  Â  Â  Â  Â  "Band": { "type": "NUMBER" }, // AI æœƒå›žå‚³å®ƒè¨ˆç®—çš„ Band
Â  Â  Â  Â  Â  Â  Â  Â  "example": { "type": "STRING" },
Â  Â  Â  Â  Â  Â  Â  Â  "consistency_score": { "type": "NUMBER" },
                "benchmark_comparison": { 
    "type": "ARRAY", 
    "items": { 
        "type": "OBJECT", // é€™è£¡å®šç¾©äº†å®ƒæ˜¯ OBJECT
        "properties": {   // é€™è£¡å¿…é ˆå®šç¾© OBJECT è£¡é¢çš„æ‰€æœ‰å±¬æ€§
            "metric": { "type": "STRING" },
            "score": { "type": "NUMBER" },
            "nearest_benchmark": { "type": "STRING" },
            "comparison_description": { "type": "STRING" }
        },
        "required": [
            "metric",
            "score",
            "nearest_benchmark",
            "comparison_description"
        ]
    } 
},
Â  Â  Â  Â  Â  Â  Â  Â  "grammar_validation": grammarValidationSchemaObject // v3.0 Replace (å‡è¨­æ­¤è®Šæ•¸åœ¨åˆ¥è™•å·²å®šç¾©)
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  required: [
Â  Â  Â  Â  Â  Â  Â  Â  "initial_phrase_correction",Â 
Â  Â  Â  Â  Â  Â  Â  Â  "PPL_norm",Â 
Â  Â  Â  Â  Â  Â  Â  Â  "H_norm",Â 
Â  Â  Â  Â  Â  Â  Â  Â  "TS",Â 
Â  Â  Â  Â  Â  Â  Â  Â  "SC",Â 
Â  Â  Â  Â  Â  Â  Â  Â  "FQ",Â 
Â  Â  Â  Â  Â  Â  Â  Â  "Band",
Â  Â  Â  Â  Â  Â  Â  Â  "example",Â 
Â  Â  Â  Â  Â  Â  Â  Â  "consistency_score",
                "benchmark_comparison", // <--- æ–°å¢žæ¬„ä½  Â 
Â  Â  Â  Â  Â  Â  Â  Â  "grammar_validation"
Â  Â  Â  Â  Â  Â  ] // v3.0 Replace
Â  Â  Â  Â  };
		/* * =======================================================================
Â  Â  Â  Â  Â * æ­¥é©ŸäºŒï¼šæ–°å¢žæ­¤è¼”åŠ©å‡½å¼ (Helper Function)
Â  Â  Â  Â  Â * * v3.0: æ ¹æ“š FQ åˆ†æ•¸åœ¨å‰ç«¯è¨ˆç®— Band å’Œå°æ‡‰çš„ UI é¡è‰²ã€‚
Â  Â  Â  Â  Â * åš´æ ¼éµå¾ªæ‚¨æä¾›çš„ FQ-Band Mapping Tableã€‚
Â  Â  Â  Â  Â * =======================================================================
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function getBandInfoFromFQ(fq) {
Â  Â  Â  Â  Â  Â  let band;
Â  Â  Â  Â  Â  Â  let color;

Â  Â  Â  Â  Â  Â  if (fq === null || fq === undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  return { band: 'N/A', color: 'bg-gray-500' };
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (fq >= 0.85) { // Band 9: FQ 0.85â€“1.0
Â  Â  Â  Â  Â  Â  Â  Â  band = 9;
Â  Â  Â  Â  Â  Â  Â  Â  color = 'bg-blue-600'; // (è«‹è‡ªè¡Œèª¿æ•´é¡è‰²ä»¥åŒ¹é…æ‚¨çš„ CSS)
Â  Â  Â  Â  Â  Â  } else if (fq >= 0.75) { // Band 8: FQ 0.75â€“0.84
Â  Â  Â  Â  Â  Â  Â  Â  band = 8;
Â  Â  Â  Â  Â  Â  Â  Â  color = 'bg-green-600';
Â  Â  Â  Â  Â  Â  } else if (fq >= 0.65) { // Band 7: FQ 0.65â€“0.74
Â  Â  Â  Â  Â  Â  Â  Â  band = 7;
Â  Â  Â  Â  Â  Â  Â  Â  color = 'bg-yellow-500';
Â  Â  Â  Â  Â  Â  } else if (fq >= 0.50) { // Band 6: FQ 0.50â€“0.64
Â  Â  Â  Â  Â  Â  Â  Â  band = 6;
Â  Â  Â  Â  Â  Â  Â  Â  color = 'bg-orange-500';
Â  Â  Â  Â  Â  Â  } else if (fq >= 0.35) { // Band 5: FQ 0.35â€“0.49
Â  Â  Â  Â  Â  Â  Â  Â  band = 5;
Â  Â  Â  Â  Â  Â  Â  Â  color = 'bg-red-600';
Â  Â  Â  Â  Â  Â  } else { // Band <5: FQ < 0.35
Â  Â  Â  Â  Â  Â  Â  Â  band = "<5";
Â  Â  Â  Â  Â  Â  Â  Â  color = 'bg-red-800';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â   Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // å›žå‚³ä¸€å€‹åŒ…å« band å’Œ color çš„ç‰©ä»¶
Â  Â  Â  Â  Â  Â  return { band: band, color: color };
Â  Â  Â  Â  }

        // --- [START] v3.1 OPTIMIZATION ---
        /**
         * v3.1 (Optimization): Render Benchmark Comparison
         * Renders the benchmark_comparison array into readable HTML.
         */
        function renderBenchmarkComparison(benchmarks) {
            if (!benchmarks || benchmarks.length === 0) {
                return '<p class="text-xs text-gray-500">No benchmark data available.</p>';
            }

            // Map metric names for display (matching the v2.9.3-en file)
            const metricNames = {
                "PPL_norm": "Normalized Perplexity (PPL_norm)",
                "H_norm": "Normalized Entropy (H_norm)",
                "TS": "Token Stability (TS)",
                "SC": "Semantic Coherence (SC)"
            };

            let html = '<div class="space-y-3">';
            
            benchmarks.forEach(item => {
                const metricName = metricNames[item.metric] || item.metric;
                const score = (item.score * 100).toFixed(1); // Convert to percentage
                
                html += `
                    <div class="bg-gray-800 p-3 rounded-md border border-gray-700">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-medium text-gray-300">${metricName}</span>
                            <span class="text-lg font-bold text-yellow-300">${item.score.toFixed(4)}</span>
                        </div>
                        <!-- Simple bar visual -->
                        <div class="w-full bg-gray-600 rounded-full h-2.5 my-1">
                            <div class="bg-yellow-500 h-2.5 rounded-full" style="width: ${score}%"></div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">
                            <!-- Note: The description below comes from the API and will be in Chinese -->
                            <strong>Benchmark (${item.nearest_benchmark}):</strong> ${item.comparison_description}
                        </p>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }
        // --- [END] v3.1 OPTIMIZATION ---

		/* * =======================================================================
Â * æ­¥é©Ÿä¸‰ï¼šæ›¿æ›èˆŠçš„ handleCustomWordCheck å‡½å¼
Â *
Â * é—œéµä¿®æ”¹ï¼š
Â * 1. (å„ªåŒ–) æ›´æ–° systemPrompt è¦å‰‡ 4 å’Œ 5ï¼Œ
Â * a. æ ¹æ“šæ‚¨æä¾›çš„æŒ‡æ¨™å®šç¾©ï¼Œæ˜Žç¢ºæŒ‡ç¤º AI å¦‚ä½•è¨ˆç®— PPL, H, TS, SCã€‚
Â * b. ç§»é™¤ AI è¨ˆç®— "Band" çš„å†—é¤˜ä»»å‹™ã€‚
Â * 2. (å„ªåŒ–) æ›´æ–° systemPrompt è¦å‰‡ 11 (JSON Schema)ï¼Œ
Â * =======================================================================
Â */
// Handle custom word validation
async function handleCustomWordCheck(e) {
Â  Â  e.preventDefault();

Â  Â  // --- [MODIFICATION START] Get API Key First ---
Â  Â  const userApiKey = apiKeyInput.value.trim();
Â  Â  if (!userApiKey) {
Â  Â  Â  Â  igpvlCustomError.className = 'text-sm p-3 rounded-lg bg-red-900/50 text-red-400';
Â  Â  Â  Â  igpvlCustomError.innerHTML = 'API key is empty. Please provide a valid API key in the field above.';
Â  Â  Â  Â  customResults.innerHTML = '';
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  // --- [MODIFICATION END] ---

Â  Â  const phrase = predInput.value.trim();
Â  Â  const customWord = customWordInput.value.trim();

Â  Â  // v2.6 IGPVL Integration: Clear old messages
Â  Â  igpvlCustomError.innerHTML = '';
Â  Â  igpvlCustomError.className = 'text-sm rounded-lg mt-4';
Â  Â  customResults.innerHTML = ''; // Clear old results

Â  Â  if (!phrase || !customWord) {
Â  Â  Â  Â  igpvlCustomError.className = 'text-sm p-3 rounded-lg bg-red-900/50 text-red-400';
Â  Â  Â  Â  igpvlCustomError.innerHTML = 'Please enter both context and a custom word.';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // Set UI to loading (v2.6: Before IGPVL)
Â  Â  customLoading.classList.remove('hidden');
Â  Â  customButton.disabled = true;
Â  Â  customButtonText.textContent = "1/2 Validating Input...";

Â  Â  // --- v2.6 IGPVL Execution (Check context phrase only) ---
Â  Â  // --- [MODIFICATION START] Pass userApiKey ---
Â  Â  const igpvlResult = await validateInputGrammar(userApiKey, phrase, 'predInput_custom', 'academic');
Â  Â  // --- [MODIFICATION END] ---
Â  Â  const isBlocked = displayIgpvlFeedback(igpvlCustomError, igpvlResult);

Â  Â  if (isBlocked) {
Â  Â  Â  Â  customLoading.classList.add('hidden');
Â  Â  Â  Â  customButton.disabled = false;
Â  Â  Â  Â  customButtonText.textContent = "Check Word";
Â  Â  Â  Â  return; // Stop execution
Â  Â  }
Â  Â  // --- IGPVL End ---

Â  Â  // Set UI to loading (v2.6: Update status)
Â  Â  customButtonText.textContent = "2/2 Checking...";

Â  Â  // Prepare API request (single word mode)
Â  Â  const taskContext = predTask.value === 'general' ? 'General Writing' : `IELTS ${predTask.value}`;
Â  Â  const temp = predTemp.value;
Â  Â  const topP = predTopP.value;
Â  Â  const contextLen = predContextLen.value;
Â  Â  const truncatedPhrase = truncateContext(phrase, contextLen);
Â  Â  const fullPhrase = `${truncatedPhrase} ${customWord}`;

Â  Â  // ========================================================
Â  Â  // === å„ªåŒ– START: systemPrompt å·²æ›´æ–° (è¦å‰‡ 4, 5, 6, 12) ===
Â  Â  // ========================================================
Â  Â  const systemPrompt = `You are a versatile writing style assistant (IELTS & Technical Writing). Your task is to validate the naturalness of the user's input word "\${customWord}" following the context "\${truncatedPhrase}", strictly adhering to the specified "Task" style.
Rules:
1.Â  [**Input Validation & Correction**]: **If the user's input context phrase \${truncatedPhrase} contains basic spelling or severe grammatical errors** (e.g., 'cycly' or 'the lives are'), **you must provide the corrected phrase in the 'initial_phrase_correction' field of the output JSON** (e.g., 'the life cycle ends,'), and use this corrected phrase as the context for all example generations. If the input is correct, return an empty string.

2.Â  [ðŸ”¥ **Task Style Constraint (Core Optimization)**]: Must strictly adhere to the user-specified 'Task' context when generating 'example' sentences.

Â  Â  a.Â  **If Task = Task 1 (Chart Description):** 'example' must be **Formal**, **Objective**, and **Academic**. The tone must be **Neutral**, focusing on describing data, trends, or comparisons (e.g., *soared, plummeted, whereas, significantly*). **Absolutely prohibit** any subjective or emotional expressions like "I think", "In my opinion".

Â  Â  b.Â  **If Task = Task 2 (Argumentative Essay):** 'example' must be **Formal** or **Semi-formal**, with a **Persuasive** or **Analytical** tone. Sentences should focus on logical arguments, cause-and-effect, or presenting formal viewpoints (e.g., *consequently, It is widely argued that, however*). **Must avoid** colloquial expressions or contractions (like "don't").

Â  Â  c.Â  **If Task = 'Tech Guide' (Technical Manual):** 'example' must be **Clear**, **Direct**, and **Instructional**. The tone must be **objective and focused on instructions**.

Â  Â  Â  Â  * **(i) Core Requirement:** Sentences **must** prioritize the **Imperative mood** (e.g., "**Click** the button") or **Active Voice in the second person** (e.g., "**You** must **enter** the password").

Â  Â  Â  Â  * **(ii) Formatting Conventions:** Must strictly use technical writing formats: **Use Bold for UI elements** (e.g., **Save** button, **File** menu); **Use Monospace/Code font for code, commands, or paths** (e.g., 'npm install', 'C:\\ProgramData').

Â  Â  Â  Â  * **(iii) Absolute Prohibition:** Must **strictly avoid** using the **Passive Voice** (e.g., "The button is clicked by...") or **vague, suggestive language** (e.g., "You might want to...", "It is possible to...").
		
3.Â  [**Absolute Rule**]: 'All' 'example' sentences you generate must satisfy the **English Sentence Definition** in point 11 and 'must' undergo the 'thorough and strict' check by the GVL (Grammar Validation Layer) in point 10 below. **This check is mandatory and cannot be skipped or done superficially**.

4.Â  [**Optimized**] For this "Context-Continuation" pair, provide the following metrics and items:
Â  Â  * Normalized Perplexity (PPL_norm)
Â  Â  * Normalized Entropy (H_norm)
Â  Â  * Token Stability (TS)
Â  Â  * Semantic Coherence (SC)
Â  Â  * **Final Fluency Quality Score (FQ)**
Â  Â  * **Concise Example (example)**
    * **Benchmark Comparison (benchmark_comparison)** Â  Â  * (Note: "Band" is removed; it will be calculated by the client.)

5.Â  [**Optimized**] [Calculation Rules & Definitions]:
Â  Â  **You must calculate the following metrics on a 0.0 to 1.0 scale, where 1.0 is the BEST possible quality.**

Â  Â  * **PPL_norm (Normalized Perplexity):**
Â  Â  Â  Â  * Calculate the Perplexity (PPL) of the \`customWord\` given the context.
Â  Â  Â  Â  * Perplexity measures "confusion"; **lower PPL is better**.
Â  Â  Â  Â  * Normalize this PPL score to the 0-1 scale, where **1.0 = perfect prediction (low PPL)** and **0.0 = high confusion (high PPL)**.
Â  Â  * **H_norm (Normalized Entropy):**
Â  Â  Â  Â  * Calculate the Entropy (H) of the probability distribution *for the next token* after the context.
Â  Â  Â  Â  * Entropy measures "uncertainty"; **higher H is worse** (more uncertainty).
Â  Â  Â  Â  * Normalize this H score to the 0-1 scale, where **1.0 = high confidence (low uncertainty)** and **0.0 = high uncertainty (flat distribution)**.
Â  Â  * **TS (Token Stability):**
Â  Â  Â  Â  * Assess the stability of the \`customWord\`'s prediction probability when the context is slightly varied.
Â  Â  Â  Â  * Normalize this to the 0-1 scale, where **1.0 = highly stable prediction** and **0.0 = volatile prediction**.
Â  Â  * **SC (Semantic Coherence):**
Â  Â  Â  Â  * Calculate the **Cosine Similarity** between the sentence embedding of the context (\`truncatedPhrase\`) and the \`customWord\` (or the resulting \`example\`).
Â  Â  Â  Â  * This measures semantic relevance. **1.0 = perfectly coherent** and **0.0 = semantically unrelated**.

Â  Â  * **FQ Calculation Formula (Use normalized metrics):**
Â  Â  Â  Â  \`FQ = 0.3 * PPL_norm + 0.2 * H_norm + 0.2 * TS + 0.3 * SC\`
Â  Â Â 
Â  Â  * **(FQ-Band Mapping Table is REMOVED as client will calculate it.)**

6.  [**Optimized**] [Metric Benchmarks (JSON Samples)]:
    **You must first follow these JSON samples as a benchmark guide to calibrate your 0.0-1.0 scoring.** These examples define what different values on the scale represent.
	
\`\`\`json
[
  // --- PPL_norm (Normalized Perplexity) Benchmarks ---
  // 1.0 = Perfect (Low PPL), 0.0 = High Confusion (High PPL)
  {
    "metric": "PPL_norm",
    "feature": "æ¥µåº¦æµæš¢ (å®Œç¾Žé æ¸¬)",
    "indicator_value": 0.95,
    "description": "æŒ‡æ¨™ç‚º 1.0 è¡¨ç¤ºå®Œç¾Žé æ¸¬ (PPL è¶¨è¿‘æ–¼ 0)ï¼Œ0.0 è¡¨ç¤ºé«˜åº¦æ··äº‚ (PPL æ¥µé«˜)ã€‚æ­¤å€¼ (0.95) ä»£è¡¨åœ¨ä¸Šä¸‹æ–‡ä¸­ï¼Œè©²è©žæ˜¯æ¥µåº¦è‡ªç„¶ã€å¹¾ä¹Žå”¯ä¸€çš„æŽ¥çºŒã€‚",
    "example": { "context": "The opposite of hot is", "word": "cold" }
  },
  {
    "metric": "PPL_norm",
    "feature": "æµæš¢ (å¸¸è¦‹)",
    "indicator_value": 0.75,
    "description": "ä¸€å€‹éžå¸¸åˆä¹Žé‚è¼¯ä¸”å¸¸è¦‹çš„ç”¨è©žï¼Œæ¨¡åž‹å°æ­¤é æ¸¬çš„å›°æƒ‘åº¦å¾ˆä½Žã€‚",
    "example": { "context": "She opened the door and walked", "word": "inside" }
  },
  {
    "metric": "PPL_norm",
    "feature": "å°šå¯ (åˆç†)",
    "indicator_value": 0.50,
    "description": "ä¸€å€‹åˆç†ã€æ–‡æ³•æ­£ç¢ºçš„æŽ¥çºŒï¼Œä½†ä¸¦éžæœ€å¸¸è¦‹æˆ–æœ€æµæš¢çš„é¸æ“‡ã€‚",
    "example": { "context": "He studied hard for the", "word": "promotion" }
  },
  {
    "metric": "PPL_norm",
    "feature": "ç”Ÿç¡¬ (ç½•è¦‹)",
    "indicator_value": 0.25,
    "description": "æ–‡æ³•ä¸Šå¯èƒ½æˆç«‹ï¼Œä½†åœ¨èªžæ„æˆ–é¢¨æ ¼ä¸Šéžå¸¸ç½•è¦‹ï¼Œå°Žè‡´æ¨¡åž‹å›°æƒ‘åº¦åé«˜ã€‚",
    "example": { "context": "Please pass the", "word": "sky" }
  },
  {
    "metric": "PPL_norm",
    "feature": "ä¸é€šé † (é«˜åº¦æ··äº‚)",
    "indicator_value": 0.05,
    "description": "è©²è©žåœ¨ä¸Šä¸‹æ–‡ä¸­é¡¯å¾—æ ¼æ ¼ä¸å…¥æˆ–è¿‘ä¹Žæ–‡æ³•éŒ¯èª¤ï¼Œæ¨¡åž‹å°æ­¤é æ¸¬çš„å›°æƒ‘åº¦æ¥µé«˜ã€‚",
    "example": { "context": "I would like to", "word": "happy" }
  },
  
  // --- H_norm (Normalized Entropy) Benchmarks ---
  // 1.0 = High Confidence (Low Uncertainty), 0.0 = High Uncertainty
  {
    "metric": "H_norm",
    "feature": "é«˜ä¿¡å¿ƒ (ä½Žä¸ç¢ºå®šæ€§)",
    "indicator_value": 0.90,
    "description": "æŒ‡æ¨™ç‚º 1.0 è¡¨ç¤ºé«˜ä¿¡å¿ƒ (ä½Žç†µ)ï¼Œ0.0 è¡¨ç¤ºé«˜ä¸ç¢ºå®šæ€§ (é«˜ç†µ)ã€‚æ­¤å€¼ (0.90) ä»£è¡¨æ¨¡åž‹æ¥µåº¦ç¢ºå®šæ­¤è©žç‚ºæœ€ä½³æŽ¥çºŒï¼Œå…¶ä»–é¸é …çš„æ©ŸçŽ‡æ¥µä½Žã€‚",
    "example": { "context": "The capital of France is", "word": "Paris" }
  },
  {
    "metric": "H_norm",
    "feature": "æœ‰ä¿¡å¿ƒ",
    "indicator_value": 0.70,
    "description": "æ¨¡åž‹ç›¸ç•¶ç¢ºå®šï¼Œåœ¨æ©ŸçŽ‡åˆ†ä½ˆä¸­ï¼Œæ­¤è©žçš„æ©ŸçŽ‡é¡¯è‘—é«˜æ–¼æ¬¡è¦é¸é …ã€‚",
    "example": { "context": "She wore a beautiful red", "word": "dress" }
  },
  {
    "metric": "H_norm",
    "feature": "ä¸­ç­‰ä¿¡å¿ƒ (å¤šé‡é¸é …)",
    "indicator_value": 0.50,
    "description": "æ¨¡åž‹èªç‚ºæœ‰æ•¸å€‹è©žå½™çš†æœ‰å¯èƒ½æŽ¥çºŒï¼Œæ©ŸçŽ‡åˆ†ä½ˆè¼ƒç‚ºåˆ†æ•£ï¼Œä¸ç¢ºå®šæ€§ä¸­ç­‰ã€‚",
    "example": { "context": "I am feeling", "word": "hungry" }
  },
  {
    "metric": "H_norm",
    "feature": "ä¸ç¢ºå®š (é«˜)",
    "indicator_value": 0.20,
    "description": "ä¸Šä¸‹æ–‡éžå¸¸æ¨¡ç³Šæˆ–é–‹æ”¾ï¼Œå°Žè‡´æ¨¡åž‹ç„¡æ³•éŽ–å®šå–®ä¸€çš„æŽ¥çºŒè©žï¼Œæ©ŸçŽ‡åˆ†ä½ˆå»£æ³›ã€‚",
    "example": { "context": "The result of the experiment was", "word": "inconclusive" }
  },
  {
    "metric": "H_norm",
    "feature": "æ¥µåº¦ä¸ç¢ºå®š (å‡å‹»åˆ†ä½ˆ)",
    "indicator_value": 0.05,
    "description": "ä¸Šä¸‹æ–‡å¹¾ä¹Žæœªæä¾›ä»»ä½•ç·šç´¢ï¼Œæ¨¡åž‹å°ä¸‹ä¸€å€‹è©žçš„é æ¸¬æŽ¥è¿‘éš¨æ©ŸçŒœæ¸¬ (é«˜ç†µ)ã€‚",
    "example": { "context": "He suddenly said,", "word": "Stop" }
  },

  // --- TS (Token Stability) Benchmarks ---
  // 1.0 = Highly Stable, 0.0 = Volatile
  {
    "metric": "TS",
    "feature": "é«˜åº¦ç©©å®š",
    "indicator_value": 0.95,
    "description": "æŒ‡æ¨™ç‚º 1.0 è¡¨ç¤ºé«˜åº¦ç©©å®šï¼Œ0.0 è¡¨ç¤ºæ¥µä¸ç©©å®šã€‚æ­¤å€¼ (0.95) ä»£è¡¨å³ä½¿ä¸Šä¸‹æ–‡ç¨ä½œåŒç¾©è©žæ›¿æ›æˆ–å¾®èª¿ï¼Œæ­¤è©žçš„é æ¸¬æ©ŸçŽ‡ä¾ç„¶ä¿æŒä¸è®Šã€‚",
    "example": { "context_1": "The dog is very loyal", "context_2": "The canine is very loyal", "word": "and" }
  },
  {
    "metric": "TS",
    "feature": "ç©©å®š",
    "indicator_value": 0.75,
    "description": "å°ä¸Šä¸‹æ–‡çš„å¾®å°è®Šå‹•æœ‰æŠµæŠ—åŠ›ï¼Œé æ¸¬çµæžœä¿æŒä¸€è‡´ã€‚",
    "example": { "context_1": "The chart shows a significant increase", "context_2": "The graph displays a major rise", "word": "in" }
  },
  {
    "metric": "TS",
    "feature": "ä¸­ç­‰ç©©å®š",
    "indicator_value": 0.50,
    "description": "ç•¶ä¸Šä¸‹æ–‡è®Šå‹•è¼ƒå¤§æ™‚ï¼Œé æ¸¬çµæžœå¯èƒ½æœƒé–‹å§‹åç§»ã€‚",
    "example": { "context_1": "Click the 'Submit' button", "context_2": "Press the 'Submit' key", "word": "to" }
  },
  {
    "metric": "TS",
    "feature": "ä¸ç©©å®š",
    "indicator_value": 0.25,
    "description": "å³ä½¿æ˜¯å¾®å°çš„åŒç¾©è©žæ›¿æ›ï¼Œä¹Ÿå¯èƒ½å°Žè‡´æ¨¡åž‹æ”¹è®Šé æ¸¬çµæžœã€‚",
    "example": { "context_1": "He felt sad", "context_2": "He felt blue", "word": "because" }
  },
  {
    "metric": "TS",
    "feature": "æ¥µåº¦ä¸ç©©å®š",
    "indicator_value": 0.05,
    "description": "é æ¸¬çµæžœå°ä¸Šä¸‹æ–‡çš„æ“¾å‹•æ¥µåº¦æ•æ„Ÿï¼Œé æ¸¬ä¸å¯é ã€‚",
    "example": { "context_1": "It's a complex task", "context_2": "It's a hard task", "word": "nonetheless" }
  },

  // --- SC (Semantic Coherence) Benchmarks ---
  // 1.0 = Perfectly Coherent, 0.0 = Unrelated
  {
    "metric": "SC",
    "feature": "å®Œå…¨ç›¸é—œ (èªžæ„ä¸€è‡´)",
    "indicator_value": 0.98,
    "description": "æŒ‡æ¨™ç‚º 1.0 è¡¨ç¤ºèªžæ„å®Œç¾Žé€£è²« (é¤˜å¼¦ç›¸ä¼¼åº¦é«˜)ï¼Œ0.0 è¡¨ç¤ºå®Œå…¨ç„¡é—œã€‚æ­¤å€¼ (0.98) ä»£è¡¨è©²è©žèˆ‡ä¸Šä¸‹æ–‡çš„èªžæ„å‘é‡å¹¾ä¹Žä¸€è‡´æˆ–å®Œç¾ŽæŽ¥çºŒã€‚",
    "example": { "context": "He is a doctor who works at the", "word": "hospital" }
  },
  {
    "metric": "SC",
    "feature": "é«˜åº¦ç›¸é—œ (ä¸»é¡Œç·Šå¯†)",
    "indicator_value": 0.80,
    "description": "èˆ‡ä¸Šä¸‹æ–‡çš„èªžæ„ä¸»é¡Œç·Šå¯†ç›¸é—œï¼Œæ˜¯åˆä¹Žé‚è¼¯çš„èªžæ„å»¶ä¼¸ã€‚",
    "example": { "context": "The company's profits soared last", "word": "quarter" }
  },
  {
    "metric": "SC",
    "feature": "ä¸»é¡Œç›¸é—œ",
    "indicator_value": 0.60,
    "description": "å±¬æ–¼åŒä¸€ä¸»é¡Œç¯„ç–‡ï¼Œä½†åœ¨èªžæ„ä¸Šçš„é€£çµä¸å¦‚å‰è€…ç·Šå¯†ã€‚",
    "example": { "context": "We are discussing climate", "word": "policy" }
  },
  {
    "metric": "SC",
    "feature": "å¼±ç›¸é—œ (èªžæ„è·³èº)",
    "indicator_value": 0.30,
    "description": "èªžæ„ä¸Šæœ‰äº›è¨±é—œè¯ï¼Œä½†é€£çµè–„å¼±ï¼Œæ„Ÿè¦ºåƒä¸»é¡Œçš„è·³èºæˆ–åé›¢ã€‚",
    "example": { "context": "She loves to bake", "word": "computers" }
  },
  {
    "metric": "SC",
    "feature": "èªžæ„ç„¡é—œ",
    "indicator_value": 0.10,
    "description": "è©²è©žèˆ‡ä¸Šä¸‹æ–‡çš„èªžæ„å®Œå…¨ä¸ç›¸é—œ (é¤˜å¼¦ç›¸ä¼¼åº¦è¶¨è¿‘æ–¼ 0)ã€‚",
    "example": { "context": "The cat sat on the", "word": "philosophy" }
  },

  // --- FQ (Final Fluency Quality) Benchmarks (Step 3) ---
  // Calculated: 0.3*PPL_norm + 0.2*H_norm + 0.2*TS + 0.3*SC
  {
    "metric": "FQ",
    "feature": "æ¥µä½³ (Band 9)",
    "indicator_value": 0.90,
    "description": "ç¶œåˆæ‰€æœ‰æŒ‡æ¨™ (PPL, H, TS, SC) å‡è¡¨ç¾æ¥µä½³ã€‚æ­¤è©žæ˜¯å®Œç¾Žçš„é¸æ“‡ã€‚",
    "example": { "context": "The data shows a clear", "word": "trend" }
  },
  {
    "metric": "FQ",
    "feature": "å„ªç§€ (Band 8)",
    "indicator_value": 0.80,
    "description": "å„é …æŒ‡æ¨™å‡è¡¨ç¾è‰¯å¥½ï¼Œæµæš¢åº¦ã€ä¿¡å¿ƒã€ç©©å®šæ€§ã€ç›¸é—œæ€§ä¿±ä½³ã€‚",
    "example": { "context": "As illustrated by the graph, the sales figures", "word": "grew" }
  },
  {
    "metric": "FQ",
    "feature": "è‰¯å¥½ (Band 7)",
    "indicator_value": 0.70,
    "description": "ç¶œåˆè¡¨ç¾è‰¯å¥½ï¼Œå¯èƒ½æœ‰ä¸€é …æŒ‡æ¨™ç¨å¼±ï¼Œä½†ä¸å½±éŸ¿æ•´é«”å“è³ªã€‚",
    "example": { "context": "The processor is very", "word": "quick" }
  },
  {
    "metric": "FQ",
    "feature": "åˆæ ¼ (Band 6)",
    "indicator_value": 0.55,
    "description": "ç¶œåˆè¡¨ç¾ä¸­ç­‰ã€‚è©²è©žå¯ç”¨ï¼Œä½†æœ‰æ›´ä½³é¸æ“‡ã€‚",
    "example": { "context": "We must finish the project before the", "word": "ending" }
  },
  {
    "metric": "FQ",
    "feature": "ä¸ä½³ (Band 5)",
    "indicator_value": 0.40,
    "description": "å¤šé …æŒ‡æ¨™åˆ†æ•¸åä½Žï¼Œé¡¯ç¤ºè©²è©žåœ¨ä¸Šä¸‹æ–‡ä¸­ä¸è‡ªç„¶æˆ–ä¸ç›¸é—œã€‚",
    "example": { "context": "Click the button to make the", "word": "computer" }
  }
]
\`\`\`

7.Â  **[æ–°è¦å‰‡]** [Benchmark Comparison Generation]:
    For each of the four core metrics (**PPL_norm, H_norm, TS, SC**), you must compare its calculated score to the JSON benchmarks provided in Rule 6. The output must be an array of four JSON objects in the \`benchmark_comparison\` field. Each object must contain:
    * **"metric"**: The name of the metric (e.g., "PPL_norm").
    * **"score"**: The calculated score for this run (e.g., 0.78).
    * **"nearest_benchmark"**: The 'feature' string from the closest benchmark JSON sample (e.g., "æµæš¢ (å¸¸è¦‹)" or "é«˜åº¦ç©©å®š").
    * **"comparison_description"**: A concise, localized description (Chinese) explaining what the score means in the context of the benchmarks (e.g., "è©²å¾—åˆ† 0.78 ç•¥é«˜æ–¼åŸºæº– 0.75ï¼Œå±¬æ–¼é«˜åº¦æµæš¢çš„ç¯„ç–‡ã€‚").
	
8. [Key Point] In the example sentence, the validated word \${customWord} must "closely and uniquely" follow the "last word" of the context \${truncatedPhrase}. If the last character of the context is punctuation, the word must "closely and uniquely" follow the punctuation mark, separated by a single space.
9.Â  Simulate three rounds of Self-Consistency sampling for each example generation to ensure semantic stability.
10.Â  Provide a "consistency_score" (0-100) for each generation, calculated based on semantic similarity, lexical variance, and syntactic stability.
11. [Grammar Validation Layer (Latest Spec)]: âœ¨ Ultimate Validation Standard

**This is the most important step.** Perform an **absolutely strict** grammar validation on the generated 'example' and fill in the 'grammar_validation' object.

Â  Â  a.Â  [I. Correctness (Strict Correctness)]: (ðŸ”¥ Strictly Reinforced - **Includes syntax and Task compliance errors**)
Â  Â  The 'correctness.errors' array 'must' contain all detected errors. **This includes the most minor errors, as well as major syntax errors (like comma splices/fragments)**. If no errors, must return an empty array [].
Â  Â  Â  Â  * **Core Grammar:** Subject-verb agreement, Basic tense errors, Pronoun case, Article errors (**redundant, missing, or misused**), Noun number.
Â  Â  Â  Â  * **Complex Grammar/Syntax:** Dangling modifiers, Inconsistent tense shifts, Double negatives, Parallel structure errors, **Run-on sentences, Comma Splices, Sentence Fragments**.
Â  Â  Â  Â  * **Spelling:** Basic spelling, Contextual spelling, Capitalization/Number format, Hyphenation/Dashes.
		* **Punctuation:** Basic punctuation, Advanced punctuation (semicolons, colon structure, quotation mark conventions).
Â  Â  Â  Â  * **(ðŸ”¥) Task Compliance:** Must strictly check for violations of **Rule 2** Task style.
Â  Â  Â  Â  Â  Â  * **Task 1 Violation (Critical):** Detected any subjective expression (e.g., "I think", "In my opinion", "feels"). Error 'type' should be "Task 1 Violation".
Â  Â  Â  Â  Â  Â  * **Task 2 Violation (High):** Detected colloquial contractions (e.g., "don't", "it's") or overly informal vocabulary. Error 'type' should be "Formality Violation".
Â  Â  Â  Â  Â  Â  * **Tech Guide Violation (High):** Detected **passive voice** (e.g., "The file is saved by..."), **vague/non-instructional language** (e.g., "It is recommended to..."), or **missing UI/Code formatting** (e.g., failing to mark 'Save button' as '**Save** button'). Error 'type' should be "Tech Guide Violation".

Â  Â  b.Â  [II. Clarity]: (ðŸ’¡ Suggestive Reinforcement - Focus on style, brevity, and semantics)
Â  Â  Provide "suggestions". **Does not handle Level I syntax errors**.
Â  Â  Â  Â  * **Optimization:** Provide brevity suggestions (wordiness), detect overuse of passive voice (a suggestion in Task 1/2, an error in Tech Guide).
Â  Â  Â  Â  * **Sentence Rewrite (rewrite_suggestion):** **Must** provide a full sentence rewrite that **corrects all errors from I. Correctness** and makes the meaning clearer and more concise.
Â  Â  c.Â  [III. Engagement]: (ðŸŒŸ Suggestive Reinforcement)
Â  Â  Provide "suggestions".
Â  Â  Â  Â  * **Vocabulary:** Via 'vocab_suggestions', **must** suggest replacements for **overused or bland** basic words.
Â  Â  Â  Â  * **Structure:** Via 'feedback', alert to issues with sentence variety or content repetition.
Â  Â  d.Â  [IV. Delivery]: (ðŸ”¥ Task-Reinforced Standard)
Â  Â  Detect 'detected_tone', 'formality', and check 'inclusive_language_warning'.
Â  Â  **'formality' and 'detected_tone' assessment must strictly correspond to the Task type specified in Rule 2:**
Â  Â  Â  Â  * **Task 1:** 'formality' must be rated "Formal (Academic)", 'detected_tone' must be "Objective" or "Neutral".
Â  Â  Â  Â  * **Task 2:** 'formality' must be rated "Formal" or "Semi-formal", 'detected_tone' must be "Persuasive" or "Analytical".
Â  Â  Â  Â  * **Tech Guide:** 'formality' must be rated "Neutral" or "Informal" (meaning "Direct", not "Casual"), 'detected_tone' must be "Instructional" or "Direct".

11. [English Sentence Definition]: **A complete English sentence must contain a subject and a predicate, express a complete thought (independent clause), begin with a capital letter, and end with a period, question mark, or exclamation mark.**

12. [Output Format (JSON Schema)]: **Your output 'must' strictly adhere to the following JSON structure object.**
Â  Â  (Note: Schema updated to match Rule 4 & 5. "Band" is removed.)

\`\`\`json
{
Â  "initial_phrase_correction": "STRING",
Â  "PPL_norm": "NUMBER",
Â  "H_norm": "NUMBER",
Â  "TS": "NUMBER",
Â  "SC": "NUMBER",
Â  "FQ": "NUMBER",
Â  "example": "STRING",
Â  "consistency_score": "NUMBER",
  "benchmark_comparison": [ // <--- ã€ä¿®æ­£é»ž Cã€‘æ–°å¢žé™£åˆ—çµæ§‹
        {
            "metric": "STRING",
            "score": "NUMBER",
            "nearest_benchmark": "STRING",
            "comparison_description": "STRING"
        }
        // ... (å…¶ä»–ä¸‰å€‹æŒ‡æ¨™çš„ç‰©ä»¶) ...
    ],
 Â  "grammar_validation": {
Â  Â  "correctness": {
Â  Â  Â  "is_correct": "BOOLEAN",
Â  Â  Â  "errors": [
Â  Â  Â  Â  {
Â  Â  Â  Â  Â  "type": "STRING",
Â  Â  Â  Â  Â  "description": "STRING",
Â  Â  Â  Â  Â  "suggestion": "STRING",
Â  Â  Â  Â  Â  "priority": "STRING"
Â  Â  Â  Â  }
Â  Â  Â  ]
Â  Â  },
Â  Â  "clarity": {
Â  Â  Â  "feedback": "STRING",
Â  Â  Â  "rewrite_suggestion": "STRING"
Â  Â  },
Â  Â  "engagement": {
Â  Â  Â  "feedback": "STRING",
Â  Â  Â  "vocab_suggestions": "ARRAY<STRING>"
Â  Â  },
Â  Â  "delivery": {
Â  Â  Â  "detected_tone": "STRING",
Â  Â  Â  "formality": "STRING",
Â  Â  Â  "inclusive_language_warning": "STRING"
Â  Â  }
Â  }
}
\`\`\`
13. **Output ONLY the requested JSON format object.**`;
Â  Â  // ======================================================
Â  Â  // === å„ªåŒ– END: systemPrompt å·²æ›´æ–° ===
Â  Â  // ======================================================


Â  Â  const userQuery = `
Context (Using only last ${contextLen} words): "${truncatedPhrase}"
Custom Word: "${customWord}"
Writing Task: "${taskContext}"
Sampling Params (T=${temp}, TopP=${topP})
`;
Â  Â  // --- [MODIFICATION START] Pass userApiKey ---
Â  Â  const result = await callGeminiAPI(userApiKey, systemPrompt, userQuery, customSchema, temp, topP);
Â  Â  // --- [MODIFICATION END] ---

Â  Â  // Restore UI
Â  Â  customLoading.classList.add('hidden');
Â  Â  customButton.disabled = false;
Â  Â  customButtonText.textContent = "Check Word";

Â  Â  // ==================================================================
    // === v3.1 OPTIMIZATION START: Reworked custom word result UI ===
Â  Â  // ==================================================================
Â  Â  if (result.isError) {
Â  Â  Â  Â  customResults.innerHTML = `<p class="text-red-400">Validation Failed: ${result.message}</p>`;

Â  Â  } else if (result.FQ !== undefined) { // v3.0: æª¢æŸ¥ FQ (è€Œä¸æ˜¯èˆŠçš„ band)

Â  Â  Â  Â  // v3.0: å‘¼å«æ–°çš„è¼”åŠ©å‡½å¼ï¼Œåœ¨å‰ç«¯æ ¹æ“š FQ è¨ˆç®— Band
Â  Â  Â  Â  const bandInfo = getBandInfoFromFQ(result.FQ);
        // =======================================================
        // ã€æ–°å¢žç¨‹å¼ç¢¼ã€‘: è¼¸å‡º benchmark_comparison åˆ° Console
        // =======================================================
        console.log("--- Benchmark Comparison Results ---");
        // ä½¿ç”¨ console.dir æˆ– JSON.stringify ä»¥ç¢ºä¿è¼¸å‡ºæ ¼å¼å¯è®€
        if (result.benchmark_comparison) {
            console.dir(result.benchmark_comparison);
        } else {
            console.log("Error: benchmark_comparison field is missing or empty.");
        }
        console.log("------------------------------------");
        // =======================================================
Â  Â  Â  Â  
        // v3.1 (Optimization): Reworked custom word result UI
        customResults.innerHTML = `
            <div class="bg-gray-700 p-4 rounded-lg border border-yellow-500/50 space-y-4">
                
                <!-- 1. Header -->
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between pb-3 border-b border-gray-600 gap-2">
                    <div>
                        <h4 class="text-lg font-bold text-yellow-300">Custom Word: "${customWord}"</h4>
                        <p class="text-sm text-gray-400 break-all">Context: "...${truncatedPhrase}"</p>
                    </div>
                    <span class="band-tag ${bandInfo.color} text-white text-lg px-4 py-2 flex-shrink-0">Band ${bandInfo.band}</span>
                </div>

                <!-- 2. Main Metrics Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    
                    <!-- Column 1: Final Score -->
                    <div class="bg-gray-800 p-4 rounded-lg flex flex-col items-center justify-center text-center border border-gray-700">
                        <h5 class="text-sm font-semibold text-gray-400 mb-1">Final Fluency Quality (FQ)</h5>
                        <p class="text-5xl font-bold text-yellow-300">${result.FQ.toFixed(4)}</p>
                        
                        <details class="w-full mt-3">
                            <summary class="text-xs text-gray-500 cursor-pointer hover:text-gray-300">Show FQ-Band Mapping</summary>
                            <div class="mt-2 pt-2 border-t border-gray-700 space-y-1 text-xs text-gray-400 text-left">
                                <p><span class="band-tag bg-blue-600 text-white w-12 inline-block text-center mr-1">Band 9</span> FQ 0.85â€“1.0</p>
                                <p><span class="band-tag bg-green-600 text-white w-12 inline-block text-center mr-1">Band 8</span> FQ 0.75â€“0.84</p>
                                <p><span class="band-tag bg-yellow-500 text-white w-12 inline-block text-center mr-1">Band 7</span> FQ 0.65â€“0.74</p>
                                <p><span class="band-tag bg-orange-500 text-white w-12 inline-block text-center mr-1">Band 6</span> FQ 0.50â€“0.64</p>
                                <p><span class="band-tag bg-red-600 text-white w-12 inline-block text-center mr-1">Band 5</span> FQ 0.35â€“0.49</p>
                                <p><span class="band-tag bg-red-800 text-white w-12 inline-block text-center mr-1">Band &lt;5</span> FQ &lt; 0.35</p>
                            </div>
                        </details>
                    </div>

                    <!-- Column 2: Component Metrics -->
                    <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                        <h5 class="text-sm font-semibold text-gray-400 mb-3">Component Metrics</h5>
                        <ul class="space-y-2 text-sm">
                            <li class="flex justify-between text-gray-300"><span>PPL_norm:</span> <span class="font-medium text-yellow-300">${result.PPL_norm.toFixed(4)}</span></li>
                            <li class="flex justify-between text-gray-300"><span>H_norm:</span> <span class="font-medium text-yellow-300">${result.H_norm.toFixed(4)}</span></li>
                            <li class="flex justify-between text-gray-300"><span>TS (Stability):</span> <span class="font-medium text-yellow-300">${result.TS.toFixed(4)}</span></li>
                            <li class="flex justify-between text-gray-300"><span>SC (Coherence):</span> <span class="font-medium text-yellow-300">${result.SC.toFixed(4)}</span></li>
                            <li class="flex justify-between text-gray-300 pt-2 border-t border-gray-700/50"><span>Consistency:</span> <span class="font-medium text-yellow-300">${result.consistency_score}</span></li>
                        </ul>
                    </div>

                    <!-- Column 3: Benchmark Comparison -->
                    <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                        <h5 class="text-sm font-semibold text-gray-400 mb-3">Benchmark Comparison</h5>
                        <!-- This is where the new function's output will go -->
                        ${renderBenchmarkComparison(result.benchmark_comparison)}
                    </div>
                </div>

                <!-- 3. Example & Grammar -->
                <div class="pt-4 border-t border-gray-600">
                    <h5 class="text-sm font-semibold text-gray-400 mb-2">Example Sentence & Grammar Report</h5>
                    <div class="bg-gray-600 p-3 rounded-md text-gray-200">
                        ${highlight(result.example, fullPhrase)}
                    </div>
                    <!-- The renderGrammarValidation function is already defined and works -->
                    ${renderGrammarValidation(result.grammar_validation)}
                </div>
            </div>
        `;
Â  Â  } else {
Â  Â  Â  Â  // v3.0: æ›´æ–°éŒ¯èª¤è¨Šæ¯
Â  Â  Â  Â  customResults.innerHTML = `<p class="text-red-400">Received unexpected response format (Missing required FQ metric).</p>`;
    }
Â  Â  // ==================================================================
Â  Â  // === v3.1 OPTIMIZATION END ===
Â  Â  // ==================================================================
}
		////


        // v3.0: Update displayPredictionResults
        function displayPredictionResults(results, inputPhrase) {
            if (results.length === 0) {
                predictionResults.innerHTML = `<p class="text-gray-400 md:col-span-2 text-center">No matching predictions found.</p>`;
                return;
            }

            results.forEach((item, index) => {
                const fullPhrase = `${inputPhrase} ${item.word}`;
                // Use local function to get color
                const bandInfo = getCohesionBandDetails(item.ppl);

                // v3.0 Update: Handle consistency status
                const consistencyStatus = item.consistency_score >= 85 ? 'Stable' : 'Check';

                const card = document.createElement('div');
                card.className = 'bg-gray-800 p-5 rounded-lg shadow-lg border border-gray-700 space-y-3';
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-bold text-white">${index + 1}. ${item.word}</h3>
                        <span class="band-tag ${bandInfo.color} text-white">Band ${bandInfo.band}</span>
                    </div>
                    
                    <p class="text-sm text-gray-400">${item.band_summary}</p>

                    <div class="grid grid-cols-2 text-sm text-gray-300 border-b border-gray-700 pb-3">
                        <p><strong>P(wâ‚™|context):</strong> <span class="text-blue-300">${item.p_w_n.toFixed(4)}</span></p>
                        <p><strong>PPL:</strong> <span class="text-blue-300">${item.ppl.toFixed(2)}</span></p>
                    </div>

                    <div id="example-container-${index}" class="bg-gray-700 p-3 rounded-md text-gray-200">
                        ${highlight(item.example, fullPhrase)}
                    </div>
                    <!-- v3.0 Update: Show Consistency and Grammar Validation Layer -->
                    <div id="metrics-container-${index}" class="text-xs text-gray-400 text-right mt-1 space-y-1">
                        <div>Consistency: ${item.consistency_score} (${consistencyStatus})</div>
                    </div>
                    <!-- v3.0 Grammar Validation Layer Injection Point -->
                    <div id="grammar-validation-${index}">
                        ${renderGrammarValidation(item.grammar_validation)}
                    </div>
                    
                    <!-- Band Control Regeneration -->
                    <div class="flex gap-2 pt-2">
                        <select id="band-select-${index}" class="w-1/2 bg-gray-600 border border-gray-500 rounded-md p-2 text-sm text-white focus:ring-1 focus:ring-blue-500">
                            <option value="9">Band 9</option>
                            <option value="8">Band 8</option>
                            <option value="7">Band 7</option>
                            <option value="6">Band 6</option>
                            <option value="5">Band 5</option>
                        </select>
                        <button class="regen-button w-1/2 bg-gray-500 hover:bg-gray-400 text-white text-sm font-medium py-2 px-3 rounded-lg transition-colors duration-200 flex items-center justify-center gap-1 disabled:opacity-50"
                                data-index="${index}"
                                data-context="${inputPhrase}"
                                data-word="${item.word}"
                                data-type="prediction">
                            <span class="regen-text">ðŸ”„ Regenerate</span>
                            <div class="spinner regen-loading hidden"></div>
                        </button>
                    </div>
                `;
                predictionResults.appendChild(card);
            });
        }
        
        // Unified UI state helper functions
        function displayLoading(errorEl, loadingEl, buttonEl, textEl, message) {
            errorEl.classList.add('hidden'); // v2.6: Keep main error hidden
            loadingEl.classList.remove('hidden');
            buttonEl.disabled = true;
            textEl.textContent = message;
        }

        function displayDone(loadingEl, buttonEl, textEl, message) {
            loadingEl.classList.add('hidden');
            buttonEl.disabled = false;
            textEl.textContent = message;
        }

        function displayError(errorEl, message, loadingEl = null, buttonEl = null, textEl = null, buttonMessage = null) {
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
            if (loadingEl) displayDone(loadingEl, buttonEl, textEl, buttonMessage);
        }

        // v3.0: Update regenSchema
        const regenSchema = {
            type: "OBJECT",
            properties: {
                "example": { "type": "STRING", "description": "Newly generated example sentence, <= 25 words" },
                "consistency_score": { "type": "NUMBER", "description": "Semantic consistency score of the new sentence (0-100)" },
                "grammar_validation": grammarValidationSchemaObject // v3.0 Replace
            },
            required: ["example", "consistency_score", "grammar_validation"] // v3.0 Replace
        };

        // Unified example regeneration logic (Shared by Prediction & Validation)
        async function handleRegeneration(button, band, context, word, type) {
            // --- [MODIFICATION START] Get API Key First ---
            const userApiKey = apiKeyInput.value.trim();
            const index = button.dataset.index;
            const exampleContainer = document.getElementById(type === 'prediction' ? `example-container-${index}` : `val-example-container`);
            
            if (!userApiKey) {
                exampleContainer.innerHTML = `<span class="text-red-400">Generation Failed: API key is empty.</span>`;
                // Restore UI in case it's spinning
                const regenText = button.querySelector('.regen-text');
                const regenLoading = button.querySelector('.regen-loading');
                button.disabled = false;
                regenText.classList.remove('hidden');
                regenLoading.classList.add('hidden');
                return;
            }
            // --- [MODIFICATION END] ---

            const fullPhrase = type === 'prediction' ? `${context} ${word}` : context; // Validation case: context is the full phrase
            
            // const exampleContainer = document.getElementById(type === 'prediction' ? `example-container-${index}` : `val-example-container`); // Moved up
            const regenText = button.querySelector('.regen-text');
            const regenLoading = button.querySelector('.regen-loading');

            // T1.8 Fix: Check if this is an auto-retry
            const isAutoRetry = button.dataset.isAutoRetry === 'true';

            // Set UI to loading
            button.disabled = true;
            regenText.classList.add('hidden');
            regenLoading.classList.remove('hidden');
            // T1.8 Fix: Update loading message
            exampleContainer.innerHTML = `<span class="text-gray-400">Generating Band ${band} example... ${isAutoRetry ? '(Auto-Traceback Retry...)' : '(Self-Consistency 3x)'}</span>`;

            // Get Consistency Manager parameters
            const temp = predTemp.value;
            const topP = predTopP.value;

            // Prepare API request
            const bandRules = `Band ${band} - Vocabulary and Sentence Feature: ${type === 'prediction' ? 'Cohesion & Coherence' : 'Lexical Resource'}.`;
            
            // v3.0 (User Custom) Update: Strictly implement Grammar Validation Layer
            const systemPrompt = `You are an IELTS Writing Assistant. Your task is to generate a "single, concise (max 25 words)" example sentence based on the user-specified "full collocation phrase" (\${fullPhrase}) and "target Band" (\${band}).

Rules:
1.  [**Collocation Phrase Validation**]: **If the user's input collocation phrase \${fullPhrase} contains basic spelling or severe grammatical errors** (e.g., 'significantlly' -> 'significantly'), **you must provide the corrected phrase in the 'phrase_correction' field of the output JSON**, and use this corrected phrase as the basis for example generation. If the input is correct, return an empty string.
2.  [**Absolute Rule**]: 'All' 'example' sentences you generate must satisfy the **English Sentence Definition** in point 10 and 'must' undergo the 'thorough and strict' check by the GVL (Grammar Validation Layer) in point 8 below. **This check is mandatory and cannot be skipped or done superficially**.
3.  **Semantic Consistency (>= 0.9):** The newly generated example must remain highly consistent semantically with the current example, differing only in syntactic structure and lexical choice.
4.  **Band Adherence:** The example must strictly conform to the target Band (\${band}) requirements for grammatical complexity, coherence, and lexical density.
5.  **Complete Collocation:** Ensure the example sentence contains the **complete and corrected** collocation "\${fullPhrase}".
6.  **Continuity:** Ensure the words in the collocation are continuous and not separated by punctuation.
7.  Self-Consistency: Simulate three rounds of Self-Consistency sampling to ensure output stability.
8.  Output a "consistency_score" (0-100), calculated based on semantic similarity, lexical variance, and syntactic stability.

9.  [Grammar Validation Layer (Latest Spec)]: âœ¨ Ultimate Validation Standard
**This is the most important step.** Perform an **absolutely strict** grammar validation on the generated 'example' and fill in the 'grammar_validation' object.

    a.  [I. Correctness (Strict Correctness)]: (ðŸ”¥ Strictly Reinforced - **Includes syntax errors**)
    The 'correctness.errors' array 'must' contain all detected errors. **This includes the most minor errors, as well as major syntax errors (like comma splices/fragments)**. If no errors, must return an empty array [].
        -   **Core Grammar:** Subject-verb agreement, Basic tense errors, Pronoun case, Article errors (**redundant, missing, or misused**), Noun number.
        -   **Complex Grammar/Syntax:** Dangling modifiers, Inconsistent tense shifts, Double negatives, Parallel structure errors, **Run-on sentences, Comma Splices, Sentence Fragments**.
        -   **Spelling:** Basic spelling, Contextual spelling, Capitalization/Number format, Hyphenation/Dashes.
        -   **Punctuation:** Basic punctuation (end-of-sentence), Advanced punctuation (semicolons, colon structure, quotation mark conventions).

    b.  [II. Clarity]: (ðŸ’¡ Suggestive Reinforcement - Focus on style, brevity, and semantics)
    Provide "suggestions". **Does not handle Level I syntax errors**.
        -   **Optimization:** Provide brevity suggestions (wordiness), detect overuse of passive voice.
        -   **Sentence Rewrite (rewrite_suggestion):** **Must** provide a full sentence rewrite that **corrects all errors from I. CorrectCness** and makes the meaning clearer and more concise.

    c.  [III. Engagement]: (ðŸŒŸ Suggestive Reinforcement)
    Provide "suggestions".
        -   **Vocabulary:** Via 'vocab_suggestions', **must** suggest replacements for **overused or bland** basic words.
        -   **Structure:** Via 'feedback', alert to issues with sentence variety or content repetition.

    d.  [IV. Delivery]: (Maintain original standard)
    Detect 'detected_tone', 'formality', and check 'inclusive_language_warning'.

10. [English Sentence Definition]: **A complete English sentence must contain a subject and a predicate, express a complete thought (independent clause), begin with a capital letter, and end with a period, question mark, or exclamation mark.**

11. [Output Format (JSON Schema)]: **Your output 'must' strictly adhere to the following JSON structure object.**

\`\`\`json
{
  "phrase_correction": "STRING", // Correction required by Rule 1
  "example": "STRING",
  "consistency_score": "NUMBER",
  "grammar_validation": {
    "correctness": {
      "is_correct": "BOOLEAN", 
      "errors": [
        {
          "type": "STRING", 
          "description": "STRING", 
          "suggestion": "STRING",
          "priority": "STRING" // Must be one of "Critical", "High", "Low"
        }
      ]
    },
    "clarity": {
      "feedback": "STRING", 
      "rewrite_suggestion": "STRING"
    },
    "engagement": {
      "feedback": "STRING", 
      "vocab_suggestions": "ARRAY<STRING>"
    },
    "delivery": {
      "detected_tone": "STRING",
      "formality": "STRING",
      "inclusive_language_warning": "STRING"
    }
  }
}
\`\`\`
12. **Output ONLY the requested JSON format object.**`;

            const userQuery = `
Full Collocation: "${fullPhrase}"
Target Band: ${band}
Band Rules: ${bandRules}
Sampling Params (T=${temp}, TopP=${topP})
`;

            // Call API
            // --- [MODIFICATION START] Pass userApiKey ---
            const result = await callGeminiAPI(userApiKey, systemPrompt, userQuery, regenSchema, temp, topP);
            // --- [MODIFICATION END] ---

            // Restore UI (Restore before T1.8 check to prevent button getting stuck)
            button.disabled = false;
            regenText.classList.remove('hidden');
            regenLoading.classList.add('hidden');

            // Display results
            if (result.isError) {
                exampleContainer.innerHTML = `<span class="text-red-400">Generation Failed: ${result.message || 'Unknown error'}</span>`;
            } else if (result.example && result.consistency_score !== undefined && result.grammar_validation) {
                
                // T1.8 / T2.8 Fix: Store history
                const historyKey = `${type}-${index}`;
                if (!regenerationHistory[historyKey]) {
                    regenerationHistory[historyKey] = [];
                }
                regenerationHistory[historyKey].push(result.consistency_score);
                if (regenerationHistory[historyKey].length > 5) { // Keep last 5
                    regenerationHistory[historyKey].shift();
                }

                // T1.8 / T2.8 Fix: Semantic Traceback simulation
                // If score is low, and this is not an auto-retry
                if (result.consistency_score < 85 && !isAutoRetry) {
                    console.warn(`Semantic Traceback (T1.8) triggered for ${historyKey}. Score: ${result.consistency_score}. Auto-retrying...`);
                    
                    // v3.0 Update: Get metrics container
                    const metricsContainer = document.getElementById(type === 'prediction' ? `metrics-container-${index}` : `val-metrics-container`);
                    if (metricsContainer) {
                        metricsContainer.innerHTML = `
                            <div>Consistency: ${result.consistency_score} (<span class="text-yellow-400">Low score! Auto-Traceback Retry...</span>)</div>
                        `;
                    }
                    // v3.0 Update: Get grammar container
                    const grammarContainer = document.getElementById(type === 'prediction' ? `grammar-validation-${index}` : `val-grammar-validation`);
                    if (grammarContainer) {
                        grammarContainer.innerHTML = renderGrammarValidation(result.grammar_validation);
                    }


                    // Flag and retry once
                    button.dataset.isAutoRetry = 'true';
                    await handleRegeneration(button, band, context, word, type);
                    
                    // After retry, clear flag and exit
                    button.dataset.isAutoRetry = 'false';
                    return; // Terminate this function to prevent showing low-score result
                }

                // --- Display Normal Result (Score >= 85 or already retried) ---
                
                // Update example
                exampleContainer.innerHTML = highlight(result.example, fullPhrase);
                
                // v3.0 Update: Update metrics container
                const metricsContainer = document.getElementById(type === 'prediction' ? `metrics-container-${index}` : `val-metrics-container`);
                if (metricsContainer) {
                    const consistencyStatus = result.consistency_score >= 85 ? 'Stable' : 'Check';
                    metricsContainer.innerHTML = `
                        <div>Consistency: ${result.consistency_score} (${consistencyStatus})</div>
                    `;
                }
                // v3.0 Update: Update grammar container
                const grammarContainer = document.getElementById(type === 'prediction' ? `grammar-validation-${index}` : `val-grammar-validation`);
                if (grammarContainer) {
                    grammarContainer.innerHTML = renderGrammarValidation(result.grammar_validation);
                }
            } else {
                exampleContainer.innerHTML = `<span class="text-red-400">Generation Failed: Received unexpected response format (missing grammar_validation).</span>`;
            }
        }

        // Event delegation for prediction results area (Regeneration)
        predictionResults.addEventListener('click', async function(e) {
            const button = e.target.closest('.regen-button');
            if (!button || button.dataset.type !== 'prediction') return;

            e.preventDefault();
            const index = button.dataset.index;
            // T1.4 Fix: Ensure truncated context is passed
            const context = truncateContext(button.dataset.context, predContextLen.value);
            const word = button.dataset.word;
            
            const bandSelect = document.getElementById(`band-select-${index}`);
            const band = bandSelect.value;
            
            await handleRegeneration(button, band, context, word, 'prediction');
        });

        // --- Validation Tab Logic (Unchanged) ---

        // v3.0: Update validationSchema
        const validationSchema = {
            type: "OBJECT",
            properties: {
                "Fpm": { "type": "NUMBER", "description": "Frequency per million words in the corpus" },
                "MI": { "type": "NUMBER", "description": "Mutual Information value" },
                "L_acc_norm": { "type": "NUMBER", "description": "Linguistic accuracy (1.0 = correct; 0.5 = minor error; 0.0 = error)" },
                "example": { "type": "STRING", "description": "Example sentence, max 25 words" },
                "grammarCheck": { "type": "STRING", "description": "Brief description of grammar validation result (should align with L_acc_norm)" },
                "spellingSuggestion": { "type": "STRING", "description": "Spelling correction suggestion or alternative collocation (empty string if none)" },
                "consistency_score": { "type": "NUMBER", "description": "Semantic consistency score of the example (0-100)" },
                "example_grammar_validation": grammarValidationSchemaObject // v3.0 Replace
            },
            required: ["Fpm", "MI", "L_acc_norm", "example", "grammarCheck", "spellingSuggestion", "consistency_score", "example_grammar_validation"] // v3.0 Replace
        };

        async function handleValidationSubmit(e) {
            e.preventDefault();

            // --- [MODIFICATION START] Get API Key First ---
            const userApiKey = apiKeyInput.value.trim();
            if (!userApiKey) {
                // v2.9.3-en: Translated
                displayError(valError, "API key is empty. Please provide a valid API key in the field above.", valLoading, valButton, valButtonText, "Validate Collocation");
                // Clear any old IGPVL errors
                igpvlValError.innerHTML = '';
                igpvlValError.className = 'text-sm rounded-lg';
                return;
            }
            // --- [MODIFICATION END] ---

            const phrase1 = valInput1.value.trim();
            const phrase2 = valInput2.value.trim();
            const fullPhrase = `${phrase1} ${phrase2}`.trim();

            // v2.6 IGPVL Integration: Clear old messages
            igpvlValError.innerHTML = '';
            igpvlValError.className = 'text-sm rounded-lg';
            valError.classList.add('hidden'); // Hide old generation errors
            validationResults.classList.add('hidden');
            validationResults.innerHTML = '';

            if (!phrase1 || !phrase2) {
                // v2.9.3-en: Translated
                displayError(valError, "Please enter both an initial phrase and a target word.", valLoading, valButton, valButtonText, "Validate Collocation");
                return;
            }

            // Set UI to loading (v2.6: Before IGPVL)
            // v2.9.3-en: Translated
            displayLoading(valError, valLoading, valButton, valButtonText, "1/2 Validating Input...");

            // --- v2.6 IGPVL Execution ---
            // --- [MODIFICATION START] Pass userApiKey ---
            const igpvlResult = await validateInputGrammar(userApiKey, fullPhrase, 'valInput', 'academic');
            // --- [MODIFICATION END] ---
            const isBlocked = displayIgpvlFeedback(igpvlValError, igpvlResult);

            if (isBlocked) {
                // v2.9.3-en: Translated
                displayDone(valLoading, valButton, valButtonText, "Validate Collocation");
                return; // Stop execution
            }
            // --- IGPVL End ---

            // Set UI to loading (v2.6: Update status)
            // v2.9.3-en: Translated
            displayLoading(valError, valLoading, valButton, valButtonText, "2/2 Validating...");
            
            // S_Naturalness v3.0 (User Custom) Revised System Prompt
            const systemPrompt = `You are an IELTS Writing Assistant. Your task is to evaluate the naturalness and correctness of the user-provided "full collocation phrase" (\${fullPhrase}) and provide the raw data needed to calculate S_Naturalness.

Rules:
1.  [**Collocation Phrase Validation**]: **If the user's input collocation phrase \${fullPhrase} contains basic spelling or severe grammatical errors** (e.g., 'significantlly' -> 'significantly'), **you must provide the corrected phrase in the 'phrase_correction' field of the output JSON**, and use this corrected phrase as the basis for example generation. If the input is correct, return an empty string.
2.  [**Absolute Rule**]: 'All' 'example' sentences you generate must satisfy the **English Sentence Definition** in point 10 and 'must' undergo the 'thorough and strict' check by the GVL (Grammar Validation Layer) in point 9 below. **This check is mandatory and cannot be skipped or done superficially**.
3.  Provide "Fpm" (Frequency per million words in the corpus).
4.  Provide "MI" (Mutual Information value).
5.  Based on grammatical and morphological correctness, provide "L_acc_norm" (Linguistic accuracy score: 1.0 = Fully correct, 0.5 = Understandable but with minor errors, 0.0 = Severe error).
6.  Provide a "Concise Example (example)" (max 25 words).
7.  Provide a brief result for "Grammar Check (grammarCheck)" (this should align with L_acc_norm).
8.  If the collocation is unnatural or has clear spelling errors, provide an "Alternative Collocation (spellingSuggestion)" or correction; otherwise, return an empty string.
9.  Provide a "consistency_score" (0-100) for the 'example'.

10. [Grammar Validation Layer (Latest Spec)]: âœ¨ Ultimate Validation Standard
**This is the most important step.** Perform an **absolutely strict** grammar validation on the generated 'example' and fill in the 'example_grammar_validation' object.

    a.  [I. Correctness (Strict Correctness)]: (ðŸ”¥ **Final Unified Reinforcement** - **Includes all structural errors**)
    The 'correctness.errors' array 'must' contain all detected errors. **This includes the most minor errors, as well as all syntactic structural errors**. If no errors, must return an empty array [].
        -   **Core Grammar:** Subject-verb agreement, Basic tense errors, Pronoun case, Article errors (**redundant, missing, or misused**), Noun number.
        -   **Complex Syntax/Structure:** Dangling/Misplaced modifiers, Inconsistent tense shifts, Incomplete comparisons, Double negatives, Parallel structure errors, **Run-on Sentences, Comma Splices, Sentence Fragments**.
        -   **Spelling:** Basic spelling, Contextual spelling (**confused words**), Capitalization/Number format, Hyphenation/Dashes.
        -   **Punctuation:** Basic punctuation, Advanced punctuation (semicolons, colon structure, quotation mark conventions).

    b.  [II. Clarity]: (ðŸ’¡ Suggestive Reinforcement - Focus on style, brevity, and semantics)
    Provide "suggestions". **This section no longer handles structural errors.**
        -   **Optimization:** Provide **brevity suggestions (wordiness)**, detect **overuse of passive voice**.
        -   **Full Sentence Rewrite (rewrite_suggestion):** **Must** be provided when needed, and this rewrite should **correct all errors from I. Correctness** and make the meaning clearer and more concise.

    c.  [III. Engagement]: (ðŸŒŸ Suggestive Reinforcement)
    Provide "suggestions".
        -   **Vocabulary:** Via 'vocab_suggestions', **must** suggest replacements for **overused or bland** basic words.
        -   **Structure:** Via 'feedback', alert to issues with **Sentence Variety** or **content repetition**.

    d.  [IV. Delivery]: (Maintain original standard)
    Detect 'detected_tone', 'formality', and check 'inclusive_language_warning'.

11. [English Sentence Definition]: **A complete English sentence must contain a subject and a predicate, express a complete thought (independent clause), begin with a capital letter, and end with a period, question mark, or exclamation mark.**

12. [Output Format (JSON Schema)]: **Your output 'must' strictly adhere to the following JSON structure object.**

\`\`\`json
{
  "phrase_correction": "STRING",
  "Fpm": "NUMBER",
  "MI": "NUMBER",
  "L_acc_norm": "NUMBER",
  "example": "STRING",
  "grammarCheck": "STRING",
  "spellingSuggestion": "STRING",
  "consistency_score": "NUMBER",
  "example_grammar_validation": {
    "correctness": {
      "is_correct": "BOOLEAN", 
      "errors": [
        {
          "type": "STRING", 
          "description": "STRING", 
          "suggestion": "STRING",
          "priority": "STRING" // Must be one of "Critical", "High", "Low"
        }
      ]
    },
    "clarity": {
      "feedback": "STRING", 
      "rewrite_suggestion": "STRING"
    },
    "engagement": {
      "feedback": "STRING", 
      "vocab_suggestions": "ARRAY<STRING>"
    },
    "delivery": {
      "detected_tone": "STRING",
      "formality": "STRING",
      "inclusive_language_warning": "STRING"
    }
  }
}
\`\`\`
13. **Output ONLY the requested JSON format object.**`;
            
            const userQuery = `
Full Collocation: "${fullPhrase}"
`;
            
            // Call API (Use Consistency Manager params from Prediction tab)
            // --- [MODIFICATION START] Pass userApiKey ---
            const result = await callGeminiAPI(userApiKey, systemPrompt, userQuery, validationSchema, predTemp.value, predTopP.value);
            // --- [MODIFICATION END] ---

            // Restore UI
            // v2.9.3-en: Translated
            displayDone(valLoading, valButton, valButtonText, "Validate Collocation");
            
            // Process API response
            if (result.isError) {
                displayError(valError, result.message);
            } else if (result.Fpm !== undefined && result.MI !== undefined && result.L_acc_norm !== undefined && result.example_grammar_validation !== undefined) {
                // v3.0 Revised: Check for new field
                displayValidationResult(result, fullPhrase);
            } else {
                displayError(valError, "Received unexpected response format (missing example_grammar_validation).");
            }
        }

        // v3.0: Display validation result
        function displayValidationResult(result, fullPhrase) {
            // Deconstruct API response according to S_Naturalness flow
            // v3.0 Update: Deconstruct new fields
            const { Fpm, MI, L_acc_norm, example, grammarCheck, spellingSuggestion, consistency_score, example_grammar_validation } = result;
            
            // S_Naturalness Calculation (7-step process)
            // Example parameters (normalization base)
            const N_LOG_MIN = 0;
            const N_LOG_MAX = 2.0043213738; // log10(100 + 1)
            const M_MIN = 0;
            const M_MAX = 6;
            
            // Weights
            const W_FPM = 0.4;
            const W_MI = 0.4;
            const W_L_ACC = 0.2;

            // Step 3: Log transform
            const N_Log = Math.log10(Fpm + 1);
            // Step 4: N-gram normalization
            const N_norm = (N_Log - N_LOG_MIN) / (N_LOG_MAX - N_LOG_MIN);
            // Step 5: MI normalization
            const M_norm = (MI - M_MIN) / (M_MAX - M_MIN);
            // Step 7: Calculate final naturalness score
            const S_Naturalness = (W_FPM * N_norm) + (W_MI * M_norm) + (W_L_ACC * L_acc_norm);

            // Get Band info based on S_Naturalness (using revised function)
            const bandInfo = getLexicalBandDetails(S_Naturalness);

            let suggestionHtml = '';
            if (spellingSuggestion && spellingSuggestion.trim() !== '') {
                suggestionHtml = `
                    <div class="mt-4">
                        <h4 class="font-semibold text-yellow-300">Suggestion/Alternative</h4>
                        <p class="text-yellow-400 bg-yellow-900/50 p-3 rounded-md">${spellingSuggestion}</p>
                    </div>
                `;
            }

            // v3.0 Update: Handle consistency status
            const consistencyStatus = consistency_score >= 85 ? 'Stable' : 'Check';

            // v2.9.3-en: Translated
            validationResults.innerHTML = `
                <div class="text-center mb-6 border-b border-gray-700 pb-4">
                    <span class="text-xs font-semibold uppercase text-gray-400">Lexical Resource Band</span>
                    <div class="flex items-center justify-center my-2">
                        <!-- S_Naturalness v2.1 Revised: Band display based on S_Naturalness -->
                        <span class="band-tag ${bandInfo.color} text-white text-3xl p-3">Band ${bandInfo.band}</span>
                    </div>
                    <p class="text-gray-300 mt-2 max-w-md mx-auto">${bandInfo.summary}</p>
                </div>

                <div class="space-y-4">
                    <!-- S_Naturalness v2.1 Revised: Show S_Naturalness calculation details -->
                    <div class="bg-gray-700/50 p-4 rounded-md space-y-3">
                        <h4 class="font-semibold text-gray-300 text-center">S_Naturalness (Naturalness) Calculation Details</h4>
                        <div class="grid grid-cols-3 text-sm text-gray-300 text-center">
                            <p><strong>Fpm (Raw Frequency):</strong> <span class="text-green-300">${Fpm.toFixed(4)}</span></p>
                            <p><strong>MI (Mutual Information):</strong> <span class="text-green-300">${MI.toFixed(3)}</span></p>
                            <p><strong>L_Acc (Accuracy):</strong> <span class="text-green-300">${L_acc_norm.toFixed(1)}</span></p>
                        </div>
                        <hr class="border-gray-600">
                        <div class="grid grid-cols-2 text-sm text-gray-300 text-center">
                            <p><strong>N_norm (Frequency Norm.):</strong> <span class="text-blue-300">${N_norm.toFixed(4)}</span> (w: ${W_FPM * 100}%)</p>
                            <p><strong>M_norm (MI Norm.):</strong> <span class="text-blue-300">${M_norm.toFixed(4)}</span> (w: ${W_MI * 100}%)</p>
                        </div>
                        <div class="text-center pt-2">
                            <p class="font-semibold text-gray-300">Final S_Naturalness Score</p>
                            <p class="text-2xl font-bold text-white">${S_Naturalness.toFixed(4)}</p>
                            <p class="text-xs text-gray-400">(${W_FPM}*${N_norm.toFixed(3)} + ${W_MI}*${M_norm.toFixed(3)} + ${W_L_ACC}*${L_acc_norm.toFixed(1)})</p>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-300">Grammar Check</h4>
                        <p class="text-gray-300">${grammarCheck}</p>
                    </div>

                    <div>
                        <h4 class="font-semibold text-gray-300">Example - <span class="text-xs text-gray-400">Band level can be changed</span></h4>
                        <div id="val-example-container" class="bg-gray-700 p-4 rounded-md text-gray-200 text-lg">
                            ${highlight(example, fullPhrase)}
                        </div>
                    </div>
                    <!-- v3.0 Update: Show Consistency and Grammar Validation Layer -->
                    <div id="val-metrics-container" class="text-xs text-gray-400 text-right mt-1 space-y-1">
                        <div>Consistency: ${consistency_score} (${consistencyStatus})</div>
                    </div>
                    <!-- v3.0 Grammar Validation Layer Injection Point -->
                    <div id="val-grammar-validation">
                        ${renderGrammarValidation(example_grammar_validation)}
                    </div>

                    <!-- Band Control Regeneration for Validation -->
                    <div class="flex gap-2 pt-2">
                        <select id="val-band-select" class="w-1/2 bg-gray-600 border border-gray-500 rounded-md p-2 text-sm text-white focus:ring-1 focus:ring-blue-500">
                            <option value="9">Band 9</option>
                            <option value="8">Band 8</option>
                            <option value="7" selected>Band 7</option>
                            <option value="6">Band 6</option>
                            <option value="5">Band 5</option>
                        </select>
                        <button class="regen-button w-1/2 bg-gray-500 hover:bg-gray-400 text-white text-sm font-medium py-2 px-3 rounded-lg transition-colors duration-200 flex items-center justify-center gap-1 disabled:opacity-50"
                                data-index="val"
                                data-context="${fullPhrase}"
                                data-word=""
                                data-type="validation">
                            <span class="regen-text">ðŸ”„ Regenerate</span>
                            <div class="spinner regen-loading hidden"></div>
                        </button>
                    </div>

                    ${suggestionHtml}
                </div>
            `;
            validationResults.classList.remove('hidden');

            // Bind regeneration event for Validation Tab
            document.querySelector('#validationResults .regen-button').addEventListener('click', async function(e) {
                e.preventDefault();
                const button = e.currentTarget;
                const band = document.getElementById('val-band-select').value;
                const context = button.dataset.context; // fullPhrase is stored here
                await handleRegeneration(button, band, context, '', 'validation');
            });
        }
        
        // --- v2.8 Add: Continuation Tab Logic ---

        /**
         * v2.8: Handle Paragraph Continuation & Full Analysis
         */
        async function handleContinuationSubmit(e) {
            e.preventDefault();

            const userApiKey = apiKeyInput.value.trim();
            if (!userApiKey) {
                // v2.9.3-en: Translated
                displayError(contError, "API key is empty. Please provide a valid API key in the field above.", contLoading, contButton, contButtonText, "Predict Next Sentence & Analyze");
                igpvlContError.innerHTML = '';
                igpvlContError.className = 'text-sm rounded-lg';
                return;
            }

            const paragraph = contInput.value.trim();

            // Clear old messages
            igpvlContError.innerHTML = '';
            igpvlContError.className = 'text-sm rounded-lg';
            contError.classList.add('hidden');
            continuationResult.classList.add('hidden');
            continuationResult.innerHTML = '';

            if (!paragraph) {
                // v2.9.3-en: Translated
                displayError(contError, "Please enter a paragraph.", contLoading, contButton, contButtonText, "Predict Next Sentence & Analyze");
                return;
            }

            // Set UI to loading (Before IGPVL)
            // v2.9.3-en: Translated
            displayLoading(contError, contLoading, contButton, contButtonText, "1/2 Validating Input...");

            // --- IGPVL Execution ---
            const igpvlResult = await validateInputGrammar(userApiKey, paragraph, 'contInput', 'academic_essay');
            const isBlocked = displayIgpvlFeedback(igpvlContError, igpvlResult);

            if (isBlocked) {
                // v2.9.3-en: Translated
                displayDone(contLoading, contButton, contButtonText, "Predict Next Sentence & Analyze");
                return; // Stop execution
            }
            // --- IGPVL End ---

            // Set UI to loading
            // v2.9.3-en: Translated
            displayLoading(contError, contLoading, contButton, contButtonText, "2/2 Analyzing & Predicting...");

            // --- Define System Prompt based on v2.8 Spec ---
            const systemPrompt = `You are the "IELTS Writing Assistant (v2.8)". Your task is to perform a full analysis on the user's input text and generate a continuation, strictly adhering to the v2.8 specification.

Your process must follow this exact flow:
1.  **Receive Input:** Get the user's text.
2.  **GVL (Grammar Validation Layer):** Perform a "Grammarly Premium-Level" check. You must check ALL categories from the v2.8 spec:
    * Core Grammar (GVL-CG-01 to 04)
    * Advanced Grammar (GVL-AG-01 to 04)
    * Spelling & Consistency (GVL-SP-01 to 04)
    * Punctuation (GVL-PU-01 to 02)
    * Number Agreement (GVL-NAC-01)
3.  **GCE (Grammar Correction Engine):** Automatically correct ALL errors found by GVL.
4.  **Re-Validation:** The corrected text MUST pass GVL again.
5.  **Run Layers:** Using the GCE-corrected text, run the Clarity, Engagement, and Delivery layers.
6.  **Continuation:** Generate a 'predicted_next_sentence' that is cohesive and logically follows the corrected text. This new sentence MUST also pass GVL/GCE.
7.  **Band Mapping:** Provide a 'band_prediction' (e.g., 8.0) for the *user's input*.
8.  **Output JSON:** Return a single JSON object matching the v2.8 (Section VIII) schema.

**Key Rules:**
* The 'correctness.errors' array MUST be empty, as GCE has fixed all errors. 'correctness.validated' MUST be true.
* 'validation_result' MUST be "Passed".
* All fields in the v2.8 (Section VIII) schema are mandatory.
`;
            const userQuery = `
Input Text:
"${paragraph}"
`;

            // Call API
            const result = await callGeminiAPI(userApiKey, systemPrompt, userQuery, v2_8_Schema, 0.7, 0.95);

            // Restore UI
            // v2.9.3-en: Translated
            displayDone(contLoading, contButton, contButtonText, "Predict Next Sentence & Analyze");

            // Process API response
            if (result.isError) {
                displayError(contError, result.message);
            } else if (result.validation_result === "Passed" && result.continuation) {
                displayContinuationResult(result);
            } else {
                displayError(contError, "Received unexpected response format from v2.8 analysis.");
                console.error("Unexpected v2.8 response:", result);
            }
        }

        /**
         * v2.8: Handle Single Sentence Band Prediction
         */
        async function handleBandPredictionSubmit(e) {
            e.preventDefault();

            const userApiKey = apiKeyInput.value.trim();
            if (!userApiKey) {
                // v2.9.3-en: Translated
                displayError(bandError, "API key is empty. Please provide a valid API key in the field above.", bandLoading, bandButton, bandButtonText, "Predict Sentence Band");
                igpvlBandError.innerHTML = '';
                igpvlBandError.className = 'text-sm rounded-lg';
                return;
            }

            const sentence = bandInput.value.trim();

            // Clear old messages
            igpvlBandError.innerHTML = '';
            igpvlBandError.className = 'text-sm rounded-lg';
            bandError.classList.add('hidden');
            bandPredictionResult.classList.add('hidden');
            bandPredictionResult.innerHTML = '';

            if (!sentence) {
                // v2.9.3-en: Translated
                displayError(bandError, "Please enter a sentence.", bandLoading, bandButton, bandButtonText, "Predict Sentence Band");
                return;
            }

            // Set UI to loading (Before IGPVL)
            // v2.9.3-en: Translated
            displayLoading(bandError, bandLoading, bandButton, bandButtonText, "1/2 Validating Input...");

            // --- IGPVL Execution ---
            const igpvlResult = await validateInputGrammar(userApiKey, sentence, 'bandInput', 'academic_sentence');
            const isBlocked = displayIgpvlFeedback(igpvlBandError, igpvlResult);

            if (isBlocked) {
                // v2.9.3-en: Translated
                displayDone(bandLoading, bandButton, bandButtonText, "Predict Sentence Band");
                return; // Stop execution
            }
            // --- IGPVL End ---

            // Set UI to loading
            // v2.9.3-en: Translated
            displayLoading(bandError, bandLoading, bandButton, bandButtonText, "2/2 Predicting Band...");

            // --- Define System Prompt based on v2.8 Spec (Task B) ---
            const systemPrompt = `You are the "IELTS Band Mapper (v2.8)". Your task is to analyze the user's single input sentence and predict its IELTS Band score.
1.  Run the GVL/GCE process to ensure the sentence is 100% grammatically correct.
2.  Evaluate the corrected sentence for lexical resource, grammatical range, and coherence.
3.  Return a single JSON object matching the 'bandPredictionSchema'.
4.  'validation_result' must be "Passed".
`;
            const userQuery = `Input Sentence: "${sentence}"`;

            // Call API
            const result = await callGeminiAPI(userApiKey, systemPrompt, userQuery, bandPredictionSchema, 0.5, 0.95);

            // Restore UI
            // v2.9.3-en: Translated
            displayDone(bandLoading, bandButton, bandButtonText, "Predict Sentence Band");

            // Process API response
            if (result.isError) {
                displayError(bandError, result.message);
            } else if (result.band_prediction) {
                displayBandPredictionResult(result);
            } else {
                displayError(bandError, "Received unexpected response format for band prediction.");
            }
        }

        /**
         * v2.8: Display results for Paragraph Continuation
         */
        function displayContinuationResult(result) {
            const { continuation } = result;

            // v2.9.3-en: Translated
            let html = `
                <div class="bg-gray-700 p-5 rounded-lg border border-purple-500/50 space-y-4">
                    <h3 class="text-xl font-bold text-white">Analysis & Continuation Complete</h3>
                    
                    <!-- V. Continuation Result -->
                    <div>
                        <h5 class="font-semibold text-white">V. Continuation (User Story 3)</h5>
                        <p class="text-gray-400">Predicted Band for your text: <span class="band-tag bg-purple-600 text-white">Band ${continuation.band_prediction.toFixed(1)}</span></p>
                        <p class="font-semibold text-gray-300 mt-2">Predicted Next Sentence:</p>
                        <div class="bg-gray-600 p-3 rounded-md text-gray-200 mt-1">
                            ${continuation.predicted_sentence}
                        </div>
                    </div>
                    
                    <!-- Render the full v2.8 analysis report -->
                    ${renderV2_8_Validation(result)}
                </div>
            `;
            
            continuationResult.innerHTML = html;
            continuationResult.classList.remove('hidden');
        }

        /**
         * v2.8: Display results for Sentence Band Prediction
         */
        function displayBandPredictionResult(result) {
            // v2.9.3-en: Translated
            let html = `
                <div class="bg-gray-700 p-5 rounded-lg border border-indigo-500/50 text-center">
                    <h3 class="text-lg font-semibold text-white">Sentence Band Prediction</h3>
                    <p class="text-5xl font-bold text-white my-4">${result.band_prediction.toFixed(1)}</p>
                    <span class="band-tag bg-indigo-600 text-white">Validation: ${result.validation_result}</span>
                </div>
            `;
            bandPredictionResult.innerHTML = html;
            bandPredictionResult.classList.remove('hidden');
        }

        // --- [MODIFICATION START] v2.9.3 SWOT Analysis Logic ---

        /**
         * v2.9.3: Handle Cohesion SWOT Analysis Submit
         */
        async function handleSwotSubmit(e) {
            e.preventDefault();

            const userApiKey = apiKeyInput.value.trim();
            if (!userApiKey) {
                // v2.9.3-en: Translated
                displayError(swotError, "API key is empty. Please provide a valid API key in the field above.", swotLoading, swotButton, swotButtonText, "Compare & Run SWOT Analysis");
                igpvlSwotError.innerHTML = '';
                igpvlSwotError.className = 'text-sm rounded-lg';
                return;
            }

            const paragraph = swotInputParagraph.value.trim();
            const sentence1 = swotInputSentence1.value.trim();
            const sentence2 = swotInputSentence2.value.trim();

            // Clear old messages
            igpvlSwotError.innerHTML = '';
            igpvlSwotError.className = 'text-sm rounded-lg';
            swotError.classList.add('hidden');
            swotResult.classList.add('hidden');
            swotResult.innerHTML = '';

            // v2.9.3: Check all three fields
            if (!paragraph || !sentence1 || !sentence2) {
                // v2.9.3-en: Translated
                displayError(swotError, "Please enter the previous paragraph and both sentence options.", swotLoading, swotButton, swotButtonText, "Compare & Run SWOT Analysis");
                return;
            }

            // --- IGPVL Step 1 ---
            // v2.9.3-en: Translated
            displayLoading(swotError, swotLoading, swotButton, swotButtonText, "1/4 Validating Option 1...");
            const igpvlResult1 = await validateInputGrammar(userApiKey, sentence1, 'swotInput1', 'academic_essay_sentence');
            const isBlocked1 = displayIgpvlFeedback(igpvlSwotError, igpvlResult1);

            if (isBlocked1) {
                // v2.9.3-en: Translated
                displayDone(swotLoading, swotButton, swotButtonText, "Compare & Run SWOT Analysis");
                return; // Stop execution
            }

            // --- IGPVL Step 2 ---
            // v2.9.3-en: Translated
            displayLoading(swotError, swotLoading, swotButton, swotButtonText, "2/4 Validating Option 2...");
            const igpvlResult2 = await validateInputGrammar(userApiKey, sentence2, 'swotInput2', 'academic_essay_sentence');
            const isBlocked2 = displayIgpvlFeedback(igpvlSwotError, igpvlResult2);
            
            // Clear feedback after success
            if (!isBlocked1 && !isBlocked2) {
                 igpvlSwotError.innerHTML = '';
                 igpvlSwotError.className = 'text-sm rounded-lg';
            }

            if (isBlocked2) {
                // v2.9.3-en: Translated
                displayDone(swotLoading, swotButton, swotButtonText, "Compare & Run SWOT Analysis");
                return; // Stop execution
            }

            // --- API Call 1: Comparison ---
            // v2.9.3-en: Translated
            displayLoading(swotError, swotLoading, swotButton, swotButtonText, "3/4 Comparing Options...");
            
            const comparisonSystemPrompt = `You are an expert IELTS examiner, specializing ONLY in the 'Cohesion and Coherence' (C&C) band descriptors.
Your task is to compare two potential opening sentences (Option 1, Option 2) based on how well they connect to the preceding paragraph.
You MUST decide which one is better based on C&C criteria:
1.  **Textual Cohesion:** Use of linking devices (e.g., 'However', 'this', 'it').
2.  **Conceptual Coherence:** How logically the topic follows (e.g., contrast, addition, result, or abrupt shift).

Return ONLY a valid JSON object matching the requested schema.`;
            
            const comparisonUserQuery = `
{
  "input_paragraph": "${paragraph}",
  "option_1": "${sentence1}",
  "option_2": "${sentence2}"
}
`;

            const comparisonResult = await callGeminiAPI(userApiKey, comparisonSystemPrompt, comparisonUserQuery, swotComparisonSchema, 0.3, 0.95);

            if (comparisonResult.isError) {
                // v2.9.3-en: Translated
                displayError(swotError, comparisonResult.message, swotLoading, swotButton, swotButtonText, "Compare & Run SWOT Analysis");
                return;
            }
            
            // --- API Call 2: SWOT Analysis on Best Option ---
            // v2.9.3-en: Translated
            displayLoading(swotError, swotLoading, swotButton, swotButtonText, "4/4 Running SWOT Analysis...");
            
            const bestSentenceIndex = comparisonResult.best_option_index;
            const bestSentence = (bestSentenceIndex === 0) ? sentence1 : sentence2;
            const sentences = [sentence1, sentence2]; // For display

            // Use the *original* SWOT system prompt
            const swotSystemPrompt = `You are an expert IELTS examiner, specializing ONLY in the 'Cohesion and Coherence' (C&C) band descriptors.
Your task is to analyze the connection between a given paragraph and the user's proposed opening sentence for the *next* paragraph.
You MUST generate a SWOT analysis based *strictly* on the IELTS C&C criteria.

**Evaluation Criteria:**
1.  **Grammatical Fluency:** How smoothly does the opening sentence follow the paragraph grammatically?
2.  **Textual Cohesion:** How effectively are linking devices used? (e.g., transition words like 'However', 'Furthermore'; pronoun references like 'this', 'it', 'they'). Are references clear?
3.  **Conceptual Coherence:** How logically does the topic of the opening sentence follow from the paragraph? (e.g., Is it a natural contrast, an added point, a result, or an abrupt shift?)

**SWOT Framework (Mandatory):**
* **Strengths (S):** Identify positive C&C links. (e.g., "Good use of 'On the other hand' to signal contrast.")
* **Weaknesses (W):** Identify clear C&C errors. (e.g., "Missing logical connector; the transition is too abrupt.", "Unclear pronoun 'it'; what does 'it' refer to?")
* **Opportunities (O):** Suggest specific improvements for this transition. (e.g., "Consider adding 'In addition,' to clarify this is a new point.", "Replacing 'This' with 'This issue' would strengthen the reference.")
* **Threats (T):** Warn about risks if these weaknesses persist. (e.g., "This abrupt shift, if repeated, will damage the essay's logical flow and lower the C&C score.", "Overusing 'And' as a connector is a Band 5/6 trait.")

**Output:**
You must provide an 'overall_assessment' and a 'cohesion_band_estimate' (from 5.0 to 9.0) for *this specific transition*.
Return ONLY a valid JSON object matching the requested schema.
`;
            const swotUserQuery = `
{
  "input_paragraph": "${paragraph}",
  "user_opening_sentence": "${bestSentence}"
}
`;
            const swotAnalysisResult = await callGeminiAPI(userApiKey, swotSystemPrompt, swotUserQuery, swotSchema, 0.5, 0.95);

            // Restore UI
            // v2.9.3-en: Translated
            displayDone(swotLoading, swotButton, swotButtonText, "Compare & Run SWOT Analysis");

            // Process final results
            if (swotAnalysisResult.isError) {
                displayError(swotError, swotAnalysisResult.message);
                // Still show the comparison result if it worked
                displaySwotCombinedResult(comparisonResult, null, sentences);
            } else {
                displaySwotCombinedResult(comparisonResult, swotAnalysisResult, sentences);
            }
        }

        /**
         * v2.9.3: Display combined results for Comparison and SWOT
         */
        function displaySwotCombinedResult(comparisonResult, swotAnalysisResult, sentences) {
            
            const { best_option_index, comparison_reason, worst_option_feedback } = comparisonResult;
            const chosenOptionIndex = best_option_index; // 0 or 1
            const weakerOptionIndex = 1 - chosenOptionIndex; // 1 or 0

            // --- Part 1: Comparison Result ---
            // v2.9.3-en: Translated
            let html = `
                <div class="bg-gray-700 p-5 rounded-lg border border-teal-500/50 space-y-4">
                    <h3 class="text-xl font-bold text-white">C&C Connection Comparison Result</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Best Option -->
                        <div class="bg-gray-800 p-4 rounded-lg border-2 border-green-500">
                            <h5 class="text-lg font-semibold text-green-400">ðŸ† Best Option (Option ${chosenOptionIndex + 1})</h5>
                            <p class="text-gray-300 italic my-2">"${sentences[chosenOptionIndex]}"</p>
                            <p class="text-sm text-gray-400">${comparison_reason}</p>
                        </div>
                        
                        <!-- Weaker Option -->
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-600">
                            <h5 class="text-lg font-semibold text-yellow-400">Other Option (Option ${weakerOptionIndex + 1})</h5>
                            <p class="text-gray-300 italic my-2">"${sentences[weakerOptionIndex]}"</p>
                            <p class="text-sm text-gray-400">${worst_option_feedback}</p>
                        </div>
                    </div>
                </div>
            `;

            // --- Part 2: SWOT Analysis Result (if successful) ---
            if (swotAnalysisResult && swotAnalysisResult.strengths) {
                const { strengths, weaknesses, opportunities, threats, overall_assessment, cohesion_band_estimate } = swotAnalysisResult;

                const renderList = (items, color) => {
                    if (!items || items.length === 0) {
                        // v2.9.3-en: Translated
                        return `<li class="text-gray-400">None</li>`;
                    }
                    return items.map(item => `<li class="text-${color}-300">${item}</li>`).join('');
                };
                
                const getBandColor = (band) => {
                    if (band >= 8.0) return 'bg-indigo-600';
                    if (band >= 7.0) return 'bg-blue-600';
                    if (band >= 6.0) return 'bg-yellow-600';
                    return 'bg-red-600';
                };

                // v2.9.3-en: Translated
                html += `
                    <div class="bg-gray-700 p-5 rounded-lg border border-teal-500/50 space-y-4 mt-6">
                        <div class="flex justify-between items-center border-b border-gray-600 pb-3">
                            <h3 class="text-xl font-bold text-white">SWOT Analysis Report (for Option ${chosenOptionIndex + 1})</h3>
                            <span class="band-tag ${getBandColor(cohesion_band_estimate)} text-white">Estimated C&C Band: ${cohesion_band_estimate.toFixed(1)}</span>
                        </div>
                        
                        <div class="mb-4">
                            <h5 class="font-semibold text-white">Overall Assessment</h5>
                            <p class="text-gray-300 text-sm">${overall_assessment}</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Strengths -->
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <h5 class="text-lg font-semibold text-green-400">Strengths</h5>
                                <ul class="list-disc list-inside space-y-1 mt-2 text-sm">
                                    ${renderList(strengths, 'green')}
                                </ul>
                            </div>
                            
                            <!-- Weaknesses -->
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <h5 class="text-lg font-semibold text-red-400">Weaknesses</h5>
                                <ul class="list-disc list-inside space-y-1 mt-2 text-sm">
                                    ${renderList(weaknesses, 'red')}
                                </ul>
                            </div>

                            <!-- Opportunities -->
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <h5 class="text-lg font-semibold text-blue-400">Opportunities</h5>
                                <ul class="list-disc list-inside space-y-1 mt-2 text-sm">
                                    ${renderList(opportunities, 'blue')}
                                </ul>
                            </div>

                            <!-- Threats -->
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <h5 class="text-lg font-semibold text-yellow-400">Threats</h5>
                                <ul class="list-disc list-inside space-y-1 mt-2 text-sm">
                                    ${renderList(threats, 'yellow')}
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            } else if (swotAnalysisResult && swotAnalysisResult.isError) {
                // v2.9.3-en: Translated
                html += `<div class="bg-red-900/50 text-red-400 p-4 rounded-lg mt-6">SWOT Analysis Failed: ${swotAnalysisResult.message}</div>`;
            }
            
            swotResult.innerHTML = html;
            swotResult.classList.remove('hidden');
        }
        
        // --- [MODIFICATION END] v2.9.3 SWOT Analysis Logic ---


        // --- Tab Switching Logic ---
        function switchTab(activeTab) {
            // v2.8 Update: Handle 3 tabs
            const allTabs = [tabs.prediction, tabs.validation, tabs.continuation];
            const allContents = [contents.prediction, contents.validation, contents.continuation];

            allTabs.forEach(tab => {
                tab.classList.add('text-gray-400', 'hover:bg-gray-800/50');
                tab.classList.remove('text-white', 'bg-gray-800', '-mb-px', 'border-t', 'border-l', 'border-r', 'border-gray-700');
            });

            allContents.forEach(content => {
                content.classList.add('hidden');
            });

            const activeTabEl = tabs[activeTab];
            const activeContentEl = contents[activeTab];

            if (activeTabEl && activeContentEl) {
                activeTabEl.classList.remove('text-gray-400', 'hover:bg-gray-800/50');
                activeTabEl.classList.add('text-white', 'bg-gray-800', '-mb-px', 'border-t', 'border-l', 'border-r', 'border-gray-700');
                activeContentEl.classList.remove('hidden');
            }
        }

        // --- Initial Event Bindings ---
        tabs.prediction.addEventListener('click', () => switchTab('prediction'));
        tabs.validation.addEventListener('click', () => switchTab('validation'));
        tabs.continuation.addEventListener('click', () => switchTab('continuation')); // v2.8 Add
        
        predForm.addEventListener('submit', handlePredictionSubmit);
        customWordForm.addEventListener('submit', handleCustomWordCheck); // Bind custom word form
        valForm.addEventListener('submit', handleValidationSubmit);
        
        // v2.8 Add
        continuationForm.addEventListener('submit', handleContinuationSubmit);
        bandPredictionForm.addEventListener('submit', handleBandPredictionSubmit);

        // v2.9 Add (v2.9.3 logic is handled here)
        swotForm.addEventListener('submit', handleSwotSubmit);

        // Select first tab by default
        switchTab('prediction');

        // v2.9.3: Version note
        console.log("IELTS Writing Assistant v2.9.3_en (UI Optimized v3.1) loaded.");

    </script>
</body>
</html>