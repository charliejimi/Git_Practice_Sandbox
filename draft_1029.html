<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Smart Vocabulary & Collocation System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base Style */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Highlight Style */
        .highlight {
            background-color: rgba(147, 197, 253, 0.4); /* blue-300/40 */
            color: #dbeafe; /* text-blue-100 */
            font-weight: 600;
            padding: 0 2px;
            border-radius: 3px;
            white-space: nowrap; /*
Ensure highlighted part does not wrap */
        }
        /* Hide Element */
        .hidden {
            display: none;
        }
        /* Simple Spinner Animation */
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #ffffff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .band-tag {
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- Title -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">IELTS Smart Vocabulary & Collocation System</h1>
            <!-- v2.6 IGPVL Update: Modified title -->
            <p class="text-lg text-gray-400 mt-2">Integrating PPL, S_Naturalness, GVL (v3.0) & IGPVL (v2.6)</p>
        </header>

        <!-- Feature Tabs -->
        <div class="flex justify-center mb-6 border-b border-gray-700">
            <button id="tabPrediction" class="tab-button px-6 py-3 font-semibold text-white bg-gray-800 rounded-t-lg -mb-px border-t border-l border-r border-gray-700">
                1. Prediction
            </button>
            <button id="tabValidation" class="tab-button px-6 py-3 font-semibold text-gray-400 hover:bg-gray-800/50 rounded-t-lg">
                2. Validation
            </button>
        </div>

        <!-- Main Content Area -->
        <main>
            <!-- 1. Prediction Content -->
            <div id="predictionContent">
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl space-y-6">
                    <form id="predictionForm" class="space-y-4">
                        <label for="predInput" class="block text-sm font-medium text-gray-300 mb-2">Input Context Phrase</label>
                        <input type="text" id="predInput" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., The government should implement effective policies to...">
                        
                        <!-- v2.6 IGPVL Add: Prediction input error reporting area -->
                        <div id="igpvlPredError" class="text-sm rounded-lg"></div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="predPos" class="block text-sm font-medium text-gray-300 mb-2">Specify POS (POS Filter)</label>
                                <select id="predPos" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="any">Any POS (Any)</option>
                                    <option value="N">Noun</option>
                                    <option value="V">Verb</option>
                                    <option value="Adj">Adjective</option>
                                    <option value="Adv">Adverb</option>
                                </select>
                            </div>
                            <div>
                                <label for="predTask" class="block text-sm font-medium text-gray-300 mb-2">IELTS Task</label>
                                <select id="predTask" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="general">General</option>
                                    <option value="task1">Task 1</option>
                                    <option value="task2">Task 2</option>
									<option value="TechWriting">TechWriting</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="pt-4 border-t border-gray-700">
                            <h3 class="text-sm font-medium text-gray-300 mb-2">Consistency Manager</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <label class="block">
                                    <span class="text-xs text-gray-400">Temperature</span>
                                    <input type="number" id="predTemp" value="0.7" step="0.1" min="0.1" max="1.0" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white text-sm">
                                </label>
                                <label class="block">
                                    <span class="text-xs text-gray-400">Top-P (Nucleus Sampling)</span>
                                    <input type="number" id="predTopP" value="0.95" step="0.05" min="0.0" max="1.0" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white text-sm">
                                </label>
                                <label class="block">
                                    <span class="text-xs text-gray-400">Context Words</span>
                                    <!-- T1.4 Fix: Remove disabled -->
                                    <input type="number" id="predContextLen" value="20" min="5" max="50" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white text-sm">
                                </label>
                                <label class="block">
                                    <span class="text-xs text-gray-400">Self-Consistency Iterations</span>
                                    <input type="number" id="predSC" value="3" min="1" max="5" disabled class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-gray-500 text-sm">
                                </label>
                            </div>
                        </div>

                        <button type="submit" id="predButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2 disabled:opacity-50 mt-4">
                            <span id="predButtonText">Get 6 Predictions</span>
                            <div id="predLoading" class="spinner hidden"></div>
                        </button>
                    </form>

                    <!-- Custom Word Validation Area -->
                    <div class="pt-6 border-t border-gray-700 mt-6">
                        <h2 class="text-xl font-semibold text-white mb-3">2. Custom Word Check</h2>
                        <form id="customWordForm" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <input type="text" id="customWordInput" class="bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500" placeholder="Enter desired word (e.g., 'growth')">
                                <button type="submit" id="customButton" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2 disabled:opacity-50">
                                    <span id="customButtonText">Check Word</span>
                                    <div id="customLoading" class="spinner hidden"></div>
                                </button>
                            </div>
                        </form>
                        <!-- v2.6 IGPVL Add: Custom word error reporting area -->
                        <div id="igpvlCustomError" class="text-sm rounded-lg mt-4"></div>
                        <div id="customResults" class="mt-4"></div>
                    </div>
                </div>

                <!-- Prediction Results Area -->
                <div id="predError" class="text-red-400 bg-red-900/50 p-4 rounded-lg mt-6 hidden"></div>
                <div id="predictionResults" class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Prediction result cards will be dynamically inserted here -->
                </div>
            </div>

            <!-- 2. Validation Content -->
            <div id="validationContent" class="hidden">
                <form id="validationForm" class="bg-gray-800 p-6 rounded-lg shadow-xl space-y-6">
                    <div>
                        <label for="valInput1" class="block text-sm font-medium text-gray-300 mb-2">Collocation - Initial Phrase</label>
                        <input type="text" id="valInput1" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., make a">
                    </div>
                    <div>
                        <label for="valInput2" class="block text-sm font-medium text-gray-300 mb-2">Collocation - Target Word/Phrase</label>
                        <input type="text" id="valInput2" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., decision">
                    </div>
                    
                    <!-- v2.6 IGPVL Add: Validation input error reporting area -->
                    <div id="igpvlValError" class="text-sm rounded-lg"></div>

                    <button type="submit" id="valButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2 disabled:opacity-50">
                        <span id="valButtonText">Validate Collocation</span>
                        <div id="valLoading" class="spinner hidden"></div>
                    </button>
                </form>

                <!-- Validation Results Area -->
                <div id="valError" class="text-red-400 bg-red-900/50 p-4 rounded-lg mt-6 hidden"></div>
                <div id="validationResults" class="mt-8 bg-gray-800 p-6 rounded-lg shadow-xl hidden">
                    <!-- Validation results will be dynamically inserted here -->
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript Logic -->
    <script type="module">
        // --- Gemini API Key (Leave as an empty string, Canvas will auto-fill) ---
        // v2.6 IGPVL Note: IGPVL and GVL use the same API endpoint and key
        const apiKey = "AIzaSyAzBdrm2Ma3LWkdo87hC_TZlLPc7cuqNEo";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // --- DOM Element References ---
        const tabs = {
            prediction: document.getElementById('tabPrediction'),
            validation: document.getElementById('tabValidation')
        };
        const contents = {
            prediction: document.getElementById('predictionContent'),
            validation: document.getElementById('validationContent')
        };
        
        // Prediction-related elements
        const predForm = document.getElementById('predictionForm');
        const predInput = document.getElementById('predInput');
        const predPos = document.getElementById('predPos');
        const predTask = document.getElementById('predTask');
        const predTemp = document.getElementById('predTemp');
        const predTopP = document.getElementById('predTopP');
        const predContextLen = document.getElementById('predContextLen'); // T1.4 Get DOM
        const predButton = document.getElementById('predButton');
        const predButtonText = document.getElementById('predButtonText');
        const predLoading = document.getElementById('predLoading');
        const predError = document.getElementById('predError');
        const predictionResults = document.getElementById('predictionResults');
        const igpvlPredError = document.getElementById('igpvlPredError'); // v2.6 IGPVL Add

        // Custom Word-related elements
        const customWordForm = document.getElementById('customWordForm');
        const customWordInput = document.getElementById('customWordInput');
        const customButton = document.getElementById('customButton');
        const customButtonText = document.getElementById('customButtonText');
        const customLoading = document.getElementById('customLoading');
        const customResults = document.getElementById('customResults');
        const igpvlCustomError = document.getElementById('igpvlCustomError'); // v2.6 IGPVL Add

        // Validation-related elements
        const valForm = document.getElementById('validationForm');
        const valInput1 = document.getElementById('valInput1');
        const valInput2 = document.getElementById('valInput2');
        const valButton = document.getElementById('valButton');
        const valButtonText = document.getElementById('valButtonText');
        const valLoading = document.getElementById('valLoading');
        const valError = document.getElementById('valError');
        const validationResults = document.getElementById('validationResults');
        const igpvlValError = document.getElementById('igpvlValError'); // v2.6 IGPVL Add

        // T1.8 / T2.8 Fix: Regeneration history
        const regenerationHistory = {};

        // --- v2.6 IGPVL (Input Grammar Pre-Validation Layer) Schema ---
        // Schema defined according to user's v2.6 specification
        const igpvlSchema = {
            "type": "OBJECT",
            "description": "Real-time feedback from Input Grammar Pre-Validation Layer (IGPVL)",
            "properties": {
                "input_id": { "type": "STRING", "description": "Unique ID corresponding to the request" },
                "status": { "type": "STRING", "enum": ["passed", "warning", "blocked"], "description": "Validation status" },
                "error_count": { "type": "NUMBER", "description": "Total number of grammar errors detected" },
                "severity": { "type": "STRING", "enum": ["none", "minor", "major"], "description": "Overall error severity" },
                "errors": {
                    "type": "ARRAY",
                    "description": "List of detected errors",
                    "items": {
                        "type": "OBJECT",
                        "properties": {
                            "type": { "type": "STRING", "enum": ["subject_verb_agreement","tense_error","article_error","pronoun_error","number_agreement","dangling_modifier","incomplete_comparison","double_negative","inconsistent_tense_shift","spelling","contextual_spelling","capitalization_error","number_format_error","hyphenation_error","end_punctuation","internal_punctuation","quotation_marks"],"description": "Error type, must be selected from a predefined list to match the four major check categories." },
                            "message": { "type": "STRING", "description": "Description of the error" },
                            "suggestion": { "type": "STRING", "description": "Grammatically correct suggestion (can be a full sentence or fragment)" },
                            "severity": { "type": "STRING", "enum": ["minor", "major"], "description": "Severity of this error" },
                            "code": { "type": "STRING", "description": "Standard-compliant error code (e.g., 'IGPVL-CORE-XX')" }
                        },
                        "required": ["type", "message", "suggestion", "code"]
                    }
                },
                "recommendation": { "type": "STRING", "description": "Overall recommendation for the user, providing a grammatically correct sentence" },
                "timestamp": { "type": "STRING", "format": "date-time", "description": "Timestamp in ISO 8601 format" }
            },
            "required": ["input_id", "status", "error_count", "severity", "errors", "recommendation", "timestamp"]
        };

        // --- v3.0 GVL (Grammar Validation Layer) Schema ---
        // Shared schema defined according to user's specification (I-IV)
        const grammarValidationSchemaObject = {
            "type": "OBJECT",
            "description": "Detailed analysis results from Grammar Validation Layer v3.0",
            "properties": {
                "correctness": {
                    "type": "OBJECT",
                    "properties": {
                        "errors": {
                            "type": "ARRAY",
							"description": "I. Correctness (Grammar, Spelling, Punctuation). List of all 'Correctness' related grammar, spelling, punctuation errors. Empty array [] means 'Check passed'.",
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "type": { "type": "STRING", "description": "Error type (e.g., 'Subject-Verb Agreement', 'Tense Error', 'Article Error', 'Pronoun Error', 'Number Agreement', 'Dangling Modifier', 'Incomplete Comparison', 'Double Negative', 'Inconsistent Tense Shift', 'General Spelling', 'Contextual Spelling', 'Capitalization Error', 'Number Format Error', 'Hyphenation Error', 'End Punctuation Error', 'Internal Punctuation Misuse - incl. Comma/Semicolon/Colon')"},
                                    "original": { "type": "STRING", "description": "Original incorrect fragment" },
                                    "correction": { "type": "STRING", "description": "Correction suggestion" },
                                    "explanation": { "type": "STRING", "description": "Brief explanation" }
                                },
                                "required": ["type", "original", "correction"]
                            }
                        }
                    },
                    "required": ["errors"]
                },
                "clarity": {
                    "type": "OBJECT",
					"description": "II. Clarity - Suggestive",
                    "properties": {
                        "feedback": { "type": "ARRAY", "description": "Clarity issues (e.g., 'Run-on Sentence', 'Sentence Fragment', 'Wordiness', 'Fluency')", "items": { "type": "STRING" } },
                        "rewrite_suggestion": { "type": "STRING", "description": "Complete rewrite suggestion for complex sentences (empty string if none)" },
                        "passive_voice_warning": { "type": "BOOLEAN", "description": "Whether passive voice is overused" }
                    },
                    "required": ["feedback", "rewrite_suggestion", "passive_voice_warning"]
                },
                "engagement": {
                    "type": "OBJECT",
                    "properties": {
                        "feedback": { "type": "ARRAY", "description": "Engagement issues (e.g., 'Monotonous Vocabulary', 'Repetitive Sentence Structure')", "items": { "type": "STRING" } },
                        "vocab_suggestions": {
                            "type": "ARRAY",
							"description": "Vocabulary enhancement suggestions (replace dull or overused words)",
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "original": { "type": "STRING" },
                                    "suggestion": { "type": "STRING" }
                                },
                                "required": ["original", "suggestion"]
                            }
                        }
                    },
                    "required": ["feedback", "vocab_suggestions"]
                },
                "delivery": {
                    "type": "OBJECT",
					"description": "IV. Delivery / Tone",
                    "properties": {
                        "detected_tone": { "type": "STRING", "description": "Detected tone" },
                        "formality": { "type": "STRING", "description": "Formality (e.g., 'Formal', 'Informal', 'Colloquial')" },
                        "inclusive_language_warning": { "type": "BOOLEAN", "description": "Whether non-inclusive language is present" }
                    },
                    "required": ["detected_tone", "formality", "inclusive_language_warning"]
                }
            },
            "required": ["correctness", "clarity", "engagement", "delivery"]
        };

        // --- Core Helper Functions ---

        /**
         * T1.4 Fix: Truncate context to the last N words
         * @param {string} text - Full input text
         * @param {number} wordCount - Number of last words to keep
         * @returns {string} - Truncated text
         */
        function truncateContext(text, wordCount) {
            if (!text) return "";
            const words = text.trim().split(/\s+/); // Split by whitespace
            const count = parseInt(wordCount, 10) || 20; // Default 20
            
            if (words.length <= count) {
                return text.trim(); // No truncation needed
            }
            
            return words.slice(-count).join(' '); // Take last N words
        }

        /**
         * Get Band commentary based on PPL (Cohesion & Coherence)
         * @param {number} ppl - Perplexity
         * @returns {object} - { band, summary, color }
         */
        function getCohesionBandDetails(ppl) {
            if (ppl <= 20) {
                return { band: 9, summary: 'Fluent, natural cohesion, extremely high coherence.', color: 'bg-indigo-600' };
            } else if (ppl <= 40) {
                return { band: 8, summary: 'Clear structure, smooth cohesion, only occasional minor unnaturalness.', color: 'bg-purple-600' };
            } else if (ppl <= 60) {
                return { band: 7, summary: 'Coherent but slightly mechanical; some connectors or references are imprecise.', color: 'bg-blue-600' };
            } else if (ppl <= 80) {
                return { band: 6, summary: 'Overall logic exists, but discourse cohesion is occasionally unbalanced or repetitive.', color: 'bg-yellow-600' };
            } else {
                return { band: 5, summary: 'Loose structure, lacking natural or overly mechanical links between sentences.', color: 'bg-red-600' };
            }
        }

        /**
         * [S_Naturalness v2.1 Revised]
         * Get Band commentary based on S_Naturalness (Lexical Resource)
         * @param {number} s - S_Naturalness score
         * @returns {object} - { band, summary, color }
         */
        function getLexicalBandDetails(s) {
             if (s >= 0.85) {
                return { band: 9, summary: 'Completely natural, very high collocation strength; near-native expression.', color: 'bg-indigo-600' };
            } else if (s >= 0.75) {
                return { band: 8, summary: 'Fluent and flexible, minor misuse; still high-level collocation.', color: 'bg-purple-600' };
            } else if (s >= 0.60) {
                return { band: 7, summary: 'Understandable and common, but slightly mechanical or repetitive.', color: 'bg-blue-600' };
            } else if (s >= 0.40) {
                return { band: 6, summary: 'Moderate naturalness; meaning is clear but collocation is not idiomatic.', color: 'bg-yellow-600' };
            } else {
                // S < 0.40
                return { band: 5, summary: 'Unnatural or awkward; replacement suggested.', color: 'bg-red-600' };
            }
        }

        /**
         * Highlight a phrase within an example sentence
         * @param {string} text - The full example sentence
         * @param {string} phraseToHighlight - The phrase to highlight
         * @returns {string} - String containing HTML <span class="highlight">
         */
        function highlight(text, phraseToHighlight) {
            if (!text || !phraseToHighlight) return text;
            // Replace all non-word characters with whitespace to ensure correct word boundary matching
            const cleanedPhrase = phraseToHighlight.trim().replace(/[\W_]+/g,"\\s*");
            // Use regex for case-insensitive replacement
            const regex = new RegExp(`(${cleanedPhrase})`, 'gi');
            
            // Use match function to preserve original case
            return text.replace(regex, (match, p1) => {
                // p1 is the original matched group, ensure we only highlight this part
                return `<span class="highlight">${match}</span>`;
            });
        }

        /**
         * v3.0: Render HTML report for Grammar Validation Layer
         * @param {object} validation - grammar_validation object
         * @returns {string} - Formatted HTML
         */
        function renderGrammarValidation(validation) {
            if (!validation) {
                return '<div class="text-xs text-red-400">Grammar validation data missing.</div>';
            }

            let html = '<div class="space-y-2 mt-2 pt-2 border-t border-gray-600 text-xs text-left">'; // Change to text-left
            
            // I. Correctness
            const { correctness, clarity, engagement, delivery } = validation;
            html += '<h5 class="font-semibold text-gray-300">Grammar Validation Report (v3.1)</h5>';
            
            if (correctness && correctness.errors && correctness.errors.length > 0) {
                html += `<div class="text-yellow-400">I. Correctness: ${correctness.errors.length} critical error(s) found</div>`;
                html += '<ul class="list-disc list-inside text-gray-400 pl-2">';
                correctness.errors.slice(0, 10).forEach(err => { // Show max 10
                    html += `<li>[${err.type}] <strong>"${err.original}"</strong> &rarr; <strong>"${err.correction}"</strong></li>`;
                });
                html += '</ul>';
            } else {
                html += '<div class="text-green-400">I. Correctness: Check passed.</div>';
            }

            // II. Clarity
            if (clarity && (clarity.feedback.length > 0 || clarity.rewrite_suggestion || clarity.passive_voice_warning)) {
                html += `<div class="text-blue-300 mt-1">II. Clarity:</div>`;
                html += '<ul class="list-disc list-inside text-gray-400 pl-2">';
                clarity.feedback.slice(0, 10).forEach(fb => html += `<li>${fb}</li>`); // Max 10
                if (clarity.passive_voice_warning) html += '<li>Note: Excessive use of passive voice.</li>';
                if (clarity.rewrite_suggestion) html += `<li>Rewrite Suggestion: <span class="text-blue-200">${clarity.rewrite_suggestion}</span></li>`;
                html += '</ul>';
            } else {
                html += '<div class="text-green-400">II. Clarity: Check passed.</div>';
            }

            // III. Engagement
            if (engagement && (engagement.feedback.length > 0 || engagement.vocab_suggestions.length > 0)) {
                html += `<div class="text-purple-300 mt-1">III. Engagement:</div>`;
                html += '<ul class="list-disc list-inside text-gray-400 pl-2">';
                engagement.feedback.slice(0, 10).forEach(fb => html += `<li>${fb}</li>`);
                engagement.vocab_suggestions.slice(0, 1).forEach(vs => html += `<li>Vocab Suggestion: ${vs.original} &rarr; ${vs.suggestion}</li>`);
                html += '</ul>';
            }

            // IV. Delivery
            if (delivery) {
                html += `<div class="text-gray-300 mt-1">IV. Tone: ${delivery.detected_tone} | Formality: ${delivery.formality}</div>`;
                if(delivery.inclusive_language_warning) html += '<div class="text-yellow-400">Note: Contains non-inclusive language.</div>';
            }

            html += '</div>';
            return html;
        }

        // --- API Call Logic ---

        /**
         * Call the Gemini API
         * @param {string} systemPrompt - System Instruction
         * @param {string} userQuery - User Query
         * @param {object|null} schema - JSON output schema (if needed)
         * @param {number} temperature - Sampling temperature
         * @param {number} topP - Top-P sampling parameter
         * @param {number} maxRetries - Maximum retry attempts
         * @returns {Promise<object>} - API response or error object
         */
        async function callGeminiAPI(systemPrompt, userQuery, schema = null, temperature = 0.7, topP = 0.95, maxRetries = 3) {
            
			// ===============================================
			// ðŸš¨ This is your checkpoint: Print Prompt content for AI
			// ===============================================
			console.log("--- Sending System Prompt to AI ---");
			console.log(systemPrompt);
			console.log("----------------------------------");
			
			console.log("--- Sending User Query to AI ---");
			console.log(userQuery);
			console.log("-------------------------------");
			
			// Since your System Prompt is very long, you can print them together
			console.log("--- Full API Request Payload (Debug) ---");
			
			const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };
            
            const generationConfig = {
                temperature: parseFloat(temperature),
                topP: parseFloat(topP),
            };

            if (schema) {
                generationConfig.responseMimeType = "application/json";
                generationConfig.responseSchema = schema;
            }
            payload.generationConfig = generationConfig;
            
            // Print the entire payload object
			console.log(JSON.stringify(payload, null, 2));
			console.log("----------------------------------------------");

            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API request failed, status code: ${response.status}`);
                    }

                    const result = await response.json();
					
                    const candidate = result.candidates?.[0];

                    if (!candidate || !candidate.content?.parts?.[0]) {
                        throw new Error("API returned an invalid response structure or was filtered.");
                    }

                    const part = candidate.content.parts[0];
                    
                    if (schema) {
                        // Handle JSON response
                        const jsonText = part.text;
                        return JSON.parse(jsonText);
                    } else {
                        // Handle plain text response
                        return part.text;
                    }

                } catch (error) {
                    console.error(`API call attempt ${attempt} failed:`, error);
                    if (attempt === maxRetries) {
                        return { isError: true, message: `API request failed: ${error.message}` };
                    }
                    // Exponential backoff
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                }
            }
        }

        // --- v2.6 IGPVL (Input Grammar Pre-Validation Layer) Logic ---

        /**
         * Execute IGPVL check (Simulates API call)
         * @param {string} text - The full text to check
         * @param {string} inputId - ID of the calling source
         * @param {string} context - Writing context (e.g., 'academic')
         * @returns {Promise<object>} - Object matching igpvlSchema or an error
         */
        async function validateInputGrammar(text, inputId, context) {
            
            // v2.6 IGPVL System Prompt
			const systemPrompt = `You are a specialized and strict "Input Grammar Pre-Validation Layer (IGPVL) v2.6".
Your "absolute sole" task is to analyze the user's input text and return "only" a JSON object according to the v2.6 specification.
You are "absolutely forbidden" from outputting any additional text, notes, or explanations outside the JSON.

You "must" perform all four check categories and strictly flag all errors:
1.  **Core Grammar (IGPVL-CORE-XX)**: Subject-verb agreement, Tense, Articles, Pronouns, Number agreement.
2.  **Advanced Grammar (IGPVL-ADV-XX)**: Dangling modifiers, Incomplete comparisons, Double negatives, Inconsistent tense shifts, **Semantic Collocation Errors or improper Subject/Verb pairings**.
3.  **Spelling & Consistency (IGPVL-SPC-XX)**: Spelling errors, Contextual spelling (e.g., their/there), Capitalization, Number formats, Hyphenation.
4.  **Punctuation (IGPVL-PUN-XX)**: **Only when** the **last character** of the input **is a punctuation mark**, check end punctuation, comma/semicolon/colon misuse.
    **[Mandatory Exception Rule]**: If the input is judged to be a **fragment/phrase** (not a complete statement or question), you **must not** flag an 'end_punctuation' error.

**Rules:**
1.  **Maximum Strictness Check**: Flag even minor errors (e.g., 'He go').
2.  **Error Count (error_count)**: Must "precisely" reflect the length of the 'errors' array.
3.  **Validation Mechanism (Status & Severity):**
    * error_count = 0: 'status' = 'passed', 'severity' = 'none', 'recommendation' = 'Grammar correct, ready to generate.'
    * 1 <= error_count <= 3: 'status' = 'warning', 'severity' = 'minor', 'recommendation' = 'Detected \${error_count} minor errors. Please review suggestions. Generation is permitted.'
    * error_count > 3: 'status' = 'blocked', 'severity' = 'major', 'recommendation' = 'Detected \${error_count} major errors. Please correct the input and try again.'
4.  **Error Codes**: 'code' field must follow specifications (e.g., 'IGPVL-CORE-01', 'IGPVL-SPC-01').
5.  **Timestamp**: Must provide the current UTC time in ISO 8601 format.
6.  **Absolute Prohibition**: Your response "must not" contain any text other than the JSON.`;
            

            const userQuery = `
{
  "input_id": "${inputId}",
  "text": "${text}",
  "context": "${context}",
  "language": "en",
  "validation_mode": "strict"
}
`;
            // Use 0.1 temperature to ensure stability and consistency of IGPVL check
            const result = await callGeminiAPI(systemPrompt, userQuery, igpvlSchema, 0.1, 1.0);
            
            // Ensure timestamp exists (model sometimes forgets)
            if (result && !result.isError && !result.timestamp) {
                result.timestamp = new Date().toISOString();
            }
            return result;
        }

        /**
         * Display IGPVL feedback on the UI
         * @param {HTMLElement} el - The DOM element to display feedback in
         * @param {object} result - The result object from validateInputGrammar
         * @returns {boolean} - Whether the flow was blocked (isBlocked)
         */
        function displayIgpvlFeedback(el, result) {
            el.innerHTML = '';
            
            if (result.isError) {
                el.className = 'text-sm p-3 rounded-lg bg-red-900/50 text-red-400';
                el.innerHTML = `<strong>IGPVL Check Failed:</strong> ${result.message}`;
                return true; // Block flow
            }

            if (result.status === 'blocked') {
                el.className = 'text-sm p-3 rounded-lg bg-red-900/50 text-red-400 space-y-2';
                let html = `<p class="font-semibold">${result.recommendation}</p>`;
                html += '<ul class="list-disc list-inside text-xs">';
                result.errors.forEach(err => {
                    html += `<li>[${err.code}] ${err.message} (Suggestion: <strong>${err.suggestion}</strong>)</li>`;
                });
                html += '</ul>';
                el.innerHTML = html;
                return true; // Block flow
            
            } else if (result.status === 'warning') {
                el.className = 'text-sm p-3 rounded-lg bg-yellow-900/50 text-yellow-400 space-y-2';
                let html = `<p class="font-semibold">${result.recommendation}</p>`;
                html += '<ul class="list-disc list-inside text-xs">';
                result.errors.forEach(err => {
                    html += `<li>[${err.code}] ${err.message} (Suggestion: <strong>${err.suggestion}</strong>)</li>`;
                });
                html += '</ul>';
                el.innerHTML = html;
                return false; // Do not block
            
            } else {
                // 'passed'
                el.className = 'text-sm p-3 rounded-lg bg-green-900/50 text-green-400';
                el.innerHTML = `<p class="font-semibold">${result.recommendation}</p>`;
                return false; // Do not block
            }
        }


        // --- Prediction Tab Logic ---

        // v3.0 Update: Use v3.0 Grammar Validation Layer Schema
        const predictionSchema = {
            type: "ARRAY",
            maxItems: 6,
            items: {
                type: "OBJECT",
                properties: {
                    "word": { "type": "STRING", "description": "Predicted next word" },
                    "p_w_n": { "type": "NUMBER", "description": "Conditional probability P(w_n | context), between 0 and 1" },
                    "ppl": { "type": "NUMBER", "description": "Perplexity of the example sentence" },
                    "band": { "type": "NUMBER", "description": "Corresponding IELTS Cohesion & Coherence Band (5, 6, 7, 8, or 9)" },
                    "band_summary": { "type": "STRING", "description": "IELTS examiner-style summary description (based on PPL coherence assessment)" },
                    "example": { "type": "STRING", "description": "Example sentence, max 25 words" },
                    "consistency_score": { "type": "NUMBER", "description": "Semantic consistency score (0-100)" },
                    "grammar_validation": grammarValidationSchemaObject // v3.0 Replace
                },
                required: ["word", "p_w_n", "ppl", "band", "band_summary", "example", "consistency_score", "grammar_validation"] // v3.0 Replace
            }
        };
        
        async function handlePredictionSubmit(e) {
            e.preventDefault();
            const phrase = predInput.value.trim();
            
            // v2.6 IGPVL Integration: Clear old messages
            igpvlPredError.innerHTML = '';
            igpvlPredError.className = 'text-sm rounded-lg';
            predError.classList.add('hidden'); // Hide old generation errors
            predictionResults.innerHTML = ''; // Clear old results

            if (!phrase) {
                displayError(predError, "Please enter an English phrase.", predLoading, predButton, predButtonText, "Get 6 Predictions");
                return;
            }

            // Set UI to loading (v2.6: Before IGPVL)
            displayLoading(predError, predLoading, predButton, predButtonText, "1/2 Validating Input...");

            // --- v2.6 IGPVL Execution ---
            const igpvlResult = await validateInputGrammar(phrase, 'predInput', 'academic');
            const isBlocked = displayIgpvlFeedback(igpvlPredError, igpvlResult);

            if (isBlocked) {
                displayDone(predLoading, predButton, predButtonText, "Get 6 Predictions");
                return; // Stop execution
            }
            // --- IGPVL End ---

            // Set UI to loading (v2.6: Update status)
            displayLoading(predError, predLoading, predButton, predButtonText, "2/2 Generating Predictions...");

            // Prepare API request
            const posFilter = predPos.value === 'any' ? 'Any POS' : predPos.value;
            const taskContext = predTask.value === 'general' ? 'General Writing' : `IELTS ${predTask.value}`;
            const temp = predTemp.value;
            const topP = predTopP.value;
            // T1.4 Fix: Read and truncate context
            const contextLen = predContextLen.value;
            const truncatedPhrase = truncateContext(phrase, contextLen);

            // v3.0 (User Custom) Update: Strictly implement Grammar Validation Layer
			// Prompt optimization log: https://gemini.google.com/share/c74d88da14dc
            const systemPrompt = `You are a versatile writing style assistant (IELTS & Technical Writing). Your task is to predict the 6 most common and natural next words based on the user's input phrase, adhering to the highest academic standards (IELTS) or the highest clarity standards (Tech Guide).

[Internal Reference: English Sentence Definition]: **A complete English sentence must contain a subject and a predicate, express a complete thought (independent clause), begin with a capital letter, and end with a period, question mark, or exclamation mark.** This reference will be used for the strict check in Rule 8.

Rules:
1.  [**Input Validation & Correction**]: **If the user's input phrase contains basic spelling or severe grammatical errors** (e.g., 'cycly' or 'the lives are'), **you must provide the corrected phrase in the 'initial_phrase_correction' field of the output JSON** (e.g., 'the life cycle ends,'), and use this corrected phrase as the context for all predictions. If the input is correct, return an empty string.

2.  [ðŸ”¥ **Task Style Constraint (Core Optimization)**]: Must strictly adhere to the user-specified 'POS' and 'Task' context when generating 'example' sentences.
    a.  **If Task = Task 1 (Chart Description):** 'example' must be **Formal**, **Objective**, and **Academic**. The tone must be **Neutral**, focusing on describing data, trends, or comparisons (e.g., *soared, plummeted, whereas, significantly*). **Absolutely prohibit** any subjective or emotional expressions like "I think", "In my opinion".
    b.  **If Task = Task 2 (Argumentative Essay):** 'example' must be **Formal** or **Semi-formal**, with a **Persuasive** or **Analytical** tone. Sentences should focus on logical arguments, cause-and-effect, or presenting formal viewpoints (e.g., *consequently, It is widely argued that, however*). **Must avoid** colloquial expressions or contractions (like "don't").
    c.  **If Task = 'Tech Guide' (Technical Manual):** 'example' must be **Clear**, **Direct**, and **Instructional**. The tone must be **objective and focused on instructions**.
        * **(i) Core Requirement:** Sentences **must** prioritize the **Imperative mood** (e.g., "**Click** the button") or **Active Voice in the second person** (e.g., "**You** must **enter** the password").
        * **(ii) Formatting Conventions:** Must strictly use technical writing formats: **Use Bold for UI elements** (e.g., **Save** button, **File** menu); **Use Monospace/Code font for code, commands, or paths** (e.g., 'npm install', 'C:\\ProgramData').
        * **(iii) Absolute Prohibition:** Must **strictly avoid** using the **Passive Voice** (e.g., "The button is clicked by...") or **vague, suggestive language** (e.g., "You might want to...", "It is possible to...").

3.  [**Absolute Rule**]: 'All' 'example' sentences you generate 'must' undergo the 'thorough and strict' check by the GVL (Grammar Validation Layer) in point 8 below. **This check is mandatory and cannot be skipped or done superficially**.
4.  For each predicted word, provide 'Conditional Probability P(w_n | context)', 'Concise Example (example)', 'Perplexity (ppl)', and 'IELTS Cohesion & Coherence Band Assessment'.
5.  [PPL-Band Mapping]: PPL 0â€“20=Band 9, 21â€“40=Band 8, 41â€“60=Band 7, 61â€“80=Band 6, >80=Band 5.
6.  [Key Point] In the example sentence, the predicted word must "closely and uniquely" follow the "last word" of the user's input phrase. If the last character of the user's input phrase is punctuation, the predicted word must "closely and uniquely" follow the punctuation mark, separated by a single space.
7.  Simulate three rounds of Self-Consistency sampling for each example generation to ensure semantic stability, and provide a "consistency_score" (0-100) for each generation.

8.  [Grammar Validation Layer (Latest Spec)]: âœ¨ Ultimate Validation Standard
**This is the most important step.** Perform an **absolutely strict** grammar validation on the generated 'example' and fill in the 'grammar_validation' object.

    a.  [I. Correctness (Strict Correctness)]: (ðŸ”¥ Strictly Reinforced - **Includes syntax and Task compliance errors**)
    The 'correctness.errors' array 'must' contain all detected errors. **This includes the most minor errors, as well as major syntax errors (like comma splices/fragments)**. If no errors, must return an empty array [].
        * **Core Grammar:** Subject-verb agreement, Basic tense errors, Pronoun case, Article errors (**redundant, missing, or misused**), Noun number.
        * **Complex Grammar/Syntax:** Dangling modifiers, Inconsistent tense shifts, Double negatives, Parallel structure errors, **Run-on sentences, Comma Splices, Sentence Fragments**.
        * **Spelling:** Basic spelling, Contextual spelling, Capitalization/Number format, Hyphenation/Dashes.
        * **Punctuation:** Basic punctuation, Advanced punctuation (semicolons, colon structure, quotation mark conventions).
        * **(ðŸ”¥) Task Compliance:** Must strictly check for violations of **Rule 2** Task style.
            * **Task 1 Violation (Critical):** Detected any subjective expression (e.g., "I think", "In my opinion", "feels"). Error 'type' should be "Task 1 Violation".
            * **Task 2 Violation (High):** Detected colloquial contractions (e.g., "don't", "it's") or
overly informal vocabulary. Error 'type' should be "Formality Violation".
            * **Tech Guide Violation (High):** Detected **passive voice** (e.g., "The file is saved by..."), **vague/non-instructional language** (e.g., "It is recommended to..."), or **missing UI/Code formatting** (e.g., failing to mark 'Save button' as '**Save** button'). Error 'type' should be "Tech Guide Violation".

    b.  [II. Clarity]: (ðŸ’¡ Suggestive Reinforcement - Focus on style, brevity, and semantics)
    Provide "suggestions". **Does not handle Level I syntax errors**.
        * **Optimization:** Provide brevity suggestions (wordiness), detect overuse of passive voice (a suggestion in Task 1/2, an error in Tech Guide).
        * **Sentence Rewrite (rewrite_suggestion):** **Must** provide a full sentence rewrite that **corrects all errors from I. Correctness** and makes the meaning clearer and more concise.

    c.  [III. Engagement]: (ðŸŒŸ Suggestive Reinforcement)
    Provide "suggestions".
        * **Vocabulary:** Via 'vocab_suggestions', **must** suggest replacements for **overused or bland** basic words.
        * **Structure:** Via 'feedback', alert to issues with sentence variety or content repetition.

    d.  [IV. Delivery]: (ðŸ”¥ Task-Reinforced Standard)
    Detect 'detected_tone', 'formality', and check 'inclusive_language_warning'.
    **'formality' and 'detected_tone' assessment must strictly correspond to the Task type specified in Rule 2:**
        * **Task 1:** 'formality' must be rated "Formal (Academic)", 'detected_tone' must be "Objective" or "Neutral".
        * **Task 2:** 'formality' must be rated "Formal" or "Semi-formal", 'detected_tone' must be "Persuasive" or "Analytical".
        * **Tech Guide:** 'formality' must be rated "Neutral" or "Informal" (meaning "Direct", not "Casual"), 'detected_tone' must be "Instructional" or "Direct".

9.  [Output Format (JSON Schema)]: **Your output 'must' strictly adhere to the following JSON structure object.**

\`\`\`json
{
  "initial_phrase_correction": "STRING", 
  "predictions": [
    {
      "predicted_word": "STRING",
      "P(w_n|context)": "NUMBER",
      "example": "STRING",
      "ppl": "NUMBER",
      "cohesion_band": "NUMBER",
      "consistency_score": "NUMBER",
      "grammar_validation": {
        "correctness": {
          "is_correct": "BOOLEAN", 
          "errors": [
            {
              "type": "STRING", 
              "description": "STRING", 
              "suggestion": "STRING",
              "priority": "STRING" // Must be one of "Critical", "High", "Low"
            }
          ]
        },
        "clarity": {
          "feedback": "STRING", 
          "rewrite_suggestion": "STRING"
        },
        "engagement": {
          "feedback": "STRING", 
          "vocab_suggestions": "ARRAY<STRING>"
        },
        "delivery": {
   "detected_tone": "STRING",
          "formality": "STRING",
          "inclusive_language_warning": "STRING"
        }
      }
    }
  ]
}
\`\`\`
10. **Output ONLY the requested JSON format object.**`;

            const userQuery = `
Input Phrase (Using only last ${contextLen} words): "${truncatedPhrase}"
POS Filter: ${posFilter}
Writing Task: ${taskContext}
Sampling Params (T=${temp}, TopP=${topP})
`;

            // Call API
            const results = await callGeminiAPI(systemPrompt, userQuery, predictionSchema, temp, topP);
            
			// â­ï¸ Checkpoint: Print the raw API response
			console.log("--- Raw Gemini API Response (results) ---");
			console.log(results);
			console.log("-----------------------------------------");
            // Restore UI
            displayDone(predLoading, predButton, predButtonText, "Get 6 Predictions");

            // Process API response
            if (results.isError) {
                displayError(predError, results.message);
            } else if (Array.isArray(results)) {
                displayPredictionResults(results, truncatedPhrase); // T1.4 Fix: Pass truncated phrase
            } else {
                displayError(predError, "Received unexpected response format.");
            }
        }
        
        // v3.0: Update customSchema
        const customSchema = {
            type: "OBJECT",
            properties: {
                "p_w_n": { "type": "NUMBER", "description": "Conditional probability P(w_n | context), between 0 and 1" },
                "ppl": { "type": "NUMBER", "description": "Perplexity of the example sentence" },
                "band": { "type": "NUMBER", "description": "Corresponding IELTS Cohesion & Coherence Band (5, 6, 7, 8, or 9)" },
                "band_summary": { "type": "STRING", "description": "IELTS examiner-style summary description (based on PPL coherence assessment)" },
                "example": { "type": "STRING", "description": "Example sentence, max 25 words" },
                "consistency_score": { "type": "NUMBER", "description": "Semantic consistency score (0-100)" },
                "grammar_validation": grammarValidationSchemaObject // v3.0 Replace
            },
            required: ["p_w_n", "ppl", "band", "band_summary", "example", "consistency_score", "grammar_validation"] // v3.0 Replace
        };

        // Handle custom word validation
        async function handleCustomWordCheck(e) {
            e.preventDefault();
            const phrase = predInput.value.trim();
            const customWord = customWordInput.value.trim();

            // v2.6 IGPVL Integration: Clear old messages
            igpvlCustomError.innerHTML = '';
            igpvlCustomError.className = 'text-sm rounded-lg mt-4';
            customResults.innerHTML = ''; // Clear old results

            if (!phrase || !customWord) {
                igpvlCustomError.className = 'text-sm p-3 rounded-lg bg-red-900/50 text-red-400';
                igpvlCustomError.innerHTML = 'Please enter context and a custom word.';
                return;
            }

            // Set UI to loading (v2.6: Before IGPVL)
            customLoading.classList.remove('hidden');
            customButton.disabled = true;
            customButtonText.textContent = "1/2 Validating Input...";

            // --- v2.6 IGPVL Execution (Check context phrase only) ---
            const igpvlResult = await validateInputGrammar(phrase, 'predInput_custom', 'academic');
            const isBlocked = displayIgpvlFeedback(igpvlCustomError, igpvlResult);

            if (isBlocked) {
                customLoading.classList.add('hidden');
                customButton.disabled = false;
                customButtonText.textContent = "Check Word";
                return; // Stop execution
            }
            // --- IGPVL End ---

            // Set UI to loading (v2.6: Update status)
            customButtonText.textContent = "2/2 Checking...";

            // Prepare API request (single word mode)
            // T1.4 Fix: Read and truncate context
			const taskContext = predTask.value === 'general' ? 'General Writing' : `IELTS ${predTask.value}`;
            const temp = predTemp.value;
            const topP = predTopP.value;
            const contextLen = predContextLen.value;
            const truncatedPhrase = truncateContext(phrase, contextLen);
            const fullPhrase = `${truncatedPhrase} ${customWord}`;

            // v3.0 (User Custom) Update: Strictly implement Grammar Validation Layer
           const systemPrompt = `You are a versatile writing style assistant (IELTS & Technical Writing). Your task is to validate the naturalness of the user's input word "\${customWord}" following the context "\${truncatedPhrase}", strictly adhering to the specified "Task" style.

Rules:
1.  [**Input Validation & Correction**]: **If the user's input context phrase \${truncatedPhrase} contains basic spelling or severe grammatical errors** (e.g., 'cycly' or 'the lives are'), **you must provide the corrected phrase in the 'initial_phrase_correction' field of the output JSON** (e.g., 'the life cycle ends,'), and use this corrected phrase as the context for all example generations. If the input is correct, return an empty string.

2.  [ðŸ”¥ **Task Style Constraint (Core Optimization)**]: Must strictly adhere to the user-specified 'Task' context when generating 'example' sentences.
    a.  **If Task = Task 1 (Chart Description):** 'example' must be **Formal**, **Objective**, and **Academic**. The tone must be **Neutral**, focusing on describing data, trends, or comparisons (e.g., *soared, plummeted, whereas, significantly*). **Absolutely prohibit** any subjective or emotional expressions like "I think", "In my opinion".
    b.  **If Task = Task 2 (Argumentative Essay):** 'example' must be **Formal** or **Semi-formal**, with a **Persuasive** or **Analytical** tone. Sentences should focus on logical arguments, cause-and-effect, or presenting formal viewpoints (e.g., *consequently, It is widely argued that, however*). **Must avoid** colloquial expressions or contractions (like "don't").
    c.  **If Task = 'Tech Guide' (Technical Manual):** 'example' must be **Clear**, **Direct**, and **Instructional**. The tone must be **objective and focused on instructions**.
        * **(i) Core Requirement:** Sentences **must** prioritize the **Imperative mood** (e.g., "**Click** the button") or **Active Voice in the second person** (e.g., "**You** must **enter** the password").
        * **(ii) Formatting Conventions:** Must strictly use technical writing formats: **Use Bold for UI elements** (e.g., **Save** button, **File** menu); **Use Monospace/Code font for code, commands, or paths** (e.g., 'npm install', 'C:\\ProgramData').
        * **(iii) Absolute Prohibition:** Must **strictly avoid** using the **Passive Voice** (e.g., "The button is clicked by...") or **vague, suggestive language** (e.g., "You might want to...", "It is possible to...").

3.  [**Absolute Rule**]: 'All' 'example' sentences you generate must satisfy the **English Sentence Definition** in point 10 and 'must' undergo the 'thorough and strict' check by the GVL (Grammar Validation Layer) in point 9 below. **This check is mandatory and cannot be skipped or done superficially**.
4.  For this collocation, provide 'Conditional Probability P(w_n | context)', 'Concise Example (example)', 'Perplexity (ppl)', and 'IELTS Cohesion & Coherence Band Assessment'.
5.  [PPL-Band Mapping]: PPL 0â€“20=Band 9, 21â€“40=Band 8, 41â€“60=Band 7, 61â€“80=Band 6, >80=Band 5.
6.  [Key Point] In the example sentence, the validated word \${customWord} must "closely and uniquely" follow the "last word" of the context \${truncatedPhrase}. If the last character of the context is punctuation, the word must "closely and uniquely" follow the punctuation mark, separated by a single space.
7.  Simulate three rounds of Self-Consistency sampling for each example generation to ensure semantic stability.
8.  Provide a "consistency_score" (0-100) for each generation, calculated based on semantic similarity, lexical variance, and syntactic stability.

9.  [Grammar Validation Layer (Latest Spec)]: âœ¨ Ultimate Validation Standard
**This is the most important step.** Perform an **absolutely strict** grammar validation on the generated 'example' and fill in the 'grammar_validation' object.

    a.  [I. Correctness (Strict Correctness)]: (ðŸ”¥ Strictly Reinforced - **Includes syntax and Task compliance errors**)
    The 'correctness.errors' array 'must' contain all detected errors. **This includes the most minor errors, as well as major syntax errors (like comma splices/fragments)**. If no errors, must return an empty array [].
        * **Core Grammar:** Subject-verb agreement, Basic tense errors, Pronoun case, Article errors (**redundant, missing, or misused**), Noun number.
        * **Complex Grammar/Syntax:** Dangling modifiers, Inconsistent tense shifts, Double negatives, Parallel structure errors, **Run-on sentences, Comma Splices, Sentence Fragments**.
        * **Spelling:** Basic spelling, Contextual spelling, Capitalization/Number format, Hyphenation/Dashes.
        * **Punctuation:** Basic punctuation, Advanced punctuation (semicolons, colon structure, quotation mark conventions).
        * **(ðŸ”¥) Task Compliance:** Must strictly check for violations of **Rule 2** Task style.
            * **Task 1 Violation (Critical):** Detected any subjective expression (e.g., "I think", "In my opinion", "feels"). Error 'type' should be "Task 1 Violation".
            * **Task 2 Violation (High):** Detected colloquial contractions (e.g., "don't", "it's") or overly informal vocabulary. Error 'type' should be "Formality Violation".
            * **Tech Guide Violation (High):** Detected **passive voice** (e.g., "The file is saved by..."), **vague/non-instructional language** (e.g., "It is recommended to..."), or **missing UI/Code formatting** (e.g., failing to mark 'Save button' as '**Save** button'). Error 'type' should be "Tech Guide Violation".

    b.  [II. Clarity]: (ðŸ’¡ Suggestive Reinforcement - Focus on style, brevity, and semantics)
    Provide "suggestions". **Does not handle Level I syntax errors**.
        * **Optimization:** Provide brevity suggestions (wordiness), detect overuse of passive voice (a suggestion in Task 1/2, an error in Tech Guide).
        * **Sentence Rewrite (rewrite_suggestion):** **Must** provide a full sentence rewrite that **corrects all errors from I. Correctness** and makes the meaning clearer and more concise.

    c.  [III. Engagement]: (ðŸŒŸ Suggestive Reinforcement)
    Provide "suggestions".
        * **Vocabulary:** Via 'vocab_suggestions', **must** suggest replacements for **overused or bland** basic words.
        * **Structure:** Via 'feedback', alert to issues with sentence variety or content repetition.

    d.  [IV. Delivery]: (ðŸ”¥ Task-Reinforced Standard)
    Detect 'detected_tone', 'formality', and check 'inclusive_language_warning'.
    **'formality' and 'detected_tone' assessment must strictly correspond to the Task type specified in Rule 2:**
        * **Task 1:** 'formality' must be rated "Formal (Academic)", 'detected_tone' must be "Objective" or "Neutral".
        * **Task 2:** 'formality' must be rated "Formal" or "Semi-formal", 'detected_tone' must be "Persuasive" or "Analytical".
        * **Tech Guide:** 'formality' must be rated "Neutral" or "Informal" (meaning "Direct", not "Casual"), 'detected_tone' must be "Instructional" or "Direct".

10. [English Sentence Definition]: **A complete English sentence must contain a subject and a predicate, express a complete thought (independent clause), begin with a capital letter, and end with a period, question mark, or exclamation mark.**

11. [Output Format (JSON Schema)]: **Your output 'must' strictly adhere to the following JSON structure object.**

\`\`\`json
{
  "initial_phrase_correction": "STRING", // Correction required by Rule 1
  "P(w_n|context)": "NUMBER",
  "example": "STRING",
  "ppl": "NUMBER",
  "cohesion_band": "NUMBER",
  "consistency_score": "NUMBER",
. "grammar_validation": {
    "correctness": {
      "is_correct": "BOOLEAN", 
      "errors": [
        {
          "type": "STRING", 
          "description": "STRING", 
          "suggestion": "STRING",
          "priority": "STRING" // Must be one of "Critical", "High", "Low"
        }
      ]
    },
    "clarity": {
      "feedback": "STRING", 
      "rewrite_suggestion": "STRING"
    },
    "engagement": {
      "feedback": "STRING", 
      "vocab_suggestions": "ARRAY<STRING>"
    },
    "delivery": {
      "detected_tone": "STRING",
      "formality": "STRING",
      "inclusive_language_warning": "STRING"
    }
  }
}
\`\`\`
12. **Output ONLY the requested JSON format object.**`;

            const userQuery = `
Context (Using only last ${contextLen} words): "${truncatedPhrase}"
Custom Word: "${customWord}"
Writing Task: "${taskContext}"
Sampling Params (T=${temp}, TopP=${topP})
`;

            const result = await callGeminiAPI(systemPrompt, userQuery, customSchema, temp, topP);

            // Restore UI
            customLoading.classList.add('hidden');
            customButton.disabled = false;
            customButtonText.textContent = "Check Word";

            if (result.isError) {
                customResults.innerHTML = `<p class="text-red-400">Validation Failed: ${result.message}</p>`;
            } else if (result.band !== undefined) {
                // Get Band info (although model returns it, we use local function to standardize color)
                const bandInfo = getCohesionBandDetails(result.ppl);
                
                // v3.0 Update: Display Grammar Validation Layer
                customResults.innerHTML = `
                    <div class="bg-gray-700 p-4 rounded-lg border border-yellow-500/50 space-y-2">
                        <div class="flex items-center justify-between">
                            <h4 class="text-lg font-bold text-yellow-300">Custom Word: ${customWord}</h4>
                            <span class="band-tag ${bandInfo.color} text-white">Band ${bandInfo.band}</span>
                        </div>
                        <p class="text-sm text-gray-400">${result.band_summary}</p>
                        <hr class="border-gray-600">
                        <div class="grid grid-cols-3 text-sm text-gray-300">
                            <p><strong>P(wâ‚™|context):</strong> <span class="text-yellow-300">${result.p_w_n.toFixed(4)}</span></p>
                            <p><strong>PPL:</strong> <span class="text-yellow-300">${result.ppl.toFixed(2)}</span></p>
                            <p><strong>Consistency:</strong> <span class="text-yellow-300">${result.consistency_score}</span></p>
                        </div>
                        <div class="bg-gray-600 p-3 rounded-md text-gray-200 mt-2">
                            ${highlight(result.example, fullPhrase)}
                        </div>
                        <!-- v3.0 Grammar Validation Layer Injection Point -->
                        ${renderGrammarValidation(result.grammar_validation)}
                    </div>
                `;
            } else {
                customResults.innerHTML = `<p class="text-red-400">Received unexpected response format.</p>`;
            }
        }


        // v3.0: Update displayPredictionResults
        function displayPredictionResults(results, inputPhrase) {
            if (results.length === 0) {
                predictionResults.innerHTML = `<p class="text-gray-400 md:col-span-2 text-center">No matching predictions found.</p>`;
                return;
            }

            results.forEach((item, index) => {
                const fullPhrase = `${inputPhrase} ${item.word}`;
                // Use local function to get color
                const bandInfo = getCohesionBandDetails(item.ppl);

                // v3.0 Update: Handle consistency status
                const consistencyStatus = item.consistency_score >= 85 ? 'Stable' : 'Check';

                const card = document.createElement('div');
                card.className = 'bg-gray-800 p-5 rounded-lg shadow-lg border border-gray-700 space-y-3';
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-bold text-white">${index + 1}. ${item.word}</h3>
                        <span class="band-tag ${bandInfo.color} text-white">Band ${bandInfo.band}</span>
                    </div>
                    
                    <p class="text-sm text-gray-400">${item.band_summary}</p>

                    <div class="grid grid-cols-2 text-sm text-gray-300 border-b border-gray-700 pb-3">
                        <p><strong>P(wâ‚™|context):</strong> <span class="text-blue-300">${item.p_w_n.toFixed(4)}</span></p>
                        <p><strong>PPL:</strong> <span class="text-blue-300">${item.ppl.toFixed(2)}</span></p>
                    </div>

                    <div id="example-container-${index}" class="bg-gray-700 p-3 rounded-md text-gray-200">
                        ${highlight(item.example, fullPhrase)}
                    </div>
                    <!-- v3.0 Update: Show Consistency and Grammar Validation Layer -->
                    <div id="metrics-container-${index}" class="text-xs text-gray-400 text-right mt-1 space-y-1">
                        <div>Consistency: ${item.consistency_score} (${consistencyStatus})</div>
                    </div>
                    <!-- v3.0 Grammar Validation Layer Injection Point -->
                    <div id="grammar-validation-${index}">
                        ${renderGrammarValidation(item.grammar_validation)}
                    </div>
                    
                    <!-- Band Control Regeneration -->
                    <div class="flex gap-2 pt-2">
                        <select id="band-select-${index}" class="w-1/2 bg-gray-600 border border-gray-500 rounded-md p-2 text-sm text-white focus:ring-1 focus:ring-blue-500">
                            <option value="9">Band 9</option>
                            <option value="8">Band 8</option>
                            <option value="7">Band 7</option>
                            <option value="6">Band 6</option>
                            <option value="5">Band 5</option>
                        </select>
                        <button class="regen-button w-1/2 bg-gray-500 hover:bg-gray-400 text-white text-sm font-medium py-2 px-3 rounded-lg transition-colors duration-200 flex items-center justify-center gap-1 disabled:opacity-50"
                                data-index="${index}"
                                data-context="${inputPhrase}"
                                data-word="${item.word}"
                                data-type="prediction">
                            <span class="regen-text">ðŸ”„ Regenerate</span>
                            <div class="spinner regen-loading hidden"></div>
                        </button>
                    </div>
                `;
                predictionResults.appendChild(card);
            });
        }
        
        // Unified UI state helper functions
        function displayLoading(errorEl, loadingEl, buttonEl, textEl, message) {
            errorEl.classList.add('hidden'); // v2.6: Keep main error hidden
            loadingEl.classList.remove('hidden');
            buttonEl.disabled = true;
            textEl.textContent = message;
        }

        function displayDone(loadingEl, buttonEl, textEl, message) {
            loadingEl.classList.add('hidden');
            buttonEl.disabled = false;
            textEl.textContent = message;
        }

        function displayError(errorEl, message, loadingEl = null, buttonEl = null, textEl = null, buttonMessage = null) {
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
            if (loadingEl) displayDone(loadingEl, buttonEl, textEl, buttonMessage);
        }

        // v3.0: Update regenSchema
        const regenSchema = {
            type: "OBJECT",
            properties: {
                "example": { "type": "STRING", "description": "Newly generated example sentence, <= 25 words" },
                "consistency_score": { "type": "NUMBER", "description": "Semantic consistency score of the new sentence (0-100)" },
                "grammar_validation": grammarValidationSchemaObject // v3.0 Replace
            },
            required: ["example", "consistency_score", "grammar_validation"] // v3.0 Replace
        };

        // Unified example regeneration logic (Shared by Prediction & Validation)
        async function handleRegeneration(button, band, context, word, type) {
            const index = button.dataset.index;
            const fullPhrase = type === 'prediction' ? `${context} ${word}` : context; // Validation case: context is the full phrase
            
            const exampleContainer = document.getElementById(type === 'prediction' ? `example-container-${index}` : `val-example-container`);
            const regenText = button.querySelector('.regen-text');
            const regenLoading = button.querySelector('.regen-loading');

            // T1.8 Fix: Check if this is an auto-retry
            const isAutoRetry = button.dataset.isAutoRetry === 'true';

            // Set UI to loading
            button.disabled = true;
            regenText.classList.add('hidden');
            regenLoading.classList.remove('hidden');
            // T1.8 Fix: Update loading message
            exampleContainer.innerHTML = `<span class="text-gray-400">Generating Band ${band} example... ${isAutoRetry ? '(Auto-Traceback Retry...)' : '(Self-Consistency 3x)'}</span>`;

            // Get Consistency Manager parameters
            const temp = predTemp.value;
            const topP = predTopP.value;

            // Prepare API request
            const bandRules = `Band ${band} - Vocabulary and Sentence Feature: ${type === 'prediction' ? 'Cohesion & Coherence' : 'Lexical Resource'}.`;
            
            // v3.0 (User Custom) Update: Strictly implement Grammar Validation Layer
            const systemPrompt = `You are an IELTS Writing Assistant. Your task is to generate a "single, concise (max 25 words)" example sentence based on the user-specified "full collocation phrase" (\${fullPhrase}) and "target Band" (\${band}).

Rules:
1.  [**Collocation Phrase Validation**]: **If the user's input collocation phrase \${fullPhrase} contains basic spelling or severe grammatical errors** (e.g., 'significantlly' -> 'significantly'), **you must provide the corrected phrase in the 'phrase_correction' field of the output JSON**, and use this corrected phrase as the basis for example generation. If the input is correct, return an empty string.
2.  [**Absolute Rule**]: 'All' 'example' sentences you generate must satisfy the **English Sentence Definition** in point 10 and 'must' undergo the 'thorough and strict' check by the GVL (Grammar Validation Layer) in point 8 below. **This check is mandatory and cannot be skipped or done superficially**.
3.  **Semantic Consistency (>= 0.9):** The newly generated example must remain highly consistent semantically with the current example, differing only in syntactic structure and lexical choice.
4.  **Band Adherence:** The example must strictly conform to the target Band (\${band}) requirements for grammatical complexity, coherence, and lexical density.
5.  **Complete Collocation:** Ensure the example sentence contains the **complete and corrected** collocation "\${fullPhrase}".
6.  **Continuity:** Ensure the words in the collocation are continuous and not separated by punctuation.
7.  Self-Consistency: Simulate three rounds of Self-Consistency sampling to ensure output stability.
8.  Output a "consistency_score" (0-100), calculated based on semantic similarity, lexical variance, and syntactic stability.

9.  [Grammar Validation Layer (Latest Spec)]: âœ¨ Ultimate Validation Standard
**This is the most important step.** Perform an **absolutely strict** grammar validation on the generated 'example' and fill in the 'grammar_validation' object.

    a.  [I. Correctness (Strict Correctness)]: (ðŸ”¥ Strictly Reinforced - **Includes syntax errors**)
    The 'correctness.errors' array 'must' contain all detected errors. **This includes the most minor errors, as well as major syntax errors (like comma splices/fragments)**. If no errors, must return an empty array [].
        -   **Core Grammar:** Subject-verb agreement, Basic tense errors, Pronoun case, Article errors (**redundant, missing, or misused**), Noun number.
        -   **Complex Grammar/Syntax:** Dangling modifiers, Inconsistent tense shifts, Double negatives, Parallel structure errors, **Run-on sentences, Comma Splices, Sentence Fragments**.
        -   **Spelling:** Basic spelling, Contextual spelling, Capitalization/Number format, Hyphenation/Dashes.
        -   **Punctuation:** Basic punctuation (end-of-sentence), Advanced punctuation (semicolons, colon structure, quotation mark conventions).

    b.  [II. Clarity]: (ðŸ’¡ Suggestive Reinforcement - Focus on style, brevity, and semantics)
    Provide "suggestions". **Does not handle Level I syntax errors**.
        -   **Optimization:** Provide brevity suggestions (wordiness), detect overuse of passive voice.
        -   **Sentence Rewrite (rewrite_suggestion):** **Must** provide a full sentence rewrite that **corrects all errors from I. Correctness** and makes the meaning clearer and more concise.

    c.  [III. Engagement]: (ðŸŒŸ Suggestive Reinforcement)
    Provide "suggestions".
        -   **Vocabulary:** Via 'vocab_suggestions', **must** suggest replacements for **overused or bland** basic words.
        -   **Structure:** Via 'feedback', alert to issues with sentence variety or content repetition.

    d.  [IV. Delivery]: (Maintain original standard)
    Detect 'detected_tone', 'formality', and check 'inclusive_language_warning'.

10. [English Sentence Definition]: **A complete English sentence must contain a subject and a predicate, express a complete thought (independent clause), begin with a capital letter, and end with a period, question mark, or exclamation mark.**

11. [Output Format (JSON Schema)]: **Your output 'must' strictly adhere to the following JSON structure object.**

\`\`\`json
{
  "phrase_correction": "STRING", // Correction required by Rule 1
  "example": "STRING",
  "consistency_score": "NUMBER",
  "grammar_validation": {
    "correctness": {
      "is_correct": "BOOLEAN", 
      "errors": [
        {
          "type": "STRING", 
          "description": "STRING", 
          "suggestion": "STRING",
          "priority": "STRING" // Must be one of "Critical", "High", "Low"
        }
      ]
    },
    "clarity": {
      "feedback": "STRING", 
      "rewrite_suggestion": "STRING"
    },
    "engagement": {
      "feedback": "STRING", 
      "vocab_suggestions": "ARRAY<STRING>"
    },
    "delivery": {
      "detected_tone": "STRING",
      "formality": "STRING",
      "inclusive_language_warning": "STRING"
    }
  }
}
\`\`\`
12. **Output ONLY the requested JSON format object.**`;

            const userQuery = `
Full Collocation: "${fullPhrase}"
Target Band: ${band}
Band Rules: ${bandRules}
Sampling Params (T=${temp}, TopP=${topP})
`;

            // Call API
            const result = await callGeminiAPI(systemPrompt, userQuery, regenSchema, temp, topP);

            // Restore UI (Restore before T1.8 check to prevent button getting stuck)
            button.disabled = false;
            regenText.classList.remove('hidden');
            regenLoading.classList.add('hidden');

            // Display results
            if (result.isError) {
                exampleContainer.innerHTML = `<span class="text-red-400">Generation Failed: ${result.message || 'Unknown error'}</span>`;
            } else if (result.example && result.consistency_score !== undefined && result.grammar_validation) {
                
                // T1.8 / T2.8 Fix: Store history
                const historyKey = `${type}-${index}`;
                if (!regenerationHistory[historyKey]) {
                    regenerationHistory[historyKey] = [];
                }
                regenerationHistory[historyKey].push(result.consistency_score);
                if (regenerationHistory[historyKey].length > 5) { // Keep last 5
                    regenerationHistory[historyKey].shift();
                }

                // T1.8 / T2.8 Fix: Semantic Traceback simulation
                // If score is low, and this is not an auto-retry
                if (result.consistency_score < 85 && !isAutoRetry) {
                    console.warn(`Semantic Traceback (T1.8) triggered for ${historyKey}. Score: ${result.consistency_score}. Auto-retrying...`);
                    
                    // v3.0 Update: Get metrics container
                    const metricsContainer = document.getElementById(type === 'prediction' ? `metrics-container-${index}` : `val-metrics-container`);
                    if (metricsContainer) {
                        metricsContainer.innerHTML = `
                            <div>Consistency: ${result.consistency_score} (<span class="text-yellow-400">Low score! Auto-Traceback Retry...</span>)</div>
                        `;
                    }
                    // v3.0 Update: Get grammar container
                    const grammarContainer = document.getElementById(type === 'prediction' ? `grammar-validation-${index}` : `val-grammar-validation`);
                    if (grammarContainer) {
                        grammarContainer.innerHTML = renderGrammarValidation(result.grammar_validation);
                    }


                    // Flag and retry once
                    button.dataset.isAutoRetry = 'true';
                    await handleRegeneration(button, band, context, word, type);
                    
                    // After retry, clear flag and exit
                    button.dataset.isAutoRetry = 'false';
                    return; // Terminate this function to prevent showing low-score result
                }

                // --- Display Normal Result (Score >= 85 or already retried) ---
                
                // Update example
                exampleContainer.innerHTML = highlight(result.example, fullPhrase);
                
                // v3.0 Update: Update metrics container
                const metricsContainer = document.getElementById(type === 'prediction' ? `metrics-container-${index}` : `val-metrics-container`);
                if (metricsContainer) {
                    const consistencyStatus = result.consistency_score >= 85 ? 'Stable' : 'Check';
                    metricsContainer.innerHTML = `
                        <div>Consistency: ${result.consistency_score} (${consistencyStatus})</div>
                    `;
                }
                // v3.0 Update: Update grammar container
                const grammarContainer = document.getElementById(type === 'prediction' ? `grammar-validation-${index}` : `val-grammar-validation`);
                if (grammarContainer) {
                    grammarContainer.innerHTML = renderGrammarValidation(result.grammar_validation);
                }
            } else {
                exampleContainer.innerHTML = `<span class="text-red-400">Generation Failed: Received unexpected response format (missing grammar_validation).</span>`;
            }
        }

        // Event delegation for prediction results area (Regeneration)
        predictionResults.addEventListener('click', async function(e) {
            const button = e.target.closest('.regen-button');
            if (!button || button.dataset.type !== 'prediction') return;

            e.preventDefault();
            const index = button.dataset.index;
            // T1.4 Fix: Ensure truncated context is passed
            const context = truncateContext(button.dataset.context, predContextLen.value);
            const word = button.dataset.word;
            
            const bandSelect = document.getElementById(`band-select-${index}`);
            const band = bandSelect.value;
            
            await handleRegeneration(button, band, context, word, 'prediction');
        });

        // --- Validation Tab Logic ---

        // v3.0: Update validationSchema
        const validationSchema = {
            type: "OBJECT",
            properties: {
                "Fpm": { "type": "NUMBER", "description": "Frequency per million words in the corpus" },
                "MI": { "type": "NUMBER", "description": "Mutual Information value" },
                "L_acc_norm": { "type": "NUMBER", "description": "Linguistic accuracy (1.0 = correct; 0.5 = minor error; 0.0 = error)" },
                "example": { "type": "STRING", "description": "Example sentence, max 25 words" },
                "grammarCheck": { "type": "STRING", "description": "Brief description of grammar validation result (should align with L_acc_norm)" },
                "spellingSuggestion": { "type": "STRING", "description": "Spelling correction suggestion or alternative collocation (empty string if none)" },
                "consistency_score": { "type": "NUMBER", "description": "Semantic consistency score of the example (0-100)" },
                "example_grammar_validation": grammarValidationSchemaObject // v3.0 Replace
            },
            required: ["Fpm", "MI", "L_acc_norm", "example", "grammarCheck", "spellingSuggestion", "consistency_score", "example_grammar_validation"] // v3.0 Replace
        };

        async function handleValidationSubmit(e) {
            e.preventDefault();
            const phrase1 = valInput1.value.trim();
            const phrase2 = valInput2.value.trim();
            const fullPhrase = `${phrase1} ${phrase2}`.trim();

            // v2.6 IGPVL Integration: Clear old messages
            igpvlValError.innerHTML = '';
            igpvlValError.className = 'text-sm rounded-lg';
            valError.classList.add('hidden'); // Hide old generation errors
            validationResults.classList.add('hidden');
            validationResults.innerHTML = '';

            if (!phrase1 || !phrase2) {
                displayError(valError, "Please enter an initial phrase and target word.", valLoading, valButton, valButtonText, "Validate Collocation");
                return;
            }

            // Set UI to loading (v2.6: Before IGPVL)
            displayLoading(valError, valLoading, valButton, valButtonText, "1/2 Validating Input...");

            // --- v2.6 IGPVL Execution ---
            const igpvlResult = await validateInputGrammar(fullPhrase, 'valInput', 'academic');
            const isBlocked = displayIgpvlFeedback(igpvlValError, igpvlResult);

            if (isBlocked) {
                displayDone(valLoading, valButton, valButtonText, "Validate Collocation");
                return; // Stop execution
            }
            // --- IGPVL End ---

            // Set UI to loading (v2.6: Update status)
            displayLoading(valError, valLoading, valButton, valButtonText, "2/2 Validating...");
            
            // S_Naturalness v3.0 (User Custom) Revised System Prompt
            const systemPrompt = `You are an IELTS Writing Assistant. Your task is to evaluate the naturalness and correctness of the user-provided "full collocation phrase" (\${fullPhrase}) and provide the raw data needed to calculate S_Naturalness.

Rules:
1.  [**Collocation Phrase Validation**]: **If the user's input collocation phrase \${fullPhrase} contains basic spelling or severe grammatical errors** (e.g., 'significantlly' -> 'significantly'), **you must provide the corrected phrase in the 'phrase_correction' field of the output JSON**, and use this corrected phrase as the basis for example generation. If the input is correct, return an empty string.
2.  [**Absolute Rule**]: 'All' 'example' sentences you generate must satisfy the **English Sentence Definition** in point 10 and 'must' undergo the 'thorough and strict' check by the GVL (Grammar Validation Layer) in point 9 below. **This check is mandatory and cannot be skipped or done superficially**.
3.  Provide "Fpm" (Frequency per million words in the corpus).
4.  Provide "MI" (Mutual Information value).
5.  Based on grammatical and morphological correctness, provide "L_acc_norm" (Linguistic accuracy score: 1.0 = Fully correct, 0.5 = Understandable but with minor errors, 0.0 = Severe error).
6.  Provide a "Concise Example (example)" (max 25 words).
7.  Provide a brief result for "Grammar Check (grammarCheck)" (this should align with L_acc_norm).
8.  If the collocation is unnatural or has clear spelling errors, provide an "Alternative Collocation (spellingSuggestion)" or correction; otherwise, return an empty string.
9.  Provide a "consistency_score" (0-100) for the 'example'.

10. [Grammar Validation Layer (Latest Spec)]: âœ¨ Ultimate Validation Standard
**This is the most important step.** Perform an **absolutely strict** grammar validation on the generated 'example' and fill in the 'example_grammar_validation' object.

    a.  [I. Correctness (Strict Correctness)]: (ðŸ”¥ **Final Unified Reinforcement** - **Includes all structural errors**)
    The 'correctness.errors' array 'must' contain all detected errors. **This includes the most minor errors, as well as all syntactic structural errors**. If no errors, must return an empty array [].
        -   **Core Grammar:** Subject-verb agreement, Basic tense errors, Pronoun case, Article errors (**redundant, missing, or misused**), Noun number.
        -   **Complex Syntax/Structure:** Dangling/Misplaced modifiers, Inconsistent tense shifts, Incomplete comparisons, Double negatives, Parallel structure errors, **Run-on Sentences, Comma Splices, Sentence Fragments**.
        -   **Spelling:** Basic spelling, Contextual spelling (**confused words**), Capitalization/Number format, Hyphenation/Dashes.
        -   **Punctuation:** Basic punctuation, Advanced punctuation (semicolons, colon structure, quotation mark conventions).

    b.  [II. Clarity]: (ðŸ’¡ Suggestive Reinforcement - Focus on style, brevity, and semantics)
    Provide "suggestions". **This section no longer handles structural errors.**
        -   **Optimization:** Provide **brevity suggestions (wordiness)**, detect **overuse of passive voice**.
        -   **Full Sentence Rewrite (rewrite_suggestion):** **Must** be provided when needed, and this rewrite should **correct all errors from I. Correctness** and make the meaning clearer and more concise.

    c.  [III. Engagement]: (ðŸŒŸ Suggestive Reinforcement)
    Provide "suggestions".
        -   **Vocabulary:** Via 'vocab_suggestions', **must** suggest replacements for **overused or bland** basic words.
        -   **Structure:** Via 'feedback', alert to issues with **Sentence Variety** or **content repetition**.

    d.  [IV. Delivery]: (Maintain original standard)
    Detect 'detected_tone', 'formality', and check 'inclusive_language_warning'.

11. [English Sentence Definition]: **A complete English sentence must contain a subject and a predicate, express a complete thought (independent clause), begin with a capital letter, and end with a period, question mark, or exclamation mark.**

12. [Output Format (JSON Schema)]: **Your output 'must' strictly adhere to the following JSON structure object.**

\`\`\`json
{
  "phrase_correction": "STRING",
  "Fpm": "NUMBER",
  "MI": "NUMBER",
  "L_acc_norm": "NUMBER",
  "example": "STRING",
  "grammarCheck": "STRING",
  "spellingSuggestion": "STRING",
  "consistency_score": "NUMBER",
  "example_grammar_validation": {
    "correctness": {
      "is_correct": "BOOLEAN", 
      "errors": [
        {
          "type": "STRING", 
          "description": "STRING", 
          "suggestion": "STRING",
          "priority": "STRING" // Must be one of "Critical", "High", "Low"
        }
      ]
    },
    "clarity": {
      "feedback": "STRING", 
      "rewrite_suggestion": "STRING"
    },
    "engagement": {
      "feedback": "STRING", 
      "vocab_suggestions": "ARRAY<STRING>"
    },
    "delivery": {
      "detected_tone": "STRING",
      "formality": "STRING",
      "inclusive_language_warning": "STRING"
    }
  }
}
\`\`\`
13. **Output ONLY the requested JSON format object.**`;
            
            const userQuery = `
Full Collocation: "${fullPhrase}"
`;
            
            // Call API (Use Consistency Manager params from Prediction tab)
            const result = await callGeminiAPI(systemPrompt, userQuery, validationSchema, predTemp.value, predTopP.value);

            // Restore UI
            displayDone(valLoading, valButton, valButtonText, "Validate Collocation");
            
            // Process API response
            if (result.isError) {
                displayError(valError, result.message);
            } else if (result.Fpm !== undefined && result.MI !== undefined && result.L_acc_norm !== undefined && result.example_grammar_validation !== undefined) {
                // v3.0 Revised: Check for new field
                displayValidationResult(result, fullPhrase);
            } else {
                displayError(valError, "Received unexpected response format (missing example_grammar_validation).");
            }
        }

        // v3.0: Display validation result
        function displayValidationResult(result, fullPhrase) {
            // Deconstruct API response according to S_Naturalness flow
            // v3.0 Update: Deconstruct new fields
            const { Fpm, MI, L_acc_norm, example, grammarCheck, spellingSuggestion, consistency_score, example_grammar_validation } = result;
            
            // S_Naturalness Calculation (7-step process)
            // Example parameters (normalization base)
            const N_LOG_MIN = 0;
            const N_LOG_MAX = 2.0043213738; // log10(100 + 1)
            const M_MIN = 0;
            const M_MAX = 6;
            
            // Weights
            const W_FPM = 0.4;
            const W_MI = 0.4;
            const W_L_ACC = 0.2;

            // Step 3: Log transform
            const N_Log = Math.log10(Fpm + 1);
            // Step 4: N-gram normalization
            const N_norm = (N_Log - N_LOG_MIN) / (N_LOG_MAX - N_LOG_MIN);
            // Step 5: MI normalization
            const M_norm = (MI - M_MIN) / (M_MAX - M_MIN);
            // Step 7: Calculate final naturalness score
            const S_Naturalness = (W_FPM * N_norm) + (W_MI * M_norm) + (W_L_ACC * L_acc_norm);

            // Get Band info based on S_Naturalness (using revised function)
            const bandInfo = getLexicalBandDetails(S_Naturalness);

            let suggestionHtml = '';
            if (spellingSuggestion && spellingSuggestion.trim() !== '') {
                suggestionHtml = `
                    <div class="mt-4">
                        <h4 class="font-semibold text-yellow-300">Suggestion/Alternative</h4>
                        <p class="text-yellow-400 bg-yellow-900/50 p-3 rounded-md">${spellingSuggestion}</p>
                    </div>
                `;
            }

            // v3.0 Update: Handle consistency status
            const consistencyStatus = consistency_score >= 85 ? 'Stable' : 'Check';

            validationResults.innerHTML = `
                <div class="text-center mb-6 border-b border-gray-700 pb-4">
                    <span class="text-xs font-semibold uppercase text-gray-400">IELTS Lexical Resource Band</span>
                    <div class="flex items-center justify-center my-2">
                        <!-- S_Naturalness v2.1 Revised: Band display based on S_Naturalness -->
                        <span class="band-tag ${bandInfo.color} text-white text-3xl p-3">Band ${bandInfo.band}</span>
                    </div>
                    <p class="text-gray-300 mt-2 max-w-md mx-auto">${bandInfo.summary}</p>
                </div>

                <div class="space-y-4">
                    <!-- S_Naturalness v2.1 Revised: Show S_Naturalness calculation details -->
                    <div class="bg-gray-700/50 p-4 rounded-md space-y-3">
                        <h4 class="font-semibold text-gray-300 text-center">S_Naturalness (Naturalness) Calculation Details</h4>
                        <div class="grid grid-cols-3 text-sm text-gray-300 text-center">
                            <p><strong>Fpm (Raw Frequency):</strong> <span class="text-green-300">${Fpm.toFixed(4)}</span></p>
                            <p><strong>MI (Mutual Information):</strong> <span class="text-green-300">${MI.toFixed(3)}</span></p>
                            <p><strong>L_Acc (Accuracy):</strong> <span class="text-green-300">${L_acc_norm.toFixed(1)}</span></p>
                        </div>
                        <hr class="border-gray-600">
                        <div class="grid grid-cols-2 text-sm text-gray-300 text-center">
                            <p><strong>N_norm (Frequency Norm.):</strong> <span class="text-blue-300">${N_norm.toFixed(4)}</span> (w: ${W_FPM * 100}%)</p>
                            <p><strong>M_norm (MI Norm.):</strong> <span class="text-blue-300">${M_norm.toFixed(4)}</span> (w: ${W_MI * 100}%)</p>
                        </div>
                        <div class="text-center pt-2">
                            <p class="font-semibold text-gray-300">Final S_Naturalness Score</p>
                            <p class="text-2xl font-bold text-white">${S_Naturalness.toFixed(4)}</p>
                            <p class="text-xs text-gray-400">(${W_FPM}*${N_norm.toFixed(3)} + ${W_MI}*${M_norm.toFixed(3)} + ${W_L_ACC}*${L_acc_norm.toFixed(1)})</p>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-300">Grammar Check</h4>
                        <p class="text-gray-300">${grammarCheck}</p>
                    </div>

                    <div>
                        <h4 class="font-semibold text-gray-300">Example - <span class="text-xs text-gray-400">Band level can be changed</span></h4>
                        <div id="val-example-container" class="bg-gray-700 p-4 rounded-md text-gray-200 text-lg">
                            ${highlight(example, fullPhrase)}
                        </div>
                    </div>
                    <!-- v3.0 Update: Show Consistency and Grammar Validation Layer -->
                    <div id="val-metrics-container" class="text-xs text-gray-400 text-right mt-1 space-y-1">
                        <div>Consistency: ${consistency_score} (${consistencyStatus})</div>
                    </div>
                    <!-- v3.0 Grammar Validation Layer Injection Point -->
                    <div id="val-grammar-validation">
                        ${renderGrammarValidation(example_grammar_validation)}
                    </div>

                    <!-- Band Control Regeneration for Validation -->
                    <div class="flex gap-2 pt-2">
                        <select id="val-band-select" class="w-1/2 bg-gray-600 border border-gray-500 rounded-md p-2 text-sm text-white focus:ring-1 focus:ring-blue-500">
                            <option value="9">Band 9</option>
                            <option value="8">Band 8</option>
                            <option value="7" selected>Band 7</option>
                            <option value="6">Band 6</option>
                            <option value="5">Band 5</option>
                        </select>
                        <button class="regen-button w-1/2 bg-gray-500 hover:bg-gray-400 text-white text-sm font-medium py-2 px-3 rounded-lg transition-colors duration-200 flex items-center justify-center gap-1 disabled:opacity-50"
                                data-index="val"
                                data-context="${fullPhrase}"
                                data-word=""
                                data-type="validation">
                            <span class="regen-text">ðŸ”„ Regenerate</span>
                            <div class="spinner regen-loading hidden"></div>
                        </button>
                    </div>

                    ${suggestionHtml}
                </div>
            `;
            validationResults.classList.remove('hidden');

            // Bind regeneration event for Validation Tab
            document.querySelector('#validationResults .regen-button').addEventListener('click', async function(e) {
                e.preventDefault();
                const button = e.currentTarget;
                const band = document.getElementById('val-band-select').value;
                const context = button.dataset.context; // fullPhrase is stored here
                await handleRegeneration(button, band, context, '', 'validation');
            });
        }


        // --- Tab Switching Logic ---
        function switchTab(activeTab) {
            // ... ( unchanged switchTab logic )
            if (activeTab === 'prediction') {
                // Activate Prediction
                tabs.prediction.classList.remove('text-gray-400', 'hover:bg-gray-800/50');
                tabs.prediction.classList.add('text-white', 'bg-gray-800', '-mb-px', 'border-t', 'border-l', 'border-r', 'border-gray-700');
                contents.prediction.classList.remove('hidden');
                
                // Deactivate Validation
                tabs.validation.classList.add('text-gray-400', 'hover:bg-gray-800/50');
                tabs.validation.classList.remove('text-white', 'bg-gray-800', '-mb-px', 'border-t', 'border-l', 'border-r', 'border-gray-700');
                contents.validation.classList.add('hidden');
            } else {
                // Activate Validation
                tabs.validation.classList.remove('text-gray-400', 'hover:bg-gray-800/50');
                tabs.validation.classList.add('text-white', 'bg-gray-800', '-mb-px', 'border-t', 'border-l', 'border-r', 'border-gray-700');
                contents.validation.classList.remove('hidden');

                // Deactivate Prediction
                tabs.prediction.classList.add('text-gray-400', 'hover:bg-gray-800/50');
                tabs.prediction.classList.remove('text-white', 'bg-gray-800', '-mb-px', 'border-t', 'border-l', 'border-r', 'border-gray-700');
                contents.prediction.classList.add('hidden');
            }
        }

        // --- Initial Event Bindings ---
        tabs.prediction.addEventListener('click', () => switchTab('prediction'));
        tabs.validation.addEventListener('click', () => switchTab('validation'));
        predForm.addEventListener('submit', handlePredictionSubmit);
        customWordForm.addEventListener('submit', handleCustomWordCheck); // Bind custom word form
        valForm.addEventListener('submit', handleValidationSubmit);

        // Select first tab by default
        switchTab('prediction');

        // v2.6 IGPVL: Version note
        console.log("IGPVL v2.6 loaded and integrated into submission forms.");

    </script>
</body>
</html>
