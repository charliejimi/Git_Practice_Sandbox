<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS æ™ºæ…§è©å½™èˆ‡æ­é…ç³»çµ±</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Inter å­—é«” -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* åŸºæœ¬æ¨£å¼ */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Highlight æ¨£å¼ */
        .highlight {
            background-color: rgba(147, 197, 253, 0.4); /* blue-300/40 */
            color: #dbeafe; /* text-blue-100 */
            font-weight: 600;
            padding: 0 2px;
            border-radius: 3px;
            white-space: nowrap; /* ç¢ºä¿é«˜äº®éƒ¨åˆ†ä¸æ–·è¡Œ */
        }
        /* éš±è—å…ƒç´  */
        .hidden {
            display: none;
        }
        /* ç°¡æ˜“ Spinner å‹•ç•« */
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #ffffff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .band-tag {
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- æ¨™é¡Œ -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">IELTS æ™ºæ…§è©å½™èˆ‡æ­é…ç³»çµ±</h1>
            <!-- v2.6 IGPVL æ›´æ–°: ä¿®æ”¹æ¨™é¡Œ -->
            <p class="text-lg text-gray-400 mt-2">æ•´åˆ PPL, S_Naturalness, GVL (v3.0) èˆ‡ IGPVL (v2.6)</p>
        </header>

        <!-- åŠŸèƒ½åˆ†é æ¨™ç±¤ -->
        <div class="flex justify-center mb-6 border-b border-gray-700">
            <button id="tabPrediction" class="tab-button px-6 py-3 font-semibold text-white bg-gray-800 rounded-t-lg -mb-px border-t border-l border-r border-gray-700">
                1. è©å½™é æ¸¬ (Prediction)
            </button>
            <button id="tabValidation" class="tab-button px-6 py-3 font-semibold text-gray-400 hover:bg-gray-800/50 rounded-t-lg">
                2. æ­é…é©—è­‰ (Validation)
            </button>
        </div>

        <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
        <main>
            <!-- 1. è©å½™é æ¸¬ (Prediction) å…§å®¹ -->
            <div id="predictionContent">
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl space-y-6">
                    <form id="predictionForm" class="space-y-4">
                        <label for="predInput" class="block text-sm font-medium text-gray-300 mb-2">è¼¸å…¥è‹±æ–‡ä¸Šä¸‹æ–‡ç‰‡æ®µ (Context Phrase)</label>
                        <input type="text" id="predInput" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ä¾‹å¦‚ï¼šThe government should implement effective policies to...">
                        
                        <!-- v2.6 IGPVL æ–°å¢: é æ¸¬è¼¸å…¥çš„éŒ¯èª¤å›å ±å€åŸŸ -->
                        <div id="igpvlPredError" class="text-sm rounded-lg"></div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="predPos" class="block text-sm font-medium text-gray-300 mb-2">æŒ‡å®šè©æ€§ (POS Filter)</label>
                                <select id="predPos" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="any">æ‰€æœ‰è©æ€§ (Any)</option>
                                    <option value="N">åè© (Noun)</option>
                                    <option value="V">å‹•è© (Verb)</option>
                                    <option value="Adj">å½¢å®¹è© (Adjective)</option>
                                    <option value="Adv">å‰¯è© (Adverb)</option>
                                </select>
                            </div>
                            <div>
                                <label for="predTask" class="block text-sm font-medium text-gray-300 mb-2">å¯«ä½œä»»å‹™ (IELTS Task)</label>
                                <select id="predTask" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="general">é€šç”¨ (General)</option>
                                    <option value="task1">Task 1</option>
                                    <option value="task2">Task 2</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="pt-4 border-t border-gray-700">
                            <h3 class="text-sm font-medium text-gray-300 mb-2">ä¸€è‡´æ€§æ§åˆ¶ (Consistency Manager)</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <label class="block">
                                    <span class="text-xs text-gray-400">æº«åº¦ (Temperature)</span>
                                    <input type="number" id="predTemp" value="0.7" step="0.1" min="0.1" max="1.0" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white text-sm">
                                </label>
                                <label class="block">
                                    <span class="text-xs text-gray-400">Top-P (æ ¸æ¡æ¨£)</span>
                                    <input type="number" id="predTopP" value="0.95" step="0.05" min="0.0" max="1.0" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white text-sm">
                                </label>
                                <label class="block">
                                    <span class="text-xs text-gray-400">ä¸Šä¸‹æ–‡è©æ•¸ (Context Words)</span>
                                    <!-- T1.4 Fix: ç§»é™¤ disabled -->
                                    <input type="number" id="predContextLen" value="20" min="5" max="50" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white text-sm">
                                </label>
                                <label class="block">
                                    <span class="text-xs text-gray-400">Self-Consistency Iterations</span>
                                    <input type="number" id="predSC" value="3" min="1" max="5" disabled class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-gray-500 text-sm">
                                </label>
                            </div>
                        </div>

                        <button type="submit" id="predButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2 disabled:opacity-50 mt-4">
                            <span id="predButtonText">ç²å– 6 å€‹é æ¸¬è©å½™ (Get Predictions)</span>
                            <div id="predLoading" class="spinner hidden"></div>
                        </button>
                    </form>

                    <!-- è‡ªå®šè©å½™é©—è­‰å€ -->
                    <div class="pt-6 border-t border-gray-700 mt-6">
                        <h2 class="text-xl font-semibold text-white mb-3">2. é©—è­‰è‡ªå®šè©å½™ (Custom Word Check)</h2>
                        <form id="customWordForm" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <input type="text" id="customWordInput" class="bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500" placeholder="è¼¸å…¥ä½ æƒ³æ¥çš„è© (e.g., 'growth')">
                                <button type="submit" id="customButton" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2 disabled:opacity-50">
                                    <span id="customButtonText">Check Word</span>
                                    <div id="customLoading" class="spinner hidden"></div>
                                </button>
                            </div>
                        </form>
                        <!-- v2.6 IGPVL æ–°å¢: è‡ªå®šè©å½™çš„éŒ¯èª¤å›å ±å€åŸŸ -->
                        <div id="igpvlCustomError" class="text-sm rounded-lg mt-4"></div>
                        <div id="customResults" class="mt-4"></div>
                    </div>
                </div>

                <!-- é æ¸¬çµæœå€åŸŸ -->
                <div id="predError" class="text-red-400 bg-red-900/50 p-4 rounded-lg mt-6 hidden"></div>
                <div id="predictionResults" class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- é æ¸¬çµæœå¡ç‰‡å°‡å‹•æ…‹æ’å…¥æ­¤è™• -->
                </div>
            </div>

            <!-- 2. æ­é…é©—è­‰ (Validation) å…§å®¹ -->
            <div id="validationContent" class="hidden">
                <form id="validationForm" class="bg-gray-800 p-6 rounded-lg shadow-xl space-y-6">
                    <div>
                        <label for="valInput1" class="block text-sm font-medium text-gray-300 mb-2">æ­é…ç‰‡èª - å‰åŠéƒ¨ (Initial Phrase)</label>
                        <input type="text" id="valInput1" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ä¾‹å¦‚ï¼šmake a">
                    </div>
                    <div>
                        <label for="valInput2" class="block text-sm font-medium text-gray-300 mb-2">æ­é…ç‰‡èª - å¾ŒåŠéƒ¨ (Target Word/Phrase)</label>
                        <input type="text" id="valInput2" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ä¾‹å¦‚ï¼šdecision">
                    </div>
                    
                    <!-- v2.6 IGPVL æ–°å¢: é©—è­‰è¼¸å…¥çš„éŒ¯èª¤å›å ±å€åŸŸ -->
                    <div id="igpvlValError" class="text-sm rounded-lg"></div>

                    <button type="submit" id="valButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2 disabled:opacity-50">
                        <span id="valButtonText">é©—è­‰æ­é… (Validate Collocation)</span>
                        <div id="valLoading" class="spinner hidden"></div>
                    </button>
                </form>

                <!-- é©—è­‰çµæœå€åŸŸ -->
                <div id="valError" class="text-red-400 bg-red-900/50 p-4 rounded-lg mt-6 hidden"></div>
                <div id="validationResults" class="mt-8 bg-gray-800 p-6 rounded-lg shadow-xl hidden">
                    <!-- é©—è­‰çµæœå°‡å‹•æ…‹æ’å…¥æ­¤è™• -->
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript é‚è¼¯ -->
    <script type="module">
        // --- Gemini API é‡‘é‘° (ä¿ç•™ç‚ºç©ºå­—ä¸²ï¼ŒCanvas å°‡è‡ªå‹•å¡«å…¥) ---
        // v2.6 IGPVL è¨»è¨˜: IGPVL å’Œ GVL ä½¿ç”¨ç›¸åŒçš„ API ç«¯é»å’Œé‡‘é‘°
        const apiKey = "AIzaSyAzBdrm2Ma3LWkdo87hC_TZlLPc7cuqNEo";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // --- DOM å…ƒç´ åƒç…§ ---
        const tabs = {
            prediction: document.getElementById('tabPrediction'),
            validation: document.getElementById('tabValidation')
        };
        const contents = {
            prediction: document.getElementById('predictionContent'),
            validation: document.getElementById('validationContent')
        };
        
        // é æ¸¬ (Prediction) ç›¸é—œå…ƒç´ 
        const predForm = document.getElementById('predictionForm');
        const predInput = document.getElementById('predInput');
        const predPos = document.getElementById('predPos');
        const predTask = document.getElementById('predTask');
        const predTemp = document.getElementById('predTemp');
        const predTopP = document.getElementById('predTopP');
        const predContextLen = document.getElementById('predContextLen'); // T1.4 æŠ“å– DOM
        const predButton = document.getElementById('predButton');
        const predButtonText = document.getElementById('predButtonText');
        const predLoading = document.getElementById('predLoading');
        const predError = document.getElementById('predError');
        const predictionResults = document.getElementById('predictionResults');
        const igpvlPredError = document.getElementById('igpvlPredError'); // v2.6 IGPVL æ–°å¢

        // è‡ªå®šè©å½™ (Custom Word) ç›¸é—œå…ƒç´ 
        const customWordForm = document.getElementById('customWordForm');
        const customWordInput = document.getElementById('customWordInput');
        const customButton = document.getElementById('customButton');
        const customButtonText = document.getElementById('customButtonText');
        const customLoading = document.getElementById('customLoading');
        const customResults = document.getElementById('customResults');
        const igpvlCustomError = document.getElementById('igpvlCustomError'); // v2.6 IGPVL æ–°å¢

        // é©—è­‰ (Validation) ç›¸é—œå…ƒç´ 
        const valForm = document.getElementById('validationForm');
        const valInput1 = document.getElementById('valInput1');
        const valInput2 = document.getElementById('valInput2');
        const valButton = document.getElementById('valButton');
        const valButtonText = document.getElementById('valButtonText');
        const valLoading = document.getElementById('valLoading');
        const valError = document.getElementById('valError');
        const validationResults = document.getElementById('validationResults');
        const igpvlValError = document.getElementById('igpvlValError'); // v2.6 IGPVL æ–°å¢

        // T1.8 / T2.8 Fix: é‡æ–°ç”Ÿæˆæ­·å²ç´€éŒ„
        const regenerationHistory = {};

        // --- v2.6 IGPVL (Input Grammar Pre-Validation Layer) Schema ---
        // æ ¹æ“šä½¿ç”¨è€… v2.6 è¦æ ¼å®šç¾©çš„ Schema
        const igpvlSchema = {
            "type": "OBJECT",
            "description": "Input Grammar Pre-Validation Layer (IGPVL) çš„å³æ™‚å›é¥‹",
            "properties": {
                "input_id": { "type": "STRING", "description": "å°æ‡‰è«‹æ±‚çš„å”¯ä¸€ ID" },
                "status": { "type": "STRING", "enum": ["passed", "warning", "blocked"], "description": "é©—è­‰ç‹€æ…‹" },
                "error_count": { "type": "NUMBER", "description": "åµæ¸¬åˆ°çš„æ–‡æ³•éŒ¯èª¤ç¸½æ•¸" },
                "severity": { "type": "STRING", "enum": ["none", "minor", "major"], "description": "æ•´é«”éŒ¯èª¤åš´é‡æ€§" },
                "errors": {
                    "type": "ARRAY",
                    "description": "åµæ¸¬åˆ°çš„éŒ¯èª¤åˆ—è¡¨",
                    "items": {
                        "type": "OBJECT",
                        "properties": {
                            "type": { "type": "STRING", "enum": ["subject_verb_agreement","tense_error","article_error","pronoun_error","number_agreement","dangling_modifier","incomplete_comparison","double_negative","inconsistent_tense_shift","spelling","contextual_spelling","capitalization_error","number_format_error","hyphenation_error","end_punctuation","internal_punctuation","quotation_marks"],"description": "éŒ¯èª¤é¡å‹ï¼Œå¿…é ˆå¾é å…ˆå®šç¾©çš„æ¸…å–®ä¸­é¸å–ï¼Œä»¥ç¢ºä¿èˆ‡å››å¤§æª¢æŸ¥é¡åˆ¥ç›¸ç¬¦ã€‚" },
                            "message": { "type": "STRING", "description": "éŒ¯èª¤çš„æè¿°" },
                            "suggestion": { "type": "STRING", "description": "æ–‡æ³•æ­£ç¢ºçš„ä¿®æ­£å»ºè­° (å¯èƒ½æ˜¯å®Œæ•´å¥å­æˆ–ç‰‡æ®µ)" },
                            "severity": { "type": "STRING", "enum": ["minor", "major"], "description": "æ­¤éŒ¯èª¤çš„åš´é‡æ€§" },
                            "code": { "type": "STRING", "description": "ç¬¦åˆè¦ç¯„çš„éŒ¯èª¤ä»£ç¢¼ (e.g., 'IGPVL-CORE-XX')" }
                        },
                        "required": ["type", "message", "suggestion", "code"]
                    }
                },
                "recommendation": { "type": "STRING", "description": "çµ¦ä½¿ç”¨è€…çš„ç¸½é«”å»ºè­°,ä¸”æä¾›æ–‡æ³•æ­£ç¢ºå¥å­" },
                "timestamp": { "type": "STRING", "format": "date-time", "description": "ISO 8601 æ ¼å¼çš„æ™‚é–“æˆ³" }
            },
            "required": ["input_id", "status", "error_count", "severity", "errors", "recommendation", "timestamp"]
        };

        // --- v3.0 GVL (Grammar Validation Layer) Schema ---
        // æ ¹æ“šä½¿ç”¨è€…æä¾›çš„è¦æ ¼ (I-IV) å®šç¾©çš„å…±ç”¨ Schema
        const grammarValidationSchemaObject = {
            "type": "OBJECT",
            "description": "Grammar Validation Layer v3.0 çš„è©³ç´°åˆ†æçµæœ",
            "properties": {
                "correctness": {
                    "type": "OBJECT",
                    "properties": {
                        "errors": {
                            "type": "ARRAY",
							"description": "I. æ­£ç¢ºæ€§ (Grammar, Spelling, Punctuation)",
                            "description": "æ‰€æœ‰ã€Œæ­£ç¢ºæ€§ã€ç›¸é—œçš„æ–‡æ³•ã€æ‹¼å¯«ã€æ¨™é»éŒ¯èª¤åˆ—è¡¨ã€‚ç©ºé™£åˆ— [] è¡¨ç¤ºã€Œæª¢æŸ¥é€šéã€ã€‚",
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "type": { "type": "STRING", "description": "éŒ¯èª¤é¡å‹ (e.g., 'ä¸»è¬‚ä¸€è‡´', 'æ™‚æ…‹éŒ¯èª¤', 'å† è©éŒ¯èª¤','ä»£åè©éŒ¯èª¤','å–®è¤‡æ•¸ä¸ä¸€è‡´','æ‡¸å‚ä¿®é£¾èª','ä¸å®Œæ•´æ¯”è¼ƒ','é›™é‡å¦å®š','æ™‚æ…‹è½‰æ›ä¸ä¸€è‡´','ä¸€èˆ¬æ‹¼å¯«éŒ¯èª¤','èªå¢ƒæ‹¼å¯«éŒ¯èª¤','å¤§å°å¯«éŒ¯èª¤','æ•¸å­—æ ¼å¼éŒ¯èª¤','é€£å­—ç¬¦éŒ¯èª¤','å¥å°¾æ¨™é»éŒ¯èª¤','å…§éƒ¨æ¨™é»èª¤ç”¨ - å«é€—è™Ÿ/åˆ†è™Ÿ/å†’è™Ÿ')"},
                                    "original": { "type": "STRING", "description": "éŒ¯èª¤çš„åŸæ–‡ç‰‡æ®µ" },
                                    "correction": { "type": "STRING", "description": "ä¿®æ­£å»ºè­°" },
                                    "explanation": { "type": "STRING", "description": "ç°¡çŸ­è§£é‡‹" }
                                },
                                "required": ["type", "original", "correction"]
                            }
                        }
                    },
                    "required": ["errors"]
                },
                "clarity": {
                    "type": "OBJECT",
					"description": "II. æ¸…æ™°åº¦ (Clarity) - å»ºè­°æ€§",
                    "properties": {
                        "feedback": { "type": "ARRAY", "description": "æ¸…æ™°åº¦å•é¡Œ (e.g., 'æµæ°´å¥','ç‰‡æ®µå¥', 'è´…è©', 'èªè¨€æµæš¢åº¦')", "items": { "type": "STRING" } },
                        "rewrite_suggestion": { "type": "STRING", "description": "é‡å°è¤‡é›œå¥å­çš„å®Œæ•´é‡å¯«å»ºè­° (è‹¥ç„¡å‰‡ç‚ºç©ºå­—ä¸²)" },
                        "passive_voice_warning": { "type": "BOOLEAN", "description": "æ˜¯å¦éåº¦ä½¿ç”¨è¢«å‹•èªæ…‹" }
                    },
                    "required": ["feedback", "rewrite_suggestion", "passive_voice_warning"]
                },
                "engagement": {
                    "type": "OBJECT",
                    "properties": {
                        "feedback": { "type": "ARRAY", "description": "åƒèˆ‡åº¦å•é¡Œ (e.g., 'è©å½™å–®èª¿', 'å¥å­çµæ§‹é‡è¤‡')", "items": { "type": "STRING" } },
                        "vocab_suggestions": {
                            "type": "ARRAY",
							"description": "è©å½™å¢å¼·å»ºè­° (æ›¿æ›ä¹å‘³æˆ–éåº¦ä½¿ç”¨çš„è©)",
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "original": { "type": "STRING" },
                                    "suggestion": { "type": "STRING" }
                                },
                                "required": ["original", "suggestion"]
                            }
                        }
                    },
                    "required": ["feedback", "vocab_suggestions"]
                },
                "delivery": {
                    "type": "OBJECT",
					"description": "IV. å‚³éæ€§ (Delivery / Tone)",
                    "properties": {
                        "detected_tone": { "type": "STRING", "description": "åµæ¸¬åˆ°çš„èªæ°£" },
                        "formality": { "type": "STRING", "description": "æ­£å¼ç¨‹åº¦ (e.g., 'æ­£å¼', 'éæ­£å¼', 'å£èªåŒ–')" },
                        "inclusive_language_warning": { "type": "BOOLEAN", "description": "æ˜¯å¦åŒ…å«ä¸å…·åŒ…å®¹æ€§çš„èªè¨€" }
                    },
                    "required": ["detected_tone", "formality", "inclusive_language_warning"]
                }
            },
            "required": ["correctness", "clarity", "engagement", "delivery"]
        };

        // --- æ ¸å¿ƒè¼”åŠ©å‡½å¼ ---

        /**
         * T1.4 Fix: æˆªæ–·ä¸Šä¸‹æ–‡ä»¥ç¬¦åˆæœ€å¾Œ N å€‹è©
         * @param {string} text - å®Œæ•´è¼¸å…¥æ–‡å­—
         * @param {number} wordCount - éœ€è¦ä¿ç•™çš„æœ€å¾Œè©å½™æ•¸é‡
         * @returns {string} - æˆªæ–·å¾Œçš„æ–‡å­—
         */
        function truncateContext(text, wordCount) {
            if (!text) return "";
            const words = text.trim().split(/\s+/); // æŒ‰ç©ºç™½æ‹†åˆ†
            const count = parseInt(wordCount, 10) || 20; // é è¨­ 20
            
            if (words.length <= count) {
                return text.trim(); // ä¸éœ€è¦æˆªæ–·
            }
            
            return words.slice(-count).join(' '); // å–æœ€å¾Œ N å€‹è©
        }

        /**
         * æ ¹æ“šPPLç²å– Band è©•èª (Cohesion & Coherence)
         * @param {number} ppl - å›°æƒ‘åº¦
         * @returns {object} - { band, summary, color }
         */
        function getCohesionBandDetails(ppl) {
            if (ppl <= 20) {
                return { band: 9, summary: 'å¥æ„æµæš¢ã€éŠœæ¥è‡ªç„¶ã€é€£è²«åº¦æ¥µé«˜ã€‚', color: 'bg-indigo-600' };
            } else if (ppl <= 40) {
                return { band: 8, summary: 'çµæ§‹æ¸…æ™°ã€éŠœæ¥é †æš¢ã€åƒ…å¶æœ‰è¼•å¾®ä¸è‡ªç„¶ã€‚', color: 'bg-purple-600' };
            } else if (ppl <= 60) {
                return { band: 7, summary: 'å¥æ³•é€£è²«ä½†ç•¥é¡¯æ©Ÿæ¢°ï¼Œéƒ¨åˆ†é€£æ¥è©æˆ–æŒ‡ä»£ä½¿ç”¨ä¸ç²¾ç¢ºã€‚', color: 'bg-blue-600' };
            } else if (ppl <= 80) {
                return { band: 6, summary: 'æœ‰æ•´é«”é‚è¼¯ä½†èªç¯‡éŠœæ¥å¶æœ‰å¤±è¡¡æˆ–é‡è¤‡ã€‚', color: 'bg-yellow-600' };
            } else {
                return { band: 5, summary: 'çµæ§‹é¬†æ•£ã€å¥èˆ‡å¥é–“ç¼ºä¹è‡ªç„¶éŠœæ¥æˆ–éåº¦æ©Ÿæ¢°ã€‚', color: 'bg-red-600' };
            }
        }

        /**
         * ã€S_Naturalness v2.1 ä¿®æ­£ç‰ˆã€‘
         * æ ¹æ“š S_Naturalness ç²å– Band è©•èª (Lexical Resource)
         * @param {number} s - S_Naturalness è‡ªç„¶åº¦åˆ†æ•¸
         * @returns {object} - { band, summary, color }
         */
        function getLexicalBandDetails(s) {
             if (s >= 0.85) {
                return { band: 9, summary: 'å®Œå…¨è‡ªç„¶ã€æ¥µé«˜æ­é…å¼·åº¦ï¼›æ¥è¿‘æ¯èªç´šè¡¨é”ã€‚', color: 'bg-indigo-600' };
            } else if (s >= 0.75) {
                return { band: 8, summary: 'æµæš¢éˆæ´»ã€å°‘è¨±èª¤ç”¨ï¼›ä»å±¬é«˜éšæ­é…ã€‚', color: 'bg-purple-600' };
            } else if (s >= 0.60) {
                return { band: 7, summary: 'å¯ç†è§£ä¸”å¸¸è¦‹ï¼Œä½†ç•¥é¡¯æ©Ÿæ¢°æˆ–é‡è¤‡ã€‚', color: 'bg-blue-600' };
            } else if (s >= 0.40) {
                return { band: 6, summary: 'ä¸­ç­‰è‡ªç„¶åº¦ï¼›èªæ„æ¸…æ¥šä½†æ­é…ä¸åœ°é“ã€‚', color: 'bg-yellow-600' };
            } else {
                // S < 0.40
                return { band: 5, summary: 'ä¸è‡ªç„¶æˆ–ç”Ÿç¡¬ï¼›å»ºè­°æ›¿æ›ã€‚', color: 'bg-red-600' };
            }
        }

        /**
         * é«˜äº®é¡¯ç¤ºä¾‹å¥ä¸­çš„ç‰‡èª
         * @param {string} text - å®Œæ•´çš„ä¾‹å¥
         * @param {string} phraseToHighlight - éœ€è¦é«˜äº®çš„ç‰‡èª
         * @returns {string} - åŒ…å« HTML <span class="highlight"> çš„å­—ä¸²
         */
        function highlight(text, phraseToHighlight) {
            if (!text || !phraseToHighlight) return text;
            // æ›¿æ›æ‰€æœ‰éå–®è©å­—å…ƒç‚ºç©ºç™½ï¼Œä»¥ç¢ºä¿æ­£ç¢ºåŒ¹é…è©å½™é‚Šç•Œ
            const cleanedPhrase = phraseToHighlight.trim().replace(/[\W_]+/g,"\\s*");
            // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼é€²è¡Œä¸å€åˆ†å¤§å°å¯«çš„æ›¿æ›
            const regex = new RegExp(`(${cleanedPhrase})`, 'gi');
            
            // ä½¿ç”¨ match å‡½å¼ç¢ºä¿åŸå§‹å¤§å°å¯«è¢«ä¿ç•™
            return text.replace(regex, (match, p1) => {
                // p1 æ˜¯åŸå§‹åŒ¹é…çš„ç¾¤çµ„ï¼Œç¢ºä¿æˆ‘å€‘åªé«˜äº®é€™éƒ¨åˆ†
                return `<span class="highlight">${match}</span>`;
            });
        }

        /**
         * v3.0: æ¸²æŸ“ Grammar Validation Layer çš„ HTML å ±å‘Š
         * @param {object} validation - grammar_validation ç‰©ä»¶
         * @returns {string} - æ ¼å¼åŒ–å¾Œçš„ HTML
         */
        function renderGrammarValidation(validation) {
            if (!validation) {
                return '<div class="text-xs text-red-400">æ–‡æ³•é©—è­‰è³‡æ–™ç¼ºå¤±ã€‚</div>';
            }

            let html = '<div class="space-y-2 mt-2 pt-2 border-t border-gray-600 text-xs text-left">'; // æ”¹ç‚º text-left
            
            // I. æ­£ç¢ºæ€§
            const { correctness, clarity, engagement, delivery } = validation;
            html += '<h5 class="font-semibold text-gray-300">æ–‡æ³•é©—è­‰å ±å‘Š (v3.1)</h5>';
            
            if (correctness && correctness.errors && correctness.errors.length > 0) {
                html += `<div class="text-yellow-400">I. æ­£ç¢ºæ€§: ${correctness.errors.length} å€‹åš´é‡éŒ¯èª¤</div>`;
                html += '<ul class="list-disc list-inside text-gray-400 pl-2">';
                correctness.errors.slice(0, 10).forEach(err => { // æœ€å¤šé¡¯ç¤º 10 å€‹
                    html += `<li>[${err.type}] <strong>"${err.original}"</strong> &rarr; <strong>"${err.correction}"</strong></li>`;
                });
                html += '</ul>';
            } else {
                html += '<div class="text-green-400">I. æ­£ç¢ºæ€§: æª¢æŸ¥é€šéã€‚</div>';
            }

            // II. æ¸…æ™°åº¦
            if (clarity && (clarity.feedback.length > 0 || clarity.rewrite_suggestion || clarity.passive_voice_warning)) {
                html += `<div class="text-blue-300 mt-1">II. æ¸…æ™°åº¦:</div>`;
                html += '<ul class="list-disc list-inside text-gray-400 pl-2">';
                clarity.feedback.slice(0, 10).forEach(fb => html += `<li>${fb}</li>`); // æœ€å¤š 10 å€‹
                if (clarity.passive_voice_warning) html += '<li>æé†’: éåº¦ä½¿ç”¨è¢«å‹•èªæ…‹ã€‚</li>';
                if (clarity.rewrite_suggestion) html += `<li>é‡å¯«å»ºè­°: <span class="text-blue-200">${clarity.rewrite_suggestion}</span></li>`;
                html += '</ul>';
            } else {
                html += '<div class="text-green-400">II. æ¸…æ™°åº¦: æª¢æŸ¥é€šéã€‚</div>';
            }

            // III. åƒèˆ‡åº¦
            if (engagement && (engagement.feedback.length > 0 || engagement.vocab_suggestions.length > 0)) {
                html += `<div class="text-purple-300 mt-1">III. åƒèˆ‡åº¦:</div>`;
                html += '<ul class="list-disc list-inside text-gray-400 pl-2">';
                engagement.feedback.slice(0, 10).forEach(fb => html += `<li>${fb}</li>`);
                engagement.vocab_suggestions.slice(0, 1).forEach(vs => html += `<li>è©å½™å»ºè­°: ${vs.original} &rarr; ${vs.suggestion}</li>`);
                html += '</ul>';
            }

            // IV. å‚³éæ€§
            if (delivery) {
                html += `<div class="text-gray-300 mt-1">IV. èªæ°£: ${delivery.detected_tone} | æ­£å¼åº¦: ${delivery.formality}</div>`;
                if(delivery.inclusive_language_warning) html += '<div class="text-yellow-400">æé†’: åŒ…å«ä¸å…·åŒ…å®¹æ€§çš„èªè¨€ã€‚</div>';
            }

            html += '</div>';
            return html;
        }

        // --- API å‘¼å«é‚è¼¯ ---

        /**
         * å‘¼å« Gemini API
         * @param {string} systemPrompt - ç³»çµ±æç¤º (System Instruction)
         * @param {string} userQuery - ä½¿ç”¨è€…æŸ¥è©¢
         * @param {object|null} schema - JSON è¼¸å‡ºçµæ§‹ (è‹¥éœ€è¦)
         * @param {number} temperature - æ¡æ¨£æº«åº¦
         * @param {number} topP - Top-P æ¡æ¨£åƒæ•¸
         * @param {number} maxRetries - æœ€å¤§é‡è©¦æ¬¡æ•¸
         * @returns {Promise<object>} - API å›æ‡‰æˆ–éŒ¯èª¤ç‰©ä»¶
         */
        async function callGeminiAPI(systemPrompt, userQuery, schema = null, temperature = 0.7, topP = 0.95, maxRetries = 3) {
            
			// ===============================================
			// ğŸš¨ é€™æ˜¯æ‚¨è¦çš„æª¢æŸ¥é»ï¼šå°å‡ºçµ¦ AI çš„ Prompt å…§å®¹
			// ===============================================
			console.log("--- ç™¼é€çµ¦ AI çš„ System Prompt ---");
			console.log(systemPrompt);
			console.log("----------------------------------");
			
			console.log("--- ç™¼é€çµ¦ AI çš„ User Query ---");
			console.log(userQuery);
			console.log("-------------------------------");
			
			// ç”±æ–¼æ‚¨çš„ System Prompt éå¸¸é•·ï¼Œæ‚¨å¯ä»¥å°‡å®ƒå€‘ä¸€èµ·å°å‡º
			console.log("--- å®Œæ•´çš„ API è«‹æ±‚ Payload å…§å®¹ (é™¤éŒ¯ç”¨) ---");
			
			const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };
            
            const generationConfig = {
                temperature: parseFloat(temperature),
                topP: parseFloat(topP),
            };

            if (schema) {
                generationConfig.responseMimeType = "application/json";
                generationConfig.responseSchema = schema;
            }
            payload.generationConfig = generationConfig;
            
            // å°å‡ºæ•´å€‹ payload ç‰©ä»¶
			console.log(JSON.stringify(payload, null, 2));
			console.log("----------------------------------------------");

            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);
                    }

                    const result = await response.json();
					
                    const candidate = result.candidates?.[0];

                    if (!candidate || !candidate.content?.parts?.[0]) {
                        throw new Error("API è¿”å›äº†ç„¡æ•ˆçš„å›æ‡‰çµæ§‹æˆ–è¢«éæ¿¾ã€‚");
                    }

                    const part = candidate.content.parts[0];
                    
                    if (schema) {
                        // è™•ç† JSON å›æ‡‰
                        const jsonText = part.text;
                        return JSON.parse(jsonText);
                    } else {
                        // è™•ç†ç´”æ–‡å­—å›æ‡‰
                        return part.text;
                    }

                } catch (error) {
                    console.error(`API å‘¼å«ç¬¬ ${attempt} æ¬¡å¤±æ•—:`, error);
                    if (attempt === maxRetries) {
                        return { isError: true, message: `API è«‹æ±‚å¤±æ•—: ${error.message}` };
                    }
                    // æŒ‡æ•¸é€€é¿
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                }
            }
        }

        // --- v2.6 IGPVL (Input Grammar Pre-Validation Layer) é‚è¼¯ ---

        /**
         * åŸ·è¡Œ IGPVL æª¢æŸ¥ (æ¨¡æ“¬ API å‘¼å«)
         * @param {string} text - è¦æª¢æŸ¥çš„å®Œæ•´æ–‡å­—
         * @param {string} inputId - å‘¼å«ä¾†æºçš„ ID
         * @param {string} context - å¯«ä½œæƒ…å¢ƒ (e.g., 'academic')
         * @returns {Promise<object>} - ç¬¦åˆ igpvlSchema çš„ç‰©ä»¶æˆ–éŒ¯èª¤
         */
        async function validateInputGrammar(text, inputId, context) {
            
            // v2.6 IGPVL System Prompt
            const systemPrompt = `ä½ æ˜¯ä¸€å€‹åš´æ ¼çš„ã€Œè¼¸å…¥æ–‡æ³•é é©—è­‰å±¤ (IGPVL)ã€ã€‚
ä½ çš„ã€Œå”¯ä¸€ã€ä»»å‹™æ˜¯åˆ†æä½¿ç”¨è€…è¼¸å…¥çš„æ–‡å­—ï¼Œä¸¦ã€Œåƒ…ã€æ ¹æ“š v2.6 è¦æ ¼å›å‚³ JSON ç‰©ä»¶ã€‚
ä½ ã€Œå¿…é ˆã€åŸ·è¡Œæ‰€æœ‰å››é¡æª¢æŸ¥ï¼š
1.  **Core Grammar (IGPVL-CORE-XX)**: ä¸»è¬‚ä¸€è‡´, æ™‚æ…‹, å† è©, ä»£åè©, å–®è¤‡è©ã€‚
2.  **Advanced Grammar (IGPVL-ADV-XX)**: æ‡¸å‚ä¿®é£¾èª, ä¸å®Œæ•´æ¯”è¼ƒ, é›™é‡å¦å®š, æ™‚æ…‹è½‰æ›ä¸ä¸€è‡´ã€‚
3.  **Spelling & Consistency (IGPVL-SPC-XX)**: æ‹¼å¯«éŒ¯èª¤, èªå¢ƒæ‹¼å¯« (e.g., their/there), å¤§å°å¯«, æ•¸å­—æ ¼å¼, é€£å­—ç¬¦ã€‚
4.  **Punctuation (IGPVL-PUN-XX)**: **ç•¶**è¼¸å…¥çš„**æœ€å¾Œä¸€å€‹å­—å…ƒæ˜¯æ¨™é»ç¬¦è™Ÿ**æ™‚ï¼Œæ‰æª¢æŸ¥å¥å°¾æ¨™é», é€—è™Ÿ/åˆ†è™Ÿ/å†’è™Ÿèª¤ç”¨ã€‚
    **ã€å¥å°¾æ¨™é»ä¾‹å¤–è¦å‰‡ã€‘**: è‹¥è¼¸å…¥è¢«åˆ¤å®šç‚º**éå®Œæ•´é™³è¿°å¥æˆ–å•å¥**ï¼ˆå³ç‚º**ç‰‡æ®µ/ç‰‡èª**ï¼‰ï¼Œå‰‡**ä¸å¾—**æ¨™è¨˜ 'end_punctuation' éŒ¯èª¤ã€‚

**è¦å‰‡:**
1.  **åš´æ ¼æª¢æŸ¥**: å³ä½¿æ˜¯å¾®å°çš„éŒ¯èª¤ (å¦‚ 'He go') ä¹Ÿè¦æ¨™è¨˜ã€‚
2.  **éŒ¯èª¤è¨ˆæ•¸ (error_count)**: å¿…é ˆæº–ç¢ºåæ˜  'errors' é™£åˆ—çš„é•·åº¦ã€‚
3.  **é©—è­‰æ©Ÿåˆ¶ (Status & Severity):**
    * error_count = 0: 'status' = 'passed', 'severity' = 'none', 'recommendation' = 'æ–‡æ³•æ­£ç¢ºï¼Œæº–å‚™ç”Ÿæˆã€‚'
    * 1 $\le$ error_count $\le$ 3: 'status' = 'warning', 'severity' = 'minor', 'recommendation' = 'åµæ¸¬åˆ° \${error_count} å€‹è¼•å¾®éŒ¯èª¤ã€‚è«‹åƒè€ƒå»ºè­°ï¼Œå·²å…è¨±ç¹¼çºŒç”Ÿæˆã€‚'
    * error_count > 3: 'status' = 'blocked', 'severity' = 'major', 'recommendation' = 'åµæ¸¬åˆ° \${error_count} å€‹åš´é‡éŒ¯èª¤ã€‚è«‹ä¿®æ­£è¼¸å…¥å¾Œå†è©¦ã€‚'
4.  **éŒ¯èª¤ä»£ç¢¼**: 'code' æ¬„ä½å¿…é ˆç¬¦åˆè¦ç¯„ (e.g., 'IGPVL-CORE-01', 'IGPVL-SPC-01')ã€‚
5.  **æ™‚é–“æˆ³**: å¿…é ˆæä¾› ISO 8601 æ ¼å¼çš„ç•¶å‰ UTC æ™‚é–“ã€‚
6.  **çµ•å°ç¦æ­¢**: ä½ çš„å›è¦†ã€Œä¸å¾—ã€åŒ…å« JSON ä»¥å¤–çš„ä»»ä½•æ–‡å­— (ä¾‹å¦‚ "Here is the JSON...")ã€‚`;

            const userQuery = `
{
  "input_id": "${inputId}",
  "text": "${text}",
  "context": "${context}",
  "language": "en",
  "validation_mode": "strict"
}
`;
            // ä½¿ç”¨ 0.1 æº«åº¦ä»¥ç¢ºä¿ IGPVL æª¢æŸ¥çš„ç©©å®šæ€§å’Œä¸€è‡´æ€§
            const result = await callGeminiAPI(systemPrompt, userQuery, igpvlSchema, 0.1, 1.0);
            
            // ç¢ºä¿æ™‚é–“æˆ³å­˜åœ¨ (æ¨¡å‹æœ‰æ™‚æœƒå¿˜è¨˜)
            if (result && !result.isError && !result.timestamp) {
                result.timestamp = new Date().toISOString();
            }
            return result;
        }

        /**
         * åœ¨ UI ä¸Šé¡¯ç¤º IGPVL çš„å›é¥‹
         * @param {HTMLElement} el - è¦é¡¯ç¤ºå›é¥‹çš„ DOM å…ƒç´ 
         * @param {object} result - ä¾†è‡ª validateInputGrammar çš„çµæœç‰©ä»¶
         * @returns {boolean} - æ˜¯å¦é˜»æ­¢äº†æµç¨‹ (isBlocked)
         */
        function displayIgpvlFeedback(el, result) {
            el.innerHTML = '';
            
            if (result.isError) {
                el.className = 'text-sm p-3 rounded-lg bg-red-900/50 text-red-400';
                el.innerHTML = `<strong>IGPVL æª¢æŸ¥å¤±æ•—:</strong> ${result.message}`;
                return true; // é˜»æ­¢æµç¨‹
            }

            if (result.status === 'blocked') {
                el.className = 'text-sm p-3 rounded-lg bg-red-900/50 text-red-400 space-y-2';
                let html = `<p class="font-semibold">${result.recommendation}</p>`;
                html += '<ul class="list-disc list-inside text-xs">';
                result.errors.forEach(err => {
                    html += `<li>[${err.code}] ${err.message} (å»ºè­°: <strong>${err.suggestion}</strong>)</li>`;
                });
                html += '</ul>';
                el.innerHTML = html;
                return true; // é˜»æ­¢æµç¨‹
            
            } else if (result.status === 'warning') {
                el.className = 'text-sm p-3 rounded-lg bg-yellow-900/50 text-yellow-400 space-y-2';
                let html = `<p class="font-semibold">${result.recommendation}</p>`;
                html += '<ul class="list-disc list-inside text-xs">';
                result.errors.forEach(err => {
                    html += `<li>[${err.code}] ${err.message} (å»ºè­°: <strong>${err.suggestion}</strong>)</li>`;
                });
                html += '</ul>';
                el.innerHTML = html;
                return false; // ä¸é˜»æ­¢æµç¨‹
            
            } else {
                // 'passed'
                el.className = 'text-sm p-3 rounded-lg bg-green-900/50 text-green-400';
                el.innerHTML = `<p class="font-semibold">${result.recommendation}</p>`;
                return false; // ä¸é˜»æ­¢æµç¨‹
            }
        }


        // --- Prediction Tab é‚è¼¯ ---

        // v3.0 æ›´æ–°: ä½¿ç”¨ v3.0 Grammar Validation Layer Schema
        const predictionSchema = {
            type: "ARRAY",
            maxItems: 6,
            items: {
                type: "OBJECT",
                properties: {
                    "word": { "type": "STRING", "description": "é æ¸¬çš„ä¸‹ä¸€å€‹è©å½™" },
                    "p_w_n": { "type": "NUMBER", "description": "æ¢ä»¶æ©Ÿç‡ P(w_n | context), 0åˆ°1ä¹‹é–“" },
                    "ppl": { "type": "NUMBER", "description": "è©²ç¤ºä¾‹å¥çš„å›°æƒ‘åº¦ (Perplexity)" },
                    "band": { "type": "NUMBER", "description": "å°æ‡‰çš„ IELTS Cohesion & Coherence Band (5, 6, 7, 8, or 9)" },
                    "band_summary": { "type": "STRING", "description": "IELTS è€ƒå®˜è§’åº¦æ‘˜è¦æè¿° (åŸºæ–¼PPLçš„é€£è²«æ€§è©•ä¼°)" },
                    "example": { "type": "STRING", "description": "ä¸è¶…é 25 å€‹å­—çš„ä¾‹å¥" },
                    "consistency_score": { "type": "NUMBER", "description": "èªç¾©ä¸€è‡´æ€§åˆ†æ•¸ (0-100)" },
                    "grammar_validation": grammarValidationSchemaObject // v3.0 æ›¿æ›
                },
                required: ["word", "p_w_n", "ppl", "band", "band_summary", "example", "consistency_score", "grammar_validation"] // v3.0 æ›¿æ›
            }
        };
        
        async function handlePredictionSubmit(e) {
            e.preventDefault();
            const phrase = predInput.value.trim();
            
            // v2.6 IGPVL æ•´åˆ: æ¸…ç©ºèˆŠè¨Šæ¯
            igpvlPredError.innerHTML = '';
            igpvlPredError.className = 'text-sm rounded-lg';
            predError.classList.add('hidden'); // éš±è—èˆŠçš„ç”ŸæˆéŒ¯èª¤
            predictionResults.innerHTML = ''; // æ¸…ç©ºèˆŠçµæœ

            if (!phrase) {
                displayError(predError, "è«‹è¼¸å…¥è‹±æ–‡ç‰‡èªã€‚", predLoading, predButton, predButtonText, "ç²å– 6 å€‹é æ¸¬è©å½™ (Get Predictions)");
                return;
            }

            // è¨­ç½® UI ç‚ºè¼‰å…¥ä¸­ (v2.6: åœ¨ IGPVL ä¹‹å‰)
            displayLoading(predError, predLoading, predButton, predButtonText, "1/2 æ­£åœ¨é©—è­‰è¼¸å…¥...");

            // --- v2.6 IGPVL åŸ·è¡Œ ---
            const igpvlResult = await validateInputGrammar(phrase, 'predInput', 'academic');
            const isBlocked = displayIgpvlFeedback(igpvlPredError, igpvlResult);

            if (isBlocked) {
                displayDone(predLoading, predButton, predButtonText, "ç²å– 6 å€‹é æ¸¬è©å½™ (Get Predictions)");
                return; // åœæ­¢åŸ·è¡Œ
            }
            // --- IGPVL çµæŸ ---

            // è¨­ç½® UI ç‚ºè¼‰å…¥ä¸­ (v2.6: æ›´æ–°ç‹€æ…‹)
            displayLoading(predError, predLoading, predButton, predButtonText, "2/2 æ­£åœ¨é æ¸¬...");

            // æº–å‚™ API è«‹æ±‚
            const posFilter = predPos.value === 'any' ? 'ä»»ä½•è©æ€§' : predPos.value;
            const taskContext = predTask.value === 'general' ? 'é€šç”¨å¯«ä½œ' : `IELTS ${predTask.value}`;
            const temp = predTemp.value;
            const topP = predTopP.value;
            // T1.4 Fix: è®€å–ä¸¦æˆªæ–·ä¸Šä¸‹æ–‡
            const contextLen = predContextLen.value;
            const truncatedPhrase = truncateContext(phrase, contextLen);

            // v3.0 (ä½¿ç”¨è€…è‡ªè¨‚) æ›´æ–°: åš´æ ¼å¯¦ä½œ Grammar Validation Layer
            const systemPrompt = `ä½ æ˜¯ä¸€å€‹ IELTS å¯«ä½œåŠ©æ•™ã€‚ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šä½¿ç”¨è€…è¼¸å…¥çš„ç‰‡èªï¼Œé æ¸¬ 6 å€‹æœ€å¸¸è¦‹çš„ä¸‹ä¸€å€‹è©å½™ã€‚
			ã€å…§éƒ¨åƒç…§ï¼šè‹±æ–‡å¥å­å®šç¾©ã€‘ï¼š**ä¸€å€‹å®Œæ•´çš„è‹±æ–‡å¥å­å¿…é ˆåŒ…å«ä¸»è©å’Œè¿°èªï¼Œè¡¨é”ä¸€å€‹å®Œæ•´çš„æ„æ€ï¼ˆç¨ç«‹å­å¥ï¼‰ï¼Œä¸”å¥é¦–å¤§å¯«ï¼Œå¥å°¾ä»¥å¥é»ã€å•è™Ÿæˆ–é©šå˜†è™Ÿä½œçµã€‚**æ­¤åƒç…§å°‡ç”¨æ–¼è¦å‰‡ 8 çš„åš´æ ¼æª¢æŸ¥ã€‚
è¦å‰‡ï¼š
1. åš´æ ¼éµå®ˆä½¿ç”¨è€…æŒ‡å®šçš„ã€Œè©æ€§ (POS)ã€å’Œã€Œå¯«ä½œä»»å‹™ (Task)ã€ä¸Šä¸‹æ–‡ã€‚
2. ã€**çµ•å°è¦å‰‡**ã€‘: ä½ ç”Ÿæˆçš„ã€Œæ‰€æœ‰ã€'example' å¥å­éƒ½ã€Œ**å¿…é ˆ**ã€ç¶“éä¸‹é¢ç¬¬ 8 é» GVL (Grammar Validation Layer) çš„ã€Œ**å¾¹åº•ä¸”åš´æ ¼**ã€çš„æª¢æŸ¥ã€‚**æ­¤æª¢æŸ¥æ˜¯å¼·åˆ¶æ€§çš„ï¼Œä¸å¾—è·³éæˆ–æ•·è¡**ã€‚
3. ç‚ºæ¯å€‹é æ¸¬è©æä¾›ã€Œæ¢ä»¶æ©Ÿç‡ P(w_n | context)ã€ã€ã€Œç²¾ç°¡ä¾‹å¥ (example)ã€ã€ã€Œå›°æƒ‘åº¦ (ppl)ã€å’Œã€ŒIELTS Cohesion & Coherence Band è©•ä¼°ã€ã€‚
4. ã€PPL-Band æ˜ å°„ã€‘: PPL 0â€“20=Band 9, 21â€“40=Band 8, 41â€“60=Band 7, 61â€“80=Band 6, >80=Band 5ã€‚
5. ã€é‡é»ã€‘ä¾‹å¥ä¸­ï¼Œé æ¸¬çš„è©å½™å¿…é ˆã€Œç·Šå¯†ä¸”å”¯ä¸€åœ°ã€ç·Šæ¥åœ¨ä½¿ç”¨è€…è¼¸å…¥ç‰‡èªçš„ã€Œæœ€å¾Œä¸€å€‹å­—ã€ä¹‹å¾Œã€‚å¦‚æœä½¿ç”¨è€…è¼¸å…¥ç‰‡èªçš„æœ€å¾Œä¸€å€‹å­—æ˜¯æ¨™é»ç¬¦è™Ÿï¼ˆä¾‹å¦‚ï¼šå¥è™Ÿ .ã€é€—è™Ÿ ,ã€å•è™Ÿ ?ã€å†’è™Ÿ :ã€åˆ†è™Ÿ ; ç­‰ï¼‰ï¼Œå‰‡é æ¸¬çš„è©å½™å¿…é ˆåœ¨æ¨™ç‚¹ç¬¦è™Ÿä¹‹å¾Œã€Œç·Šå¯†ä¸”å”¯ä¸€åœ°ã€ä»¥ä¸€å€‹ç©ºæ ¼éš”é–‹**ã€‚**
6. æ¯æ¬¡ä¾‹å¥ç”Ÿæˆæ¨¡æ“¬åŸ·è¡Œä¸‰è¼ª Self-Consistency æ¡æ¨£ï¼Œä»¥ç¢ºä¿èªç¾©ç©©å®šæ€§ã€‚
7. ç‚ºæ¯æ¬¡ç”Ÿæˆæä¾›ã€Œä¸€è‡´æ€§åˆ†æ•¸ (consistency_score)ã€(0-100)ï¼ŒåŸºæ–¼èªç¾©ç›¸ä¼¼åº¦ã€è©å½™è®Šç•°åº¦ã€å¥æ³•ç©©å®šæ€§è¨ˆç®—ã€‚
8. ã€Grammar Validation Layer (æœ€æ–°è¦æ ¼)ã€‘: **é€™æ˜¯æœ€é‡è¦çš„æ­¥é©Ÿ**ã€‚å°ç”Ÿæˆçš„ 'example' åŸ·è¡Œåš´æ ¼çš„æ–‡æ³•é©—è­‰ï¼Œä¸¦å¡«å…¥ 'grammar_validation' ç‰©ä»¶ã€‚
    a. ã€I. æ­£ç¢ºæ€§ (Strict Correctness)ã€‘: åš´æ ¼åŸ·è¡Œæ­¤éƒ¨åˆ†çš„æª¢æŸ¥ã€‚'correctness.errors' é™£åˆ—ã€Œå¿…é ˆã€åŒ…å«æ‰€æœ‰åµæ¸¬åˆ°çš„éŒ¯èª¤ã€‚**é€™åŒ…æ‹¬æœ€å¾®å°çš„éŒ¯èª¤ï¼ˆä¾‹å¦‚å† è©ã€å–®è¤‡æ•¸ã€æ¨™é»ç¬¦è™Ÿï¼‰**ã€‚å¦‚æœæ²’æœ‰éŒ¯èª¤ï¼Œå¿…é ˆè¿”å›ç©ºé™£åˆ— []ã€‚
        - æ ¸å¿ƒæ–‡æ³•: ä¸»è¬‚ä¸€è‡´, åŸºç¤æ™‚æ…‹éŒ¯èª¤, ä»£åè©æ ¼ä½, å† è©éŒ¯èª¤,å–®è¤‡è©ã€‚
        - è¤‡é›œæ–‡æ³•: æ‡¸å‚ä¿®é£¾èª, æ™‚æ…‹è½‰æ›ä¸ä¸€è‡´, ä¸å®Œæ•´æ¯”è¼ƒ, é›™é‡å¦å®šã€‚
        - æ‹¼å¯«: åŸºç¤æ‹¼å¯«, èªå¢ƒæ‹¼å¯« (there/their), å¤§å°å¯«/æ•¸å­—æ ¼å¼, é€£å­—ç¬¦ã€‚
		
    b. ã€II. æ¸…æ™°åº¦ (Clarity)ã€‘: æä¾›ã€Œå»ºè­°ã€ã€‚
        - çµæ§‹: æª¢æŸ¥ æµæ°´å¥, ç‰‡æ®µå¥ã€‚
        - å„ªåŒ–: æä¾› ç°¡æ½”æ€§å»ºè­° (è´…è©), åµæ¸¬ éåº¦ä½¿ç”¨è¢«å‹•èªæ…‹, ä¸¦åœ¨éœ€è¦æ™‚æä¾› å®Œæ•´å¥å­é‡å¯« (rewrite_suggestion) æˆ– èªè¨€æµæš¢åº¦ (feedback) å»ºè­°ã€‚
    c. ã€III. åƒèˆ‡åº¦ (Engagement)ã€‘: æä¾›ã€Œå»ºè­°ã€ã€‚
        - è©å½™: é€é 'vocab_suggestions' å»ºè­°æ›¿æ› éåº¦ä½¿ç”¨æˆ–ä¹å‘³ çš„è©å½™ã€‚
        - çµæ§‹: é€é 'feedback' æé†’ å¥å­å¤šæ¨£æ€§ æˆ– å…§å®¹é‡è¤‡ çš„å•é¡Œã€‚
    d. ã€IV. å‚³éæ€§ (Delivery)ã€‘: (ç¶­æŒåŸæ¨™æº–) åµæ¸¬ 'detected_tone', 'formality' (e.g., 'æ­£å¼')ï¼Œä¸¦æª¢æŸ¥ 'inclusive_language_warning'ã€‚
9. åƒ…ä»¥è¦æ±‚çš„ JSON æ ¼å¼é™£åˆ— (Array) è¼¸å‡ºã€‚`;

            const userQuery = `
è¼¸å…¥ç‰‡èª (åƒ…ä½¿ç”¨æœ€å¾Œ ${contextLen} è©): "${truncatedPhrase}"
è©æ€§éæ¿¾: ${posFilter}
å¯«ä½œä»»å‹™: ${taskContext}
æ¡æ¨£åƒæ•¸ (T=${temp}, TopP=${topP})
`;

            // å‘¼å« API
            const results = await callGeminiAPI(systemPrompt, userQuery, predictionSchema, temp, topP);
            
			// â­ï¸ åœ¨é€™è£¡åŠ å…¥æª¢æŸ¥é»ï¼šå°å‡º API çš„åŸå§‹å›æ‡‰
			console.log("--- Gemini API åŸå§‹å›æ‡‰ (results) ---");
			console.log(results);
			console.log("-----------------------------------------");
            // æ¢å¾© UI
            displayDone(predLoading, predButton, predButtonText, "ç²å– 6 å€‹é æ¸¬è©å½™ (Get Predictions)");

            // è™•ç† API å›æ‡‰
            if (results.isError) {
                displayError(predError, results.message);
            } else if (Array.isArray(results)) {
                displayPredictionResults(results, truncatedPhrase); // T1.4 Fix: å‚³éæˆªæ–·å¾Œçš„ç‰‡èª
            } else {
                displayError(predError, "æ”¶åˆ°éé æœŸçš„å›æ‡‰æ ¼å¼ã€‚");
            }
        }
        
        // v3.0: æ›´æ–° customSchema
        const customSchema = {
            type: "OBJECT",
            properties: {
                "p_w_n": { "type": "NUMBER", "description": "æ¢ä»¶æ©Ÿç‡ P(w_n | context), 0åˆ°1ä¹‹é–“" },
                "ppl": { "type": "NUMBER", "description": "è©²ç¤ºä¾‹å¥çš„å›°æƒ‘åº¦ (Perplexity)" },
                "band": { "type": "NUMBER", "description": "å°æ‡‰çš„ IELTS Cohesion & Coherence Band (5, 6, 7, 8, or 9)" },
                "band_summary": { "type": "STRING", "description": "IELTS è€ƒå®˜è§’åº¦æ‘˜è¦æè¿° (åŸºæ–¼PPLçš„é€£è²«æ€§è©•ä¼°)" },
                "example": { "type": "STRING", "description": "ä¸è¶…é 25 å€‹å­—çš„ä¾‹å¥" },
                "consistency_score": { "type": "NUMBER", "description": "èªç¾©ä¸€è‡´æ€§åˆ†æ•¸ (0-100)" },
                "grammar_validation": grammarValidationSchemaObject // v3.0 æ›¿æ›
            },
            required: ["p_w_n", "ppl", "band", "band_summary", "example", "consistency_score", "grammar_validation"] // v3.0 æ›¿æ›
        };

        // è™•ç†è‡ªå®šè©å½™é©—è­‰
        async function handleCustomWordCheck(e) {
            e.preventDefault();
            const phrase = predInput.value.trim();
            const customWord = customWordInput.value.trim();

            // v2.6 IGPVL æ•´åˆ: æ¸…ç©ºèˆŠè¨Šæ¯
            igpvlCustomError.innerHTML = '';
            igpvlCustomError.className = 'text-sm rounded-lg mt-4';
            customResults.innerHTML = ''; // æ¸…ç©ºèˆŠçµæœ

            if (!phrase || !customWord) {
                igpvlCustomError.className = 'text-sm p-3 rounded-lg bg-red-900/50 text-red-400';
                igpvlCustomError.innerHTML = 'è«‹è¼¸å…¥ä¸Šä¸‹æ–‡å’Œè‡ªå®šè©å½™ã€‚';
                return;
            }

            // è¨­ç½® UI ç‚ºè¼‰å…¥ä¸­ (v2.6: åœ¨ IGPVL ä¹‹å‰)
            customLoading.classList.remove('hidden');
            customButton.disabled = true;
            customButtonText.textContent = "1/2 é©—è­‰è¼¸å…¥...";

            // --- v2.6 IGPVL åŸ·è¡Œ (åƒ…æª¢æŸ¥ä¸Šä¸‹æ–‡ phrase) ---
            const igpvlResult = await validateInputGrammar(phrase, 'predInput_custom', 'academic');
            const isBlocked = displayIgpvlFeedback(igpvlCustomError, igpvlResult);

            if (isBlocked) {
                customLoading.classList.add('hidden');
                customButton.disabled = false;
                customButtonText.textContent = "Check Word";
                return; // åœæ­¢åŸ·è¡Œ
            }
            // --- IGPVL çµæŸ ---

            // è¨­ç½® UI ç‚ºè¼‰å…¥ä¸­ (v2.6: æ›´æ–°ç‹€æ…‹)
            customButtonText.textContent = "2/2 æª¢æŸ¥ä¸­...";

            // æº–å‚™ API è«‹æ±‚ (ä½¿ç”¨å–®è©æ¨¡å¼)
            // T1.4 Fix: è®€å–ä¸¦æˆªæ–·ä¸Šä¸‹æ–‡
			const taskContext = predTask.value === 'general' ? 'é€šç”¨å¯«ä½œ' : `IELTS ${predTask.value}`;
            const temp = predTemp.value;
            const topP = predTopP.value;
            const contextLen = predContextLen.value;
            const truncatedPhrase = truncateContext(phrase, contextLen);
            const fullPhrase = `${truncatedPhrase} ${customWord}`;

            // v3.0 (ä½¿ç”¨è€…è‡ªè¨‚) æ›´æ–°: åš´æ ¼å¯¦ä½œ Grammar Validation Layer
            const systemPrompt = `ä½ æ˜¯ä¸€å€‹ IELTS å¯«ä½œåŠ©æ•™ã€‚ä½ çš„ä»»å‹™æ˜¯é©—è­‰ä½¿ç”¨è€…è¼¸å…¥çš„è©å½™ã€Œ${customWord}ã€åœ¨ä¸Šä¸‹æ–‡ã€Œ${truncatedPhrase}ã€ä¹‹å¾Œçš„è‡ªç„¶åº¦ã€‚
			
è¦å‰‡ï¼š
1. åš´æ ¼éµå®ˆä½¿ç”¨è€…æŒ‡å®šçš„ã€Œå¯«ä½œä»»å‹™ (Task)ã€ä¸Šä¸‹æ–‡ã€‚
2. ã€**çµ•å°è¦å‰‡**ã€‘: ä½ ç”Ÿæˆçš„ã€Œæ‰€æœ‰ã€'example' å¥å­å¿…é ˆæ»¿è¶³ä¸‹é¢ç¬¬ 9 é»**è‹±æ–‡å¥å­å®šç¾©**è€Œä¸”éƒ½ã€Œ**å¿…é ˆ**ã€ç¶“éä¸‹é¢ç¬¬ 8 é» GVL (Grammar Validation Layer) çš„ã€Œ**å¾¹åº•ä¸”åš´æ ¼**ã€çš„æª¢æŸ¥ã€‚**æ­¤æª¢æŸ¥æ˜¯å¼·åˆ¶æ€§çš„ï¼Œä¸å¾—è·³éæˆ–æ•·è¡**ã€‚
3. ç‚ºè©²æ­é…æä¾›ã€Œæ¢ä»¶æ©Ÿç‡ P(w_n | context)ã€ã€ã€Œç²¾ç°¡ä¾‹å¥ (example)ã€ã€ã€Œå›°æƒ‘åº¦ (ppl)ã€å’Œã€ŒIELTS Cohesion & Coherence Band è©•ä¼°ã€ã€‚
4. ã€PPL-Band æ˜ å°„ã€‘: PPL 0â€“20=Band 9, 21â€“40=Band 8, 41â€“60=Band 7, 61â€“80=Band 6, >80=Band 5ã€‚
5. ã€é‡é»ã€‘ä¾‹å¥ä¸­ï¼Œé æ¸¬çš„è©å½™å¿…é ˆã€Œç·Šå¯†ä¸”å”¯ä¸€åœ°ã€ç·Šæ¥åœ¨ä¸Šä¸‹æ–‡çš„ã€Œæœ€å¾Œä¸€å€‹å­—ã€ä¹‹å¾Œã€‚å¦‚æœä½¿ç”¨è€…è¼¸å…¥ç‰‡èªçš„æœ€å¾Œä¸€å€‹å­—æ˜¯æ¨™é»ç¬¦è™Ÿï¼ˆä¾‹å¦‚ï¼šå¥è™Ÿ .ã€é€—è™Ÿ ,ã€å•è™Ÿ ?ã€å†’è™Ÿ :ã€åˆ†è™Ÿ ; ç­‰ï¼‰ï¼Œå‰‡é æ¸¬çš„è©å½™å¿…é ˆåœ¨æ¨™ç‚¹ç¬¦è™Ÿä¹‹å¾Œã€Œç·Šå¯†ä¸”å”¯ä¸€åœ°ã€ä»¥ä¸€å€‹ç©ºæ ¼éš”é–‹**ã€‚**
6. æ¯æ¬¡ä¾‹å¥ç”Ÿæˆæ¨¡æ“¬åŸ·è¡Œä¸‰è¼ª Self-Consistency æ¡æ¨£ï¼Œä»¥ç¢ºä¿èªç¾©ç©©å®šæ€§ã€‚
7. ç‚ºæ¯æ¬¡ç”Ÿæˆæä¾›ã€Œä¸€è‡´æ€§åˆ†æ•¸ (consistency_score)ã€(0-100)ï¼ŒåŸºæ–¼èªç¾©ç›¸ä¼¼åº¦ã€è©å½™è®Šç•°åº¦ã€å¥æ³•ç©©å®šæ€§è¨ˆç®—ã€‚
8. ã€Grammar Validation Layer (æœ€æ–°è¦æ ¼)ã€‘: **é€™æ˜¯æœ€é‡è¦çš„æ­¥é©Ÿ**ã€‚å°ç”Ÿæˆçš„ 'example' åŸ·è¡Œåš´æ ¼çš„æ–‡æ³•é©—è­‰ï¼Œä¸¦å¡«å…¥ 'grammar_validation' ç‰©ä»¶ã€‚
    a. ã€I. æ­£ç¢ºæ€§ (Strict Correctness)ã€‘: åš´æ ¼åŸ·è¡Œæ­¤éƒ¨åˆ†çš„æª¢æŸ¥ã€‚'correctness.errors' é™£åˆ—ã€Œå¿…é ˆã€åŒ…å«æ‰€æœ‰åµæ¸¬åˆ°çš„éŒ¯èª¤ã€‚**é€™åŒ…æ‹¬æœ€å¾®å°çš„éŒ¯èª¤ï¼ˆä¾‹å¦‚å† è©ã€å–®è¤‡æ•¸ã€æ¨™é»ç¬¦è™Ÿï¼‰**ã€‚å¦‚æœæ²’æœ‰éŒ¯èª¤ï¼Œå¿…é ˆè¿”å›ç©ºé™£åˆ— []ã€‚
        - æ ¸å¿ƒæ–‡æ³•: ä¸»è¬‚ä¸€è‡´, åŸºç¤æ™‚æ…‹éŒ¯èª¤, ä»£åè©æ ¼ä½, å† è©éŒ¯èª¤,å–®è¤‡è©ã€‚
        - è¤‡é›œæ–‡æ³•: æ‡¸å‚ä¿®é£¾èª, æ™‚æ…‹è½‰æ›ä¸ä¸€è‡´, ä¸å®Œæ•´æ¯”è¼ƒ, é›™é‡å¦å®šã€‚
        - æ‹¼å¯«: åŸºç¤æ‹¼å¯«, èªå¢ƒæ‹¼å¯« (there/their), å¤§å°å¯«/æ•¸å­—æ ¼å¼, é€£å­—ç¬¦ã€‚
        
		
    b. ã€II. æ¸…æ™°åº¦ (Clarity)ã€‘: æä¾›ã€Œå»ºè­°ã€ã€‚
        - çµæ§‹: æª¢æŸ¥ æµæ°´å¥, ç‰‡æ®µå¥ã€‚
        - å„ªåŒ–: æä¾› ç°¡æ½”æ€§å»ºè­° (è´…è©), åµæ¸¬ éåº¦ä½¿ç”¨è¢«å‹•èªæ…‹, ä¸¦åœ¨éœ€è¦æ™‚æä¾› å®Œæ•´å¥å­é‡å¯« (rewrite_suggestion) æˆ– èªè¨€æµæš¢åº¦ (feedback) å»ºè­°ã€‚
    c. ã€III. åƒèˆ‡åº¦ (Engagement)ã€‘: æä¾›ã€Œå»ºè­°ã€ã€‚
        - è©å½™: é€é 'vocab_suggestions' å»ºè­°æ›¿æ› éåº¦ä½¿ç”¨æˆ–ä¹å‘³ çš„è©å½™ã€‚
        - çµæ§‹: é€é 'feedback' æé†’ å¥å­å¤šæ¨£æ€§ æˆ– å…§å®¹é‡è¤‡ çš„å•é¡Œã€‚
    d. ã€IV. å‚³éæ€§ (Delivery)ã€‘: (ç¶­æŒåŸæ¨™æº–) åµæ¸¬ 'detected_tone', 'formality' (e.g., 'æ­£å¼')ï¼Œä¸¦æª¢æŸ¥ 'inclusive_language_warning'ã€‚
9. ã€è‹±æ–‡å¥å­å®šç¾©ã€‘ï¼š**ä¸€å€‹å®Œæ•´çš„è‹±æ–‡å¥å­å¿…é ˆåŒ…å«ä¸»è©å’Œè¿°èªï¼Œè¡¨é”ä¸€å€‹å®Œæ•´çš„æ„æ€ï¼ˆç¨ç«‹å­å¥ï¼‰ï¼Œä¸”å¥é¦–å¤§å¯«ï¼Œå¥å°¾ä»¥å¥é»ã€å•è™Ÿæˆ–é©šå˜†è™Ÿä½œçµã€‚**
10. åƒ…ä»¥è¦æ±‚çš„ JSON æ ¼å¼ç‰©ä»¶ (Object) è¼¸å‡ºã€‚`;

            const userQuery = `
ä¸Šä¸‹æ–‡ (åƒ…ä½¿ç”¨æœ€å¾Œ ${contextLen} è©): "${truncatedPhrase}"
è‡ªå®šè©å½™: "${customWord}"
å¯«ä½œä»»å‹™: "${taskContext}"
æ¡æ¨£åƒæ•¸ (T=${temp}, TopP=${topP})
`;

            const result = await callGeminiAPI(systemPrompt, userQuery, customSchema, temp, topP);

            // æ¢å¾© UI
            customLoading.classList.add('hidden');
            customButton.disabled = false;
            customButtonText.textContent = "Check Word";

            if (result.isError) {
                customResults.innerHTML = `<p class="text-red-400">é©—è­‰å¤±æ•—: ${result.message}</p>`;
            } else if (result.band !== undefined) {
                // ç²å– Band è³‡è¨Š (é›–ç„¶æ¨¡å‹å·²è¿”å›ï¼Œä½†æˆ‘å€‘ä½¿ç”¨æœ¬åœ°å‡½æ•¸ä¾†æ¨™æº–åŒ–é¡è‰²)
                const bandInfo = getCohesionBandDetails(result.ppl);
                
                // v3.0 æ›´æ–°: é¡¯ç¤º Grammar Validation Layer
                customResults.innerHTML = `
                    <div class="bg-gray-700 p-4 rounded-lg border border-yellow-500/50 space-y-2">
                        <div class="flex items-center justify-between">
                            <h4 class="text-lg font-bold text-yellow-300">è‡ªå®šè©å½™ï¼š${customWord}</h4>
                            <span class="band-tag ${bandInfo.color} text-white">Band ${bandInfo.band}</span>
                        </div>
                        <p class="text-sm text-gray-400">${result.band_summary}</p>
                        <hr class="border-gray-600">
                        <div class="grid grid-cols-3 text-sm text-gray-300">
                            <p><strong>P(wâ‚™|context):</strong> <span class="text-yellow-300">${result.p_w_n.toFixed(4)}</span></p>
                            <p><strong>PPL:</strong> <span class="text-yellow-300">${result.ppl.toFixed(2)}</span></p>
                            <p><strong>Consistency:</strong> <span class="text-yellow-300">${result.consistency_score}</span></p>
                        </div>
                        <div class="bg-gray-600 p-3 rounded-md text-gray-200 mt-2">
                            ${highlight(result.example, fullPhrase)}
                        </div>
                        <!-- v3.0 Grammar Validation Layer æ³¨å…¥é» -->
                        ${renderGrammarValidation(result.grammar_validation)}
                    </div>
                `;
            } else {
                customResults.innerHTML = `<p class="text-red-400">æ”¶åˆ°éé æœŸçš„å›æ‡‰æ ¼å¼ã€‚</p>`;
            }
        }


        // v3.0: æ›´æ–°é¡¯ç¤ºé æ¸¬çµæœ
        function displayPredictionResults(results, inputPhrase) {
            if (results.length === 0) {
                predictionResults.innerHTML = `<p class="text-gray-400 md:col-span-2 text-center">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é æ¸¬è©å½™ã€‚</p>`;
                return;
            }

            results.forEach((item, index) => {
                const fullPhrase = `${inputPhrase} ${item.word}`;
                // ä½¿ç”¨æœ¬åœ°å‡½æ•¸ç²å–é¡è‰²
                const bandInfo = getCohesionBandDetails(item.ppl);

                // v3.0 æ›´æ–°: è™•ç† consistency ç‹€æ…‹
                const consistencyStatus = item.consistency_score >= 85 ? 'Stable' : 'Check';

                const card = document.createElement('div');
                card.className = 'bg-gray-800 p-5 rounded-lg shadow-lg border border-gray-700 space-y-3';
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-bold text-white">${index + 1}. ${item.word}</h3>
                        <span class="band-tag ${bandInfo.color} text-white">Band ${bandInfo.band}</span>
                    </div>
                    
                    <p class="text-sm text-gray-400">${item.band_summary}</p>

                    <div class="grid grid-cols-2 text-sm text-gray-300 border-b border-gray-700 pb-3">
                        <p><strong>P(wâ‚™|context):</strong> <span class="text-blue-300">${item.p_w_n.toFixed(4)}</span></p>
                        <p><strong>PPL:</strong> <span class="text-blue-300">${item.ppl.toFixed(2)}</span></p>
                    </div>

                    <div id="example-container-${index}" class="bg-gray-700 p-3 rounded-md text-gray-200">
                        ${highlight(item.example, fullPhrase)}
                    </div>
                    <!-- v3.0 æ›´æ–°: é¡¯ç¤º Consistency å’Œ Grammar Validation Layer -->
                    <div id="metrics-container-${index}" class="text-xs text-gray-400 text-right mt-1 space-y-1">
                        <div>Consistency: ${item.consistency_score} (${consistencyStatus})</div>
                    </div>
                    <!-- v3.0 Grammar Validation Layer æ³¨å…¥é» -->
                    <div id="grammar-validation-${index}">
                        ${renderGrammarValidation(item.grammar_validation)}
                    </div>
                    
                    <!-- Band Control Regeneration -->
                    <div class="flex gap-2 pt-2">
                        <select id="band-select-${index}" class="w-1/2 bg-gray-600 border border-gray-500 rounded-md p-2 text-sm text-white focus:ring-1 focus:ring-blue-500">
                            <option value="9">Band 9</option>
                            <option value="8">Band 8</option>
                            <option value="7">Band 7</option>
                            <option value="6">Band 6</option>
                            <option value="5">Band 5</option>
                        </select>
                        <button class="regen-button w-1/2 bg-gray-500 hover:bg-gray-400 text-white text-sm font-medium py-2 px-3 rounded-lg transition-colors duration-200 flex items-center justify-center gap-1 disabled:opacity-50"
                                data-index="${index}"
                                data-context="${inputPhrase}"
                                data-word="${item.word}"
                                data-type="prediction">
                            <span class="regen-text">ğŸ”„ é‡æ–°ç”Ÿæˆ</span>
                            <div class="spinner regen-loading hidden"></div>
                        </button>
                    </div>
                `;
                predictionResults.appendChild(card);
            });
        }
        
        // çµ±ä¸€çš„ UI ç‹€æ…‹è¼”åŠ©å‡½æ•¸
        function displayLoading(errorEl, loadingEl, buttonEl, textEl, message) {
            errorEl.classList.add('hidden'); // v2.6: ä¿æŒéš±è—ä¸»éŒ¯èª¤
            loadingEl.classList.remove('hidden');
            buttonEl.disabled = true;
            textEl.textContent = message;
        }

        function displayDone(loadingEl, buttonEl, textEl, message) {
            loadingEl.classList.add('hidden');
            buttonEl.disabled = false;
            textEl.textContent = message;
        }

        function displayError(errorEl, message, loadingEl = null, buttonEl = null, textEl = null, buttonMessage = null) {
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
            if (loadingEl) displayDone(loadingEl, buttonEl, textEl, buttonMessage);
        }

        // v3.0: æ›´æ–° regenSchema
        const regenSchema = {
            type: "OBJECT",
            properties: {
                "example": { "type": "STRING", "description": "æ–°ç”Ÿæˆçš„ä¾‹å¥, $\le 25$ è©" },
                "consistency_score": { "type": "NUMBER", "description": "æ–°ä¾‹å¥çš„èªç¾©ä¸€è‡´æ€§åˆ†æ•¸ (0-100)" },
                "grammar_validation": grammarValidationSchemaObject // v3.0 æ›¿æ›
            },
            required: ["example", "consistency_score", "grammar_validation"] // v3.0 æ›¿æ›
        };

        // çµ±ä¸€çš„ä¾‹å¥é‡æ–°ç”Ÿæˆé‚è¼¯ (Prediction & Validation å…±ç”¨)
        async function handleRegeneration(button, band, context, word, type) {
            const index = button.dataset.index;
            const fullPhrase = type === 'prediction' ? `${context} ${word}` : context; // Validation case: context is the full phrase
            
            const exampleContainer = document.getElementById(type === 'prediction' ? `example-container-${index}` : `val-example-container`);
            const regenText = button.querySelector('.regen-text');
            const regenLoading = button.querySelector('.regen-loading');

            // T1.8 Fix: æª¢æŸ¥é€™æ˜¯å¦ç‚ºè‡ªå‹•é‡è©¦
            const isAutoRetry = button.dataset.isAutoRetry === 'true';

            // è¨­ç½® UI ç‚ºè¼‰å…¥ä¸­
            button.disabled = true;
            regenText.classList.add('hidden');
            regenLoading.classList.remove('hidden');
            // T1.8 Fix: æ›´æ–°è¼‰å…¥è¨Šæ¯
            exampleContainer.innerHTML = `<span class="text-gray-400">æ­£åœ¨ç”Ÿæˆ Band ${band} ä¾‹å¥... ${isAutoRetry ? '(è‡ªå‹•å›æº¯é‡è©¦...)' : '(Self-Consistency 3x)'}</span>`;

            // ç²å– Consistency Manager åƒæ•¸
            const temp = predTemp.value;
            const topP = predTopP.value;

            // æº–å‚™ API è«‹æ±‚
            const bandRules = `Band ${band} - è©å½™èˆ‡å¥å¼ç‰¹å¾: ${type === 'prediction' ? 'Cohesion & Coherence' : 'Lexical Resource'}ã€‚`;
            
            // v3.0 (ä½¿ç”¨è€…è‡ªè¨‚) æ›´æ–°: åš´æ ¼å¯¦ä½œ Grammar Validation Layer
            const systemPrompt = `ä½ æ˜¯ä¸€å€‹ IELTS å¯«ä½œåŠ©æ•™ã€‚ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šä½¿ç”¨è€…æŒ‡å®šçš„ã€Œå®Œæ•´æ­é…ç‰‡èªã€å’Œã€Œç›®æ¨™ Bandã€ï¼Œç”Ÿæˆä¸€å€‹ã€Œå–®ä¸€ã€ç²¾ç°¡ï¼ˆæœ€å¤š 25 è©ï¼‰ã€çš„ä¾‹å¥ã€‚
åŸå‰‡ï¼š
1. ã€**çµ•å°è¦å‰‡**ã€‘: ä½ ç”Ÿæˆçš„ã€Œæ‰€æœ‰ã€'example' å¥å­å¿…é ˆæ»¿è¶³ä¸‹é¢ç¬¬ 9 é»**è‹±æ–‡å¥å­å®šç¾©**è€Œä¸”éƒ½ã€Œ**å¿…é ˆ**ã€ç¶“éä¸‹é¢ç¬¬ 8 é» GVL (Grammar Validation Layer) çš„ã€Œ**å¾¹åº•ä¸”åš´æ ¼**ã€çš„æª¢æŸ¥ã€‚**æ­¤æª¢æŸ¥æ˜¯å¼·åˆ¶æ€§çš„ï¼Œä¸å¾—è·³éæˆ–æ•·è¡**ã€‚
2. **èªç¾©ä¸€è‡´æ€§ ($\ge 0.9$):** æ–°ç”Ÿæˆçš„ä¾‹å¥å¿…é ˆèˆ‡ç•¶å‰ä¾‹å¥èªç¾©ä¿æŒé«˜åº¦ä¸€è‡´ï¼Œå·®ç•°åƒ…åœ¨æ–¼å¥æ³•çµæ§‹å’Œè©å½™é¸æ“‡ã€‚
3. **Band éµå¾ª:** ä¾‹å¥å¿…é ˆåš´æ ¼ç¬¦åˆç›®æ¨™ Band (${band}) çš„èªæ³•è¤‡é›œåº¦ã€é€£è²«æ€§èˆ‡è©å½™å¯†åº¦è¦æ±‚ã€‚
4. **æ­é…å®Œæ•´:** ç¢ºä¿ä¾‹å¥ä¸­åŒ…å«å®Œæ•´çš„æ­é…ã€Œ${fullPhrase}ã€ã€‚
5. **é€£çºŒæ€§:** ç¢ºä¿æ­é…ä¸­çš„è©å½™æ˜¯é€£çºŒä¸”ä¸è¢«æ¨™é»ç¬¦è™Ÿåˆ†éš”ã€‚
6. **Self-Consistency:** æ¨¡æ“¬åŸ·è¡Œä¸‰è¼ª Self-Consistency æ¡æ¨£ï¼Œä»¥ç¢ºä¿è¼¸å‡ºçš„ç©©å®šæ€§ã€‚
7. è¼¸å‡ºã€Œä¸€è‡´æ€§åˆ†æ•¸ (consistency_score)ã€(0-100)ï¼ŒåŸºæ–¼èªç¾©ç›¸ä¼¼åº¦ã€è©å½™è®Šç•°åº¦ã€å¥æ³•ç©©å®šæ€§è¨ˆç®—ã€‚
8. ã€Grammar Validation Layer (æœ€æ–°è¦æ ¼)ã€‘: **é€™æ˜¯æœ€é‡è¦çš„æ­¥é©Ÿ**ã€‚å°ç”Ÿæˆçš„ 'example' åŸ·è¡Œåš´æ ¼çš„æ–‡æ³•é©—è­‰ï¼Œä¸¦å¡«å…¥ 'grammar_validation' ç‰©ä»¶ã€‚
    a. ã€I. æ­£ç¢ºæ€§ (Strict Correctness)ã€‘: åš´æ ¼åŸ·è¡Œæ­¤éƒ¨åˆ†çš„æª¢æŸ¥ã€‚'correctness.errors' é™£åˆ—ã€Œå¿…é ˆã€åŒ…å«æ‰€æœ‰åµæ¸¬åˆ°çš„éŒ¯èª¤ã€‚**é€™åŒ…æ‹¬æœ€å¾®å°çš„éŒ¯èª¤ï¼ˆä¾‹å¦‚å† è©ã€å–®è¤‡æ•¸ã€æ¨™é»ç¬¦è™Ÿï¼‰**ã€‚å¦‚æœæ²’æœ‰éŒ¯èª¤ï¼Œå¿…é ˆè¿”å›ç©ºé™£åˆ— []ã€‚
        - æ ¸å¿ƒæ–‡æ³•: ä¸»è¬‚ä¸€è‡´, åŸºç¤æ™‚æ…‹éŒ¯èª¤, ä»£åè©æ ¼ä½, å† è©éŒ¯èª¤,å–®è¤‡è©ã€‚
        - è¤‡é›œæ–‡æ³•: æ‡¸å‚ä¿®é£¾èª, æ™‚æ…‹è½‰æ›ä¸ä¸€è‡´, ä¸å®Œæ•´æ¯”è¼ƒ, é›™é‡å¦å®šã€‚
        - æ‹¼å¯«: åŸºç¤æ‹¼å¯«, èªå¢ƒæ‹¼å¯« (there/their), å¤§å°å¯«/æ•¸å­—æ ¼å¼, é€£å­—ç¬¦ã€‚
        - æ¨™é»: åŸºç¤æ¨™é» (å¥å°¾), é€²éšæ¨™é» (é€—è™Ÿ, åˆ†è™Ÿ, å†’è™Ÿ)ã€‚
		
    b. ã€II. æ¸…æ™°åº¦ (Clarity)ã€‘: æä¾›ã€Œå»ºè­°ã€ã€‚
        - çµæ§‹: æª¢æŸ¥ æµæ°´å¥, ç‰‡æ®µå¥ã€‚
        - å„ªåŒ–: æä¾› ç°¡æ½”æ€§å»ºè­° (è´…è©), åµæ¸¬ éåº¦ä½¿ç”¨è¢«å‹•èªæ…‹, ä¸¦åœ¨éœ€è¦æ™‚æä¾› å®Œæ•´å¥å­é‡å¯« (rewrite_suggestion) æˆ– èªè¨€æµæš¢åº¦ (feedback) å»ºè­°ã€‚
    c. ã€III. åƒèˆ‡åº¦ (Engagement)ã€‘: æä¾›ã€Œå»ºè­°ã€ã€‚
        - è©å½™: é€é 'vocab_suggestions' å»ºè­°æ›¿æ› éåº¦ä½¿ç”¨æˆ–ä¹å‘³ çš„è©å½™ã€‚
        - çµæ§‹: é€é 'feedback' æé†’ å¥å­å¤šæ¨£æ€§ æˆ– å…§å®¹é‡è¤‡ çš„å•é¡Œã€‚
    d. ã€IV. å‚³éæ€§ (Delivery)ã€‘: (ç¶­æŒåŸæ¨™æº–) åµæ¸¬ 'detected_tone', 'formality' (e.g., 'æ­£å¼')ï¼Œä¸¦æª¢æŸ¥ 'inclusive_language_warning'ã€‚
9. ã€è‹±æ–‡å¥å­å®šç¾©ã€‘ï¼š**ä¸€å€‹å®Œæ•´çš„è‹±æ–‡å¥å­å¿…é ˆåŒ…å«ä¸»è©å’Œè¿°èªï¼Œè¡¨é”ä¸€å€‹å®Œæ•´çš„æ„æ€ï¼ˆç¨ç«‹å­å¥ï¼‰ï¼Œä¸”å¥é¦–å¤§å¯«ï¼Œå¥å°¾ä»¥å¥é»ã€å•è™Ÿæˆ–é©šå˜†è™Ÿä½œçµã€‚**
10. åƒ…ä»¥è¦æ±‚çš„ JSON æ ¼å¼ç‰©ä»¶ (Object) è¼¸å‡ºã€‚`;

            const userQuery = `
å®Œæ•´æ­é…ç‰‡èª: "${fullPhrase}"
ç›®æ¨™ Band: ${band}
Band è¦å‰‡: ${bandRules}
æ¡æ¨£åƒæ•¸ (T=${temp}, TopP=${topP})
`;

            // å‘¼å« API
            const result = await callGeminiAPI(systemPrompt, userQuery, regenSchema, temp, topP);

            // æ¢å¾© UI (åœ¨ T1.8 æª¢æŸ¥å‰å…ˆæ¢å¾©ï¼Œä»¥å…æŒ‰éˆ•å¡ä½)
            button.disabled = false;
            regenText.classList.remove('hidden');
            regenLoading.classList.add('hidden');

            // é¡¯ç¤ºçµæœ
            if (result.isError) {
                exampleContainer.innerHTML = `<span class="text-red-400">ç”Ÿæˆå¤±æ•—: ${result.message || 'æœªçŸ¥éŒ¯èª¤'}</span>`;
            } else if (result.example && result.consistency_score !== undefined && result.grammar_validation) {
                
                // T1.8 / T2.8 Fix: å„²å­˜æ­·å²ç´€éŒ„
                const historyKey = `${type}-${index}`;
                if (!regenerationHistory[historyKey]) {
                    regenerationHistory[historyKey] = [];
                }
                regenerationHistory[historyKey].push(result.consistency_score);
                if (regenerationHistory[historyKey].length > 5) { // ä¿ç•™æœ€è¿‘ 5 æ¬¡
                    regenerationHistory[historyKey].shift();
                }

                // T1.8 / T2.8 Fix: Semantic Traceback æ¨¡æ“¬
                // å¦‚æœåˆ†æ•¸ä½ï¼Œä¸”é€™ä¸æ˜¯ä¸€æ¬¡è‡ªå‹•é‡è©¦
                if (result.consistency_score < 85 && !isAutoRetry) {
                    console.warn(`Semantic Traceback (T1.8) è§¸ç™¼æ–¼ ${historyKey}. åˆ†æ•¸: ${result.consistency_score}. è‡ªå‹•é‡è©¦ä¸­...`);
                    
                    // v3.0 æ›´æ–°: æŠ“å– metrics container
                    const metricsContainer = document.getElementById(type === 'prediction' ? `metrics-container-${index}` : `val-metrics-container`);
                    if (metricsContainer) {
                        metricsContainer.innerHTML = `
                            <div>Consistency: ${result.consistency_score} (<span class="text-yellow-400">ä½åˆ†! è‡ªå‹•å›æº¯é‡è©¦...</span>)</div>
                        `;
                    }
                    // v3.0 æ›´æ–°: æŠ“å– grammar container
                    const grammarContainer = document.getElementById(type === 'prediction' ? `grammar-validation-${index}` : `val-grammar-validation`);
                    if (grammarContainer) {
                        grammarContainer.innerHTML = renderGrammarValidation(result.grammar_validation);
                    }


                    // æ¨™è¨˜ä¸¦é‡è©¦ä¸€æ¬¡
                    button.dataset.isAutoRetry = 'true';
                    await handleRegeneration(button, band, context, word, type);
                    
                    // é‡è©¦å¾Œï¼Œæ¸…é™¤æ¨™è¨˜ä¸¦é€€å‡º
                    button.dataset.isAutoRetry = 'false';
                    return; // çµ‚æ­¢æ­¤å‡½æ•¸ï¼Œé˜²æ­¢é¡¯ç¤ºä½åˆ†çµæœ
                }

                // --- æ­£å¸¸é¡¯ç¤ºçµæœ (åˆ†æ•¸ $\ge$ 85 æˆ–å·²é‡è©¦é) ---
                
                // æ›´æ–°ä¾‹å¥
                exampleContainer.innerHTML = highlight(result.example, fullPhrase);
                
                // v3.0 æ›´æ–°: æ›´æ–° metrics container
                const metricsContainer = document.getElementById(type === 'prediction' ? `metrics-container-${index}` : `val-metrics-container`);
                if (metricsContainer) {
                    const consistencyStatus = result.consistency_score >= 85 ? 'Stable' : 'Check';
                    metricsContainer.innerHTML = `
                        <div>Consistency: ${result.consistency_score} (${consistencyStatus})</div>
                    `;
                }
                // v3.0 æ›´æ–°: æ›´æ–° grammar container
                const grammarContainer = document.getElementById(type === 'prediction' ? `grammar-validation-${index}` : `val-grammar-validation`);
                if (grammarContainer) {
                    grammarContainer.innerHTML = renderGrammarValidation(result.grammar_validation);
                }
            } else {
                exampleContainer.innerHTML = `<span class="text-red-400">ç”Ÿæˆå¤±æ•—: æ”¶åˆ°éé æœŸçš„å›æ‡‰æ ¼å¼ (ç¼ºå°‘ grammar_validation)ã€‚</span>`;
            }
        }

        // é æ¸¬çµæœå€åŸŸçš„äº‹ä»¶å§”æ´¾ (é‡æ–°ç”Ÿæˆ)
        predictionResults.addEventListener('click', async function(e) {
            const button = e.target.closest('.regen-button');
            if (!button || button.dataset.type !== 'prediction') return;

            e.preventDefault();
            const index = button.dataset.index;
            // T1.4 Fix: ç¢ºä¿å‚³éæˆªæ–·å¾Œçš„ context
            const context = truncateContext(button.dataset.context, predContextLen.value);
            const word = button.dataset.word;
            
            const bandSelect = document.getElementById(`band-select-${index}`);
            const band = bandSelect.value;
            
            await handleRegeneration(button, band, context, word, 'prediction');
        });

        // --- Validation Tab é‚è¼¯ ---

        // v3.0: æ›´æ–° validationSchema
        const validationSchema = {
            type: "OBJECT",
            properties: {
                "Fpm": { "type": "NUMBER", "description": "è©²ç‰‡èªåœ¨èªæ–™åº«ä¸­æ¯ç™¾è¬è©çš„å‡ºç¾é »ç‡ (Per Million)" },
                "MI": { "type": "NUMBER", "description": "äº’è³‡è¨Šå€¼ (Mutual Information)" },
                "L_acc_norm": { "type": "NUMBER", "description": "èªè¨€å­¸æº–ç¢ºåº¦ (1.0 = æ­£ç¢º; 0.5 = å°éŒ¯; 0.0 = éŒ¯èª¤)" },
                "example": { "type": "STRING", "description": "ä¸è¶…é 25 å€‹è©çš„ä¾‹å¥" },
                "grammarCheck": { "type": "STRING", "description": "èªæ³•é©—è­‰çµæœçš„ç°¡çŸ­èªªæ˜ (æ‡‰èˆ‡ L_acc_norm ä¸€è‡´)" },
                "spellingSuggestion": { "type": "STRING", "description": "æ‹¼å¯«ä¿®æ­£å»ºè­°æˆ–æ›¿ä»£æ­é…å»ºè­° (è‹¥ç„¡å‰‡ç‚ºç©ºå­—ä¸²)" },
                "consistency_score": { "type": "NUMBER", "description": "ç¯„ä¾‹å¥çš„èªç¾©ä¸€è‡´æ€§åˆ†æ•¸ (0-100)" },
                "example_grammar_validation": grammarValidationSchemaObject // v3.0 æ›¿æ›
            },
            required: ["Fpm", "MI", "L_acc_norm", "example", "grammarCheck", "spellingSuggestion", "consistency_score", "example_grammar_validation"] // v3.0 æ›¿æ›
        };

        async function handleValidationSubmit(e) {
            e.preventDefault();
            const phrase1 = valInput1.value.trim();
            const phrase2 = valInput2.value.trim();
            const fullPhrase = `${phrase1} ${phrase2}`.trim();

            // v2.6 IGPVL æ•´åˆ: æ¸…ç©ºèˆŠè¨Šæ¯
            igpvlValError.innerHTML = '';
            igpvlValError.className = 'text-sm rounded-lg';
            valError.classList.add('hidden'); // éš±è—èˆŠçš„ç”ŸæˆéŒ¯èª¤
            validationResults.classList.add('hidden');
            validationResults.innerHTML = '';

            if (!phrase1 || !phrase2) {
                displayError(valError, "è«‹è¼¸å…¥åˆå§‹ç‰‡èªå’Œç›®æ¨™è©å½™ã€‚", valLoading, valButton, valButtonText, "é©—è­‰æ­é… (Validate Collocation)");
                return;
            }

            // è¨­ç½® UI ç‚ºè¼‰å…¥ä¸­ (v2.6: åœ¨ IGPVL ä¹‹å‰)
            displayLoading(valError, valLoading, valButton, valButtonText, "1/2 æ­£åœ¨é©—è­‰è¼¸å…¥...");

            // --- v2.6 IGPVL åŸ·è¡Œ ---
            const igpvlResult = await validateInputGrammar(fullPhrase, 'valInput', 'academic');
            const isBlocked = displayIgpvlFeedback(igpvlValError, igpvlResult);

            if (isBlocked) {
                displayDone(valLoading, valButton, valButtonText, "é©—è­‰æ­é… (Validate Collocation)");
                return; // åœæ­¢åŸ·è¡Œ
            }
            // --- IGPVL çµæŸ ---

            // è¨­ç½® UI ç‚ºè¼‰å…¥ä¸­ (v2.6: æ›´æ–°ç‹€æ…‹)
            displayLoading(valError, valLoading, valButton, valButtonText, "2/2 æ­£åœ¨é©—è­‰...");
            
            // S_Naturalness v3.0 (ä½¿ç”¨è€…è‡ªè¨‚) ä¿®æ­£ç‰ˆ System Prompt
            const systemPrompt = `ä½ æ˜¯ä¸€å€‹ IELTS å¯«ä½œåŠ©æ•™ã€‚ä½ çš„ä»»å‹™æ˜¯è©•ä¼°ä½¿ç”¨è€…æä¾›çš„ã€Œå®Œæ•´æ­é…ç‰‡èªã€çš„è‡ªç„¶åº¦èˆ‡æ­£ç¢ºæ€§ï¼Œä¸¦æä¾›è¨ˆç®— S_Naturalness æ‰€éœ€çš„åŸå§‹æ•¸æ“šã€‚
è¦å‰‡ï¼š
1. ã€**çµ•å°è¦å‰‡**ã€‘: ä½ ç”Ÿæˆçš„ã€Œæ‰€æœ‰ã€'example' å¥å­å¿…é ˆæ»¿è¶³ä¸‹é¢ç¬¬ 10 é»**è‹±æ–‡å¥å­å®šç¾©**è€Œä¸”éƒ½ã€Œ**å¿…é ˆ**ã€ç¶“éä¸‹é¢ç¬¬ 9 é» GVL (Grammar Validation Layer) çš„ã€Œ**å¾¹åº•ä¸”åš´æ ¼**ã€çš„æª¢æŸ¥ã€‚**æ­¤æª¢æŸ¥æ˜¯å¼·åˆ¶æ€§çš„ï¼Œä¸å¾—è·³éæˆ–æ•·è¡**ã€‚
2. æä¾›ã€ŒFpmã€ (è©²ç‰‡èªåœ¨èªæ–™åº«ä¸­æ¯ç™¾è¬è©çš„å‡ºç¾é »ç‡)ã€‚
3. æä¾›ã€ŒMIã€ (äº’è³‡è¨Šå€¼)ã€‚
4. æ ¹æ“šèªæ³•èˆ‡è©å½¢æ­£ç¢ºæ€§ï¼Œæä¾›ã€ŒL_acc_normã€ (èªè¨€å­¸æº–ç¢ºåº¦åˆ†æ•¸ï¼š1.0 = å®Œå…¨æ­£ç¢º, 0.5 = å¯ç†è§£ä½†æœ‰å°éŒ¯, 0.0 = åš´é‡éŒ¯èª¤)ã€‚
5. æä¾›ä¸€å€‹ã€Œç²¾ç°¡ä¾‹å¥ (example)ã€ï¼ˆæœ€å¤š 25 è©ï¼‰ã€‚
6. æä¾›ã€Œèªæ³•é©—è­‰ (grammarCheck)ã€çš„ç°¡çŸ­çµæœ (é€™æ‡‰èˆ‡ L_acc_norm ä¸€è‡´)ã€‚
7. å¦‚æœæ­é…ä¸è‡ªç„¶æˆ–æœ‰æ˜é¡¯æ‹¼å¯«éŒ¯èª¤ï¼Œæä¾›ã€Œæ›¿ä»£æ­é… (spellingSuggestion)ã€æˆ–ä¿®æ­£å»ºè­°ï¼›è‹¥ç„¡ï¼Œå‰‡è¿”å›ç©ºå­—ä¸²ã€‚
8. ç‚º 'example' æä¾›ã€Œä¸€è‡´æ€§åˆ†æ•¸ (consistency_score)ã€(0-100)ã€‚
9. ã€Grammar Validation Layer (æœ€æ–°è¦æ ¼)ã€‘: **é€™æ˜¯æœ€é‡è¦çš„æ­¥é©Ÿ**ã€‚å°ç”Ÿæˆçš„ 'example' åŸ·è¡Œåš´æ ¼çš„æ–‡æ³•é©—è­‰ï¼Œä¸¦å¡«å…¥ 'example_grammar_validation' ç‰©ä»¶ã€‚
    a. ã€I. æ­£ç¢ºæ€§ (Strict Correctness)ã€‘: åš´æ ¼åŸ·è¡Œæ­¤éƒ¨åˆ†çš„æª¢æŸ¥ã€‚'correctness.errors' é™£åˆ—ã€Œå¿…é ˆã€åŒ…å«æ‰€æœ‰åµæ¸¬åˆ°çš„éŒ¯èª¤ã€‚**é€™åŒ…æ‹¬æœ€å¾®å°çš„éŒ¯èª¤ï¼ˆä¾‹å¦‚å† è©ã€å–®è¤‡æ•¸ã€æ¨™é»ç¬¦è™Ÿï¼‰**ã€‚å¦‚æœæ²’æœ‰éŒ¯èª¤ï¼Œå¿…é ˆè¿”å›ç©ºé™£åˆ— []ã€‚
        - æ ¸å¿ƒæ–‡æ³•: ä¸»è¬‚ä¸€è‡´, åŸºç¤æ™‚æ…‹éŒ¯èª¤, ä»£åè©æ ¼ä½, å† è©éŒ¯èª¤,å–®è¤‡è©ã€‚
        - è¤‡é›œæ–‡æ³•: æ‡¸å‚ä¿®é£¾èª, æ™‚æ…‹è½‰æ›ä¸ä¸€è‡´, ä¸å®Œæ•´æ¯”è¼ƒ, é›™é‡å¦å®šã€‚
        - æ‹¼å¯«: åŸºç¤æ‹¼å¯«, èªå¢ƒæ‹¼å¯« (there/their), å¤§å°å¯«/æ•¸å­—æ ¼å¼, é€£å­—ç¬¦ã€‚
        - æ¨™é»: åŸºç¤æ¨™é» (å¥å°¾), é€²éšæ¨™é» (é€—è™Ÿ, åˆ†è™Ÿ, å†’è™Ÿ)ã€‚
		
    b. ã€II. æ¸…æ™°åº¦ (Clarity)ã€‘: æä¾›ã€Œå»ºè­°ã€ã€‚
        - çµæ§‹: æª¢æŸ¥ æµæ°´å¥, ç‰‡æ®µå¥ã€‚
        - å„ªåŒ–: æä¾› ç°¡æ½”æ€§å»ºè­° (è´…è©), åµæ¸¬ éåº¦ä½¿ç”¨è¢«å‹•èªæ…‹, ä¸¦åœ¨éœ€è¦æ™‚æä¾› å®Œæ•´å¥å­é‡å¯« (rewrite_suggestion) æˆ– èªè¨€æµæš¢åº¦ (feedback) å»ºè­°ã€‚
    c. ã€III. åƒèˆ‡åº¦ (Engagement)ã€‘: æä¾›ã€Œå»ºè­°ã€ã€‚
        - è©å½™: é€é 'vocab_suggestions' å»ºè­°æ›¿æ› éåº¦ä½¿ç”¨æˆ–ä¹å‘³ çš„è©å½™ã€‚
        - çµæ§‹: é€é 'feedback' æé†’ å¥å­å¤šæ¨£æ€§ æˆ– å…§å®¹é‡è¤‡ çš„å•é¡Œã€‚
    d. ã€IV. å‚³éæ€§ (Delivery)ã€‘: (ç¶­æŒåŸæ¨™æº–) åµæ¸¬ 'detected_tone', 'formality' (e.g., 'æ­£å¼')ï¼Œä¸¦æª¢æŸ¥ 'inclusive_language_warning'ã€‚
10. ã€è‹±æ–‡å¥å­å®šç¾©ã€‘ï¼š**ä¸€å€‹å®Œæ•´çš„è‹±æ–‡å¥å­å¿…é ˆåŒ…å«ä¸»è©å’Œè¿°èªï¼Œè¡¨é”ä¸€å€‹å®Œæ•´çš„æ„æ€ï¼ˆç¨ç«‹å­å¥ï¼‰ï¼Œä¸”å¥é¦–å¤§å¯«ï¼Œå¥å°¾ä»¥å¥é»ã€å•è™Ÿæˆ–é©šå˜†è™Ÿä½œçµã€‚**
11. åƒ…ä»¥è¦æ±‚çš„ JSON æ ¼å¼ç‰©ä»¶ (Object) è¼¸å‡ºã€‚`;
            
            const userQuery = `
å®Œæ•´æ­é…ç‰‡èª: "${fullPhrase}"
`;
            
            // å‘¼å« API (ä½¿ç”¨ Prediction tab çš„ Consistency Manager åƒæ•¸)
            const result = await callGeminiAPI(systemPrompt, userQuery, validationSchema, predTemp.value, predTopP.value);

            // æ¢å¾© UI
            displayDone(valLoading, valButton, valButtonText, "é©—è­‰æ­é… (Validate Collocation)");
            
            // è™•ç† API å›æ‡‰
            if (result.isError) {
                displayError(valError, result.message);
            } else if (result.Fpm !== undefined && result.MI !== undefined && result.L_acc_norm !== undefined && result.example_grammar_validation !== undefined) {
                // v3.0 ä¿®æ­£ç‰ˆï¼šæª¢æŸ¥æ–°æ¬„ä½
                displayValidationResult(result, fullPhrase);
            } else {
                displayError(valError, "æ”¶åˆ°éé æœŸçš„å›æ‡‰æ ¼å¼ (ç¼ºå°‘ example_grammar_validation)ã€‚");
            }
        }

        // v3.0: é¡¯ç¤ºé©—è­‰çµæœ
        function displayValidationResult(result, fullPhrase) {
            // æ ¹æ“š S_Naturalness æµç¨‹è§£æ§‹ API å›æ‡‰
            // v3.0 æ›´æ–°: è§£æ§‹æ–°æ¬„ä½
            const { Fpm, MI, L_acc_norm, example, grammarCheck, spellingSuggestion, consistency_score, example_grammar_validation } = result;
            
            // S_Naturalness é‹ç®— (ä¸ƒæ­¥é©Ÿæµç¨‹)
            // ç¯„ä¾‹åƒæ•¸ï¼ˆæ­£è¦åŒ–åŸºæº–ï¼‰
            const N_LOG_MIN = 0;
            const N_LOG_MAX = 2.0043213738; // log10(100 + 1)
            const M_MIN = 0;
            const M_MAX = 6;
            
            // æ¬Šé‡
            const W_FPM = 0.4;
            const W_MI = 0.4;
            const W_L_ACC = 0.2;

            // æ­¥é©Ÿ 3: å°æ•¸è½‰æ›
            const N_Log = Math.log10(Fpm + 1);
            // æ­¥é©Ÿ 4: N-gram æ­£è¦åŒ–
            const N_norm = (N_Log - N_LOG_MIN) / (N_LOG_MAX - N_LOG_MIN);
            // æ­¥é©Ÿ 5: MI æ­£è¦åŒ–
            const M_norm = (MI - M_MIN) / (M_MAX - M_MIN);
            // æ­¥é©Ÿ 7: è¨ˆç®—æœ€çµ‚è‡ªç„¶åº¦è©•åˆ†
            const S_Naturalness = (W_FPM * N_norm) + (W_MI * M_norm) + (W_L_ACC * L_acc_norm);

            // æ ¹æ“š S_Naturalness ç²å– Band è³‡è¨Š (ä½¿ç”¨å·²ä¿®æ­£çš„å‡½æ•¸)
            const bandInfo = getLexicalBandDetails(S_Naturalness);

            let suggestionHtml = '';
            if (spellingSuggestion && spellingSuggestion.trim() !== '') {
                suggestionHtml = `
                    <div class="mt-4">
                        <h4 class="font-semibold text-yellow-300">å»ºè­° (Suggestion/Alternative)</h4>
                        <p class="text-yellow-400 bg-yellow-900/50 p-3 rounded-md">${spellingSuggestion}</p>
                    </div>
                `;
            }

            // v3.0 æ›´æ–°: è™•ç† consistency ç‹€æ…‹
            const consistencyStatus = consistency_score >= 85 ? 'Stable' : 'Check';

            validationResults.innerHTML = `
                <div class="text-center mb-6 border-b border-gray-700 pb-4">
                    <span class="text-xs font-semibold uppercase text-gray-400">IELTS Lexical Resource Band</span>
                    <div class="flex items-center justify-center my-2">
                        <!-- S_Naturalness v2.1 ä¿®æ­£ç‰ˆ: Band é¡¯ç¤ºåŸºæ–¼ S_Naturalness -->
                        <span class="band-tag ${bandInfo.color} text-white text-3xl p-3">Band ${bandInfo.band}</span>
                    </div>
                    <p class="text-gray-300 mt-2 max-w-md mx-auto">${bandInfo.summary}</p>
                </div>

                <div class="space-y-4">
                    <!-- S_Naturalness v2.1 ä¿®æ­£ç‰ˆ: é¡¯ç¤º S_Naturalness è¨ˆç®—è©³æƒ… -->
                    <div class="bg-gray-700/50 p-4 rounded-md space-y-3">
                        <h4 class="font-semibold text-gray-300 text-center">S_Naturalness (è‡ªç„¶åº¦) è¨ˆç®—è©³æƒ…</h4>
                        <div class="grid grid-cols-3 text-sm text-gray-300 text-center">
                            <p><strong>Fpm (åŸå§‹é »ç‡):</strong> <span class="text-green-300">${Fpm.toFixed(4)}</span></p>
                            <p><strong>MI (äº’è³‡è¨Š):</strong> <span class="text-green-300">${MI.toFixed(3)}</span></p>
                            <p><strong>L_Acc (æº–ç¢ºåº¦):</strong> <span class="text-green-300">${L_acc_norm.toFixed(1)}</span></p>
                        </div>
                        <hr class="border-gray-600">
                        <div class="grid grid-cols-2 text-sm text-gray-300 text-center">
                            <p><strong>N_norm (é »ç‡æ­£è¦åŒ–):</strong> <span class="text-blue-300">${N_norm.toFixed(4)}</span> (w: ${W_FPM * 100}%)</p>
                            <p><strong>M_norm (MI æ­£è¦åŒ–):</strong> <span class="text-blue-300">${M_norm.toFixed(4)}</span> (w: ${W_MI * 100}%)</p>
                        </div>
                        <div class="text-center pt-2">
                            <p class="font-semibold text-gray-300">æœ€çµ‚ S_Naturalness åˆ†æ•¸</p>
                            <p class="text-2xl font-bold text-white">${S_Naturalness.toFixed(4)}</p>
                            <p class="text-xs text-gray-400">(${W_FPM}*${N_norm.toFixed(3)} + ${W_MI}*${M_norm.toFixed(3)} + ${W_L_ACC}*${L_acc_norm.toFixed(1)})</p>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-300">èªæ³•é©—è­‰ (Grammar Check)</h4>
                        <p class="text-gray-300">${grammarCheck}</p>
                    </div>

                    <div>
                        <h4 class="font-semibold text-gray-300">ç¯„ä¾‹ (Example) - <span class="text-xs text-gray-400">å¯åˆ‡æ› Band ç­‰ç´š</span></h4>
                        <div id="val-example-container" class="bg-gray-700 p-4 rounded-md text-gray-200 text-lg">
                            ${highlight(example, fullPhrase)}
                        </div>
                    </div>
                    <!-- v3.0 æ›´æ–°: é¡¯ç¤º Consistency å’Œ Grammar Validation Layer -->
                    <div id="val-metrics-container" class="text-xs text-gray-400 text-right mt-1 space-y-1">
                        <div>Consistency: ${consistency_score} (${consistencyStatus})</div>
                    </div>
                    <!-- v3.0 Grammar Validation Layer æ³¨å…¥é» -->
                    <div id="val-grammar-validation">
                        ${renderGrammarValidation(example_grammar_validation)}
                    </div>

                    <!-- Band Control Regeneration for Validation -->
                    <div class="flex gap-2 pt-2">
                        <select id="val-band-select" class="w-1/2 bg-gray-600 border border-gray-500 rounded-md p-2 text-sm text-white focus:ring-1 focus:ring-blue-500">
                            <option value="9">Band 9</option>
                            <option value="8">Band 8</option>
                            <option value="7" selected>Band 7</option>
                            <option value="6">Band 6</option>
                            <option value="5">Band 5</option>
                        </select>
                        <button class="regen-button w-1/2 bg-gray-500 hover:bg-gray-400 text-white text-sm font-medium py-2 px-3 rounded-lg transition-colors duration-200 flex items-center justify-center gap-1 disabled:opacity-50"
                                data-index="val"
                                data-context="${fullPhrase}"
                                data-word=""
                                data-type="validation">
                            <span class="regen-text">ğŸ”„ é‡æ–°ç”Ÿæˆ</span>
                            <div class="spinner regen-loading hidden"></div>
                        </button>
                    </div>

                    ${suggestionHtml}
                </div>
            `;
            validationResults.classList.remove('hidden');

            // ç¶å®š Validation Tab çš„é‡æ–°ç”Ÿæˆäº‹ä»¶
            document.querySelector('#validationResults .regen-button').addEventListener('click', async function(e) {
                e.preventDefault();
                const button = e.currentTarget;
                const band = document.getElementById('val-band-select').value;
                const context = button.dataset.context; // fullPhrase is stored here
                await handleRegeneration(button, band, context, '', 'validation');
            });
        }


        // --- åˆ†é åˆ‡æ›é‚è¼¯ ---
        function switchTab(activeTab) {
            // ... ( unchanged switchTab logic )
            if (activeTab === 'prediction') {
                // å•Ÿå‹• Prediction
                tabs.prediction.classList.remove('text-gray-400', 'hover:bg-gray-800/50');
                tabs.prediction.classList.add('text-white', 'bg-gray-800', '-mb-px', 'border-t', 'border-l', 'border-r', 'border-gray-700');
                contents.prediction.classList.remove('hidden');
                
                // é—œé–‰ Validation
                tabs.validation.classList.add('text-gray-400', 'hover:bg-gray-800/50');
                tabs.validation.classList.remove('text-white', 'bg-gray-800', '-mb-px', 'border-t', 'border-l', 'border-r', 'border-gray-700');
                contents.validation.classList.add('hidden');
            } else {
                // å•Ÿå‹• Validation
                tabs.validation.classList.remove('text-gray-400', 'hover:bg-gray-800/50');
                tabs.validation.classList.add('text-white', 'bg-gray-800', '-mb-px', 'border-t', 'border-l', 'border-r', 'border-gray-700');
                contents.validation.classList.remove('hidden');

                // é—œé–‰ Prediction
                tabs.prediction.classList.add('text-gray-400', 'hover:bg-gray-800/50');
                tabs.prediction.classList.remove('text-white', 'bg-gray-800', '-mb-px', 'border-t', 'border-l', 'border-r', 'border-gray-700');
                contents.prediction.classList.add('hidden');
            }
        }

        // --- åˆå§‹ç¶å®šäº‹ä»¶ ---
        tabs.prediction.addEventListener('click', () => switchTab('prediction'));
        tabs.validation.addEventListener('click', () => switchTab('validation'));
        predForm.addEventListener('submit', handlePredictionSubmit);
        customWordForm.addEventListener('submit', handleCustomWordCheck); // ç¶å®šè‡ªå®šè©å½™è¡¨å–®
        valForm.addEventListener('submit', handleValidationSubmit);

        // é è¨­é¸ä¸­ç¬¬ä¸€å€‹åˆ†é 
        switchTab('prediction');

        // v2.6 IGPVL: ç‰ˆæœ¬è¨»è¨˜
        console.log("IGPVL v2.6 å·²è¼‰å…¥ä¸¦æ•´åˆåˆ°æäº¤è¡¨å–®ä¸­ã€‚");

    </script>
</body>
</html>