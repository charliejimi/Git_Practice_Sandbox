<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub æª”æ¡ˆç®¡ç†çµ‚ç«¯ v2.9.6 (Exe Support + AI Path + Gamified Heatmap)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0F172A, #1E293B);
            min-height: 100vh;
            color: #E2E8F0;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-gradient {
            background: linear-gradient(135deg, #3B82F6, #8B5CF6);
            transition: all 0.3s ease;
        }
        .btn-gradient:hover:not(:disabled) {
            background: linear-gradient(135deg, #2563EB, #7C3AED);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #EF4444, #B91C1C);
            transition: all 0.3s ease;
        }
        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .input-field {
            background: #0F172A;
            border: 1px solid #334155;
            transition: all 0.3s;
        }
        .input-field:focus {
            border-color: #8B5CF6;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
            outline: none;
        }

        /* --- Tree View Specific Styles --- */
        .tree-container {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* VS Code style font */
            font-size: 13px;
        }
        .tree-node {
            display: flex;
            align-items: center;
            padding: 3px 0;
            cursor: pointer;
            color: #cbd5e1;
            user-select: none;
            transition: background-color 0.1s;
        }
        .tree-node:hover {
            background-color: #334155;
            color: #fff;
        }
        .tree-node.selected {
            background-color: #2563eb !important; /* VS Code Blue */
            color: #fff !important;
        }
        .tree-toggle-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #94a3b8;
            transition: transform 0.2s ease;
        }
        .tree-toggle-icon.expanded {
            transform: rotate(90deg);
        }
        .tree-toggle-icon.invisible {
            visibility: hidden;
        }
        .tree-icon {
            margin-right: 6px;
            width: 16px;
            text-align: center;
        }
        .tree-label {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Loading indicator inside tree */
        .tree-spinner {
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 4px;
        }

        .drag-over {
            border-color: #3B82F6 !important;
            background-color: rgba(59, 130, 246, 0.1) !important;
            transform: scale(1.02);
        }

        .spinner {
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .markdown-body h1, .markdown-body h2, .markdown-body h3 { margin-top: 1em; margin-bottom: 0.5em; font-weight: bold; color: #fff; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body li { margin-bottom: 0.3em; }
        .markdown-body code { background-color: #334155; padding: 0.2em 0.4em; border-radius: 3px; font-family: monospace; }
        .markdown-body pre { background-color: #1e293b; padding: 1em; border-radius: 0.5em; overflow-x: auto; margin-bottom: 1em; }
        .markdown-body p { margin-bottom: 0.8em; }
        .markdown-body strong { color: #A5B4FC; }

        /* --- Heatmap Contribution Graph Styles (Enhanced) --- */
        .heatmap-container {
            display: flex;
            align-items: flex-end;
            gap: 3px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        .heatmap-week {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .heatmap-day {
            width: 10px;
            height: 10px;
            border-radius: 2px;
            background-color: #1e293b; /* é è¨­: ç„¡è²¢ç» */
            position: relative;
            transition: all 0.3s ease;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }
        @keyframes fadeIn { to { opacity: 1; } }

        .heatmap-day:hover {
            border: 1px solid rgba(255,255,255,0.8);
            transform: scale(1.3);
            z-index: 10;
            box-shadow: 0 0 8px rgba(255,255,255,0.3);
        }
        
        /* Contribution Levels (Enhanced Green Colors) */
        .level-0 { background-color: #1e293b; }
        .level-1 { background-color: #0e4429; } 
        .level-2 { background-color: #006d32; }
        .level-3 { background-color: #26a641; }
        .level-4 { 
            background-color: #39d353; 
            box-shadow: 0 0 4px rgba(57, 211, 83, 0.4); /* Glow for max effort */
        }

        /* Stats Cards */
        .stat-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255,255,255,0.05);
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            background: rgba(15, 23, 42, 0.8);
            border-color: rgba(255,255,255,0.1);
        }

        /* Custom Tooltip for Heatmap */
        .heatmap-tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            color: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            pointer-events: none;
            border: 1px solid #334155;
            z-index: 50;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- å·¦å´é¢æ¿ï¼šè¨­å®šèˆ‡æª”æ¡ˆç€è¦½å™¨ -->
        <div class="lg:col-span-1 space-y-6">
            
            <!-- 1. è¨­å®šå€å¡Š -->
            <div class="glass-panel rounded-2xl p-6 shadow-xl relative">
                <h2 class="text-xl font-bold mb-4 flex items-center text-blue-400">
                    <i class="fa-brands fa-github mr-2"></i> å€‰åº«è¨­å®š
                </h2>
                
                <div class="space-y-4">
                    <!-- Token -->
                    <div>
                        <div class="flex justify-between items-end">
                            <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider">GitHub PAT Token</label>
                            <span id="tokenStatus" class="text-[10px] text-green-400 opacity-0 transition-opacity"><i class="fa-solid fa-check"></i> å·²ç´€éŒ„</span>
                        </div>
                        <div class="relative">
                            <input type="password" id="token" placeholder="ghp_xxxxxxxxxxxx"
                                class="input-field w-full p-2.5 rounded-lg text-sm mt-1 pr-10">
                            <button onclick="toggleTokenVisibility('token', 'eyeIcon')" class="absolute right-3 top-3.5 text-gray-500 hover:text-white">
                                <i class="fa-regular fa-eye" id="eyeIcon"></i>
                            </button>
                        </div>
                        
                        <div class="flex items-center mt-2 group cursor-pointer">
                            <input type="checkbox" id="saveToken" class="rounded bg-gray-700 border-gray-600 text-blue-500 focus:ring-blue-500 cursor-pointer w-4 h-4">
                            <label for="saveToken" class="ml-2 text-xs text-gray-400 group-hover:text-blue-300 transition-colors cursor-pointer select-none">
                                <i class="fa-solid fa-database mr-1"></i> è‡ªå‹•å„²å­˜ Token (ä¸‹æ¬¡å•Ÿå‹•è‡ªå‹•å¸¶å…¥)
                            </label>
                        </div>
                    </div>

                    <!-- Gemini API Key -->
                    <div class="border-t border-slate-700 pt-4">
                        <div class="flex justify-between items-end">
                            <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider flex items-center">
                                <i class="fa-solid fa-robot mr-1"></i> Gemini API Key (é¸å¡«)
                            </label>
                            <span id="geminiStatus" class="text-[10px] text-green-400 opacity-0 transition-opacity"><i class="fa-solid fa-check"></i> å·²ç´€éŒ„</span>
                        </div>
                        <div class="relative">
                            <input type="password" id="geminiApiKey" placeholder="AIzaSy..."
                                class="input-field w-full p-2.5 rounded-lg text-sm mt-1 pr-10">
                            <button onclick="toggleTokenVisibility('geminiApiKey', 'aiEyeIcon')" class="absolute right-3 top-3.5 text-gray-500 hover:text-white">
                                <i class="fa-regular fa-eye" id="aiEyeIcon"></i>
                            </button>
                        </div>
                        
                         <div class="flex items-center mt-2 group cursor-pointer">
                            <input type="checkbox" id="saveGeminiKey" class="rounded bg-gray-700 border-gray-600 text-blue-500 focus:ring-blue-500 cursor-pointer w-4 h-4">
                            <label for="saveGeminiKey" class="ml-2 text-xs text-gray-400 group-hover:text-blue-300 transition-colors cursor-pointer select-none">
                                <i class="fa-solid fa-database mr-1"></i> è‡ªå‹•å„²å­˜ API Key (ä¸‹æ¬¡å•Ÿå‹•è‡ªå‹•å¸¶å…¥)
                            </label>
                        </div>
                    </div>

                    <!-- Repo & Branch -->
                    <div class="border-t border-slate-700 pt-4">
                        <div class="flex justify-between items-center">
                            <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Owner / Repo</label>
                            <button onclick="fetchRepositories(document.getElementById('token').value)" class="text-[10px] text-blue-400 hover:text-blue-300" title="é‡æ–°æ•´ç†åˆ—è¡¨">
                                <i class="fa-solid fa-sync"></i>
                            </button>
                        </div>
                        <select id="repo" onchange="fetchBranches(document.getElementById('token').value)" class="input-field w-full p-2.5 rounded-lg text-sm mt-1 appearance-none">
                            <option value="charliejimi/Git_Practice_Sandbox">charliejimi/Git_Practice_Sandbox</option>
                            <option value="" disabled>è«‹è¼¸å…¥ Token ä»¥è®€å–æ›´å¤š...</option>
                        </select>
                    </div>
                    <div>
                        <div class="flex justify-between items-center">
                            <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Branch</label>
                        </div>
                        <select id="branch" class="input-field w-full p-2.5 rounded-lg text-sm mt-1 appearance-none">
                            <option value="master">master</option>
                        </select>
                    </div>
                    
                    <button onclick="initTreeBrowser()" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-medium py-2 rounded-lg text-sm transition flex justify-center items-center shadow-lg mt-4">
                        <i class="fa-solid fa-rotate mr-2"></i> é€£ç·šä¸¦è®€å– (Root)
                    </button>

                    <!-- æ‰‹å‹•å‚™ä»½å€å¡Š -->
                    <div class="border-t border-slate-700 pt-4 mt-2">
                         <div class="flex justify-between items-center mb-2">
                             <label class="text-[10px] text-gray-500 uppercase font-bold">è¨­å®šæª”å‚™ä»½ (Config Backup)</label>
                         </div>
                         <div class="grid grid-cols-2 gap-2">
                             <button onclick="ConfigDB.exportToFile()" class="bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs py-1.5 rounded border border-gray-600 transition">
                                 <i class="fa-solid fa-download mr-1"></i> åŒ¯å‡ºè¨­å®š.json
                             </button>
                             <button onclick="document.getElementById('importConfigInput').click()" class="bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs py-1.5 rounded border border-gray-600 transition">
                                 <i class="fa-solid fa-upload mr-1"></i> åŒ¯å…¥è¨­å®š.json
                             </button>
                             <input type="file" id="importConfigInput" accept=".json" class="hidden" onchange="ConfigDB.importFromFile(this)">
                         </div>
                         <p class="text-[9px] text-gray-500 mt-1 text-center">å¯å°‡è¨­å®šåŒ¯å‡ºç‚ºå¯¦é«”æª”æ¡ˆä¿å­˜æ–¼é›»è…¦</p>
                    </div>
                </div>
            </div>

            <!-- 2. æª”æ¡ˆç€è¦½å™¨ (Tree View) -->
            <div class="glass-panel rounded-2xl p-4 shadow-xl flex flex-col h-[500px]">
                <div class="flex items-center justify-between mb-2 pb-2 border-b border-slate-700">
                    <h2 class="text-lg font-bold flex items-center text-emerald-400">
                        <i class="fa-regular fa-folder-open mr-2"></i> æª”æ¡ˆç€è¦½å™¨
                    </h2>
                    <span id="repoNameDisplay" class="text-xs text-gray-500 font-mono"></span>
                </div>
                
                <!-- æ¨¹ç‹€åˆ—è¡¨å€åŸŸ -->
                <div id="fileList" class="flex-grow overflow-y-auto overflow-x-hidden bg-[#0F172A] rounded border border-slate-800 p-1 tree-container">
                    <div class="text-center text-gray-500 mt-10 text-xs">
                        <p>è«‹è¼¸å…¥è¨­å®šä¸¦é»æ“Šä¸Šæ–¹<br>ã€Œé€£ç·šä¸¦è®€å–ã€æŒ‰éˆ•</p>
                    </div>
                </div>

                <!-- åº•éƒ¨æ“ä½œæç¤º -->
                <div class="mt-2 text-[10px] text-gray-500 text-center flex justify-between px-2">
                    <span><i class="fa-solid fa-mouse-pointer mr-1"></i>é»æ“Šé¸å–</span>
                    <span><i class="fa-solid fa-chevron-right mr-1"></i>å±•é–‹è³‡æ–™å¤¾</span>
                </div>
            </div>
        </div>

        <!-- å³å´é¢æ¿ï¼šä¸Šå‚³èˆ‡æ“ä½œå€ -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- 3. ä¸Šå‚³/ç·¨è¼¯å€ -->
            <div class="glass-panel rounded-2xl p-6 md:p-10 shadow-xl relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
                    <i class="fa-brands fa-git-alt text-9xl"></i>
                </div>

                <h1 class="text-3xl font-extrabold text-white mb-6 tracking-tight flex items-center gap-3">
                    æª”æ¡ˆä¸Šå‚³èˆ‡æ™ºèƒ½æ“ä½œ
                    <span class="text-xs font-normal bg-blue-600 text-white px-2 py-1 rounded-full align-middle">AI Powered</span>
                </h1>

                <!-- ç›®æ¨™è·¯å¾‘ (AI æ¨è–¦æŒ‰éˆ•) -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-400 mb-1">ç›®æ¨™è·¯å¾‘ (å«æª”å)</label>
                    <div class="flex gap-2">
                        <div class="flex flex-1">
                            <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-slate-600 bg-slate-700 text-gray-400 text-sm">
                                /
                            </span>
                            <input type="text" id="targetPath" placeholder="folder/filename.ext"
                                class="input-field flex-1 p-3 rounded-r-lg focus:ring-2 focus:ring-blue-500 w-full">
                        </div>
                        <button onclick="suggestPathWithAI()" id="btnAiPath" class="bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg px-3 py-2 text-xs font-bold transition flex items-center shadow-lg whitespace-nowrap border border-indigo-400/50">
                            <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> AI æ¨è–¦ä½ç½®
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1 ml-1">ä¸Šå‚³å‰è«‹ç¢ºèªè·¯å¾‘ã€‚å¯æ‰‹å‹•è¼¸å…¥æˆ–é»æ“Šã€ŒAI æ¨è–¦ä½ç½®ã€ç”±ç³»çµ±è‡ªå‹•åˆ¤æ–·ã€‚</p>
                </div>

                <!-- æª”æ¡ˆé¸æ“‡å€åŸŸ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-400 mb-2">é¸æ“‡æª”æ¡ˆ</label>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- æ‹–æ”¾å€ -->
                        <div id="dropZone" 
                             class="md:col-span-2 relative border-2 border-dashed border-slate-600 rounded-xl p-6 hover:border-blue-500 transition-all duration-200 cursor-pointer bg-slate-800/50 flex flex-col items-center justify-center"
                             onclick="document.getElementById('fileInput').click()"
                             ondragover="handleDragOver(event)"
                             ondragleave="handleDragLeave(event)"
                             ondrop="handleFileDrop(event)">
                             
                            <input type="file" id="fileInput" class="hidden" 
                                   accept=".txt,.html,.css,.js,.json,.md,.png,.jpg,.jpeg,.gif,.svg,.webp,.py,.java,.cpp,.ts,.tsx,.jsx"
                                   onchange="handleFileSelect(this)">
                            
                            <div class="text-center space-y-2 pointer-events-none">
                                <i class="fa-solid fa-cloud-arrow-up text-3xl text-gray-400 group-hover:text-blue-400 transition"></i>
                                <p id="fileNameDisplay" class="text-sm text-gray-300 font-medium">é»æ“Šæˆ–æ‹–æ›³æª”æ¡ˆè‡³æ­¤</p>
                                <p class="text-[10px] text-gray-500 leading-tight max-w-xs mx-auto">
                                    æ”¯æ´æ ¼å¼: <br>
                                    <span class="text-gray-400">æ–‡å­—/ä»£ç¢¼:</span> .txt, .md, .html, .css, .js, .py, .json, .cpp, .java<br>
                                    <span class="text-gray-400">åœ–ç‰‡:</span> .png, .jpg, .jpeg, .gif, .svg, .webp
                                </p>
                            </div>
                        </div>

                        <!-- é è¦½å€ -->
                        <div class="md:col-span-1 border border-slate-700 rounded-xl bg-slate-900 flex items-center justify-center overflow-hidden relative min-h-[120px]">
                            <img id="imagePreview" class="hidden w-full h-full object-contain p-1" alt="Preview">
                            <div id="textPreviewIcon" class="hidden text-gray-600 flex flex-col items-center gap-2">
                                <i class="fa-regular fa-file-code text-4xl"></i>
                                <span class="text-xs">ç¨‹å¼ç¢¼æª”æ¡ˆ</span>
                            </div>
                            <span id="noPreviewText" class="text-xs text-gray-600">ç„¡é è¦½</span>
                            
                            <!-- æ¸…é™¤æŒ‰éˆ• -->
                            <button onclick="clearFileSelection(event)" id="clearFileBtn" class="hidden absolute top-1 right-1 bg-red-500/80 hover:bg-red-600 text-white rounded-full p-1 w-6 h-6 flex items-center justify-center text-xs backdrop-blur-sm shadow-md">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Gemini AI åŠŸèƒ½å€ -->
                <div class="mb-6 p-4 rounded-xl border border-indigo-500/30 bg-indigo-900/10">
                    <label class="block text-sm font-bold text-indigo-300 mb-3 flex items-center">
                        <i class="fa-solid fa-robot mr-2"></i> Gemini AI æ™ºèƒ½åŠ©æ‰‹
                    </label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <button onclick="runGeminiTask('summary')" id="btnSummary" disabled
                            class="bg-indigo-600/20 border border-indigo-500/30 text-indigo-300 hover:bg-indigo-600/30 py-2 px-3 rounded-lg text-sm font-medium transition flex items-center justify-center disabled:opacity-30 disabled:cursor-not-allowed">
                            <i class="fa-solid fa-file-lines mr-2"></i> æª”æ¡ˆæ‘˜è¦
                        </button>
                        <button onclick="runGeminiTask('commit')" id="btnCommitMsg" disabled
                            class="bg-amber-600/20 border border-amber-500/30 text-amber-300 hover:bg-amber-600/30 py-2 px-3 rounded-lg text-sm font-medium transition flex items-center justify-center disabled:opacity-30 disabled:cursor-not-allowed">
                            <i class="fa-solid fa-message mr-2"></i> å¯« Commit è¨Šæ¯
                        </button>
                        <button onclick="runGeminiTask('review')" id="btnCodeReview" disabled
                            class="bg-emerald-600/20 border border-emerald-500/30 text-emerald-300 hover:bg-emerald-600/30 py-2 px-3 rounded-lg text-sm font-medium transition flex items-center justify-center disabled:opacity-30 disabled:cursor-not-allowed relative overflow-hidden group">
                            <span class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></span>
                            <i class="fa-solid fa-bug-slash mr-2"></i> âœ¨ æ™ºèƒ½ä»£ç¢¼å¯©æŸ¥
                        </button>
                    </div>
                    
                    <!-- Gemini è¼¸å‡ºå€å¡Š -->
                    <div id="geminiOutputContainer" class="hidden mt-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-indigo-300 font-bold" id="aiOutputTitle">AI å›æ‡‰:</span>
                            <button onclick="document.getElementById('geminiOutputContainer').classList.add('hidden')" class="text-xs text-gray-500 hover:text-white">
                                <i class="fa-solid fa-times"></i> é—œé–‰
                            </button>
                        </div>
                        <div id="geminiOutput" class="p-4 bg-slate-800/80 border border-indigo-500/20 rounded-lg text-sm text-gray-200 markdown-body max-h-64 overflow-y-auto"></div>
                    </div>
                </div>

                <!-- ğŸŒŸ Contribution Heatmap (Gamified Version) -->
                <div class="mb-6 p-4 rounded-xl border border-slate-700 bg-slate-800/50">
                     <div class="flex justify-between items-center mb-4">
                         <label class="text-xs font-bold text-gray-400 uppercase tracking-wider flex items-center">
                             <i class="fa-solid fa-chart-line mr-2 text-green-400"></i> è¿‘æœŸè²¢ç»æ¦‚è¦½ (Activity)
                         </label>
                         <span class="text-[10px] text-gray-500">Last 90 Days</span>
                     </div>

                     <!-- Stats Dashboard (NEW) -->
                     <div class="grid grid-cols-3 gap-3 mb-4">
                         <!-- Streak Card -->
                         <div class="stat-card p-3 rounded-lg text-center">
                             <div class="text-[10px] text-gray-400 uppercase tracking-wider mb-1">Current Streak</div>
                             <div class="flex items-center justify-center text-xl font-bold text-orange-400">
                                 <i class="fa-solid fa-fire mr-1.5 animate-pulse"></i> <span id="statStreak">0</span>
                             </div>
                             <div class="text-[9px] text-gray-500 mt-1">Best: <span id="statMaxStreak">0</span> Days</div>
                         </div>
                         
                         <!-- Total Card -->
                         <div class="stat-card p-3 rounded-lg text-center">
                             <div class="text-[10px] text-gray-400 uppercase tracking-wider mb-1">Total Commits</div>
                             <div class="flex items-center justify-center text-xl font-bold text-blue-400">
                                 <span id="statTotal">0</span>
                             </div>
                             <div class="text-[9px] text-gray-500 mt-1">In 3 Months</div>
                         </div>

                         <!-- Rank Card -->
                         <div class="stat-card p-3 rounded-lg text-center">
                             <div class="text-[10px] text-gray-400 uppercase tracking-wider mb-1">Current Rank</div>
                             <div class="flex items-center justify-center text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-400">
                                 <span id="statRank">Novice</span>
                             </div>
                             <div class="text-[9px] text-gray-500 mt-1" id="nextLevelMsg">Keep coding!</div>
                         </div>
                     </div>

                     <div class="overflow-x-auto pb-1">
                         <div id="contributionHeatmap" class="heatmap-container min-h-[60px] flex items-center justify-center text-gray-500 text-xs">
                             è¼‰å…¥ä¸­...
                         </div>
                     </div>
                     <div class="flex items-center justify-end mt-2 gap-1 text-[10px] text-gray-500">
                         <span>Less</span>
                         <div class="w-2.5 h-2.5 rounded bg-[#1e293b]"></div>
                         <div class="w-2.5 h-2.5 rounded bg-[#0e4429]"></div>
                         <div class="w-2.5 h-2.5 rounded bg-[#006d32]"></div>
                         <div class="w-2.5 h-2.5 rounded bg-[#26a641]"></div>
                         <div class="w-2.5 h-2.5 rounded bg-[#39d353]"></div>
                         <span>More</span>
                     </div>
                </div>

                <!-- Commit Message -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-400 mb-1">Commit Message</label>
                    <input type="text" id="commitMessage" value="Update via AI GitHub Manager"
                        class="input-field w-full p-3 rounded-lg">
                </div>

                <!-- Action Buttons -->
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="performAction('upload')" id="btnUpload"
                        class="btn-gradient text-white font-bold py-3.5 rounded-xl shadow-lg flex items-center justify-center">
                        <span id="spinnerUpload" class="spinner hidden mr-2"></span>
                        <i class="fa-solid fa-cloud-upload-alt mr-2"></i> ä¸Šå‚³ / æ›´æ–°
                    </button>
                    <button onclick="performAction('delete')" id="btnDelete"
                        class="btn-danger text-white font-bold py-3.5 rounded-xl shadow-lg flex items-center justify-center">
                        <span id="spinnerDelete" class="spinner hidden mr-2"></span>
                        <i class="fa-solid fa-trash-alt mr-2"></i> åˆªé™¤æª”æ¡ˆ
                    </button>
                </div>
            </div>

            <!-- ç‹€æ…‹èˆ‡çµæœ -->
            <div id="statusArea" class="hidden p-4 rounded-xl border transition-all duration-300">
                <div class="flex items-start">
                    <i id="statusIcon" class="fa-solid fa-circle-info mt-1 mr-3"></i>
                    <div class="flex-1 overflow-hidden">
                        <h4 id="statusTitle" class="font-bold text-sm mb-1">ç‹€æ…‹æ›´æ–°</h4>
                        <p id="statusMsg" class="text-xs opacity-90 break-all"></p>
                        
                        <!-- æˆåŠŸå¾Œçš„é€£çµ -->
                        <div id="successLinks" class="hidden mt-3 pt-3 border-t border-white/20">
                            <label class="text-[10px] uppercase font-bold opacity-70">Raw URL</label>
                            <div class="flex mt-1">
                                <input type="text" id="resultUrl" readonly class="bg-black/20 border-none rounded-l text-xs w-full px-2 py-1 select-all text-white">
                                <button onclick="copyUrl()" class="bg-white/20 hover:bg-white/30 px-3 rounded-r text-xs font-bold transition">
                                    COPY
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    
    <!-- Tooltip Element -->
    <div id="heatmapTooltip" class="heatmap-tooltip"></div>

    <script>
        // --- å…¨åŸŸå¸¸æ•¸èˆ‡è®Šæ•¸ ---
        const DEFAULT_UPLOAD_MESSAGE = "Update via AI GitHub Manager"; 
        
        let selectedFile = null; 
        let selectedFileBase64 = null; 
        
        // Tree View State
        let currentlySelectedNode = null;

        // --- 1. å°å‹è³‡æ–™åº« (Config Manager) ---
        const ConfigDB = {
            KEYS: {
                GITHUB_TOKEN: 'github_pat_token',
                GEMINI_KEY: 'gemini_api_key',
                REPO: 'github_repo_name',
                BRANCH: 'github_branch_name'
            },
            
            save: function(key, value) {
                if (value) {
                    localStorage.setItem(key, value);
                    this.showSaveIndicator(key);
                } else {
                    localStorage.removeItem(key);
                    this.hideSaveIndicator(key);
                }
            },

            remove: function(key) {
                localStorage.removeItem(key);
                this.hideSaveIndicator(key);
            },

            get: function(key) {
                return localStorage.getItem(key);
            },

            showSaveIndicator: function(key) {
                let elId = '';
                if(key === this.KEYS.GITHUB_TOKEN) elId = 'tokenStatus';
                if(key === this.KEYS.GEMINI_KEY) elId = 'geminiStatus';
                
                const el = document.getElementById(elId);
                if(el) el.style.opacity = 1;
            },

            hideSaveIndicator: function(key) {
                let elId = '';
                if(key === this.KEYS.GITHUB_TOKEN) elId = 'tokenStatus';
                if(key === this.KEYS.GEMINI_KEY) elId = 'geminiStatus';
                
                const el = document.getElementById(elId);
                if(el) el.style.opacity = 0;
            },

            exportToFile: function() {
                const config = {
                    github_token: localStorage.getItem(this.KEYS.GITHUB_TOKEN) || '',
                    gemini_key: localStorage.getItem(this.KEYS.GEMINI_KEY) || '',
                    repo: document.getElementById('repo').value,
                    branch: document.getElementById('branch').value
                };
                
                const jsonString = JSON.stringify(config, null, 2);

                if (window.pywebview && window.pywebview.api) {
                    showStatus('info', 'æ­£åœ¨é–‹å•Ÿå­˜æª”å°è©±æ¡†...');
                    window.pywebview.api.export_json(jsonString).then(result => {
                        if (result) {
                            showStatus('success', 'è¨­å®šæª”åŒ¯å‡ºæˆåŠŸï¼');
                        } else {
                            showStatus('warning', 'åŒ¯å‡ºå·²å–æ¶ˆæˆ–å¤±æ•—ã€‚');
                        }
                    }).catch(err => {
                        console.error(err);
                        showStatus('error', 'å‘¼å« Python åŒ¯å‡ºåŠŸèƒ½å¤±æ•—ã€‚');
                    });
                } else {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(jsonString);
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", "github_manager_config.json");
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                    showStatus('info', 'è¨­å®šæª”å·²åŒ¯å‡ºï¼Œè«‹å¦¥å–„ä¿å­˜ã€‚');
                }
            },

            importFromFile: function(inputElement) {
                const file = inputElement.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const config = JSON.parse(e.target.result);
                        if(config.github_token) {
                            document.getElementById('token').value = config.github_token;
                            document.getElementById('saveToken').checked = true;
                            ConfigDB.save(ConfigDB.KEYS.GITHUB_TOKEN, config.github_token);
                            // è‡ªå‹•è§¸ç™¼ Repo åŒæ­¥
                            fetchRepositories(config.github_token, config.repo);
                        }
                        if(config.gemini_key) {
                            document.getElementById('geminiApiKey').value = config.gemini_key;
                            document.getElementById('saveGeminiKey').checked = true;
                            ConfigDB.save(ConfigDB.KEYS.GEMINI_KEY, config.gemini_key);
                        }
                        // å¦‚æœæœ‰ Branch è¨­å®šï¼Œå…ˆå­˜å…¥ LocalStorageï¼Œè®“ç¨å¾Œçš„ fetchBranches èƒ½æŠ“åˆ°
                        if(config.branch) {
                            ConfigDB.save(ConfigDB.KEYS.BRANCH, config.branch);
                        }

                        showStatus('success', 'è¨­å®šæª”åŒ¯å…¥æˆåŠŸï¼');
                    } catch (err) {
                        console.error(err);
                        showStatus('error', 'è¨­å®šæª”æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•åŒ¯å…¥ã€‚');
                    }
                    inputElement.value = '';
                };
                reader.readAsText(file);
            }
        };

        window.onload = function() {
            const savedToken = ConfigDB.get(ConfigDB.KEYS.GITHUB_TOKEN);
            if (savedToken) {
                document.getElementById('token').value = savedToken;
                document.getElementById('saveToken').checked = true;
                ConfigDB.showSaveIndicator(ConfigDB.KEYS.GITHUB_TOKEN);
                // è‡ªå‹•è®€å– Repo
                fetchRepositories(savedToken);
            }

            const savedGeminiKey = ConfigDB.get(ConfigDB.KEYS.GEMINI_KEY);
            if (savedGeminiKey) {
                document.getElementById('geminiApiKey').value = savedGeminiKey;
                document.getElementById('saveGeminiKey').checked = true;
                ConfigDB.showSaveIndicator(ConfigDB.KEYS.GEMINI_KEY);
            }

            document.getElementById('commitMessage').value = DEFAULT_UPLOAD_MESSAGE;

            setupRealtimeSync('token', 'saveToken', ConfigDB.KEYS.GITHUB_TOKEN);
            setupRealtimeSync('geminiApiKey', 'saveGeminiKey', ConfigDB.KEYS.GEMINI_KEY);
            setupRealtimeSync('branch', 'saveToken', ConfigDB.KEYS.BRANCH);
            
            // ç›£è½ Token è®Šæ›´ä»¥è‡ªå‹•è®€å– Repo
            document.getElementById('token').addEventListener('change', function() {
                fetchRepositories(this.value);
            });
            
            // ç›£è½ Repo è®Šæ›´ä»¥æ›´æ–° Heatmap
            document.getElementById('repo').addEventListener('change', function() {
                updateContributionHeatmap();
            });
        };

        async function fetchRepositories(token, preferredRepo = null) {
            if (!token) return;
            
            const repoSelect = document.getElementById('repo');
            const currentSelection = preferredRepo || repoSelect.value || ConfigDB.get(ConfigDB.KEYS.REPO) || "charliejimi/Git_Practice_Sandbox";
            
            repoSelect.disabled = true;
            const originalText = repoSelect.innerHTML;
            repoSelect.innerHTML = `<option>æ­£åœ¨åŒæ­¥ Repo åˆ—è¡¨...</option>`;

            try {
                // æŠ“å–å‰ 100 å€‹ Reposï¼Œä¾æ›´æ–°æ™‚é–“æ’åº
                const response = await fetch('https://api.github.com/user/repos?sort=updated&per_page=100&type=all', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Token ç„¡æ•ˆæˆ–ç¶²è·¯éŒ¯èª¤');
                }

                const repos = await response.json();
                
                repoSelect.innerHTML = '';
                
                if (repos.length === 0) {
                     repoSelect.innerHTML = '<option value="">æ‰¾ä¸åˆ°ä»»ä½•å€‰åº«</option>';
                } else {
                    repos.forEach(repo => {
                        const option = document.createElement('option');
                        option.value = repo.full_name;
                        option.textContent = repo.full_name + (repo.private ? ' (Private)' : '');
                        option.dataset.defaultBranch = repo.default_branch;
                        repoSelect.appendChild(option);
                    });
                    
                    let found = false;
                    for (let i = 0; i < repoSelect.options.length; i++) {
                        if (repoSelect.options[i].value === currentSelection) {
                            repoSelect.selectedIndex = i;
                            found = true;
                            break;
                        }
                    }
                    
                    if (!found && currentSelection) {
                        const option = document.createElement('option');
                        option.value = currentSelection;
                        option.textContent = currentSelection + ' (Saved/Manual)';
                        option.selected = true;
                        option.dataset.defaultBranch = 'master'; 
                        repoSelect.prepend(option);
                    }
                }
                
                const statusEl = document.getElementById('tokenStatus');
                if(statusEl) {
                    statusEl.innerHTML = '<i class="fa-solid fa-check"></i> åŒæ­¥å®Œæˆ';
                    statusEl.style.opacity = 1;
                    setTimeout(() => statusEl.innerHTML = '<i class="fa-solid fa-check"></i> å·²ç´€éŒ„', 3000);
                }

                await fetchBranches(token);
                // Trigger Heatmap update after repo loaded
                updateContributionHeatmap();

            } catch (error) {
                console.error("Repo fetch failed:", error);
                repoSelect.innerHTML = `<option value="${currentSelection}">${currentSelection}</option>`;
                showStatus('warning', 'Repo åˆ—è¡¨åŒæ­¥å¤±æ•—ï¼Œè«‹ç¢ºèª Token æ¬Šé™ã€‚ç›®å‰ä½¿ç”¨å¿«å–è¨­å®šã€‚');
                await fetchBranches(token);
            } finally {
                repoSelect.disabled = false;
            }
        }

        async function fetchBranches(token) {
            const repoSelect = document.getElementById('repo');
            const branchSelect = document.getElementById('branch');
            const repoName = repoSelect.value;

            if(!token || !repoName) return;

            branchSelect.disabled = true;
            branchSelect.innerHTML = '<option>è®€å–åˆ†æ”¯ä¸­...</option>';

            try {
                const selectedOption = repoSelect.options[repoSelect.selectedIndex];
                let defaultBranch = selectedOption ? selectedOption.dataset.defaultBranch : 'master';

                const response = await fetch(`https://api.github.com/repos/${repoName}/branches`, {
                     headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if(!response.ok) throw new Error('ç„¡æ³•è®€å–åˆ†æ”¯');
                const branches = await response.json();

                branchSelect.innerHTML = '';
                branches.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b.name;
                    opt.textContent = b.name;
                    branchSelect.appendChild(opt);
                });

                const savedBranch = ConfigDB.get(ConfigDB.KEYS.BRANCH);
                const savedRepo = ConfigDB.get(ConfigDB.KEYS.REPO);
                
                let targetBranch = defaultBranch;

                if (savedRepo === repoName && savedBranch && branches.some(b => b.name === savedBranch)) {
                    targetBranch = savedBranch;
                } else if (branches.some(b => b.name === defaultBranch)) {
                    targetBranch = defaultBranch;
                } else if (branches.length > 0) {
                    targetBranch = branches[0].name;
                }
                
                branchSelect.value = targetBranch;
                
                if(document.getElementById('saveToken').checked) {
                    ConfigDB.save(ConfigDB.KEYS.BRANCH, targetBranch);
                    ConfigDB.save(ConfigDB.KEYS.REPO, repoName);
                }

            } catch (e) {
                console.error(e);
                branchSelect.innerHTML = `<option value="master">master (è®€å–å¤±æ•—)</option>`;
            } finally {
                branchSelect.disabled = false;
            }
        }

        function setupRealtimeSync(inputId, checkboxId, storageKey) {
            const inputEl = document.getElementById(inputId);
            const checkboxEl = document.getElementById(checkboxId);
            if(!inputEl || !checkboxEl) return;

            const syncLogic = () => {
                if (checkboxEl.checked) {
                    const val = inputEl.value.trim();
                    if(val) {
                        ConfigDB.save(storageKey, val);
                    }
                } else {
                    ConfigDB.remove(storageKey);
                }
            };

            inputEl.addEventListener('input', () => { if (checkboxEl.checked) syncLogic(); });
            inputEl.addEventListener('change', () => { if (checkboxEl.checked) syncLogic(); });
            checkboxEl.addEventListener('change', syncLogic);
        }
        
        function toggleTokenVisibility(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }


        // --- 2. æª”æ¡ˆç€è¦½å™¨é‚è¼¯ (VS Code Tree View Style) ---

        async function initTreeBrowser() {
            const inputs = getInputs(false); 
            if (!inputs.token || !inputs.repo) {
                showStatus('error', 'è«‹è¼¸å…¥ GitHub Token å’Œ Repository åç¨±ä»¥è®€å–åˆ—è¡¨');
                return;
            }

            const listContainer = document.getElementById('fileList');
            const repoDisplay = document.getElementById('repoNameDisplay');
            
            listContainer.innerHTML = '<div class="flex justify-center py-4"><span class="spinner"></span></div>';
            repoDisplay.textContent = inputs.repo;

            try {
                const items = await fetchItemsFromApi(inputs.repo, inputs.token, inputs.branch, '');
                
                listContainer.innerHTML = ''; 

                items.sort(sortItems);

                items.forEach(item => {
                    listContainer.appendChild(createTreeNode(item, 0));
                });
                
                // Also refresh heatmap just in case
                updateContributionHeatmap();

            } catch (error) {
                listContainer.innerHTML = `<div class="text-red-400 text-center text-sm p-2">è®€å–å¤±æ•—<br>${error.message}</div>`;
            }
        }

        async function fetchItemsFromApi(repo, token, branch, path) {
            const timestamp = new Date().getTime();
            const url = `https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}&_t=${timestamp}`;
            
            const response = await fetch(url, {
                headers: { 
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });

            if (!response.ok) throw new Error(`API Error: ${response.status}`);
            
            const data = await response.json();
            return Array.isArray(data) ? data : [data];
        }

        function sortItems(a, b) {
            if (a.type === b.type) return a.name.localeCompare(b.name);
            return a.type === 'dir' ? -1 : 1;
        }

        function createTreeNode(item, level) {
            const container = document.createElement('div');
            
            const nodeRow = document.createElement('div');
            nodeRow.className = 'tree-node rounded';
            nodeRow.style.paddingLeft = `${level * 16 + 4}px`; 
            
            const toggleIcon = document.createElement('div');
            toggleIcon.className = 'tree-toggle-icon';
            if (item.type === 'dir') {
                toggleIcon.innerHTML = '<i class="fa-solid fa-chevron-right"></i>';
            } else {
                toggleIcon.classList.add('invisible');
                toggleIcon.innerHTML = '<i class="fa-solid fa-chevron-right"></i>';
            }
            nodeRow.appendChild(toggleIcon);

            const fileIcon = document.createElement('div');
            fileIcon.className = 'tree-icon';
            const iconClass = item.type === 'dir' ? 'fa-folder text-yellow-400' : getFileIcon(item.name);
            fileIcon.innerHTML = `<i class="fa-solid ${iconClass}"></i>`;
            nodeRow.appendChild(fileIcon);

            const label = document.createElement('span');
            label.className = 'tree-label ml-1';
            label.textContent = item.name;
            nodeRow.appendChild(label);

            container.appendChild(nodeRow);

            let childrenContainer = null;
            if (item.type === 'dir') {
                childrenContainer = document.createElement('div');
                childrenContainer.className = 'tree-children hidden';
                container.appendChild(childrenContainer);
            }

            nodeRow.onclick = async (e) => {
                e.stopPropagation();

                if (currentlySelectedNode) {
                    currentlySelectedNode.classList.remove('selected');
                }
                nodeRow.classList.add('selected');
                currentlySelectedNode = nodeRow;

                if (item.type === 'file') {
                    document.getElementById('targetPath').value = item.path;
                    
                } else if (item.type === 'dir') {
                    const inputs = getInputs(false);
                    
                    if (childrenContainer.innerHTML === '') {
                        toggleIcon.innerHTML = '<div class="tree-spinner"></div>';
                        
                        try {
                            const subItems = await fetchItemsFromApi(inputs.repo, inputs.token, inputs.branch, item.path);
                            subItems.sort(sortItems);
                            
                            subItems.forEach(subItem => {
                                childrenContainer.appendChild(createTreeNode(subItem, level + 1));
                            });
                            
                            childrenContainer.classList.remove('hidden');
                            toggleIcon.classList.add('expanded');
                            toggleIcon.innerHTML = '<i class="fa-solid fa-chevron-right"></i>';
                            
                            fileIcon.innerHTML = '<i class="fa-solid fa-folder-open text-yellow-400"></i>';

                        } catch (err) {
                            toggleIcon.innerHTML = '<i class="fa-solid fa-triangle-exclamation text-red-500"></i>';
                            showStatus('error', `è®€å–è³‡æ–™å¤¾å¤±æ•—: ${err.message}`);
                        }
                    } else {
                        const isHidden = childrenContainer.classList.contains('hidden');
                        if (isHidden) {
                            childrenContainer.classList.remove('hidden');
                            toggleIcon.classList.add('expanded');
                            fileIcon.innerHTML = '<i class="fa-solid fa-folder-open text-yellow-400"></i>';
                        } else {
                            childrenContainer.classList.add('hidden');
                            toggleIcon.classList.remove('expanded');
                            fileIcon.innerHTML = '<i class="fa-solid fa-folder text-yellow-400"></i>';
                        }
                    }
                }
            };

            return container;
        }

        function getFileIcon(filename) {
            if (filename.endsWith('.html')) return 'fa-html5 text-orange-500';
            if (filename.endsWith('.js')) return 'fa-js text-yellow-300';
            if (filename.endsWith('.css')) return 'fa-css3-alt text-blue-500';
            if (filename.match(/\.(jpg|jpeg|png|gif|svg)$/i)) return 'fa-image text-purple-400';
            if (filename.endsWith('.md')) return 'fa-markdown text-white';
            if (filename.endsWith('.json')) return 'fa-file-code text-yellow-500';
            if (filename.endsWith('.py')) return 'fa-python text-blue-300';
            return 'fa-file-lines text-gray-400';
        }

        // --- 3. æª”æ¡ˆè™•ç† (Drag & Drop, é¸æ“‡, é è¦½) ---

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').classList.remove('drag-over');
        }

        function handleFileDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').classList.remove('drag-over');
            
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files && files.length > 0) {
                handleFileSelect({ files: files });
            }
        }

        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;

            selectedFile = file;
            const fileNameDisplay = document.getElementById('fileNameDisplay');
            const previewImg = document.getElementById('imagePreview');
            const previewText = document.getElementById('textPreviewIcon');
            const noPreview = document.getElementById('noPreviewText');
            const clearBtn = document.getElementById('clearFileBtn');
            const targetPath = document.getElementById('targetPath');

            fileNameDisplay.textContent = file.name;
            fileNameDisplay.classList.add('text-blue-300');
            clearBtn.classList.remove('hidden');
            noPreview.classList.add('hidden');

            const currentVal = targetPath.value;
            const lastSlashIndex = currentVal.lastIndexOf('/');
            
            if (lastSlashIndex !== -1) {
                const dir = currentVal.substring(0, lastSlashIndex + 1);
                targetPath.value = dir + file.name;
            } else {
                if (targetPath.value === '') {
                    targetPath.value = file.name;
                }
            }

            const reader = new FileReader();
            
            if (file.type.startsWith('image/')) {
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    previewImg.classList.remove('hidden');
                    previewText.classList.add('hidden');
                    selectedFileBase64 = e.target.result.split(',')[1];
                    enableGemini(false); 
                };
                reader.readAsDataURL(file);
            } else {
                previewImg.classList.add('hidden');
                previewText.classList.remove('hidden');
                
                reader.onload = (e) => {
                    selectedFileBase64 = btoa(unescape(encodeURIComponent(e.target.result)));
                    enableGemini(true);
                };
                reader.readAsText(file);
            }
        }

        function clearFileSelection(e) {
            if(e) e.stopPropagation(); 
            document.getElementById('fileInput').value = '';
            selectedFile = null;
            selectedFileBase64 = null;
            document.getElementById('fileNameDisplay').textContent = 'é»æ“Šæˆ–æ‹–æ›³æª”æ¡ˆè‡³æ­¤';
            document.getElementById('fileNameDisplay').classList.remove('text-blue-300');
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('textPreviewIcon').classList.add('hidden');
            document.getElementById('noPreviewText').classList.remove('hidden');
            document.getElementById('clearFileBtn').classList.add('hidden');
            document.getElementById('geminiOutputContainer').classList.add('hidden'); 
            enableGemini(false);
        }

        // --- 4. ä¸Šå‚³èˆ‡åˆªé™¤é‚è¼¯ ---

        function isTextFile(filename) {
            return /\.(txt|md|html|css|js|json|py|java|cpp|ts|xml|csv|rb|go|php)$/i.test(filename);
        }

        async function performAction(action) {
            const inputs = getInputs(true);
            if (!inputs) return;
            
            const btn = action === 'upload' ? document.getElementById('btnUpload') : document.getElementById('btnDelete');
            const spinner = action === 'upload' ? document.getElementById('spinnerUpload') : document.getElementById('spinnerDelete');
            
            if (action === 'upload' && !selectedFileBase64) {
                showStatus('error', 'è«‹å…ˆé¸æ“‡è¦ä¸Šå‚³çš„æª”æ¡ˆ');
                return;
            }

            btn.disabled = true;
            spinner.classList.remove('hidden');
            showStatus('info', 'æ­£åœ¨è™•ç†è«‹æ±‚...');

            try {
                // 1. Check File Existence (GET SHA)
                const ts = new Date().getTime();
                const apiUrl = `https://api.github.com/repos/${inputs.repo}/contents/${inputs.path}?ref=${inputs.branch}&_t=${ts}`;
                const checkRes = await fetch(apiUrl, {
                    headers: { 'Authorization': `token ${inputs.token}` }
                });

                let sha = null;
                let remoteContentBase64 = null;

                if (checkRes.ok) {
                    const data = await checkRes.json();
                    sha = data.sha;
                    remoteContentBase64 = data.content; 
                }

                if (action === 'upload') {
                    
                    if (sha) {
                        const cleanRemoteBase64 = remoteContentBase64.replace(/\n/g, '');
                        
                        if (cleanRemoteBase64 === selectedFileBase64) {
                            showStatus('info', 'æª”æ¡ˆå…§å®¹æœªè®Šæ›´ï¼Œç„¡éœ€ä¸Šå‚³æ›´æ–°ã€‚');
                            btn.disabled = false;
                            spinner.classList.add('hidden');
                            return; 
                        }

                        if (inputs.message === DEFAULT_UPLOAD_MESSAGE && inputs.geminiApiKey && isTextFile(inputs.path)) {
                            showStatus('info', 'å…§å®¹æœ‰è®Šå‹•ï¼Œæ­£åœ¨ä½¿ç”¨ AI åˆ†æå·®ç•°ä¸¦ç”Ÿæˆ Commit è¨Šæ¯...');
                            try {
                                const remoteContent = decodeURIComponent(escape(atob(cleanRemoteBase64)));
                                const localContent = decodeURIComponent(escape(atob(selectedFileBase64)));
                                const newCommitMessage = await generateDiffCommitMessage(inputs.geminiApiKey, remoteContent, localContent, inputs.path);
                                inputs.message = newCommitMessage; 
                                document.getElementById('commitMessage').value = newCommitMessage;
                            } catch (geminiError) {
                                console.error("Gemini Diff failed:", geminiError);
                            }
                        }
                    } else if (inputs.message === DEFAULT_UPLOAD_MESSAGE && inputs.geminiApiKey && isTextFile(inputs.path)) {
                        showStatus('info', 'æ–°æª”æ¡ˆä¸Šå‚³ä¸­ï¼Œæ­£åœ¨ä½¿ç”¨ AI æ‘˜è¦å…§å®¹ä¸¦ç”Ÿæˆ Commit è¨Šæ¯...');
                        try {
                            const localContent = decodeURIComponent(escape(atob(selectedFileBase64)));
                            const newCommitMessage = await generateNewFileCommitMessage(inputs.geminiApiKey, localContent, inputs.path);
                            inputs.message = newCommitMessage;
                            document.getElementById('commitMessage').value = newCommitMessage;
                        } catch (geminiError) {
                            console.error("Gemini New File failed:", geminiError);
                        }
                    }

                    // æº–å‚™ Payload
                    let finalBase64 = selectedFileBase64;
                    if (isTextFile(inputs.path)) {
                        let content = decodeURIComponent(escape(atob(selectedFileBase64)));
                        const tokenRegex = /(<input[^>]*value=")(ghp_[^"]*)("[^>]*>)/gi;
                        if (tokenRegex.test(content)) {
                            content = content.replace(tokenRegex, '$1""$3'); 
                            finalBase64 = btoa(unescape(encodeURIComponent(content)));
                            console.log('HTML Token cleaned.');
                        }
                    }

                    var method = 'PUT';
                    var payload = {
                        message: inputs.message, 
                        branch: inputs.branch,
                        content: finalBase64 
                    };
                    if (sha) payload.sha = sha;

                } else { 
                    if (!sha) throw new Error('æª”æ¡ˆä¸å­˜åœ¨ï¼Œç„¡æ³•åˆªé™¤');
                    var method = 'DELETE';
                    var payload = {
                        message: inputs.message,
                        branch: inputs.branch,
                        sha: sha
                    };
                }


                // 3. Execute
                const executeUrl = `https://api.github.com/repos/${inputs.repo}/contents/${inputs.path}`;
                const res = await fetch(executeUrl, {
                    method: method,
                    headers: {
                        'Authorization': `token ${inputs.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const resultData = await res.json();

                if (res.ok) {
                    const actionName = action === 'upload' ? (sha ? 'æ›´æ–°' : 'ä¸Šå‚³') : 'åˆªé™¤';
                    showStatus('success', `æª”æ¡ˆ${actionName}æˆåŠŸï¼ Commit SHA: ${resultData.commit.sha.substring(0,7)}`);
                    
                    initTreeBrowser(); 

                    if (action === 'upload') {
                        const rawUrl = `https://github.com/${inputs.repo}/raw/${inputs.branch}/${inputs.path}`;
                        document.getElementById('resultUrl').value = rawUrl;
                        document.getElementById('successLinks').classList.remove('hidden');
                    } else {
                        document.getElementById('successLinks').classList.add('hidden');
                        clearFileSelection();
                        document.getElementById('targetPath').value = '';
                    }

                    // æ›´æ–° Heatmap
                    updateContributionHeatmap();

                } else {
                    throw new Error(resultData.message || res.statusText);
                }

            } catch (error) {
                showStatus('error', `æ“ä½œå¤±æ•—: ${error.message}`);
            } finally {
                btn.disabled = false;
                spinner.classList.add('hidden');
            }
        }

        async function generateDiffCommitMessage(apiKey, oldContent, newContent, filePath) {
            const systemInstruction = "You are a Git commit message generator. Output ONLY the raw commit message text. No markdown or quotation marks.";
            const MAX_CONTEXT_LENGTH = 4000;
            const diffContext = `File: ${filePath}\n\n--- OLD CONTENT ---\n${oldContent.substring(0, MAX_CONTEXT_LENGTH)}\n\n--- NEW CONTENT ---\n${newContent.substring(0, MAX_CONTEXT_LENGTH)}`;
            const userQuery = `è«‹æ ¹æ“šå…§å®¹å·®ç•°ï¼Œç”Ÿæˆä¸€å€‹ç¹é«”ä¸­æ–‡ Git Commit Message (ä¸è¶…é 30 å€‹å­—ç¬¦)ã€‚`;
            const result = await callGeminiApi(systemInstruction, userQuery, diffContext, apiKey);
            return result.replace(/^['"`]+|['"`]+$/g, '').trim();
        }
        
        async function generateNewFileCommitMessage(apiKey, newContent, filePath) {
            const systemInstruction = "You are a Git commit message generator. Output ONLY the raw commit message text. No markdown or quotation marks.";
            const MAX_CONTEXT_LENGTH = 4000;
            const context = `File: ${filePath}\n\n--- FILE CONTENT ---\n${newContent.substring(0, MAX_CONTEXT_LENGTH)}`;
            const userQuery = `é€™æ˜¯ä¸€å€‹æ–°æª”æ¡ˆã€‚è«‹æ ¹æ“šå…§å®¹ï¼Œç”Ÿæˆä¸€å€‹ç¹é«”ä¸­æ–‡ Git Commit Message (ä¸è¶…é 30 å€‹å­—ç¬¦)ï¼Œé–‹é ­ä½¿ç”¨ 'feat:' æˆ– 'add:'ã€‚`;
            const result = await callGeminiApi(systemInstruction, userQuery, context, apiKey);
            return result.replace(/^['"`]+|['"`]+$/g, '').trim();
        }


        // --- 5. Gemini æ·±åº¦æ•´åˆåŠŸèƒ½ ---

        function enableGemini(enabled) {
            const hasKey = !!document.getElementById('geminiApiKey').value.trim();
            const finalState = enabled && hasKey;

            document.getElementById('btnSummary').disabled = !finalState;
            document.getElementById('btnCommitMsg').disabled = !finalState;
            document.getElementById('btnCodeReview').disabled = !finalState;
            document.getElementById('geminiOutputContainer').classList.add('hidden');
        }
        
        async function suggestPathWithAI() {
            const inputs = getInputs(false);
            const apiKey = document.getElementById('geminiApiKey').value.trim();
            
            if (!selectedFile) {
                showStatus('warning', 'è«‹å…ˆé¸æ“‡è¦ä¸Šå‚³çš„æª”æ¡ˆ');
                return;
            }
            if (!apiKey) {
                showStatus('error', 'è«‹å…ˆè¨­å®š Gemini API Key');
                return;
            }
            if (!inputs.token || !inputs.repo) {
                showStatus('error', 'è«‹å…ˆè¨­å®š GitHub Token å’Œ Repository ä»¥ä¾¿åˆ†æè³‡æ–™å¤¾çµæ§‹');
                return;
            }

            const btn = document.getElementById('btnAiPath');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> åˆ†æä¸­...';

            try {
                let folderList = [];
                try {
                    const items = await fetchItemsFromApi(inputs.repo, inputs.token, inputs.branch, '');
                    folderList = items.filter(i => i.type === 'dir').map(i => i.name);
                } catch (e) {
                    console.warn("Could not fetch repo structure, proceeding with generic advice.", e);
                }

                const folderContext = folderList.length > 0 
                    ? `Current top-level folders in repo: ${folderList.join(', ')}` 
                    : "Current repo structure is unknown.";
                
                const systemPrompt = "You are a helpful GitHub repository file organizer. Respond with ONLY the path string.";
                const userQuery = `I want to push a file named "${selectedFile.name}" to my repo.
                ${folderContext}
                
                Based on the file extension and name, suggests the best relative path to store this file.
                - If it fits in an existing folder, use that folder (e.g. 'src/${selectedFile.name}').
                - If it needs a new folder, suggest a logical name (e.g., 'src/', 'docs/', 'images/', 'components/').
                - If it is a root level file (like README.md, LICENSE), put it in root (just the filename).
                
                Reply with ONLY the full relative path including the filename. Do not add any markdown, quotes or explanation.`;

                let suggestedPath = await callGeminiApi(systemPrompt, userQuery, "", apiKey);
                
                suggestedPath = suggestedPath.replace(/['"`]/g, '').trim();
                if (suggestedPath.startsWith('/')) suggestedPath = suggestedPath.substring(1);

                document.getElementById('targetPath').value = suggestedPath;
                showStatus('success', `AI å·²å»ºè­°è·¯å¾‘: ${suggestedPath}`);
                
                const input = document.getElementById('targetPath');
                input.classList.add('ring-2', 'ring-indigo-500');
                setTimeout(() => input.classList.remove('ring-2', 'ring-indigo-500'), 2000);

            } catch (err) {
                showStatus('error', `AI æ¨è–¦å¤±æ•—: ${err.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function runGeminiTask(task) {
            const file = selectedFile;
            const apiKey = document.getElementById('geminiApiKey').value.trim();
            if (!file || !apiKey) return;

            const outputContainer = document.getElementById('geminiOutputContainer');
            const outputDiv = document.getElementById('geminiOutput');
            const title = document.getElementById('aiOutputTitle');
            
            outputContainer.classList.remove('hidden');
            
            const localText = await new Promise(resolve => {
                const r = new FileReader();
                r.onload = e => resolve(e.target.result);
                r.readAsText(file);
            });

            let prompt = "";
            let systemInstruction = "";
            let contextText = localText;

            try {
                if (task === 'summary') {
                    outputDiv.innerHTML = '<div class="flex items-center gap-2"><span class="spinner" style="width:16px;height:16px;"></span> <span class="text-gray-400">Gemini æ­£åœ¨åˆ†ææª”æ¡ˆçµæ§‹...</span></div>';
                    title.textContent = "ğŸ“„ æª”æ¡ˆæ‘˜è¦";
                    systemInstruction = "You are a helpful summary assistant. Respond in Traditional Chinese.";
                    prompt = "è«‹ç”¨ç¹é«”ä¸­æ–‡ï¼Œåˆ—é»ç¸½çµé€™ä»½ç¨‹å¼ç¢¼æˆ–æ–‡ä»¶çš„ä¸»è¦åŠŸèƒ½èˆ‡æ¶æ§‹ï¼Œè«‹ä½¿ç”¨ Markdown æ ¼å¼ã€‚";
                    
                } else if (task === 'commit') {
                    outputDiv.innerHTML = '<div class="flex items-center gap-2"><span class="spinner" style="width:16px;height:16px;"></span> <span class="text-gray-400">æ­£åœ¨æ¯”å°é ç«¯æª”æ¡ˆä¸¦ç”Ÿæˆæ‘˜è¦...</span></div>';
                    title.textContent = "ğŸ’¬ å·®ç•°æ‘˜è¦èˆ‡ Commit å»ºè­°";
                    
                    const inputs = getInputs(false); 
                    let oldContent = "";
                    let isNewFile = true;

                    if (inputs && inputs.token && inputs.repo && inputs.path) {
                        try {
                            const ts = new Date().getTime();
                            const apiUrl = `https://api.github.com/repos/${inputs.repo}/contents/${inputs.path}?ref=${inputs.branch}&_t=${ts}`;
                            const res = await fetch(apiUrl, { headers: { 'Authorization': `token ${inputs.token}` } });
                            if (res.ok) {
                                const data = await res.json();
                                oldContent = decodeURIComponent(escape(atob(data.content.replace(/\n/g, ''))));
                                isNewFile = false;
                            }
                        } catch (e) {
                            console.log("Remote file fetch failed (likely new file):", e);
                        }
                    }

                    systemInstruction = "You are a professional Git assistant. Analyze code differences. Respond in Traditional Chinese.";
                    
                    /* --- ä¿®æ”¹éƒ¨åˆ†ï¼šæ ¹æ“šæ–°èˆŠæª”æ¡ˆç‹€æ…‹å‹•æ…‹ç”Ÿæˆ Prompt --- */
                    if (isNewFile) {
                        prompt = `é€™æ˜¯ä¸€å€‹æ–°æª”æ¡ˆã€‚è«‹æ ¹æ“šå…§å®¹ç”Ÿæˆä¸€å€‹é«˜è³ªé‡çš„ç¹é«”ä¸­æ–‡ Git Commit Message (50å­—å…§)ã€‚
                        
                        é‡è¦è¦å‰‡ï¼šå› ç‚ºæ˜¯æ–°æª”æ¡ˆï¼Œ**è«‹å‹¿**ç”Ÿæˆ Diff Summary æˆ–ä»»ä½•æ¢åˆ—å¼æ‘˜è¦ã€‚åªè¼¸å‡º Commit Message å³å¯ã€‚

                        è¼¸å‡ºæ ¼å¼ï¼š
                        ---COMMIT_MSG_START---
                        (Commit Message)
                        ---COMMIT_MSG_END---
                        `;
                    } else {
                        prompt = `é€™æ˜¯ç¾æœ‰æª”æ¡ˆçš„ä¿®æ”¹ã€‚è«‹è©³ç´°æ¯”è¼ƒ 'OLD_CONTENT' (èˆŠç‰ˆæœ¬) èˆ‡ 'NEW_CONTENT' (æ–°ç‰ˆæœ¬) çš„å…§å®¹å·®ç•° (Diff)ã€‚

                        é‡è¦å®šç¾©ï¼š
                        - OLD_CONTENT: é ç«¯èˆŠç¨‹å¼ç¢¼ (Before)
                        - NEW_CONTENT: æœ¬åœ°æ–°ç¨‹å¼ç¢¼ (After)
                        - **æ–°å¢**: å­˜åœ¨æ–¼ NEW ä½†ä¸å­˜åœ¨æ–¼ OLD çš„å…§å®¹ã€‚
                        - **åˆªé™¤**: å­˜åœ¨æ–¼ OLD ä½†ä¸å­˜åœ¨æ–¼ NEW çš„å…§å®¹ã€‚

                        ä»»å‹™ç›®æ¨™ï¼š
                        1. **Diff åˆ†æ**: è­˜åˆ¥å‡ºæœ€å…·æ„ç¾©çš„ä¿®æ”¹ã€æ–°å¢ã€æˆ–åˆªé™¤çš„ç¨‹å¼ç¢¼/æ–‡æœ¬æ®µè½ã€‚ç¢ºä¿ä¸è¦æåã€Œæ–°å¢ã€èˆ‡ã€Œåˆªé™¤ã€ã€‚
                        2. **æ¢åˆ—å¼æ‘˜è¦**: å°‡é€™äº›è®Šå‹•é»è½‰åŒ–ç‚º"è‡ªç„¶èªè¨€"çš„æ¢åˆ—å¼æ‘˜è¦ (Markdown Bullet Points)ã€‚
                        3. **Commit Message**: æ ¹æ“šè®Šå‹•å…§å®¹ï¼Œç”Ÿæˆä¸€å€‹é«˜å“è³ªçš„ Commit Message æ¨™é¡Œ (50å­—å…§)ã€‚

                        è¼¸å‡ºæ ¼å¼è«‹åš´æ ¼éµå®ˆï¼š
                        ---COMMIT_MSG_START---
                        (Commit Message)
                        ---COMMIT_MSG_END---

                        ### è®Šæ›´æ‘˜è¦
                        (åœ¨æ­¤è™•åˆ—å‡º Diff åˆ†æå¾Œçš„è‡ªç„¶èªè¨€æ¢åˆ—å¼æ‘˜è¦)
                        `;
                    }
                    /* --- ä¿®æ”¹çµæŸ --- */
                    
                    const MAX_LEN = 15000;
                    contextText = `File Path: ${inputs ? inputs.path : file.name}\n\n--- OLD_CONTENT ---\n${oldContent.substring(0, MAX_LEN)}\n\n--- NEW_CONTENT ---\n${localText.substring(0, MAX_LEN)}`;
                
                } else if (task === 'review') {
                    outputDiv.innerHTML = '<div class="flex items-center gap-2"><span class="spinner" style="width:16px;height:16px;"></span> <span class="text-gray-400">æ­£åœ¨é€²è¡Œä»£ç¢¼å¯©æŸ¥...</span></div>';
                    title.textContent = "âœ¨ æ™ºèƒ½ä»£ç¢¼å¯©æŸ¥";
                    systemInstruction = "You are a senior software engineer conducting a code review. Be constructive, strict but polite. Respond in Traditional Chinese using Markdown.";
                    prompt = `è«‹å°ä»¥ä¸‹ä»£ç¢¼é€²è¡Œ Code Reviewã€‚è«‹åŒ…å«ï¼š
1. **æ•´é«”è©•åˆ†** (0-10 åˆ†)
2. **æ½›åœ¨ Bug èˆ‡å®‰å…¨æ€§é¢¨éšª** (å¦‚æœæœ‰çš„è©±)
3. **å„ªåŒ–å»ºè­°** (æ•ˆèƒ½ã€å¯è®€æ€§)
4. **é‡æ§‹ç¯„ä¾‹** (é‡å°é—œéµéƒ¨åˆ†æä¾›æ›´å¥½çš„å¯«æ³•)
Code to review:`; 
                }

                const result = await callGeminiApi(systemInstruction, prompt, contextText, apiKey);
                
                if (task === 'commit') {
                    const msgMatch = result.match(/---COMMIT_MSG_START---([\s\S]*?)---COMMIT_MSG_END---/);
                    let commitMsg = "Update file";
                    let explanation = result;

                    if (msgMatch) {
                        commitMsg = msgMatch[1].trim();
                        explanation = result.replace(/---COMMIT_MSG_START---[\s\S]*?---COMMIT_MSG_END---/, '').trim();
                    }

                    document.getElementById('commitMessage').value = commitMsg;
                    
                    /* --- ä¿®æ”¹ï¼šè‹¥æ‘˜è¦ç‚ºç©º (æ–°æª”æ¡ˆ)ï¼Œéš±è—ä¸‹æ–¹çš„èªªæ˜å€å¡Š --- */
                    if (explanation && explanation.length > 5) {
                         outputDiv.innerHTML = `
                            <div class="mb-3 p-2 bg-green-900/30 border border-green-500/30 rounded text-xs text-green-300">
                                <i class="fa-solid fa-check-circle mr-1"></i> å·²è‡ªå‹•å¡«å…¥æ¨™é¡Œ: <b>${commitMsg}</b>
                            </div>
                            <div class="markdown-body text-sm">${marked.parse(explanation)}</div>
                            <div class="mt-2 text-center text-xs text-gray-500">â†‘ æ‚¨å¯ä»¥é¸å–ä¸¦è¤‡è£½ä¸Šæ–¹çš„æ‘˜è¦ä½œç‚ºè©³ç´°æè¿°</div>
                        `;
                    } else {
                        outputDiv.innerHTML = `
                            <div class="mb-3 p-2 bg-green-900/30 border border-green-500/30 rounded text-xs text-green-300">
                                <i class="fa-solid fa-check-circle mr-1"></i> å·²è‡ªå‹•å¡«å…¥æ¨™é¡Œ: <b>${commitMsg}</b>
                            </div>
                            <div class="text-center text-xs text-gray-500">(æ–°æª”æ¡ˆæ¨¡å¼ï¼šç„¡è®Šæ›´æ‘˜è¦)</div>
                        `;
                    }
                } else {
                    outputDiv.innerHTML = marked.parse(result);
                }

            } catch (error) {
                outputDiv.innerHTML = `<span class="text-red-400">AI è«‹æ±‚å¤±æ•—: ${error.message}</span>`;
            }
        }

        async function callGeminiApi(systemPrompt, userQuery, contextText = "", apiKey) {
            if (!apiKey) {
                throw new Error("Gemini API Key is missing.");
            }
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const finalPrompt = contextText ? `${userQuery}\n\nContent:\n${contextText.substring(0, 30000)}` : userQuery; 
            
            const payload = {
                contents: [{ parts: [{ text: finalPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            const maxRetries = 3;
            let attempt = 0;
            
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        if (response.status === 429) { 
                            throw new Error("Rate limit exceeded");
                        }
                        const errorData = await response.json();
                        const errorMessage = errorData.error?.message || `API Error: ${response.status}`;
                        throw new Error(errorMessage);
                    }

                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response generated.";
                } catch (e) {
                    attempt++;
                    console.warn(`Attempt ${attempt} failed: ${e.message}`);
                    if (attempt >= maxRetries) throw e;
                    await new Promise(r => setTimeout(r, 1000 * attempt)); 
                }
            }
        }

        // --- 6. Contribution Heatmap Logic (Gamified) ---
        
        async function updateContributionHeatmap() {
            const inputs = getInputs(false);
            const container = document.getElementById('contributionHeatmap');
            
            // Stats Elements
            const statStreak = document.getElementById('statStreak');
            const statMaxStreak = document.getElementById('statMaxStreak');
            const statTotal = document.getElementById('statTotal');
            const statRank = document.getElementById('statRank');
            const nextLevelMsg = document.getElementById('nextLevelMsg');

            if (!inputs.token || !inputs.repo) {
                container.innerHTML = 'è«‹å…ˆè¨­å®š Token èˆ‡ Repo ä»¥æª¢è¦–è²¢ç»åœ–';
                return;
            }

            container.innerHTML = '<span class="spinner" style="width:16px;height:16px;"></span> <span class="ml-2">è®€å–è²¢ç»æ•¸æ“š...</span>';

            try {
                // 1. Calculate Start Date (90 days ago)
                const today = new Date();
                const pastDate = new Date();
                pastDate.setDate(today.getDate() - 90);
                const sinceDate = pastDate.toISOString();

                // 2. Fetch Commits from GitHub API
                const url = `https://api.github.com/repos/${inputs.repo}/commits?since=${sinceDate}&per_page=100`;
                const response = await fetch(url, {
                    headers: { 
                        'Authorization': `token ${inputs.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) throw new Error('ç„¡æ³•è®€å– Commit ç´€éŒ„');
                const commits = await response.json();

                // 3. Process Data: Count commits per day
                const counts = {};
                commits.forEach(commit => {
                    const dateStr = commit.commit.author.date.split('T')[0]; // YYYY-MM-DD
                    counts[dateStr] = (counts[dateStr] || 0) + 1;
                });

                // 4. Calculate Advanced Stats
                const stats = calculateStats(counts);
                
                // Update UI Stats
                statStreak.textContent = `${stats.currentStreak} Days`;
                statMaxStreak.textContent = stats.maxStreak;
                statTotal.textContent = stats.total;
                
                // Gamification Rank
                const rankData = getGamifiedRank(stats.total);
                statRank.textContent = rankData.rank;
                nextLevelMsg.textContent = rankData.msg;

                // 5. Generate Grid
                renderHeatmapGrid(container, counts, 84); // 84 days = 12 weeks

            } catch (error) {
                console.error(error);
                container.innerHTML = `<span class="text-red-400">è®€å–å¤±æ•—: ${error.message}</span>`;
            }
        }
        
        function calculateStats(counts) {
            const today = new Date();
            let currentStreak = 0;
            let maxStreak = 0;
            let total = 0;
            let tempStreak = 0;
            
            // Helper to format date key
            const getDateKey = (d) => d.toISOString().split('T')[0];
            
            // Check Current Streak (starting from today backwards)
            // Note: If user hasn't committed TODAY yet, check YESTERDAY to keep streak alive.
            let d = new Date(today);
            let checkDate = getDateKey(d);
            
            if (!counts[checkDate]) {
                 // Try yesterday
                 d.setDate(d.getDate() - 1);
                 checkDate = getDateKey(d);
            }
            
            while (counts[checkDate] > 0) {
                currentStreak++;
                d.setDate(d.getDate() - 1);
                checkDate = getDateKey(d);
            }

            // Calculate Max Streak & Total over the 90 days window
            // We iterate all keys in data
            const sortedDates = Object.keys(counts).sort();
            
            if (sortedDates.length > 0) {
                // Determine streak continuity
                // Simple logic: iterate expected days range or just sort keys and check difference?
                // For simplicity on small dataset, let's iterate last 90 days logic:
                let scanDate = new Date();
                scanDate.setDate(scanDate.getDate() - 90);
                
                for(let i=0; i<=90; i++) {
                    const key = getDateKey(scanDate);
                    const count = counts[key] || 0;
                    total += count;
                    
                    if (count > 0) {
                        tempStreak++;
                    } else {
                        if (tempStreak > maxStreak) maxStreak = tempStreak;
                        tempStreak = 0;
                    }
                    scanDate.setDate(scanDate.getDate() + 1);
                }
                if (tempStreak > maxStreak) maxStreak = tempStreak;
            }

            return { currentStreak, maxStreak, total };
        }
        
        function getGamifiedRank(totalCommits) {
            if (totalCommits < 10) return { rank: "ğŸŒ± Novice", msg: "Start your journey!" };
            if (totalCommits < 30) return { rank: "ğŸ”¨ Builder", msg: "Keep building!" };
            if (totalCommits < 60) return { rank: "ğŸš€ Contributor", msg: "You're flying high!" };
            if (totalCommits < 100) return { rank: "ğŸ”¥ Code Ninja", msg: "Unstoppable!" };
            return { rank: "ğŸ‘‘ Git Legend", msg: "Maximum Respect!" };
        }

        function renderHeatmapGrid(container, data, totalDays) {
            container.innerHTML = '';
            
            const today = new Date();
            const endDate = new Date(today);
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - totalDays);
            
            // Adjust start date to previous Sunday
            while(startDate.getDay() !== 0) {
                startDate.setDate(startDate.getDate() - 1);
            }

            const tooltip = document.getElementById('heatmapTooltip');
            let currentWeekDiv = document.createElement('div');
            currentWeekDiv.className = 'heatmap-week';
            
            let currentDate = new Date(startDate);
            let dayCount = 0;
            
            // For animation delay
            let animationDelay = 0;

            while (currentDate <= endDate) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const count = data[dateStr] || 0;
                
                const level = count === 0 ? 0 :
                              count <= 2 ? 1 :
                              count <= 5 ? 2 :
                              count <= 10 ? 3 : 4;

                const dayDiv = document.createElement('div');
                dayDiv.className = `heatmap-day level-${level}`;
                
                // Animation Stagger
                dayDiv.style.animationDelay = `${animationDelay}ms`;
                animationDelay += 5; // increment delay

                // Tooltip
                dayDiv.onmouseenter = (e) => {
                    tooltip.innerHTML = `<strong>${dateStr}</strong><br>${count} contributions`;
                    tooltip.style.display = 'block';
                    const rect = dayDiv.getBoundingClientRect();
                    tooltip.style.left = `${rect.left - 40}px`;
                    tooltip.style.top = `${rect.top - 45}px`;
                };
                dayDiv.onmouseleave = () => {
                    tooltip.style.display = 'none';
                };

                currentWeekDiv.appendChild(dayDiv);
                
                currentDate.setDate(currentDate.getDate() + 1);
                dayCount++;

                if (dayCount % 7 === 0) {
                    container.appendChild(currentWeekDiv);
                    currentWeekDiv = document.createElement('div');
                    currentWeekDiv.className = 'heatmap-week';
                }
            }
            if (currentWeekDiv.hasChildNodes()) {
                container.appendChild(currentWeekDiv);
            }
            
            container.scrollLeft = container.scrollWidth;
        }

        // --- Helpers ---

        function getInputs(validateAll = true) {
            const token = document.getElementById('token').value.trim();
            const geminiApiKey = document.getElementById('geminiApiKey').value.trim();
            const repo = document.getElementById('repo').value.trim();
            const branch = document.getElementById('branch').value.trim();
            const path = document.getElementById('targetPath').value.trim();
            const message = document.getElementById('commitMessage').value.trim();

            if (validateAll && (!token || !repo || !branch || !path || !message)) {
                showStatus('error', 'è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½ (Token, Repo, Branch, Path, Message)');
                return null;
            }
            return { token, geminiApiKey, repo, branch, path, message };
        }

        function showStatus(type, msg) {
            const el = document.getElementById('statusArea');
            const title = document.getElementById('statusTitle');
            const body = document.getElementById('statusMsg');
            const icon = document.getElementById('statusIcon');

            el.classList.remove('hidden', 'bg-red-900/50', 'bg-green-900/50', 'bg-blue-900/50', 'border-red-500', 'border-green-500', 'border-blue-500');
            icon.className = 'mt-1 mr-3 fa-solid';

            if (type === 'error') {
                el.classList.add('bg-red-900/50', 'border-red-500', 'text-red-200');
                icon.classList.add('fa-circle-xmark');
                title.textContent = 'ç™¼ç”ŸéŒ¯èª¤';
            } else if (type === 'success') {
                el.classList.add('bg-green-900/50', 'border-green-500', 'text-green-200');
                icon.classList.add('fa-circle-check');
                title.textContent = 'æ“ä½œæˆåŠŸ';
                document.getElementById('successLinks').classList.remove('hidden');
            } else if (type === 'info' || type === 'warning') {
                el.classList.add('bg-blue-900/50', 'border-blue-500', 'text-blue-200');
                icon.classList.add('fa-spinner', 'fa-spin');
                title.textContent = 'è™•ç†ä¸­';
                document.getElementById('successLinks').classList.add('hidden');
                if (type === 'warning') {
                    icon.classList.replace('fa-spinner', 'fa-triangle-exclamation');
                    icon.classList.remove('fa-spin');
                    title.textContent = 'è­¦å‘Š';
                } else if (type === 'info') {
                    title.textContent = 'è™•ç†ä¸­';
                }
            }
            body.textContent = msg;
            el.classList.remove('hidden');
        }

        function copyUrl() {
            const input = document.getElementById('resultUrl');
            input.select();
            document.execCommand('copy');
            const btn = input.nextElementSibling;
            const originalText = btn.textContent;
            btn.textContent = 'OK!';
            setTimeout(() => btn.textContent = originalText, 1500);
        }
    </script>
</body>
</html>