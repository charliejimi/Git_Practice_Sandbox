<!-- Chosen Palette: Calm Harmony (bg-slate-50, text-slate-700, accent-emerald-600) -->
<!-- Application Structure Plan: A tab-based SPA structure was chosen. The tabs ("ç¸½è¦½", "è‡ªç„¶å¾ªç’°", "è£½é€ æµç¨‹", "ç³»çµ±æµç¨‹") directly correspond to the major categories of IELTS process diagrams. This design allows the user to easily isolate and study one category at a time, which is ideal for focused learning. Within each tab, an accordion-style interaction reveals real-life analogies. This 'click-to-reveal' mechanic encourages active exploration rather than passive reading and directly links the abstract IELTS task to a tangible life experience, which was the core of the user's request. New LLM-powered sections were added to each tab for vocabulary expansion, prompt generation, and Image Analysis. -->
<!-- Visualization & Content Choices: Report Info: Analysis of IELTS process questions. Goal: Show the *flow* of each process. Viz/Presentation Method: Text-based, responsive flowcharts using structured HTML (flexbox) and Unicode arrows (â†’). Interaction: Accordion toggles to reveal detailed descriptions and vocabulary for each analogy. LLM Interaction: Two new buttons trigger Gemini API calls for vocabulary generation and practice prompt generation (Text Gen), one button for Image Analysis (Multimodal Gen), and one button for TTS (Audio Gen). Justification: This method (HTML diagrams + LLM enhancements) is chosen to maximize practical learning tools. It avoids all banned libraries (SVG, Mermaid) as required. -->
<!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS æµç¨‹åœ–æƒ…å¢ƒåˆ†æå™¨ (å«åœ–åƒåˆ†æ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .nav-tab.active {
            background-color: #059669; /* emerald-600 */
            color: white;
            border-color: #059669;
        }
        .nav-tab {
            transition: all 0.3s ease;
        }
        .analogy-detail {
            transition: all 0.5s ease-in-out;
            overflow: hidden;
        }
        /* Style for Markdown list output from LLM */
        .markdown-output ul {
            list-style-type: disc;
            margin-left: 1.5rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .markdown-output h3 {
            font-weight: 600;
            font-size: 1.125rem; /* lg */
            color: #065F46; /* emerald-800 */
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        /* Style for image preview */
        .image-preview-container img {
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-700">

    <div id="loading-indicator" class="fixed inset-0 bg-slate-50/80 backdrop-blur-sm flex justify-center items-center z-50 hidden">
        <div class="text-emerald-600 text-xl font-semibold p-4 rounded-lg bg-white shadow-xl flex items-center space-x-3">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-emerald-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>âœ¨ AI æ­£åœ¨åŠªåŠ›æ€è€ƒä¸­...</span>
        </div>
    </div>

    <div class="max-w-5xl mx-auto p-4 sm:p-8">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-emerald-700 mb-2">IELTS æµç¨‹åœ–æƒ…å¢ƒåˆ†æå™¨</h1>
            <p class="text-lg text-slate-600">å°‡æŠ½è±¡çš„è€ƒè©¦æµç¨‹ï¼Œè½‰åŒ–ç‚ºå…·é«”çš„ç”Ÿæ´»ç¶“é©—ï¼Œä¸¦ç”± AI å¢å¼·å­¸ç¿’</p>
        </header>

        <nav class="flex flex-wrap justify-center gap-2 sm:gap-4 mb-8">
            <button class="nav-tab active text-sm sm:text-base font-medium py-2 px-4 rounded-full border-2 border-emerald-200 bg-white text-emerald-700 hover:bg-emerald-50" data-target="overview">
                ç¸½è¦½
            </button>
            <button class="nav-tab text-sm sm:text-base font-medium py-2 px-4 rounded-full border-2 border-emerald-200 bg-white text-emerald-700 hover:bg-emerald-50" data-target="natural-cycles">
                è‡ªç„¶å¾ªç’°
            </button>
            <button class="nav-tab text-sm sm:text-base font-medium py-2 px-4 rounded-full border-2 border-emerald-200 bg-white text-emerald-700 hover:bg-emerald-50" data-target="manufacturing-processes">
                è£½é€ æµç¨‹
            </button>
            <button class="nav-tab text-sm sm:text-base font-medium py-2 px-4 rounded-full border-2 border-emerald-200 bg-white text-emerald-700 hover:bg-emerald-50" data-target="system-flows">
                ç³»çµ±æµç¨‹
            </button>
        </nav>

        <main>
            <section id="overview" class="content-panel bg-white p-6 sm:p-8 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold text-emerald-600 mb-4">æ­¡è¿ä½¿ç”¨ï¼</h2>
                <p class="mb-4">é›…æ€ Task 1 çš„æµç¨‹åœ– (Process Diagram) å¸¸å¸¸è®“äººæ„Ÿåˆ°æ£˜æ‰‹ï¼Œå› ç‚ºå®ƒå€‘çœ‹èµ·ä¾†å¾ˆå­¸è¡“ã€å¾ˆç”Ÿç¡¬ã€‚ä½†äº‹å¯¦ä¸Šï¼Œé€™äº›åœ–è¡¨æ‰€æè¿°çš„ã€Œèªå¢ƒã€â€” ä¹Ÿå°±æ˜¯ã€Œä¸€å€‹æ­¥é©Ÿæ¥è‘—ä¸€å€‹æ­¥é©Ÿã€â€” å……æ»¿åœ¨æˆ‘å€‘çš„æ—¥å¸¸ç”Ÿæ´»ä¸­ã€‚</p>
                <p class="mb-4">é€™å€‹å·¥å…·çš„ç›®çš„ï¼Œå°±æ˜¯å¹«åŠ©æ‚¨æ‰“ç ´é€™ç¨®éš”é–¡ã€‚æˆ‘å€‘å°‡æµç¨‹åœ–è€ƒé¡Œæ­¸ç´ç‚ºä¸‰å¤§æ ¸å¿ƒé¡å‹ï¼š<strong class="text-emerald-700">è‡ªç„¶å¾ªç’°</strong>ã€<strong class="text-emerald-700">è£½é€ æµç¨‹</strong>å’Œ<strong class="text-emerald-700">ç³»çµ±æµç¨‹</strong>ã€‚</p>
                <p class="mb-4">è«‹é»æ“Šä¸Šæ–¹çš„é ç±¤ï¼Œæ¢ç´¢æ¯ä¸€ç¨®é¡å‹ã€‚ç¾åœ¨ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ AI æä¾›çš„ã€Œé€²éšè©å½™ã€æ¸…å–®ä¾†è±å¯Œæ‚¨çš„å¯«ä½œï¼Œä¸¦ä¸”ä¸Šå‚³ã€Œç›¸é—œæƒ…å¢ƒç…§ç‰‡ã€è®“ AI åˆ†æï¼ŒåŠ©æ‚¨å¾ä¸åŒç¶­åº¦ç†è§£æµç¨‹åœ–å¯«ä½œï¼</p>
            </section>

            <!-- ============================================== -->
            <!-- TYPE 1: NATURAL CYCLES (è‡ªç„¶å¾ªç’°) -->
            <!-- ============================================== -->
            <section id="natural-cycles" class="content-panel hidden bg-white p-6 sm:p-8 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold text-emerald-600 mb-4">é¡å‹ä¸€ï¼šè‡ªç„¶å¾ªç’° (Natural Cycles)</h2>
                <p class="mb-6">é€™ç¨®é¡å‹çš„åœ–è¡¨æè¿°çš„æ˜¯ç”Ÿç‰©æˆ–è‡ªç„¶ç¾è±¡çš„ç”Ÿå‘½é€±æœŸï¼Œé€šå¸¸æ˜¯ä¸€å€‹å°é–‰çš„å¾ªç’°ã€‚é‡é»åœ¨æ–¼æè¿°ã€Œéšæ®µã€(stages) å’Œã€Œè½‰è®Šã€(transformation)ã€‚</p>
                
                <!-- Prompt Generation Section -->
                <div class="mt-6 mb-8 p-4 bg-emerald-50 rounded-lg border border-emerald-200">
                    <h3 class="font-semibold text-emerald-800 mb-3">éœ€è¦ç·´ç¿’å—ï¼Ÿ</h3>
                    <button class="generate-prompt-btn w-full sm:w-auto px-6 py-2 bg-emerald-600 text-white font-semibold rounded-full hover:bg-emerald-700 transition-colors shadow-md" data-category="Natural Cycle (è‡ªç„¶å¾ªç’°)" data-output-id="prompt-text-natural-cycles" data-audio-id="audio-player-natural-cycles">
                        âœ¨ ç”¢ç”Ÿæ–°çš„ç·´ç¿’é¡Œç›®
                    </button>
                    <div id="prompt-output-natural-cycles" class="prompt-output mt-4 p-4 bg-white rounded border border-emerald-300 hidden">
                        <p class="font-medium text-emerald-800 mb-2">æ–°çš„ IELTS Task 1 æµç¨‹åœ–é¡Œç›®ï¼š</p>
                        <p id="prompt-text-natural-cycles" class="text-slate-700 whitespace-pre-wrap"></p>
                        <button class="tts-button mt-2 text-sm text-slate-500 hover:text-emerald-600" data-target="prompt-text-natural-cycles">ğŸ”Š æœ—è®€</button>
                        <audio id="audio-player-natural-cycles" class="w-full mt-2 hidden" controls></audio>
                    </div>
                </div>

                <h3 class="text-xl font-semibold text-slate-700 mb-4">ç”Ÿæ´»æƒ…å¢ƒé€£çµï¼š</h3>
                
                <!-- Analogy 1: Hand-Drip Coffee -->
                <div class="border border-slate-200 rounded-lg mb-4">
                    <button class="analogy-trigger w-full flex justify-between items-center p-4 bg-emerald-50 hover:bg-emerald-100 transition-colors">
                        <span class="font-semibold text-emerald-800">æƒ…å¢ƒ 1: æ‰‹æ²–å’–å•¡ (Drip Coffee Preparation)</span>
                        <span class="analogy-icon text-emerald-800 text-2xl font-light">+</span>
                    </button>
                    <div class="analogy-detail hidden p-4 sm:p-6 border-t border-slate-200">
                        <p class="mb-4">æ‰‹æ²–å’–å•¡å®Œç¾æ¨¡æ“¬äº†ä¸€å€‹å°å‹çš„ã€Œæ°´å¾ªç’°ã€ã€‚æ‚¨éœ€è¦æè¿°æ°´å¦‚ä½•æ”¹è®Šå½¢æ…‹ä¸¦åœ¨ç³»çµ±ä¸­ç§»å‹•ã€‚</p>
                        <div class="flex flex-wrap items-center justify-center gap-2 my-4 overflow-x-auto p-2">
                            <span class="bg-emerald-100 text-emerald-800 rounded-md p-2 text-sm font-medium text-center">ç†±æ°´ (Evaporation)</span>
                            <span class="text-slate-400 text-2xl mx-1">â†’</span>
                            <span class="bg-emerald-100 text-emerald-800 rounded-md p-2 text-sm font-medium text-center">é€šéå’–å•¡ç²‰ (Infiltration)</span>
                            <span class="text-slate-400 text-2xl mx-1">â†’</span>
                            <span class="bg-emerald-100 text-emerald-800 rounded-md p-2 text-sm font-medium text-center">æ»´å…¥å£ºä¸­ (Collection)</span>
                        </div>
                        
                        <div class="mt-4 border-t pt-4">
                            <h4 class="font-semibold mb-2">é€²éšè©å½™èˆ‡è½‰æ‰¿è©ï¼š</h4>
                            <button class="generate-vocab-btn px-4 py-1 text-sm bg-emerald-600 text-white rounded-full hover:bg-emerald-700 transition-colors" data-process="Drip Coffee Preparation (æ‰‹æ²–å’–å•¡)" data-output-id="vocab-text-coffee" data-audio-id="audio-player-coffee">
                                âœ¨ ç”Ÿæˆé€²éšè©å½™
                            </button>
                            <div id="vocab-output-coffee" class="vocab-output mt-3 p-3 bg-slate-100 rounded hidden">
                                <p class="font-medium text-slate-700 mb-2">ç”Ÿæˆçµæœï¼š</p>
                                <div id="vocab-text-coffee" class="text-slate-600 text-sm whitespace-pre-wrap markdown-output"></div>
                                <button class="tts-button mt-2 text-sm text-slate-500 hover:text-emerald-600" data-target="vocab-text-coffee">ğŸ”Š æœ—è®€</button>
                                <audio id="audio-player-coffee" class="w-full mt-2 hidden" controls></audio>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Image Analysis Section for Natural Cycles -->
                <div class="mt-8 pt-6 border-t border-slate-200">
                    <h3 class="text-xl font-semibold text-emerald-600 mb-4">åœ–åƒæƒ…å¢ƒåˆ†æï¼ˆè‡ªç„¶å¾ªç’°ï¼‰</h3>
                    <p class="mb-3 text-slate-600">ä¸Šå‚³ä¸€å¼µèˆ‡è‡ªç„¶å¾ªç’°ç›¸é—œçš„ç…§ç‰‡ (ä¾‹å¦‚ï¼šæ¤ç‰©ã€å¤©æ°£ã€å‹•ç‰©ç”Ÿå‘½é€±æœŸ)ï¼ŒAI å°‡åˆ†æå…¶å¯å¯«çš„æµç¨‹ç´°ç¯€ã€‚<br><span class="text-xs text-emerald-600 font-semibold">*æ³¨æ„ï¼šAI å°‡æœƒç‰¹åˆ¥æé†’æ‚¨åœ¨æ­¤é¡é¡Œå‹ä¸­ä½¿ç”¨ä¸»å‹•èªæ…‹ (Active Voice)ã€‚</span></p>
                    
                    <div class="flex flex-col sm:flex-row sm:items-end gap-3 p-4 bg-slate-50 rounded-lg border border-slate-200">
                        <div class="flex-grow">
                            <label for="image-upload-natural-cycles" class="block text-sm font-medium text-slate-700 mb-1">é¸æ“‡ç…§ç‰‡</label>
                            <input type="file" accept="image/*" class="image-upload-input block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100" id="image-upload-natural-cycles">
                        </div>
                        <button class="analyze-image-btn w-full sm:w-auto px-6 py-2 bg-emerald-600 text-white font-semibold rounded-full hover:bg-emerald-700 transition-colors shadow-md" data-category="Natural Cycles (è‡ªç„¶å¾ªç’°)" data-input-id="image-upload-natural-cycles" data-output-id="image-analysis-output-natural-cycles" data-analysis-text-id="analysis-text-natural-cycles" data-image-preview-id="image-preview-natural-cycles" data-audio-id="audio-player-img-natural-cycles">
                            ğŸ“· åˆ†æåœ–ç‰‡
                        </button>
                    </div>

                    <div id="image-analysis-output-natural-cycles" class="mt-4 p-4 bg-white rounded border border-emerald-300 hidden">
                        <h4 class="font-medium text-emerald-800 mb-3">AI åœ–åƒåˆ†æçµæœï¼š</h4>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <div id="image-preview-natural-cycles" class="image-preview-container w-full sm:w-1/3 flex-shrink-0 max-h-40 overflow-hidden rounded-lg border border-slate-200 bg-slate-100 flex items-center justify-center">
                                <p class="text-sm text-slate-400 p-4">åœ–ç‰‡é è¦½</p>
                            </div>
                            <div class="w-full sm:w-2/3">
                                <p id="analysis-text-natural-cycles" class="text-slate-700 whitespace-pre-wrap"></p>
                                <button class="tts-button mt-3 text-sm text-slate-500 hover:text-emerald-600" data-target="analysis-text-natural-cycles">ğŸ”Š æœ—è®€</button>
                                <audio id="audio-player-img-natural-cycles" class="w-full mt-2 hidden" controls></audio>
                            </div>
                        </div>
                    </div>
                </div>

            </section>

            <!-- ============================================== -->
            <!-- TYPE 2: MANUFACTURING PROCESSES (è£½é€ æµç¨‹) -->
            <!-- ============================================== -->
            <section id="manufacturing-processes" class="content-panel hidden bg-white p-6 sm:p-8 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold text-emerald-600 mb-4">é¡å‹äºŒï¼šè£½é€ æµç¨‹ (Manufacturing Processes)</h2>
                <p class="mb-6">é€™ç¨®é¡å‹çš„åœ–è¡¨æè¿°çš„æ˜¯ä¸€å€‹ã€Œç·šæ€§ã€éç¨‹ï¼Œå³åŸæ–™ (raw materials) å¦‚ä½•ç¶“éä¸€ç³»åˆ—æ­¥é©Ÿï¼Œè¢«åŠ å·¥ (processed) æˆæœ€çµ‚ç”¢å“ (finished product)ã€‚é€™é€šå¸¸æ˜¯äººç‚ºçš„ã€‚é‡é»åœ¨æ–¼ã€Œé †åºã€å’Œã€Œè¢«å‹•èªæ…‹ã€ã€‚</p>
                
                <!-- Prompt Generation Section -->
                <div class="mt-6 mb-8 p-4 bg-emerald-50 rounded-lg border border-emerald-200">
                    <h3 class="font-semibold text-emerald-800 mb-3">éœ€è¦ç·´ç¿’å—ï¼Ÿ</h3>
                    <button class="generate-prompt-btn w-full sm:w-auto px-6 py-2 bg-emerald-600 text-white font-semibold rounded-full hover:bg-emerald-700 transition-colors shadow-md" data-category="Manufacturing Process (è£½é€ æµç¨‹)" data-output-id="prompt-text-manufacturing-processes" data-audio-id="audio-player-manufacturing-processes">
                        âœ¨ ç”¢ç”Ÿæ–°çš„ç·´ç¿’é¡Œç›®
                    </button>
                    <div id="prompt-output-manufacturing-processes" class="prompt-output mt-4 p-4 bg-white rounded border border-emerald-300 hidden">
                        <p class="font-medium text-emerald-800 mb-2">æ–°çš„ IELTS Task 1 æµç¨‹åœ–é¡Œç›®ï¼š</p>
                        <p id="prompt-text-manufacturing-processes" class="text-slate-700 whitespace-pre-wrap"></p>
                        <button class="tts-button mt-2 text-sm text-slate-500 hover:text-emerald-600" data-target="prompt-text-manufacturing-processes">ğŸ”Š æœ—è®€</button>
                        <audio id="audio-player-manufacturing-processes" class="w-full mt-2 hidden" controls></audio>
                    </div>
                </div>

                <h3 class="text-xl font-semibold text-slate-700 mb-4">ç”Ÿæ´»æƒ…å¢ƒé€£çµï¼š</h3>
                
                <!-- Analogy 1: Baking a Cake -->
                <div class="border border-slate-200 rounded-lg mb-4">
                    <button class="analogy-trigger w-full flex justify-between items-center p-4 bg-emerald-50 hover:bg-emerald-100 transition-colors">
                        <span class="font-semibold text-emerald-800">æƒ…å¢ƒ 1: ç…§è‘—é£Ÿè­œçƒ¤è›‹ç³• (Baking a Cake)</span>
                        <span class="analogy-icon text-emerald-800 text-2xl font-light">+</span>
                    </button>
                    <div class="analogy-detail hidden p-4 sm:p-6 border-t border-slate-200">
                        <p class="mb-4">çƒ¤è›‹ç³•å°±æ˜¯ä¸€å€‹å®Œç¾çš„è£½é€ æµç¨‹ã€‚ä½ æœ‰åŸæ–™ï¼ˆéºµç²‰ã€è›‹ï¼‰ï¼Œä¸¦ä½¿ç”¨å·¥å…·ï¼ˆçƒ¤ç®±ï¼‰ä¾†æ”¹è®Šå®ƒå€‘ã€‚</p>
                        <div class="flex flex-wrap items-center justify-center gap-2 my-4 overflow-x-auto p-2">
                            <span class="bg-emerald-100 text-emerald-800 rounded-md p-2 text-sm font-medium text-center">åŸæ–™</span>
                            <span class="text-slate-400 text-2xl mx-1">â†’</span>
                            <span class="bg-emerald-100 text-emerald-800 rounded-md p-2 text-sm font-medium text-center">æ··åˆ</span>
                            <span class="text-slate-400 text-2xl mx-1">â†’</span>
                            <span class="bg-emerald-100 text-emerald-800 rounded-md p-2 text-sm font-medium text-center">çƒ˜çƒ¤</span>
                            <span class="text-slate-400 text-2xl mx-1">â†’</span>
                            <span class="bg-emerald-100 text-emerald-800 rounded-md p-2 text-sm font-medium text-center">æˆå“</span>
                        </div>
                        
                        <div class="mt-4 border-t pt-4">
                            <h4 class="font-semibold mb-2">é€²éšè©å½™èˆ‡è½‰æ‰¿è©ï¼š</h4>
                            <button class="generate-vocab-btn px-4 py-1 text-sm bg-emerald-600 text-white rounded-full hover:bg-emerald-700 transition-colors" data-process="Baking a Cake (çƒ¤è›‹ç³•)" data-output-id="vocab-text-baking" data-audio-id="audio-player-baking">
                                âœ¨ ç”Ÿæˆé€²éšè©å½™
                            </button>
                            <div id="vocab-output-baking" class="vocab-output mt-3 p-3 bg-slate-100 rounded hidden">
                                <p class="font-medium text-slate-700 mb-2">ç”Ÿæˆçµæœï¼š</p>
                                <div id="vocab-text-baking" class="text-slate-600 text-sm whitespace-pre-wrap markdown-output"></div>
                                <button class="tts-button mt-2 text-sm text-slate-500 hover:text-emerald-600" data-target="vocab-text-baking">ğŸ”Š æœ—è®€</button>
                                <audio id="audio-player-baking" class="w-full mt-2 hidden" controls></audio>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Image Analysis Section for Manufacturing Processes -->
                <div class="mt-8 pt-6 border-t border-slate-200">
                    <h3 class="text-xl font-semibold text-emerald-600 mb-4">åœ–åƒæƒ…å¢ƒåˆ†æï¼ˆè£½é€ æµç¨‹ï¼‰</h3>
                    <p class="mb-3 text-slate-600">ä¸Šå‚³ä¸€å¼µèˆ‡è£½é€ æˆ–åŠ å·¥ç›¸é—œçš„ç…§ç‰‡ (ä¾‹å¦‚ï¼šå·¥å» è¨­å‚™ã€å»šæˆ¿å‚™æ–™ã€å›æ”¶ç«™)ï¼ŒAI å°‡åˆ†æå…¶å¯å¯«çš„æµç¨‹ç´°ç¯€ã€‚</p>
                    
                    <div class="flex flex-col sm:flex-row sm:items-end gap-3 p-4 bg-slate-50 rounded-lg border border-slate-200">
                        <div class="flex-grow">
                            <label for="image-upload-manufacturing-processes" class="block text-sm font-medium text-slate-700 mb-1">é¸æ“‡ç…§ç‰‡</label>
                            <input type="file" accept="image/*" class="image-upload-input block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100" id="image-upload-manufacturing-processes">
                        </div>
                        <button class="analyze-image-btn w-full sm:w-auto px-6 py-2 bg-emerald-600 text-white font-semibold rounded-full hover:bg-emerald-700 transition-colors shadow-md" data-category="Manufacturing Process (è£½é€ æµç¨‹)" data-input-id="image-upload-manufacturing-processes" data-output-id="image-analysis-output-manufacturing-processes" data-analysis-text-id="analysis-text-manufacturing-processes" data-image-preview-id="image-preview-manufacturing-processes" data-audio-id="audio-player-img-manufacturing-processes">
                            ğŸ“· åˆ†æåœ–ç‰‡
                        </button>
                    </div>

                    <div id="image-analysis-output-manufacturing-processes" class="mt-4 p-4 bg-white rounded border border-emerald-300 hidden">
                        <h4 class="font-medium text-emerald-800 mb-3">AI åœ–åƒåˆ†æçµæœï¼š</h4>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <div id="image-preview-manufacturing-processes" class="image-preview-container w-full sm:w-1/3 flex-shrink-0 max-h-40 overflow-hidden rounded-lg border border-slate-200 bg-slate-100 flex items-center justify-center">
                                <p class="text-sm text-slate-400 p-4">åœ–ç‰‡é è¦½</p>
                            </div>
                            <div class="w-full sm:w-2/3">
                                <p id="analysis-text-manufacturing-processes" class="text-slate-700 whitespace-pre-wrap"></p>
                                <button class="tts-button mt-3 text-sm text-slate-500 hover:text-emerald-600" data-target="analysis-text-manufacturing-processes">ğŸ”Š æœ—è®€</button>
                                <audio id="audio-player-img-manufacturing-processes" class="w-full mt-2 hidden" controls></audio>
                            </div>
                        </div>
                    </div>
                </div>

            </section>

            <!-- ============================================== -->
            <!-- TYPE 3: SYSTEM FLOWS (ç³»çµ±æµç¨‹) -->
            <!-- ============================================== -->
            <section id="system-flows" class="content-panel hidden bg-white p-6 sm:p-8 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold text-emerald-600 mb-4">é¡å‹ä¸‰ï¼šç³»çµ±æµç¨‹ (System Flows)</h2>
                <p class="mb-6">é€™ç¨®é¡å‹çš„åœ–è¡¨æè¿°çš„æ˜¯ä¸€å€‹ã€Œè³‡è¨Šã€æˆ–ã€Œæœå‹™ã€çš„æµç¨‹ï¼Œå®ƒå¯èƒ½åŒ…å«ã€Œæ±ºç­–é»ã€(decision points) å’Œä¸åŒçš„è·¯å¾‘ã€‚é‡é»åœ¨æ–¼æè¿°ã€Œè«‹æ±‚ã€ã€ã€Œè™•ç†ã€å’Œã€Œåé¥‹ã€ã€‚</p>

                <!-- Prompt Generation Section -->
                <div class="mt-6 mb-8 p-4 bg-emerald-50 rounded-lg border border-emerald-200">
                    <h3 class="font-semibold text-emerald-800 mb-3">éœ€è¦ç·´ç¿’å—ï¼Ÿ</h3>
                    <button class="generate-prompt-btn w-full sm:w-auto px-6 py-2 bg-emerald-600 text-white font-semibold rounded-full hover:bg-emerald-700 transition-colors shadow-md" data-category="System Flow (ç³»çµ±æµç¨‹)" data-output-id="prompt-text-system-flows" data-audio-id="audio-player-system-flows">
                        âœ¨ ç”¢ç”Ÿæ–°çš„ç·´ç¿’é¡Œç›®
                    </button>
                    <div id="prompt-output-system-flows" class="prompt-output mt-4 p-4 bg-white rounded border border-emerald-300 hidden">
                        <p class="font-medium text-emerald-800 mb-2">æ–°çš„ IELTS Task 1 æµç¨‹åœ–é¡Œç›®ï¼š</p>
                        <p id="prompt-text-system-flows" class="text-slate-700 whitespace-pre-wrap"></p>
                        <button class="tts-button mt-2 text-sm text-slate-500 hover:text-emerald-600" data-target="prompt-text-system-flows">ğŸ”Š æœ—è®€</button>
                        <audio id="audio-player-system-flows" class="w-full mt-2 hidden" controls></audio>
                    </div>
                </div>

                <h3 class="text-xl font-semibold text-slate-700 mb-4">ç”Ÿæ´»æƒ…å¢ƒé€£çµï¼š</h3>
                
                <!-- Analogy 1: Online Food Delivery -->
                <div class="border border-slate-200 rounded-lg mb-4">
                    <button class="analogy-trigger w-full flex justify-between items-center p-4 bg-emerald-50 hover:bg-emerald-100 transition-colors">
                        <span class="font-semibold text-emerald-800">æƒ…å¢ƒ 1: ç·šä¸Šè¨‚é¤ (Food Delivery System)</span>
                        <span class="analogy-icon text-emerald-800 text-2xl font-light">+</span>
                    </button>
                    <div class="analogy-detail hidden p-4 sm:p-6 border-t border-slate-200">
                        <p class="mb-4">ç·šä¸Šè¨‚é¤æ˜¯ä¸€å€‹å®Œç¾çš„ç¾ä»£ç³»çµ±æµç¨‹ã€‚å®ƒæ¶‰åŠä½¿ç”¨è€…ã€ç³»çµ±å’Œä¾›æ‡‰å•†ï¼ˆé¤å»³ï¼‰ä¹‹é–“çš„äº’å‹•ã€‚</p>
                        <div class="flex flex-wrap items-center justify-center gap-2 my-4 overflow-x-auto p-2">
                            <span class="bg-emerald-100 text-emerald-800 rounded-md p-2 text-sm font-medium text-center">é¡§å®¢ä¸‹å–®</span>
                            <span class="text-slate-400 text-2xl mx-1">â†’</span>
                            <span class="bg-emerald-100 text-emerald-800 rounded-md p-2 text-sm font-medium text-center">é¤å»³æ¥æ”¶</span>
                            <span class="text-slate-400 text-2xl mx-1">â†’</span>
                            <span class="bg-emerald-100 text-emerald-800 rounded-md p-2 text-sm font-medium text-center">æº–å‚™é¤é»</span>
                            <span class="text-slate-400 text-2xl mx-1">â†’</span>
                            <span class="bg-emerald-100 text-emerald-800 rounded-md p-2 text-sm font-medium text-center">é€é”</span>
                        </div>
                        
                        <div class="mt-4 border-t pt-4">
                            <h4 class="font-semibold mb-2">é€²éšè©å½™èˆ‡è½‰æ‰¿è©ï¼š</h4>
                            <button class="generate-vocab-btn px-4 py-1 text-sm bg-emerald-600 text-white rounded-full hover:bg-emerald-700 transition-colors" data-process="Online Food Ordering System (ç·šä¸Šè¨‚é¤)" data-output-id="vocab-text-food-delivery" data-audio-id="audio-player-food-delivery">
                                âœ¨ ç”Ÿæˆé€²éšè©å½™
                            </button>
                            <div id="vocab-output-food-delivery" class="vocab-output mt-3 p-3 bg-slate-100 rounded hidden">
                                <p class="font-medium text-slate-700 mb-2">ç”Ÿæˆçµæœï¼š</p>
                                <div id="vocab-text-food-delivery" class="text-slate-600 text-sm whitespace-pre-wrap markdown-output"></div>
                                <button class="tts-button mt-2 text-sm text-slate-500 hover:text-emerald-600" data-target="vocab-text-food-delivery">ğŸ”Š æœ—è®€</button>
                                <audio id="audio-player-food-delivery" class="w-full mt-2 hidden" controls></audio>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Image Analysis Section for System Flows -->
                <div class="mt-8 pt-6 border-t border-slate-200">
                    <h3 class="text-xl font-semibold text-emerald-600 mb-4">åœ–åƒæƒ…å¢ƒåˆ†æï¼ˆç³»çµ±æµç¨‹ï¼‰</h3>
                    <p class="mb-3 text-slate-600">ä¸Šå‚³ä¸€å¼µèˆ‡æœå‹™æˆ–è³‡è¨Šæµç›¸é—œçš„ç…§ç‰‡ (ä¾‹å¦‚ï¼šæ©Ÿå ´ç™»æ©Ÿå£ã€æ’éšŠéšŠä¼ã€è¾¦å…¬å®¤å·¥ä½œç«™)ï¼ŒAI å°‡åˆ†æå…¶å¯å¯«çš„æµç¨‹ç´°ç¯€ã€‚</p>
                    
                    <div class="flex flex-col sm:flex-row sm:items-end gap-3 p-4 bg-slate-50 rounded-lg border border-slate-200">
                        <div class="flex-grow">
                            <label for="image-upload-system-flows" class="block text-sm font-medium text-slate-700 mb-1">é¸æ“‡ç…§ç‰‡</label>
                            <input type="file" accept="image/*" class="image-upload-input block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100" id="image-upload-system-flows">
                        </div>
                        <button class="analyze-image-btn w-full sm:w-auto px-6 py-2 bg-emerald-600 text-white font-semibold rounded-full hover:bg-emerald-700 transition-colors shadow-md" data-category="System Flow (ç³»çµ±æµç¨‹)" data-input-id="image-upload-system-flows" data-output-id="image-analysis-output-system-flows" data-analysis-text-id="analysis-text-system-flows" data-image-preview-id="image-preview-system-flows" data-audio-id="audio-player-img-system-flows">
                            ğŸ“· åˆ†æåœ–ç‰‡
                        </button>
                    </div>

                    <div id="image-analysis-output-system-flows" class="mt-4 p-4 bg-white rounded border border-emerald-300 hidden">
                        <h4 class="font-medium text-emerald-800 mb-3">AI åœ–åƒåˆ†æçµæœï¼š</h4>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <div id="image-preview-system-flows" class="image-preview-container w-full sm:w-1/3 flex-shrink-0 max-h-40 overflow-hidden rounded-lg border border-slate-200 bg-slate-100 flex items-center justify-center">
                                <p class="text-sm text-slate-400 p-4">åœ–ç‰‡é è¦½</p>
                            </div>
                            <div class="w-full sm:w-2/3">
                                <p id="analysis-text-system-flows" class="text-slate-700 whitespace-pre-wrap"></p>
                                <button class="tts-button mt-3 text-sm text-slate-500 hover:text-emerald-600" data-target="analysis-text-system-flows">ğŸ”Š æœ—è®€</button>
                                <audio id="audio-player-img-system-flows" class="w-full mt-2 hidden" controls></audio>
                            </div>
                        </div>
                    </div>
                </div>

            </section>
        </main>
    </div>

    <script>
        const apiKey = "AIzaSyCKKfTgA-4wY7aOP0fqLHRJ8dBV9AQRkzs";
        const LLM_TEXT_MODEL = 'gemini-2.5-flash-preview-09-2025';
        const LLM_TTS_MODEL = 'gemini-2.5-flash-preview-tts';
        const loadingIndicator = document.getElementById('loading-indicator');

        // Function to convert base64 to ArrayBuffer
        const base64ToArrayBuffer = (base64) => {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };

        // Function to convert PCM audio data to WAV format
        const pcmToWav = (pcm16, sampleRate) => {
            const numChannels = 1;
            const bitDepth = 16;
            const bytesPerSample = bitDepth / 8;
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcm16.length * bytesPerSample;
            
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);
            let offset = 0;

            // Write RIFF header
            const writeString = (s) => {
                for (let i = 0; i < s.length; i++) {
                    view.setUint8(offset + i, s.charCodeAt(i));
                }
                offset += s.length;
            };

            writeString('RIFF'); // Chunk ID
            view.setUint32(offset, 36 + dataSize, true); // Chunk Size
            offset += 4;
            writeString('WAVE'); // Format

            // Write fmt sub-chunk
            writeString('fmt '); // Sub-chunk 1 ID
            view.setUint32(offset, 16, true); // Sub-chunk 1 Size
            offset += 4;
            view.setUint16(offset, 1, true); // Audio Format (1 = PCM)
            offset += 2;
            view.setUint16(offset, numChannels, true); // Num Channels
            offset += 2;
            view.setUint32(offset, sampleRate, true); // Sample Rate
            offset += 4;
            view.setUint32(offset, byteRate, true); // Byte Rate
            offset += 4;
            view.setUint16(offset, blockAlign, true); // Block Align
            offset += 2;
            view.setUint16(offset, bitDepth, true); // Bit Depth
            offset += 2;

            // Write data sub-chunk
            writeString('data'); // Sub-chunk 2 ID
            view.setUint32(offset, dataSize, true); // Sub-chunk 2 Size
            offset += 4;

            // Write PCM data
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }

            return new Blob([buffer], { type: 'audio/wav' });
        };

        // Generic fetch function with exponential backoff
        const fetchWithBackoff = async (url, options, maxRetries = 5) => {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("Maximum retries reached.");
        };

        // LLM Text Generation Function
        const generateContent = async (userQuery, systemPrompt) => {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_TEXT_MODEL}:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const response = await fetchWithBackoff(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            return result.candidates?.[0]?.content?.parts?.[0]?.text || 'ç”Ÿæˆå…§å®¹å¤±æ•—ã€‚';
        };

        // Function to convert file to Base64
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // reader.result is Data URI (e.g., data:image/png;base64,...)
                    const base64String = reader.result.split(',')[1];
                    const mimeType = file.type;
                    resolve({ base64: base64String, mimeType: mimeType });
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        };

        // LLM Image Analysis Function (using multimodal capabilities)
        const analyzeImage = async (base64Image, mimeType, category) => {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_TEXT_MODEL}:generateContent?key=${apiKey}`;
            
            // --- ä¿®æ­£é–‹å§‹ï¼šé‡å°è‡ªç„¶å¾ªç’°æ·»åŠ å¼·åˆ¶ä¸»å‹•èªæ…‹æé†’ ---
            let extraInstruction = "";
            if (category.includes("Natural Cycles") || category.includes("è‡ªç„¶å¾ªç’°")) {
                extraInstruction = " é‡è¦æé†’ï¼šé‡å°ã€Œè‡ªç„¶å¾ªç’°ã€é¡å‹ï¼Œè«‹åœ¨å›æ‡‰ä¸­æ˜ç¢ºæé†’å­¸ç”Ÿï¼Œæè¿°è‡ªç„¶ç•Œç”Ÿç‰©ç”Ÿé•·æˆ–å¾ªç’°æ™‚ï¼Œå¿…é ˆä½¿ç”¨ã€Œä¸»å‹•èªæ…‹ã€(Active Voice)ã€‚";
            }
            // --- ä¿®æ­£çµæŸ ---

            const userQuery = `è«‹åˆ†æé€™å¼µåœ–ç‰‡ï¼Œä¸¦ä»¥ IELTS Task 1 æµç¨‹åœ–å¯«ä½œçš„è§’åº¦ï¼Œèªªæ˜åœ–ç‰‡ä¸­çš„ç‰©é«”ã€å‹•ä½œæˆ–ç‹€æ…‹å¦‚ä½•èƒ½è¢«æè¿°ç‚ºä¸€å€‹æµç¨‹ã€‚é€™å€‹æµç¨‹å±¬æ–¼ã€Œ${category}ã€é¡å‹ã€‚${extraInstruction}`;
            
            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: userQuery },
                        {
                            inlineData: {
                                mimeType: mimeType,
                                data: base64Image
                            }
                        }
                    ]
                }],
                systemInstruction: {
                    parts: [{ text: "You are an expert IELTS Task 1 tutor. Analyze the provided image in the context of process diagram description. Focus on identifying objects, actions, and sequence/state changes that could be described using process vocabulary. Write a concise, professional analysis in Traditional Chinese. Do not use any markdown formatting." }]
                },
            };

            const response = await fetchWithBackoff(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            return result.candidates?.[0]?.content?.parts?.[0]?.text || 'åœ–åƒåˆ†æå¤±æ•—ã€‚';
        };

        // LLM TTS Generation Function
        const generateTTS = async (text, audioId) => {
            const audioPlayer = document.getElementById(audioId);
            const ttsUrl = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_TTS_MODEL}:generateContent?key=${apiKey}`;
            
            // --- ä¿®æ­£ï¼šå®šç¾©æ’­æ”¾çµæŸæ™‚çš„å‹•ä½œ ---
            const onAudioEnd = () => {
                loadingIndicator.classList.add('hidden'); // åœ¨æ’­æ”¾çµæŸæ™‚éš±è—æŒ‡ç¤ºå™¨
                audioPlayer.removeEventListener('ended', onAudioEnd); // æ¸…ç†ç›£è½å™¨
            };
            
            // --- ä¿®æ­£ï¼šç§»é™¤èˆŠç›£è½å™¨ä¸¦æ·»åŠ æ–°ç›£è½å™¨ ---
            audioPlayer.removeEventListener('ended', onAudioEnd);
            audioPlayer.addEventListener('ended', onAudioEnd);
            // --- ä¿®æ­£çµæŸ ---

            audioPlayer.classList.add('hidden');
            audioPlayer.pause();
            audioPlayer.removeAttribute('src');

            const payload = {
                contents: [{ parts: [{ text: text }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" }
                        }
                    }
                },
                model: LLM_TTS_MODEL
            };

            try {
                const response = await fetchWithBackoff(ttsUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    
                    const audioUrl = URL.createObjectURL(wavBlob);
                    audioPlayer.src = audioUrl;
                    audioPlayer.classList.remove('hidden');
                    audioPlayer.play();
                    // æ’­æ”¾é–‹å§‹ï¼ŒloadingIndicator ä¿æŒå¯è¦‹ï¼Œç›´åˆ° 'ended' äº‹ä»¶è§¸ç™¼
                } else {
                    console.error("TTS generation failed or returned invalid format:", result);
                    const message = "èªéŸ³ç”Ÿæˆå¤±æ•—ï¼šç„¡æ³•å–å¾—éŸ³è¨Šè³‡æ–™ã€‚";
                    console.warn(message);
                    loadingIndicator.classList.add('hidden'); // --- ä¿®æ­£ï¼šåœ¨å¤±æ•—æ™‚éš±è—
                }
            } catch (error) {
                console.error("TTS API call error:", error);
                const message = "èªéŸ³ç”Ÿæˆç™¼ç”ŸéŒ¯èª¤ã€‚è«‹ç¨å¾Œå†è©¦ã€‚";
                console.warn(message);
                loadingIndicator.classList.add('hidden'); // --- ä¿®æ­£ï¼šåœ¨ catch ä¸­éš±è—
            }
        };

        // Main DOMContentLoaded setup
        document.addEventListener('DOMContentLoaded', () => {
            const tabs = document.querySelectorAll('.nav-tab');
            const panels = document.querySelectorAll('.content-panel');
            const analogyTriggers = document.querySelectorAll('.analogy-trigger');
            const vocabButtons = document.querySelectorAll('.generate-vocab-btn');
            const promptButtons = document.querySelectorAll('.generate-prompt-btn');
            const analyzeImageButtons = document.querySelectorAll('.analyze-image-btn');
            
            // Tab Navigation Logic
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const target = tab.getAttribute('data-target');
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    panels.forEach(panel => {
                        if (panel.id === target) {
                            panel.classList.remove('hidden');
                        } else {
                            panel.classList.add('hidden');
                        }
                    });
                });
            });

            // Analogy Accordion Logic
            analogyTriggers.forEach(trigger => {
                trigger.addEventListener('click', () => {
                    const detail = trigger.nextElementSibling;
                    const icon = trigger.querySelector('.analogy-icon');
                    
                    const isHidden = detail.classList.contains('hidden');
                    
                    analogyTriggers.forEach(t => {
                        if (t !== trigger) {
                            t.nextElementSibling.classList.add('hidden');
                            t.querySelector('.analogy-icon').textContent = '+';
                            t.nextElementSibling.style.maxHeight = '0px';
                        }
                    });

                    if (isHidden) {
                        detail.classList.remove('hidden');
                        detail.style.maxHeight = detail.scrollHeight + 'px';
                        icon.textContent = 'âˆ’';
                    } else {
                        detail.style.maxHeight = '0px';
                        icon.textContent = '+';
                        setTimeout(() => {
                            detail.classList.add('hidden');
                        }, 500); 
                    }
                });
            });

            // Initial state for accordions
            analogyTriggers.forEach(trigger => {
                const detail = trigger.nextElementSibling;
                detail.classList.add('hidden');
                detail.style.maxHeight = '0px';
            });
            
            // LLM Vocabulary Generation Logic
            vocabButtons.forEach(button => {
                button.addEventListener('click', async (e) => {
                    const processName = button.getAttribute('data-process');
                    const outputId = button.getAttribute('data-output-id');
                    const audioId = button.getAttribute('data-audio-id');
                    const outputDiv = document.getElementById(outputId);
                    const outputContainer = outputDiv.closest('.vocab-output');
                    
                    outputContainer.classList.remove('hidden');
                    outputDiv.innerHTML = '<p class="text-slate-500">ç”Ÿæˆä¸­...</p>';
                    document.getElementById(audioId).classList.add('hidden');

                    const systemPrompt = "Act as an expert IELTS writing tutor. Your task is to provide a list of 5 advanced verbs, 3 sophisticated adjectives, and 2 advanced transition phrases suitable for describing the process of [PROCESS NAME]. Output only a markdown list using the following format and language (Traditional Chinese): '### é€²éšå‹•è©\n- å‹•è© A\n- å‹•è© B\n-...\n### å½¢å®¹è©/åè©\n- å½¢å®¹è© A / åè© A\n-...\n### è½‰æ‰¿è©\n- è½‰æ‰¿è© A\n-...' Do not include any introductory or concluding text outside the markdown list.";
                    const userQuery = `è«‹é‡å°é€™å€‹æµç¨‹ï¼š${processName}ï¼Œç”Ÿæˆé€²éšè©å½™ã€‚`;

                    loadingIndicator.classList.remove('hidden');
                    try {
                        const resultText = await generateContent(userQuery, systemPrompt.replace('[PROCESS NAME]', processName));
                        outputDiv.innerHTML = resultText; // Use innerHTML to render markdown lists
                    } catch (error) {
                        outputDiv.innerHTML = '<p class="text-red-500">ç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚</p>';
                        console.error("Vocabulary generation error:", error);
                    } finally {
                        loadingIndicator.classList.add('hidden');
                    }
                });
            });

            // LLM Prompt Generation Logic
            promptButtons.forEach(button => {
                button.addEventListener('click', async (e) => {
                    const category = button.getAttribute('data-category');
                    const outputId = button.getAttribute('data-output-id');
                    const audioId = button.getAttribute('data-audio-id');
                    const outputDiv = document.getElementById(outputId);
                    const outputContainer = outputDiv.closest('.prompt-output');
                    
                    outputContainer.classList.remove('hidden');
                    outputDiv.textContent = 'ç”Ÿæˆä¸­...';
                    document.getElementById(audioId).classList.add('hidden');

                    const systemPrompt = "Act as an IELTS exam question writer. Generate a single, unique IELTS Writing Task 1 process diagram question focusing on the category: [CATEGORY NAME]. The question must start with 'The diagram illustrates...' and should include a final instruction like 'Summarise the information by selecting and reporting the main features, and make comparisons where relevant.' Output only the complete prompt text.";
                    const userQuery = `è«‹é‡å°æµç¨‹åœ–é¡åˆ¥ï¼š${category}ï¼Œç”Ÿæˆä¸€å€‹å…¨æ–°çš„ IELTS Task 1 é¡Œç›®ã€‚`;

                    loadingIndicator.classList.remove('hidden');
                    try {
                        const resultText = await generateContent(userQuery, systemPrompt.replace('[CATEGORY NAME]', category));
                        outputDiv.textContent = resultText;
                    } catch (error)
 {
                        outputDiv.textContent = 'ç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚';
                        console.error("Prompt generation error:", error);
                    } finally {
                        loadingIndicator.classList.add('hidden');
                    }
                });
            });

            // Image Analysis Logic
            analyzeImageButtons.forEach(button => {
                button.addEventListener('click', async () => {
                    const category = button.getAttribute('data-category');
                    const inputId = button.getAttribute('data-input-id');
                    const outputId = button.getAttribute('data-output-id');
                    const analysisTextId = button.getAttribute('data-analysis-text-id');
                    const imagePreviewId = button.getAttribute('data-image-preview-id');
                    const audioId = button.getAttribute('data-audio-id');

                    const inputElement = document.getElementById(inputId);
                    const outputContainer = document.getElementById(outputId);
                    const analysisTextElement = document.getElementById(analysisTextId);
                    const imagePreviewContainer = document.getElementById(imagePreviewId);

                    const file = inputElement.files[0];

                    if (!file) {
                        alert('è«‹å…ˆé¸æ“‡ä¸€å¼µåœ–ç‰‡ï¼');
                        return;
                    }

                    outputContainer.classList.remove('hidden');
                    analysisTextElement.textContent = 'åœ–åƒåˆ†æä¸­ï¼Œè«‹ç¨å€™...';
                    imagePreviewContainer.innerHTML = `<img src="${URL.createObjectURL(file)}" alt="Uploaded Image Preview">`;
                    document.getElementById(audioId).classList.add('hidden');

                    loadingIndicator.classList.remove('hidden');
                    
                    try {
                        const { base64, mimeType } = await fileToBase64(file);
                        const resultText = await analyzeImage(base64, mimeType, category);
                        
                        analysisTextElement.textContent = resultText;
                    } catch (error) {
                        analysisTextElement.textContent = 'åœ–åƒåˆ†æå¤±æ•—ï¼Œè«‹æª¢æŸ¥åœ–ç‰‡æˆ–ç¶²è·¯ã€‚';
                        console.error("Image analysis error:", error);
                    } finally {
                        loadingIndicator.classList.add('hidden');
                    }
                });
            });


            // TTS Logic
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('tts-button')) {
                    const button = e.target;
                    const targetId = button.getAttribute('data-target');
                    const targetElement = document.getElementById(targetId);
                    
                    const textToRead = targetElement.textContent.trim();
                    if (!textToRead || textToRead === 'ç”Ÿæˆä¸­...' || textToRead.includes('ç”Ÿæˆå¤±æ•—') || textToRead.includes('åœ–åƒåˆ†æä¸­')) {
                        // ä½¿ç”¨è‡ªå®šç¾©æç¤ºæ¡†æˆ–æ§åˆ¶å°è­¦å‘Šï¼Œè€Œä¸æ˜¯ alert
                        console.warn('è«‹å…ˆç”Ÿæˆå…§å®¹æˆ–ç¢ºä¿å…§å®¹éç©ºã€‚');
                        return;
                    }

                    // For markdown content (vocab list), strip headers/list markers for TTS clarity
                    let cleanedText = textToRead.replace(/###\s*(.*)\n/g, '$1. '); // Replace markdown headers with period
                    cleanedText = cleanedText.replace(/-\s*/g, ' '); // Remove list markers

                    const audioId = button.nextElementSibling.id;
                    loadingIndicator.classList.remove('hidden'); // é¡¯ç¤ºæŒ‡ç¤ºå™¨
                    
                    try {
                        // generateTTS å‡½æ•¸ç¾åœ¨å°‡è™•ç†ä½•æ™‚éš±è—æŒ‡ç¤ºå™¨
                        generateTTS(cleanedText, audioId);
                    } catch (error) {
                        console.error("TTS execution error:", error);
                        loadingIndicator.classList.add('hidden'); // --- ä¿®æ­£ï¼šæ·»åŠ å®‰å…¨ç¶²ä»¥é˜²
                    }
                }
            });
        });
    </script>
</body>
</html>